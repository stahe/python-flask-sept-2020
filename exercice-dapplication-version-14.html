
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Introduction au langage Python 3 et au framework web Flask par l'exemple">
      
      
        <meta name="author" content="Serge Tahé">
      
      
        <link rel="canonical" href="https://stahe.github.io/python-flask-sept-2020/exercice-dapplication-version-14.html">
      
      
        <link rel="prev" href="exercice-dapplication-version-13.html">
      
      
        <link rel="next" href="exercice-dapplication-version-15.html">
      
      
        
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>34. Exercice d’application : version 14 - Introduction au langage Python 3 et au framework web Flask par l'exemple</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="stylesheets/focus.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#34-exercice-dapplication-version-14" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Introduction au langage Python 3 et au framework web Flask par l&#39;exemple" class="md-header__button md-logo" aria-label="Introduction au langage Python 3 et au framework web Flask par l'exemple" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Introduction au langage Python 3 et au framework web Flask par l'exemple
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              34. Exercice d’application : version 14
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode sombre"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Passer au mode sombre" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode clair"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Passer au mode clair" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/stahe/python-flask-sept-2020" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Introduction au langage Python 3 et au framework web Flask par l&#39;exemple" class="md-nav__button md-logo" aria-label="Introduction au langage Python 3 et au framework web Flask par l'exemple" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Introduction au langage Python 3 et au framework web Flask par l'exemple
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/stahe/python-flask-sept-2020" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accueil
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="avant-propos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Avant-propos
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="installation-dx27un-environnement-de-travail.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Installation d&#x27;un environnement de travail
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-bases-de-python.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Les bases de Python
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-chaines-de-caracteres.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Les chaînes de caractères
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-exceptions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Les exceptions
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-fonctions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Les fonctions
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-fichiers-texte.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    7. Les fichiers texte
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application---version-1.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    8. Exercice d&#x27;application – version 1
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-imports.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    9. Les imports
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-2.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    10. Exercice d’application : version 2
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-3.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    11. Exercice d’application : version 3
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-classes-et-objets.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    12. Les classes et objets
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-classes-generiques-baseentity-et-myexception.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    13. Les classes génériques [BaseEntity] et [MyException]
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="architecture-en-couches-et-programmation-par-interfaces.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    14. Architecture en couches et programmation par interfaces
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application---version-4.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    15. Exercice d&#x27;application - version 4
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-du-sgbd-mysql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    16. Utilisation du SGBD MySQL
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-du-sgbd-postgresql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    17. Utilisation du SGBD PostgreSQL
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="ecrire-du-code-independant-du-sgbd.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    18. Ecrire du code indépendant du SGBD
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-de-lorm-sqlalchemy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    19. Utilisation de l’ORM SQLALCHEMY
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application-version-5.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    20. Exercice d&#x27;application : version 5
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="fonctions-internet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    21. Fonctions internet
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="services-web-avec-le-framework-flask.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    22. Services web avec le framework Flask
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-6.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    23. Exercice d’application : version 6
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-7.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    24. Exercice d’application : version 7
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-8.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    25. Exercice d’application : version 8
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="du-dictionnaire-a-xml-et-vice-versa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    26. Du dictionnaire à XML et vice-versa
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-9.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    27. Exercice d’application : version 9
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-10.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    28. Exercice d’application : version 10
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-11.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    29. Exercice d’application : version 11
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    30. Exercice d’application : version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="clients-web-pour-les-services-json-et-xml-de-la-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    31. Clients web pour les services jSON et XML de la version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="le-mode-html-de-la-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    32. Le mode HTML de la version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-13.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    33. Exercice d’application : version 13
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    34. Exercice d’application : version 14
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="exercice-dapplication-version-14.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    34. Exercice d’application : version 14
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#341-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        34.1. Introduction
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#342-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        34.2. Configuration
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#343-implementation-csrf" class="md-nav__link">
    <span class="md-ellipsis">
      
        34.3. Implémentation CSRF
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="34.3. Implémentation CSRF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3431-le-module-flask_wtf" class="md-nav__link">
    <span class="md-ellipsis">
      
        34.3.1. Le module [flask_wtf]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3432-les-modeles-des-vues" class="md-nav__link">
    <span class="md-ellipsis">
      
        34.3.2. Les modèles des vues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3433-les-vues" class="md-nav__link">
    <span class="md-ellipsis">
      
        34.3.3. Les vues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3434-les-routes" class="md-nav__link">
    <span class="md-ellipsis">
      
        34.3.4. Les routes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3435-le-controleur-maincontroller" class="md-nav__link">
    <span class="md-ellipsis">
      
        34.3.5. Le contrôleur [MainController]
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#344-tests-avec-un-navigateur" class="md-nav__link">
    <span class="md-ellipsis">
      
        34.4. Tests avec un navigateur
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#345-clients-console" class="md-nav__link">
    <span class="md-ellipsis">
      
        34.5. Clients console
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-15.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    35. Exercice d’application : version 15
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-16.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    36. Exercice d’application : version 16
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-17.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    37. Exercice d’application : version 17
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-18.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    38. Exercice d’application : version 18
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="conclusion.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    39. Conclusion
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="34-exercice-dapplication-version-14">34. Exercice d’application : version 14</h1>
<p>Le dossier <strong>[http-servers/09]</strong> de la version 14 est obtenu par recopie du dossier <strong>[http-servers/08]</strong> de la version 13.</p>
<h2 id="341-introduction">34.1. Introduction</h2>
<p>CSRF (Cross Site Request Forgery) est une technique de vol de session. Elle est expliquée ainsi dans Wikipedia (<a href="https://fr.wikipedia.org/wiki/Cross-site_request_forgery"><u><u>https://fr.wikipedia.org/wiki/Cross-site_request_forgery</u></u></a>):</p>
<p>Supposons qu&#x27;Alice soit l&#x27;administratrice d&#x27;un forum et qu&#x27;elle soit connectée à celui-ci par un système de sessions. Malorie est un membre de ce même forum, elle veut supprimer un des messages du forum. Comme elle n&#x27;a pas les droits nécessaires avec son compte, elle utilise celui d&#x27;Alice grâce à une attaque de type CSRF.</p>
<ul>
<li>Malorie arrive à connaitre le lien qui permet de supprimer le message en question.</li>
<li>Malorie envoie un message à Alice contenant une pseudo-image à afficher (qui est en fait un script). L&#x27;URL de l&#x27;image est le lien vers le script permettant de supprimer le message désiré.</li>
<li>Alice doit avoir une session ouverte dans son navigateur pour le site visé par Malorie. C&#x27;est une condition requise pour que l&#x27;attaque réussisse de façon silencieuse sans requérir une demande d&#x27;authentification qui alerterait Alice. Cette session doit disposer des droits requis pour exécuter la requête destructrice de Malorie. Il n&#x27;est pas nécessaire qu&#x27;un onglet du navigateur soit ouvert sur le site cible ni même que le navigateur soit démarré. Il suffit que la session soit active.</li>
<li>Alice lit le message de Malorie, son navigateur utilise la session ouverte d&#x27;Alice et ne demande pas d&#x27;authentification interactive. Il tente de récupérer le contenu de l&#x27;image. En faisant cela, le navigateur actionne le lien et supprime le message, il récupère une page web texte comme contenu pour l&#x27;image. Ne reconnaissant pas le type d&#x27;image associé, il n&#x27;affiche pas d&#x27;image et Alice ne sait pas que Malorie vient de lui faire supprimer un message contre son gré.
Même expliqué comme ça, la technique du CSRF est  difficile à comprendre. Faisons un schéma :</li>
</ul>
<p><img src="images/10000000000003E50000024D46F14920.png" style="width:11.501cm;height:6.79cm;" alt="Image" /></p>
<ul>
<li>en <strong>[1-2]</strong>, Alice communique avec le forum (Site A). Ce forum maintient une session pour chaque utilisateur. Le navigateur d’Alice stocke localement ce cookie de session et le renvoie à chaque fois qu’il fait une nouvelle requête au site A ;</li>
<li>en <strong>[3]</strong>, Malorie envoie un message à Alice. Celle-ci le lit avec son navigateur. Le message lu est au format HTML et contient un lien vers une image du site B. En fait ce lien est un lien vers un script Javascript qui s’exécute une fois arrivé sur le navigateur d’Alice ;</li>
<li>
<p>ce script Javascript réalise alors une requête vers le site A. Le navigateur d’Alice envoie alors automatiquement la requête avec le cookie de session stocké localement. C’est ici que se produit l’attaque : Malorie a réussi à interroger le site A avec les droits (session) de Alice. Ensuite, peu importe ce qui se passe, l’attaque a eu lieu ;
Pour contrer ce type d’attaque, le site A peut procéder de la façon suivante :</p>
</li>
<li>
<p>à chaque échange <strong>[1-2]</strong> avec Alice, le site A envoie une clé, appelée par la suite token (jeton) CSRF, qu’Alice doit lui renvoyer lors de la requête suivante. Ainsi Alice doit envoyer à chaque requête deux informations :</p>
</li>
<li>le cookie de session ;</li>
<li>le token CSRF reçu lors de la réponse à sa dernière requête au site A ;
La protection est là : si le navigateur renvoie automatiquement au site A le cookie de session, il ne le fait pas pour le token CSRF. Pour cette raison, l’échange 6-7 fait par le script d’attaque sera refusé car la requête 6 n’aura pas envoyé le jeton CSRF ;</li>
</ul>
<p>Le site A peut envoyer à Alice le jeton CSRF de diverses façons pour une application HTML :</p>
<ul>
<li>il peut à chaque requête envoyer une page HTML où tous les liens auront le jeton CSRF, par exemple <strong>[http://siteA/chemin/csrf_token]</strong>. Lors de la requête suivante, Alice cliquant sur l’un de ces liens, le site A n’aura qu’à récupérer le jeton CSRF dans l’URL de la requête et vérifier qu’il est correct. C’est ce qui sera fait ici ;</li>
<li>il peut, pour les pages HTML contenant un formulaire, envoyer celui-ci avec un champ caché <strong>[input type=’hidden’]</strong> contenant le jeton CSRF. Celui-ci sera alors posté automatiquement avec le formulaire lorsqu’Alice validera la page. Le site A récupèrera le jeton CSRF dans le corps (body) de la requête ;</li>
<li>d’autres techniques sont envisageables ;</li>
</ul>
<h2 id="342-configuration">34.2. Configuration</h2>
<p><img src="images/1000000000000127000000E642E6C9B2.png" style="width:3.41cm;height:2.65cm;" alt="Image" /></p>
<p>Nous introduisons dans la configuration <strong>[parameters]</strong> de l’application deux booléens :</p>
<ul>
<li><strong>[with_redissession]</strong> : à True, l’application utilise une session Redis. A False, l’application utilise une session Flask normale ;</li>
<li><strong>[with_csrftoken]</strong> : à True, les URL de l’application contiennent un jeton CSRF ;
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>        <span class="c1"># durée pause thread en secondes</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>        <span class="s2">&quot;sleep_time&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="c1"># serveur Redis</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="s2">&quot;with_redissession&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="s2">&quot;redis&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>            <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>            <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="mi">6379</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>        <span class="p">},</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="c1"># token csrf</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="s2">&quot;with_csrftoken&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<h2 id="343-implementation-csrf">34.3. Implémentation CSRF</h2>
<p>Nous allons faire en sorte que lorsque :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="n">config</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;with_csrftoken&#39;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
<p>vaut <strong>[True]</strong>, l’application envoie au navigateur client des pages web dont les liens contiendront un jeton CSRF.</p>
<h3 id="3431-le-module-flask_wtf">34.3.1. Le module [flask_wtf]</h3>
<p>L’implémentation du jeton CSRF sera faite avec le module <strong>[flask_wtf]</strong> que nous installons dans un terminal PyCharm :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="p">(</span><span class="n">venv</span><span class="p">)</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">packages</span><span class="o">&gt;</span><span class="n">pip</span> <span class="n">install</span> <span class="n">flask_wtf</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="n">Collecting</span> <span class="n">flask_wtf</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="err">…</span>
</code></pre></div></td></tr></table></div>
<h3 id="3432-les-modeles-des-vues">34.3.2. Les modèles des vues</h3>
<p>Nous introduisons une nouvelle classe dans les modèles :</p>
<p><img src="images/10000000000001D4000001CE1812B1F9.png" style="width:5.411cm;height:5.34cm;" alt="Image" /></p>
<p>La classe <strong>[</strong><strong>AbstractBaseModelForView</strong><strong>]</strong> est la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">abstractmethod</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_wtf.csrf</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_csrf</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceModelForView</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceModelForView</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">AbstractBaseModelForView</span><span class="p">(</span><span class="n">InterfaceModelForView</span><span class="p">):</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_model_for_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">résultat</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>        <span class="k">pass</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_csrftoken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a>        <span class="c1"># csrf_token</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;with_csrftoken&#39;</span><span class="p">]:</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">generate_csrf</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a>            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 9 : la classe <strong>[</strong><strong>AbstractBaseModelForView</strong><strong>]</strong> implémente l’interface <strong>[</strong><strong>InterfaceModelForView</strong><strong>]</strong> implémentée par les classes des modèles ;</li>
<li>lignes 11-13 : la méthode <strong>[</strong><strong>get_model_for_view</strong><strong>]</strong> n’est pas implémentée ;</li>
<li>lignes 15-20 : la méthode <strong>[</strong><strong>get_csrftoken</strong><strong>]</strong> génère le jeton CSRF si l’application a été configurée pour les utiliser. Selon les cas, la fonction rend un jeton précédé du signe / sinon une chaîne vide. La fonction <strong>[generate_csrf]</strong> a la particularité de toujours générer la même valeur pour une requête client donnée. Le traitement d’une requête implique l’exécution de différentes fonctions. Utiliser <strong>[generate_csrf]</strong> dans celles-ci génère toujours la même valeur. Lors de la requête suivante, en revanche, un nouveau jeton CSRF est généré ;
Tous les modèles M de vue V inclueront le jeton CSRF de la façon suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ModelForAuthentificationView</span><span class="p">(</span><span class="n">AbstractBaseModelForView</span><span class="p">):</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_model_for_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">résultat</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>        <span class="c1"># on encapsule les données de la pagé dans modèle</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>        <span class="n">modèle</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>        <span class="err">…</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>        <span class="c1"># jeton csrf</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>        <span class="n">modèle</span><span class="p">[</span><span class="s1">&#39;csrf_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_csrftoken</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>        <span class="c1"># on rend le modèle</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>        <span class="k">return</span> <span class="n">modèle</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>chaque classe de modèle étend la classe de base <strong>[</strong><strong>AbstractBaseModelForView</strong><strong>]</strong> ;</li>
<li>ligne 8 : le jeton CSRF est demandé à la classe parent. On obtient soit la chaîne vide, soit une chaîne du genre <strong>[</strong><strong>/</strong><strong>Ijk4NjQ2ZDdjZjI0ZDJiYTVjZTZjYmFhZGNjMjE3Y2U5M2I3ODI0NzYi.Xy5Okg.n-kSR_nslkndfT7AFVy2UDtdb8c]</strong> ;</li>
</ul>
<h3 id="3433-les-vues">34.3.3. Les vues</h3>
<p>De ce qu’on vient de voir, toutes les vues V auront dans leur modèle M le jeton CSRF. Elles pourront donc l’utiliser dans les liens qu’elles contiennent. Prenons quelques exemples :</p>
<p><u><strong>Le fragment d’authentification</strong></u><strong> </strong><strong>[v_authentification.html]</strong></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">formulaire</span> <span class="n">HTML</span> <span class="o">-</span> <span class="n">on</span> <span class="n">poste</span> <span class="n">ses</span> <span class="n">valeurs</span> <span class="n">avec</span> <span class="n">l</span><span class="s1">&#39;action [authentifier-utilisateur] --&gt;</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="o">&lt;</span><span class="n">form</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;post&quot;</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;/authentifier-utilisateur{{modèle.csrf_token}}&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">titre</span> <span class="o">--&gt;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>    <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;alert alert-primary&quot;</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;alert&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>        <span class="o">&lt;</span><span class="n">h4</span><span class="o">&gt;</span><span class="n">Veuillez</span> <span class="n">vous</span> <span class="n">authentifier</span><span class="o">&lt;/</span><span class="n">h4</span><span class="o">&gt;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a>    <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="err">…</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 2 : d’après ce qui vient d’être vu, l’URL de l’attribut <strong>[action]</strong> sera :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="p">[</span><span class="o">/</span><span class="n">authentifier</span><span class="o">-</span><span class="n">utilisateur</span><span class="o">/</span><span class="n">Ijk4NjQ2ZDdjZjI0ZDJiYTVjZTZjYmFhZGNjMjE3Y2U5M2I3ODI0NzYi</span><span class="o">.</span><span class="n">Xy5Okg</span><span class="o">.</span><span class="n">n</span><span class="o">-</span><span class="n">kSR_nslkndfT7AFVy2UDtdb8c</span><span class="p">]</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<p>ou</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="p">[</span><span class="o">/</span><span class="n">authentifier</span><span class="o">-</span><span class="n">utilisateur</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
<p>selon que l’application a été configurée pour utiliser ou non des jetons CSRF ;</p>
<p><u><strong>Le fragment de calcul de l’impôt</strong></u> <strong>[v-calcul-impot.html]</strong></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">formulaire</span> <span class="n">HTML</span> <span class="n">posté</span> <span class="o">--&gt;</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="o">&lt;</span><span class="n">form</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;post&quot;</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;/calculer-impot{{modèle.csrf_token}}&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">message</span> <span class="n">sur</span> <span class="mi">12</span> <span class="n">colonnes</span> <span class="n">sur</span> <span class="n">fond</span> <span class="n">bleu</span> <span class="o">--&gt;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>    <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;col-md-12&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>        <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;alert alert-primary&quot;</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;alert&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>            <span class="o">&lt;</span><span class="n">h4</span><span class="o">&gt;</span><span class="n">Remplissez</span> <span class="n">le</span> <span class="n">formulaire</span> <span class="n">ci</span><span class="o">-</span><span class="n">dessous</span> <span class="n">puis</span> <span class="n">validez</span><span class="o">-</span><span class="n">le</span><span class="o">&lt;/</span><span class="n">h4</span><span class="o">&gt;</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a>        <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>    <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>    <span class="err">…</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
</code></pre></div></td></tr></table></div>
<p><u><strong>Le fragment des simulations</strong></u> <strong>[v-liste-simulations.html]</strong></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span>
<span class="normal"><a href="#__codelineno-9-20">20</a></span>
<span class="normal"><a href="#__codelineno-9-21">21</a></span>
<span class="normal"><a href="#__codelineno-9-22">22</a></span>
<span class="normal"><a href="#__codelineno-9-23">23</a></span>
<span class="normal"><a href="#__codelineno-9-24">24</a></span>
<span class="normal"><a href="#__codelineno-9-25">25</a></span>
<span class="normal"><a href="#__codelineno-9-26">26</a></span>
<span class="normal"><a href="#__codelineno-9-27">27</a></span>
<span class="normal"><a href="#__codelineno-9-28">28</a></span>
<span class="normal"><a href="#__codelineno-9-29">29</a></span>
<span class="normal"><a href="#__codelineno-9-30">30</a></span>
<span class="normal"><a href="#__codelineno-9-31">31</a></span>
<span class="normal"><a href="#__codelineno-9-32">32</a></span>
<span class="normal"><a href="#__codelineno-9-33">33</a></span>
<span class="normal"><a href="#__codelineno-9-34">34</a></span>
<span class="normal"><a href="#__codelineno-9-35">35</a></span>
<span class="normal"><a href="#__codelineno-9-36">36</a></span>
<span class="normal"><a href="#__codelineno-9-37">37</a></span>
<span class="normal"><a href="#__codelineno-9-38">38</a></span>
<span class="normal"><a href="#__codelineno-9-39">39</a></span>
<span class="normal"><a href="#__codelineno-9-40">40</a></span>
<span class="normal"><a href="#__codelineno-9-41">41</a></span>
<span class="normal"><a href="#__codelineno-9-42">42</a></span>
<span class="normal"><a href="#__codelineno-9-43">43</a></span>
<span class="normal"><a href="#__codelineno-9-44">44</a></span>
<span class="normal"><a href="#__codelineno-9-45">45</a></span>
<span class="normal"><a href="#__codelineno-9-46">46</a></span>
<span class="normal"><a href="#__codelineno-9-47">47</a></span>
<span class="normal"><a href="#__codelineno-9-48">48</a></span>
<span class="normal"><a href="#__codelineno-9-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">modèle</span><span class="o">.</span><span class="n">simulations</span> <span class="ow">is</span> <span class="n">undefined</span> <span class="ow">or</span> <span class="n">modèle</span><span class="o">.</span><span class="n">simulations</span><span class="o">|</span><span class="n">length</span><span class="o">==</span><span class="mi">0</span> <span class="o">%</span><span class="p">}</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">message</span> <span class="n">sur</span> <span class="n">fond</span> <span class="n">bleu</span> <span class="o">--&gt;</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;alert alert-primary&quot;</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;alert&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>    <span class="o">&lt;</span><span class="n">h4</span><span class="o">&gt;</span><span class="n">Votre</span> <span class="n">liste</span> <span class="n">de</span> <span class="n">simulations</span> <span class="n">est</span> <span class="n">vide</span><span class="o">&lt;/</span><span class="n">h4</span><span class="o">&gt;</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">modèle</span><span class="o">.</span><span class="n">simulations</span> <span class="ow">is</span> <span class="n">defined</span> <span class="ow">and</span> <span class="n">modèle</span><span class="o">.</span><span class="n">simulations</span><span class="o">|</span><span class="n">length</span><span class="o">!=</span><span class="mi">0</span> <span class="o">%</span><span class="p">}</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">message</span> <span class="n">sur</span> <span class="n">fond</span> <span class="n">bleu</span> <span class="o">--&gt;</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;alert alert-primary&quot;</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;alert&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a>    <span class="o">&lt;</span><span class="n">h4</span><span class="o">&gt;</span><span class="n">Liste</span> <span class="n">de</span> <span class="n">vos</span> <span class="n">simulations</span><span class="o">&lt;/</span><span class="n">h4</span><span class="o">&gt;</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">tableau</span> <span class="n">des</span> <span class="n">simulations</span> <span class="o">--&gt;</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="o">&lt;</span><span class="n">table</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;table table-sm table-hover table-striped&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a>    <span class="err">…</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">corps</span> <span class="n">du</span> <span class="n">tableau</span> <span class="p">(</span><span class="n">données</span> <span class="n">affichées</span><span class="p">)</span> <span class="o">--&gt;</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a>    <span class="o">&lt;</span><span class="n">tbody</span><span class="o">&gt;</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">on</span> <span class="n">affiche</span> <span class="n">chaque</span> <span class="n">simulation</span> <span class="n">en</span> <span class="n">parcourant</span> <span class="n">le</span> <span class="n">tableau</span> <span class="n">des</span> <span class="n">simulations</span> <span class="o">--&gt;</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a>    <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">simulation</span> <span class="ow">in</span> <span class="n">modèle</span><span class="o">.</span><span class="n">simulations</span> <span class="o">%</span><span class="p">}</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">affichage</span> <span class="n">d</span><span class="s1">&#39;une ligne du tableau avec 6 colonnes - balise &lt;tr&gt; --&gt;</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">colonne</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">entête</span> <span class="n">ligne</span> <span class="p">(</span><span class="n">n</span><span class="err">°</span> <span class="n">simulation</span><span class="p">)</span> <span class="o">-</span> <span class="n">balise</span> <span class="o">&lt;</span><span class="n">th</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;row&#39;</span> <span class="o">--&gt;</span>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">colonne</span> <span class="mi">2</span> <span class="p">:</span> <span class="n">valeur</span> <span class="n">paramètre</span> <span class="p">[</span><span class="n">marié</span><span class="p">]</span> <span class="o">-</span> <span class="n">balise</span> <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span> <span class="o">--&gt;</span>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">colonne</span> <span class="mi">3</span> <span class="p">:</span> <span class="n">valeur</span> <span class="n">paramètre</span> <span class="p">[</span><span class="n">enfants</span><span class="p">]</span> <span class="o">-</span> <span class="n">balise</span> <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span> <span class="o">--&gt;</span>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">colonne</span> <span class="mi">4</span> <span class="p">:</span> <span class="n">valeur</span> <span class="n">paramètre</span> <span class="p">[</span><span class="n">salaire</span><span class="p">]</span> <span class="o">-</span> <span class="n">balise</span> <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span> <span class="o">--&gt;</span>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">colonne</span> <span class="mi">5</span> <span class="p">:</span> <span class="n">valeur</span> <span class="n">paramètre</span> <span class="p">[</span><span class="n">impôt</span><span class="p">]</span> <span class="p">(</span><span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt) - balise &lt;td&gt; --&gt;</span>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">colonne</span> <span class="mi">6</span> <span class="p">:</span> <span class="n">valeur</span> <span class="n">paramètre</span> <span class="p">[</span><span class="n">surcôte</span><span class="p">]</span> <span class="o">-</span> <span class="n">balise</span> <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span> <span class="o">--&gt;</span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">colonne</span> <span class="mi">7</span> <span class="p">:</span> <span class="n">valeur</span> <span class="n">paramètre</span> <span class="p">[</span><span class="n">décôte</span><span class="p">]</span> <span class="o">-</span> <span class="n">balise</span> <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span> <span class="o">--&gt;</span>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">colonne</span> <span class="mi">8</span> <span class="p">:</span> <span class="n">valeur</span> <span class="n">paramètre</span> <span class="p">[</span><span class="n">réduction</span><span class="p">]</span> <span class="o">-</span> <span class="n">balise</span> <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span> <span class="o">--&gt;</span>
<a id="__codelineno-9-31" name="__codelineno-9-31"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">colonne</span> <span class="mi">9</span> <span class="p">:</span> <span class="n">valeur</span> <span class="n">paramètre</span> <span class="p">[</span><span class="n">taux</span><span class="p">]</span> <span class="p">(</span><span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt) - balise &lt;td&gt; --&gt;</span>
<a id="__codelineno-9-32" name="__codelineno-9-32"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">colonne</span> <span class="mi">10</span> <span class="p">:</span> <span class="n">lien</span> <span class="n">de</span> <span class="n">suppression</span> <span class="n">de</span> <span class="n">la</span> <span class="n">simulation</span> <span class="o">-</span> <span class="n">balise</span> <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span> <span class="o">--&gt;</span>
<a id="__codelineno-9-33" name="__codelineno-9-33"></a>    <span class="o">&lt;</span><span class="n">tr</span><span class="o">&gt;</span>
<a id="__codelineno-9-34" name="__codelineno-9-34"></a>        <span class="o">&lt;</span><span class="n">th</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="o">&gt;</span><span class="p">{{</span><span class="n">simulation</span><span class="o">.</span><span class="n">id</span><span class="p">}}</span><span class="o">&lt;/</span><span class="n">th</span><span class="o">&gt;</span>
<a id="__codelineno-9-35" name="__codelineno-9-35"></a>        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span><span class="p">{{</span><span class="n">simulation</span><span class="o">.</span><span class="n">marié</span><span class="p">}}</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<a id="__codelineno-9-36" name="__codelineno-9-36"></a>        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span><span class="p">{{</span><span class="n">simulation</span><span class="o">.</span><span class="n">enfants</span><span class="p">}}</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<a id="__codelineno-9-37" name="__codelineno-9-37"></a>        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span><span class="p">{{</span><span class="n">simulation</span><span class="o">.</span><span class="n">salaire</span><span class="p">}}</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<a id="__codelineno-9-38" name="__codelineno-9-38"></a>        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span><span class="p">{{</span><span class="n">simulation</span><span class="o">.</span><span class="n">impôt</span><span class="p">}}</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<a id="__codelineno-9-39" name="__codelineno-9-39"></a>        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span><span class="p">{{</span><span class="n">simulation</span><span class="o">.</span><span class="n">surcôte</span><span class="p">}}</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<a id="__codelineno-9-40" name="__codelineno-9-40"></a>        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span><span class="p">{{</span><span class="n">simulation</span><span class="o">.</span><span class="n">décôte</span><span class="p">}}</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<a id="__codelineno-9-41" name="__codelineno-9-41"></a>        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span><span class="p">{{</span><span class="n">simulation</span><span class="o">.</span><span class="n">réduction</span><span class="p">}}</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<a id="__codelineno-9-42" name="__codelineno-9-42"></a>        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span><span class="p">{{</span><span class="n">simulation</span><span class="o">.</span><span class="n">taux</span><span class="p">}}</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<a id="__codelineno-9-43" name="__codelineno-9-43"></a>        <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;/supprimer-simulation/{{simulation.id}}{{modèle.csrf_token}}&quot;</span><span class="o">&gt;</span><span class="n">Supprimer</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<a id="__codelineno-9-44" name="__codelineno-9-44"></a>    <span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;</span>
<a id="__codelineno-9-45" name="__codelineno-9-45"></a>    <span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
<a id="__codelineno-9-46" name="__codelineno-9-46"></a>    <span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;</span>
<a id="__codelineno-9-47" name="__codelineno-9-47"></a>    <span class="o">&lt;/</span><span class="n">tbody</span><span class="o">&gt;</span>
<a id="__codelineno-9-48" name="__codelineno-9-48"></a><span class="o">&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
<a id="__codelineno-9-49" name="__codelineno-9-49"></a><span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><u><strong>Le fragment du menu</strong></u> <strong>[v-menu.html]</strong></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span>
<span class="normal"><a href="#__codelineno-10-3">3</a></span>
<span class="normal"><a href="#__codelineno-10-4">4</a></span>
<span class="normal"><a href="#__codelineno-10-5">5</a></span>
<span class="normal"><a href="#__codelineno-10-6">6</a></span>
<span class="normal"><a href="#__codelineno-10-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">menu</span> <span class="n">Bootstrap</span> <span class="o">--&gt;</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="o">&lt;</span><span class="n">nav</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;nav flex-column&quot;</span><span class="o">&gt;</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>    <span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="n">affichage</span> <span class="n">d</span><span class="s1">&#39;une liste de liens HTML --&gt;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>    <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">optionMenu</span> <span class="ow">in</span> <span class="n">modèle</span><span class="o">.</span><span class="n">optionsMenu</span> <span class="o">%</span><span class="p">}</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>    <span class="o">&lt;</span><span class="n">a</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;nav-link&quot;</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;{{optionMenu.url}}{{modèle.csrf_token}}&quot;</span><span class="o">&gt;</span><span class="p">{{</span><span class="n">optionMenu</span><span class="o">.</span><span class="n">text</span><span class="p">}}</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>    <span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="o">&lt;/</span><span class="n">nav</span><span class="o">&gt;</span>
</code></pre></div></td></tr></table></div>
<h3 id="3434-les-routes">34.3.4. Les routes</h3>
<p>Il y a désormais deux types de routes, selon que celles-ci utilisent ou non un jeton CSRF :</p>
<p><img src="images/100000000000018F00000106A63E3323.png" style="width:4.612cm;height:3.031cm;" alt="Image" /></p>
<ul>
<li><strong>[routes_without_csrftoken]</strong> sont les routes sans jeton CSRF. Ce sont les routes de la version précédente ;</li>
<li><strong>[routes_with_csrftoken]</strong> sont les routes avec jeton CSRF.
Dans <strong>[routes_with_csrftoken]</strong>, les routes ont désormais un paramètre supplémentaire, le jeton CSRF :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span>
<span class="normal"><a href="#__codelineno-11-31">31</a></span>
<span class="normal"><a href="#__codelineno-11-32">32</a></span>
<span class="normal"><a href="#__codelineno-11-33">33</a></span>
<span class="normal"><a href="#__codelineno-11-34">34</a></span>
<span class="normal"><a href="#__codelineno-11-35">35</a></span>
<span class="normal"><a href="#__codelineno-11-36">36</a></span>
<span class="normal"><a href="#__codelineno-11-37">37</a></span>
<span class="normal"><a href="#__codelineno-11-38">38</a></span>
<span class="normal"><a href="#__codelineno-11-39">39</a></span>
<span class="normal"><a href="#__codelineno-11-40">40</a></span>
<span class="normal"><a href="#__codelineno-11-41">41</a></span>
<span class="normal"><a href="#__codelineno-11-42">42</a></span>
<span class="normal"><a href="#__codelineno-11-43">43</a></span>
<span class="normal"><a href="#__codelineno-11-44">44</a></span>
<span class="normal"><a href="#__codelineno-11-45">45</a></span>
<span class="normal"><a href="#__codelineno-11-46">46</a></span>
<span class="normal"><a href="#__codelineno-11-47">47</a></span>
<span class="normal"><a href="#__codelineno-11-48">48</a></span>
<span class="normal"><a href="#__codelineno-11-49">49</a></span>
<span class="normal"><a href="#__codelineno-11-50">50</a></span>
<span class="normal"><a href="#__codelineno-11-51">51</a></span>
<span class="normal"><a href="#__codelineno-11-52">52</a></span>
<span class="normal"><a href="#__codelineno-11-53">53</a></span>
<span class="normal"><a href="#__codelineno-11-54">54</a></span>
<span class="normal"><a href="#__codelineno-11-55">55</a></span>
<span class="normal"><a href="#__codelineno-11-56">56</a></span>
<span class="normal"><a href="#__codelineno-11-57">57</a></span>
<span class="normal"><a href="#__codelineno-11-58">58</a></span>
<span class="normal"><a href="#__codelineno-11-59">59</a></span>
<span class="normal"><a href="#__codelineno-11-60">60</a></span>
<span class="normal"><a href="#__codelineno-11-61">61</a></span>
<span class="normal"><a href="#__codelineno-11-62">62</a></span>
<span class="normal"><a href="#__codelineno-11-63">63</a></span>
<span class="normal"><a href="#__codelineno-11-64">64</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1"># le front controller</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">front_controller</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>    <span class="c1"># on fait suivre la requête au contrôleur principal</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>    <span class="n">main_controller</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;mvc&#39;</span><span class="p">][</span><span class="s1">&#39;controllers&#39;</span><span class="p">][</span><span class="s1">&#39;main-controller&#39;</span><span class="p">]</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>    <span class="k">return</span> <span class="n">main_controller</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>    <span class="c1"># redirection vers /init-session/html</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;init_session&quot;</span><span class="p">,</span> <span class="n">type_response</span><span class="o">=</span><span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="n">csrf_token</span><span class="o">=</span><span class="n">generate_csrf</span><span class="p">()),</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_302_FOUND</span><span class="p">)</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="c1"># init-session</span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/init-session/&lt;string:type_response&gt;/&lt;string:csrf_token&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="k">def</span><span class="w"> </span><span class="nf">init_session</span><span class="p">(</span><span class="n">type_response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="c1"># authentifier-utilisateur</span>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/authentifier-utilisateur/&lt;string:csrf_token&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="k">def</span><span class="w"> </span><span class="nf">authentifier_utilisateur</span><span class="p">(</span><span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="c1"># calculer-impot</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/calculer-impot/&lt;string:csrf_token&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculer_impot</span><span class="p">(</span><span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-11-29" name="__codelineno-11-29"></a>
<a id="__codelineno-11-30" name="__codelineno-11-30"></a><span class="c1"># calcul de l&#39;impôt par lots</span>
<a id="__codelineno-11-31" name="__codelineno-11-31"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/calculer-impots/&lt;string:csrf_token&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<a id="__codelineno-11-32" name="__codelineno-11-32"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculer_impots</span><span class="p">(</span><span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-11-33" name="__codelineno-11-33"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-11-34" name="__codelineno-11-34"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-11-35" name="__codelineno-11-35"></a>
<a id="__codelineno-11-36" name="__codelineno-11-36"></a><span class="c1"># lister-simulations</span>
<a id="__codelineno-11-37" name="__codelineno-11-37"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/lister-simulations/&lt;string:csrf_token&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-11-38" name="__codelineno-11-38"></a><span class="k">def</span><span class="w"> </span><span class="nf">lister_simulations</span><span class="p">(</span><span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-11-39" name="__codelineno-11-39"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-11-40" name="__codelineno-11-40"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-11-41" name="__codelineno-11-41"></a>
<a id="__codelineno-11-42" name="__codelineno-11-42"></a><span class="c1"># supprimer-simulation</span>
<a id="__codelineno-11-43" name="__codelineno-11-43"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/supprimer-simulation/&lt;int:numero&gt;/&lt;string:csrf_token&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-11-44" name="__codelineno-11-44"></a><span class="k">def</span><span class="w"> </span><span class="nf">supprimer_simulation</span><span class="p">(</span><span class="n">numero</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-11-45" name="__codelineno-11-45"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-11-46" name="__codelineno-11-46"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-11-47" name="__codelineno-11-47"></a>
<a id="__codelineno-11-48" name="__codelineno-11-48"></a><span class="c1"># fin-session</span>
<a id="__codelineno-11-49" name="__codelineno-11-49"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/fin-session/&lt;string:csrf_token&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-11-50" name="__codelineno-11-50"></a><span class="k">def</span><span class="w"> </span><span class="nf">fin_session</span><span class="p">(</span><span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-11-51" name="__codelineno-11-51"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-11-52" name="__codelineno-11-52"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-11-53" name="__codelineno-11-53"></a>
<a id="__codelineno-11-54" name="__codelineno-11-54"></a><span class="c1"># afficher-calcul-impot</span>
<a id="__codelineno-11-55" name="__codelineno-11-55"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/afficher-calcul-impot/&lt;string:csrf_token&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-11-56" name="__codelineno-11-56"></a><span class="k">def</span><span class="w"> </span><span class="nf">afficher_calcul_impot</span><span class="p">(</span><span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-11-57" name="__codelineno-11-57"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-11-58" name="__codelineno-11-58"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-11-59" name="__codelineno-11-59"></a>
<a id="__codelineno-11-60" name="__codelineno-11-60"></a><span class="c1"># get-admindata</span>
<a id="__codelineno-11-61" name="__codelineno-11-61"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/get-admindata/&lt;string:csrf_token&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-11-62" name="__codelineno-11-62"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_admindata</span><span class="p">(</span><span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-11-63" name="__codelineno-11-63"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-11-64" name="__codelineno-11-64"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>Toutes les routes ont désormais le jeton CSRF dans leurs paramètres, même la route <strong>[/init-session]</strong>. Cela signifie que le client ne peut pas démarrer l’application en tapant directement l’URL <strong>[/init-session/html]</strong> car il y manquera le jeton CSRF. Il doit désormais obligatoirement passer par l’URL <strong>[/]</strong> des lignes 7-10.</p>
<p>Le choix des routes est fait dans le script principal <strong>[main]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="err">…</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="c1"># le thread principal n&#39;a plus besoin du logger</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="n">logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="c1"># s&#39;il y a eu erreur on s&#39;arrête</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="c1"># import des routes de l&#39;application web</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;with_csrftoken&#39;</span><span class="p">]:</span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">routes_with_csrftoken</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">routes</span>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-12-13" name="__codelineno-12-13"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">routes_without_csrftoken</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">routes</span>
<a id="__codelineno-12-14" name="__codelineno-12-14"></a>
<a id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="c1"># configuration des routes</span>
<a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="n">routes</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-12-17" name="__codelineno-12-17"></a>
<a id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="c1"># démarrage application Flask</span>
<a id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="n">routes</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 9-13 : choix des routes selon que l’application utilise ou non des jetons CSRF ;</li>
</ul>
<h3 id="3435-le-controleur-maincontroller">34.3.5. Le contrôleur [MainController]</h3>
<p>A chaque requête, le serveur doit vérifier la présence du jeton CSRF. Nous ferons cela dans le contrôleur principal <strong>[MainController]</strong> qui voit passer toutes les requêtes :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span>
<span class="normal"><a href="#__codelineno-13-15">15</a></span>
<span class="normal"><a href="#__codelineno-13-16">16</a></span>
<span class="normal"><a href="#__codelineno-13-17">17</a></span>
<span class="normal"><a href="#__codelineno-13-18">18</a></span>
<span class="normal"><a href="#__codelineno-13-19">19</a></span>
<span class="normal"><a href="#__codelineno-13-20">20</a></span>
<span class="normal"><a href="#__codelineno-13-21">21</a></span>
<span class="normal"><a href="#__codelineno-13-22">22</a></span>
<span class="normal"><a href="#__codelineno-13-23">23</a></span>
<span class="normal"><a href="#__codelineno-13-24">24</a></span>
<span class="normal"><a href="#__codelineno-13-25">25</a></span>
<span class="normal"><a href="#__codelineno-13-26">26</a></span>
<span class="normal"><a href="#__codelineno-13-27">27</a></span>
<span class="normal"><a href="#__codelineno-13-28">28</a></span>
<span class="normal"><a href="#__codelineno-13-29">29</a></span>
<span class="normal"><a href="#__codelineno-13-30">30</a></span>
<span class="normal"><a href="#__codelineno-13-31">31</a></span>
<span class="normal"><a href="#__codelineno-13-32">32</a></span>
<span class="normal"><a href="#__codelineno-13-33">33</a></span>
<span class="normal"><a href="#__codelineno-13-34">34</a></span>
<span class="normal"><a href="#__codelineno-13-35">35</a></span>
<span class="normal"><a href="#__codelineno-13-36">36</a></span>
<span class="normal"><a href="#__codelineno-13-37">37</a></span>
<span class="normal"><a href="#__codelineno-13-38">38</a></span>
<span class="normal"><a href="#__codelineno-13-39">39</a></span>
<span class="normal"><a href="#__codelineno-13-40">40</a></span>
<span class="normal"><a href="#__codelineno-13-41">41</a></span>
<span class="normal"><a href="#__codelineno-13-42">42</a></span>
<span class="normal"><a href="#__codelineno-13-43">43</a></span>
<span class="normal"><a href="#__codelineno-13-44">44</a></span>
<span class="normal"><a href="#__codelineno-13-45">45</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_wtf.csrf</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_csrf</span><span class="p">,</span> <span class="n">validate_csrf</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="err">…</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>       <span class="c1"># on traite la requête</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a>            <span class="c1"># logger</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a>            <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;logsFilename&#39;</span><span class="p">])</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a>            <span class="err">…</span>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a>            <span class="c1"># on récupère les éléments du path</span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a>            <span class="c1"># l&#39;action est le 1er élément</span>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a>            <span class="n">action</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a>            <span class="err">…</span>
<a id="__codelineno-13-17" name="__codelineno-13-17"></a>
<a id="__codelineno-13-18" name="__codelineno-13-18"></a>            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;with_csrftoken&#39;</span><span class="p">]:</span>
<a id="__codelineno-13-19" name="__codelineno-13-19"></a>                <span class="c1"># le csrf_token est le dernier élément du path</span>
<a id="__codelineno-13-20" name="__codelineno-13-20"></a>                <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<a id="__codelineno-13-21" name="__codelineno-13-21"></a>                <span class="c1"># on vérifie la validité du token</span>
<a id="__codelineno-13-22" name="__codelineno-13-22"></a>                <span class="c1"># une exception sera lancée si le csrf_token n&#39;est pas celui attendu</span>
<a id="__codelineno-13-23" name="__codelineno-13-23"></a>                <span class="n">validate_csrf</span><span class="p">(</span><span class="n">csrf_token</span><span class="p">)</span>
<a id="__codelineno-13-24" name="__codelineno-13-24"></a>
<a id="__codelineno-13-25" name="__codelineno-13-25"></a>            <span class="err">…</span>
<a id="__codelineno-13-26" name="__codelineno-13-26"></a>
<a id="__codelineno-13-27" name="__codelineno-13-27"></a>        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
<a id="__codelineno-13-28" name="__codelineno-13-28"></a>            <span class="c1"># csrf token invalide</span>
<a id="__codelineno-13-29" name="__codelineno-13-29"></a>            <span class="n">résultat</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">121</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]}</span>
<a id="__codelineno-13-30" name="__codelineno-13-30"></a>            <span class="n">status_code</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
<a id="__codelineno-13-31" name="__codelineno-13-31"></a>
<a id="__codelineno-13-32" name="__codelineno-13-32"></a>        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
<a id="__codelineno-13-33" name="__codelineno-13-33"></a>            <span class="c1"># autres exceptions (inattendues)</span>
<a id="__codelineno-13-34" name="__codelineno-13-34"></a>            <span class="n">résultat</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">131</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]}</span>
<a id="__codelineno-13-35" name="__codelineno-13-35"></a>            <span class="n">status_code</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
<a id="__codelineno-13-36" name="__codelineno-13-36"></a>
<a id="__codelineno-13-37" name="__codelineno-13-37"></a>        <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-13-38" name="__codelineno-13-38"></a>            <span class="k">pass</span>
<a id="__codelineno-13-39" name="__codelineno-13-39"></a>
<a id="__codelineno-13-40" name="__codelineno-13-40"></a>        <span class="c1"># on ajoute le csrf_token au résultat</span>
<a id="__codelineno-13-41" name="__codelineno-13-41"></a>        <span class="n">résultat</span><span class="p">[</span><span class="s1">&#39;csrf_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generate_csrf</span><span class="p">()</span>
<a id="__codelineno-13-42" name="__codelineno-13-42"></a>
<a id="__codelineno-13-43" name="__codelineno-13-43"></a>        <span class="c1"># on logue le résultat envoyé au client</span>
<a id="__codelineno-13-44" name="__codelineno-13-44"></a>        <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[MainController] </span><span class="si">{</span><span class="n">résultat</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-13-45" name="__codelineno-13-45"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 20 : on récupère le jeton CSRF dans l’URL de la requête du type <strong>[http://machine :port/chemin/action/param1/param2/…/csrf_token]</strong>. Le jeton de session est toujours le dernier élément de l’URL ;</li>
<li>ligne 23 : la validité du jeton CSRF récupéré dans l’URL avec le jeton CSRF de la session est vérifiée. S’il n’est pas valide, la fonction <strong>[validate_csrf]</strong> lance une exception de type <strong>[ValidationError]</strong> (ligne 27) ;</li>
<li>ligne 41 : le jeton CSRF est mis dans le résultat envoyé au client. Les clients jSON et XML en auront besoin. En effet, ces clients ne reçoivent pas de pages HTML avec le jeton CSRF dans les liens contenus dans les pages. Ils le recevront donc dans le résultat jSON ou XML envoyé par le serveur ;
<strong>Note</strong> : la fonction <strong>[validate_csrf]</strong> de la ligne 23 ne vérifie pas une concordance stricte. Le jeton CSRF est mémorisé dans la session avec la clé <strong>[csrf_token]</strong>. Les test semblent montrer qu’un jeton CSRF est valide s’il a été généré au cours de la session. Ainsi si manuellement, dans l’URL affichée dans le navigateur, par exemple (/lister-simulations/xyz), vous remplacez le jeton <strong>[xyz]</strong> CSRF par un autre <strong>[abc]</strong> déjà reçu lors d’une précédente action, l’action <strong>[/lister-simulations]</strong> va réussir ;</li>
</ul>
<h2 id="344-tests-avec-un-navigateur">34.4. Tests avec un navigateur</h2>
<p>On :</p>
<ul>
<li>lance le serveur avec le paramètre <strong>[with_csrftoken]</strong> à <strong>[True]</strong> ;</li>
<li>demande l’URL <strong>[http://localhost:5000]</strong> avec un navigateur ;</li>
</ul>
<p><img src="images/10000000000004710000029076ACA4C7.png" style="width:13.14cm;height:7.561cm;" alt="Image" /></p>
<ul>
<li>en <strong>[1]</strong>, le jeton CSRF ;
Faisons des manipulations jusqu’à avoir une liste de simulations :</li>
</ul>
<p><img src="images/100000000000058E00000254BCAB1B42.png" style="width:16.431cm;height:6.891cm;" alt="Image" /></p>
<p>Maintenant, tapons à la main, l’URL <strong>[http://localhost:5000/supprimer-simulation/1/x]</strong> pour supprimer la simulation d’id=1. On met volontairement un jeton CSRF incorrect pour voir ce qui se passe. La réponse du serveur est la suivante :</p>
<p><img src="images/100000000000058E0000021B39C49A61.png" style="width:16.41cm;height:6.22cm;" alt="Image" /></p>
<p><strong>Note 1</strong> : il n’est pas sûr que la méthode utilisée ici soit toujours suffisante pour contrer les attaques CSRF. Revenons au schéma de l’attaque :</p>
<p><img src="images/10000000000003E50000024D46F14920.png" style="width:11.501cm;height:6.79cm;" alt="Image" /></p>
<p>Si le script Javascript téléchargé en <strong>[5]</strong> est capable de lire l’historique du navigateur utilisé par Alice, il sera capable de récupérer les URL exécutées par le navigateur, des URL telles que <strong>[/cible/csrf_token]</strong>. Il pourra alors récupérer le jeton de session <strong>[csrf_token]</strong> et faire son attaque en <strong>[6-7]</strong>. Néanmoins, le navigateur autorise uniquement l’exploitation de l’historique de la fenêtre du navigateur dans laquelle s’exécute le script. Si donc Alice n’utilise pas la même fenêtre pour travailler avec le site A <strong>[1-2]</strong> et lire le message de Malorie <strong>[3]</strong>, l’attaque CSRF ne sera pas possible.</p>
<h2 id="345-clients-console">34.5. Clients console</h2>
<p>Une autre façon de tester la version 14 de l’application est de reprendre les tests de la version 12 et de les adapter au nouveau serveur.</p>
<p><img src="images/10000000000000E4000000E6E2289AB8.png" style="width:2.631cm;height:2.65cm;" alt="Image" /></p>
<p>Le dossier <strong>[impots/http-clients/09]</strong> est obtenu initialement par recopie du dossier <strong>[impots/http-clients/07]</strong>. Il est ensuite modifié.</p>
<p>Revenons aux routes qui initialisent une session :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="c1"># racine de l&#39;application</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>    <span class="c1"># redirection vers /init-session/html</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a>    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;init_session&quot;</span><span class="p">,</span> <span class="n">type_response</span><span class="o">=</span><span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="n">csrf_token</span><span class="o">=</span><span class="n">generate_csrf</span><span class="p">()),</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_302_FOUND</span><span class="p">)</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="c1"># init-session-with-csrf-token</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/init-session/&lt;string:type_response&gt;/&lt;string:csrf_token&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">init_session</span><span class="p">(</span><span class="n">type_response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>Aucune de ces routes ne convient pour initialiser une session jSON ou XML :</p>
<ul>
<li>lignes 2-5 : la route <strong>[/]</strong> initialise une session HTML ;</li>
<li>lignes 8-11 : la route <strong>[/init-session]</strong> nécessite un jeton CSRF qu’on ne connaît pas ;
Nous décidons d’ajouter une nouvelle route au serveur :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span>
<span class="normal"><a href="#__codelineno-15-4">4</a></span>
<span class="normal"><a href="#__codelineno-15-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="c1"># init-session-without-csrftoken</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/init-session-without-csrftoken/&lt;string:type_response&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">init_session_without_csrftoken</span><span class="p">(</span><span class="n">type_response</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a>    <span class="c1"># redirection vers /init-session/type_response</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a>    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;init_session&quot;</span><span class="p">,</span> <span class="n">type_response</span><span class="o">=</span><span class="n">type_response</span><span class="p">,</span> <span class="n">csrf_token</span><span class="o">=</span><span class="n">generate_csrf</span><span class="p">()),</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_302_FOUND</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 2 : la nouvelle route. Elle n’attend pas de jeton CSRF. On est ainsi revenu à la route <strong>[/init-session]</strong> de la version précédente ;</li>
<li>lignes 4-5 : on redirige le client (jSON, XML, HTML) vers la route <strong>[/init-session]</strong> ayant le jeton CSRF dans ses paramètres ;
On peut essayer cette nouvelle route avec un navigateur :</li>
</ul>
<p><img src="images/10000000000003CF000000A47ACF6ACC.png" style="width:11.27cm;height:1.89cm;" alt="Image" /></p>
<p>La réponse du serveur (configuré avec <strong>[with_csrftoken=True]</strong>) est la suivante :</p>
<p><img src="images/100000000000063C000000A5FABB0D6C.png" style="width:18.432cm;height:1.9cm;" alt="Image" /></p>
<ul>
<li>en <strong>[1]</strong>, le serveur a été redirigé vers la route <strong>[/init-session]</strong> avec jeton CSRF dans l’URL ;</li>
<li>en <strong>[2]</strong>, le jeton CSRF est dans le dictionnaire jSON envoyé par le serveur associé à la clé <strong>[csrf_token]</strong> ;
Revenons au code du client :</li>
</ul>
<p><img src="images/1000000000000119000001395F3D944C.png" style="width:3.241cm;height:3.62cm;" alt="Image" /></p>
<p>Nous modifions la configuration <strong>[config]</strong> de la façon suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span>
<span class="normal"><a href="#__codelineno-16-20">20</a></span>
<span class="normal"><a href="#__codelineno-16-21">21</a></span>
<span class="normal"><a href="#__codelineno-16-22">22</a></span>
<span class="normal"><a href="#__codelineno-16-23">23</a></span>
<span class="normal"><a href="#__codelineno-16-24">24</a></span>
<span class="normal"><a href="#__codelineno-16-25">25</a></span>
<span class="normal"><a href="#__codelineno-16-26">26</a></span>
<span class="normal"><a href="#__codelineno-16-27">27</a></span>
<span class="normal"><a href="#__codelineno-16-28">28</a></span>
<span class="normal"><a href="#__codelineno-16-29">29</a></span>
<span class="normal"><a href="#__codelineno-16-30">30</a></span>
<span class="normal"><a href="#__codelineno-16-31">31</a></span>
<span class="normal"><a href="#__codelineno-16-32">32</a></span>
<span class="normal"><a href="#__codelineno-16-33">33</a></span>
<span class="normal"><a href="#__codelineno-16-34">34</a></span>
<span class="normal"><a href="#__codelineno-16-35">35</a></span>
<span class="normal"><a href="#__codelineno-16-36">36</a></span>
<span class="normal"><a href="#__codelineno-16-37">37</a></span>
<span class="normal"><a href="#__codelineno-16-38">38</a></span>
<span class="normal"><a href="#__codelineno-16-39">39</a></span>
<span class="normal"><a href="#__codelineno-16-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a>   <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a>        <span class="c1"># fichier des contribuables</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a>        <span class="s2">&quot;taxpayersFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../data/input/taxpayersdata.txt&quot;</span><span class="p">,</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a>        <span class="c1"># fichier des résultats</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a>        <span class="s2">&quot;resultsFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../data/output/résultats.json&quot;</span><span class="p">,</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a>        <span class="c1"># fichier des erreurs</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a>        <span class="s2">&quot;errorsFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../data/output/errors.txt&quot;</span><span class="p">,</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a>        <span class="c1"># fichier de logs</span>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a>        <span class="s2">&quot;logsFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../data/logs/logs.txt&quot;</span><span class="p">,</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a>        <span class="c1"># le serveur de calcul de l&#39;impôt</span>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a>        <span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a>            <span class="s2">&quot;urlServer&quot;</span><span class="p">:</span> <span class="s2">&quot;http://127.0.0.1:5000&quot;</span><span class="p">,</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a>            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-16-14" name="__codelineno-16-14"></a>                <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
<a id="__codelineno-16-15" name="__codelineno-16-15"></a>                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span>
<a id="__codelineno-16-16" name="__codelineno-16-16"></a>            <span class="p">},</span>
<a id="__codelineno-16-17" name="__codelineno-16-17"></a>            <span class="s2">&quot;url_services&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-16-18" name="__codelineno-16-18"></a>                <span class="s2">&quot;calculate-tax&quot;</span><span class="p">:</span> <span class="s2">&quot;/calculer-impot&quot;</span><span class="p">,</span>
<a id="__codelineno-16-19" name="__codelineno-16-19"></a>                <span class="s2">&quot;get-admindata&quot;</span><span class="p">:</span> <span class="s2">&quot;/get-admindata&quot;</span><span class="p">,</span>
<a id="__codelineno-16-20" name="__codelineno-16-20"></a>                <span class="s2">&quot;calculate-tax-in-bulk-mode&quot;</span><span class="p">:</span> <span class="s2">&quot;/calculer-impots&quot;</span><span class="p">,</span>
<a id="__codelineno-16-21" name="__codelineno-16-21"></a>                <span class="s2">&quot;init-session&quot;</span><span class="p">:</span> <span class="s2">&quot;/init-session-without-csrftoken&quot;</span><span class="p">,</span>
<a id="__codelineno-16-22" name="__codelineno-16-22"></a>                <span class="s2">&quot;end-session&quot;</span><span class="p">:</span> <span class="s2">&quot;/fin-session&quot;</span><span class="p">,</span>
<a id="__codelineno-16-23" name="__codelineno-16-23"></a>                <span class="s2">&quot;authenticate-user&quot;</span><span class="p">:</span> <span class="s2">&quot;/authentifier-utilisateur&quot;</span><span class="p">,</span>
<a id="__codelineno-16-24" name="__codelineno-16-24"></a>                <span class="s2">&quot;get-simulations&quot;</span><span class="p">:</span> <span class="s2">&quot;/lister-simulations&quot;</span><span class="p">,</span>
<a id="__codelineno-16-25" name="__codelineno-16-25"></a>                <span class="s2">&quot;delete-simulation&quot;</span><span class="p">:</span> <span class="s2">&quot;/supprimer-simulation&quot;</span><span class="p">,</span>
<a id="__codelineno-16-26" name="__codelineno-16-26"></a>            <span class="p">}</span>
<a id="__codelineno-16-27" name="__codelineno-16-27"></a>        <span class="p">},</span>
<a id="__codelineno-16-28" name="__codelineno-16-28"></a>        <span class="c1"># mode debug</span>
<a id="__codelineno-16-29" name="__codelineno-16-29"></a>        <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-16-30" name="__codelineno-16-30"></a>        <span class="c1"># csrf_token</span>
<a id="__codelineno-16-31" name="__codelineno-16-31"></a>        <span class="s2">&quot;with_csrftoken&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-16-32" name="__codelineno-16-32"></a>    <span class="p">}</span>
<a id="__codelineno-16-33" name="__codelineno-16-33"></a>    <span class="p">)</span>
<a id="__codelineno-16-34" name="__codelineno-16-34"></a><span class="err">…</span>
<a id="__codelineno-16-35" name="__codelineno-16-35"></a>    <span class="c1"># route init-session</span>
<a id="__codelineno-16-36" name="__codelineno-16-36"></a>    <span class="n">url_services</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">][</span><span class="s1">&#39;url_services&#39;</span><span class="p">]</span>
<a id="__codelineno-16-37" name="__codelineno-16-37"></a>    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;with_csrftoken&#39;</span><span class="p">]:</span>
<a id="__codelineno-16-38" name="__codelineno-16-38"></a>        <span class="n">url_services</span><span class="p">[</span><span class="s1">&#39;init-session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/init-session-without-csrftoken&#39;</span>
<a id="__codelineno-16-39" name="__codelineno-16-39"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-16-40" name="__codelineno-16-40"></a>        <span class="n">url_services</span><span class="p">[</span><span class="s1">&#39;init-session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/init-session&#39;</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 31 : un booléen indiquera au client si le serveur auquel il s’adresse travaille ou non avec des jetons CSRF ;</li>
<li>lignes 37-40 : on fixe l’URL de service de l’action <strong>[init-session]</strong> :</li>
<li>si le serveur utilise des jetons CSRF alors l’URL de service est <strong>[</strong><strong>/init-session-without-csrftoken</strong><strong>]</strong> ;</li>
<li>sinon l’URL de service est <strong>[</strong><strong>/init-session</strong><strong>]</strong> ;
La route <strong>[</strong><strong>/init-session-without-csrftoken</strong><strong>]</strong> a été présentée. Elle permet à un client jSON / XML de démarrer une session avec le serveur sans posséder de jeton CSRF. Il trouvera ce jeton dans la réponse du serveur.</li>
</ul>
<p>Nous modifions ensuite la classe <strong>[</strong><strong>ImpôtsDaoWithHttpSession</strong><strong>]</strong> implémentant la couche <strong>[dao]</strong> du client :</p>
<p><img src="images/100000000000023A0000012AE88F5267.png" style="width:6.571cm;height:3.44cm;" alt="Image" /></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">  1</a></span>
<span class="normal"><a href="#__codelineno-17-2">  2</a></span>
<span class="normal"><a href="#__codelineno-17-3">  3</a></span>
<span class="normal"><a href="#__codelineno-17-4">  4</a></span>
<span class="normal"><a href="#__codelineno-17-5">  5</a></span>
<span class="normal"><a href="#__codelineno-17-6">  6</a></span>
<span class="normal"><a href="#__codelineno-17-7">  7</a></span>
<span class="normal"><a href="#__codelineno-17-8">  8</a></span>
<span class="normal"><a href="#__codelineno-17-9">  9</a></span>
<span class="normal"><a href="#__codelineno-17-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-17-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-17-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-17-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-17-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-17-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-17-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-17-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-17-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-17-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-17-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-17-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-17-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-17-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-17-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-17-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-17-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-17-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-17-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-17-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-17-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-17-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-17-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-17-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-17-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-17-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-17-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-17-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-17-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-17-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-17-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-17-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-17-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-17-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-17-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-17-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-17-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-17-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-17-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-17-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-17-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-17-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-17-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-17-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-17-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-17-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-17-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-17-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-17-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-17-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-17-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-17-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-17-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-17-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-17-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-17-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-17-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-17-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-17-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-17-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-17-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-17-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-17-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-17-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-17-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-17-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-17-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-17-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-17-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-17-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-17-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-17-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-17-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-17-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-17-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-17-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-17-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-17-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-17-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-17-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-17-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-17-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-17-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-17-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-17-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-17-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-17-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-17-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-17-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-17-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-17-100">100</a></span>
<span class="normal"><a href="#__codelineno-17-101">101</a></span>
<span class="normal"><a href="#__codelineno-17-102">102</a></span>
<span class="normal"><a href="#__codelineno-17-103">103</a></span>
<span class="normal"><a href="#__codelineno-17-104">104</a></span>
<span class="normal"><a href="#__codelineno-17-105">105</a></span>
<span class="normal"><a href="#__codelineno-17-106">106</a></span>
<span class="normal"><a href="#__codelineno-17-107">107</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1"># imports</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">xmltodict</span>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">AbstractImpôtsDao</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbstractImpôtsDao</span>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">AdminData</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdminData</span>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceImpôtsDaoWithHttpSession</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceImpôtsDaoWithHttpSession</span>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">TaxPayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaxPayer</span>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a>
<a id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">ImpôtsDaoWithHttpSession</span><span class="p">(</span><span class="n">InterfaceImpôtsDaoWithHttpSession</span><span class="p">):</span>
<a id="__codelineno-17-15" name="__codelineno-17-15"></a>
<a id="__codelineno-17-16" name="__codelineno-17-16"></a>    <span class="c1"># constructeur</span>
<a id="__codelineno-17-17" name="__codelineno-17-17"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-17-18" name="__codelineno-17-18"></a>        <span class="c1"># initialisation parent</span>
<a id="__codelineno-17-19" name="__codelineno-17-19"></a>        <span class="n">AbstractImpôtsDao</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-17-20" name="__codelineno-17-20"></a>        <span class="c1"># mémorisation éléments de la configuration</span>
<a id="__codelineno-17-21" name="__codelineno-17-21"></a>        <span class="c1"># config générale</span>
<a id="__codelineno-17-22" name="__codelineno-17-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-17-23" name="__codelineno-17-23"></a>        <span class="c1"># serveur</span>
<a id="__codelineno-17-24" name="__codelineno-17-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">]</span>
<a id="__codelineno-17-25" name="__codelineno-17-25"></a>        <span class="c1"># services</span>
<a id="__codelineno-17-26" name="__codelineno-17-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__config_services</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">][</span><span class="s1">&#39;url_services&#39;</span><span class="p">]</span>
<a id="__codelineno-17-27" name="__codelineno-17-27"></a>        <span class="c1"># mode debug</span>
<a id="__codelineno-17-28" name="__codelineno-17-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__debug</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">]</span>
<a id="__codelineno-17-29" name="__codelineno-17-29"></a>        <span class="c1"># logger</span>
<a id="__codelineno-17-30" name="__codelineno-17-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-17-31" name="__codelineno-17-31"></a>        <span class="c1"># cookies</span>
<a id="__codelineno-17-32" name="__codelineno-17-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__cookies</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-17-33" name="__codelineno-17-33"></a>        <span class="c1"># type de session (json, xml)</span>
<a id="__codelineno-17-34" name="__codelineno-17-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__session_type</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-17-35" name="__codelineno-17-35"></a>        <span class="c1"># jeton CSRF</span>
<a id="__codelineno-17-36" name="__codelineno-17-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__csrf_token</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-17-37" name="__codelineno-17-37"></a>
<a id="__codelineno-17-38" name="__codelineno-17-38"></a>    <span class="c1"># étape request / response</span>
<a id="__codelineno-17-39" name="__codelineno-17-39"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">url_service</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data_value</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">json_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-17-40" name="__codelineno-17-40"></a>        <span class="c1"># [method] : méthode HTTP GET ou POST</span>
<a id="__codelineno-17-41" name="__codelineno-17-41"></a>        <span class="c1"># [url_service] : URL de service</span>
<a id="__codelineno-17-42" name="__codelineno-17-42"></a>        <span class="c1"># [data] : paramètres du POST en x-www-form-urlencoded</span>
<a id="__codelineno-17-43" name="__codelineno-17-43"></a>        <span class="c1"># [json] : paramètres du POST en json</span>
<a id="__codelineno-17-44" name="__codelineno-17-44"></a>        <span class="c1"># [cookies]: cookies à inclure dans la requête</span>
<a id="__codelineno-17-45" name="__codelineno-17-45"></a>
<a id="__codelineno-17-46" name="__codelineno-17-46"></a>        <span class="c1"># on doit avoir une session XML ou JSON, sinon on ne pourra pas gérer la réponse</span>
<a id="__codelineno-17-47" name="__codelineno-17-47"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__session_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="s1">&#39;xml&#39;</span><span class="p">]:</span>
<a id="__codelineno-17-48" name="__codelineno-17-48"></a>            <span class="k">raise</span> <span class="n">ImpôtsError</span><span class="p">(</span><span class="mi">73</span><span class="p">,</span> <span class="s2">&quot;il n&#39;y a pas de session valide en cours&quot;</span><span class="p">)</span>
<a id="__codelineno-17-49" name="__codelineno-17-49"></a>
<a id="__codelineno-17-50" name="__codelineno-17-50"></a>        <span class="c1"># on ajoute le jeton CSRF à l&#39;URL de service</span>
<a id="__codelineno-17-51" name="__codelineno-17-51"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__csrf_token</span><span class="p">:</span>
<a id="__codelineno-17-52" name="__codelineno-17-52"></a>            <span class="n">url_service</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">url_service</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__csrf_token</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-17-53" name="__codelineno-17-53"></a>
<a id="__codelineno-17-54" name="__codelineno-17-54"></a>        <span class="c1"># exécution de la requête</span>
<a id="__codelineno-17-55" name="__codelineno-17-55"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span>
<a id="__codelineno-17-56" name="__codelineno-17-56"></a>                                    <span class="n">url_service</span><span class="p">,</span>
<a id="__codelineno-17-57" name="__codelineno-17-57"></a>                                    <span class="n">data</span><span class="o">=</span><span class="n">data_value</span><span class="p">,</span>
<a id="__codelineno-17-58" name="__codelineno-17-58"></a>                                    <span class="n">json</span><span class="o">=</span><span class="n">json_value</span><span class="p">,</span>
<a id="__codelineno-17-59" name="__codelineno-17-59"></a>                                    <span class="n">cookies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__cookies</span><span class="p">,</span>
<a id="__codelineno-17-60" name="__codelineno-17-60"></a>                                    <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-17-61" name="__codelineno-17-61"></a>
<a id="__codelineno-17-62" name="__codelineno-17-62"></a>        <span class="c1"># mode debug ?</span>
<a id="__codelineno-17-63" name="__codelineno-17-63"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug</span><span class="p">:</span>
<a id="__codelineno-17-64" name="__codelineno-17-64"></a>            <span class="c1"># logueur</span>
<a id="__codelineno-17-65" name="__codelineno-17-65"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="p">:</span>
<a id="__codelineno-17-66" name="__codelineno-17-66"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__config</span><span class="p">[</span><span class="s1">&#39;logger&#39;</span><span class="p">]</span>
<a id="__codelineno-17-67" name="__codelineno-17-67"></a>            <span class="c1"># on logue</span>
<a id="__codelineno-17-68" name="__codelineno-17-68"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-17-69" name="__codelineno-17-69"></a>
<a id="__codelineno-17-70" name="__codelineno-17-70"></a>        <span class="c1"># résultat</span>
<a id="__codelineno-17-71" name="__codelineno-17-71"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__session_type</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
<a id="__codelineno-17-72" name="__codelineno-17-72"></a>            <span class="n">résultat</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-17-73" name="__codelineno-17-73"></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># xml</span>
<a id="__codelineno-17-74" name="__codelineno-17-74"></a>            <span class="n">résultat</span> <span class="o">=</span> <span class="n">xmltodict</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[</span><span class="mi">39</span><span class="p">:])[</span><span class="s1">&#39;root&#39;</span><span class="p">]</span>
<a id="__codelineno-17-75" name="__codelineno-17-75"></a>
<a id="__codelineno-17-76" name="__codelineno-17-76"></a>        <span class="c1"># on récupère les cookies de la réponse s&#39;il y en a</span>
<a id="__codelineno-17-77" name="__codelineno-17-77"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
<a id="__codelineno-17-78" name="__codelineno-17-78"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__cookies</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">cookies</span>
<a id="__codelineno-17-79" name="__codelineno-17-79"></a>
<a id="__codelineno-17-80" name="__codelineno-17-80"></a>        <span class="c1"># on récupère le jeton CSRF</span>
<a id="__codelineno-17-81" name="__codelineno-17-81"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__config</span><span class="p">[</span><span class="s1">&#39;with_csrftoken&#39;</span><span class="p">]:</span>
<a id="__codelineno-17-82" name="__codelineno-17-82"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__csrf_token</span> <span class="o">=</span> <span class="n">résultat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;csrf_token&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-17-83" name="__codelineno-17-83"></a>
<a id="__codelineno-17-84" name="__codelineno-17-84"></a>        <span class="c1"># code de statut</span>
<a id="__codelineno-17-85" name="__codelineno-17-85"></a>        <span class="n">status_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
<a id="__codelineno-17-86" name="__codelineno-17-86"></a>
<a id="__codelineno-17-87" name="__codelineno-17-87"></a>        <span class="c1"># si code de statut différent de 200 OK</span>
<a id="__codelineno-17-88" name="__codelineno-17-88"></a>        <span class="k">if</span> <span class="n">status_code</span> <span class="o">!=</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">:</span>
<a id="__codelineno-17-89" name="__codelineno-17-89"></a>            <span class="k">raise</span> <span class="n">ImpôtsError</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="n">résultat</span><span class="p">[</span><span class="s1">&#39;réponse&#39;</span><span class="p">])</span>
<a id="__codelineno-17-90" name="__codelineno-17-90"></a>
<a id="__codelineno-17-91" name="__codelineno-17-91"></a>        <span class="c1"># on rend le résultat</span>
<a id="__codelineno-17-92" name="__codelineno-17-92"></a>        <span class="k">return</span> <span class="n">résultat</span><span class="p">[</span><span class="s1">&#39;réponse&#39;</span><span class="p">]</span>
<a id="__codelineno-17-93" name="__codelineno-17-93"></a>
<a id="__codelineno-17-94" name="__codelineno-17-94"></a>    
<a id="__codelineno-17-95" name="__codelineno-17-95"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-17-96" name="__codelineno-17-96"></a>        <span class="c1"># on note le type de la session</span>
<a id="__codelineno-17-97" name="__codelineno-17-97"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__session_type</span> <span class="o">=</span> <span class="n">session_type</span>
<a id="__codelineno-17-98" name="__codelineno-17-98"></a>
<a id="__codelineno-17-99" name="__codelineno-17-99"></a>        <span class="c1"># on supprime le jeton CSRF des précédents appels</span>
<a id="__codelineno-17-100" name="__codelineno-17-100"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__csrf_token</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-17-101" name="__codelineno-17-101"></a>
<a id="__codelineno-17-102" name="__codelineno-17-102"></a>        <span class="c1"># on demande l&#39;URL de l&#39;action init-session</span>
<a id="__codelineno-17-103" name="__codelineno-17-103"></a>        <span class="n">url_service</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span><span class="p">[</span><span class="s1">&#39;urlServer&#39;</span><span class="p">]</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">__config_services</span><span class="p">[</span><span class="s1">&#39;init-session&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">session_type</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-17-104" name="__codelineno-17-104"></a>
<a id="__codelineno-17-105" name="__codelineno-17-105"></a>        <span class="c1"># exécution requête</span>
<a id="__codelineno-17-106" name="__codelineno-17-106"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">url_service</span><span class="p">)</span>
<a id="__codelineno-17-107" name="__codelineno-17-107"></a><span class="err">…</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 38-92 : la gestion du jeton CSRF se passe principalement dans la méthode <strong>[get_response]</strong> ;</li>
<li>
<p>ligne 60 : le point important est le paramètre <strong>[allow_redirects=True]</strong>. C’est sa valeur par défaut mais on a tenu à le mettre en relief ;
Lorsqu’on est en mode <strong>[with_csrftoken=True]</strong> :</p>
</li>
<li>
<p>les clients commencent leur dialogue avec le serveur par l’appel à la route <strong>[/init-session_without_csftoken/type_response]</strong> ;</p>
</li>
<li>le serveur répond à cette requête par une redirection vers la route <strong>[/init-session/type_response/csrf_token]</strong> ;</li>
<li>à cause du paramètre <strong>[allow_redirects=True]</strong>, cette redirection va être suivie par le client <strong>[requests]</strong> ;</li>
<li>
<p>le jeton CSRF sera trouvé dans le résultat récupéré aux lignes 72 et 74 associé à la clé <strong>[csrf_token]</strong> ;
Lorsqu’on est en mode <strong>[with_csrftoken=False]</strong> :</p>
</li>
<li>
<p>les clients commencent leur dialogue avec le serveur par l’appel à la route <strong>[/init-session /type_response]</strong> ;</p>
</li>
<li>le serveur répond à cette requête par une redirection vers la route <strong>[/init-session/type_response]</strong> ;</li>
<li>à cause du paramètre <strong>[allow_redirects=True]</strong>, cette redirection va être suivie par le client <strong>[requests]</strong> ;</li>
<li>il n’y a pas de jeton CSRF à récupérer aux lignes 81-82. La propriété <strong>[self.__csrf_token]</strong> reste alors toujours à None (ligne 36) ;</li>
<li>lignes 51-52 : pour toutes les requêtes suivantes, le jeton CSRF, s’il existe, est ajouté à la route initiale ;</li>
<li>lignes 81-82 : le nouveau jeton que génère le serveur à chaque nouvelle requête du client est mémorisé localement pour être renvoyé ligne 52 à la requête suivante ;
Par ailleurs, la méthode <strong>[init_session]</strong> évolue un peu :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a>        <span class="c1"># on note le type de la session</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__session_type</span> <span class="o">=</span> <span class="n">session_type</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a>        <span class="c1"># on supprime le jeton CSRF des précédents appels</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__csrf_token</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a>        <span class="c1"># on demande l&#39;URL de l&#39;action init-session</span>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a>        <span class="n">url_service</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span><span class="p">[</span><span class="s1">&#39;urlServer&#39;</span><span class="p">]</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">__config_services</span><span class="p">[</span><span class="s1">&#39;init-session&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">session_type</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a>
<a id="__codelineno-18-11" name="__codelineno-18-11"></a>        <span class="c1"># exécution requête</span>
<a id="__codelineno-18-12" name="__codelineno-18-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">url_service</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Il faut se rappeler ici qu’on a créé une route <strong>[/init-session-without-csrftoken/&lt;type-response&gt;]</strong> pour initialiser le dialogue client / serveur sans jeton CSRF. Or nous avons vu que la méthode <strong>[get_response]</strong> appelée ligne 12 du code ajoute systématiquement à la fin de l’URL de service le jeton CSRF mémorisé dans <strong>[</strong><strong>self</strong><strong>.__csrf_token</strong><strong>]</strong>. C’est pourquoi ligne 6 du code on supprime ce jeton CSRF s’il existait.</p>
<p>C’est tout. Pour les tests, on exécutera :</p>
<ul>
<li>les clients console <strong>[main, main2, main3]</strong> ;</li>
<li>les classes de test <strong>[Test1HttpClientDaoWithSession]</strong> et <strong>[Test2HttpClientDaoWithSession]</strong> ;
en mettant successivement à True puis False, le paramètre de configuration <strong>[with_csrftoken]</strong>.</li>
</ul>
<p><img src="images/1000000000000239000002062A0C2A4E.png" style="width:6.571cm;height:5.98cm;" alt="Image" /></p>
<p>Voici comme exemple les logs obtenus à l’exécution du client <strong>[main json]</strong> avec <strong>[with_csrftoken=True]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.317903</span><span class="p">,</span> <span class="n">MainThread</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt des contribuables</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.317903</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt des 4 contribuables</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.317903</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt des 2 contribuables</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.317903</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt des 4 contribuables</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.317903</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt des 1 contribuables</span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.379221</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;init-session&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">700</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;session démarrée avec le type de réponse json&quot;</span><span class="p">],</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;ImFiZmZkYjZmMzFkZDc2YWRjNWYwOGM0NTBmMGM4ODJjYzViOWI4NGEi.Xy63sw.H5L0--yWsvfaWvggrGw78z5VnN0&quot;</span><span class="p">}</span>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.381073</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;init-session&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">700</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;session démarrée avec le type de réponse json&quot;</span><span class="p">],</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;ImY5YzQyMjlkYzcyYmM4YmZiMGI0NWY5MjE4MzIzNDExZjc0MGQ3MWQi.Xy63sw.q6olg7IP_g2ro_RBFRCX1BX90g8&quot;</span><span class="p">}</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.386982</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;init-session&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">700</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;session démarrée avec le type de réponse json&quot;</span><span class="p">],</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;IjkxZGNlN2YyMmUxMjQ0M2Y0MTdjNDQ4ZmQ1MDMxZjkwNjBhNzAzZjMi.Xy63sw.-6buL11No3UJBlElpW4tX4B-lp0&quot;</span><span class="p">}</span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.390269</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;init-session&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">700</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;session démarrée avec le type de réponse json&quot;</span><span class="p">],</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;IjIxNmU4MDQyZDFmZmIyZDlmZjE4MzNlNDUzYzFjMGYxMWYxYzEwNGYi.Xy63sw.fgs6Cm2owsJf4NjTm7gKrVESabI&quot;</span><span class="p">}</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.413206</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;authentifier-utilisateur&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="s2">&quot;Authentification réussie&quot;</span><span class="p">,</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;ImFiZmZkYjZmMzFkZDc2YWRjNWYwOGM0NTBmMGM4ODJjYzViOWI4NGEi.Xy63sw.H5L0--yWsvfaWvggrGw78z5VnN0&quot;</span><span class="p">}</span>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.422877</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;calculer-impots&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">1500</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">16782</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">7176</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">9200</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">2180</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}],</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;ImFiZmZkYjZmMzFkZDc2YWRjNWYwOGM0NTBmMGM4ODJjYzViOWI4NGEi.Xy63sw.H5L0--yWsvfaWvggrGw78z5VnN0&quot;</span><span class="p">}</span>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.428622</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;authentifier-utilisateur&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="s2">&quot;Authentification réussie&quot;</span><span class="p">,</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;ImY5YzQyMjlkYzcyYmM4YmZiMGI0NWY5MjE4MzIzNDExZjc0MGQ3MWQi.Xy63sw.q6olg7IP_g2ro_RBFRCX1BX90g8&quot;</span><span class="p">}</span>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.429127</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;authentifier-utilisateur&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="s2">&quot;Authentification réussie&quot;</span><span class="p">,</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;IjkxZGNlN2YyMmUxMjQ0M2Y0MTdjNDQ4ZmQ1MDMxZjkwNjBhNzAzZjMi.Xy63sw.-6buL11No3UJBlElpW4tX4B-lp0&quot;</span><span class="p">}</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.429127</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;authentifier-utilisateur&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="s2">&quot;Authentification réussie&quot;</span><span class="p">,</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;IjIxNmU4MDQyZDFmZmIyZDlmZjE4MzNlNDUzYzFjMGYxMWYxYzEwNGYi.Xy63sw.fgs6Cm2owsJf4NjTm7gKrVESabI&quot;</span><span class="p">}</span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.429127</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;fin-session&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="s2">&quot;session réinitialisée&quot;</span><span class="p">,</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;IjU1YjlmZDA0OWRhNTJlODFmYjgyYjlhM2ExYWNhZmUzNTk2NjA5NGIi.Xy63sw.nyNSvkcG6iG0oIMBjtYPo8ySgdw&quot;</span><span class="p">}</span>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.438519</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt des 2 contribuables</span>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.443033</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;calculer-impots&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">1500</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">42842</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">17283</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}],</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;ImY5YzQyMjlkYzcyYmM4YmZiMGI0NWY5MjE4MzIzNDExZjc0MGQ3MWQi.Xy63sw.q6olg7IP_g2ro_RBFRCX1BX90g8&quot;</span><span class="p">}</span>
<a id="__codelineno-19-18" name="__codelineno-19-18"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.446510</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;calculer-impots&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">1500</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">4230</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">22986</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">64210</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">7498</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.45</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}],</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;IjkxZGNlN2YyMmUxMjQ0M2Y0MTdjNDQ4ZmQ1MDMxZjkwNjBhNzAzZjMi.Xy63sw.-6buL11No3UJBlElpW4tX4B-lp0&quot;</span><span class="p">}</span>
<a id="__codelineno-19-19" name="__codelineno-19-19"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.453477</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;calculer-impots&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">1500</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">55555</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">2814</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">1384</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">384</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">347</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">720</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">19884</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">4480</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}],</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;IjIxNmU4MDQyZDFmZmIyZDlmZjE4MzNlNDUzYzFjMGYxMWYxYzEwNGYi.Xy63sw.fgs6Cm2owsJf4NjTm7gKrVESabI&quot;</span><span class="p">}</span>
<a id="__codelineno-19-20" name="__codelineno-19-20"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.457912</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;fin-session&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="s2">&quot;session réinitialisée&quot;</span><span class="p">,</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;IjQ0ZDQxODgzN2M5NjRiYWI0NjA2MTk5YWFkNGFhMzY1M2IxNWMyNDIi.Xy63sw.mOa5MKXvJ-EXf_qEok-OqC5j_mg&quot;</span><span class="p">}</span>
<a id="__codelineno-19-21" name="__codelineno-19-21"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.458442</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt des 1 contribuables</span>
<a id="__codelineno-19-22" name="__codelineno-19-22"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.459045</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;fin-session&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="s2">&quot;session réinitialisée&quot;</span><span class="p">,</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;ImQ0NDZlYmViYjY1ZDUxYzJhMTNmM2JiZTRkMjBjZGJkYzE0OGVkYzMi.Xy63sw.fviTJz4zFDqVLlVlkrosT_JRPww&quot;</span><span class="p">}</span>
<a id="__codelineno-19-23" name="__codelineno-19-23"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.459700</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt des 4 contribuables</span>
<a id="__codelineno-19-24" name="__codelineno-19-24"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.460492</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;fin-session&quot;</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="s2">&quot;session réinitialisée&quot;</span><span class="p">,</span> <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="s2">&quot;Ijg3MjQ1NGUyYTUyOGEyNTdmZmNmYWZkMmU2OTgyMzUwNjI1YTlhZjIi.Xy63sw.I0xBl9Q8DzsuXPSgOdeARc_VKBA&quot;</span><span class="p">}</span>
<a id="__codelineno-19-25" name="__codelineno-19-25"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.460492</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt des 4 contribuables</span>
<a id="__codelineno-19-26" name="__codelineno-19-26"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span> <span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mf">23.460492</span><span class="p">,</span> <span class="n">MainThread</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt des contribuables</span>
</code></pre></div></td></tr></table></div>
<p>Si on regarde les jetons CSRF reçus successivement on voit qu’ils sont tous différents.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner">

      <div>
        <a href="https://tahe.developpez.com" target="_blank">
          https://tahe.developpez.com
        </a>
        <br>
        Ce cours tutoriel écrit par <strong>Serge Tahé</strong> est mis à disposition du public selon les termes de la
        <em>Licence Creative Commons Attribution – Pas d’Utilisation Commerciale –
        Partage dans les Mêmes Conditions 3.0 non transposé</em>.
      </div>

    </div>
  </div>

      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": ".", "features": ["navigation.sections", "navigation.indexes", "toc.integrate", "navigation.top"], "search": "assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="javascripts/focus.js"></script>
      
    
  </body>
</html>