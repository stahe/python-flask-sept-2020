
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Introduction au langage Python 3 et au framework web Flask par l'exemple">
      
      
        <meta name="author" content="Serge Tahé">
      
      
        <link rel="canonical" href="https://stahe.github.io/python-flask-sept-2020/exercice-dapplication-version-12.html">
      
      
        <link rel="prev" href="exercice-dapplication-version-11.html">
      
      
        <link rel="next" href="clients-web-pour-les-services-json-et-xml-de-la-version-12.html">
      
      
        
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>30. Exercice d’application : version 12 - Introduction au langage Python 3 et au framework web Flask par l'exemple</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="stylesheets/focus.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#30-exercice-dapplication-version-12" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Introduction au langage Python 3 et au framework web Flask par l&#39;exemple" class="md-header__button md-logo" aria-label="Introduction au langage Python 3 et au framework web Flask par l'exemple" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Introduction au langage Python 3 et au framework web Flask par l'exemple
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              30. Exercice d’application : version 12
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode sombre"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Passer au mode sombre" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode clair"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Passer au mode clair" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/stahe/python-flask-sept-2020" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Introduction au langage Python 3 et au framework web Flask par l&#39;exemple" class="md-nav__button md-logo" aria-label="Introduction au langage Python 3 et au framework web Flask par l'exemple" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Introduction au langage Python 3 et au framework web Flask par l'exemple
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/stahe/python-flask-sept-2020" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accueil
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="avant-propos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Avant-propos
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="installation-dx27un-environnement-de-travail.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Installation d&#x27;un environnement de travail
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-bases-de-python.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Les bases de Python
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-chaines-de-caracteres.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Les chaînes de caractères
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-exceptions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Les exceptions
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-fonctions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Les fonctions
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-fichiers-texte.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    7. Les fichiers texte
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application---version-1.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    8. Exercice d&#x27;application – version 1
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-imports.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    9. Les imports
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-2.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    10. Exercice d’application : version 2
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-3.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    11. Exercice d’application : version 3
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-classes-et-objets.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    12. Les classes et objets
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-classes-generiques-baseentity-et-myexception.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    13. Les classes génériques [BaseEntity] et [MyException]
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="architecture-en-couches-et-programmation-par-interfaces.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    14. Architecture en couches et programmation par interfaces
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application---version-4.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    15. Exercice d&#x27;application - version 4
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-du-sgbd-mysql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    16. Utilisation du SGBD MySQL
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-du-sgbd-postgresql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    17. Utilisation du SGBD PostgreSQL
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="ecrire-du-code-independant-du-sgbd.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    18. Ecrire du code indépendant du SGBD
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-de-lorm-sqlalchemy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    19. Utilisation de l’ORM SQLALCHEMY
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application-version-5.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    20. Exercice d&#x27;application : version 5
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="fonctions-internet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    21. Fonctions internet
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="services-web-avec-le-framework-flask.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    22. Services web avec le framework Flask
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-6.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    23. Exercice d’application : version 6
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-7.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    24. Exercice d’application : version 7
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-8.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    25. Exercice d’application : version 8
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="du-dictionnaire-a-xml-et-vice-versa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    26. Du dictionnaire à XML et vice-versa
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-9.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    27. Exercice d’application : version 9
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-10.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    28. Exercice d’application : version 10
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-11.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    29. Exercice d’application : version 11
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    30. Exercice d’application : version 12
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="exercice-dapplication-version-12.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    30. Exercice d’application : version 12
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#301-architecture-mvc" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.1. Architecture MVC
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#302-architecture-de-lapplication-client-serveur" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.2. Architecture de l’application client / serveur
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#303-larborescence-du-code-du-serveur" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.3. L’arborescence du code du serveur
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#304-les-url-de-service-de-lapplication" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.4. Les URL de service de l’application
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#305-configuration-du-serveur" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.5. Configuration du serveur
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#306-cheminement-dune-requete-client-au-sein-du-serveur" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.6. Cheminement d’une requête client au sein du serveur
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="30.6. Cheminement d’une requête client au sein du serveur">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3061-le-script-main" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.6.1. Le script [main]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3062-le-controleur-principal-maincontroller" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.6.2. Le contrôleur principal [MainController]
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#307-traitement-specifique-a-une-action" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.7. Traitement spécifique à une action
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#308-elaboration-de-la-reponse-http-du-serveur" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.8. Elaboration de la réponse HTTP du serveur
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#309-premiers-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.9. Premiers tests
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3010-laction-authentifier-utilisateur" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.10. L’action [authentifier-utilisateur]
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3011-laction-calculer_impot" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.11. L’action [calculer_impot]
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3012-laction-lister-simulations" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.12. L’action [lister-simulations]
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3013-laction-supprimer-simulation" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.13. L’action [supprimer-simulation]
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3014-laction-fin-session" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.14. L’action [fin-session]
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3015-laction-get-admindata" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.15. L’action [get-admindata]
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3016-laction-calculer-impots" class="md-nav__link">
    <span class="md-ellipsis">
      
        30.16. L’action [calculer-impots]
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="clients-web-pour-les-services-json-et-xml-de-la-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    31. Clients web pour les services jSON et XML de la version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="le-mode-html-de-la-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    32. Le mode HTML de la version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-13.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    33. Exercice d’application : version 13
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-14.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    34. Exercice d’application : version 14
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-15.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    35. Exercice d’application : version 15
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-16.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    36. Exercice d’application : version 16
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-17.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    37. Exercice d’application : version 17
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-18.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    38. Exercice d’application : version 18
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="conclusion.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    39. Conclusion
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="30-exercice-dapplication-version-12">30. Exercice d’application : version 12</h1>
<p>Nous allons dans ce chapitre écrire une application web respectant l’architecture MVC (Modèle-Vue-Contrôleur). L’application pourra délivrer ses réponses dans trois formats : jSON, XML, HTML. Il y a un saut de complexité entre ce que nous allons faire maintenant et ce qui a été fait précédemment. Nous allons réutiliser la plupart des concepts vus jusqu’à maintenant et allons détailler toutes les étapes menant à l’application finale.</p>
<h2 id="301-architecture-mvc">30.1. Architecture MVC</h2>
<p>Nous allons implémenter le modèle d&#x27;architecture dit MVC (Modèle – Vue – Contrôleur) de la façon suivante :</p>
<p><img src="images/10000001000003320000010243F9EAD1.png" style="width:13.831cm;height:4.351cm;" alt="Image" /></p>
<p>Le traitement d&#x27;une demande d&#x27;un client se déroulera de la façon suivante :</p>
<ul>
<li>
<p>1 - demande
Les URL demandées seront de la forme http://machine:port/action/param1/param2/… Le <strong>[Contrôleur principal]</strong> utilisera un fichier de configuration pour &quot; router &quot; la demande vers le bon contrôleur. Pour cela, il utilisera le champ <strong>[action]</strong> de l&#x27;URL. Le reste de l&#x27;URL <strong>[param1/param2/…]</strong> est formé de paramètres facultatifs qui seront transmis à l&#x27;action. Le <strong>C</strong> de MVC est ici la chaîne <strong>[Contrôleur principal, Contrôleur / Action]</strong>. Si aucun contrôleur ne peut traiter l&#x27;action demandée, le serveur web répondra que l&#x27;URL demandée n&#x27;a pas été trouvée.</p>
</li>
<li>
<p>2 - traitement</p>
</li>
<li>l&#x27;action choisie <strong>[2a]</strong> peut exploiter les paramètres parami que le <strong>[Contrôleur principal]</strong> lui a transmis. Ceux-ci pourront provenir de deux sources :</li>
<li>du chemin <strong>[/param1/param2/…]</strong> de l&#x27;URL,</li>
<li>de paramètres postés dans le corps de la requête du client ;</li>
<li>dans le traitement de la demande de l&#x27;utilisateur, l&#x27;action peut avoir besoin de la couche <strong>[métier]</strong> <strong>[2b]</strong>. Une fois la demande du client traitée, celle-ci peut appeler diverses réponses. Un exemple classique est :</li>
<li>une réponse d&#x27;erreur si la demande n&#x27;a pu être traitée correctement ;</li>
<li>une réponse de confirmation sinon ;</li>
<li>le <strong>[Contrôleur / Action]</strong> rendra sa réponse <strong>[2c]</strong> au contrôleur principal ainsi qu’un code d’état. Ces codes d’état représenteront de façon unique l’état dans lequel se trouve l’application. Ce sera soit un code de réussite, soit un code d’erreur ;</li>
<li>3 - réponse</li>
<li>selon que le client a demandé une réponse jSON, XML ou HTML, le <strong>[Contrôleur principal]</strong> instanciera <strong>[3a]</strong> le type de réponse appropriée et demandera à celle-ci d’envoyer la réponse au client. Le <strong>[Contrôleur principal]</strong> lui transmettra et la réponse et le code d’état fournis par le <strong>[Contrôleur / Action]</strong> qui a été exécuté ;</li>
<li>si la réponse souhaitée est de type jSON ou XML, la réponse sélectionnée mettra en forme la réponse du <strong>[Contrôleur / Action]</strong> qu’on lui a donnée et l’enverra <strong>[3c]</strong>. Le client capable d’exploiter cette réponse peut être un script console Python ou un script Javascript logé dans une page HTML ;</li>
<li>si la réponse souhaitée est de type HTML, la réponse sélectionnée sélectionnera <strong>[3b]</strong> une des <strong>vues</strong> HTML <strong>[Vuei]</strong> à l’aide du code d’état qu’on lui a donné. C’est le <strong>V</strong> de MVC. A un code d’état correspond une unique vue. Cette vue <strong>V</strong> va afficher la réponse du  <strong>[Contrôleur / Action]</strong> qui a été exécuté. Elle habille avec du HTML, CSS, Javascript les données de cette réponse. On appelle ces données le <strong>modèle de la vue</strong>. C&#x27;est le <strong>M</strong> de MVC. Le client est alors le plus souvent un navigateur ;
Maintenant, précisons le lien entre architecture web MVC et architecture en couches. Selon la définition qu&#x27;on donne au <strong>modèle</strong>, ces deux concepts sont liés ou non. Prenons une application web MVC à une couche :</li>
</ul>
<p><img src="images/10000001000002C0000000F3C259C5FB.png" style="width:11.941cm;height:4.121cm;" alt="Image" /></p>
<p>Ci-dessus, les <strong>[Contrôleur / Action]</strong> intègrent chacun une partie des couches <strong>[métier]</strong> et <strong>[dao]</strong>. Dans la couche <strong>[web]</strong> on a bien une architecture MVC mais l’ensemble de l’application n’a pas une architecture en couches. Ici il n’y a qu’une couche, la couche web, qui fait tout.</p>
<p>Maintenant, considérons une architecture web multicouche :</p>
<p><img src="images/10000000000004AF000000CE2A4AE434.png" style="width:13.821cm;height:2.38cm;" alt="Image" /></p>
<p>La couche <strong>[web]</strong> peut être implémentée sans suivre le modèle MVC. On a bien alors une architecture multicouche mais la couche web n&#x27;implémente pas le modèle MVC.</p>
<p>Par exemple, dans le monde .NET la couche <strong>[web]</strong> ci-dessus peut être implémentée avec ASP.NET MVC et on a alors une architecture en couches avec une couche <strong>[web]</strong> de type MVC. Ceci fait, on peut remplacer cette couche ASP.NET MVC par une couche ASP.NET classique (WebForms) tout en gardant le reste (métier, DAO, Pilote) <strong>à l&#x27;identique</strong>.  On a alors une architecture en couches avec une couche <strong>[web]</strong> qui n&#x27;est plus de type MVC.</p>
<p>Dans MVC, nous avons dit que le modèle M était celui de la vue V, c.a.d. l&#x27;ensemble des données affichées par la vue V. Une autre définition du modèle M de MVC est donnée :</p>
<p><img src="images/10000000000004AD000000BE31C43437.png" style="width:13.821cm;height:2.192cm;" alt="Image" /></p>
<p>Beaucoup d&#x27;auteurs considèrent que ce qui est à droite de la couche <strong>[web]</strong> forme le modèle M du MVC. Pour éviter les ambigüités on peut parler :</p>
<ul>
<li>du <strong>modèle du domaine</strong> lorsqu&#x27;on désigne tout ce qui est à droite de la couche <strong>[web]</strong> ;</li>
<li>du <strong>modèle de la vue</strong> lorsqu&#x27;on désigne les données affichées par une vue V ;
Dans ce qui suit, lorsque nous parlerons de modèle, il s’agita toujours du <strong>modèle de la vue</strong>.</li>
</ul>
<h2 id="302-architecture-de-lapplication-client-serveur">30.2. Architecture de l’application client / serveur</h2>
<p>L’application web aura l’architecture suivante :</p>
<p><img src="images/10000000000003BC0000053607429669.png" style="width:11.052cm;height:15.371cm;" alt="Image" /></p>
<ul>
<li>en <strong>[1]</strong> le serveur web aura deux types de clients :</li>
<li>en <strong>[2]</strong>, un client console qui échangera du jSON et du XML avec le serveur ;</li>
<li>en <strong>[3]</strong>, un navigateur qui recevra du HTML du serveur et l’affichera ; </li>
<li>le serveur web <strong>[1]</strong> conserve les couches <strong>[métier]</strong> et <strong>[dao]</strong> des versions précédentes ;</li>
<li>le client web <strong>[2]</strong> évoluera pour tenir compte des nouvelles URL de service de l’application web ;</li>
<li>
<p>l’application HTML afichée par le navigateur est à écrire complètement ;
Nous allons développer l’application en plusieurs temps :</p>
</li>
<li>
<p>nous allons développer la version jSON du serveur. Nous testerons les URL de service du serveur les unes après les autres avec un client Postman. Cette méthode nous permet de construire l’ossature du seveur web sans nous préoccuper des vues (=HTML) de l’application ;</p>
</li>
<li>après avoir testé le serveur jSON avec Postman, nous le testerons avec un client console ;</li>
<li>puis nous passerons à la version XML du serveur. Nous avons vu que le passage du jSON au XML était trivial ;</li>
<li>enfin nous passerons à la version HTML du serveur. Nous construirons une architecture MVC et définirons les vues à afficher. L’application HTML sera testée à la fois avec le client Postman et un navigateur classique ;</li>
</ul>
<h2 id="303-larborescence-du-code-du-serveur">30.3. L’arborescence du code du serveur</h2>
<ul>
<li>en <strong>[1 : le serveur web dans sa globalité ;</strong></li>
</ul>
<p><img src="images/100000000000052E00000191E4FCA526.png" style="width:15.301cm;height:4.631cm;" alt="Image" /></p>
<ul>
<li><strong>en [2]</strong> : nous ignorerons pour l’instant les dossiers <strong>[static, templates, tests_views]</strong> qui concernent la version HTML du serveur. En-dehors de ce dossier nous trouverons le script principal <strong>[main]</strong> et sa configuration ;</li>
<li>en <strong>[3]</strong>, les contrôleurs du serveur web. Ce seront des instances de classes ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000017C00000179A4B96CF2.png" style="display:inline-block; margin:4px;width:4.381cm;height:4.351cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001B2000001291DBA70C4.png" style="display:inline-block; margin:4px;width:5.01cm;height:3.432cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<ul>
<li>en <strong>[4]</strong>, la réponse HTTP du serveur sera gérée par des classes ;</li>
<li>en <strong>[5]</strong>, nous conservons le fichier de logs des serveurs précédents ;
Lorsque nous construirons la version HTML du serveur, d’autres dossiers interviendront :</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001DB00000246F98D7DD7.png" style="display:inline-block; margin:4px;width:5.49cm;height:6.73cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001FA000001893C83F7F1.png" style="display:inline-block; margin:4px;width:5.841cm;height:4.541cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<ul>
<li>en <strong>[6]</strong>, les éléments statiques de l’application HTML ;</li>
<li>en <strong>[7]</strong>, les templates de l’application HTML décomposés en vues <strong>[9]</strong> et en fragments de vue <strong>[8]</strong> ;</li>
<li>en <strong>[9]</strong>, les classes implémentant les modèles des vues ;</li>
</ul>
<h2 id="304-les-url-de-service-de-lapplication">30.4. Les URL de service de l’application</h2>
<p>Pour construire le serveur web, nous allons procéder de la façon suivante :</p>
<ul>
<li>à partir des vues de l’application HTML, nous allons définir les actions que doit implémenter l’application web. Nous allons ici utiliser les vues réelles mais ce pourrait être simplement des vues sur papier ;</li>
<li>à partir de ces actions, nous allons définir les URL de service de l’application HTML ;</li>
<li>nous allons implémenter ces URL de service avec un serveur délivrant du jSON. Cela permet de définir l’ossature du serveur web sans se préoccuper des pages HTML à délivrer. Nous testerons ces URL de service avec Postman ;</li>
<li>nous testerons ensuite notre serveur jSON avec un client console ;</li>
<li>
<p>une fois que le serveur jSON aura été validé, nous passerons à l’ériture de l’application HTML ;
La 1ère vue sera la vue d’authentification :</p>
</li>
<li>
<p>l’action qui mène à cette 1ère vue s’appellera <strong>[init-session]</strong> <strong>[1]</strong> ;</p>
</li>
</ul>
<p><img src="images/100000000000052F0000035AF3022D8F.png" style="width:15.331cm;height:9.921cm;" alt="Image" /></p>
<ul>
<li>le clic sur le bouton <strong>[Valider]</strong> va déclencher l’action <strong>[authentifier-utilisateur]</strong> avec deux paramètres postés <strong>[2-3]</strong> ;
La vue du calcul de l’impôt :</li>
</ul>
<p><img src="images/100000000000050B00000373E5FBF2A5.png" style="width:14.922cm;height:10.201cm;" alt="Image" /></p>
<ul>
<li>en <strong>[1]</strong>, l’action <strong>[authentifier-utilisateur]</strong> qui a amené à cette vue ;</li>
<li>en <strong>[2]</strong>, le clic sur le bouton <strong>[Valider]</strong> déclenche l’exécution de l’action <strong>[calculer-impot]</strong> avec trois paramètres postés <strong>[2-5]</strong> ;</li>
<li>le clic sur le lien <strong>[6]</strong> déclenche l’action <strong>[lister-simulations]</strong> sans paramètres ;</li>
<li>le clic sur le lien <strong>[7]</strong> déclenche l’action <strong>[fin-session]</strong> sans paramètres ;
La 3ième vue est celle des simulations faites par l’utilisateur authentifié :</li>
</ul>
<p><img src="images/100000000000052700000248AB35CBDA.png" style="width:15.221cm;height:6.751cm;" alt="Image" /></p>
<ul>
<li>en <strong>[3]</strong>, l’action <strong>[lister-simulations]</strong> qui a amené à cette vue ;</li>
<li>en <strong>[2]</strong>, un clic sur le lien <strong>[Supprimer]</strong> déclenche l’action <strong>[supprimer-simulation]</strong> avec un paramètre, le n° de la simulation à supprimer dans la liste ;</li>
<li>un clic sur le lien <strong>[3]</strong> déclenche l’action <strong>[afficher-calcul-impot]</strong> sans paramètres qui réaffiche la vue du calcul de l’impôt ;</li>
<li>un clic sur le lien <strong>[4]</strong> déclenche l’action <strong>[fin-session]</strong> sans paramètres ;
Avec ces premières informations, nous pouvons définir les différentes URL de service du serveur :</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Action</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Rôle</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Contexte d’exécution</b></p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">/init-session</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Sert à fixer le type (json, xml, html) des réponses souhaitées</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Requête <b>GET</b></p><p style="margin:0;">Peut être émise à tout moment</p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">/authentifier-utilisateur</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Autorise ou non un utilisateur à se connecter</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Requête <b>POST.</b></p><p style="margin:0;">La requête doit avoir deux paramètres postés <b>[user, password]</b></p><p style="margin:0;">Ne peut être émise que si le type de la session (json, xml, html) est connu</p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">/calculer-impot</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Fait une simulation de calcul d’impôt</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Requête <b>POST.</b></p><p style="margin:0;">La requête doit avoir trois paramètres postés <b>[marié, enfants, salaire]</b></p><p style="margin:0;">Ne peut être émise que si le type de la session (json, xml, html) est connu et l’utilisateur authentifié</p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">/lister-simulations</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Demande à voir la liste des simulations opérées depuis le début de la session</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Requête <b>GET.</b></p><p style="margin:0;">Ne peut être émise que si le type de la session (json, xml, html) est connu et l’utilisateur authentifié</p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">/supprimer-simulation/numéro</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Supprime une simulation de la liste des simulations</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Requête <b>GET.</b></p><p style="margin:0;">Ne peut être émise que si le type de la session (json, xml, html) est connu et l’utilisateur authentifié</p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">/afficher-calcul-impot</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Affiche la page HTML du calul de l’impôt</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Requête <b>GET</b>.</p><p style="margin:0;">Ne peut être émise que si le type de la session (json, xml, html) est connu et l’utilisateur authentifié</p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">/fin-session</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Termine la session de simulations.</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Techniquement l’ancienne session web est supprimée et une nouvelle session est créée</p><p style="margin:0;">Ne peut être émise que si le type de la session (json, xml, html) est connu et l’utilisateur authentifié</p></td></tr></table>

<p>Ces différentes URL de service seront utilisées aussi bien pour le serveur HTML que pour les serveurs jSON ou XML. Deux URL ne seront utilisées que pour ces deux derniers serveurs : ce sont les URL de la version précédente du client / serveur web que nous reprenons ici :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Action</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Rôle</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Contexte d’exécution</b></p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">/get-admindata</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Rend les données fiscales permettant le calcul de l’impôt</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Requête GET.</p><p style="margin:0;">N’est utilisée que si le type de la session est json ou xml. L’utilisateur doit être authentifié</p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">/calculer-impots</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Fait le calcul de l’impôt d’une liste de contribuables postés en jSON</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Requête GET.</p><p style="margin:0;">N’est utilisée que si le type de la session est json ou xml. L’utilisateur doit être authentifié</p></td></tr></table>

<p>Tous les contrôleurs associés à ces actions procèderont de la même façon :</p>
<ul>
<li>ils vérifieront leurs paramètres. Ceux-ci sont trouvés dans l’objet :</li>
<li><strong>[request.path]</strong> pour les paramètres présents dans l’URL sous la forme <strong>[/action/param1/param2/…]</strong> ;</li>
<li>dans l’objet <strong>[request.form]</strong> pour ceux qui sont transmis en <strong>[x-www-form-urlencoded]</strong> dans le corps de la requête ;</li>
<li>dans l’objet <strong>[request.data]</strong> pour ceux qui sont transmis en jSON dans le corps de la requête ;</li>
<li>un contrôleur s’apparente à une fonction ou méthode qui vérifie la validité de ses paramètres. Pour le contrôleur c’est cependant un peu plus compliqué :</li>
<li>les paramètres attendus peuvent être absents ;</li>
<li>les paramètres récupérés par le contrôleur sont des chaînes de caractères. Si le paramètre attendu est un nombre, alors le contrôleur doit vérifier que la chaîne de caractères du paramètre est bien celle d’un nombre ;</li>
<li>une fois vérifié, que les paramètres attendus sont présents et syntaxiquement corrects, il faut vérifier qu’ils sont valides dans le contexte d’exécution du moment. Ce contexte est présent dans la session. L’exemple de l’authentification est un exemple de contexte d’exécution. Certaines actions ne doivent être traitées qu’une fois le client authentifié. Généralement, une clé dans la session indique si cette authentification a eu lieu ou pas ;</li>
<li>une fois, les vérifications précédentes faites, le contrôleur secondaire peut travailler. Ce travail de vérification des paramètres est très important. On ne peut pas accepter qu’un client nous envoie n’importe quoi à n’importe quel moment de la vie de l’application. On doit contrôler totalement la vie de celle-ci ;</li>
<li>une fois son travail fait, le contrôleur secondaire rend un dictionnaire avec les clés <strong>[action, état, réponse]</strong> au contrôleur principal qui l’a appelé :</li>
<li><strong>[action]</strong> est l’action qui vient d’être exécutée ;</li>
<li><strong>[état]</strong> est un nombre à trois chiffres qui indique le résultat du traitement de l’action :</li>
<li><strong>[x00]</strong> signalera une réussite du traitement ;</li>
<li><strong>[x01]</strong> signalera un échec du traitement ;</li>
<li><strong>[réponse]</strong> est le dictionnaire des résultats sous la forme <strong>{‘réponse’:objet}</strong>. L’objet aura des structures différentes selon l’action traitée ;<br />
Nous allons maintenant passer en revue les différents contrôleurs ou ce qui revient au même les différentes actions que ces contrôleurs traitent et qui rythment la vie de l’application web.</li>
</ul>
<h2 id="305-configuration-du-serveur">30.5. Configuration du serveur</h2>
<p><img src="images/100000000000015100000132D2E60F03.png" style="width:3.901cm;height:3.53cm;" alt="Image" /></p>
<p>La configuration de la base de données <strong>[config_database]</strong> ainsi que celle des couches du serveur <strong>[config_layers]</strong> sont identiques à celles des versions précédentes. Le fichier <strong>[config]</strong> voit apparaître de nouvelles informations :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">  1</a></span>
<span class="normal"><a href="#__codelineno-0-2">  2</a></span>
<span class="normal"><a href="#__codelineno-0-3">  3</a></span>
<span class="normal"><a href="#__codelineno-0-4">  4</a></span>
<span class="normal"><a href="#__codelineno-0-5">  5</a></span>
<span class="normal"><a href="#__codelineno-0-6">  6</a></span>
<span class="normal"><a href="#__codelineno-0-7">  7</a></span>
<span class="normal"><a href="#__codelineno-0-8">  8</a></span>
<span class="normal"><a href="#__codelineno-0-9">  9</a></span>
<span class="normal"><a href="#__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="c1"># étape 1 ------</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="c1"># dossier de ce fichier</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="c1"># chemin racine</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="n">root_dir</span> <span class="o">=</span> <span class="s2">&quot;C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="c1"># dépendances</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="n">absolute_dependencies</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="c1"># dossiers du projet</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="c1"># BaseEntity, MyException</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/classes/02/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="c1"># InterfaceImpôtsDao, InterfaceImpôtsMétier, InterfaceImpôtsUi</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/interfaces&quot;</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="c1"># AbstractImpôtsdao, ImpôtsConsole, ImpôtsMétier</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/services&quot;</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="c1"># ImpotsDaoWithAdminDataInDatabase</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v05/services&quot;</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="c1"># AdminData, ImpôtsError, TaxPayer</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="c1"># Constantes, tranches</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v05/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="c1"># Logger, SendAdminMail</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/http-servers/02/utilities&quot;</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="c1"># scripts [config_database, config_layers]</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="n">script_dir</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="c1"># contrôleurs</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../controllers&quot;</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="c1"># réponses HTTP</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../responses&quot;</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="c1"># modèles des vues</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../models_for_views&quot;</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="p">]</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="c1"># on fixe le syspath</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_syspath</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="n">set_syspath</span><span class="p">(</span><span class="n">absolute_dependencies</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="c1"># dépendances du serveur web</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="c1"># les contrôleurs</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">AfficherCalculImpotController</span><span class="w"> </span><span class="kn">import</span> <span class="n">AfficherCalculImpotController</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">AuthentifierUtilisateurController</span><span class="w"> </span><span class="kn">import</span> <span class="n">AuthentifierUtilisateurController</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">CalculerImpotController</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalculerImpotController</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">CalculerImpotsController</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalculerImpotsController</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">FinSessionController</span><span class="w"> </span><span class="kn">import</span> <span class="n">FinSessionController</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">GetAdminDataController</span><span class="w"> </span><span class="kn">import</span> <span class="n">GetAdminDataController</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">InitSessionController</span><span class="w"> </span><span class="kn">import</span> <span class="n">InitSessionController</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">ListerSimulationsController</span><span class="w"> </span><span class="kn">import</span> <span class="n">ListerSimulationsController</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">MainController</span><span class="w"> </span><span class="kn">import</span> <span class="n">MainController</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">SupprimerSimulationController</span><span class="w"> </span><span class="kn">import</span> <span class="n">SupprimerSimulationController</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="c1"># les réponses HTTP</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">HtmlResponse</span><span class="w"> </span><span class="kn">import</span> <span class="n">HtmlResponse</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">JsonResponse</span><span class="w"> </span><span class="kn">import</span> <span class="n">JsonResponse</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">XmlResponse</span><span class="w"> </span><span class="kn">import</span> <span class="n">XmlResponse</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="c1"># les modèles des vues</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">ModelForAuthentificationView</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelForAuthentificationView</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">ModelForCalculImpotView</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelForCalculImpotView</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">ModelForErreursView</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelForErreursView</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">ModelForListeSimulationsView</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelForListeSimulationsView</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="c1"># étape 2 ------</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="c1"># configuration de l&#39;application</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="c1"># utilisateurs autorisés à utiliser l&#39;application</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="p">{</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>                <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="p">}</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="p">],</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="c1"># fichier de logs</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="s2">&quot;logsFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../data/logs/logs.txt&quot;</span><span class="p">,</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="c1"># config serveur SMTP</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="s2">&quot;adminMail&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="c1"># serveur SMTP</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="s2">&quot;smtp-server&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="c1"># port du serveur SMTP</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="s2">&quot;smtp-port&quot;</span><span class="p">:</span> <span class="s2">&quot;25&quot;</span><span class="p">,</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="c1"># administrateur</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;guest@localhost.com&quot;</span><span class="p">,</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;guest@localhost.com&quot;</span><span class="p">,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="c1"># sujet du mail</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;plantage du serveur de calcul d&#39;impôts&quot;</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>            <span class="c1"># tls à True si le serveur SMTP requiert une autorisation, à False sinon</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="s2">&quot;tls&quot;</span><span class="p">:</span> <span class="kc">False</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="p">},</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="c1"># durée pause thread en secondes</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="s2">&quot;sleep_time&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="c1"># actions autorisées et leurs contrôleurs</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="s2">&quot;controllers&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="c1"># initialisation d&#39;une session de calcul</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="s2">&quot;init-session&quot;</span><span class="p">:</span> <span class="n">InitSessionController</span><span class="p">(),</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="c1"># authentification d&#39;un utilisateur</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="s2">&quot;authentifier-utilisateur&quot;</span><span class="p">:</span> <span class="n">AuthentifierUtilisateurController</span><span class="p">(),</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="c1"># calcul de l&#39;impôt en mode individuel</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="s2">&quot;calculer-impot&quot;</span><span class="p">:</span> <span class="n">CalculerImpotController</span><span class="p">(),</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="c1"># calcul de l&#39;impôt en mode lots</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="s2">&quot;calculer-impots&quot;</span><span class="p">:</span> <span class="n">CalculerImpotsController</span><span class="p">(),</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="c1"># liste des simulations</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="s2">&quot;lister-simulations&quot;</span><span class="p">:</span> <span class="n">ListerSimulationsController</span><span class="p">(),</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="c1"># suppression d&#39;une simulation</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="s2">&quot;supprimer-simulation&quot;</span><span class="p">:</span> <span class="n">SupprimerSimulationController</span><span class="p">(),</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="c1"># fin de la session de calcul</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="s2">&quot;fin-session&quot;</span><span class="p">:</span> <span class="n">FinSessionController</span><span class="p">(),</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="c1"># affichage de la vue de calcul de l&#39;impôt</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="s2">&quot;afficher-calcul-impot&quot;</span><span class="p">:</span> <span class="n">AfficherCalculImpotController</span><span class="p">(),</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="c1"># obtention des données de l&#39;administration fiscale</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="s2">&quot;get-admindata&quot;</span><span class="p">:</span> <span class="n">GetAdminDataController</span><span class="p">(),</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="c1"># main controller</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="s2">&quot;main-controller&quot;</span><span class="p">:</span> <span class="n">MainController</span><span class="p">()</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="p">},</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="c1"># les différents types de réponse (json, xml, html)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="s2">&quot;responses&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="s2">&quot;json&quot;</span><span class="p">:</span> <span class="n">JsonResponse</span><span class="p">(),</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="s2">&quot;html&quot;</span><span class="p">:</span> <span class="n">HtmlResponse</span><span class="p">(),</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="s2">&quot;xml&quot;</span><span class="p">:</span> <span class="n">XmlResponse</span><span class="p">()</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="p">},</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="c1"># les vues HTML et leurs modèles dépendent de l&#39;état rendu par le contrôleur</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="s2">&quot;views&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="p">{</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                <span class="c1"># vue d&#39;authentification</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                <span class="s2">&quot;états&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                    <span class="c1"># /init-session réussite</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                    <span class="mi">700</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                    <span class="c1"># /authentifier-utilisateur échec</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                    <span class="mi">201</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                <span class="p">],</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                <span class="s2">&quot;view_name&quot;</span><span class="p">:</span> <span class="s2">&quot;views/vue-authentification.html&quot;</span><span class="p">,</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                <span class="s2">&quot;model_for_view&quot;</span><span class="p">:</span> <span class="n">ModelForAuthentificationView</span><span class="p">()</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="p">},</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="p">{</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                <span class="c1"># vue du calcul de l&#39;impôt</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                <span class="s2">&quot;états&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                    <span class="c1"># /authentifier-utilisateur réussite</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                    <span class="mi">200</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                    <span class="c1"># /calculer-impot réussite</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                    <span class="mi">300</span><span class="p">,</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                    <span class="c1"># /calculer-impot échec</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                    <span class="mi">301</span><span class="p">,</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                    <span class="c1"># /afficher-calcul-impot</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>                    <span class="mi">800</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                <span class="p">],</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                <span class="s2">&quot;view_name&quot;</span><span class="p">:</span> <span class="s2">&quot;views/vue-calcul-impot.html&quot;</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                <span class="s2">&quot;model_for_view&quot;</span><span class="p">:</span> <span class="n">ModelForCalculImpotView</span><span class="p">()</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="p">},</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="p">{</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                <span class="c1"># vue de la liste des simulations</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                <span class="s2">&quot;états&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                    <span class="c1"># /lister-simulations</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                    <span class="mi">500</span><span class="p">,</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>                    <span class="c1"># /supprimer-simulation</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                    <span class="mi">600</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                <span class="p">],</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                <span class="s2">&quot;view_name&quot;</span><span class="p">:</span> <span class="s2">&quot;views/vue-liste-simulations.html&quot;</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                <span class="s2">&quot;model_for_view&quot;</span><span class="p">:</span> <span class="n">ModelForListeSimulationsView</span><span class="p">()</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>            <span class="p">}</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="p">],</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="c1"># vue des erreurs inattendues</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="s2">&quot;view-erreurs&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="s2">&quot;view_name&quot;</span><span class="p">:</span> <span class="s2">&quot;views/vue-erreurs.html&quot;</span><span class="p">,</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="s2">&quot;model_for_view&quot;</span><span class="p">:</span> <span class="n">ModelForErreursView</span><span class="p">()</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="p">},</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="c1"># redirections</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="s2">&quot;redirections&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>            <span class="p">{</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                <span class="s2">&quot;états&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                    <span class="mi">400</span><span class="p">,</span>  <span class="c1"># /fin-session réussi</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                <span class="p">],</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                <span class="c1"># redirection vers</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;/init-session/html&quot;</span><span class="p">,</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="p">}</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="p">],</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="p">}</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="c1"># étape 3 ------</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="c1"># configuration de la base de données</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config_database</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_database</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="c1"># étape 4 ------</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="c1"># instanciation des couches de l&#39;application</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config_layers</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_layers</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="c1"># on rend la configuration</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>jusqu’à la ligne 41, on retrouve des choses classiques ;</li>
<li>lignes 43-66 : arrivé à la ligne 43, le Python Path du serveur est défini. On peut alors importer les dépendances du projet :</li>
<li>lignes 45-55 : la liste des contrôleurs ;</li>
<li>lignes 57-60 : la liste des réponses HTTP ;</li>
<li>lignes 62-66 : la liste des modèles de vues ;</li>
<li>lignes 68-189 : la configuration de l’application avec une série de constantes ;</li>
<li>lignes 71-98 : nous connaissons déà ces lignes rencontrées dans les versions précédentes ;</li>
<li>lignes 101-122 : le dictionnaire des contrôleurs :</li>
<li>les clés sont les noms des actions ;</li>
<li>les valeurs sont une instance du contrôleur qui doit gérer cette action. Chaque contrôleur n’est instancié qu’en un unique exemplaire (singleton). La même instance sera exécutée par différents threads du serveur. Il faudra donc veiller aux données partagées que chaque contrôleur pourrait vouloir modifier ;</li>
<li>lignes 125-129 : le dictionnaire des trois réponses HTTP possibles :</li>
<li>les clés sont le type de réponse souhaité par le client (jSON, xml, html) ;</li>
<li>les valeurs sont une instance de la réponse HTTP. Chaque générateur de réponse n’est instancié qu’en un unique exemplaire (singleton). Le même générateur sera exécuté par différents threads du serveur. Il faudra donc veiller aux données partagées que chaque générateur pourrait vouloir modifier ;</li>
<li>lignbes 132-186 : configuration des vues HTML. Pour l’instant, on ignore ces lignes ;</li>
<li>lignes 191-202 : nous avons déjà rencontré ces lignes dans les versions précédentes ;</li>
</ul>
<h2 id="306-cheminement-dune-requete-client-au-sein-du-serveur">30.6. Cheminement d’une requête client au sein du serveur</h2>
<p>Nous allons suivre le cheminement d’une requête client arrivant sur le serveur jusqu’à la réponse HTTP envoyée en retour. Elle suit le cheminement du serveur MVC.</p>
<p><img src="images/10000001000003320000010243F9EAD1.png" style="width:13.831cm;height:4.351cm;" alt="Image" /></p>
<h3 id="3061-le-script-main">30.6.1. Le script [main]</h3>
<p>Le script <strong>[main]</strong> est identique en de nombreux points à celui des versions précédentes. Nous le donnons néanmoins en entier pour repartir sur de bonnes bases :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">  1</a></span>
<span class="normal"><a href="#__codelineno-1-2">  2</a></span>
<span class="normal"><a href="#__codelineno-1-3">  3</a></span>
<span class="normal"><a href="#__codelineno-1-4">  4</a></span>
<span class="normal"><a href="#__codelineno-1-5">  5</a></span>
<span class="normal"><a href="#__codelineno-1-6">  6</a></span>
<span class="normal"><a href="#__codelineno-1-7">  7</a></span>
<span class="normal"><a href="#__codelineno-1-8">  8</a></span>
<span class="normal"><a href="#__codelineno-1-9">  9</a></span>
<span class="normal"><a href="#__codelineno-1-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-1-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-1-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-1-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-1-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-1-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-1-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-1-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-1-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-1-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-1-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-1-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-1-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-1-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-1-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-1-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-1-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-1-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-1-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-1-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-1-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-1-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-1-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-1-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-1-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-1-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-1-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-1-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-1-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-1-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-1-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-1-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-1-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-1-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-1-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-1-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-1-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-1-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-1-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-1-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-1-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-1-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-1-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-1-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-1-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-1-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-1-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-1-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-1-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-1-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-1-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-1-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-1-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-1-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-1-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-1-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-1-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-1-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-1-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-1-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-1-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-1-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-1-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-1-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-1-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-1-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-1-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-1-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-1-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-1-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-1-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-1-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-1-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-1-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-1-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-1-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-1-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-1-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-1-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-1-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-1-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-1-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-1-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-1-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-1-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-1-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-1-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-1-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-1-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-1-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-1-100">100</a></span>
<span class="normal"><a href="#__codelineno-1-101">101</a></span>
<span class="normal"><a href="#__codelineno-1-102">102</a></span>
<span class="normal"><a href="#__codelineno-1-103">103</a></span>
<span class="normal"><a href="#__codelineno-1-104">104</a></span>
<span class="normal"><a href="#__codelineno-1-105">105</a></span>
<span class="normal"><a href="#__codelineno-1-106">106</a></span>
<span class="normal"><a href="#__codelineno-1-107">107</a></span>
<span class="normal"><a href="#__codelineno-1-108">108</a></span>
<span class="normal"><a href="#__codelineno-1-109">109</a></span>
<span class="normal"><a href="#__codelineno-1-110">110</a></span>
<span class="normal"><a href="#__codelineno-1-111">111</a></span>
<span class="normal"><a href="#__codelineno-1-112">112</a></span>
<span class="normal"><a href="#__codelineno-1-113">113</a></span>
<span class="normal"><a href="#__codelineno-1-114">114</a></span>
<span class="normal"><a href="#__codelineno-1-115">115</a></span>
<span class="normal"><a href="#__codelineno-1-116">116</a></span>
<span class="normal"><a href="#__codelineno-1-117">117</a></span>
<span class="normal"><a href="#__codelineno-1-118">118</a></span>
<span class="normal"><a href="#__codelineno-1-119">119</a></span>
<span class="normal"><a href="#__codelineno-1-120">120</a></span>
<span class="normal"><a href="#__codelineno-1-121">121</a></span>
<span class="normal"><a href="#__codelineno-1-122">122</a></span>
<span class="normal"><a href="#__codelineno-1-123">123</a></span>
<span class="normal"><a href="#__codelineno-1-124">124</a></span>
<span class="normal"><a href="#__codelineno-1-125">125</a></span>
<span class="normal"><a href="#__codelineno-1-126">126</a></span>
<span class="normal"><a href="#__codelineno-1-127">127</a></span>
<span class="normal"><a href="#__codelineno-1-128">128</a></span>
<span class="normal"><a href="#__codelineno-1-129">129</a></span>
<span class="normal"><a href="#__codelineno-1-130">130</a></span>
<span class="normal"><a href="#__codelineno-1-131">131</a></span>
<span class="normal"><a href="#__codelineno-1-132">132</a></span>
<span class="normal"><a href="#__codelineno-1-133">133</a></span>
<span class="normal"><a href="#__codelineno-1-134">134</a></span>
<span class="normal"><a href="#__codelineno-1-135">135</a></span>
<span class="normal"><a href="#__codelineno-1-136">136</a></span>
<span class="normal"><a href="#__codelineno-1-137">137</a></span>
<span class="normal"><a href="#__codelineno-1-138">138</a></span>
<span class="normal"><a href="#__codelineno-1-139">139</a></span>
<span class="normal"><a href="#__codelineno-1-140">140</a></span>
<span class="normal"><a href="#__codelineno-1-141">141</a></span>
<span class="normal"><a href="#__codelineno-1-142">142</a></span>
<span class="normal"><a href="#__codelineno-1-143">143</a></span>
<span class="normal"><a href="#__codelineno-1-144">144</a></span>
<span class="normal"><a href="#__codelineno-1-145">145</a></span>
<span class="normal"><a href="#__codelineno-1-146">146</a></span>
<span class="normal"><a href="#__codelineno-1-147">147</a></span>
<span class="normal"><a href="#__codelineno-1-148">148</a></span>
<span class="normal"><a href="#__codelineno-1-149">149</a></span>
<span class="normal"><a href="#__codelineno-1-150">150</a></span>
<span class="normal"><a href="#__codelineno-1-151">151</a></span>
<span class="normal"><a href="#__codelineno-1-152">152</a></span>
<span class="normal"><a href="#__codelineno-1-153">153</a></span>
<span class="normal"><a href="#__codelineno-1-154">154</a></span>
<span class="normal"><a href="#__codelineno-1-155">155</a></span>
<span class="normal"><a href="#__codelineno-1-156">156</a></span>
<span class="normal"><a href="#__codelineno-1-157">157</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># on attend un paramètre mysql ou pgres</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="n">syntaxe</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> mysql / pgres&quot;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="n">erreur</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>    <span class="n">sgbd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;mysql&quot;</span> <span class="ow">and</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;pgres&quot;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syntaxe : </span><span class="si">{</span><span class="n">syntaxe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s1">&#39;sgbd&#39;</span><span class="p">:</span> <span class="n">sgbd</span><span class="p">})</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="c1"># dépendances</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">redirect</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="kn">from</span><span class="w"> </span><span class="nn">SendAdminMail</span><span class="w"> </span><span class="kn">import</span> <span class="n">SendAdminMail</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="kn">from</span><span class="w"> </span><span class="nn">myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">json_response</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">Logger</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">randint</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="c1"># envoi d&#39;un mail à l&#39;administrateur</span>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="k">def</span><span class="w"> </span><span class="nf">send_adminmail</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a>    <span class="c1"># on envoie un mail à l&#39;administrateur de l&#39;application</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a>    <span class="n">config_mail</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;adminMail&quot;</span><span class="p">]</span>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a>    <span class="n">config_mail</span><span class="p">[</span><span class="s2">&quot;logger&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;logger&#39;</span><span class="p">]</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a>    <span class="n">SendAdminMail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">config_mail</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="c1"># vérification du fichier de logs</span>
<a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="n">erreur</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="n">message_erreur</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-1-41" name="__codelineno-1-41"></a>    <span class="c1"># logueur</span>
<a id="__codelineno-1-42" name="__codelineno-1-42"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;logsFilename&quot;</span><span class="p">])</span>
<a id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
<a id="__codelineno-1-44" name="__codelineno-1-44"></a>    <span class="c1"># log console</span>
<a id="__codelineno-1-45" name="__codelineno-1-45"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-1-46" name="__codelineno-1-46"></a>    <span class="c1"># on note l&#39;erreur</span>
<a id="__codelineno-1-47" name="__codelineno-1-47"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-1-48" name="__codelineno-1-48"></a>    <span class="n">message_erreur</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-1-49" name="__codelineno-1-49"></a><span class="c1"># on mémorise le logueur dans la config</span>
<a id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logger&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-1-51" name="__codelineno-1-51"></a><span class="c1"># gestion de l&#39;erreur</span>
<a id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-1-53" name="__codelineno-1-53"></a>    <span class="c1"># mail à l&#39;administrateur</span>
<a id="__codelineno-1-54" name="__codelineno-1-54"></a>    <span class="n">send_adminmail</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">message_erreur</span><span class="p">)</span>
<a id="__codelineno-1-55" name="__codelineno-1-55"></a>    <span class="c1"># fin de l&#39;application</span>
<a id="__codelineno-1-56" name="__codelineno-1-56"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-57" name="__codelineno-1-57"></a>
<a id="__codelineno-1-58" name="__codelineno-1-58"></a><span class="c1"># log de démarrage</span>
<a id="__codelineno-1-59" name="__codelineno-1-59"></a><span class="n">log</span> <span class="o">=</span> <span class="s2">&quot;[serveur] démarrage du serveur&quot;</span>
<a id="__codelineno-1-60" name="__codelineno-1-60"></a><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">log</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-1-61" name="__codelineno-1-61"></a><span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
<a id="__codelineno-1-62" name="__codelineno-1-62"></a>
<a id="__codelineno-1-63" name="__codelineno-1-63"></a><span class="c1"># récupération des données de l&#39;administration fiscale</span>
<a id="__codelineno-1-64" name="__codelineno-1-64"></a><span class="n">erreur</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-1-65" name="__codelineno-1-65"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-1-66" name="__codelineno-1-66"></a>    <span class="c1"># admindata sera une donnée de portée application en lecture seule</span>
<a id="__codelineno-1-67" name="__codelineno-1-67"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;admindata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_admindata</span><span class="p">()</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span>
<a id="__codelineno-1-68" name="__codelineno-1-68"></a>    <span class="c1"># log de réussite</span>
<a id="__codelineno-1-69" name="__codelineno-1-69"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[serveur] connexion à la base de données réussie</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-1-70" name="__codelineno-1-70"></a><span class="k">except</span> <span class="n">ImpôtsError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
<a id="__codelineno-1-71" name="__codelineno-1-71"></a>    <span class="c1"># on note l&#39;erreur</span>
<a id="__codelineno-1-72" name="__codelineno-1-72"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-1-73" name="__codelineno-1-73"></a>    <span class="c1"># log d&#39;erreur</span>
<a id="__codelineno-1-74" name="__codelineno-1-74"></a>    <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-1-75" name="__codelineno-1-75"></a>    <span class="c1"># console</span>
<a id="__codelineno-1-76" name="__codelineno-1-76"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
<a id="__codelineno-1-77" name="__codelineno-1-77"></a>    <span class="c1"># fichier de logs</span>
<a id="__codelineno-1-78" name="__codelineno-1-78"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">log</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-1-79" name="__codelineno-1-79"></a>    <span class="c1"># mail à l&#39;administrateur</span>
<a id="__codelineno-1-80" name="__codelineno-1-80"></a>    <span class="n">send_adminmail</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
<a id="__codelineno-1-81" name="__codelineno-1-81"></a>
<a id="__codelineno-1-82" name="__codelineno-1-82"></a><span class="c1"># le thread principal n&#39;a plus besoin du logger</span>
<a id="__codelineno-1-83" name="__codelineno-1-83"></a><span class="n">logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-1-84" name="__codelineno-1-84"></a>
<a id="__codelineno-1-85" name="__codelineno-1-85"></a><span class="c1"># s&#39;il y a eu erreur on s&#39;arrête</span>
<a id="__codelineno-1-86" name="__codelineno-1-86"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-1-87" name="__codelineno-1-87"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-1-88" name="__codelineno-1-88"></a>
<a id="__codelineno-1-89" name="__codelineno-1-89"></a><span class="c1"># application Flask</span>
<a id="__codelineno-1-90" name="__codelineno-1-90"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">template_folder</span><span class="o">=</span><span class="s2">&quot;templates&quot;</span><span class="p">,</span> <span class="n">static_folder</span><span class="o">=</span><span class="s2">&quot;static&quot;</span><span class="p">)</span>
<a id="__codelineno-1-91" name="__codelineno-1-91"></a><span class="c1"># clé secrète de la session</span>
<a id="__codelineno-1-92" name="__codelineno-1-92"></a><span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
<a id="__codelineno-1-93" name="__codelineno-1-93"></a>
<a id="__codelineno-1-94" name="__codelineno-1-94"></a><span class="c1"># le front controller</span>
<a id="__codelineno-1-95" name="__codelineno-1-95"></a><span class="k">def</span><span class="w"> </span><span class="nf">front_controller</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-1-96" name="__codelineno-1-96"></a>    <span class="c1"># on traite la requête</span>
<a id="__codelineno-1-97" name="__codelineno-1-97"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-1-98" name="__codelineno-1-98"></a>    <span class="err">…</span>
<a id="__codelineno-1-99" name="__codelineno-1-99"></a>
<a id="__codelineno-1-100" name="__codelineno-1-100"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-1-101" name="__codelineno-1-101"></a><span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-1-102" name="__codelineno-1-102"></a>    <span class="c1"># redirection vers /init-session/html</span>
<a id="__codelineno-1-103" name="__codelineno-1-103"></a>    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;init_session&quot;</span><span class="p">,</span> <span class="n">type_response</span><span class="o">=</span><span class="s2">&quot;html&quot;</span><span class="p">),</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_302_FOUND</span><span class="p">)</span>
<a id="__codelineno-1-104" name="__codelineno-1-104"></a>
<a id="__codelineno-1-105" name="__codelineno-1-105"></a><span class="c1"># init-session</span>
<a id="__codelineno-1-106" name="__codelineno-1-106"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/init-session/&lt;string:type_response&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-1-107" name="__codelineno-1-107"></a><span class="k">def</span><span class="w"> </span><span class="nf">init_session</span><span class="p">(</span><span class="n">type_response</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-1-108" name="__codelineno-1-108"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-1-109" name="__codelineno-1-109"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-1-110" name="__codelineno-1-110"></a>
<a id="__codelineno-1-111" name="__codelineno-1-111"></a><span class="c1"># authentifier-utilisateur</span>
<a id="__codelineno-1-112" name="__codelineno-1-112"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/authentifier-utilisateur&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<a id="__codelineno-1-113" name="__codelineno-1-113"></a><span class="k">def</span><span class="w"> </span><span class="nf">authentifier_utilisateur</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-1-114" name="__codelineno-1-114"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-1-115" name="__codelineno-1-115"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-1-116" name="__codelineno-1-116"></a>
<a id="__codelineno-1-117" name="__codelineno-1-117"></a><span class="c1"># calculer-impot</span>
<a id="__codelineno-1-118" name="__codelineno-1-118"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/calculer-impot&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<a id="__codelineno-1-119" name="__codelineno-1-119"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculer_impot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-1-120" name="__codelineno-1-120"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-1-121" name="__codelineno-1-121"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-1-122" name="__codelineno-1-122"></a>
<a id="__codelineno-1-123" name="__codelineno-1-123"></a><span class="c1"># lister-simulations</span>
<a id="__codelineno-1-124" name="__codelineno-1-124"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/lister-simulations&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-1-125" name="__codelineno-1-125"></a><span class="k">def</span><span class="w"> </span><span class="nf">lister_simulations</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-1-126" name="__codelineno-1-126"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-1-127" name="__codelineno-1-127"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-1-128" name="__codelineno-1-128"></a>
<a id="__codelineno-1-129" name="__codelineno-1-129"></a><span class="c1"># supprimer-simulation</span>
<a id="__codelineno-1-130" name="__codelineno-1-130"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/supprimer-simulation/&lt;int:numero&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-1-131" name="__codelineno-1-131"></a><span class="k">def</span><span class="w"> </span><span class="nf">supprimer_simulation</span><span class="p">(</span><span class="n">numero</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-1-132" name="__codelineno-1-132"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-1-133" name="__codelineno-1-133"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-1-134" name="__codelineno-1-134"></a>
<a id="__codelineno-1-135" name="__codelineno-1-135"></a><span class="c1"># fin-session</span>
<a id="__codelineno-1-136" name="__codelineno-1-136"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/fin-session&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-1-137" name="__codelineno-1-137"></a><span class="k">def</span><span class="w"> </span><span class="nf">fin_session</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-1-138" name="__codelineno-1-138"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-1-139" name="__codelineno-1-139"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-1-140" name="__codelineno-1-140"></a>
<a id="__codelineno-1-141" name="__codelineno-1-141"></a><span class="c1"># afficher-calcul-impot</span>
<a id="__codelineno-1-142" name="__codelineno-1-142"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/afficher-calcul-impot&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-1-143" name="__codelineno-1-143"></a><span class="k">def</span><span class="w"> </span><span class="nf">afficher_calcul_impot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-1-144" name="__codelineno-1-144"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-1-145" name="__codelineno-1-145"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-1-146" name="__codelineno-1-146"></a>
<a id="__codelineno-1-147" name="__codelineno-1-147"></a><span class="c1"># get-admindata</span>
<a id="__codelineno-1-148" name="__codelineno-1-148"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/get-admindata/&lt;int:numero&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-1-149" name="__codelineno-1-149"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_admindata</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-1-150" name="__codelineno-1-150"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-1-151" name="__codelineno-1-151"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
<a id="__codelineno-1-152" name="__codelineno-1-152"></a>
<a id="__codelineno-1-153" name="__codelineno-1-153"></a><span class="c1"># main uniquement</span>
<a id="__codelineno-1-154" name="__codelineno-1-154"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-1-155" name="__codelineno-1-155"></a>    <span class="c1"># on lance le serveur</span>
<a id="__codelineno-1-156" name="__codelineno-1-156"></a>    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ENV</span><span class="o">=</span><span class="s2">&quot;development&quot;</span><span class="p">,</span> <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-1-157" name="__codelineno-1-157"></a>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">threaded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 1-92 : toutes ces lignes ont été déjà rencontrées et expliquées ;</li>
<li>ligne 92 : le serveur va gérer une session. Il nous faut donc une clé secrète. Nous mettrons pour chaque utilisateur deux informations dans la session :</li>
<li>si l’utilisateur s’est correctement authentifié ;</li>
<li>à chaque fois qu’il fera un calcul d’impôt, les résultats de ce calcul seront placés dans une liste qu’on appellera la liste des simulations de l’utilisateur. Cette liste sera placée en session ;</li>
<li>lignes 100-151 : la liste des URL de service du serveur. Les fonctions associées servent de filtre : toutes les URL non présentes dans cette liste seront rejetées par le serveur Flask avec l’erreur <strong>[404 NOT FOUND]</strong>. Une fois passée ce filtrage, la requête est systématiquement transmise à un ‘Front Controller’ implémenté par la fonction <strong>[front_controller]</strong> des lignes 94-98 que nous allons bientôt présenter ;</li>
<li>lignes 100-103 : gestion de la route <strong>[/]</strong>. Le point d’entrée de l’application web sera l’URL de la ligne 107. Aussi ligne 103, nous redirigeons le client vers cette URL :</li>
<li>la fonction <strong>[url_for]</strong> est importée ligne 18. Elle a ici deux paramètres :</li>
<li>le 1er paramètre est le nom d’une des fonctions de routage, ici celle de la ligne 107. On voit que cette fonction attend un paramètre <strong>[type_response]</strong> qui est le type (json, xml, html) de réponse souhaité par le client ;</li>
<li>le 2ième paramètre reprend le nom du paramètre de la ligne 107, <strong>[type_response]</strong> et lui donne une valeur. S’il y avait d’autres paramètres, on répéterait l’opération pour chacun d’eux ;</li>
<li>elle rend l’URL associée à la fonction désignée par les deux paramètres qui lui ont été donnés. Ici cela donnera l’URL de la ligne 106 où le paramètre est remplacé par sa valeur <strong>[/init-session/html]</strong> ;</li>
<li>la fonction <strong>[redirect]</strong> a été importée ligne 18. Elle a pour rôle d’envoyer un entête HTTP de redirection au client :</li>
<li>le 1er paramètre est l’URL vers laquelle le client doit être redirigé ;</li>
<li>le 2ième paramètre est le code de statut de la réponse HTTP faite au client. Le code <strong>[</strong><strong>status.HTTP_302_FOUND</strong><strong>]</strong> correspond à une redirection HTTP ;
La fonction <strong>[</strong><strong>front_controller</strong><strong>]</strong> des lignes 94-98 fait les premiers traitements de la requête du client :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span>
<span class="normal"><a href="#__codelineno-2-22">22</a></span>
<span class="normal"><a href="#__codelineno-2-23">23</a></span>
<span class="normal"><a href="#__codelineno-2-24">24</a></span>
<span class="normal"><a href="#__codelineno-2-25">25</a></span>
<span class="normal"><a href="#__codelineno-2-26">26</a></span>
<span class="normal"><a href="#__codelineno-2-27">27</a></span>
<span class="normal"><a href="#__codelineno-2-28">28</a></span>
<span class="normal"><a href="#__codelineno-2-29">29</a></span>
<span class="normal"><a href="#__codelineno-2-30">30</a></span>
<span class="normal"><a href="#__codelineno-2-31">31</a></span>
<span class="normal"><a href="#__codelineno-2-32">32</a></span>
<span class="normal"><a href="#__codelineno-2-33">33</a></span>
<span class="normal"><a href="#__codelineno-2-34">34</a></span>
<span class="normal"><a href="#__codelineno-2-35">35</a></span>
<span class="normal"><a href="#__codelineno-2-36">36</a></span>
<span class="normal"><a href="#__codelineno-2-37">37</a></span>
<span class="normal"><a href="#__codelineno-2-38">38</a></span>
<span class="normal"><a href="#__codelineno-2-39">39</a></span>
<span class="normal"><a href="#__codelineno-2-40">40</a></span>
<span class="normal"><a href="#__codelineno-2-41">41</a></span>
<span class="normal"><a href="#__codelineno-2-42">42</a></span>
<span class="normal"><a href="#__codelineno-2-43">43</a></span>
<span class="normal"><a href="#__codelineno-2-44">44</a></span>
<span class="normal"><a href="#__codelineno-2-45">45</a></span>
<span class="normal"><a href="#__codelineno-2-46">46</a></span>
<span class="normal"><a href="#__codelineno-2-47">47</a></span>
<span class="normal"><a href="#__codelineno-2-48">48</a></span>
<span class="normal"><a href="#__codelineno-2-49">49</a></span>
<span class="normal"><a href="#__codelineno-2-50">50</a></span>
<span class="normal"><a href="#__codelineno-2-51">51</a></span>
<span class="normal"><a href="#__codelineno-2-52">52</a></span>
<span class="normal"><a href="#__codelineno-2-53">53</a></span>
<span class="normal"><a href="#__codelineno-2-54">54</a></span>
<span class="normal"><a href="#__codelineno-2-55">55</a></span>
<span class="normal"><a href="#__codelineno-2-56">56</a></span>
<span class="normal"><a href="#__codelineno-2-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1"># le front controller</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">front_controller</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>    <span class="c1"># on traite la requête</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>        <span class="c1"># logger</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;logsFilename&quot;</span><span class="p">])</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>        <span class="c1"># on le mémorise dans une config associée au thread</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>        <span class="n">thread_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;logger&quot;</span><span class="p">:</span> <span class="n">logger</span><span class="p">}</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>        <span class="n">thread_name</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>        <span class="n">config</span><span class="p">[</span><span class="n">thread_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">thread_config</span><span class="p">}</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>        <span class="c1"># on logue la requête</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ front_controller] requête : </span><span class="si">{</span><span class="n">request</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>        <span class="c1"># on interrompt le thread si cela a été demandé</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>        <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;sleep_time&quot;</span><span class="p">]</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>        <span class="k">if</span> <span class="n">sleep_time</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>            <span class="c1"># la pause est aléatoire pour que certains threads soient interrompus et d&#39;autres pas</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a>            <span class="n">aléa</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a>            <span class="k">if</span> <span class="n">aléa</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>                <span class="c1"># log avant pause</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ front_controller] mis en pause du thread pendant </span><span class="si">{</span><span class="n">sleep_time</span><span class="si">}</span><span class="s2"> seconde(s)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a>                <span class="c1"># pause</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a>        <span class="c1"># on fait suivre la requête au contrôleur principal</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a>        <span class="n">main_controller</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">][</span><span class="s2">&quot;main-controller&quot;</span><span class="p">]</span>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a>        <span class="n">résultat</span><span class="p">,</span> <span class="n">status_code</span> <span class="o">=</span> <span class="n">main_controller</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a>        <span class="c1"># on logue le résultat envoyé au client</span>
<a id="__codelineno-2-28" name="__codelineno-2-28"></a>        <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[front_controller] </span><span class="si">{</span><span class="n">résultat</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-2-29" name="__codelineno-2-29"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
<a id="__codelineno-2-30" name="__codelineno-2-30"></a>        <span class="c1"># y-a-t-il eu une erreur fatale ?</span>
<a id="__codelineno-2-31" name="__codelineno-2-31"></a>        <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">:</span>
<a id="__codelineno-2-32" name="__codelineno-2-32"></a>            <span class="c1"># on envoie un mail à l&#39;administrateur de l&#39;application</span>
<a id="__codelineno-2-33" name="__codelineno-2-33"></a>            <span class="n">send_adminmail</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
<a id="__codelineno-2-34" name="__codelineno-2-34"></a>        <span class="c1"># on détermine le type souhaité pour la réponse</span>
<a id="__codelineno-2-35" name="__codelineno-2-35"></a>        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;typeResponse&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-36" name="__codelineno-2-36"></a>            <span class="c1"># le type de session n&#39;a pas encore été établi - ce sera du jSON</span>
<a id="__codelineno-2-37" name="__codelineno-2-37"></a>            <span class="n">type_response</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span>
<a id="__codelineno-2-38" name="__codelineno-2-38"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-39" name="__codelineno-2-39"></a>            <span class="n">type_response</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;typeResponse&#39;</span><span class="p">]</span>
<a id="__codelineno-2-40" name="__codelineno-2-40"></a>        <span class="c1"># on construit la réponse à envoyer</span>
<a id="__codelineno-2-41" name="__codelineno-2-41"></a>        <span class="n">response_builder</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;responses&quot;</span><span class="p">][</span><span class="n">type_response</span><span class="p">]</span>
<a id="__codelineno-2-42" name="__codelineno-2-42"></a>        <span class="n">response</span><span class="p">,</span> <span class="n">status_code</span> <span class="o">=</span> <span class="n">response_builder</span> \
<a id="__codelineno-2-43" name="__codelineno-2-43"></a>            <span class="o">.</span><span class="n">build_http_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">résultat</span><span class="p">)</span>
<a id="__codelineno-2-44" name="__codelineno-2-44"></a>        <span class="c1"># on envoie la réponse</span>
<a id="__codelineno-2-45" name="__codelineno-2-45"></a>        <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">status_code</span>
<a id="__codelineno-2-46" name="__codelineno-2-46"></a>    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-2-47" name="__codelineno-2-47"></a>        <span class="c1"># c&#39;est une erreur inattendue - on logue l&#39;erreur si c&#39;est possible</span>
<a id="__codelineno-2-48" name="__codelineno-2-48"></a>        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-2-49" name="__codelineno-2-49"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ front_controller] </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-50" name="__codelineno-2-50"></a>        <span class="c1"># on prépare la réponse au client</span>
<a id="__codelineno-2-51" name="__codelineno-2-51"></a>        <span class="n">résultat</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;erreurs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]}}</span>
<a id="__codelineno-2-52" name="__codelineno-2-52"></a>        <span class="c1"># on envoie lune réponse en jSON</span>
<a id="__codelineno-2-53" name="__codelineno-2-53"></a>        <span class="k">return</span> <span class="n">json_response</span><span class="p">(</span><span class="n">résultat</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span>
<a id="__codelineno-2-54" name="__codelineno-2-54"></a>    <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-2-55" name="__codelineno-2-55"></a>        <span class="c1"># on ferme le fichier de logs s&#39;il a été ouvert</span>
<a id="__codelineno-2-56" name="__codelineno-2-56"></a>        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-2-57" name="__codelineno-2-57"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 1-57 : nous connaissons ce code. C’était par exemple le code de la fonction appelée <strong>[main]</strong> dans le script <strong>[main]</strong> de la version précédente. Une seule chose est à noter, le contrôleur utilisé aux lignes 25-26 :</li>
<li>
<p>ligne 25 : on récupère dans la configuration l’instance de contrôleur associée au nom <strong>[main-controller]</strong>. Il s’agit des lignes suivantes :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a>    <span class="c1"># dépendances du serveur web</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>    <span class="c1"># les contôleurs</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>    <span class="err">…</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">MainController</span><span class="w"> </span><span class="kn">import</span> <span class="n">MainController</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>    <span class="c1"># actions autorisées et leurs contrôleurs</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>        <span class="s2">&quot;controllers&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>            <span class="err">…</span><span class="p">,</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>            <span class="c1"># main controller</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>            <span class="s2">&quot;main-controller&quot;</span><span class="p">:</span> <span class="n">MainController</span><span class="p">()</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>        <span class="p">},</span>
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>ligne 10 ci-dessus, on remarquera qu’on récupère une instance de classe ;</p>
</li>
<li>ligne 26 : on demande on contrôleur <strong>[MainController]</strong> de traiter la requête ;</li>
<li>lignes 30-45 : la réponse rendue par le contrôleur <strong>[MainController]</strong> est envoyée au client. Nous reviendrons sur ces lignes un peu plus tard ;
Le travail de la fonction <strong>[front_controller]</strong> puis de la classe <strong>[MainController]</strong> est de faire le travail commun à toutes les requêtes :</li>
</ul>
<p>Dans le schéma ci-dessus, on en est toujours à la phase 1 du traitement de la requête. Le contrôleur principal <strong>[MainController]</strong> va poursuivre l’étape 1.</p>
<p><img src="images/10000001000003320000010243F9EAD1.png" style="width:13.831cm;height:4.351cm;" alt="Image" /></p>
<h3 id="3062-le-controleur-principal-maincontroller">30.6.2. Le contrôleur principal [MainController]</h3>
<p>Le contrôleur principal <strong>[MainController]</strong> continue le travail commencé par la fonction <strong>[front_controller]</strong> :</p>
<p>Tous les contrôleurs implémentent l’interface <strong>[</strong><strong>InterfaceController</strong><strong>]</strong> <strong>[2]</strong> suivante :</p>
<p><img src="images/10000000000001DE00000195484FCCBE.png" style="width:5.531cm;height:4.691cm;" alt="Image" /></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span>
<span class="normal"><a href="#__codelineno-4-5">5</a></span>
<span class="normal"><a href="#__codelineno-4-6">6</a></span>
<span class="normal"><a href="#__codelineno-4-7">7</a></span>
<span class="normal"><a href="#__codelineno-4-8">8</a></span>
<span class="normal"><a href="#__codelineno-4-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">InterfaceController</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>l’interface <strong>[</strong><strong>InterfaceController</strong><strong>]</strong> ne définit que l’unique méthode <strong>[execute]</strong> de la ligne 8. Cette méthode reçoit trois paramètres :</li>
<li><strong>[request]</strong> : la requête du client ;</li>
<li><strong>[session]</strong> : la session du client ;</li>
<li>
<p><strong>[config]</strong> : la configuration de l’application ;
La méthode <strong>[execute]</strong> rend un tuple de deux éléments :</p>
</li>
<li>
<p>le 1er est le dictionnaire des résultats sous la forme {‘action’: action, ‘état’:état, ‘réponse’:résultats} ;</p>
</li>
<li>le 2ième est le code de statut HTTP à rendre au client ;
Le contrôleur principal <strong>[MainController]</strong> <strong>[1]</strong> implémente l’interface <strong>[</strong><strong>InterfaceController</strong><strong>]</strong> de la façon suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span>
<span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span>
<span class="normal"><a href="#__codelineno-5-28">28</a></span>
<span class="normal"><a href="#__codelineno-5-29">29</a></span>
<span class="normal"><a href="#__codelineno-5-30">30</a></span>
<span class="normal"><a href="#__codelineno-5-31">31</a></span>
<span class="normal"><a href="#__codelineno-5-32">32</a></span>
<span class="normal"><a href="#__codelineno-5-33">33</a></span>
<span class="normal"><a href="#__codelineno-5-34">34</a></span>
<span class="normal"><a href="#__codelineno-5-35">35</a></span>
<span class="normal"><a href="#__codelineno-5-36">36</a></span>
<span class="normal"><a href="#__codelineno-5-37">37</a></span>
<span class="normal"><a href="#__codelineno-5-38">38</a></span>
<span class="normal"><a href="#__codelineno-5-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1"># import des dépendances</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="c1"># contrôleurs de l&#39;application web</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceController</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceController</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">MainController</span><span class="p">(</span><span class="n">InterfaceController</span><span class="p">):</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a>        <span class="c1"># on récupères les éléments du path</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a>        <span class="n">params</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a>        <span class="n">action</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a>        <span class="c1"># erreurs</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a>        <span class="n">erreur</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a>        <span class="c1"># le type de session doit être connu avant certaines actions</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a>        <span class="n">type_response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;typeResponse&#39;</span><span class="p">)</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a>        <span class="k">if</span> <span class="n">type_response</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">action</span> <span class="o">!=</span> <span class="s2">&quot;init-session&quot;</span><span class="p">:</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a>            <span class="c1"># on note l&#39;erreur</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a>            <span class="n">résultat</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">101</span><span class="p">,</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a>                        <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pas de session en cours. Commencer par action [init-session]&quot;</span><span class="p">]}</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a>            <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a>        <span class="c1"># pour certaines actions on doit être authentifié</span>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a>        <span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span> <span class="ow">and</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;init-session&quot;</span><span class="p">,</span> <span class="s2">&quot;authentifier-utilisateur&quot;</span><span class="p">]:</span>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a>            <span class="c1"># on note l&#39;erreur</span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a>            <span class="n">résultat</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">101</span><span class="p">,</span>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a>                        <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;action [</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">] demandée par utilisateur non authentifié&quot;</span><span class="p">]}</span>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a>            <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-5-31" name="__codelineno-5-31"></a>        <span class="c1"># y-a-t-il des erreurs ?</span>
<a id="__codelineno-5-32" name="__codelineno-5-32"></a>        <span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-5-33" name="__codelineno-5-33"></a>            <span class="c1"># on renvoie un msg d&#39;erreur</span>
<a id="__codelineno-5-34" name="__codelineno-5-34"></a>            <span class="k">return</span> <span class="n">résultat</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
<a id="__codelineno-5-35" name="__codelineno-5-35"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-36" name="__codelineno-5-36"></a>            <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-5-37" name="__codelineno-5-37"></a>            <span class="n">controller</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;controllers&quot;</span><span class="p">][</span><span class="n">action</span><span class="p">]</span>
<a id="__codelineno-5-38" name="__codelineno-5-38"></a>            <span class="n">résultat</span><span class="p">,</span> <span class="n">status_code</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-5-39" name="__codelineno-5-39"></a>            <span class="k">return</span> <span class="n">résultat</span><span class="p">,</span> <span class="n">status_code</span>
</code></pre></div></td></tr></table></div>
<p>Le contrôleur <strong>[MainController]</strong> fait les premières vérifications de la validité de la requête.</p>
<ul>
<li>lignes 11-13 : le contrôleur commence par récupérer l’action demandée par le client. On rappelle que les URL de service sont de la forme <strong>[/action/param1/param2/…]</strong> et que cette URL est dans <strong>[request.path]</strong> ;</li>
<li>lignes 17-23 : l’action <strong>[init-session]</strong> sert à initialiser le type de réponse (json, xml, html) désiré par le client. Cette information est mise en session associée à la clé <strong>[typeRéponse]</strong>. Si donc l’action n’est pas <strong>[init-session]</strong> alors la session doit contenir la clé <strong>[typeRéponse]</strong>, sinon la requête est erronée ;</li>
<li>lignes 21-22 : la structure du résultat rendu par chaque contrôleur, ici un résultat d’erreur :</li>
<li><strong>[action]</strong> : est le nom de l’action en cours. Cela va permettre d’avoir son nom lorsqu’on va loguer le résultat de la requête ;</li>
<li><strong>[état]</strong> : est un code d’état à trois chiffres :</li>
<li><strong>[x00]</strong> pour une réussite ;</li>
<li><strong>[x01]</strong> pour un échec ;</li>
<li><strong>[réponse]</strong> : est la réponse à la requête. Sa nature est propre à chaque requête ;</li>
<li>lignes 24-30 : l’action <strong>[authentifier-utilisateur]</strong> sert à authentifier l’utilisateur. Si elle réussit, une clé <strong>[user=True]</strong> est mise dans la session de l’utilisateur. Certaines URL de service ne sont accessibles que par un utilisateur authentifié. C’est ce qu’on vérifie ici ;</li>
<li>ligne 26 : seules les actions <strong>[init-session]</strong> et <strong>[authentifier-utilisateur]</strong> peuvent être faites par un utilisateur non encore authentifié ;</li>
<li>lignes 28-29 : le résultat à envoyer en cas d’erreur ;</li>
<li>lignes 32-34 : si l’une des deux erreurs précédentes s’est produite, alors on envoie la réponse d’erreur au client avec le statut HTTP 400 BAD REQUEST ;</li>
<li>
<p>lignes 35-39 : s’il n’y a pas eu d’erreur alors on passe la main au contrôleur chargé de traiter l’action en cours. Son instance est trouvée dans la configuration de l’application ;
La classe <strong>[MainController]</strong> continue le travail de la fonction <strong>[front_controller]</strong> : à elles deux, elles rassemblent tout ce qui peut être factorisé dans le traitement des requêtes, attendant le dernier moment pour passer la requête à un contrôleur spécifique. La répartition du code entre la fonction <strong>[front_controller]</strong> et la classe <strong>[MainController]</strong> est tout à fait subjective. Ici j’ai voulu conserver l’acquis de la version précédente : la fonction <strong>[front_controller]</strong> existait déjà sous le nom <strong>[main]</strong>. Dans la pratique, on pourrait :</p>
</li>
<li>
<p>tout mettre dans la fonction <strong>[front_controller]</strong> et éliminer la classe <strong>[MainController]</strong> ;</p>
</li>
<li>tout mettre dans la classe <strong>[MainController]</strong> et éliminer la fonction <strong>[front_controller]</strong>. C’est plutôt cette solution que je choisirais car elle a le mérite d’alléger le code du script principal <strong>[main]</strong> ;</li>
</ul>
<h2 id="307-traitement-specifique-a-une-action">30.7. Traitement spécifique à une action</h2>
<p>Revenons à l’architecture MVC de l’application :</p>
<p><img src="images/10000001000003320000010243F9EAD1.png" style="width:13.831cm;height:4.351cm;" alt="Image" /></p>
<p>Nous en sommes toujours à l’étape 1 ci-dessus. S’il n’y a pas eu d’erreur, l’étape 2 va commencer. La requête a été transmise au contrôleur spécifique à l’action demandée par la requête. Supposons que cette action soit <strong>[/init-session]</strong> définie par la route :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span>
<span class="normal"><a href="#__codelineno-6-4">4</a></span>
<span class="normal"><a href="#__codelineno-6-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c1"># init-session</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/init-session/&lt;string:type_response&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">init_session</span><span class="p">(</span><span class="n">type_response</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>Cette action est reliée à un contrôleur dans la configuration <strong>[config]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span>
<span class="normal"><a href="#__codelineno-7-2">2</a></span>
<span class="normal"><a href="#__codelineno-7-3">3</a></span>
<span class="normal"><a href="#__codelineno-7-4">4</a></span>
<span class="normal"><a href="#__codelineno-7-5">5</a></span>
<span class="normal"><a href="#__codelineno-7-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a>        <span class="c1"># actions autorisées et leurs contrôleurs</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>        <span class="s2">&quot;controllers&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>            <span class="c1"># initialisation d&#39;une session de calcul</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>            <span class="s2">&quot;init-session&quot;</span><span class="p">:</span> <span class="n">InitSessionController</span><span class="p">(),</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>            <span class="err">…</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>        <span class="p">},</span>
</code></pre></div></td></tr></table></div>
<p>Le contrôleur <strong>[InitSessionController]</strong> (ligne 4) prend donc la main. Son code est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceController</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceController</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">InitSessionController</span><span class="p">(</span><span class="n">InterfaceController</span><span class="p">):</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>        <span class="c1"># on récupère les éléments du path</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a>        <span class="n">dummy</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">type_response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>        <span class="c1"># au départ pas d&#39;erreur</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a>        <span class="n">erreur</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>        <span class="c1"># vérification du type de réponse</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a>        <span class="k">if</span> <span class="n">type_response</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;responses&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a>            <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a>            <span class="n">résultat</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">701</span><span class="p">,</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a>                        <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;paramètre [type=</span><span class="si">{</span><span class="n">type_response</span><span class="si">}</span><span class="s2">] invalide&quot;</span><span class="p">]}</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a>        <span class="c1"># si pas d&#39;erreur</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a>            <span class="c1"># on met le type de la session dans la session flask</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a>            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;typeResponse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_response</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a>            <span class="n">résultat</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">700</span><span class="p">,</span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a>                        <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;session démarrée avec le type de réponse </span><span class="si">{</span><span class="n">type_response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]}</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a>            <span class="k">return</span> <span class="n">résultat</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a>            <span class="k">return</span> <span class="n">résultat</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 6 : comme les autres contrôleurs, le contrôleur <strong>[</strong><strong>InitSessionController</strong><strong>]</strong> implémente l’interface <strong>[</strong><strong>InterfaceController</strong><strong>]</strong> ;</li>
<li>ligne 10 : l’URL est de type <strong>[/init-session/type_response]</strong>. On récupère l’action <strong>[init-session]</strong> et le type de réponse souhaité ;</li>
<li>
<p>ligne 15 : le type de réponse souhaité ne peut être que l’un de ceux présents dans la configuration des réponses :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span>
<span class="normal"><a href="#__codelineno-9-4">4</a></span>
<span class="normal"><a href="#__codelineno-9-5">5</a></span>
<span class="normal"><a href="#__codelineno-9-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a>        <span class="c1"># les différents types de réponse (json, xml, html)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>        <span class="s2">&quot;responses&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>            <span class="s2">&quot;json&quot;</span><span class="p">:</span> <span class="n">JsonResponse</span><span class="p">(),</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>            <span class="s2">&quot;html&quot;</span><span class="p">:</span> <span class="n">HtmlResponse</span><span class="p">(),</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>            <span class="s2">&quot;xml&quot;</span><span class="p">:</span> <span class="n">XmlResponse</span><span class="p">()</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>        <span class="p">},</span>
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>si ce n’est pas le cas on prépare une réponse d’erreur 701 (ligne 17) ;</p>
</li>
<li>lignes 20-25 : cas où le type de réponse souhaité est valide ;</li>
<li>ligne 22 : le type de réponse souhaité est mis en session. En effet, il va falloir s’en souvenir pour les requêtes qui vont suivre ;</li>
<li>lignes 23-24 : on prépare une réponse de réussite 700 ;</li>
<li>ligne 25 : la réponse de réussite est rendue au code appelant ;</li>
<li>ligne 27 : s’il y a eu erreur, la réponse d’erreur est rendue au code appelant ;</li>
</ul>
<h2 id="308-elaboration-de-la-reponse-http-du-serveur">30.8. Elaboration de la réponse HTTP du serveur</h2>
<p>Revenons à l’architecture MVC de l’application :</p>
<p><img src="images/10000001000003320000010243F9EAD1.png" style="width:13.831cm;height:4.351cm;" alt="Image" /></p>
<p>Nous venons de voir les étapes 1 et 2. Nous avons rencontré trois codes d’état :</p>
<ul>
<li>700 : /init-session a réussi ;</li>
<li>701 : /init-session a échoué ;</li>
<li>101 : requête invalide soit parce que la session n’a pas été initialisée soit parce que l’utilisateur n’est pas authentifié ;
Examinons comment la réponse du serveur va être envoyée au client lors de l’étape 3 ci-dessus. Cela se passe dans la fonction <strong>[front_controller]</strong> du script <strong>[main]</strong> :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span>
<span class="normal"><a href="#__codelineno-10-24">24</a></span>
<span class="normal"><a href="#__codelineno-10-25">25</a></span>
<span class="normal"><a href="#__codelineno-10-26">26</a></span>
<span class="normal"><a href="#__codelineno-10-27">27</a></span>
<span class="normal"><a href="#__codelineno-10-28">28</a></span>
<span class="normal"><a href="#__codelineno-10-29">29</a></span>
<span class="normal"><a href="#__codelineno-10-30">30</a></span>
<span class="normal"><a href="#__codelineno-10-31">31</a></span>
<span class="normal"><a href="#__codelineno-10-32">32</a></span>
<span class="normal"><a href="#__codelineno-10-33">33</a></span>
<span class="normal"><a href="#__codelineno-10-34">34</a></span>
<span class="normal"><a href="#__codelineno-10-35">35</a></span>
<span class="normal"><a href="#__codelineno-10-36">36</a></span>
<span class="normal"><a href="#__codelineno-10-37">37</a></span>
<span class="normal"><a href="#__codelineno-10-38">38</a></span>
<span class="normal"><a href="#__codelineno-10-39">39</a></span>
<span class="normal"><a href="#__codelineno-10-40">40</a></span>
<span class="normal"><a href="#__codelineno-10-41">41</a></span>
<span class="normal"><a href="#__codelineno-10-42">42</a></span>
<span class="normal"><a href="#__codelineno-10-43">43</a></span>
<span class="normal"><a href="#__codelineno-10-44">44</a></span>
<span class="normal"><a href="#__codelineno-10-45">45</a></span>
<span class="normal"><a href="#__codelineno-10-46">46</a></span>
<span class="normal"><a href="#__codelineno-10-47">47</a></span>
<span class="normal"><a href="#__codelineno-10-48">48</a></span>
<span class="normal"><a href="#__codelineno-10-49">49</a></span>
<span class="normal"><a href="#__codelineno-10-50">50</a></span>
<span class="normal"><a href="#__codelineno-10-51">51</a></span>
<span class="normal"><a href="#__codelineno-10-52">52</a></span>
<span class="normal"><a href="#__codelineno-10-53">53</a></span>
<span class="normal"><a href="#__codelineno-10-54">54</a></span>
<span class="normal"><a href="#__codelineno-10-55">55</a></span>
<span class="normal"><a href="#__codelineno-10-56">56</a></span>
<span class="normal"><a href="#__codelineno-10-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="c1"># le front controller</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">front_controller</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>    <span class="c1"># on traite la requête</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>        <span class="c1"># logger</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;logsFilename&quot;</span><span class="p">])</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a>        <span class="c1"># on le mémorise dans une config associée au thread</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>        <span class="n">thread_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;logger&quot;</span><span class="p">:</span> <span class="n">logger</span><span class="p">}</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a>        <span class="n">thread_name</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>        <span class="n">config</span><span class="p">[</span><span class="n">thread_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">thread_config</span><span class="p">}</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a>        <span class="c1"># on logue la requête</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ front_controller] requête : </span><span class="si">{</span><span class="n">request</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a>        <span class="c1"># on interrompt le thread si cela a été demandé</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a>        <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;sleep_time&quot;</span><span class="p">]</span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a>        <span class="k">if</span> <span class="n">sleep_time</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a>            <span class="c1"># la pause est aléatoire pour que certains threads soient interrompus et d&#39;autres pas</span>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a>            <span class="n">aléa</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a>            <span class="k">if</span> <span class="n">aléa</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a>                <span class="c1"># log avant pause</span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ front_controller] mis en pause du thread pendant </span><span class="si">{</span><span class="n">sleep_time</span><span class="si">}</span><span class="s2"> seconde(s)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a>                <span class="c1"># pause</span>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a>        <span class="c1"># on fait suivre la requête au contrôleur principal</span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a>        <span class="n">main_controller</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">][</span><span class="s2">&quot;main-controller&quot;</span><span class="p">]</span>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a>        <span class="n">résultat</span><span class="p">,</span> <span class="n">status_code</span> <span class="o">=</span> <span class="n">main_controller</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a>        <span class="c1"># on logue le résultat envoyé au client</span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a>        <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[front_controller] </span><span class="si">{</span><span class="n">résultat</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-10-29" name="__codelineno-10-29"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
<a id="__codelineno-10-30" name="__codelineno-10-30"></a>        <span class="c1"># y-a-t-il eu une erreur fatale ?</span>
<a id="__codelineno-10-31" name="__codelineno-10-31"></a>        <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">:</span>
<a id="__codelineno-10-32" name="__codelineno-10-32"></a>            <span class="c1"># on envoie un mail à l&#39;administrateur de l&#39;application</span>
<a id="__codelineno-10-33" name="__codelineno-10-33"></a>            <span class="n">send_adminmail</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
<a id="__codelineno-10-34" name="__codelineno-10-34"></a>        <span class="c1"># on détermine le type souhaité pour la réponse</span>
<a id="__codelineno-10-35" name="__codelineno-10-35"></a>        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;typeResponse&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-10-36" name="__codelineno-10-36"></a>            <span class="c1"># le type de session n&#39;a pas encore été établi - ce sera du jSON</span>
<a id="__codelineno-10-37" name="__codelineno-10-37"></a>            <span class="n">type_response</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span>
<a id="__codelineno-10-38" name="__codelineno-10-38"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-10-39" name="__codelineno-10-39"></a>            <span class="n">type_response</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;typeResponse&#39;</span><span class="p">]</span>
<a id="__codelineno-10-40" name="__codelineno-10-40"></a>        <span class="c1"># on construit la réponse à envoyer</span>
<a id="__codelineno-10-41" name="__codelineno-10-41"></a>        <span class="n">response_builder</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;responses&quot;</span><span class="p">][</span><span class="n">type_response</span><span class="p">]</span>
<a id="__codelineno-10-42" name="__codelineno-10-42"></a>        <span class="n">response</span><span class="p">,</span> <span class="n">status_code</span> <span class="o">=</span> <span class="n">response_builder</span> \
<a id="__codelineno-10-43" name="__codelineno-10-43"></a>            <span class="o">.</span><span class="n">build_http_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">résultat</span><span class="p">)</span>
<a id="__codelineno-10-44" name="__codelineno-10-44"></a>        <span class="c1"># on envoie la réponse</span>
<a id="__codelineno-10-45" name="__codelineno-10-45"></a>        <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">status_code</span>
<a id="__codelineno-10-46" name="__codelineno-10-46"></a>    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-10-47" name="__codelineno-10-47"></a>        <span class="c1"># c&#39;est une erreur inattendue - on logue l&#39;erreur si c&#39;est possible</span>
<a id="__codelineno-10-48" name="__codelineno-10-48"></a>        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-10-49" name="__codelineno-10-49"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ front_controller] </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-10-50" name="__codelineno-10-50"></a>        <span class="c1"># on prépare la réponse au client</span>
<a id="__codelineno-10-51" name="__codelineno-10-51"></a>        <span class="n">résultat</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;erreurs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]}}</span>
<a id="__codelineno-10-52" name="__codelineno-10-52"></a>        <span class="c1"># on envoie lune réponse en jSON</span>
<a id="__codelineno-10-53" name="__codelineno-10-53"></a>        <span class="k">return</span> <span class="n">json_response</span><span class="p">(</span><span class="n">résultat</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span>
<a id="__codelineno-10-54" name="__codelineno-10-54"></a>    <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-10-55" name="__codelineno-10-55"></a>        <span class="c1"># on ferme le fichier de logs s&#39;il a été ouvert</span>
<a id="__codelineno-10-56" name="__codelineno-10-56"></a>        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-10-57" name="__codelineno-10-57"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>nous en sommes à la ligne 26 : le contrôleur principal a rendu sa réponse d’erreur ;</li>
<li>lignes 27-29 : quelque soit la réponse du contrôleur principal (réussite ou échec) cette réponse est loguée dans le fichier de logs ;</li>
<li>lignes 30-33 : comme dans les versions précédentes, si le statut HTTP est <strong>[500 INTERNAL SERVER ERROR]</strong>, on envoie un mail à l’administrateur de l’application avec le log de l’erreur ;</li>
<li>lignes 34-39 : on va envoyer la réponse HTTP et le résultat rendu par le contrôleur va être mis dans le corps de cette réponse. Il nous faut savoir sous quelle forme (json, xml, html) le client veut cette réponse. On cherche le type de réponse souhaitée dans la session. S’il n’y est pas, alors on fixe arbitrairement ce type à du jSON ;</li>
<li>lignes 40-43 : la réponse HTTP est construite ;
Dans le fichier de configuration, chaque type de réponse (json, xml, html) a été associé à une instance de classe :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span>
<span class="normal"><a href="#__codelineno-11-2">2</a></span>
<span class="normal"><a href="#__codelineno-11-3">3</a></span>
<span class="normal"><a href="#__codelineno-11-4">4</a></span>
<span class="normal"><a href="#__codelineno-11-5">5</a></span>
<span class="normal"><a href="#__codelineno-11-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a>        <span class="c1"># les différents types de réponse (json, xml, html)</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>        <span class="s2">&quot;responses&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>            <span class="s2">&quot;json&quot;</span><span class="p">:</span> <span class="n">JsonResponse</span><span class="p">(),</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>            <span class="s2">&quot;html&quot;</span><span class="p">:</span> <span class="n">HtmlResponse</span><span class="p">(),</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>            <span class="s2">&quot;xml&quot;</span><span class="p">:</span> <span class="n">XmlResponse</span><span class="p">()</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>        <span class="p">},</span>
</code></pre></div></td></tr></table></div>
<p>Les classes de réponses sont dans le dossier <strong>[responses]</strong> de l’arborescence du serveur :</p>
<p><img src="images/100000000000017C00000179366F75BA.png" style="width:3.95cm;height:3.92cm;" alt="Image" /></p>
<p>Chaque classe de réponse implémente l’interface <strong>[InterfaceResponse]</strong> suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask.wrappers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Response</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">InterfaceResponse</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">build_http_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a>                            <span class="n">résultat</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a>        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 8-11 : l’interface <strong>[</strong><strong>InterfaceResponse</strong><strong>]</strong> définit une unique méthode <strong>[</strong><strong>build_http_response</strong><strong>]</strong> ayant les paramètres suivants :</li>
<li><strong>[request, session, config]</strong> : ce sont les paramètres reçus par le contrôleur de l’action ;</li>
<li><strong>[résultat, status_code]</strong> : ce sont les résultats produits par le contrôleur de l’action ;
Nous allons présenter la réponse jSON. Elle est produite par la classe <strong>[JsonResponse]</strong> suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span>
<span class="normal"><a href="#__codelineno-13-15">15</a></span>
<span class="normal"><a href="#__codelineno-13-16">16</a></span>
<span class="normal"><a href="#__codelineno-13-17">17</a></span>
<span class="normal"><a href="#__codelineno-13-18">18</a></span>
<span class="normal"><a href="#__codelineno-13-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_response</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask.wrappers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Response</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceResponse</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceResponse</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">JsonResponse</span><span class="p">(</span><span class="n">InterfaceResponse</span><span class="p">):</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">build_http_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a>                            <span class="n">résultat</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a>        <span class="c1"># résultats : le dictionnaire des résultats</span>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a>        <span class="c1"># status_code : le code de statut de la réponse HTTP</span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a>        <span class="c1"># on rend la réponse HTTP</span>
<a id="__codelineno-13-17" name="__codelineno-13-17"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">résultat</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-13-18" name="__codelineno-13-18"></a>        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/json; charset=utf-8&#39;</span>
<a id="__codelineno-13-19" name="__codelineno-13-19"></a>        <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">status_code</span>
</code></pre></div></td></tr></table></div>
<p>Nous connaissons ce code que nous avons rencontré de nombreuses fois. C’est le code de la fonction <strong>[json_response]</strong> du module <strong>[myutils]</strong>.</p>
<h2 id="309-premiers-tests">30.9. Premiers tests</h2>
<p>Dans le code étudié, nous avons rencontré trois codes d’état :</p>
<ul>
<li>700 : /init-session a réussi ;</li>
<li>701 : /init-session a échoué ;</li>
<li>
<p>101 : requête invalide soit parce que la session n’a pas été initialisée soit parce que l’utilisateur n’est pas authentifié ;
Nous allons essayer de les obtenir avec une session jSON.</p>
</li>
<li>
<p>nous lançons le seveur web, le SGBD, le serveur de mails ;</p>
</li>
<li>nous lançons un client Postman ;
<u><strong>Test 1</strong></u></li>
</ul>
<p>Nous montrons tout d’abord une requête invalide parce que la session n’a pas été initialisé :</p>
<p><img src="images/10000000000002BE00000127F5FEAD9A.png" style="width:8.09cm;height:3.41cm;" alt="Image" /></p>
<ul>
<li><strong>[1-2]</strong> : la requête <strong>[POST </strong><a href="http://localhost:5000/authentifier-utilisateur"><u><u><strong>http://localhost:5000/authentifier-utilisateur</strong></u></u></a><strong>]</strong> est une route valide :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span>
<span class="normal"><a href="#__codelineno-14-3">3</a></span>
<span class="normal"><a href="#__codelineno-14-4">4</a></span>
<span class="normal"><a href="#__codelineno-14-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="c1"># authentifier-utilisateur</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/authentifier-utilisateur&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">authentifier_utilisateur</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<p>mais elle n’est acceptée que si la session a été initialisée auparavant avec l’action <strong>[/init-session]</strong>.</p>
<p>Exécutons la requête et voyons le résultat envoyé par le serveur :</p>
<p><img src="images/10000000000003F50000019B063287AC.png" style="width:11.69cm;height:4.74cm;" alt="Image" /></p>
<ul>
<li><strong>[1-2]</strong> : on a obtenu une réponse jSON. Lorsque le type de réponse n’a pas encore été fixé par le client, le serveur utilise le jSON pour répondre ;</li>
<li><strong>[3-5]</strong> : le dictionnaire jSON de la réponse ;</li>
<li><strong>[action]</strong> : l’action qui a été exécutée ;</li>
<li><strong>[état]</strong> : le code d’état de la réponse. Un code <strong>[x01]</strong> indique une erreur ;</li>
<li><strong>[réponse]</strong> : est adaptée à chaque action. Ici elle contient un message d’erreur ;
Maintenant initialisons une session avec un type de réponse incorrect :</li>
</ul>
<p><img src="images/100000000000033E0000019C4EE2189F.png" style="width:9.561cm;height:4.751cm;" alt="Image" /></p>
<ul>
<li><strong>[1-2]</strong> est une route correcte :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span>
<span class="normal"><a href="#__codelineno-15-4">4</a></span>
<span class="normal"><a href="#__codelineno-15-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="c1"># init-session</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/init-session/&lt;string:type_response&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">init_session</span><span class="p">(</span><span class="n">type_response</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<p>Elle va donc entrer dans le tunnel de traitement des requêtes du serveur MVC. Néanmoins elle devrait être refusée au cours de ce traitement parce que le type de session demandé est incorrect.</p>
<p>La réponse est la suivante :</p>
<p><img src="images/10000000000002F70000017D6FABDC42.png" style="width:8.771cm;height:4.4cm;" alt="Image" /></p>
<ul>
<li>en <strong>[4]</strong>, un code d’erreur <strong>[x01]</strong> ;</li>
<li>en <strong>[5]</strong>, l’explication de l’erreur ;
Maintenant, initialisons une session jSON :</li>
</ul>
<p><img src="images/10000000000002BB0000013B913DCD7D.png" style="width:8.081cm;height:3.641cm;" alt="Image" /></p>
<p>La réponse est la suivante :</p>
<p><img src="images/100000000000033C000001912F02645F.png" style="width:9.561cm;height:4.62cm;" alt="Image" /></p>
<p>Maintenant, initialisons une session XML. La réponse jSON va être remplacée par une réponse XML générée par la classe <strong>[XmlResponse]</strong> suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span>
<span class="normal"><a href="#__codelineno-16-20">20</a></span>
<span class="normal"><a href="#__codelineno-16-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">xmltodict</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_response</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask.wrappers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Response</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceResponse</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceResponse</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">Logger</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">XmlResponse</span><span class="p">(</span><span class="n">InterfaceResponse</span><span class="p">):</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">build_http_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a>                            <span class="n">résultat</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a>        <span class="c1"># résultats : le dictionnaire des résultats</span>
<a id="__codelineno-16-14" name="__codelineno-16-14"></a>        <span class="c1"># status_code : le code de statut de la réponse HTTP</span>
<a id="__codelineno-16-15" name="__codelineno-16-15"></a>
<a id="__codelineno-16-16" name="__codelineno-16-16"></a>        <span class="c1"># résultat : le dictionnaire à transformer en chaîne XML</span>
<a id="__codelineno-16-17" name="__codelineno-16-17"></a>        <span class="n">xml_string</span> <span class="o">=</span> <span class="n">xmltodict</span><span class="o">.</span><span class="n">unparse</span><span class="p">({</span><span class="s2">&quot;root&quot;</span><span class="p">:</span> <span class="n">résultat</span><span class="p">})</span>
<a id="__codelineno-16-18" name="__codelineno-16-18"></a>        <span class="c1"># on rend la réponse HTTP</span>
<a id="__codelineno-16-19" name="__codelineno-16-19"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">xml_string</span><span class="p">)</span>
<a id="__codelineno-16-20" name="__codelineno-16-20"></a>        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/xml; charset=utf-8&#39;</span>
<a id="__codelineno-16-21" name="__codelineno-16-21"></a>        <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">status_code</span>
</code></pre></div></td></tr></table></div>
<p>C’est du code que nous connaissons, celui de la fonction <strong>[xml_response]</strong> du module partagé <strong>[myutils]</strong>.</p>
<p>Nous initialisons une session XML :</p>
<p><img src="images/10000000000002BB00000139B7662CFA.png" style="width:8.09cm;height:3.611cm;" alt="Image" /></p>
<p>Le résultat du serveur est alors le suivant :</p>
<p><img src="images/100000000000038E000001753C4E8200.png" style="width:10.501cm;height:4.301cm;" alt="Image" /></p>
<p>Nous obtenons la même réponse qu’en jSON mais cette fois-ci la réponse est habilllée en XML.</p>
<h2 id="3010-laction-authentifier-utilisateur">30.10. L’action [authentifier-utilisateur]</h2>
<p>L’action <strong>[authentifier-utilisateur]</strong> permet d’authentifier un utilisateur désirant utiliser l’application de calcul de l’impôt. Sa route est définie de la façon suivante dans le script <strong>[main]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span>
<span class="normal"><a href="#__codelineno-17-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1"># authentifier-utilisateur</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/authentifier-utilisateur&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">authentifier_utilisateur</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>Le serveur attend deux paramètres postés :</p>
<ul>
<li><strong>[user]</strong> : l’identifiant de l’utilisateur ;</li>
<li><strong>[password]</strong> : son mot de passe ;
La liste des utilisateurs autorisés est définie dans la configuration <strong>[config]</strong> :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span>
<span class="normal"><a href="#__codelineno-18-3">3</a></span>
<span class="normal"><a href="#__codelineno-18-4">4</a></span>
<span class="normal"><a href="#__codelineno-18-5">5</a></span>
<span class="normal"><a href="#__codelineno-18-6">6</a></span>
<span class="normal"><a href="#__codelineno-18-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a>        <span class="c1"># utilisateurs autorisés à utiliser l&#39;application</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a>        <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a>            <span class="p">{</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a>                <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a>                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a>            <span class="p">}</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a>        <span class="p">],</span>
</code></pre></div></td></tr></table></div>
<p>Ici, nous avons une liste à un élément.</p>
<p>L’action <strong>[authentifier-utilisateur]</strong> est traitée par le contrôleur <strong>[</strong><strong>AuthentifierUtilisateurController</strong><strong>]</strong> suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span>
<span class="normal"><a href="#__codelineno-19-27">27</a></span>
<span class="normal"><a href="#__codelineno-19-28">28</a></span>
<span class="normal"><a href="#__codelineno-19-29">29</a></span>
<span class="normal"><a href="#__codelineno-19-30">30</a></span>
<span class="normal"><a href="#__codelineno-19-31">31</a></span>
<span class="normal"><a href="#__codelineno-19-32">32</a></span>
<span class="normal"><a href="#__codelineno-19-33">33</a></span>
<span class="normal"><a href="#__codelineno-19-34">34</a></span>
<span class="normal"><a href="#__codelineno-19-35">35</a></span>
<span class="normal"><a href="#__codelineno-19-36">36</a></span>
<span class="normal"><a href="#__codelineno-19-37">37</a></span>
<span class="normal"><a href="#__codelineno-19-38">38</a></span>
<span class="normal"><a href="#__codelineno-19-39">39</a></span>
<span class="normal"><a href="#__codelineno-19-40">40</a></span>
<span class="normal"><a href="#__codelineno-19-41">41</a></span>
<span class="normal"><a href="#__codelineno-19-42">42</a></span>
<span class="normal"><a href="#__codelineno-19-43">43</a></span>
<span class="normal"><a href="#__codelineno-19-44">44</a></span>
<span class="normal"><a href="#__codelineno-19-45">45</a></span>
<span class="normal"><a href="#__codelineno-19-46">46</a></span>
<span class="normal"><a href="#__codelineno-19-47">47</a></span>
<span class="normal"><a href="#__codelineno-19-48">48</a></span>
<span class="normal"><a href="#__codelineno-19-49">49</a></span>
<span class="normal"><a href="#__codelineno-19-50">50</a></span>
<span class="normal"><a href="#__codelineno-19-51">51</a></span>
<span class="normal"><a href="#__codelineno-19-52">52</a></span>
<span class="normal"><a href="#__codelineno-19-53">53</a></span>
<span class="normal"><a href="#__codelineno-19-54">54</a></span>
<span class="normal"><a href="#__codelineno-19-55">55</a></span>
<span class="normal"><a href="#__codelineno-19-56">56</a></span>
<span class="normal"><a href="#__codelineno-19-57">57</a></span>
<span class="normal"><a href="#__codelineno-19-58">58</a></span>
<span class="normal"><a href="#__codelineno-19-59">59</a></span>
<span class="normal"><a href="#__codelineno-19-60">60</a></span>
<span class="normal"><a href="#__codelineno-19-61">61</a></span>
<span class="normal"><a href="#__codelineno-19-62">62</a></span>
<span class="normal"><a href="#__codelineno-19-63">63</a></span>
<span class="normal"><a href="#__codelineno-19-64">64</a></span>
<span class="normal"><a href="#__codelineno-19-65">65</a></span>
<span class="normal"><a href="#__codelineno-19-66">66</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceController</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceController</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">Logger</span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">AuthentifierUtilisateurController</span><span class="p">(</span><span class="n">InterfaceController</span><span class="p">):</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a>        <span class="c1"># on récupère les éléments du path</span>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a>        <span class="n">dummy</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a>        <span class="c1"># les paramètres du POST</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a>        <span class="n">post_params</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a>        <span class="c1"># code de statut de la réponse HTTP</span>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a>        <span class="n">status_code</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a>        <span class="c1"># au départ pas d&#39;erreurs</span>
<a id="__codelineno-19-18" name="__codelineno-19-18"></a>        <span class="n">erreur</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-19-19" name="__codelineno-19-19"></a>        <span class="n">erreurs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-19-20" name="__codelineno-19-20"></a>        <span class="c1"># il faut un POST avec deux paramètres</span>
<a id="__codelineno-19-21" name="__codelineno-19-21"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">post_params</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-19-22" name="__codelineno-19-22"></a>            <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-19-23" name="__codelineno-19-23"></a>            <span class="n">status_code</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
<a id="__codelineno-19-24" name="__codelineno-19-24"></a>            <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;méthode POST requise, paramètre [action] dans l&#39;URL, paramètres postés [user, password]&quot;</span><span class="p">)</span>
<a id="__codelineno-19-25" name="__codelineno-19-25"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-19-26" name="__codelineno-19-26"></a>            <span class="c1"># on récupère les paramètres du POST</span>
<a id="__codelineno-19-27" name="__codelineno-19-27"></a>            <span class="c1"># paramètre [user]</span>
<a id="__codelineno-19-28" name="__codelineno-19-28"></a>            <span class="n">user</span> <span class="o">=</span> <span class="n">post_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
<a id="__codelineno-19-29" name="__codelineno-19-29"></a>            <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-19-30" name="__codelineno-19-30"></a>                <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-19-31" name="__codelineno-19-31"></a>                <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;paramètre [user] manquant&quot;</span><span class="p">)</span>
<a id="__codelineno-19-32" name="__codelineno-19-32"></a>            <span class="c1"># paramètre [password]</span>
<a id="__codelineno-19-33" name="__codelineno-19-33"></a>            <span class="n">password</span> <span class="o">=</span> <span class="n">post_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
<a id="__codelineno-19-34" name="__codelineno-19-34"></a>            <span class="k">if</span> <span class="n">password</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-19-35" name="__codelineno-19-35"></a>                <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-19-36" name="__codelineno-19-36"></a>                <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;paramètre [password] manquant&quot;</span><span class="p">)</span>
<a id="__codelineno-19-37" name="__codelineno-19-37"></a>            <span class="c1"># erreur ?</span>
<a id="__codelineno-19-38" name="__codelineno-19-38"></a>            <span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-19-39" name="__codelineno-19-39"></a>                <span class="n">status_code</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
<a id="__codelineno-19-40" name="__codelineno-19-40"></a>        <span class="c1"># erreur ?</span>
<a id="__codelineno-19-41" name="__codelineno-19-41"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-19-42" name="__codelineno-19-42"></a>            <span class="c1"># on vérifie la validité du couple (user, password)</span>
<a id="__codelineno-19-43" name="__codelineno-19-43"></a>            <span class="n">users</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
<a id="__codelineno-19-44" name="__codelineno-19-44"></a>            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-19-45" name="__codelineno-19-45"></a>            <span class="n">nbusers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
<a id="__codelineno-19-46" name="__codelineno-19-46"></a>            <span class="n">trouvé</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-19-47" name="__codelineno-19-47"></a>            <span class="k">while</span> <span class="ow">not</span> <span class="n">trouvé</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbusers</span><span class="p">:</span>
<a id="__codelineno-19-48" name="__codelineno-19-48"></a>                <span class="n">trouvé</span> <span class="o">=</span> <span class="n">user</span> <span class="o">==</span> <span class="n">users</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;login&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">password</span> <span class="o">==</span> <span class="n">users</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
<a id="__codelineno-19-49" name="__codelineno-19-49"></a>                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-19-50" name="__codelineno-19-50"></a>            <span class="c1"># trouvé ?</span>
<a id="__codelineno-19-51" name="__codelineno-19-51"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">trouvé</span><span class="p">:</span>
<a id="__codelineno-19-52" name="__codelineno-19-52"></a>                <span class="c1"># on note l&#39;erreur</span>
<a id="__codelineno-19-53" name="__codelineno-19-53"></a>                <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-19-54" name="__codelineno-19-54"></a>                <span class="n">status_code</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span>
<a id="__codelineno-19-55" name="__codelineno-19-55"></a>                <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Echec de l&#39;authentification&quot;</span><span class="p">)</span>
<a id="__codelineno-19-56" name="__codelineno-19-56"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-19-57" name="__codelineno-19-57"></a>                <span class="c1"># on note dans la session qu&#39;on a trouvé l&#39;utilisateur</span>
<a id="__codelineno-19-58" name="__codelineno-19-58"></a>                <span class="n">session</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-19-59" name="__codelineno-19-59"></a>        <span class="c1"># c&#39;est fini</span>
<a id="__codelineno-19-60" name="__codelineno-19-60"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-19-61" name="__codelineno-19-61"></a>            <span class="c1"># retour sans erreur</span>
<a id="__codelineno-19-62" name="__codelineno-19-62"></a>            <span class="n">résultat</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Authentification réussie&quot;</span><span class="p">}</span>
<a id="__codelineno-19-63" name="__codelineno-19-63"></a>            <span class="k">return</span> <span class="n">résultat</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span>
<a id="__codelineno-19-64" name="__codelineno-19-64"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-19-65" name="__codelineno-19-65"></a>            <span class="c1"># retour avec erreur</span>
<a id="__codelineno-19-66" name="__codelineno-19-66"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">201</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="n">erreurs</span><span class="p">},</span> <span class="n">status_code</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 14 : on récupère les paramètres du POST ;</li>
<li>ligne 19 : la liste des erreurs trouvées dans la requête ;</li>
<li>lignes 20-24 : on vérifie qu’il y a bien deux paramètres postés ;</li>
<li>lignes 27-31 : on vérifie la présence d’un paramètre <strong>[users]</strong> ;</li>
<li>lignes 32-36 : on vérifie la présence d’un paramètre <strong>[password]</strong> ;</li>
<li>lignes 38-39 : si les paramètres postés sont erronés, on prépare une réponse HTTP 400 BAD REQUEST ;</li>
<li>lignes 40-58 : on vérifie que les identifiants <strong>[user, password]</strong> sont ceux d’un utilisateur autorisé à utiliser l’application ;</li>
<li>lignes 51-55 : si l’utilisateur (user, password) n’est pas autorisé à utiliser l’application, on prépare une réponse HTTP 401 UNAUTHORIZED ;</li>
<li>lignes 56-58 : s’il est autorisé, alors on note avec la clé <strong>[user]</strong> dans la session qu’il s’est authentifié ;
On notera que si l’utilisateur était authentifié avec les identifiants <strong>[identifiants1]</strong> et qu’il échoue à s’authentifier avec les identifiants <strong>[identifiants2]</strong>, il reste néanmoins authentifié avec les identifiants <strong>[identifiants1]</strong>.</li>
</ul>
<p>Faisons des tests Postman :</p>
<ul>
<li>on lance le serveur web, le SGBD et le serveur de mails ;</li>
<li>avec le client Postman :</li>
<li>on démarre une session jSON ;</li>
<li>puis on s’authentifie ;
Voilà différents cas.</li>
</ul>
<p><u><strong>Cas 1 : POST sans paramètres postés</strong></u></p>
<p><img src="images/100000000000038E0000015C77DFB95F.png" style="width:10.51cm;height:4.021cm;" alt="Image" /></p>
<ul>
<li>en <strong>[3-5]</strong>, le POST n’a pas de corps ;
Le résultat de la requête est le suivant :</li>
</ul>
<p><img src="images/10000000000004BB0000012542DE0AB8.png" style="width:13.99cm;height:3.38cm;" alt="Image" /></p>
<ul>
<li>en <strong>[2]</strong>, on a eu une réponse HTTP 400 BAD REQUEST ;</li>
<li>en <strong>[5]</strong>, on a eu un code d’erreur <strong>[201]</strong> ;
<u><strong>Cas 2 : POST avec identifiants erronés</strong></u></li>
</ul>
<p><img src="images/100000000000038E00000172CBD23596.png" style="width:10.51cm;height:4.261cm;" alt="Image" /></p>
<ul>
<li>en <strong>[6]</strong>, les identifiants sont erronés ;
Le serveur envoie la réponse suivante :</li>
</ul>
<p><img src="images/10000000000004BE00000124AB53F412.png" style="width:14.031cm;height:3.372cm;" alt="Image" /></p>
<ul>
<li>en <strong>[2]</strong>, la réponse HTTP 401 UNAUTHORIZED ;</li>
<li>en <strong>[5]</strong>, la réponse d’erreur ;
<u><strong>Cas 2 : POST avec identifiants corrects</strong></u></li>
</ul>
<p><img src="images/100000000000038D00000172C28B877D.png" style="width:10.51cm;height:4.261cm;" alt="Image" /></p>
<ul>
<li>
<p>en <strong>[6]</strong>, les identifiants sont corrects ;
La réponse du serveur est la suivante :</p>
</li>
<li>
<p>en <strong>[2]</strong>, un réponse HTTP 200 OK ;</p>
</li>
</ul>
<p><img src="images/10000000000004BF0000010257D437DE.png" style="width:14.011cm;height:2.98cm;" alt="Image" /></p>
<ul>
<li>en <strong>[5]</strong>, la réponse de réussite ;</li>
</ul>
<h2 id="3011-laction-calculer_impot">30.11. L’action [calculer_impot]</h2>
<p>L’action <strong>[calculer_impot]</strong> permet de calculer l’impôt d’un contribuable. Sa route est définie de la façon suivante dans le script <strong>[main]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1">1</a></span>
<span class="normal"><a href="#__codelineno-20-2">2</a></span>
<span class="normal"><a href="#__codelineno-20-3">3</a></span>
<span class="normal"><a href="#__codelineno-20-4">4</a></span>
<span class="normal"><a href="#__codelineno-20-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="c1"># calculer-impot</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/calculer-impot&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculer_impot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>Le serveur attend trois paramètres postés :</p>
<ul>
<li><strong>[marié]</strong> : oui / non ;</li>
<li><strong>[enfants]</strong> : nombre d’enfants du contribuable ;</li>
<li><strong>[salaire]</strong> : salaire annuel du contribuable ;
Le contrôleur <strong>[CalculerImpotController]</strong> traite l’action <strong>[calculer_impot]</strong> :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span>
<span class="normal"><a href="#__codelineno-21-12">12</a></span>
<span class="normal"><a href="#__codelineno-21-13">13</a></span>
<span class="normal"><a href="#__codelineno-21-14">14</a></span>
<span class="normal"><a href="#__codelineno-21-15">15</a></span>
<span class="normal"><a href="#__codelineno-21-16">16</a></span>
<span class="normal"><a href="#__codelineno-21-17">17</a></span>
<span class="normal"><a href="#__codelineno-21-18">18</a></span>
<span class="normal"><a href="#__codelineno-21-19">19</a></span>
<span class="normal"><a href="#__codelineno-21-20">20</a></span>
<span class="normal"><a href="#__codelineno-21-21">21</a></span>
<span class="normal"><a href="#__codelineno-21-22">22</a></span>
<span class="normal"><a href="#__codelineno-21-23">23</a></span>
<span class="normal"><a href="#__codelineno-21-24">24</a></span>
<span class="normal"><a href="#__codelineno-21-25">25</a></span>
<span class="normal"><a href="#__codelineno-21-26">26</a></span>
<span class="normal"><a href="#__codelineno-21-27">27</a></span>
<span class="normal"><a href="#__codelineno-21-28">28</a></span>
<span class="normal"><a href="#__codelineno-21-29">29</a></span>
<span class="normal"><a href="#__codelineno-21-30">30</a></span>
<span class="normal"><a href="#__codelineno-21-31">31</a></span>
<span class="normal"><a href="#__codelineno-21-32">32</a></span>
<span class="normal"><a href="#__codelineno-21-33">33</a></span>
<span class="normal"><a href="#__codelineno-21-34">34</a></span>
<span class="normal"><a href="#__codelineno-21-35">35</a></span>
<span class="normal"><a href="#__codelineno-21-36">36</a></span>
<span class="normal"><a href="#__codelineno-21-37">37</a></span>
<span class="normal"><a href="#__codelineno-21-38">38</a></span>
<span class="normal"><a href="#__codelineno-21-39">39</a></span>
<span class="normal"><a href="#__codelineno-21-40">40</a></span>
<span class="normal"><a href="#__codelineno-21-41">41</a></span>
<span class="normal"><a href="#__codelineno-21-42">42</a></span>
<span class="normal"><a href="#__codelineno-21-43">43</a></span>
<span class="normal"><a href="#__codelineno-21-44">44</a></span>
<span class="normal"><a href="#__codelineno-21-45">45</a></span>
<span class="normal"><a href="#__codelineno-21-46">46</a></span>
<span class="normal"><a href="#__codelineno-21-47">47</a></span>
<span class="normal"><a href="#__codelineno-21-48">48</a></span>
<span class="normal"><a href="#__codelineno-21-49">49</a></span>
<span class="normal"><a href="#__codelineno-21-50">50</a></span>
<span class="normal"><a href="#__codelineno-21-51">51</a></span>
<span class="normal"><a href="#__codelineno-21-52">52</a></span>
<span class="normal"><a href="#__codelineno-21-53">53</a></span>
<span class="normal"><a href="#__codelineno-21-54">54</a></span>
<span class="normal"><a href="#__codelineno-21-55">55</a></span>
<span class="normal"><a href="#__codelineno-21-56">56</a></span>
<span class="normal"><a href="#__codelineno-21-57">57</a></span>
<span class="normal"><a href="#__codelineno-21-58">58</a></span>
<span class="normal"><a href="#__codelineno-21-59">59</a></span>
<span class="normal"><a href="#__codelineno-21-60">60</a></span>
<span class="normal"><a href="#__codelineno-21-61">61</a></span>
<span class="normal"><a href="#__codelineno-21-62">62</a></span>
<span class="normal"><a href="#__codelineno-21-63">63</a></span>
<span class="normal"><a href="#__codelineno-21-64">64</a></span>
<span class="normal"><a href="#__codelineno-21-65">65</a></span>
<span class="normal"><a href="#__codelineno-21-66">66</a></span>
<span class="normal"><a href="#__codelineno-21-67">67</a></span>
<span class="normal"><a href="#__codelineno-21-68">68</a></span>
<span class="normal"><a href="#__codelineno-21-69">69</a></span>
<span class="normal"><a href="#__codelineno-21-70">70</a></span>
<span class="normal"><a href="#__codelineno-21-71">71</a></span>
<span class="normal"><a href="#__codelineno-21-72">72</a></span>
<span class="normal"><a href="#__codelineno-21-73">73</a></span>
<span class="normal"><a href="#__codelineno-21-74">74</a></span>
<span class="normal"><a href="#__codelineno-21-75">75</a></span>
<span class="normal"><a href="#__codelineno-21-76">76</a></span>
<span class="normal"><a href="#__codelineno-21-77">77</a></span>
<span class="normal"><a href="#__codelineno-21-78">78</a></span>
<span class="normal"><a href="#__codelineno-21-79">79</a></span>
<span class="normal"><a href="#__codelineno-21-80">80</a></span>
<span class="normal"><a href="#__codelineno-21-81">81</a></span>
<span class="normal"><a href="#__codelineno-21-82">82</a></span>
<span class="normal"><a href="#__codelineno-21-83">83</a></span>
<span class="normal"><a href="#__codelineno-21-84">84</a></span>
<span class="normal"><a href="#__codelineno-21-85">85</a></span>
<span class="normal"><a href="#__codelineno-21-86">86</a></span>
<span class="normal"><a href="#__codelineno-21-87">87</a></span>
<span class="normal"><a href="#__codelineno-21-88">88</a></span>
<span class="normal"><a href="#__codelineno-21-89">89</a></span>
<span class="normal"><a href="#__codelineno-21-90">90</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a>
<a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceController</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceController</span>
<a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">TaxPayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaxPayer</span>
<a id="__codelineno-21-8" name="__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">CalculerImpotController</span><span class="p">(</span><span class="n">InterfaceController</span><span class="p">):</span>
<a id="__codelineno-21-10" name="__codelineno-21-10"></a>
<a id="__codelineno-21-11" name="__codelineno-21-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-21-12" name="__codelineno-21-12"></a>        <span class="c1"># on récupère les éléments du path</span>
<a id="__codelineno-21-13" name="__codelineno-21-13"></a>        <span class="n">dummy</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<a id="__codelineno-21-14" name="__codelineno-21-14"></a>
<a id="__codelineno-21-15" name="__codelineno-21-15"></a>        <span class="c1"># pas d&#39;erreur au départ</span>
<a id="__codelineno-21-16" name="__codelineno-21-16"></a>        <span class="n">erreur</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-21-17" name="__codelineno-21-17"></a>        <span class="n">erreurs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-21-18" name="__codelineno-21-18"></a>        <span class="c1"># les paramètres du POST</span>
<a id="__codelineno-21-19" name="__codelineno-21-19"></a>        <span class="n">post_params</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span>
<a id="__codelineno-21-20" name="__codelineno-21-20"></a>        <span class="c1"># il faut un POST avec trois paramètres</span>
<a id="__codelineno-21-21" name="__codelineno-21-21"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">post_params</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-21-22" name="__codelineno-21-22"></a>            <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-21-23" name="__codelineno-21-23"></a>            <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-21-24" name="__codelineno-21-24"></a>                <span class="s2">&quot;méthode POST requise avec les paramètres postés [marié, enfants, salaire]&quot;</span><span class="p">)</span>
<a id="__codelineno-21-25" name="__codelineno-21-25"></a>        <span class="c1"># on analyse les paramètres postés</span>
<a id="__codelineno-21-26" name="__codelineno-21-26"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-21-27" name="__codelineno-21-27"></a>            <span class="c1"># paramètre marié</span>
<a id="__codelineno-21-28" name="__codelineno-21-28"></a>            <span class="n">marié</span> <span class="o">=</span> <span class="n">post_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;marié&quot;</span><span class="p">)</span>
<a id="__codelineno-21-29" name="__codelineno-21-29"></a>            <span class="k">if</span> <span class="n">marié</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-21-30" name="__codelineno-21-30"></a>                <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;paramètre [marié] manquant&quot;</span><span class="p">)</span>
<a id="__codelineno-21-31" name="__codelineno-21-31"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-21-32" name="__codelineno-21-32"></a>                <span class="c1"># le paramètre est-il valide ?</span>
<a id="__codelineno-21-33" name="__codelineno-21-33"></a>                <span class="n">marié</span> <span class="o">=</span> <span class="n">marié</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-21-34" name="__codelineno-21-34"></a>                <span class="k">if</span> <span class="n">marié</span> <span class="o">!=</span> <span class="s2">&quot;oui&quot;</span> <span class="ow">and</span> <span class="n">marié</span> <span class="o">!=</span> <span class="s2">&quot;non&quot;</span><span class="p">:</span>
<a id="__codelineno-21-35" name="__codelineno-21-35"></a>                    <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-21-36" name="__codelineno-21-36"></a>                    <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;valeur [</span><span class="si">{</span><span class="n">marié</span><span class="si">}</span><span class="s2">] invalide pour le paramètre [marié (oui/non)]&quot;</span><span class="p">)</span>
<a id="__codelineno-21-37" name="__codelineno-21-37"></a>            <span class="c1"># paramètre [enfants]</span>
<a id="__codelineno-21-38" name="__codelineno-21-38"></a>            <span class="n">enfants</span> <span class="o">=</span> <span class="n">post_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enfants&quot;</span><span class="p">)</span>
<a id="__codelineno-21-39" name="__codelineno-21-39"></a>            <span class="k">if</span> <span class="n">enfants</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-21-40" name="__codelineno-21-40"></a>                <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-21-41" name="__codelineno-21-41"></a>                <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;paramètre [enfants] manquant&quot;</span><span class="p">)</span>
<a id="__codelineno-21-42" name="__codelineno-21-42"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-21-43" name="__codelineno-21-43"></a>                <span class="c1"># le paramètre est-il valide ?</span>
<a id="__codelineno-21-44" name="__codelineno-21-44"></a>                <span class="n">enfants</span> <span class="o">=</span> <span class="n">enfants</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-21-45" name="__codelineno-21-45"></a>                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">enfants</span><span class="p">)</span>
<a id="__codelineno-21-46" name="__codelineno-21-46"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-21-47" name="__codelineno-21-47"></a>                    <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-21-48" name="__codelineno-21-48"></a>                    <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;valeur [</span><span class="si">{</span><span class="n">enfants</span><span class="si">}</span><span class="s2">] invalide pour le paramètre [enfants (entier&gt;=0)]&quot;</span><span class="p">)</span>
<a id="__codelineno-21-49" name="__codelineno-21-49"></a>            <span class="c1"># paramètre salaire</span>
<a id="__codelineno-21-50" name="__codelineno-21-50"></a>            <span class="n">salaire</span> <span class="o">=</span> <span class="n">post_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;salaire&quot;</span><span class="p">)</span>
<a id="__codelineno-21-51" name="__codelineno-21-51"></a>            <span class="k">if</span> <span class="n">salaire</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-21-52" name="__codelineno-21-52"></a>                <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-21-53" name="__codelineno-21-53"></a>                <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;paramètre [salaire] manquant&quot;</span><span class="p">)</span>
<a id="__codelineno-21-54" name="__codelineno-21-54"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-21-55" name="__codelineno-21-55"></a>                <span class="c1"># le paramètre est-il valide ?</span>
<a id="__codelineno-21-56" name="__codelineno-21-56"></a>                <span class="n">salaire</span> <span class="o">=</span> <span class="n">salaire</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-21-57" name="__codelineno-21-57"></a>                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">salaire</span><span class="p">)</span>
<a id="__codelineno-21-58" name="__codelineno-21-58"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-21-59" name="__codelineno-21-59"></a>                    <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-21-60" name="__codelineno-21-60"></a>                    <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;valeur [</span><span class="si">{</span><span class="n">salaire</span><span class="si">}</span><span class="s2">] invalide pour le paramètre [salaire (entier&gt;=0)]&quot;</span><span class="p">)</span>
<a id="__codelineno-21-61" name="__codelineno-21-61"></a>        <span class="c1"># erreur ?</span>
<a id="__codelineno-21-62" name="__codelineno-21-62"></a>        <span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-21-63" name="__codelineno-21-63"></a>            <span class="n">status_code</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
<a id="__codelineno-21-64" name="__codelineno-21-64"></a>            <span class="n">résultat</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">301</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="n">erreurs</span><span class="p">}</span>
<a id="__codelineno-21-65" name="__codelineno-21-65"></a>            <span class="c1"># on rend le résultat</span>
<a id="__codelineno-21-66" name="__codelineno-21-66"></a>            <span class="k">return</span> <span class="n">résultat</span><span class="p">,</span> <span class="n">status_code</span>
<a id="__codelineno-21-67" name="__codelineno-21-67"></a>
<a id="__codelineno-21-68" name="__codelineno-21-68"></a>        <span class="c1"># calcul de l&#39;impôt</span>
<a id="__codelineno-21-69" name="__codelineno-21-69"></a>        <span class="c1"># on récupère la couche [métier] et le dictionnaire [adminData]</span>
<a id="__codelineno-21-70" name="__codelineno-21-70"></a>        <span class="n">métier</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;métier&quot;</span><span class="p">]</span>
<a id="__codelineno-21-71" name="__codelineno-21-71"></a>        <span class="n">admin_data</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;admindata&quot;</span><span class="p">]</span>
<a id="__codelineno-21-72" name="__codelineno-21-72"></a>        <span class="c1"># calcul de l&#39;impôt</span>
<a id="__codelineno-21-73" name="__codelineno-21-73"></a>        <span class="n">taxpayer</span> <span class="o">=</span> <span class="n">TaxPayer</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="n">marié</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="n">enfants</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="n">salaire</span><span class="p">})</span>
<a id="__codelineno-21-74" name="__codelineno-21-74"></a>        <span class="n">métier</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">taxpayer</span><span class="p">,</span> <span class="n">admin_data</span><span class="p">)</span>
<a id="__codelineno-21-75" name="__codelineno-21-75"></a>        <span class="c1"># n° de la simulation</span>
<a id="__codelineno-21-76" name="__codelineno-21-76"></a>        <span class="n">id_simulation</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id_simulation&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-21-77" name="__codelineno-21-77"></a>        <span class="n">id_simulation</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-21-78" name="__codelineno-21-78"></a>        <span class="n">session</span><span class="p">[</span><span class="s1">&#39;id_simulation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_simulation</span>
<a id="__codelineno-21-79" name="__codelineno-21-79"></a>        <span class="c1"># on met le résultat en session ous la forme du dictionnaire d&#39;un TaxPayer</span>
<a id="__codelineno-21-80" name="__codelineno-21-80"></a>        <span class="n">simulation</span> <span class="o">=</span> <span class="n">taxpayer</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">id_simulation</span><span class="p">})</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span>
<a id="__codelineno-21-81" name="__codelineno-21-81"></a>        <span class="c1"># on ajoute le résultat à la liste des simulations déjà faites et on met celle-ci en session</span>
<a id="__codelineno-21-82" name="__codelineno-21-82"></a>        <span class="n">simulations</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;simulations&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-21-83" name="__codelineno-21-83"></a>        <span class="n">simulations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span>
<a id="__codelineno-21-84" name="__codelineno-21-84"></a>        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;simulations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simulations</span>
<a id="__codelineno-21-85" name="__codelineno-21-85"></a>        <span class="c1"># résultat</span>
<a id="__codelineno-21-86" name="__codelineno-21-86"></a>        <span class="n">résultat</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="n">simulation</span><span class="p">}</span>
<a id="__codelineno-21-87" name="__codelineno-21-87"></a>        <span class="n">status_code</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span>
<a id="__codelineno-21-88" name="__codelineno-21-88"></a>
<a id="__codelineno-21-89" name="__codelineno-21-89"></a>        <span class="c1"># on rend le résultat</span>
<a id="__codelineno-21-90" name="__codelineno-21-90"></a>        <span class="k">return</span> <span class="n">résultat</span><span class="p">,</span> <span class="n">status_code</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 13 : on récupère le nom de l’action en cours ;</li>
<li>ligne 17: on va cumuler les erreurs dans une liste ;</li>
<li>ligne 19 : on récupère les paramètres postés. Ceux-ci sont postés sous la forme <strong>[x-www-form-urlencoded]</strong> et c’est pourquoi on les récupère dans <strong>[request.form]</strong>. S’ils avaient été postés en jSON on les aurait récupérés dans <strong>[request.data]</strong> ;</li>
<li>lignes 21-24 : on vérifie qu’il y a bien trois paramètres postés ;</li>
<li>lignes 27-36 : vérification de la présence et de la validité du paramètre posté <strong>[marié]</strong> ;</li>
<li>lignes 37-48 : vérification de la présence et de la validité du paramètre posté <strong>[enfants]</strong> ;</li>
<li>lignes 49-60 : vérification de la présence et de la validité du paramètre posté <strong>[salaire]</strong> ;</li>
<li>lignes 62-66 : s’il y a eu erreur, on envoie une réponse d’erreur 400 BAD REQUEST avec un code d’état <strong>[301]</strong> ;</li>
<li>lignes 69-71 : s’il n’y a pas eu erreur, on se prépare à calculer l’impôt. Pour cela,</li>
<li>ligne 70 : on récupère une référence sur la couche <strong>[métier]</strong> ;</li>
<li>ligne 71 : on récupère les données de l’administration fiscale dans la configuration du serveur ;</li>
<li>lignes 72-74 : l’impôt du contribuable est calculé ;</li>
<li>lignes 75-77 : on va compter le nombre de calculs d’impôt faits par l’utilisateur ;</li>
<li>ligne 76 : on récupère en session, le n° du dernier calcul fait. On appelle ici <strong>[simulation]</strong> le résultat d’un calcul ;</li>
<li>ligne 77 : on incrémente le n° de la dernière simulation ;</li>
<li>ligne 78 : on remet ce n° en session ;</li>
<li>lignes 79-84 : pour suivre les calculs faits par l’utilisateur, on va mettre dans sa session, la liste des simulations qu’il a faites ;</li>
<li>ligne 80 : une simulation sera le dictionnaire d’un objet TaxPayer dont la propriété <strong>[id]</strong> aura pour valeur le n° de la simulation ;</li>
<li>lignes 82-84 : la simulation courante est ajoutée à la liste des simulations présente en session ;</li>
<li>lignes 86-87 : on prépare une réponse HTTP de réussite ;</li>
<li>ligne 90 : on rend le résultat ;
Faisons quelques tests : le serveur web, le SGBD, le serveur de mails, un client Postman sont lancés. </li>
</ul>
<p><u><strong>Cas 1 : faire un calcul d’impôt alors que la session n’est pas initialisée</strong></u></p>
<p><img src="images/100000000000038E000001A92D814240.png" style="width:10.501cm;height:4.901cm;" alt="Image" /></p>
<p>La réponse est la suivante :</p>
<p><img src="images/1000000000000329000001327D6E0398.png" style="width:9.33cm;height:3.541cm;" alt="Image" /></p>
<p><u><strong>Cas 2 : faire un calcul d’impôt sans être authentifié</strong></u></p>
<p>On lance tout d’abord une session jSON avec <strong>[/init-session/json]</strong>. Puis on fait la même requête que précédemment. La réponse est alors la suivante :</p>
<p><img src="images/10000000000003290000012E50FAA0EC.png" style="width:9.351cm;height:3.492cm;" alt="Image" /></p>
<p><u><strong>Cas 3 : faire un calcul d’impôt avec des paramètres manquants</strong></u></p>
<p>On initialise une session jSON, on s’authentifie puis on fait la requête suivante :</p>
<p><img src="images/100000000000038D0000019EBD0BAABF.png" style="width:10.501cm;height:4.781cm;" alt="Image" /></p>
<ul>
<li>en <strong>[5]</strong>, il manque le paramètre <strong>[marié]</strong> ;
La réponse est la suivante :</li>
</ul>
<p><u><strong>Cas 4 : faire un calcul d’impôt avec des paramètres erronés</strong></u> </p>
<p><img src="images/100000000000038D000001366AEFA3B8.png" style="width:10.501cm;height:3.581cm;" alt="Image" /></p>
<p><img src="images/10000000000003620000013C3EC6078A.png" style="width:10.011cm;height:3.65cm;" alt="Image" /></p>
<p>La réponse du serveur est la suivante :</p>
<p><img src="images/10000000000003770000018073E147F7.png" style="width:9.201cm;height:3.991cm;" alt="Image" /></p>
<p><u><strong>Cas 4 : faire un calcul d’impôt avec des paramètres corrects</strong></u></p>
<p><img src="images/100000000000031E00000178E67A7270.png" style="width:9.221cm;height:4.34cm;" alt="Image" /></p>
<p>La réponse du serveur est la suivante :</p>
<h2 id="3012-laction-lister-simulations">30.12. L’action [lister-simulations]</h2>
<p>L’action <strong>[lister-simulations]</strong> permet à un utilisateur de connaître la liste des simulations qu’il a faites depuis le début de la session. Sa route est définie de la façon suivante dans le script <strong>[main]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span>
<span class="normal"><a href="#__codelineno-22-2">2</a></span>
<span class="normal"><a href="#__codelineno-22-3">3</a></span>
<span class="normal"><a href="#__codelineno-22-4">4</a></span>
<span class="normal"><a href="#__codelineno-22-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="c1"># lister-simulations</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/lister-simulations&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">lister_simulations</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>Le serveur n’attend aucun paramètre. L’action <strong>[lister-simulations]</strong> est traitée par le contrôleur <strong>[</strong><strong>ListerSimulationsController</strong><strong>]</strong> suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span>
<span class="normal"><a href="#__codelineno-23-15">15</a></span>
<span class="normal"><a href="#__codelineno-23-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceController</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceController</span>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">ListerSimulationsController</span><span class="p">(</span><span class="n">InterfaceController</span><span class="p">):</span>
<a id="__codelineno-23-7" name="__codelineno-23-7"></a>
<a id="__codelineno-23-8" name="__codelineno-23-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-23-9" name="__codelineno-23-9"></a>        <span class="c1"># on récupère les éléments du path</span>
<a id="__codelineno-23-10" name="__codelineno-23-10"></a>        <span class="n">dummy</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<a id="__codelineno-23-11" name="__codelineno-23-11"></a>
<a id="__codelineno-23-12" name="__codelineno-23-12"></a>        <span class="c1"># on récupère la liste des simulations dans la session</span>
<a id="__codelineno-23-13" name="__codelineno-23-13"></a>        <span class="n">simulations</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;simulations&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-23-14" name="__codelineno-23-14"></a>        <span class="c1"># on rend le résultat</span>
<a id="__codelineno-23-15" name="__codelineno-23-15"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
<a id="__codelineno-23-16" name="__codelineno-23-16"></a>                <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="n">simulations</span><span class="p">},</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 13 : la liste des simulations est prise dans la session ;</li>
<li>
<p>lignes 15-16 : on retourne une réponse de réussite ;
Faisons le test Postman suivant :</p>
</li>
<li>
<p>on lance une session jSON ;</p>
</li>
<li>on s’authentifie ;</li>
<li>on fait deux calculs d’impôt ;</li>
<li>
<p>on demande la liste des simulations ;
La requête est la suivante :</p>
</li>
<li>
<p>en <strong>[3]</strong>, il n’y a aucun paramètre ;</p>
</li>
</ul>
<p><img src="images/1000000000000239000001260619ED31.png" style="width:6.571cm;height:3.391cm;" alt="Image" /></p>
<p>La réponse du serveur est la suivante :</p>
<p><img src="images/10000000000002CB000003893204E1AE.png" style="width:8.261cm;height:10.461cm;" alt="Image" /></p>
<ul>
<li>en <strong>[4]</strong>, la liste des simulations de l’utilisateur ;</li>
</ul>
<h2 id="3013-laction-supprimer-simulation">30.13. L’action [supprimer-simulation]</h2>
<p>L’action <strong>[supprimer-simulation]</strong> permet à un utilisateur de supprimer une des simulations de sa liste de simulations. Sa route est définie de la façon suivante dans le script <strong>[main]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span>
<span class="normal"><a href="#__codelineno-24-2">2</a></span>
<span class="normal"><a href="#__codelineno-24-3">3</a></span>
<span class="normal"><a href="#__codelineno-24-4">4</a></span>
<span class="normal"><a href="#__codelineno-24-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="c1"># supprimer-simulation</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/supprimer-simulation/&lt;int:numero&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">supprimer_simulation</span><span class="p">(</span><span class="n">numero</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>Le serveur attend un unique paramètre, le n° de la simulation à supprimer. L’action <strong>[supprimer-simulation]</strong> est traitée par le contrôleur <strong>[</strong><strong>SupprimerSimulationController</strong><strong>]</strong> suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span>
<span class="normal"><a href="#__codelineno-25-11">11</a></span>
<span class="normal"><a href="#__codelineno-25-12">12</a></span>
<span class="normal"><a href="#__codelineno-25-13">13</a></span>
<span class="normal"><a href="#__codelineno-25-14">14</a></span>
<span class="normal"><a href="#__codelineno-25-15">15</a></span>
<span class="normal"><a href="#__codelineno-25-16">16</a></span>
<span class="normal"><a href="#__codelineno-25-17">17</a></span>
<span class="normal"><a href="#__codelineno-25-18">18</a></span>
<span class="normal"><a href="#__codelineno-25-19">19</a></span>
<span class="normal"><a href="#__codelineno-25-20">20</a></span>
<span class="normal"><a href="#__codelineno-25-21">21</a></span>
<span class="normal"><a href="#__codelineno-25-22">22</a></span>
<span class="normal"><a href="#__codelineno-25-23">23</a></span>
<span class="normal"><a href="#__codelineno-25-24">24</a></span>
<span class="normal"><a href="#__codelineno-25-25">25</a></span>
<span class="normal"><a href="#__codelineno-25-26">26</a></span>
<span class="normal"><a href="#__codelineno-25-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceController</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceController</span>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a>
<a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">SupprimerSimulationController</span><span class="p">(</span><span class="n">InterfaceController</span><span class="p">):</span>
<a id="__codelineno-25-7" name="__codelineno-25-7"></a>
<a id="__codelineno-25-8" name="__codelineno-25-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-25-9" name="__codelineno-25-9"></a>        <span class="c1"># on récupère les éléments du path</span>
<a id="__codelineno-25-10" name="__codelineno-25-10"></a>        <span class="n">dummy</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">numéro</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<a id="__codelineno-25-11" name="__codelineno-25-11"></a>
<a id="__codelineno-25-12" name="__codelineno-25-12"></a>        <span class="c1"># le paramètre [numéro] est un entier positif ou nul d&#39;après sa route</span>
<a id="__codelineno-25-13" name="__codelineno-25-13"></a>        <span class="n">numéro</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numéro</span><span class="p">)</span>
<a id="__codelineno-25-14" name="__codelineno-25-14"></a>        <span class="c1"># la simulation id=numéro doit exister dans la liste des simulations</span>
<a id="__codelineno-25-15" name="__codelineno-25-15"></a>        <span class="n">simulations</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;simulations&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-25-16" name="__codelineno-25-16"></a>        <span class="n">liste_simulations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">simulation</span><span class="p">:</span> <span class="n">simulation</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">numéro</span><span class="p">,</span> <span class="n">simulations</span><span class="p">))</span>
<a id="__codelineno-25-17" name="__codelineno-25-17"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">liste_simulations</span><span class="p">:</span>
<a id="__codelineno-25-18" name="__codelineno-25-18"></a>            <span class="n">msg_erreur</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;la simulation n° [</span><span class="si">{</span><span class="n">numéro</span><span class="si">}</span><span class="s2">] n&#39;existe pas&quot;</span>
<a id="__codelineno-25-19" name="__codelineno-25-19"></a>            <span class="c1"># on rend l&#39;erreur</span>
<a id="__codelineno-25-20" name="__codelineno-25-20"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">601</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">msg_erreur</span><span class="p">]},</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
<a id="__codelineno-25-21" name="__codelineno-25-21"></a>        <span class="c1"># suppression de la simulation id=numéro</span>
<a id="__codelineno-25-22" name="__codelineno-25-22"></a>        <span class="n">simulation</span> <span class="o">=</span> <span class="n">liste_simulations</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-25-23" name="__codelineno-25-23"></a>        <span class="n">simulations</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span>
<a id="__codelineno-25-24" name="__codelineno-25-24"></a>        <span class="c1"># on remet les simulations dans la session</span>
<a id="__codelineno-25-25" name="__codelineno-25-25"></a>        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;simulations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simulations</span>
<a id="__codelineno-25-26" name="__codelineno-25-26"></a>        <span class="c1"># on rend le résultat</span>
<a id="__codelineno-25-27" name="__codelineno-25-27"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="n">simulations</span><span class="p">},</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 10 : on récupère les deux éléments du chemin de la requête. On les récupère en temps que chaîne de caractères ;</li>
<li>ligne 13 : le paramètre <strong>[numéro]</strong> est transformé en entier. On sait que c’est possible à cause de la signature de sa route, 
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/supprimer-simulation/&lt;int:numero&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<p>On sait de plus que c’est un entier &gt;=0. On ne peut pas en effet avoir une URL <strong>[/supprimer-simulation/-4]</strong>. Celle-ci est refusée par le serveur Flask ;</p>
<ul>
<li>ligne 15 : on récupère la liste des simulations dans la session ;</li>
<li>ligne 16 : avec la fonction <strong>[filter]</strong>, on cherche la simulation ayant id==numéro. On obtient un objet <strong>[filter]</strong> qu’on convertit en type <strong>[list]</strong> ;</li>
<li>lignes 17-20 : si le filtre n’a rien ramené, alors c’est que la simulation à supprimer n’existe pas. On rend une réponse d’erreur qui l’indique ;</li>
<li>lignes 21-23 : on supprime la simulation ramenée par le filtre ;</li>
<li>ligne 25 : on remet la nouvelle liste de simulations en session ;</li>
<li>ligne 27 : on rend dans la réponse, la nouvelle liste de simulations ;
Nous faisons un test de réussite et un test d’échec. On fait des simulations puis on demande la liste des simulations :</li>
</ul>
<p><img src="images/1000000000000275000003300966AC33.png" style="width:7.261cm;height:9.42cm;" alt="Image" /></p>
<ul>
<li>les simulations ont ici les n°s 2 et 3 ;
On demande à supprimer la simulation ayant le n° 3.</li>
</ul>
<p><img src="images/10000000000002D50000010FED9F04E5.png" style="width:8.362cm;height:3.13cm;" alt="Image" /></p>
<p>La réponse est la suivante :</p>
<p>Maintenant, recommençons la même opération (suppression de la simulation d’id=3). La réponse est alors la suivante :</p>
<p><img src="images/10000000000002980000024D554EFBE6.png" style="width:7.67cm;height:6.801cm;" alt="Image" /></p>
<h2 id="3014-laction-fin-session">30.14. L’action [fin-session]</h2>
<p>L’action <strong>[fin-session]</strong> permet à un utilisateur de terminer sa session de simulations. Sa route est définie de la façon suivante dans le script <strong>[main]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1">1</a></span>
<span class="normal"><a href="#__codelineno-27-2">2</a></span>
<span class="normal"><a href="#__codelineno-27-3">3</a></span>
<span class="normal"><a href="#__codelineno-27-4">4</a></span>
<span class="normal"><a href="#__codelineno-27-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="c1"># fin-session</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/fin-session&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">fin_session</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>Le serveur n’attend aucun paramètre. L’action est traitée par le contrôleur <strong>[</strong><strong>FinSessionController</strong><strong>]</strong> suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span>
<span class="normal"><a href="#__codelineno-28-11">11</a></span>
<span class="normal"><a href="#__codelineno-28-12">12</a></span>
<span class="normal"><a href="#__codelineno-28-13">13</a></span>
<span class="normal"><a href="#__codelineno-28-14">14</a></span>
<span class="normal"><a href="#__codelineno-28-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-28-3" name="__codelineno-28-3"></a>
<a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceController</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceController</span>
<a id="__codelineno-28-5" name="__codelineno-28-5"></a>
<a id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">FinSessionController</span><span class="p">(</span><span class="n">InterfaceController</span><span class="p">):</span>
<a id="__codelineno-28-7" name="__codelineno-28-7"></a>
<a id="__codelineno-28-8" name="__codelineno-28-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-28-9" name="__codelineno-28-9"></a>        <span class="c1"># on récupère les éléments du path</span>
<a id="__codelineno-28-10" name="__codelineno-28-10"></a>        <span class="n">dummy</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<a id="__codelineno-28-11" name="__codelineno-28-11"></a>
<a id="__codelineno-28-12" name="__codelineno-28-12"></a>        <span class="c1"># on supprime toutes les clés la session courante</span>
<a id="__codelineno-28-13" name="__codelineno-28-13"></a>        <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-28-14" name="__codelineno-28-14"></a>        <span class="c1"># on rend le résultat</span>
<a id="__codelineno-28-15" name="__codelineno-28-15"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="s2">&quot;session réinitialisée&quot;</span><span class="p">},</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 13 : on supprime toutes les clés de la session. Cela supprime :</li>
<li><strong>[typeResponse]</strong> : le type des réponses HTTP (json, xml, html) ;</li>
<li><strong>[id_simulation]</strong> : n° de la dernière simulation faite ;</li>
<li><strong>[simulations]</strong> : la liste des simulations de l’utilisateur ;</li>
<li><strong>[user]</strong> : l’indicateur que l’utilisateur a été authentifié ;</li>
<li>on rend la réponse ;
On peut se demander comment va être rendue la réponse HTTP de la ligne 15, maintenant que le type de réponse n’est plus dans la session. Pour le savoir, il faut revenir à la fonction |front_controller| du script principal <strong>[main]</strong> et la modifier de la façon suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-29-10">10</a></span>
<span class="normal"><a href="#__codelineno-29-11">11</a></span>
<span class="normal"><a href="#__codelineno-29-12">12</a></span>
<span class="normal"><a href="#__codelineno-29-13">13</a></span>
<span class="normal"><a href="#__codelineno-29-14">14</a></span>
<span class="normal"><a href="#__codelineno-29-15">15</a></span>
<span class="normal"><a href="#__codelineno-29-16">16</a></span>
<span class="normal"><a href="#__codelineno-29-17">17</a></span>
<span class="normal"><a href="#__codelineno-29-18">18</a></span>
<span class="normal"><a href="#__codelineno-29-19">19</a></span>
<span class="normal"><a href="#__codelineno-29-20">20</a></span>
<span class="normal"><a href="#__codelineno-29-21">21</a></span>
<span class="normal"><a href="#__codelineno-29-22">22</a></span>
<span class="normal"><a href="#__codelineno-29-23">23</a></span>
<span class="normal"><a href="#__codelineno-29-24">24</a></span>
<span class="normal"><a href="#__codelineno-29-25">25</a></span>
<span class="normal"><a href="#__codelineno-29-26">26</a></span>
<span class="normal"><a href="#__codelineno-29-27">27</a></span>
<span class="normal"><a href="#__codelineno-29-28">28</a></span>
<span class="normal"><a href="#__codelineno-29-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="err">…</span>        
<a id="__codelineno-29-2" name="__codelineno-29-2"></a>         <span class="c1"># on note le type de réponse souhaité si cette information est dans la session</span>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a>        <span class="n">type_response1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;typeResponse&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-29-4" name="__codelineno-29-4"></a>        <span class="c1"># on fait suivre la requête au contrôleur principal</span>
<a id="__codelineno-29-5" name="__codelineno-29-5"></a>        <span class="n">main_controller</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;controllers&#39;</span><span class="p">][</span><span class="s2">&quot;main-controller&quot;</span><span class="p">]</span>
<a id="__codelineno-29-6" name="__codelineno-29-6"></a>        <span class="n">résultat</span><span class="p">,</span> <span class="n">status_code</span> <span class="o">=</span> <span class="n">main_controller</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-29-7" name="__codelineno-29-7"></a>        <span class="c1"># on logue le résultat envoyé au client</span>
<a id="__codelineno-29-8" name="__codelineno-29-8"></a>        <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[front_controller] </span><span class="si">{</span><span class="n">résultat</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-29-9" name="__codelineno-29-9"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
<a id="__codelineno-29-10" name="__codelineno-29-10"></a>        <span class="c1"># y-a-t-il eu une erreur fatale ?</span>
<a id="__codelineno-29-11" name="__codelineno-29-11"></a>        <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">:</span>
<a id="__codelineno-29-12" name="__codelineno-29-12"></a>            <span class="c1"># on envoie un mail à l&#39;administrateur de l&#39;application</span>
<a id="__codelineno-29-13" name="__codelineno-29-13"></a>            <span class="n">send_adminmail</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
<a id="__codelineno-29-14" name="__codelineno-29-14"></a>        <span class="c1"># on détermine le type souhaité pour la réponse</span>
<a id="__codelineno-29-15" name="__codelineno-29-15"></a>        <span class="n">type_response2</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;typeResponse&#39;</span><span class="p">)</span>
<a id="__codelineno-29-16" name="__codelineno-29-16"></a>        <span class="k">if</span>  <span class="n">type_response2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">type_response1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-29-17" name="__codelineno-29-17"></a>            <span class="c1"># le type de session n&#39;a pas encore été établi - ce sera du jSON</span>
<a id="__codelineno-29-18" name="__codelineno-29-18"></a>            <span class="n">type_response</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span>
<a id="__codelineno-29-19" name="__codelineno-29-19"></a>        <span class="k">elif</span> <span class="n">type_response2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-29-20" name="__codelineno-29-20"></a>            <span class="c1"># le type de la réponse est connu et dans la session</span>
<a id="__codelineno-29-21" name="__codelineno-29-21"></a>            <span class="n">type_response</span> <span class="o">=</span> <span class="n">type_response2</span>
<a id="__codelineno-29-22" name="__codelineno-29-22"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-29-23" name="__codelineno-29-23"></a>            <span class="n">type_response</span><span class="o">=</span><span class="n">type_response1</span>
<a id="__codelineno-29-24" name="__codelineno-29-24"></a>        <span class="c1"># on construit la réponse à envoyer</span>
<a id="__codelineno-29-25" name="__codelineno-29-25"></a>        <span class="n">response_builder</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;responses&quot;</span><span class="p">][</span><span class="n">type_response</span><span class="p">]</span>
<a id="__codelineno-29-26" name="__codelineno-29-26"></a>        <span class="n">response</span><span class="p">,</span> <span class="n">status_code</span> <span class="o">=</span> <span class="n">response_builder</span> \
<a id="__codelineno-29-27" name="__codelineno-29-27"></a>            <span class="o">.</span><span class="n">build_http_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">résultat</span><span class="p">)</span>
<a id="__codelineno-29-28" name="__codelineno-29-28"></a>        <span class="c1"># on envoie la réponse</span>
<a id="__codelineno-29-29" name="__codelineno-29-29"></a>        <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">status_code</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 3 : le type de la réponse actuellement en session est mémorisé ;</li>
<li>ligne 6 : l’action est exécutée. S’il s’agit de :</li>
<li><strong>[fin-session]</strong>, la clé <strong>[typeResponse]</strong> n’est alors plus dans la session ;</li>
<li><strong>[init-session]</strong>, la clé <strong>[typeResponse]</strong> de la session a pu changer de valeur ;;</li>
<li>lignes 14-20 : on doit émettre la réponse HTTP. Il nous faut savoir sous quelle forme :</li>
<li>lignes 16-18 : si le type de la réponse n’est définie ni par <strong>[type_response1]</strong> de la ligne 3, ni par <strong>[type_response2]</strong> de la ligne 15, alors le type de réponse n’était défini ni avant ni après l’action. On utilise alors du jSON (ligne 18) ;</li>
<li>lignes 19-21 : si <strong>[type_response2]</strong> existe, le type dans la session après l’action, alors c’est ce type qu’il faut utiliser ;</li>
<li>lignes 22-23 : sinon c’est <strong>[type_response1]</strong>, le type de réponse avant l’action (celle-ci est forcément <strong>[fin-session]</strong>) qu’il faut utiliser ;</li>
</ul>
<h2 id="3015-laction-get-admindata">30.15. L’action [get-admindata]</h2>
<p>Nous abordons maintenant les deux URL réservées aux services jSON et XML :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Action</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Rôle</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>Contexte d’exécution</b></p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">/get-admindata</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Rend les données fiscales permettant le calcul de l’impôt</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Requête GET.</p><p style="margin:0;">N’est utilisée que si le type de la session est json ou xml. L’utilisateur doit être authentifié</p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">/calculer-impots</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Fait le calcul de l’impôt d’une liste de contribuables postés en jSON</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">Requête GET.</p><p style="margin:0;">N’est utilisée que si le type de la session est json ou xml. L’utilisateur doit être authentifié</p></td></tr></table>

<p>L’URL <strong>[/get-admindata]</strong> est définie dans les routes du script principal <strong>[main]</strong> de la façon suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1">1</a></span>
<span class="normal"><a href="#__codelineno-30-2">2</a></span>
<span class="normal"><a href="#__codelineno-30-3">3</a></span>
<span class="normal"><a href="#__codelineno-30-4">4</a></span>
<span class="normal"><a href="#__codelineno-30-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="c1"># get-admindata</span>
<a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/get-admindata&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_admindata</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-30-4" name="__codelineno-30-4"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-30-5" name="__codelineno-30-5"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>La route <strong>[/get-admindata]</strong> est traitée par le contrôleur <strong>[</strong><strong>GetAdminDataController</strong><strong>]</strong> suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span>
<span class="normal"><a href="#__codelineno-31-11">11</a></span>
<span class="normal"><a href="#__codelineno-31-12">12</a></span>
<span class="normal"><a href="#__codelineno-31-13">13</a></span>
<span class="normal"><a href="#__codelineno-31-14">14</a></span>
<span class="normal"><a href="#__codelineno-31-15">15</a></span>
<span class="normal"><a href="#__codelineno-31-16">16</a></span>
<span class="normal"><a href="#__codelineno-31-17">17</a></span>
<span class="normal"><a href="#__codelineno-31-18">18</a></span>
<span class="normal"><a href="#__codelineno-31-19">19</a></span>
<span class="normal"><a href="#__codelineno-31-20">20</a></span>
<span class="normal"><a href="#__codelineno-31-21">21</a></span>
<span class="normal"><a href="#__codelineno-31-22">22</a></span>
<span class="normal"><a href="#__codelineno-31-23">23</a></span>
<span class="normal"><a href="#__codelineno-31-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="c1"># import des dépendances</span>
<a id="__codelineno-31-2" name="__codelineno-31-2"></a>
<a id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-31-5" name="__codelineno-31-5"></a>
<a id="__codelineno-31-6" name="__codelineno-31-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceController</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceController</span>
<a id="__codelineno-31-7" name="__codelineno-31-7"></a>
<a id="__codelineno-31-8" name="__codelineno-31-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">GetAdminDataController</span><span class="p">(</span><span class="n">InterfaceController</span><span class="p">):</span>
<a id="__codelineno-31-9" name="__codelineno-31-9"></a>
<a id="__codelineno-31-10" name="__codelineno-31-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-31-11" name="__codelineno-31-11"></a>        <span class="c1"># on récupère les éléments du path</span>
<a id="__codelineno-31-12" name="__codelineno-31-12"></a>        <span class="n">dummy</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<a id="__codelineno-31-13" name="__codelineno-31-13"></a>        <span class="c1"># seules les sessions json et xml sont acceptées</span>
<a id="__codelineno-31-14" name="__codelineno-31-14"></a>        <span class="n">type_response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;typeResponse&#39;</span><span class="p">)</span>
<a id="__codelineno-31-15" name="__codelineno-31-15"></a>        <span class="k">if</span> <span class="n">type_response</span> <span class="o">!=</span> <span class="s1">&#39;json&#39;</span> <span class="ow">and</span> <span class="n">type_response</span> <span class="o">!=</span> <span class="s1">&#39;xml&#39;</span><span class="p">:</span>
<a id="__codelineno-31-16" name="__codelineno-31-16"></a>            <span class="c1"># on rend une réponse d&#39;erreur</span>
<a id="__codelineno-31-17" name="__codelineno-31-17"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-31-18" name="__codelineno-31-18"></a>                       <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
<a id="__codelineno-31-19" name="__codelineno-31-19"></a>                       <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">1001</span><span class="p">,</span>
<a id="__codelineno-31-20" name="__codelineno-31-20"></a>                       <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;cette action n&#39;est possible que pour les sessions json ou xml&quot;</span><span class="p">]</span>
<a id="__codelineno-31-21" name="__codelineno-31-21"></a>                   <span class="p">},</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
<a id="__codelineno-31-22" name="__codelineno-31-22"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-31-23" name="__codelineno-31-23"></a>            <span class="c1"># on rend une réponse de réussite</span>
<a id="__codelineno-31-24" name="__codelineno-31-24"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;adminData&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">asdict</span><span class="p">()},</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 13-21 : on vérifie qu’on est dans une session json ou xml ;</li>
<li>ligne 24 : on rend le dictionnaire des données de l’administration fiscale qui dès le démarrage du serveur avaient été placées dans la configuration :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span>
<span class="normal"><a href="#__codelineno-32-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a>    <span class="c1"># admindata sera une donnée de portée application en lecture seule</span>
<a id="__codelineno-32-2" name="__codelineno-32-2"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;admindata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_admindata</span><span class="p">()</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<p>Prenons un client Postman et demandons l’URL <strong>[/get-admindata]</strong>, après avoir démarré une session jSON et s’être authentifié :</p>
<p><img src="images/100000000000023900000100BCF35DE1.png" style="width:6.58cm;height:2.961cm;" alt="Image" /></p>
<p>La réponse du serveur est la suivante :</p>
<p><img src="images/1000000000000370000003FA9C9E97FA.png" style="width:10.171cm;height:11.771cm;" alt="Image" /></p>
<h2 id="3016-laction-calculer-impots">30.16. L’action [calculer-impots]</h2>
<p>L’action <strong>[calculer-impots]</strong> calcule l’impôts d’une liste de contribuables trouvée dans le corps de la requête sous la forme d’une chaîne jSON. Nous connaissons déjà cette action : elle s’appelait <strong>[calculate_tax_in_bulk_mode]</strong> dans la version précédente.</p>
<p>Sa route est la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1">1</a></span>
<span class="normal"><a href="#__codelineno-33-2">2</a></span>
<span class="normal"><a href="#__codelineno-33-3">3</a></span>
<span class="normal"><a href="#__codelineno-33-4">4</a></span>
<span class="normal"><a href="#__codelineno-33-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="c1"># calcul de l&#39;impôt par lots</span>
<a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/calculer-impots&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculer_impots</span><span class="p">():</span>
<a id="__codelineno-33-4" name="__codelineno-33-4"></a>    <span class="c1"># on exécute le contrôleur associé à l&#39;action</span>
<a id="__codelineno-33-5" name="__codelineno-33-5"></a>    <span class="k">return</span> <span class="n">front_controller</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>Cette action est traitée par le contrôleur <strong>[CalculerImpotsController]</strong> suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1">  1</a></span>
<span class="normal"><a href="#__codelineno-34-2">  2</a></span>
<span class="normal"><a href="#__codelineno-34-3">  3</a></span>
<span class="normal"><a href="#__codelineno-34-4">  4</a></span>
<span class="normal"><a href="#__codelineno-34-5">  5</a></span>
<span class="normal"><a href="#__codelineno-34-6">  6</a></span>
<span class="normal"><a href="#__codelineno-34-7">  7</a></span>
<span class="normal"><a href="#__codelineno-34-8">  8</a></span>
<span class="normal"><a href="#__codelineno-34-9">  9</a></span>
<span class="normal"><a href="#__codelineno-34-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-34-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-34-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-34-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-34-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-34-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-34-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-34-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-34-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-34-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-34-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-34-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-34-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-34-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-34-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-34-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-34-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-34-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-34-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-34-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-34-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-34-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-34-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-34-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-34-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-34-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-34-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-34-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-34-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-34-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-34-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-34-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-34-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-34-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-34-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-34-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-34-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-34-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-34-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-34-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-34-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-34-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-34-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-34-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-34-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-34-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-34-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-34-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-34-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-34-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-34-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-34-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-34-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-34-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-34-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-34-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-34-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-34-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-34-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-34-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-34-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-34-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-34-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-34-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-34-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-34-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-34-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-34-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-34-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-34-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-34-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-34-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-34-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-34-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-34-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-34-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-34-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-34-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-34-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-34-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-34-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-34-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-34-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-34-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-34-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-34-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-34-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-34-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-34-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-34-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-34-100">100</a></span>
<span class="normal"><a href="#__codelineno-34-101">101</a></span>
<span class="normal"><a href="#__codelineno-34-102">102</a></span>
<span class="normal"><a href="#__codelineno-34-103">103</a></span>
<span class="normal"><a href="#__codelineno-34-104">104</a></span>
<span class="normal"><a href="#__codelineno-34-105">105</a></span>
<span class="normal"><a href="#__codelineno-34-106">106</a></span>
<span class="normal"><a href="#__codelineno-34-107">107</a></span>
<span class="normal"><a href="#__codelineno-34-108">108</a></span>
<span class="normal"><a href="#__codelineno-34-109">109</a></span>
<span class="normal"><a href="#__codelineno-34-110">110</a></span>
<span class="normal"><a href="#__codelineno-34-111">111</a></span>
<span class="normal"><a href="#__codelineno-34-112">112</a></span>
<span class="normal"><a href="#__codelineno-34-113">113</a></span>
<span class="normal"><a href="#__codelineno-34-114">114</a></span>
<span class="normal"><a href="#__codelineno-34-115">115</a></span>
<span class="normal"><a href="#__codelineno-34-116">116</a></span>
<span class="normal"><a href="#__codelineno-34-117">117</a></span>
<span class="normal"><a href="#__codelineno-34-118">118</a></span>
<span class="normal"><a href="#__codelineno-34-119">119</a></span>
<span class="normal"><a href="#__codelineno-34-120">120</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-34-2" name="__codelineno-34-2"></a>
<a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-34-5" name="__codelineno-34-5"></a>
<a id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceController</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceController</span>
<a id="__codelineno-34-8" name="__codelineno-34-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">TaxPayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaxPayer</span>
<a id="__codelineno-34-9" name="__codelineno-34-9"></a>
<a id="__codelineno-34-10" name="__codelineno-34-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">CalculerImpotsController</span><span class="p">(</span><span class="n">InterfaceController</span><span class="p">):</span>
<a id="__codelineno-34-11" name="__codelineno-34-11"></a>
<a id="__codelineno-34-12" name="__codelineno-34-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-34-13" name="__codelineno-34-13"></a>        <span class="c1"># on récupère les éléments du path</span>
<a id="__codelineno-34-14" name="__codelineno-34-14"></a>        <span class="n">dummy</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<a id="__codelineno-34-15" name="__codelineno-34-15"></a>
<a id="__codelineno-34-16" name="__codelineno-34-16"></a>        <span class="c1"># seules les sessions json et xml sont acceptées</span>
<a id="__codelineno-34-17" name="__codelineno-34-17"></a>        <span class="n">type_response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;typeResponse&#39;</span><span class="p">)</span>
<a id="__codelineno-34-18" name="__codelineno-34-18"></a>        <span class="k">if</span> <span class="n">type_response</span> <span class="o">!=</span> <span class="s1">&#39;json&#39;</span> <span class="ow">and</span> <span class="n">type_response</span> <span class="o">!=</span> <span class="s1">&#39;xml&#39;</span><span class="p">:</span>
<a id="__codelineno-34-19" name="__codelineno-34-19"></a>            <span class="c1"># on rend une réponse d&#39;erreur</span>
<a id="__codelineno-34-20" name="__codelineno-34-20"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-34-21" name="__codelineno-34-21"></a>                       <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
<a id="__codelineno-34-22" name="__codelineno-34-22"></a>                       <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">1501</span><span class="p">,</span>
<a id="__codelineno-34-23" name="__codelineno-34-23"></a>                       <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;cette action n&#39;est possible que pour les sessions json ou xml&quot;</span><span class="p">]</span>
<a id="__codelineno-34-24" name="__codelineno-34-24"></a>                   <span class="p">},</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
<a id="__codelineno-34-25" name="__codelineno-34-25"></a>
<a id="__codelineno-34-26" name="__codelineno-34-26"></a>        <span class="c1"># on récupère le corps du post - on attend une liste de dictionnaires</span>
<a id="__codelineno-34-27" name="__codelineno-34-27"></a>        <span class="n">msg_erreur</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-34-28" name="__codelineno-34-28"></a>        <span class="n">list_dict_taxpayers</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-34-29" name="__codelineno-34-29"></a>        <span class="c1"># le corps jSON du POST</span>
<a id="__codelineno-34-30" name="__codelineno-34-30"></a>        <span class="n">request_text</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span>
<a id="__codelineno-34-31" name="__codelineno-34-31"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-34-32" name="__codelineno-34-32"></a>            <span class="c1"># qu&#39;on transforme en une liste de dictionnaires</span>
<a id="__codelineno-34-33" name="__codelineno-34-33"></a>            <span class="n">list_dict_taxpayers</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request_text</span><span class="p">)</span>
<a id="__codelineno-34-34" name="__codelineno-34-34"></a>        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-34-35" name="__codelineno-34-35"></a>            <span class="c1"># on note l&#39;erreur</span>
<a id="__codelineno-34-36" name="__codelineno-34-36"></a>            <span class="n">msg_erreur</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;le corps du POST n&#39;est pas une chaîne jSON valide : </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-34-37" name="__codelineno-34-37"></a>        <span class="c1"># a-t-on une liste non vide ?</span>
<a id="__codelineno-34-38" name="__codelineno-34-38"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg_erreur</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_dict_taxpayers</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_dict_taxpayers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-34-39" name="__codelineno-34-39"></a>            <span class="c1"># on note l&#39;erreur</span>
<a id="__codelineno-34-40" name="__codelineno-34-40"></a>            <span class="n">msg_erreur</span> <span class="o">=</span> <span class="s2">&quot;le corps du POST n&#39;est pas une liste ou alors cette liste est vide&quot;</span>
<a id="__codelineno-34-41" name="__codelineno-34-41"></a>        <span class="c1"># a-t-on une liste de dictionnaires ?</span>
<a id="__codelineno-34-42" name="__codelineno-34-42"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg_erreur</span><span class="p">:</span>
<a id="__codelineno-34-43" name="__codelineno-34-43"></a>            <span class="n">erreur</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-34-44" name="__codelineno-34-44"></a>            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-34-45" name="__codelineno-34-45"></a>            <span class="k">while</span> <span class="ow">not</span> <span class="n">erreur</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_dict_taxpayers</span><span class="p">):</span>
<a id="__codelineno-34-46" name="__codelineno-34-46"></a>                <span class="n">erreur</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_dict_taxpayers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-34-47" name="__codelineno-34-47"></a>                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-34-48" name="__codelineno-34-48"></a>            <span class="c1"># erreur ?</span>
<a id="__codelineno-34-49" name="__codelineno-34-49"></a>            <span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-34-50" name="__codelineno-34-50"></a>                <span class="n">msg_erreur</span> <span class="o">=</span> <span class="s2">&quot;le corps du POST doit être une liste de dictionnaires&quot;</span>
<a id="__codelineno-34-51" name="__codelineno-34-51"></a>        <span class="c1"># erreur ?</span>
<a id="__codelineno-34-52" name="__codelineno-34-52"></a>        <span class="k">if</span> <span class="n">msg_erreur</span><span class="p">:</span>
<a id="__codelineno-34-53" name="__codelineno-34-53"></a>            <span class="c1"># on envoie une réponse d&#39;erreur au client</span>
<a id="__codelineno-34-54" name="__codelineno-34-54"></a>            <span class="n">résultats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">1501</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">msg_erreur</span><span class="p">]}</span>
<a id="__codelineno-34-55" name="__codelineno-34-55"></a>            <span class="k">return</span> <span class="n">résultats</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
<a id="__codelineno-34-56" name="__codelineno-34-56"></a>
<a id="__codelineno-34-57" name="__codelineno-34-57"></a>        <span class="c1"># on vérifie les TaxPayers un par un</span>
<a id="__codelineno-34-58" name="__codelineno-34-58"></a>        <span class="c1"># au départ pas d&#39;erreurs</span>
<a id="__codelineno-34-59" name="__codelineno-34-59"></a>        <span class="n">list_erreurs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-34-60" name="__codelineno-34-60"></a>        <span class="k">for</span> <span class="n">dict_taxpayer</span> <span class="ow">in</span> <span class="n">list_dict_taxpayers</span><span class="p">:</span>
<a id="__codelineno-34-61" name="__codelineno-34-61"></a>            <span class="c1"># on crée un TaxPayer à partir de dict_taxpayer</span>
<a id="__codelineno-34-62" name="__codelineno-34-62"></a>            <span class="n">msg_erreur</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-34-63" name="__codelineno-34-63"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-34-64" name="__codelineno-34-64"></a>                <span class="c1"># l&#39;opération suivante va éliminer les cas où les paramètres ne sont pas</span>
<a id="__codelineno-34-65" name="__codelineno-34-65"></a>                <span class="c1"># des propriétés de la classe TaxPayer ainsi que les cas où leurs valeurs</span>
<a id="__codelineno-34-66" name="__codelineno-34-66"></a>                <span class="c1"># sont incorrectes</span>
<a id="__codelineno-34-67" name="__codelineno-34-67"></a>                <span class="n">TaxPayer</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">(</span><span class="n">dict_taxpayer</span><span class="p">)</span>
<a id="__codelineno-34-68" name="__codelineno-34-68"></a>            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-34-69" name="__codelineno-34-69"></a>                <span class="n">msg_erreur</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-34-70" name="__codelineno-34-70"></a>            <span class="c1"># certaines clés doivent être présentes dans le dictionnaire</span>
<a id="__codelineno-34-71" name="__codelineno-34-71"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">msg_erreur</span><span class="p">:</span>
<a id="__codelineno-34-72" name="__codelineno-34-72"></a>                <span class="c1"># les clés [marié, enfants, salaire] doivent être présentes dans le dictionnaire</span>
<a id="__codelineno-34-73" name="__codelineno-34-73"></a>                <span class="n">keys</span> <span class="o">=</span> <span class="n">dict_taxpayer</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-34-74" name="__codelineno-34-74"></a>                <span class="k">if</span> <span class="s1">&#39;marié&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span> <span class="ow">or</span> <span class="s1">&#39;enfants&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span> <span class="ow">or</span> <span class="s1">&#39;salaire&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
<a id="__codelineno-34-75" name="__codelineno-34-75"></a>                    <span class="n">msg_erreur</span> <span class="o">=</span> <span class="s2">&quot;le dictionnaire doit inclure les clés [marié, enfants, salaire]&quot;</span>
<a id="__codelineno-34-76" name="__codelineno-34-76"></a>            <span class="c1"># des erreurs ?</span>
<a id="__codelineno-34-77" name="__codelineno-34-77"></a>            <span class="k">if</span> <span class="n">msg_erreur</span><span class="p">:</span>
<a id="__codelineno-34-78" name="__codelineno-34-78"></a>                <span class="c1"># on note l&#39;erreur dans le TaxPayer lui-même</span>
<a id="__codelineno-34-79" name="__codelineno-34-79"></a>                <span class="n">dict_taxpayer</span><span class="p">[</span><span class="s1">&#39;erreur&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg_erreur</span>
<a id="__codelineno-34-80" name="__codelineno-34-80"></a>                <span class="c1"># on ajoute le TaxPayer à la liste des erreurs</span>
<a id="__codelineno-34-81" name="__codelineno-34-81"></a>                <span class="n">list_erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dict_taxpayer</span><span class="p">)</span>
<a id="__codelineno-34-82" name="__codelineno-34-82"></a>
<a id="__codelineno-34-83" name="__codelineno-34-83"></a>        <span class="c1"># on a traité tous les taxpayers - y-a-t-il des erreurs ?</span>
<a id="__codelineno-34-84" name="__codelineno-34-84"></a>        <span class="k">if</span> <span class="n">list_erreurs</span><span class="p">:</span>
<a id="__codelineno-34-85" name="__codelineno-34-85"></a>            <span class="c1"># on envoie une réponse d&#39;erreur au client</span>
<a id="__codelineno-34-86" name="__codelineno-34-86"></a>            <span class="n">résultats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">1501</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="n">list_erreurs</span><span class="p">}</span>
<a id="__codelineno-34-87" name="__codelineno-34-87"></a>            <span class="k">return</span> <span class="n">résultats</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
<a id="__codelineno-34-88" name="__codelineno-34-88"></a>
<a id="__codelineno-34-89" name="__codelineno-34-89"></a>        <span class="c1"># pas d&#39;erreurs, on peut travailler</span>
<a id="__codelineno-34-90" name="__codelineno-34-90"></a>        <span class="c1"># récupération des données de l&#39;administration fiscale</span>
<a id="__codelineno-34-91" name="__codelineno-34-91"></a>        <span class="n">admindata</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;admindata&quot;</span><span class="p">]</span>
<a id="__codelineno-34-92" name="__codelineno-34-92"></a>        <span class="n">métier</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;métier&quot;</span><span class="p">]</span>
<a id="__codelineno-34-93" name="__codelineno-34-93"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-34-94" name="__codelineno-34-94"></a>            <span class="c1"># on traite les TaxPayer un à un</span>
<a id="__codelineno-34-95" name="__codelineno-34-95"></a>            <span class="n">list_taxpayers</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-34-96" name="__codelineno-34-96"></a>            <span class="k">for</span> <span class="n">dict_taxpayer</span> <span class="ow">in</span> <span class="n">list_dict_taxpayers</span><span class="p">:</span>
<a id="__codelineno-34-97" name="__codelineno-34-97"></a>                <span class="c1"># calcul de l&#39;impôt</span>
<a id="__codelineno-34-98" name="__codelineno-34-98"></a>                <span class="n">taxpayer</span> <span class="o">=</span> <span class="n">TaxPayer</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">(</span>
<a id="__codelineno-34-99" name="__codelineno-34-99"></a>                    <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="n">dict_taxpayer</span><span class="p">[</span><span class="s1">&#39;marié&#39;</span><span class="p">],</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="n">dict_taxpayer</span><span class="p">[</span><span class="s1">&#39;enfants&#39;</span><span class="p">],</span>
<a id="__codelineno-34-100" name="__codelineno-34-100"></a>                     <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="n">dict_taxpayer</span><span class="p">[</span><span class="s1">&#39;salaire&#39;</span><span class="p">]})</span>
<a id="__codelineno-34-101" name="__codelineno-34-101"></a>                <span class="n">métier</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">taxpayer</span><span class="p">,</span> <span class="n">admindata</span><span class="p">)</span>
<a id="__codelineno-34-102" name="__codelineno-34-102"></a>                <span class="c1"># on mémorise le résultat en tant que dictionnaire</span>
<a id="__codelineno-34-103" name="__codelineno-34-103"></a>                <span class="n">list_taxpayers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">asdict</span><span class="p">())</span>
<a id="__codelineno-34-104" name="__codelineno-34-104"></a>            <span class="c1"># on ajoute list_taxpayers aux simulations actuelles en donnant à chaque simulation un n°</span>
<a id="__codelineno-34-105" name="__codelineno-34-105"></a>            <span class="n">simulations</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;simulations&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-34-106" name="__codelineno-34-106"></a>            <span class="n">id_simulation</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id_simulation&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-34-107" name="__codelineno-34-107"></a>            <span class="k">for</span> <span class="n">simulation</span> <span class="ow">in</span> <span class="n">list_taxpayers</span><span class="p">:</span>
<a id="__codelineno-34-108" name="__codelineno-34-108"></a>                <span class="c1"># on donne un n° à chaque simulation</span>
<a id="__codelineno-34-109" name="__codelineno-34-109"></a>                <span class="n">id_simulation</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-34-110" name="__codelineno-34-110"></a>                <span class="n">simulation</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_simulation</span>
<a id="__codelineno-34-111" name="__codelineno-34-111"></a>                <span class="c1"># on l&#39;ajoute à la liste actuelle des simulations</span>
<a id="__codelineno-34-112" name="__codelineno-34-112"></a>                <span class="n">simulations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span>
<a id="__codelineno-34-113" name="__codelineno-34-113"></a>            <span class="c1"># on remet le tout en session</span>
<a id="__codelineno-34-114" name="__codelineno-34-114"></a>            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;simulations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simulations</span>
<a id="__codelineno-34-115" name="__codelineno-34-115"></a>            <span class="n">session</span><span class="p">[</span><span class="s2">&quot;id_simulation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_simulation</span>
<a id="__codelineno-34-116" name="__codelineno-34-116"></a>            <span class="c1"># on envoie la réponse au client</span>
<a id="__codelineno-34-117" name="__codelineno-34-117"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">1500</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="n">list_taxpayers</span><span class="p">},</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span>
<a id="__codelineno-34-118" name="__codelineno-34-118"></a>        <span class="k">except</span> <span class="n">ImpôtsError</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-34-119" name="__codelineno-34-119"></a>            <span class="c1"># on envoie une réponse d&#39;erreur au client</span>
<a id="__codelineno-34-120" name="__codelineno-34-120"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s2">&quot;état&quot;</span><span class="p">:</span> <span class="mi">1501</span><span class="p">,</span> <span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]},</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 16-24 : on vérifie qu’on est bien dans une session json ou xml</li>
<li>lignes 26-120 : ce code nous est globalement connu. C’est celui de la fonction |<a href="#_Le_contrôleur_[index_controller]"><u><u>index_controller</u></u></a>| de la version 10 de l’application qui a été aménagé pour répondre aux spécifications de l’interface <strong>[</strong><strong>InterfaceController</strong><strong>]</strong> implémentée ;</li>
<li>lignes 104-115 : le code ajouté pour tenir compte du nouvel environnement de ce contrôleur. On vient de faire des calculs d’impôt. Il nous faut mémoriser les résultats dans la liste des simulations maintenues en session ;</li>
<li>ligne 105 : on récupère la liste des simulations en session ;</li>
<li>ligne 106 : on récupère le n° de la dernière simulation faite ;</li>
<li>lignes 107-112 : on parcourt la liste des dictionnaires des résultats du calcul de l’impôt, à chacun d’eux on attribue un n° <strong>[id]</strong> de simulation et chaque dictionnaire est ajouté à la liste des simulations ;</li>
<li>lignes 113-115 : la nouvelle liste des simulations ainsi que le n° de la dernière simulation faite sont remis en session ;
Nous faisons le test Postman suivant, après avoir initialisé une session jSON et s’être authentifié :</li>
</ul>
<p><img src="images/10000000000005FE000001960B59FC7D.png" style="width:17.691cm;height:4.691cm;" alt="Image" /></p>
<p><img src="images/10000000000003E70000020DD3E6731F.png" style="width:11.51cm;height:6.07cm;" alt="Image" /></p>
<p>La réponse du serveur est la suivante :</p>
<p><img src="images/100000000000024A000002BBAEB19130.png" style="width:6.771cm;height:8.081cm;" alt="Image" /></p>
<p>Si maintenant, on demande la liste des simulations :</p>
<p>On remarquera que dans la liste résultat de <strong>[/calcul-impots]</strong>, les contribuables n’ont pas d’attribut <strong>[id]</strong> alors que dans la liste des simulations, chaque simulation a un n° qui l’identifie.</p>
<p><img src="images/10000000000004FD0000032045FED02A.png" style="width:14.742cm;height:9.24cm;" alt="Image" /></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner">

      <div>
        <a href="https://tahe.developpez.com" target="_blank">
          https://tahe.developpez.com
        </a>
        <br>
        Ce cours tutoriel écrit par <strong>Serge Tahé</strong> est mis à disposition du public selon les termes de la
        <em>Licence Creative Commons Attribution – Pas d’Utilisation Commerciale –
        Partage dans les Mêmes Conditions 3.0 non transposé</em>.
      </div>

    </div>
  </div>

      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": ".", "features": ["navigation.sections", "navigation.indexes", "toc.integrate", "navigation.top"], "search": "assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="javascripts/focus.js"></script>
      
    
  </body>
</html>