{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"index.html","title":"Accueil","text":"<p>INTRODUCTION AU LANGAGE PYTHON 3 ET AU FRAMEWORK WEB FLASK PAR L'EXEMPLE</p> <p>Serge Tah\u00e9, septembre 2020</p>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html","title":"14. Architecture en couches et programmation par interfaces","text":""},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#141-introduction","title":"14.1. Introduction","text":"<p>Nous nous proposons d'\u00e9crire une application permettant l'affichage des notes des \u00e9l\u00e8ves d'un coll\u00e8ge. Cette application peut avoir une architecture multicouche\u00a0:</p> <p></p> <ul> <li>la couche [ui] (User Interface) est la couche en contact avec l'utilisateur de l'application\u00a0;</li> <li>la couche [m\u00e9tier] impl\u00e9mente les r\u00e8gles de gestion de l'application, tels que le calcul d'un salaire ou d'une facture. Cette couche utilise des donn\u00e9es provenant de l'utilisateur via la couche [pr\u00e9sentation] et du SGBD via la couche [dao]\u00a0;</li> <li>la couche [dao] (Data Access Objects) g\u00e8re l'acc\u00e8s aux donn\u00e9es du SGBD (Syst\u00e8me de Gestion de Bases de Donn\u00e9es). C'est l'architecture qui avait \u00e9t\u00e9 utilis\u00e9e dans le |cours sur Python 2|. On peut \u00e9galement introduire une variante\u00a0:</li> </ul> <p></p> <p>Les diff\u00e9rences vis \u00e0 vis de la structure en couches pr\u00e9c\u00e9dente sont les suivantes :</p> <ul> <li>un script principal appel\u00e9 [main] ci-dessus organise l'instanciation des couches\u00a0;</li> <li> <p>les couches [ui, m\u00e9tier, dao] ne communiquent plus forc\u00e9ment entre-elles. Si elles le doivent, le script [main] leur fournit les r\u00e9f\u00e9rences des couches dont elles ont besoin\u00a0; Le code est ici organis\u00e9 en centres de comp\u00e9tences avec un chef d'orchestre\u00a0:</p> </li> <li> <p>le chef d'orchestre est le script principal [main]\u00a0;</p> </li> <li>les couches [ui], [dao] et [m\u00e9tier] sont les centres de comp\u00e9tences\u00a0; On pourrait appeler cette organisation, une organisation orchestrale.</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#142-exemple-1","title":"14.2. Exemple 1","text":"<p>Nous allons illustrer l\u2019architecture en couches avec une application console simple\u00a0:</p> <ul> <li>il n'y aura pas de base de donn\u00e9es\u00a0;</li> <li>la couche [dao] g\u00e8rera des entit\u00e9s El\u00e8ve, Classe, Mati\u00e8re, Note permettant de g\u00e9rer les notes des \u00e9l\u00e8ves\u00a0;</li> <li>la couche [m\u00e9tier] permettra de calculer des indicateurs sur les notes d'un \u00e9l\u00e8ve pr\u00e9cis\u00a0;</li> <li>la couche [ui] sera une application console qui affichera les r\u00e9sultats des \u00e9l\u00e8ves\u00a0; Le projet PyCharm de l'application est le suivant\u00a0:</li> </ul> <p></p> <p>Note\u00a0: les dossiers en bleu font partie des [Sources Root] du projet PyCharm.</p>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#1421-les-entites-de-lapplication","title":"14.2.1. Les entit\u00e9s de l'application","text":"<p>On appellera entit\u00e9s, des classes dont le seul r\u00f4le est d'encapsuler des donn\u00e9es. On pourrait pour ce faire utiliser des dictionnaires. L'int\u00e9r\u00eat de la classe est de permettre de tester la validit\u00e9 des donn\u00e9es stock\u00e9es dans l'objet et de fournir une m\u00e9thode fournissant l'identit\u00e9 de l'objet sous la forme d'une cha\u00eene de caract\u00e8res.</p> <p></p>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#14211-lentite-classe","title":"14.2.1.1. L'entit\u00e9 [Classe]","text":"<p>L'entit\u00e9 [Classe] (Classe.py) repr\u00e9sente une classe du coll\u00e8ge\u00a0:</p> <pre><code># imports\nfrom BaseEntity import BaseEntity\nfrom MyException import MyException\nfrom Utils import Utils\n\n\nclass Classe(BaseEntity):\n    # attributs exclus de l'\u00e9tat de la classe\n    excluded_keys = []\n\n    # propri\u00e9t\u00e9s de la classe\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        # id : identifiant de la classe\n        # nom : nom de la classe\n        return BaseEntity.get_allowed_keys() + [\"nom\"]\n\n    # getter\n    @property\n    def nom(self: object) -&gt; str:\n        return self.__nom\n\n    #  setters\n    @nom.setter\n    def nom(self: object, nom: str):\n        # nom doit \u00eatre une cha\u00eene de caract\u00e8res non vide\n        if Utils.is_string_ok(nom):\n            self.__nom = nom\n        else:\n            raise MyException(11, f\"Le nom de la classe {self.id} doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\n</code></pre> <p>Notes</p> <ul> <li>ligne 7\u00a0: l'entit\u00e9 [Classe] d\u00e9rive de l'entit\u00e9 [BaseEntity]\u00a0\u00e9tudi\u00e9e au paragraphe |La classe BaseEntity|\u00a0;</li> <li>lignes 11-16\u00a0: une classe est d\u00e9finie par un n\u00b0 id et un nom (ligne 16). La propri\u00e9t\u00e9 [id] est fournie par la classe [BaseEntity] et le nom par la classe [Classe]\u00a0;</li> <li>lignes 18-30\u00a0: getter / setter de l'attribut [nom]\u00a0;</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#14212-lentite-matiere","title":"14.2.1.2. L'entit\u00e9 [Mati\u00e8re]","text":"<p>La classe [Mati\u00e8re] (mati\u00e8re.py) est la suivante\u00a0:</p> <pre><code># imports\nfrom BaseEntity import BaseEntity\nfrom MyException import MyException\nfrom Utils import Utils\n\n\nclass Mati\u00e8re(BaseEntity):\n    # attributs exclus de l'\u00e9tat de la classe\n    excluded_keys = []\n\n    # propri\u00e9t\u00e9s de la classe\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        # id : identifiant de la mati\u00e8re\n        # nom : nom de la mati\u00e8re\n        # coefficient : coefficient de la mati\u00e8re\n        return BaseEntity.get_allowed_keys() + [\"nom\", \"coefficient\"]\n\n    # getter\n    @property\n    def nom(self: object) -&gt; str:\n        return self.__nom\n\n    @property\n    def coefficient(self: object) -&gt; float:\n        return self.__coefficient\n\n    #  setters\n    @nom.setter\n    def nom(self: object, nom: str):\n        # nom doit \u00eatre une cha\u00eene de caract\u00e8res non vide\n        if Utils.is_string_ok(nom):\n            self.__nom = nom\n        else:\n            raise MyException(21, f\"Le nom de la mati\u00e8re {self.id} doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\n\n    @coefficient.setter\n    def coefficient(self, coefficient: float):\n        # le coefficient doit \u00eatre un r\u00e9el &gt;=0\n        erreur = False\n        if isinstance(coefficient, (int, float)):\n            if coefficient &gt;= 0:\n                self.__coefficient = coefficient\n            else:\n                erreur = True\n        else:\n            erreur = True\n        # erreur ?\n        if erreur:\n            raise MyException(22, f\"Le coefficient de la mati\u00e8re {self.nom} doit \u00eatre un r\u00e9el &gt;=0\")\n</code></pre> <p>Notes</p> <ul> <li>ligne 7\u00a0: la classe [Classe] d\u00e9rive de la classe [BaseEntity]\u00a0;</li> <li>lignes 11-17\u00a0: une mati\u00e8re est d\u00e9finie par son n\u00b0 [id], son nom [nom], son coefficient [coefficient]\u00a0;</li> <li>lignes 19-50\u00a0: getters / setters des attributs de la classe\u00a0;</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#14213-lentite-eleve","title":"14.2.1.3. L'entit\u00e9 [El\u00e8ve]","text":"<p>La classe [El\u00e8ve] (\u00e9l\u00e8ve.py) est la suivante\u00a0:</p> <pre><code># imports\nfrom BaseEntity import BaseEntity\nfrom Classe import Classe\nfrom MyException import MyException\n\nfrom Utils import Utils\n\n\nclass El\u00e8ve(BaseEntity):\n    # attributs exclus de l'\u00e9tat de la classe\n    excluded_keys = []\n\n    # propri\u00e9t\u00e9s de la classe\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        # id : identifiant de l'\u00e9l\u00e8ve\n        # nom : nom de l'\u00e9l\u00e8ve\n        # pr\u00e9nom : pr\u00e9nom de l'\u00e9l\u00e8ve\n        # classe : classe de l'\u00e9l\u00e8ve\n        return BaseEntity.get_allowed_keys() + [\"nom\", \"pr\u00e9nom\", \"classe\"]\n\n    # getters\n    @property\n    def nom(self: object) -&gt; str:\n        return self.__nom\n\n    @property\n    def pr\u00e9nom(self: object) -&gt; str:\n        return self.__pr\u00e9nom\n\n    @property\n    def classe(self: object) -&gt; Classe:\n        return self.__classe\n\n    #  setters\n    @nom.setter\n    def nom(self: object, nom: str) -&gt; str:\n        # nom doit \u00eatre une cha\u00eene de caract\u00e8res non vide\n        if Utils.is_string_ok(nom):\n            self.__nom = nom\n        else:\n            raise MyException(41, f\"Le nom de l'\u00e9l\u00e8ve {self.id} doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\n\n    @pr\u00e9nom.setter\n    def pr\u00e9nom(self: object, pr\u00e9nom: str) -&gt; str:\n        # pr\u00e9nom doit \u00eatre une cha\u00eene de caract\u00e8res non vide\n        if Utils.is_string_ok(pr\u00e9nom):\n            self.__pr\u00e9nom = pr\u00e9nom\n        else:\n            raise MyException(42, f\"Le pr\u00e9nom de l'\u00e9l\u00e8ve {self.id} doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\n\n    @classe.setter\n    def classe(self: object, value):\n        try:\n            # on attend un type Classe\n            if isinstance(value, Classe):\n                self.__classe = value\n            # ou un type dict\n            elif isinstance(value,dict):\n                self.__classe=Classe().fromdict(value)\n            # ou un type json\n            elif isinstance(value,str):\n                self.__classe = Classe().fromjson(value)\n        except BaseException as erreur:\n            raise MyException(43, f\"L'attribut [{value}] de l'\u00e9l\u00e8ve {self.id} doit \u00eatre de type Classe ou dict ou json. Erreur : {erreur}\")\n</code></pre> <p>Notes</p> <ul> <li>ligne 9\u00a0: la classe [El\u00e8ve] d\u00e9rive de la classe [BaseEntity]\u00a0;</li> <li>lignes 13-20\u00a0: un \u00e9l\u00e8ve est caract\u00e9ris\u00e9 par son n\u00b0 [id], son nom [nom], son pr\u00e9nom [pr\u00e9nom], sa classe[classe]. Ce dernier param\u00e8tre est une r\u00e9f\u00e9rence sur un objet [Classe]\u00a0;</li> <li>lignes 22-65\u00a0: getters / setters des attributs de la classe\u00a0;</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#14214-lentite-note","title":"14.2.1.4. L'entit\u00e9 [Note]","text":"<p>La classe [Note] (note.py) est la suivante\u00a0:</p> <pre><code># imports\nfrom BaseEntity import BaseEntity\nfrom El\u00e8ve import El\u00e8ve\nfrom Mati\u00e8re import Mati\u00e8re\nfrom MyException import MyException\n\n\nclass Note(BaseEntity):\n    # attributs exclus de l'\u00e9tat de la classe\n    excluded_keys = []\n\n    # propri\u00e9t\u00e9s de la classe\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        # id : identifiant de la note\n        # valeur : la note elle-m\u00eame\n        # \u00e9l\u00e8ve : \u00e9l\u00e8ve (de type El\u00e8ve) concern\u00e9 par la note\n        # mati\u00e8re : mati\u00e8re (de type Mati\u00e8re) concern\u00e9e par la note\n        # l'objet Note est donc la note d'un \u00e9l\u00e8ve dans une mati\u00e8re\n        return BaseEntity.get_allowed_keys() + [\"valeur\", \"\u00e9l\u00e8ve\", \"mati\u00e8re\"]\n\n    # getters\n    @property\n    def valeur(self: object) -&gt; float:\n        return self.__valeur\n\n    @property\n    def \u00e9l\u00e8ve(self: object) -&gt; El\u00e8ve:\n        return self.__\u00e9l\u00e8ve\n\n    @property\n    def mati\u00e8re(self: object) -&gt; Mati\u00e8re:\n        return self.__mati\u00e8re\n\n    # getters\n    @valeur.setter\n    def valeur(self: object, valeur: float):\n        # la note doit \u00eatre un r\u00e9el entre 0 et 20\n        if isinstance(valeur, (int, float)) and 0 &lt;= valeur &lt;= 20:\n            self.__valeur = valeur\n        else:\n            raise MyException(31,\n                              f\"L'attribut {valeur} de la note {self.id} doit \u00eatre un nombre dans l'intervalle [0,20]\")\n\n    @\u00e9l\u00e8ve.setter\n    def \u00e9l\u00e8ve(self: object, value):\n        try:\n            # on attend un type El\u00e8ve\n            if isinstance(value, El\u00e8ve):\n                self.__\u00e9l\u00e8ve = value\n            # ou un type dict\n            elif isinstance(value, dict):\n                self.__\u00e9l\u00e8ve = El\u00e8ve().fromdict(value)\n            # ou un type json\n            elif isinstance(value, str):\n                self.__\u00e9l\u00e8ve = El\u00e8ve().fromjson(value)\n        except BaseException as erreur:\n            raise MyException(32,\n                              f\"L'attribut [{value}] de la note {self.id} doit \u00eatre de type El\u00e8ve ou dict ou json. Erreur : {erreur}\")\n\n    @mati\u00e8re.setter\n    def mati\u00e8re(self: object, value):\n        try:\n            # on attend un type Mati\u00e8re\n            if isinstance(value, Mati\u00e8re):\n                self.__mati\u00e8re = value\n            # ou un type dict\n            elif isinstance(value, dict):\n                self.__mati\u00e8re = Mati\u00e8re().fromdict(value)\n            # ou un type json\n            elif isinstance(value, str):\n                self.__mati\u00e8re = Mati\u00e8re().fromjson(value)\n        except BaseException as erreur:\n            raise MyException(33,\n                              f\"L'attribut [{value}] de la note {self.id} doit \u00eatre de type Mati\u00e8re ou dict ou json. Erreur : {erreur}\")\n</code></pre> <p>Notes</p> <ul> <li>ligne 8\u00a0: la classe [Note] d\u00e9rive de la classe [BaseEntity]\u00a0;</li> <li>lignes 12-20\u00a0: un objet [Note] est caract\u00e9ris\u00e9 par son n\u00b0 [id], la valeur de la note [valeur], une r\u00e9f\u00e9rence [\u00e9l\u00e8ve] sur l'\u00e9l\u00e8ve qui a cette note, une r\u00e9f\u00e9rence sur la mati\u00e8re [mati\u00e8re] objet de la note\u00a0;</li> <li>lignes 22-75\u00a0: getters / setters des attributs de la classe\u00a0;</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#1422-configuration-de-lapplication","title":"14.2.2. Configuration de l\u2019application","text":"<p>Le fichier [config.py] configure l\u2019environnement du script principal [main] (1) ainsi que celui des tests (2). Tous ces scripts ont une instruction [import config] en d\u00e9but de code. On rappelle que le dossier contenant le script objet de la commande [python script] fait automatiquement partie du Python Path.Si donc [config] est dans le m\u00eame dossier que les scripts ayant l\u2019instruction [import config], il sera trouv\u00e9. Les fichiers [1] et [2] sont ici identiques. Ce pourrait ne pas \u00eatre le cas.</p> <p>Le fichier [config.sys] est le suivant\u00a0:</p> <pre><code>def\u00a0configure():\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0absolu\u00a0du\u00a0dossier\u00a0de\u00a0ce\u00a0script\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\u00a0\u00a0\u00a0\u00a0#\u00a0root_dir\n\u00a0\u00a0\u00a0\u00a0root_dir=\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes\"\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\u00a0absolues\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies=[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0dossiers\u00a0locaux\u00a0contenant\u00a0des\u00a0classes\u00a0et\u00a0interfaces\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/02/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../services\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0mise\u00a0\u00e0\u00a0jour\u00a0du\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0return\u00a0{}\n</code></pre> <ul> <li>lignes 11-14\u00a0: les dossiers qui doivent faire partie du Python Path (sys.path)\u00a0;</li> <li>le dossier [f\"{root_dir}/02/entities\"] donne acc\u00e8s aux classes [BaseEntity] et [MyException]\u00a0;</li> <li>le dossier [f\"{script_dir}/../entities\"] donne acc\u00e8s aux classes [El\u00e8ve], [Classe], [Mati\u00e8re], [Note]\u00a0;</li> <li>le dossier [f\"{script_dir}/../interfaces\",] donne acc\u00e8s aux interfaces de l\u2019application\u00a0;</li> <li>le dossier [f\"{script_dir}/../services\"] donne acc\u00e8s aux classes impl\u00e9mentant les interfaces\u00a0;</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#1423-tests-des-entites","title":"14.2.3. Tests des entit\u00e9s","text":"<p>Nous allons ici \u00e9crire des tests ex\u00e9cut\u00e9s par un outil appel\u00e9 [unittest]. PyCharm vient avec plusieurs frameworks de test. Le choix de l\u2019un d\u2019eux se fait dans la configuration de PyCharm\u00a0:</p> <p></p> <ul> <li>en [4], plusieurs frameworks de test sont disponibles\u00a0:</li> </ul> <p></p>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#14231-la-classe-de-tests-testbaseentity","title":"14.2.3.1. La classe de tests [TestBaseEntity]","text":"<p>Le script de test [TestBaseEntity] sera le suivant\u00a0:</p> <pre><code>import unittest\n\n# on configure l'application\nimport config\n\nconfig = config.configure()\n\n\nclass TestBaseEntity (unittest.TestCase):\n\n    def test_note1(self):\n        # imports\n        from Note import Note\n        from El\u00e8ve import El\u00e8ve\n        from Classe import Classe\n        from Mati\u00e8re import Mati\u00e8re\n        # construction d'une note \u00e0 partir d'une cha\u00eene jSON\n        note = Note().fromjson(\n            '{\"id\": 8, \"valeur\": 12, \"\u00e9l\u00e8ve\": {\"id\": 42, \"nom\": \"nom4\", \"pr\u00e9nom\": \"pr\u00e9nom4\", \"classe\": {\"id\": 2, \"nom\": \"classe2\"}}, \"mati\u00e8re\": {\"id\": 2, \"nom\": \"mati\u00e8re2\", \"coefficient\": 2}}')\n        # v\u00e9rifications\n        self.assertIsInstance(note, Note)\n        self.assertIsInstance(note.\u00e9l\u00e8ve, El\u00e8ve)\n        self.assertIsInstance(note.\u00e9l\u00e8ve.classe, Classe)\n        self.assertIsInstance(note.mati\u00e8re, Mati\u00e8re)\n\n\n    def test_note2(self):\n        # imports\n        from Note import Note\n        from El\u00e8ve import El\u00e8ve\n        from Classe import Classe\n        from Mati\u00e8re import Mati\u00e8re\n        # construction d'une note \u00e0 partir d'un dictionnaire\n        note = Note().fromdict(\n            {\"id\": 8, \"valeur\": 12, \"\u00e9l\u00e8ve\": {\"id\": 42, \"nom\": \"nom4\", \"pr\u00e9nom\": \"pr\u00e9nom4\",\n                                              \"classe\": {\"id\": 2, \"nom\": \"classe2\"}},\n             \"mati\u00e8re\": {\"id\": 2, \"nom\": \"mati\u00e8re2\", \"coefficient\": 2}})\n        # v\u00e9rifications\n        self.assertIsInstance(note, Note)\n        self.assertIsInstance(note.\u00e9l\u00e8ve, El\u00e8ve)\n        self.assertIsInstance(note.\u00e9l\u00e8ve.classe, Classe)\n        self.assertIsInstance(note.mati\u00e8re, Mati\u00e8re)\n\nif __name__ == '__main__':\n    unittest.main()\n</code></pre> <p>Notes</p> <ul> <li>ligne 1\u00a0: on importe le module [unittest] qui va fournir les diff\u00e9rentes m\u00e9thodes de test\u00a0;</li> <li>lignes 3-6\u00a0: on configure l\u2019application pour que les classes n\u00e9cessaires aux tests soient trouv\u00e9es\u00a0;</li> <li>ligne 9\u00a0: une classe de test [unittest] doit \u00e9tendre la classe [unittest.TestCase]\u00a0;</li> <li>lignes 11, 27\u00a0: les fonctions de test doivent avoir un nom commen\u00e7ant par [test]\u00a0sinon elles ne seront pas reconnues\u00a0;</li> <li>lignes 13-16\u00a0: on importe les classes dont on a besoin\u00a0;</li> <li>dans cette classe de test, on veut v\u00e9rifier le comportement des m\u00e9thodes [BaseEntity.fromdict] (ligne 34) et [BaseEntity.fromjson] (ligne 18). La classe [Note] a des propri\u00e9t\u00e9s qui sont des r\u00e9f\u00e9rences \u00e0 d\u2019autres classes. On veut v\u00e9rifier que les deux m\u00e9thodes pr\u00e9c\u00e9dentes cr\u00e9ent des objets [Note] valides\u00a0;</li> <li>ligne 18\u00a0: on cr\u00e9e un objet [Note] \u00e0 partir d\u2019un objet jSON\u00a0;</li> <li>ligne 21\u00a0: on v\u00e9rifie que l\u2019objet cr\u00e9\u00e9 est bien de type [Note]. La m\u00e9thode [assertIsInstance] est une m\u00e9thode de la classe [unittest.TestCase], classe parent de la classe [TestBaseEntity]\u00a0;</li> <li>ligne 22\u00a0: on v\u00e9rifie que [note.\u00e9l\u00e8ve] est bien de type [El\u00e8ve]\u00a0;</li> <li>ligne 23\u00a0: on v\u00e9rifie que [note.\u00e9l\u00e8ve.classe] est bien de type [Classe]\u00a0;</li> <li>ligne 24\u00a0: on v\u00e9rifie que [note.mati\u00e8re] est bien de type [Mati\u00e8re]\u00a0;</li> <li>lignes 33-42\u00a0: on fait de m\u00eame avec la m\u00e9thode [BaseEntity.fromdict]\u00a0; Il y a plusieurs fa\u00e7on d\u2019ex\u00e9cuter les tests\u00a0:</li> </ul> <p></p> <ul> <li>en [1-2], on ex\u00e9cute [TestBaseEntity] avec le framework [UnitTest]\u00a0;</li> <li>en [3-5], les tests \u00e9chouent. [UnitTests] indique qu\u2019il n\u2019a trouv\u00e9 aucun test \u00e0 ex\u00e9cuter\u00a0; L\u2019\u00e9chec des tests vient de l\u2019organisation du code de [TestBaseEntity]\u00a0:</li> </ul> <pre><code>import unittest\n\n# on configure l'application\nimport config\n\nconfig = config.configure()\n\n\nclass TestBaseEntity(unittest.TestCase):\n</code></pre> <p>Ce qui g\u00eane le framework [UnitTest], c\u2019est la pr\u00e9sence de code ex\u00e9cutable, lignes 3-6, avant la d\u00e9finition de la classe de test, ligne 9.</p> <p>On r\u00e9organise alors le code de la fa\u00e7on suivante\u00a0:</p> <pre><code>import unittest\n\n\nclass TestBaseEntity(unittest.TestCase):\n\n    def setUp(self):\n        # on configure l'application\n        import config\n\n        config.configure()\n\n    def test_note1(self):\n        \u2026\n\n    def test_note2(self):\n        \u2026\n\n\nif __name__ == '__main__':\n    unittest.main()\n</code></pre> <ul> <li>lignes 6-10\u00a0: on d\u00e9finit une fonction [setUp]. Cette fonction a un r\u00f4le particulier\u00a0: elle est ex\u00e9cut\u00e9e avant chaque fonction de test (test_note1, test_note2)\u00a0; Ceci fait, l\u2019ex\u00e9cution de la classe [TestBaseEntity] donne les r\u00e9sultats suivants\u00a0:</li> </ul> <p></p> <p>Cette fois-ci les deux m\u00e9thodes de test ont \u00e9t\u00e9 ex\u00e9cut\u00e9es et les tests ont \u00e9t\u00e9 r\u00e9ussis.</p> <p>Voyons ce qui se passe lorsqu\u2019un test \u00e9choue. Modifions le code de [test_note1] de la fa\u00e7on suivante\u00a0:</p> <pre><code>    def test_note1(self):\n        # erreur volontaire - on v\u00e9rifie que 1==2\n        self.assertEqual(1,2)\n        # imports\n        from Note import Note\n\u2026\n</code></pre> <ul> <li>ligne 2\u00a0: on v\u00e9rifie que 1==2\u00a0; Les r\u00e9sultats de l\u2019ex\u00e9cution sont alors les suivants\u00a0:</li> </ul> <p></p> <p>On peut conna\u00eetre la cause de l\u2019erreur en cliquant sur le test rat\u00e9 [2]\u00a0:</p> <p></p> <ul> <li>en [7-8], la cause de l\u2019erreur\u00a0; Une autre fa\u00e7on d\u2019ex\u00e9cuter une classe de tests est de l\u2019ex\u00e9cuter dans un terminal\u00a0:</li> </ul> <p></p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\troiscouches\\v01\\tests&gt;python -m unittest TestBaseEntity.py\n..\n----------------------------------------------------------------------\nRan 2 tests in 0.026s\n\nOK\n</code></pre> <p>La ligne 6 indique que les deux tests ont r\u00e9ussi (on a enlev\u00e9 l\u2019erreur 1==2)\u00a0;</p> <p>Enfin une trois\u00e8me fa\u00e7on d\u2019ex\u00e9cuter la classe de tests [TestBaseEntity], toujours dans un terminal, est la suivante. On termine la classe de tests avec les lignes 6-7 suivantes\u00a0;</p> <pre><code>\u2026\n        self.assertIsInstance(note.\u00e9l\u00e8ve.classe, Classe)\n        self.assertIsInstance(note.mati\u00e8re, Mati\u00e8re)\n\n\nif __name__ == '__main__':\n    unittest.main()\n</code></pre> <ul> <li>ligne 6\u00a0: la variable [name] est le nom donn\u00e9 au script qui s\u2019ex\u00e9cute. Lorsque le script est le script lanc\u00e9 par la commande [python script.py], la variable [name] vaut [main] (2 caract\u00e8res soulign\u00e9s avant et apr\u00e8s l\u2019identifiant). Ainsi la ligne 7 n\u2019est ex\u00e9cut\u00e9e que lorsque le script [TestBaseEntity] est lanc\u00e9 par la commande [python TestBaseEntity.py]. L\u2019instruction [unittest.main()] lance l\u2019ex\u00e9cution du script par le framework [UnitTest]. Voici un exemple\u00a0: <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\troiscouches\\v01\\tests&gt;python TestBaseEntity.py\n..\n----------------------------------------------------------------------\nRan 2 tests in 0.013s\n\nOK\n</code></pre></li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#14232-la-classe-de-tests-testentites","title":"14.2.3.2. La classe de tests [TestEntit\u00e9s]","text":"<p>La classe de tests [TestEntit\u00e9s] est la suivante\u00a0:</p> <pre><code>import unittest\n\n\nclass TestEntit\u00e9s(unittest.TestCase):\n    def setUp(self):\n        # on configure l'application\n        import config\n\n        config.configure()\n\n    def test_code1a(self):\n        # imports\n        from El\u00e8ve import El\u00e8ve\n        from MyException import MyException\n        # code d'erreur\n        code = None\n        try:\n            # id invalide\n            El\u00e8ve().fromdict({\"id\": \"x\", \"nom\": \"y\", \"pr\u00e9nom\": \"z\", \"classe\": \"t\"})\n        except MyException as ex:\n            print(f\"\\ncode erreur={ex.code}, message={ex}\")\n            code = ex.code\n        # v\u00e9rification\n        self.assertEqual(code, 1)\n\n    def test_code41(self):\n        # imports\n        from El\u00e8ve import El\u00e8ve\n        from MyException import MyException\n        # code d'erreur\n        code = None\n\n        try:\n            # nom invalide\n            El\u00e8ve().fromdict({\"id\": 1, \"nom\": \"\", \"pr\u00e9nom\": \"z\", \"classe\": \"t\"})\n        except MyException as ex:\n            print(f\"\\ncode erreur={ex.code}, message={ex}\")\n            code = ex.code\n        # v\u00e9rification\n        self.assertEqual(code, 41)\n\n    def test_code42(self):\n        # imports\n        from El\u00e8ve import El\u00e8ve\n        from MyException import MyException\n        # code d'erreur\n        code = None\n        try:\n            # pr\u00e9nom invalide\n            El\u00e8ve().fromdict({\"id\": 1, \"nom\": \"y\", \"pr\u00e9nom\": \"\", \"classe\": \"t\"})\n        except MyException as ex:\n            print(f\"\\ncode erreur={ex.code}, message={ex}\")\n            code = ex.code\n        # v\u00e9rification\n        self.assertEqual(code, 42)\n\n    def test_code43(self):\n        # imports\n        from El\u00e8ve import El\u00e8ve\n        from MyException import MyException\n        # code d'erreur\n        code = None\n        try:\n            # classe invalide\n            El\u00e8ve().fromdict({\"id\": 1, \"nom\": \"y\", \"pr\u00e9nom\": \"z\", \"classe\": \"t\"})\n        except MyException as ex:\n            print(f\"\\ncode erreur={ex.code}, message={ex}\")\n            code = ex.code\n        # v\u00e9rification\n        self.assertEqual(code, 43)\n\n    def test_code1b(self):\n        # imports\n        from Classe import Classe\n        from MyException import MyException\n        # code d'erreur\n        code = None\n        try:\n            # identifiant invalide\n            Classe().fromdict({\"id\": \"x\", \"nom\": \"y\"})\n        except MyException as ex:\n            print(f\"\\ncode erreur={ex.code}, message={ex}\")\n            code = ex.code\n        # v\u00e9rification\n        self.assertEqual(code, 1)\n\n    def test_code11(self):\n        # imports\n        from Classe import Classe\n        from MyException import MyException\n\n        # code d'erreur\n        code = None\n        try:\n            # nom invalide\n            Classe().fromdict({\"id\": 1, \"nom\": \"\"})\n        except MyException as ex:\n            code = ex.code\n        # v\u00e9rification\n        self.assertEqual(code, 11)\n\n    def test_code1c(self):\n        # imports\n        from Mati\u00e8re import Mati\u00e8re\n        from MyException import MyException\n\n        # code d'erreur\n        code = None\n        try:\n            # identifiant invalide\n            Mati\u00e8re().fromdict({\"id\": \"x\", \"nom\": \"y\", \"coefficient\": \"t\"})\n        except MyException as ex:\n            print(f\"\\ncode erreur={ex.code}, message={ex}\")\n            code = ex.code\n        # v\u00e9rification\n        self.assertEqual(code, 1)\n\n    def test_code21(self):\n        # imports\n        from Mati\u00e8re import Mati\u00e8re\n        from MyException import MyException\n        # code d'erreur\n        code = None\n        try:\n            # nom invalide\n            Mati\u00e8re().fromdict({\"id\": \"1\", \"nom\": \"\", \"coefficient\": \"t\"})\n        except MyException as ex:\n            print(f\"\\ncode erreur={ex.code}, message={ex}\")\n            code = ex.code\n        # v\u00e9rification\n        self.assertEqual(code, 21)\n\n    def test_code22(self):\n        # imports\n        from Mati\u00e8re import Mati\u00e8re\n        from MyException import MyException\n        # code d'erreur\n        code = None\n        try:\n            # coefficient invalide\n            Mati\u00e8re().fromdict({\"id\": 1, \"nom\": \"y\", \"coefficient\": \"t\"})\n        except MyException as ex:\n            print(f\"\\ncode erreur={ex.code}, message={ex}\")\n            code = ex.code\n        # v\u00e9rification\n        self.assertEqual(code, 22)\n\n    def test_code1d(self):\n        # imports\n        from Note import Note\n        from MyException import MyException\n        # code d'erreur\n        code = None\n        try:\n            # identifiant invalide\n            Note().fromdict({\"id\": \"x\", \"valeur\": \"x\", \"\u00e9l\u00e8ve\": \"y\", \"mati\u00e8re\": \"z\"})\n        except MyException as ex:\n            print(f\"\\ncode erreur={ex.code}, message={ex}\")\n            code = ex.code\n        # v\u00e9rification\n        self.assertEqual(code, 1)\n\n    def test_code31(self):\n        # imports\n        from Note import Note\n        from MyException import MyException\n\n        # code d'erreur\n        code = None\n        try:\n            # valeur invalide\n            Note().fromdict({\"id\": 1, \"valeur\": \"x\", \"\u00e9l\u00e8ve\": \"y\", \"mati\u00e8re\": \"z\"})\n        except MyException as ex:\n            print(f\"\\ncode erreur={ex.code}, message={ex}\")\n            code = ex.code\n        # v\u00e9rification\n        self.assertEqual(code, 31)\n\n    def test_code32(self):\n        # imports\n        from Note import Note\n        from MyException import MyException\n\n        # code d'erreur\n        code = None\n        try:\n            # \u00e9l\u00e8ve invalide\n            Note().fromdict({\"id\": 1, \"valeur\": 10, \"\u00e9l\u00e8ve\": \"y\", \"mati\u00e8re\": \"z\"})\n        except MyException as ex:\n            print(f\"\\ncode erreur={ex.code}, message={ex}\")\n            code = ex.code\n        # v\u00e9rification\n        self.assertEqual(code, 32)\n\n    def test_code33(self):\n        # imports\n        from El\u00e8ve import El\u00e8ve\n        from Note import Note\n        from Classe import Classe\n        from MyException import MyException\n\n        # code d'erreur\n        code = None\n        try:\n            # mati\u00e8re invalide\n            classe = Classe().fromdict({\"id\": 1, \"nom\": \"x\"})\n            \u00e9l\u00e8ve = El\u00e8ve().fromdict({\"id\": 1, \"nom\": \"a\", \"pr\u00e9nom\": \"b\", \"classe\": classe})\n            Note().fromdict({\"id\": 1, \"valeur\": 10, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve, \"mati\u00e8re\": \"z\"})\n        except MyException as ex:\n            print(f\"\\ncode erreur={ex.code}, message={ex}\")\n            code = ex.code\n        # v\u00e9rification\n        self.assertEqual(code, 33)\n\n    def test_exception(self):\n        # imports\n        from El\u00e8ve import El\u00e8ve\n        # le test doit lancer le type [MyException] pour r\u00e9ussir\n        from MyException import MyException\n        with self.assertRaises(MyException):\n            # le test\n            El\u00e8ve().fromdict({\"id\": \"x\", \"nom\": \"y\", \"pr\u00e9nom\": \"z\", \"classe\": \"t\"})\n\n\nif __name__ == '__main__':\n    unittest.main()\n</code></pre> <ul> <li>le script de test a pour but de tester les setters des classes\u00a0: v\u00e9rifier qu'on ne peut pas attribuer des valeurs incorrectes aux attributs des diff\u00e9rentes entit\u00e9s\u00a0;</li> <li>lignes 11-24\u00a0: on teste qu'on ne peut pas passer un identifiant invalide \u00e0 un \u00e9l\u00e8ve. Parce qu'on passe la valeur 'x', ligne 16, comme identifiant de l'\u00e9l\u00e8ve, on s'attend \u00e0 avoir une exception. On devrait donc passer dans les lignes 20-22\u00a0;</li> <li>ligne 21\u00a0: affichage du message d'erreur\u00a0;</li> <li>ligne 22\u00a0: on r\u00e9cup\u00e8re le code de l'erreur (cf paragraphe |L'entit\u00e9 MyException|)\u00a0;</li> <li>ligne 24\u00a0: on v\u00e9rifie (assert) que le code d'erreur est 1. Ici, on v\u00e9rifie deux choses\u00a0:</li> <li>qu'il y a bien eu erreur\u00a0;</li> <li>que le code d'erreur est 1\u00a0;</li> <li>ce processus est r\u00e9p\u00e9t\u00e9 avec les fonctions des lignes 24-213\u00a0;</li> <li>lignes 215-222\u00a0: on teste qu'une action l\u00e8ve une exception d'un certain type\u00a0;</li> <li>ligne 220\u00a0: on indique que le test est r\u00e9ussi s'il l\u00e8ve une exception de type [MyException]\u00a0; R\u00e9sultats</li> </ul> <p>On ex\u00e9cute le script de test\u00a0:</p> <p></p> <p>Les r\u00e9sultats obtenus sont les suivants\u00a0:</p> <pre><code>Testing started at 09:39 ...\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe \"C:\\Program Files\\JetBrains\\PyCharm Community Edition 2020.1.2\\plugins\\python-ce\\helpers\\pycharm\\_jb_unittest_runner.py\" --path C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/troiscouches/v01/tests/TestEntit\u00e9s.py\nLaunching unittests with arguments python -m unittest C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/troiscouches/v01/tests/TestEntit\u00e9s.py in C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\troiscouches\\v01\\tests\n\n\ncode erreur=1, message=MyException[1, L'identifiant d'une entit\u00e9 &lt;class 'El\u00e8ve.El\u00e8ve'&gt; doit \u00eatre un entier &gt;=0]\n\ncode erreur=1, message=MyException[1, L'identifiant d'une entit\u00e9 &lt;class 'Classe.Classe'&gt; doit \u00eatre un entier &gt;=0]\n\ncode erreur=1, message=MyException[1, L'identifiant d'une entit\u00e9 &lt;class 'Mati\u00e8re.Mati\u00e8re'&gt; doit \u00eatre un entier &gt;=0]\n\ncode erreur=1, message=MyException[1, L'identifiant d'une entit\u00e9 &lt;class 'Note.Note'&gt; doit \u00eatre un entier &gt;=0]\n\ncode erreur=21, message=MyException[21, Le nom de la mati\u00e8re 1 doit \u00eatre une cha\u00eene de caract\u00e8res non vide]\n\ncode erreur=22, message=MyException[22, Le coefficient de la mati\u00e8re y doit \u00eatre un r\u00e9el &gt;=0]\n\ncode erreur=31, message=MyException[31, L'attribut x de la note 1 doit \u00eatre un nombre dans l'intervalle [0,20]]\n\ncode erreur=32, message=MyException[32, L'attribut [y] de la note 1 doit \u00eatre de type El\u00e8ve ou dict ou json. Erreur : Expecting value: line 1 column 1 (char 0)]\n\ncode erreur=33, message=MyException[33, L'attribut [z] de la note 1 doit \u00eatre de type Mati\u00e8re ou dict ou json. Erreur : Expecting value: line 1 column 1 (char 0)]\n\ncode erreur=41, message=MyException[41, Le nom de l'\u00e9l\u00e8ve 1 doit \u00eatre une cha\u00eene de caract\u00e8res non vide]\n\ncode erreur=42, message=MyException[42, Le pr\u00e9nom de l'\u00e9l\u00e8ve 1 doit \u00eatre une cha\u00eene de caract\u00e8res non vide]\n\ncode erreur=43, message=MyException[43, L'attribut [t] de l'\u00e9l\u00e8ve 1 doit \u00eatre de type Classe ou dict ou json. Erreur : Expecting value: line 1 column 1 (char 0)]\n\n\nRan 14 tests in 0.040s\n\nOK\n\nProcess finished with exit code 0\n</code></pre> <p>Ici, tous les tests ont \u00e9t\u00e9 r\u00e9ussis</p>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#1424-la-couche-dao","title":"14.2.4. La couche [dao]","text":"<p>La couche [dao] impl\u00e9mente l\u2019interface [InterfaceDao] [1]. Celle-ci est impl\u00e9ment\u00e9e par la classe [Dao] (2). Le script [tests_dao] (3) teste les m\u00e9thodes de la couche [dao].</p>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#14241-interface-interfacedao","title":"14.2.4.1. Interface [InterfaceDao]","text":"<p>Une interface est un contrat pass\u00e9 entre code appelant et code appel\u00e9. C\u2019est le code appel\u00e9 qui offre l\u2019interface\u00a0:</p> <p></p> <ul> <li> <p>le code appelant [1] ne connait pas l\u2019impl\u00e9mentation du code appel\u00e9 [3]. Il ne conna\u00eet que la fa\u00e7on de l\u2019appeler. C\u2019est l\u2019interface [2] qui le lui indique. Celle-ci d\u00e9finit un certain nombre de m\u00e9thodes / fonctions \u00e0 utiliser pour interagir avec le code appel\u00e9. On appelle \u00e9galement API (Application Programming Interface) cette interface\u00a0; La couche [dao] offrira l'interface suivante\u00a0:</p> </li> <li> <p>[get_classes] rend la liste des classes du coll\u00e8ge\u00a0;</p> </li> <li>[get_mati\u00e8res] rend la liste des mati\u00e8res\u00a0enseign\u00e9es au coll\u00e8ge ;</li> <li>[get_\u00e9l\u00e8ves] rend la liste des \u00e9l\u00e8ves\u00a0du coll\u00e8ge ;</li> <li>[get_notes] rend la liste des notes de tous les \u00e9l\u00e8ves\u00a0;</li> <li>[get_notes_for_\u00e9l\u00e8ve_by_id] rend les notes d\u2019un \u00e9l\u00e8ve particulier\u00a0;</li> <li>[get_\u00e9l\u00e8ve_by_id] rend un \u00e9l\u00e8ve rep\u00e9r\u00e9 par son n\u00b0\u00a0; Le code appelant n'utilisera que ces m\u00e9thodes. Il n'a pas \u00e0 savoir comment elles sont impl\u00e9ment\u00e9es. Les donn\u00e9es peuvent alors provenir de diff\u00e9rentes sources (en dur, d'une base de donn\u00e9es, de fichiers texte\u2026) sans que cela impacte le code appelant. On appelle cela la programmation par interfaces.</li> </ul> <p>Python 3 a une notion qui s'approche de celle d'interface\u00a0: la classe abstraite. Nous allons l'utiliser. Nous allons regrouper les interfaces de cet exemple dans le dossier [interfaces].</p> <p>Nous d\u00e9finissons une classe abstraite [InterfaceDao] (InterfaceDao.py) pour la couche [dao]\u00a0:</p> <pre><code># imports\nfrom abc import ABC, abstractmethod\n\n# interface Dao\nfrom El\u00e8ve import El\u00e8ve\n\n\nclass InterfaceDao(ABC):\n    # liste des classes\n    @abstractmethod\n    def get_classes(self: object) -&gt; list:\n        pass\n\n    # liste des \u00e9l\u00e8ves\n    @abstractmethod\n    def get_\u00e9l\u00e8ves(self: object) -&gt; list:\n        pass\n\n    # liste des mati\u00e8res\n    @abstractmethod\n    def get_mati\u00e8res(self: object) -&gt; list:\n        pass\n\n    # liste des notes\n    @abstractmethod\n    def get_notes(self: object) -&gt; list:\n        pass\n\n    # liste des notes d'un \u00e9l\u00e8ve\n    @abstractmethod\n    def get_notes_for_\u00e9l\u00e8ve_by_id(self: object, \u00e9l\u00e8ve_id: int) -&gt; list:\n        pass\n\n    # chercher un \u00e9l\u00e8ve par son id\n    @abstractmethod\n    def get_\u00e9l\u00e8ve_by_id(self, \u00e9l\u00e8ve_id: int) -&gt; El\u00e8ve:\n        pass\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>ligne 2\u00a0: ABC=Abstract Base Class. On importe du module [abc], la classe ABC ainsi que le d\u00e9corateur [abstractmethod] utilis\u00e9 aux lignes 10, 15, 20, 25, 30 et 35\u00a0;</li> <li>ligne 8\u00a0: la classe abstraite s'appelle [InterfaceDao] et d\u00e9rive de la classe [ABC]\u00a0;</li> <li>les m\u00e9thodes de la classe abstraite sont d\u00e9cor\u00e9es avec le d\u00e9corateur [@abstractmethod] qui fait de la m\u00e9thode ainsi d\u00e9cor\u00e9e une m\u00e9thode abstraite\u00a0: son code n'est pas d\u00e9fini. N\u00e9anmoins, on y met du code\u00a0: l\u2019instruction [pass] qui ne fait rien\u00a0;</li> <li>la classe abstraite [InterfaceDao] ne peut \u00eatre instanci\u00e9e. Seules peuvent l'\u00eatre les classes d\u00e9riv\u00e9es de [InterfaceDao] ayant impl\u00e9ment\u00e9 toutes les m\u00e9thodes de [InterfaceDao]. Si donc on cr\u00e9e deux classes [Dao1] et [Dao2] d\u00e9rivant de la classe [InterfaceDao], elles impl\u00e9menteront toutes deux les m\u00e9thodes abstraites de [InterfaceDao]. On pourrait dire ainsi qu'elles impl\u00e9mentent l'interface [InterfaceDao]\u00a0;</li> <li>les langages impl\u00e9mentant \u00e0 la fois les interfaces et les classes abstraites donnent \u00e0 l'interface un r\u00f4le diff\u00e9rent de celui de la classe abstraite. Une interface n'a pas d'attributs et ne peut \u00eatre instanci\u00e9e. Une classe peut impl\u00e9menter une interface en d\u00e9finissant toutes les m\u00e9thodes de celle-ci\u00a0;</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#14242-implementation-dao","title":"14.2.4.2. Impl\u00e9mentation [Dao]","text":"<p>La classe [Dao] (dao.py) impl\u00e9mente l'interface [InterfaceDao] de la fa\u00e7on suivante\u00a0:</p> <pre><code># import des entit\u00e9s et des interfaces\nfrom Classe import Classe\nfrom El\u00e8ve import El\u00e8ve\nfrom InterfaceDao import InterfaceDao\nfrom Mati\u00e8re import Mati\u00e8re\nfrom MyException import MyException\nfrom Note import Note\n\n\n# couche [dao] impl\u00e9mente l'interface InterfaceDao\nclass Dao(InterfaceDao):\n    # constructeur\n    # on construit des listes en dur\n    def __init__(self):\n        # on instancie les classes\n        classe1 = Classe().fromdict({\"id\": 1, \"nom\": \"classe1\"})\n        classe2 = Classe().fromdict({\"id\": 2, \"nom\": \"classe2\"})\n        self.classes = [classe1, classe2]\n        # les mati\u00e8res\n        mati\u00e8re1 = Mati\u00e8re().fromdict({\"id\": 1, \"nom\": \"mati\u00e8re1\", \"coefficient\": 1})\n        mati\u00e8re2 = Mati\u00e8re().fromdict({\"id\": 2, \"nom\": \"mati\u00e8re2\", \"coefficient\": 2})\n        self.mati\u00e8res = [mati\u00e8re1, mati\u00e8re2]\n        # les \u00e9l\u00e8ves\n        \u00e9l\u00e8ve11 = El\u00e8ve().fromdict({\"id\": 11, \"nom\": \"nom1\", \"pr\u00e9nom\": \"pr\u00e9nom1\", \"classe\": classe1})\n        \u00e9l\u00e8ve21 = El\u00e8ve().fromdict({\"id\": 21, \"nom\": \"nom2\", \"pr\u00e9nom\": \"pr\u00e9nom2\", \"classe\": classe1})\n        \u00e9l\u00e8ve32 = El\u00e8ve().fromdict({\"id\": 32, \"nom\": \"nom3\", \"pr\u00e9nom\": \"pr\u00e9nom3\", \"classe\": classe2})\n        \u00e9l\u00e8ve42 = El\u00e8ve().fromdict({\"id\": 42, \"nom\": \"nom4\", \"pr\u00e9nom\": \"pr\u00e9nom4\", \"classe\": classe2})\n        self.\u00e9l\u00e8ves = [\u00e9l\u00e8ve11, \u00e9l\u00e8ve21, \u00e9l\u00e8ve32, \u00e9l\u00e8ve42]\n        # les notes des \u00e9l\u00e8ves dans les diff\u00e9rentes mati\u00e8res\n        note1 = Note().fromdict({\"id\": 1, \"valeur\": 10, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve11, \"mati\u00e8re\": mati\u00e8re1})\n        note2 = Note().fromdict({\"id\": 2, \"valeur\": 12, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve21, \"mati\u00e8re\": mati\u00e8re1})\n        note3 = Note().fromdict({\"id\": 3, \"valeur\": 14, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve32, \"mati\u00e8re\": mati\u00e8re1})\n        note4 = Note().fromdict({\"id\": 4, \"valeur\": 16, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve42, \"mati\u00e8re\": mati\u00e8re1})\n        note5 = Note().fromdict({\"id\": 5, \"valeur\": 6, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve11, \"mati\u00e8re\": mati\u00e8re2})\n        note6 = Note().fromdict({\"id\": 6, \"valeur\": 8, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve21, \"mati\u00e8re\": mati\u00e8re2})\n        note7 = Note().fromdict({\"id\": 7, \"valeur\": 10, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve32, \"mati\u00e8re\": mati\u00e8re2})\n        note8 = Note().fromdict({\"id\": 8, \"valeur\": 12, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve42, \"mati\u00e8re\": mati\u00e8re2})\n        self.notes = [note1, note2, note3, note4, note5, note6, note7, note8]\n\n    # -----------\n    # interface IDao\n    # -----------\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>lignes 1-7\u00a0: on importe les entit\u00e9s et l'interface [InterfaceDao]\u00a0;</li> <li>ligne 11\u00a0: la classe [Dao] d\u00e9rive de la classe abstraite [InterfaceDao]. Nous dirons qu'elle impl\u00e9mente l'interface [InterfaceDao]\u00a0;</li> <li>ligne 14\u00a0: le constructeur n'a pas de param\u00e8tres. Il construit en dur quatre listes\u00a0:</li> <li>lignes 15-18\u00a0: la liste des classes\u00a0;</li> <li>lignes 19-22\u00a0: la liste des mati\u00e8res\u00a0;</li> <li>lignes 23-28\u00a0: la liste des \u00e9l\u00e8ves\u00a0;</li> <li>lignes 29-38\u00a0: la liste des notes\u00a0;</li> <li>lignes 40-44\u00a0: impl\u00e9mentation des m\u00e9thodes de l\u2019interface [Interface Dao]. Ici, nous ne les d\u00e9finissons pas pour voir le message d\u2019erreur \u00e9mis par Python\u00a0; Un programme de test pourrait \u00eatre le suivant [tests-dao.py]\u00a0:</li> </ul> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# instanciation couche [dao]\nfrom Dao import Dao\n\ndaoImpl = Dao()\n\n# liste des classes\nfor classe in daoImpl.get_classes():\n    print(classe)\n\n# liste des mati\u00e8res\nfor mati\u00e8re in daoImpl.get_mati\u00e8res():\n    print(mati\u00e8re)\n\n# liste des classes\nfor \u00e9l\u00e8ve in daoImpl.get_\u00e9l\u00e8ves():\n    print(\u00e9l\u00e8ve)\n\n# liste des notes\nfor note in daoImpl.get_notes():\n    print(note)\n</code></pre> <p>Note\u00a0: le script [tests-dao.py] n'est pas un test [unittest] car il ne contient pas de m\u00e9thodes avec un nom commen\u00e7ant par [test_].</p> <p>Les commentaires se suffisent \u00e0 eux-m\u00eames. Les lignes 11-25 utilisent l'interface de la couche [dao]. Il n'y a pas l\u00e0 d'hypoth\u00e8ses sur l'impl\u00e9mentation r\u00e9elle de la couche. Ligne 9, on instancie la couche [dao].</p> <p>Les r\u00e9sultats de l'ex\u00e9cution de ce script sont les suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/troiscouches/v01/tests/tests_dao.py\nTraceback (most recent call last):\n  File \"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/troiscouches/v01/tests/tests_dao.py\", line 9, in &lt;module&gt;\n    daoImpl = Dao()\nTypeError: Can't instantiate abstract class Dao with abstract methods get_classes, get_mati\u00e8res, get_notes, get_notes_for_\u00e9l\u00e8ve_by_id, get_\u00e9l\u00e8ve_by_id, get_\u00e9l\u00e8ves\n\nProcess finished with exit code 1\n</code></pre> <p>On voit qu'une erreur se produit d\u00e8s l'instanciation de la classe [Dao] (ligne 3 ci-dessus). L'interpr\u00e9teur Python 3 nous dit qu'il ne peut instancier la classe, ceci parce que nous n'avons pas d\u00e9fini les m\u00e9thodes abstraites [get_classes, get_mati\u00e8res, get_notes, get_notes_for_\u00e9l\u00e8ve_by_id, get_\u00e9l\u00e8ve_by_id, get_\u00e9l\u00e8ves].</p> <p>Pycharm a \u00e9galement la notion de classe abstraite et nous propose de d\u00e9finir les m\u00e9hodes de celle-ci\u00a0:</p> <p></p> <ul> <li>en [1], cliquer droit sur le code\u00a0;</li> <li>en [2-3], choisir [Generate / Implement Methods] pour impl\u00e9menter les m\u00e9thodes manquantes de la classe [Dao]\u00a0;</li> <li>en [4], choisir les m\u00e9thodes \u00e0 impl\u00e9menter, ici toutes\u00a0; Ceci fait, la classe [Dao] est compl\u00e9t\u00e9e par PyCharm de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code>    # -----------\n    # interface IDao\n    # -----------\n\n    def get_classes(self: object) -&gt; list:\n        pass\n\n    def get_\u00e9l\u00e8ves(self: object) -&gt; list:\n        pass\n\n    def get_mati\u00e8res(self: object) -&gt; list:\n        pass\n\n    def get_notes(self: object) -&gt; list:\n        pass\n\n    def get_notes_for_\u00e9l\u00e8ve_by_id(self: object, \u00e9l\u00e8ve_id: int) -&gt; list:\n        pass\n\n    def get_\u00e9l\u00e8ve_by_id(self, \u00e9l\u00e8ve_id: int) -&gt; El\u00e8ve:\n        pass\n</code></pre> <p>Nous compl\u00e9tons la classe [Dao] de la fa\u00e7on suivante\u00a0:</p> <pre><code>    # -----------\n    # interface IDao\n    # -----------\n\n    # liste des classes\n    def get_classes(self) -&gt; list:\n        return self.classes\n\n    # liste des mati\u00e8res\n    def get_mati\u00e8res(self) -&gt; list:\n        return self.mati\u00e8res\n\n    # liste des \u00e9l\u00e8ves\n    def get_\u00e9l\u00e8ves(self) -&gt; list:\n        return self.\u00e9l\u00e8ves\n\n    # liste des notes\n    def get_notes(self) -&gt; list:\n        return self.notes\n\n    def get_notes_for_\u00e9l\u00e8ve_by_id(self, \u00e9l\u00e8ve_id: int) -&gt; dict:\n        # on recherche l'\u00e9l\u00e8ve\n        \u00e9l\u00e8ve = self.get_\u00e9l\u00e8ve_by_id(\u00e9l\u00e8ve_id)\n        # on r\u00e9cup\u00e8re ses notes\n        notes = list(filter(lambda n: n.\u00e9l\u00e8ve.id == \u00e9l\u00e8ve_id, self.get_notes()))\n        # on rend le r\u00e9sultat\n        return {\"\u00e9l\u00e8ve\": \u00e9l\u00e8ve, \"notes\": notes}\n\n    def get_\u00e9l\u00e8ve_by_id(self, \u00e9l\u00e8ve_id: int) -&gt; El\u00e8ve:\n        # on filtre les \u00e9l\u00e8ves\n        \u00e9l\u00e8ves = list(filter(lambda e: e.id == \u00e9l\u00e8ve_id, self.get_\u00e9l\u00e8ves()))\n        # trouv\u00e9 ?\n        if not \u00e9l\u00e8ves:\n            raise MyException(10, f\"L'\u00e9l\u00e8ve d'identifiant {\u00e9l\u00e8ve_id} n'existe pas\")\n        # r\u00e9sultat\n        return \u00e9l\u00e8ves[0]\n</code></pre> <ul> <li>les lignes 5-19 ne posent pas de difficult\u00e9s\u00a0;</li> <li>lignes 29-36\u00a0: la m\u00e9thode qui rend l\u2019\u00e9l\u00e8ve dont on passe le num\u00e9ro. Si l\u2019\u00e9l\u00e8ve n\u2019existe pas, une exception est lev\u00e9e\u00a0;</li> <li>ligne 31\u00a0: la fonction [filter] permet de filtrer une liste\u00a0:</li> <li>le 1er param\u00e8tre est le crit\u00e8re de filtrage\u00a0;</li> <li>le second param\u00e8tre est la liste \u00e0 filtrer, ici la liste des \u00e9l\u00e8ves\u00a0; </li> <li>ligne 31\u00a0: le crit\u00e8re de filtrage de la liste est impl\u00e9ment\u00e9 \u00e0 l\u2019aide d\u2019une fonction [f(e\u00a0:El\u00e8ve)-&gt;bool]. Celle-ci est appliqu\u00e9e \u00e0 chacun des \u00e9l\u00e9ments de la liste \u00e0 filtrer. Si l\u2019\u00e9l\u00e9ment satisfait le crit\u00e8re de filtrage, il est retenu dans la liste filtr\u00e9e, sinon il en est exclu. On peut ici soit\u00a0:</li> <li>donner le nom de la fonction f et impl\u00e9menter celle-ci ailleurs. L\u2019appel \u00e0 la fonction [filter] devient alors [filter(f,self.get_\u00e9l\u00e8ves()]\u00a0;</li> <li>donner la d\u00e9finition de la fonction f. L\u2019appel \u00e0 la fonction [filter] devient alors [filter(f(e\u00a0:El\u00e8ve){\u2026},self.get_\u00e9l\u00e8ves()] o\u00f9 [e] repr\u00e9sente un \u00e9l\u00e9ment de la liste filtr\u00e9e, \u00e7-\u00e0-d un \u00e9l\u00e8ve. C\u2019est ce qui a \u00e9t\u00e9 fait ici. La d\u00e9finition de la fonction f serait ici [f(e\u00a0:El\u00e8ve){return e.id==\u00e9l\u00e8ve_id)]\u00a0: un \u00e9l\u00e8ve n\u2019est retenu que si non n\u00b0 [id] est \u00e9gal \u00e0 celui cherch\u00e9. Une telle fonction peut \u00eatre remplac\u00e9e par une fonction dite lambda\u00a0: [lambda e: e.id == \u00e9l\u00e8ve_id]\u00a0: </li> <li>e\u00a0: repr\u00e9sente le param\u00e8tre de la fonction f, ici un \u00e9l\u00e8ve. On peut utiliser le nom que l\u2019on veut\u00a0;</li> <li>e.id==\u00e9l\u00e8ve_id est le crit\u00e8re de filtrage\u00a0: un \u00e9l\u00e8ve [e] n\u2019est retenu que si son n\u00b0 [id] correspond \u00e0 celui qui est cherch\u00e9\u00a0;</li> <li>ligne 31\u00a0: la fonction [filter] rend la liste filtr\u00e9e sous un type qui n\u2019est pas le type [list] mais qui supporte d\u2019\u00eatre transform\u00e9 en type [list]. C\u2019est ce que nous faisons ici avec l\u2019expression [list(liste filtr\u00e9e)]\u00a0;</li> <li>lignes 33-34\u00a0: si la liste filtr\u00e9e est vide c\u2019est que l\u2019\u00e9l\u00e8ve cherch\u00e9 n\u2019existe pas. On l\u00e8ve alors une exception\u00a0;</li> <li>ligne 36\u00a0: si on arrive ici, c\u2019est qu\u2019il n\u2019y a pas eu d\u2019exception. On sait alors qu\u2019on a r\u00e9cup\u00e9r\u00e9 une liste \u00e0 1 \u00e9l\u00e9ment (il n\u2019y a pas deux \u00e9l\u00e8ves ayant le m\u00eame n\u00b0 [id]). On rend donc le 1er \u00e9l\u00e9ment de la liste\u00a0;</li> <li>lignes 21-27\u00a0: la m\u00e9thode [get_notes_for_\u00e9l\u00e8ve_by_id] doit rendre les notes de l\u2019\u00e9l\u00e8ve dont on lui passe le n\u00b0 [id]\u00a0;</li> <li>lignes 22-23\u00a0: on commence par rechercher l\u2019\u00e9l\u00e8ve de n\u00b0 [\u00e9l\u00e8ve_id] \u00e0 l\u2019aide de la m\u00e9thode [get_\u00e9l\u00e8ve_by_id] que l\u2019on vient de commenter. Il peut se produire une exception si l\u2019\u00e9l\u00e8ve cherch\u00e9 n\u2019existe pas. Comme il n\u2019y a pas de try / catch autour de l\u2019instruction de la ligne 23, l\u2019exception remontera au code appelant. C\u2019est ce qui est d\u00e9sir\u00e9\u00a0;</li> <li>lignes 24-25\u00a0: une fois l\u2019\u00e9l\u00e8ve r\u00e9cup\u00e9r\u00e9, on r\u00e9cup\u00e8re toutes ses notes. On le fait de nouveau avec un filtre\u00a0:</li> <li>le filtre est [filter(crit\u00e8re, self_getnotes()]. La liste \u00e0 filtrer est donc la liste de toutes les notes de tous les \u00e9l\u00e8ves du coll\u00e8ge\u00a0;</li> <li>le crit\u00e8re de filtrage est exprim\u00e9 \u00e0 l\u2019aide d\u2019une fonction [lambda]\u00a0: lambda n: n.\u00e9l\u00e8ve.id == \u00e9l\u00e8ve_id. Le param\u00e8tre n est un \u00e9l\u00e9ment de la liste \u00e0 filtrer, donc une note. Le type [Note] a une propri\u00e9t\u00e9 [\u00e9l\u00e8ve] qui repr\u00e9sente l\u2019\u00e9l\u00e8ve propri\u00e9taire de la note. Il faut alors que [n.\u00e9l\u00e8ve.id] qui repr\u00e9sente le n\u00b0 de cet \u00e9l\u00e8ve soit \u00e9gal au num\u00e9ro de l\u2019\u00e9l\u00e8ve cherch\u00e9\u00a0; Puis nous ex\u00e9cutons le script [tests-dao.py].</li> </ul> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# instanciation couche [dao]\nfrom Dao import Dao\n\ndaoImpl = Dao()\n\n# liste des classes\nfor classe in daoImpl.get_classes():\n    print(classe)\n\n# liste des mati\u00e8res\nfor mati\u00e8re in daoImpl.get_mati\u00e8res():\n    print(mati\u00e8re)\n\n# liste des classes\nfor \u00e9l\u00e8ve in daoImpl.get_\u00e9l\u00e8ves():\n    print(\u00e9l\u00e8ve)\n\n# liste des notes\nfor note in daoImpl.get_notes():\n    print(note)\n\n# un \u00e9l\u00e8ve particulier\nprint(daoImpl.get_\u00e9l\u00e8ve_by_id(11))\n\n# la liste de ses notes\ndict1 = daoImpl.get_notes_for_\u00e9l\u00e8ve_by_id(11)\nprint(f\"\u00e9l\u00e8ve n\u00b0 11 = {dict1['\u00e9l\u00e8ve']}\")\nfor note in dict1[\"notes\"]:\n    print(f\"note de l'\u00e9l\u00e8ve n\u00b0 11 = {note}\")\n</code></pre> <p>Nous obtenons alors les r\u00e9sultats suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/troiscouches/v01/tests/tests_dao.py\n{\"id\": 1, \"nom\": \"classe1\"}\n{\"id\": 2, \"nom\": \"classe2\"}\n{\"id\": 1, \"nom\": \"mati\u00e8re1\", \"coefficient\": 1}\n{\"id\": 2, \"nom\": \"mati\u00e8re2\", \"coefficient\": 2}\n{\"id\": 11, \"nom\": \"nom1\", \"pr\u00e9nom\": \"pr\u00e9nom1\", \"classe\": {\"id\": 1, \"nom\": \"classe1\"}}\n{\"id\": 21, \"nom\": \"nom2\", \"pr\u00e9nom\": \"pr\u00e9nom2\", \"classe\": {\"id\": 1, \"nom\": \"classe1\"}}\n{\"id\": 32, \"nom\": \"nom3\", \"pr\u00e9nom\": \"pr\u00e9nom3\", \"classe\": {\"id\": 2, \"nom\": \"classe2\"}}\n{\"id\": 42, \"nom\": \"nom4\", \"pr\u00e9nom\": \"pr\u00e9nom4\", \"classe\": {\"id\": 2, \"nom\": \"classe2\"}}\n{\"id\": 1, \"valeur\": 10, \"\u00e9l\u00e8ve\": {\"id\": 11, \"nom\": \"nom1\", \"pr\u00e9nom\": \"pr\u00e9nom1\", \"classe\": {\"id\": 1, \"nom\": \"classe1\"}}, \"mati\u00e8re\": {\"id\": 1, \"nom\": \"mati\u00e8re1\", \"coefficient\": 1}}\n{\"id\": 2, \"valeur\": 12, \"\u00e9l\u00e8ve\": {\"id\": 21, \"nom\": \"nom2\", \"pr\u00e9nom\": \"pr\u00e9nom2\", \"classe\": {\"id\": 1, \"nom\": \"classe1\"}}, \"mati\u00e8re\": {\"id\": 1, \"nom\": \"mati\u00e8re1\", \"coefficient\": 1}}\n{\"id\": 3, \"valeur\": 14, \"\u00e9l\u00e8ve\": {\"id\": 32, \"nom\": \"nom3\", \"pr\u00e9nom\": \"pr\u00e9nom3\", \"classe\": {\"id\": 2, \"nom\": \"classe2\"}}, \"mati\u00e8re\": {\"id\": 1, \"nom\": \"mati\u00e8re1\", \"coefficient\": 1}}\n{\"id\": 4, \"valeur\": 16, \"\u00e9l\u00e8ve\": {\"id\": 42, \"nom\": \"nom4\", \"pr\u00e9nom\": \"pr\u00e9nom4\", \"classe\": {\"id\": 2, \"nom\": \"classe2\"}}, \"mati\u00e8re\": {\"id\": 1, \"nom\": \"mati\u00e8re1\", \"coefficient\": 1}}\n{\"id\": 5, \"valeur\": 6, \"\u00e9l\u00e8ve\": {\"id\": 11, \"nom\": \"nom1\", \"pr\u00e9nom\": \"pr\u00e9nom1\", \"classe\": {\"id\": 1, \"nom\": \"classe1\"}}, \"mati\u00e8re\": {\"id\": 2, \"nom\": \"mati\u00e8re2\", \"coefficient\": 2}}\n{\"id\": 6, \"valeur\": 8, \"\u00e9l\u00e8ve\": {\"id\": 21, \"nom\": \"nom2\", \"pr\u00e9nom\": \"pr\u00e9nom2\", \"classe\": {\"id\": 1, \"nom\": \"classe1\"}}, \"mati\u00e8re\": {\"id\": 2, \"nom\": \"mati\u00e8re2\", \"coefficient\": 2}}\n{\"id\": 7, \"valeur\": 10, \"\u00e9l\u00e8ve\": {\"id\": 32, \"nom\": \"nom3\", \"pr\u00e9nom\": \"pr\u00e9nom3\", \"classe\": {\"id\": 2, \"nom\": \"classe2\"}}, \"mati\u00e8re\": {\"id\": 2, \"nom\": \"mati\u00e8re2\", \"coefficient\": 2}}\n{\"id\": 8, \"valeur\": 12, \"\u00e9l\u00e8ve\": {\"id\": 42, \"nom\": \"nom4\", \"pr\u00e9nom\": \"pr\u00e9nom4\", \"classe\": {\"id\": 2, \"nom\": \"classe2\"}}, \"mati\u00e8re\": {\"id\": 2, \"nom\": \"mati\u00e8re2\", \"coefficient\": 2}}\n{\"id\": 11, \"nom\": \"nom1\", \"pr\u00e9nom\": \"pr\u00e9nom1\", \"classe\": {\"id\": 1, \"nom\": \"classe1\"}}\n\u00e9l\u00e8ve n\u00b0 11 = {\"id\": 11, \"nom\": \"nom1\", \"pr\u00e9nom\": \"pr\u00e9nom1\", \"classe\": {\"id\": 1, \"nom\": \"classe1\"}}\nnote de l'\u00e9l\u00e8ve n\u00b0 11 = {\"id\": 1, \"valeur\": 10, \"\u00e9l\u00e8ve\": {\"id\": 11, \"nom\": \"nom1\", \"pr\u00e9nom\": \"pr\u00e9nom1\", \"classe\": {\"id\": 1, \"nom\": \"classe1\"}}, \"mati\u00e8re\": {\"id\": 1, \"nom\": \"mati\u00e8re1\", \"coefficient\": 1}}\nnote de l'\u00e9l\u00e8ve n\u00b0 11 = {\"id\": 5, \"valeur\": 6, \"\u00e9l\u00e8ve\": {\"id\": 11, \"nom\": \"nom1\", \"pr\u00e9nom\": \"pr\u00e9nom1\", \"classe\": {\"id\": 1, \"nom\": \"classe1\"}}, \"mati\u00e8re\": {\"id\": 2, \"nom\": \"mati\u00e8re2\", \"coefficient\": 2}}\n\nProcess finished with exit code 0\n</code></pre> <p>On pourra remarquer que lorsqu\u2019on affiche une note (pour les autres objets, c\u2019est similaire), on a \u00e9galement :</p> <ul> <li>l\u2019\u00e9l\u00e8ve propri\u00e9taire de la note ;</li> <li>la mati\u00e8re r\u00e9f\u00e9renc\u00e9e par la note\u00a0; C\u2019est la fonction [BaseEntity.asdict] qui produit ce r\u00e9sultat (cf. paragraphe lien).</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#1425-la-couche-metier","title":"14.2.5. La couche [m\u00e9tier]","text":"<ul> <li>[InterfaceM\u00e9tier] est l\u2019interface de la couche [m\u00e9tier]\u00a0;</li> <li>[M\u00e9tier] est la classe d\u2019impl\u00e9mentation de la couche [m\u00e9tier]\u00a0;</li> <li>[Testm\u00e9tier] est une classe [UnitTest] de test de la classe [M\u00e9tier]\u00a0;</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#14251-interface-interfacemetier","title":"14.2.5.1. Interface [InterfaceM\u00e9tier]","text":"<p>La couche [m\u00e9tier] impl\u00e9mentera l'interface [InterfaceM\u00e9tier] suivante (InterfaceM\u00e9tier.py)\u00a0:</p> <pre><code># imports\nfrom abc import ABC, abstractmethod\n\nfrom StatsForEl\u00e8ve import StatsForEl\u00e8ve\n\n\n# interface M\u00e9tier\nclass InterfaceM\u00e9tier(ABC):\n    # calcul de statistiques pour un \u00e9l\u00e8ve\n    @abstractmethod\n    def get_stats_for_\u00e9l\u00e8ve(self, idEl\u00e8ve: int) -&gt; StatsForEl\u00e8ve:\n        pass\n</code></pre> <ul> <li>[get_stats_for_\u00e9l\u00e8ve] rend les notes de l'\u00e9l\u00e8ve n\u00b0 idEl\u00e8ve ainsi que des informations sur celles-ci\u00a0: moyenne pond\u00e9r\u00e9e, note la plus basse, note la plus haute. Ces informations sont encapsul\u00e9es dans un objet de type [StatsForEl\u00e8ve]\u00a0;</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#14252-lentite-statsforeleve","title":"14.2.5.2. L'entit\u00e9 [StatsForEl\u00e8ve]","text":"<p>Le type [StatsForEl\u00e8ve] (StatsForEl\u00e8ve.py) qui encapsule les statistiques (notes, min, max, moyenne pond\u00e9r\u00e9e) d'un \u00e9l\u00e8ve est le suivant\u00a0:</p> <pre><code># imports\nfrom BaseEntity import BaseEntity\n\n\n# statistiques d'un \u00e9l\u00e8ve particulier\n\n\nclass StatsForEl\u00e8ve(BaseEntity):\n    # attributs exclus de l'\u00e9tat de la classe\n    excluded_keys = []\n\n    # propri\u00e9t\u00e9s de la classe\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        # id : identifiant de la note\n        # \u00e9l\u00e8ve : l'\u00e9l\u00e8ve concern\u00e9\n        # notes : ses notes\n        # moyennePond\u00e9r\u00e9e : sa moyenne pond\u00e9r\u00e9e par les coefficients des mati\u00e8res\n        # min : sa note minimale\n        # max : sa note maximale\n\n        return BaseEntity.get_allowed_keys() + [\"\u00e9l\u00e8ve\", \"notes\", \"moyenne_pond\u00e9r\u00e9e\", \"min\", \"max\"]\n\n    # toString\n    def __str__(self) -&gt; str:\n        # cas de l'\u00e9l\u00e8ve sans notes\n        if len(self.notes) == 0:\n            return f\"El\u00e8ve={self.\u00e9l\u00e8ve}, notes=[]\"\n        # cas de l'\u00e9l\u00e8ve avec notes\n        str = \"\"\n        for note in self.notes:\n            str += f\"{note.valeur} \"\n        return f\"El\u00e8ve={self.\u00e9l\u00e8ve}, notes=[{str.strip()}], max={self.max}, min={self.min}, \" \\\n               f\"moyenne pond\u00e9r\u00e9e={self.moyenne_pond\u00e9r\u00e9e:4.2f}\"\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>ligne 8\u00a0: la classe [StatsForEl\u00e8ve] d\u00e9rive de la classe [BaseEntity]\u00a0;</li> <li>lignes 13-22\u00a0: les propri\u00e9t\u00e9s de la classe\u00a0;</li> <li>un identifiant [id] provenant de [BaseEntity]\u00a0;</li> <li>l'\u00e9l\u00e8ve [\u00e9l\u00e8ve] dont on encapsile les statistiques\u00a0;</li> <li>ses notes\u00a0[notes] ;</li> <li>sa moyenne pond\u00e9r\u00e9e [moyenne_pond\u00e9r\u00e9e]\u00a0;</li> <li>sa note minimale [min]\u00a0;</li> <li>sa note maximale [max]\u00a0;</li> <li>on ne d\u00e9finit pas de getters / setters pour ces attributs. On part du principe que c'est la couche [m\u00e9tier] qui cr\u00e9e des objets de ce type et que celle-ci ne cr\u00e9e pas d'objets invalides\u00a0;</li> <li>lignes 23-33\u00a0: la fonction [str] rend une cha\u00eene de caract\u00e8res reprenant les propri\u00e9t\u00e9s de l\u2019objet\u00a0;</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#14253-limplementation-metier","title":"14.2.5.3. L'impl\u00e9mentation [M\u00e9tier]","text":"<p>L'impl\u00e9mentation [M\u00e9tier] (Metier.py) de l'interface [InterfaceM\u00e9tier] sera la suivante\u00a0:</p> <pre><code># imports\nfrom InterfaceDao import InterfaceDao\nfrom InterfaceM\u00e9tier import InterfaceM\u00e9tier\nfrom StatsForEl\u00e8ve import StatsForEl\u00e8ve\n\n\nclass M\u00e9tier(InterfaceM\u00e9tier):\n\n    # constructeur\n    def __init__(self, dao: InterfaceDao):\n        # on m\u00e9morise le param\u00e8tre\n        self.__dao = dao\n\n    # -----------\n    # interface\n    # -----------\n\n    # les indicateurs sur les notes d'un \u00e9l\u00e8ve particulier\n    def get_stats_for_\u00e9l\u00e8ve(self, id_\u00e9l\u00e8ve: int) -&gt; StatsForEl\u00e8ve:\n        # Stats pour l'\u00e9l\u00e8ve de n\u00b0 idEleve\n        # id_\u00e9l\u00e8ve : n\u00b0 de l'\u00e9l\u00e8ve\n\n        # on r\u00e9cup\u00e8re ses notes avec la couche [dao]\n        notes_\u00e9l\u00e8ve = self.__dao.get_notes_for_\u00e9l\u00e8ve_by_id(id_\u00e9l\u00e8ve)\n        \u00e9l\u00e8ve = notes_\u00e9l\u00e8ve[\"\u00e9l\u00e8ve\"]\n        notes = notes_\u00e9l\u00e8ve[\"notes\"]\n\n        # on s'arr\u00eate s'il n'y a pas de notes\n        if len(notes) == 0:\n            # on rend le r\u00e9sultat\n            return StatsForEl\u00e8ve().fromdict({\"\u00e9l\u00e8ve\": \u00e9l\u00e8ve, \"notes\": []})\n\n        # exploitation des notes de l'\u00e9l\u00e8ve\n        somme_pond\u00e9r\u00e9e = 0\n        somme_coeff = 0\n        max = -1\n        min = 21\n        for note in notes:\n            # valeur de la note\n            valeur = note.valeur\n            # coefficient de la mati\u00e8re\n            coeff = note.mati\u00e8re.coefficient\n            # somme des coefficients\n            somme_coeff += coeff\n            # somme pond\u00e9r\u00e9e\n            somme_pond\u00e9r\u00e9e += valeur * coeff\n            # recherche du min\n            if valeur &lt; min:\n                min = valeur\n            # recherche du max\n            if valeur &gt; max:\n                max = valeur\n        # calcul des indicateurs manquants\n        moyenne_pond\u00e9r\u00e9e = float(somme_pond\u00e9r\u00e9e) / somme_coeff\n\n        # on rend le r\u00e9sultat sous la forme d'un type [StatsForEl\u00e8ve]\n        return StatsForEl\u00e8ve(). \\\n            fromdict({\"\u00e9l\u00e8ve\": \u00e9l\u00e8ve, \"notes\": notes,\n                      \"moyenne_pond\u00e9r\u00e9e\": moyenne_pond\u00e9r\u00e9e,\n                      \"min\": min, \"max\": max})\n</code></pre> <p>Notes</p> <ul> <li>ligne 7\u00a0: la classe [M\u00e9tier] d\u00e9rive de la classe [InterfaceM\u00e9tier]. On a pris l\u2019habitude de dire qu\u2019elle impl\u00e9mente l\u2019interface [InterfaceM\u00e9tier]\u00a0;</li> <li>lignes 9-12\u00a0: le constructeur re\u00e7oit pour seul param\u00e8tre une r\u00e9f\u00e9rence sur la couche [dao]. Ligne 10, on notera qu\u2019on a donn\u00e9 le type [InterfaceDao] au param\u00e8tre [dao]. On n\u2019attend pas une impl\u00e9mentation pr\u00e9cise mais simplement une impl\u00e9mentation restectant l\u2019interface [InterfaceDao]. Ici, \u00e7a n\u2019a pas d\u2019importance puisque Python ne va pas tenir compte de ce type mais c\u2019est une bonne habitude de travailler avec des interfaces plut\u00f4t qu\u2019avec des impl\u00e9mentations pr\u00e9cises. Le code est alors plus facilement modifiable\u00a0;</li> <li>lignes 19-60\u00a0: impl\u00e9mentation de la m\u00e9thode [get_stats_for_\u00e9l\u00e8ve]\u00a0;</li> <li>ligne 19\u00a0: la m\u00e9thode re\u00e7oit un unique param\u00e8tre, le n\u00b0 [idEl\u00e8ve] de l\u2019\u00e9l\u00e8ve dont on veut les statistiques\u00a0;</li> <li>ligne 24\u00a0: on demande \u00e0 la couche [dao], les notes de l\u2019\u00e9l\u00e8ve. Cette demande d\u00e9bouche sur une exception si l\u2019\u00e9l\u00e8ve n\u2019existe pas. Celle-ci n\u2019est pas g\u00e9r\u00e9e (absence de try / catch) et remonte donc au code appelant\u00a0;</li> <li>ligne 25\u00a0: on arrive ici s\u2019il n\u2019y a pas eu exception. [notes_\u00e9l\u00e8ve] est alors un dictionnaire \u00e0 deux cl\u00e9s [\u00e9l\u00e8ve, note]\u00a0:</li> <li>ligne 25\u00a0: on r\u00e9cup\u00e8re les informations sur l\u2019\u00e9l\u00e8ve (son nom, sa classe, \u2026)\u00a0;</li> <li>ligne 26\u00a0: on r\u00e9cup\u00e8re ses notes\u00a0;</li> <li>lignes 28-31\u00a0: on regarde si l\u2019\u00e9l\u00e8ve a des notes. S\u2019il n\u2019en a pas, il n\u2019y a pas de statistiques \u00e0 calculer\u00a0;</li> <li>ligne 31\u00a0: on rend un objet [StatsForEl\u00e8ve] construit \u00e0 partir d\u2019un dictionnaire avec la m\u00e9thode [BaseEntity.fromdict]\u00a0;</li> <li>lignes 33-54\u00a0: on exploite les notes de l\u2019\u00e9l\u00e8ve pour calculer les statistiques demand\u00e9es. Les commentaires du code devraient suffire \u00e0 sa compr\u00e9hension\u00a0;</li> <li>lignes 56-60\u00a0: on rend un objet [StatsForEl\u00e8ve] construit \u00e0 partir d\u2019un dictionnaire avec la m\u00e9thode [BaseEntity.fromdict]\u00a0;</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#14254-test-de-la-couche-metier","title":"14.2.5.4. Test de la couche [m\u00e9tier]","text":"<p>Un script [UnitTest] de la couche [m\u00e9tier] pourrait \u00eatre le suivant (TestM\u00e9tier.py)\u00a0:</p> <pre><code># imports\nimport unittest\n\n\nclass Testm\u00e9tier(unittest.TestCase):\n    def setUp(self):\n        # on configure l'application\n        import config\n        config.configure()\n\n    def test_statsForEleve11(self):\n        # imports\n        from Dao import Dao\n        from M\u00e9tier import M\u00e9tier\n        # on teste les indicateurs de l'\u00e9l\u00e8ve 11\n        dao = Dao()\n        stats_for_\u00e9l\u00e8ve = M\u00e9tier(dao).get_stats_for_\u00e9l\u00e8ve(11)\n        # affichage\n        print(f\"\\nstats={stats_for_\u00e9l\u00e8ve}\")\n        # v\u00e9rifications\n        self.assertEqual(stats_for_\u00e9l\u00e8ve.min, 6)\n        self.assertEqual(stats_for_\u00e9l\u00e8ve.max, 10)\n        self.assertAlmostEqual(stats_for_\u00e9l\u00e8ve.moyenne_pond\u00e9r\u00e9e, 7.333, delta=1e-3)\n\n\nif __name__ == '__main__':\n    unittest.main()\n</code></pre> <p>Notes</p> <ul> <li>lignes 6-9\u00a0: la fonction [setUp] est ici utilis\u00e9e pour configurer le Python Path du test\u00a0;</li> <li>ligne 16\u00a0: on instancie la couche [dao]\u00a0;</li> <li>ligne 17\u00a0: on instancie la couche [m\u00e9tier]\u00a0et on utilise sa m\u00e9thode [get_stats_for_\u00e9l\u00e8ve] pour calculer les statistiques de l\u2019\u00e9l\u00e8ve n\u00b0 11\u00a0;</li> <li>ligne 19\u00a0: on affiche le r\u00e9sultat [StatsForEl\u00e8ve] obtenu. Comme [StatsForEl\u00e8ve] d\u00e9rive de [BaseEntity], c\u2019est la cha\u00eene jSON de [StatsForEl\u00e8ve] qui est ici affich\u00e9e\u00a0;</li> <li>ligne 21\u00a0: on v\u00e9rifie la note minimale de l\u2019\u00e9l\u00e8ve\u00a0;</li> <li>ligne 22\u00a0: on v\u00e9rifie sa note maximale\u00a0;</li> <li>ligne 23\u00a0: on teste que la moyenne pond\u00e9r\u00e9e vaut 7,333 \u00e0 10-3 pr\u00e8s. En g\u00e9n\u00e9ral, il n'est pas possible de comparer les nombres r\u00e9els de fa\u00e7on exacte car de fa\u00e7on interne, ils n'ont le plus souvent qu'une repr\u00e9sentation approch\u00e9e\u00a0;  Les r\u00e9sultats du test sont les suivants\u00a0:</li> </ul> <pre><code>Testing started at 18:17 ...\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe \"C:\\Program Files\\JetBrains\\PyCharm Community Edition 2020.1.2\\plugins\\python-ce\\helpers\\pycharm\\_jb_unittest_runner.py\" --path C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/troiscouches/v01/tests/TestM\u00e9tier.py\nLaunching unittests with arguments python -m unittest C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/troiscouches/v01/tests/TestM\u00e9tier.py in C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\troiscouches\\v01\\tests\n\n\n\nRan 1 test in 0.015s\n\nOK\n\nstats=El\u00e8ve={\"id\": 11, \"nom\": \"nom1\", \"pr\u00e9nom\": \"pr\u00e9nom1\", \"classe\": {\"id\": 1, \"nom\": \"classe1\"}}, notes=[10 6], max=10, min=6, moyenne pond\u00e9r\u00e9e=7.33\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#1426-la-couche-ui","title":"14.2.6. La couche [ui]","text":"<ul> <li>en [1], l\u2019interface de la couche [ui]\u00a0;</li> <li>en [2], l\u2019impl\u00e9mentation de cette interface\u00a0;</li> <li>en [3], le script principal de l\u2019application\u00a0;</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#14261-interface-interfaceui","title":"14.2.6.1. Interface [InterfaceUi]","text":"<p>L'interface de la couche [UI] sera la suivante\u00a0:</p> <pre><code># imports\nfrom abc import ABC, abstractmethod\n\n\n# interface UI\nclass InterfaceUi(ABC):\n    # ex\u00e9cution de la couche UI\n    @abstractmethod\n    def run(self: object):\n        pass\n</code></pre> <p>Notes</p> <ul> <li>lignes 9-10\u00a0: la couche [UI] n'aura qu'une m\u00e9thode, [run]\u00a0;</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#14262-limplementation-console","title":"14.2.6.2. L'impl\u00e9mentation [Console]","text":"<p>La couche [console] est impl\u00e9ment\u00e9e par le script [Console.py] suivant\u00a0:</p> <pre><code># imports des couches\n\nfrom InterfaceDao import InterfaceDao\nfrom InterfaceM\u00e9tier import InterfaceM\u00e9tier\nfrom InterfaceUi import InterfaceUi\n\n# autres d\u00e9pendances\nfrom MyException import MyException\n\n\nclass Console(InterfaceUi):\n    # constructeur\n    def __init__(self: object, m\u00e9tier: InterfaceM\u00e9tier):\n        # m\u00e9tier : la couche [m\u00e9tier]\n\n        # on m\u00e9morise les attributs\n        self.m\u00e9tier = m\u00e9tier\n\n\n        # -----------\n        # interface\n        # -----------\n\n    def run(self):\n        # dialogue utilisateur\n        fini = False\n        while not fini:\n            # question / r\u00e9ponse\n            r\u00e9ponse = input(\"Num\u00e9ro de l'\u00e9l\u00e8ve (&gt;=1 et * pour arr\u00eater) : \").strip()\n            # fini ?\n            if r\u00e9ponse == \"*\":\n                break\n            # a-t-on une saisie correcte ?\n            ok = False\n            try:\n                id_\u00e9l\u00e8ve = int(r\u00e9ponse, 10)\n                ok = id_\u00e9l\u00e8ve &gt;= 1\n            except ValueError as erreur:\n                pass\n            # donn\u00e9e correcte ?\n            if not ok:\n                print(\"Saisie incorrecte. Recommencez...\")\n                continue\n            # calcul des statistiques pour l'\u00e9l\u00e8ve choisi\n            try:\n                print(self.m\u00e9tier.get_stats_for_\u00e9l\u00e8ve(id_\u00e9l\u00e8ve))\n            except MyException as erreur:\n                print(f\"L'erreur suivante s'est produite : {erreur}\")\n</code></pre> <ul> <li>lignes 3-5\u00a0: import de toutes les interfaces\u00a0;</li> <li>ligne 11\u00a0: la classe [Console] impl\u00e9mente l'interface [InterfaceUi]\u00a0;</li> <li>lignes 12-17\u00a0: le constructeur de la classe [Console] re\u00e7oit en param\u00e8tre une r\u00e9f\u00e9rence sur la couche [m\u00e9tier]. On notera qu\u2019on a donn\u00e9 le type [InterfaceM\u00e9tier] \u00e0 ce param\u00e8tre pour rappeler qu\u2019on travaille avec des interfaces plut\u00f4t qu\u2019avec des impl\u00e9mentations pr\u00e9cises\u00a0;</li> <li>ligne 24\u00a0: impl\u00e9mentation de la m\u00e9thode [run] de l'interface\u00a0;</li> <li>ligne 27\u00a0: une boucle qui s\u2019arr\u00eate lorsque la condition de la ligne 31 est v\u00e9rifi\u00e9e\u00a0;</li> <li>ligne 29\u00a0: saisie d\u2019une donn\u00e9e tap\u00e9e au clavier. La fonction [input] re\u00e7oit un param\u00e8tre facultatif\u00a0: le message \u00e0 \u00e9crire sur l\u2019\u00e9cran pour demander la saisie. Celle-ci est toujours r\u00e9cup\u00e9r\u00e9e comme une cha\u00eene de caract\u00e8res. La fonction [strip] d\u00e9barrasse celle-ci de ses \u00ab\u00a0blancs\u00a0\u00bb qui la suivent ou la pr\u00e9c\u00e8dent\u00a0;</li> <li>lignes 34-39\u00a0: on v\u00e9rifie que la saisie, un n\u00b0 d\u2019\u00e9l\u00e8ve, est valide. Il faut que ce soit un entier &gt;=1. On rappelle que la saisie a \u00e9t\u00e9 faite en tant que cha\u00eene de caract\u00e8res\u00a0;</li> <li>ligne 36\u00a0: on essaie de transformer la saisie en nombre entier en base 10. La fonction [int] lance une exception si ce n\u2019est pas possible\u00a0;</li> <li>ligne 37\u00a0: on arrive l\u00e0 seulement s\u2019il n\u2019y a pas eu d\u2019exception. On v\u00e9rifie que le nombre entier r\u00e9cup\u00e9r\u00e9 est bien &gt;=1\u00a0;</li> <li>lignes 38-39\u00a0: on g\u00e8re l\u2019exception. S\u2019il y a eu exception, la variable [ok] de la ligne 34 est rest\u00e9e \u00e0 [False]\u00a0;</li> <li>lignes 41-43\u00a0: si la saisie a \u00e9t\u00e9 incorrecte, on affiche un message d\u2019erreur et on reboucle (ligne 43)\u00a0;</li> <li>lignes 45-48\u00a0: on calcule les statistiques de l\u2019\u00e9l\u00e8ve dont on a saisi le n\u00b0\u00a0;</li> <li>ligne 46\u00a0: on utilise la m\u00e9thode [get_stats_for_\u00e9l\u00e8ve] de la couche [m\u00e9tier]. Celle-ci lance une exception si l\u2019\u00e9l\u00e8ve n\u2019existe pas. Celle-ci est g\u00e9r\u00e9e aux lignes 47-48. On sait que les couches [dao] et [m\u00e9tier] lancent l\u2019exception [MyException]\u00a0;</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#143-le-script-principal-main","title":"14.3. Le script principal [main]","text":"<p>Le script principal [main] est le suivant (main.py)\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom Console import Console\nfrom Dao import Dao\nfrom M\u00e9tier import M\u00e9tier\n\n# ----------- couche [console]\ntry:\n    # instanciation couche [dao]\n    dao = Dao()\n    # instanciation couche [m\u00e9tier]\n    m\u00e9tier = M\u00e9tier(dao)\n    # instanciation couche [ui]\n    console = Console(m\u00e9tier)\n    # ex\u00e9cution couche [console]\n    console.run()\nexcept BaseException as ex:\n    # on affiche l'erreur\n    print(f\"L'erreur suivante s'est produite : {ex}\")\nfinally:\n    pass\n</code></pre> <ul> <li>lignes 1-4\u00a0: on configure le Python Path de l\u2019application\u00a0;</li> <li>lignes 6-9\u00a0: on importe les classes et interfaces dont on a besoin\u00a0;</li> <li>ligne 14\u00a0: instanciation de la couche [dao]\u00a0;</li> <li>ligne 16\u00a0: instanciation de la couche [m\u00e9tier]\u00a0;</li> <li>ligne 18\u00a0: instanciation de la couche [ui]\u00a0;</li> <li>ligne 20\u00a0: on lance le dialogue avec l'utilisateur\u00a0;</li> <li>lignes 13-20\u00a0: normalement aucune exception ne sort de ces lignes. Celles qui remontent des couches [dao] et [m\u00e9tier] sont arr\u00eat\u00e9es par la couche [Console]. La gestion des exceptions est un art difficile lorsqu\u2019on ne conna\u00eet pas parfaitement les couches utilis\u00e9es (ici ce n\u2019est pas le cas). Dans le cas de doutes, on peut ajouter du code pour arr\u00eater tout type d\u2019exception pouvant \u00eatre lanc\u00e9 par le code ex\u00e9cut\u00e9. C\u2019est ce qui est fait ici, lignes 21-23. On arr\u00eate toute exception d\u00e9rivant de [BaseException], \u00e7-\u00e0-d toutes les exceptions\u00a0;</li> <li>lignes 24-25\u00a0: la clause [finally] ne fait rien ici. Elle n\u2019est l\u00e0 que pour pouvoir mettre en commentaires les lignes 21-23. En effet, en mode d\u00e9bogage on n\u2019a pas int\u00e9r\u00eat \u00e0 arr\u00eater les exceptions. Dans ce cas, c\u2019est l\u2019interpr\u00e9teur Python qui les arr\u00eate et il donne alors le n\u00b0 de la ligne o\u00f9 l\u2019exception s\u2019est produite. Une information indispensable. Lorsque les lignes 21-23 sont mises en commentaires, la pr\u00e9sence des lignes 24-25 permet d\u2019avoir un try/catch syntaxiquement correct. En leur absence, Python d\u00e9clare une erreur\u00a0; Voici un exemple d'ex\u00e9cution\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/troiscouches/v01/main/main.py\nNum\u00e9ro de l'\u00e9l\u00e8ve (&gt;=1 et * pour arr\u00eater) : 11\nEl\u00e8ve={\"id\": 11, \"nom\": \"nom1\", \"pr\u00e9nom\": \"pr\u00e9nom1\", \"classe\": {\"id\": 1, \"nom\": \"classe1\"}}, notes=[10 6], max=10, min=6, moyenne pond\u00e9r\u00e9e=7.33\nNum\u00e9ro de l'\u00e9l\u00e8ve (&gt;=1 et * pour arr\u00eater) : 1\nL'erreur suivante s'est produite : MyException[10, L'\u00e9l\u00e8ve d'identifiant 1 n'existe pas]\nNum\u00e9ro de l'\u00e9l\u00e8ve (&gt;=1 et * pour arr\u00eater) : *\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#144-exemple-2","title":"14.4. Exemple 2","text":"<p>Ce nouvel exemple d\u2019architectures en couches vise \u00e0 montrer l\u2019int\u00e9r\u00eat de la programmation par interfaces. Celle-ci facilite la maintenance et le test des applications. Nous utiliserons de nouveau une architecture \u00e0 trois couches\u00a0:</p> <p></p> <p>Chaque couche sera impl\u00e9ment\u00e9e de deux fa\u00e7ons diff\u00e9rentes. Nous voulons montrer que l\u2019on peut changer facilement l\u2019impl\u00e9mentation d\u2019une couche avec un impact minimal sur les autres.</p>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#1441-la-couche-dao","title":"14.4.1. La couche [dao]","text":"<p>L\u2019interface [InterfaceDao] est la suivante:</p> <pre><code># imports\nfrom abc import ABC, abstractmethod\n\n\n# interface Dao\nclass InterfaceDao(ABC):\n    # une seule m\u00e9thode\n    @abstractmethod\n    def do_something_in_dao_layer(self, x: int, y: int) -&gt; int:\n        pass\n</code></pre> <ul> <li>lignes 8-10: la m\u00e9thode [do_something_in_dao_layer] est l\u2019unique m\u00e9thode de l\u2019interface\u00a0; La classe [DaoImpl1] impl\u00e9mente l\u2019interface [InterfaceDao] de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code>from InterfaceDao import InterfaceDao\n\n\nclass DaoImpl1(InterfaceDao):\n    # impl\u00e9mentation InterfaceDao\n    def do_something_in_dao_layer(self: InterfaceDao, x: int, y: int) -&gt; int:\n        return x + y\n</code></pre> <p>La classe [DaoImpl2] impl\u00e9mente l\u2019interface [InterfaceDao] de la fa\u00e7on suivante\u00a0:</p> <pre><code>from InterfaceDao import InterfaceDao\n\n\nclass DaoImpl2(InterfaceDao):\n    # impl\u00e9mentation InterfaceDao\n    def do_something_in_dao_layer(self: InterfaceDao, x: int, y: int) -&gt; int:\n        return x - y\n</code></pre>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#1442-la-couche-metier","title":"14.4.2. La couche [m\u00e9tier]","text":"<p>L\u2019interface [InterfaceM\u00e9tier] est la suivante:</p> <pre><code># imports\nfrom abc import ABC, abstractmethod\n\n\n# interface m\u00e9tier\nclass InterfaceM\u00e9tier(ABC):\n    # une seule m\u00e9thode\n    @abstractmethod\n    def do_something_in_m\u00e9tier_layer(self, x: int, y: int) -&gt; int:\n        pass\n</code></pre> <ul> <li>lignes 8-10: la m\u00e9thode [do_something_in_m\u00e9tier_layer] est l\u2019unique m\u00e9thode de l\u2019interface\u00a0; La classe [AbstractBaseM\u00e9tier] impl\u00e9mente l\u2019interface [InterfaceM\u00e9tier] de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code># imports\nfrom abc import ABC, abstractmethod\n\nfrom InterfaceDao import InterfaceDao\nfrom InterfaceM\u00e9tier import InterfaceM\u00e9tier\n\n\nclass AbstractBaseM\u00e9tier(InterfaceM\u00e9tier, ABC):\n    # propri\u00e9t\u00e9s\n    # __dao est une r\u00e9f\u00e9rence sur la couche [dao]\n    @property\n    def dao(self) -&gt; InterfaceDao:\n        return self.__dao\n\n    @dao.setter\n    def dao(self, dao: InterfaceDao):\n        self.__dao = dao\n\n    # impl\u00e9mentation de l'interface [InterfaceM\u00e9tier]\n    @abstractmethod\n    def do_something_in_m\u00e9tier_layer(self, x: int, y: int) -&gt; int:\n        pass\n</code></pre> <ul> <li>ligne 8\u00a0: la classe [AbstractBaseM\u00e9tier] d\u00e9rive deux classes\u00a0:</li> <li>[InterfaceM\u00e9tier]\u00a0: la classe [AbstractBaseM\u00e9tier] impl\u00e9mente cette interface aux lignes 19-22. En fait on voit qu\u2019elle n\u2019a pas impl\u00e9ment\u00e9 la m\u00e9thode [do_something_in_m\u00e9tier_layer] qu\u2019elle a d\u00e9clar\u00e9e abstraite (ligne 20). Ce sera aux classes d\u00e9riv\u00e9es d\u2019impl\u00e9menter la m\u00e9thode;</li> <li>[ABC] pour avoir acc\u00e8s aux annotations [@abstractmethod]\u00a0;</li> <li> <p>l\u2019ordre a un sens\u00a0: si on l\u2019inverse ici, Python d\u00e9clare une erreur \u00e0 l\u2019ex\u00e9cution\u00a0; C\u2019est la premi\u00e8re fois qu\u2019on utilise l\u2019h\u00e9ritage multiple (h\u00e9riter de plusieurs classes). La classe [AbstractBaseM\u00e9tier] h\u00e9rite, \u00e0 la fois, des propri\u00e9t\u00e9s des classes [InterfaceM\u00e9tier] et [ABC].</p> </li> <li> <p>lignes 9-17\u00a0: on d\u00e9finit la propri\u00e9t\u00e9 [dao] qui sera une r\u00e9f\u00e9rence sur la couche [dao]\u00a0; Une interface est destin\u00e9e \u00e0 \u00eatre impl\u00e9ment\u00e9e. Lorsque des impl\u00e9mentations diff\u00e9rentes partagent des propri\u00e9t\u00e9s il est int\u00e9ressant de mettre celles-ci dans une classe parent afin d\u2019\u00e9viter de les dupliquer. C\u2019est le cas ici de la propri\u00e9t\u00e9 [dao]. La classe parent est en g\u00e9n\u00e9ral toujours abstraite parce qu\u2019elle ne sait pas impl\u00e9menter toutes les m\u00e9thodes de l\u2019interface.</p> </li> </ul> <p>La classe [M\u00e9tierImpl1] impl\u00e9mente l\u2019interface [InterfaceM\u00e9tier] de la fa\u00e7on suivante\u00a0:</p> <pre><code>from AbstractBaseM\u00e9tier import AbstractBaseM\u00e9tier\n\n\nclass M\u00e9tierImpl1(AbstractBaseM\u00e9tier):\n    # impl\u00e9mentation de l'interface [InterfaceM\u00e9tier]\n    def do_something_in_m\u00e9tier_layer(self:AbstractBaseM\u00e9tier, x: int, y: int) -&gt; int:\n        x += 1\n        y += 1\n        return self.dao.do_something_in_dao_layer(x, y)\n</code></pre> <ul> <li>ligne 4\u00a0: la classe [M\u00e9tierImpl1] d\u00e9rive de la classe [AbstractbaseM\u00e9tier]. Elle h\u00e9rite donc de la propri\u00e9t\u00e9 [dao] de cette classe\u00a0;</li> <li>lignes 6-9\u00a0: impl\u00e9mentation de l\u2019interface [InterfaceM\u00e9tier] que n\u2019a pas impl\u00e9ment\u00e9e la classe parent [AbstractbaseM\u00e9tier]\u00a0;</li> <li>ligne 9\u00a0: on utilise la couche [dao]\u00a0; La classe [M\u00e9tierImpl2] impl\u00e9mente l\u2019interface [InterfaceM\u00e9tier] de fa\u00e7on analogue\u00a0:</li> </ul> <pre><code>from AbstractBaseM\u00e9tier import AbstractBaseM\u00e9tier\n\n\nclass M\u00e9tierImpl2(AbstractBaseM\u00e9tier):\n    # impl\u00e9mentation de l'interface [InterfaceM\u00e9tier]\n    def do_something_in_m\u00e9tier_layer(self:AbstractBaseM\u00e9tier, x: int, y: int) -&gt; int:\n        x -= 1\n        y -= 1\n        return self.dao.do_something_in_dao_layer(x, y)\n</code></pre>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#1443-la-couche-ui","title":"14.4.3. La couche [ui]","text":"<p>L\u2019interface [InterfaceUi] est la suivante\u00a0:</p> <pre><code># imports\nfrom abc import ABC, abstractmethod\n\n\n# interface Ui\nclass InterfaceUi(ABC):\n    # une seule m\u00e9thode\n    @abstractmethod\n    def do_something_in_ui_layer(self, x: int, y: int) -&gt; int:\n        pass\n</code></pre> <ul> <li>lignes 8-10\u00a0: l\u2019unique m\u00e9thode de l\u2019interface\u00a0; La classe [AbstractBaseUi] impl\u00e9mente l\u2019interface [InterfaceUi] de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code># imports\nfrom abc import ABC, abstractmethod\n\nfrom InterfaceM\u00e9tier import InterfaceM\u00e9tier\nfrom InterfaceUi import InterfaceUi\n\n\nclass AbstractBaseUi(InterfaceUi, ABC):\n    # propri\u00e9t\u00e9s\n    # m\u00e9tier est une r\u00e9f\u00e9rence sur la couche [m\u00e9tier]\n    @property\n    def m\u00e9tier(self) -&gt; InterfaceM\u00e9tier:\n        return self.__m\u00e9tier\n\n    @m\u00e9tier.setter\n    def m\u00e9tier(self, m\u00e9tier: InterfaceM\u00e9tier):\n        self.__m\u00e9tier = m\u00e9tier\n\n    # impl\u00e9mentation de l'interface [InterfaceUI]\n    @abstractmethod\n    def do_something_in_ui_layer(self: InterfaceUi, x: int, y: int) -&gt; int:\n        pass\n</code></pre> <ul> <li>la classe [AbstractBaseUi] est une classe abstraite (ligne 20). Elle devra \u00eatre d\u00e9riv\u00e9e pour impl\u00e9menter l\u2019interface [InterfaceUi]\u00a0;</li> <li>lignes 9-17\u00a0: la classe [AbstractBaseUi] poss\u00e8de une r\u00e9f\u00e9rence sur la couche [m\u00e9tier]\u00a0; La classe d\u2019impl\u00e9mentation [UiImpl1] est la suivante\u00a0:</li> </ul> <pre><code>from AbstractBaseUi import AbstractBaseUi\n\n\nclass UiImpl1(AbstractBaseUi):\n    # impl\u00e9mentation de l'interface [InterfaceUi]\n    def do_something_in_ui_layer(self: AbstractBaseUi, x: int, y: int) -&gt; int:\n        x += 1\n        y += 1\n        return self.m\u00e9tier.do_something_in_m\u00e9tier_layer(x, y)\n</code></pre> <ul> <li>ligne 4\u00a0: la classe [UiImpl1] d\u00e9rive de la classe [AbstractBaseUi] et h\u00e9rite donc de sa propri\u00e9t\u00e9 [m\u00e9tier]. Celle-ci est utilis\u00e9e ligne 9\u00a0; La classe d\u2019impl\u00e9mentation [UiImpl2] est analogue\u00a0:</li> </ul> <pre><code>from AbstractBaseUi import AbstractBaseUi\n\n\nclass UiImpl2(AbstractBaseUi):\n    # impl\u00e9mentation de l'interface [InterfaceUi]\n    def do_something_in_ui_layer(self: AbstractBaseUi, x: int, y: int) -&gt; int:\n        x -= 1\n        y -= 1\n        return self.m\u00e9tier.do_something_in_m\u00e9tier_layer(x, y)\n</code></pre> <ul> <li>ligne 4\u00a0: la classe [UiImpl2] d\u00e9rive de la classe [AbstractBaseUi] et h\u00e9rite donc de sa propri\u00e9t\u00e9 [m\u00e9tier]. Celle-ci est utilis\u00e9e ligne 9\u00a0;</li> </ul>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#1444-les-fichiers-de-configuration","title":"14.4.4. Les fichiers de configuration","text":"<ul> <li>les fichiers [config1, config2] configurent l\u2019application de deux fa\u00e7ons diff\u00e9rentes\u00a0;</li> <li>le fichier [main] est le script principal de l\u2019application\u00a0; Le fichier [config1] est le suivant\u00a0:</li> </ul> <pre><code>def\u00a0configure():\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a01\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0absolu\u00a0du\u00a0dossier\u00a0de\u00a0ce\u00a0script\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossiers\u00a0locaux\u00a0du\u00a0Python\u00a0Path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../dao\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../ui\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../m\u00e9tier\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0configure\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a02\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0des\u00a0couches\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0from\u00a0DaoImpl1\u00a0import\u00a0DaoImpl1\n\u00a0\u00a0\u00a0\u00a0from\u00a0M\u00e9tierImpl1\u00a0import\u00a0M\u00e9tierImpl1\n\u00a0\u00a0\u00a0\u00a0from\u00a0UiImpl1\u00a0import\u00a0UiImpl1\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\n\u00a0\u00a0\u00a0\u00a0#\u00a0dao\n\u00a0\u00a0\u00a0\u00a0dao\u00a0=\u00a0DaoImpl1()\n\u00a0\u00a0\u00a0\u00a0#\u00a0m\u00e9tier\n\u00a0\u00a0\u00a0\u00a0m\u00e9tier\u00a0=\u00a0M\u00e9tierImpl1()\n\u00a0\u00a0\u00a0\u00a0m\u00e9tier.dao\u00a0=\u00a0dao\n\u00a0\u00a0\u00a0\u00a0#\u00a0ui\n\u00a0\u00a0\u00a0\u00a0ui\u00a0=\u00a0UiImpl1()\n\u00a0\u00a0\u00a0\u00a0ui.m\u00e9tier\u00a0=\u00a0m\u00e9tier\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0met\u00a0les\u00a0instances\u00a0de\u00a0couche\u00a0dans\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0#\u00a0seule\u00a0la\u00a0couche\u00a0ui\u00a0est\u00a0ici\u00a0n\u00e9cessaire\n\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0{\"ui\":\u00a0ui}\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <ul> <li>lignes 2-16\u00a0: configuration du Python Path de l\u2019application\u00a0;</li> <li>lignes 18-31\u00a0: instanciation des couches [dao, m\u00e9tier, ui]. Pour impl\u00e9menter leurs interfaces, on choisit \u00e0 chaque fois la 1\u00e8re impl\u00e9mentation construite\u00a0;</li> <li>lignes 33-35\u00a0: on met les r\u00e9f\u00e9rences de couches dans la configuration. Ici, le script principal n\u2019a besoin que de la couche [ui]\u00a0; Le fichier [config2] est analogue et impl\u00e9mente chaque interface avec la 2i\u00e8me impl\u00e9mentation disponible\u00a0:</li> </ul> <pre><code>def\u00a0configure():\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a01\u00a0---\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0absolu\u00a0du\u00a0dossier\u00a0de\u00a0ce\u00a0script\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossiers\u00a0locaux\u00a0du\u00a0Python\u00a0Path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../dao\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../ui\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../m\u00e9tier\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0configure\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a02\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0des\u00a0couches\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0from\u00a0DaoImpl2\u00a0import\u00a0DaoImpl2\n\u00a0\u00a0\u00a0\u00a0from\u00a0M\u00e9tierImpl2\u00a0import\u00a0M\u00e9tierImpl2\n\u00a0\u00a0\u00a0\u00a0from\u00a0UiImpl2\u00a0import\u00a0UiImpl2\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\n\u00a0\u00a0\u00a0\u00a0#\u00a0dao\n\u00a0\u00a0\u00a0\u00a0dao\u00a0=\u00a0DaoImpl2()\n\u00a0\u00a0\u00a0\u00a0#\u00a0m\u00e9tier\n\u00a0\u00a0\u00a0\u00a0m\u00e9tier\u00a0=\u00a0M\u00e9tierImpl2()\n\u00a0\u00a0\u00a0\u00a0m\u00e9tier.dao\u00a0=\u00a0dao\n\u00a0\u00a0\u00a0\u00a0#\u00a0ui\n\u00a0\u00a0\u00a0\u00a0ui\u00a0=\u00a0UiImpl2()\n\u00a0\u00a0\u00a0\u00a0ui.m\u00e9tier\u00a0=\u00a0m\u00e9tier\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0met\u00a0les\u00a0instances\u00a0de\u00a0couche\u00a0dans\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0#\u00a0seule\u00a0la\u00a0couche\u00a0ui\u00a0est\u00a0ici\u00a0n\u00e9cessaire\n\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0{\"ui\":\u00a0ui}\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre>"},{"location":"architecture-en-couches-et-programmation-par-interfaces.html#1445-le-script-principal-main","title":"14.4.5. Le script principal [main]","text":"<p>Le script principal est le suivant\u00a0:</p> <pre><code># imports\nimport importlib\nimport sys\n\n# main ---------\n\n# il faut deux arguments\nnb_args = len(sys.argv)\nif nb_args != 2 or (sys.argv[1] != \"config1\" and sys.argv[1] != \"config2\"):\n    print(f\"Syntaxe : {sys.argv[0]} config1 ou config2\")\n    sys.exit()\n\n# configuration de l'application\nmodule = importlib.import_module(sys.argv[1])\nconfig = module.configure()\n\n# ex\u00e9cution de la couche [ui]\nprint(config[\"ui\"].do_something_in_ui_layer(10, 20))\n</code></pre> <p>Ce script re\u00e7oit un param\u00e8tre\u00a0:</p> <ul> <li>[config1] pour utiliser la configuration n\u00b0 1\u00a0;</li> <li> <p>[config2] pour utiliser la configuration n\u00b0 2\u00a0; Python enregistre les param\u00e8tres dans une liste [sys.argv]\u00a0:</p> </li> <li> <p>sys.argv[0] est le nom du script, ici [main]. Ce param\u00e8tre est toujours pr\u00e9sent\u00a0;</p> </li> <li>sys.argv[1] est le 1er param\u00e8tre pass\u00e9 au script, sys.argv[2] le 2i\u00e8me, \u2026</li> <li>ligne 8\u00a0: on r\u00e9cup\u00e8re le nombre de param\u00e8tres\u00a0;</li> <li>lignes 9-11\u00a0: on v\u00e9rifie qu\u2019il y a bien un param\u00e8tre et que sa valeur est soit [config1], soit [config2]. Si ce n\u2019est pas le cas, un message d\u2019erreur est affich\u00e9 (ligne 10) et on quitte le programme (ligne 11)\u00a0; Une fois connue la configuration souhait\u00e9e, il nous faut ex\u00e9cuter cette configuration. Par exemple, si c\u2019est la configuration 1 qui a \u00e9t\u00e9 choisie, il nous faut ex\u00e9cuter le code\u00a0:</li> </ul> <pre><code>import config1\nconfig1.configure()\n</code></pre> <p>Le probl\u00e8me ici est que la configuration \u00e0 utiliser est dans une variable, la variable [sys.argv[1]. Pour importer un module dont le nom est dans une variable, il nous faut utiliser le package[importlib] (ligne 2).</p> <ul> <li>ligne 14\u00a0: on importe le module dont le nom est dans [sys.argv[1]\u00a0;</li> <li>ligne 15\u00a0: ceci fait, on ex\u00e9cute la fonction [configure] de ce module. On r\u00e9cup\u00e8re un dictionnaire [config] qui est la configuration de l\u2019application\u00a0;</li> <li>ligne 18\u00a0: on sait qu\u2019une r\u00e9f\u00e9rence de la couche [ui] est dans config[\u2018ui\u2019]. On l\u2019utilise pour appeler la m\u00e9thode [do_something_in_ui_layer]. On sait que cette m\u00e9thode va appeler une m\u00e9thode de la couche [m\u00e9tier] qui elle-m\u00eame va appeler une m\u00e9thode de la couche [dao]\u00a0; Par exemple, la fonction [do_something_in_ui_layer] est la suivante\u00a0:</li> </ul> <pre><code>class UiImpl1(AbstractBaseUi):\n    # impl\u00e9mentation de l'interface [InterfaceUi]\n    def do_something_in_ui_layer(self: AbstractBaseUi, x: int, y: int) -&gt; int:\n        x += 1\n        y += 1\n        return self.m\u00e9tier.do_something_in_m\u00e9tier_layer(x, y)\n</code></pre> <ul> <li> <p>ligne 6 ci-dessus\u00a0utilise la propri\u00e9t\u00e9 [m\u00e9tier] de la classe [UiImpl1], ligne 1. Or dans la configuration [config1] il a \u00e9t\u00e9 \u00e9crit\u00a0: <pre><code># m\u00e9tier\n    m\u00e9tier = M\u00e9tierImpl1()\n    m\u00e9tier.dao = dao\n    # ui\n    ui = UiImpl1()\n    ui.m\u00e9tier = m\u00e9tier\n</code></pre></p> </li> <li> <p>ligne 6\u00a0: la propri\u00e9t\u00e9 [m\u00e9tier] de [UIImpl1] est une r\u00e9f\u00e9rence \u00e0 la classe [M\u00e9tierImpl1] (ligne 2). Ainsi c\u2019est la m\u00e9thode [do_something_in_ui_layer] de la classe [M\u00e9tierImpl1] qui va \u00eatre ex\u00e9cut\u00e9e\u00a0; Dans la classe [M\u00e9tierUiImpl1], il est \u00e9crit\u00a0:</p> </li> </ul> <pre><code>class M\u00e9tierImpl1(AbstractBaseM\u00e9tier):\n    # impl\u00e9mentation de l'interface [InterfaceM\u00e9tier]\n    def do_something_in_m\u00e9tier_layer(self: AbstractBaseM\u00e9tier, x: int, y: int) -&gt; int:\n        x += 1\n        y += 1\n        return self.dao.do_something_in_dao_layer(x, y)\n</code></pre> <ul> <li>ligne 6, la m\u00e9thode appel\u00e9e par la couche [ui] va \u00e0 son tour appel\u00e9e une m\u00e9thode de la propri\u00e9t\u00e9 [dao] de la classe [M\u00e9tierImpl1]\u00a0; Or dans la configuration [config1], il a \u00e9t\u00e9 \u00e9crit\u00a0:</li> </ul> <pre><code># dao\n    dao = DaoImpl1()\n    # m\u00e9tier\n    m\u00e9tier = M\u00e9tierImpl1()\n    m\u00e9tier.dao = dao\n</code></pre> <ul> <li>ligne 5\u00a0: la propri\u00e9t\u00e9 [M\u00e9tierImpl1.dao] est de type [DaoImpl1] (ligne 2)\u00a0; Ce qu\u2019on veut montrer ici, c\u2019est que le script [main] n\u2019a pas \u00e0 se pr\u00e9occuper des couches [m\u00e9tier] et [dao]. Il n\u2019a \u00e0 se pr\u00e9occuper que de la couche [ui], les liens entre cette couche et les autres ayant \u00e9t\u00e9 faits par configuration.</li> </ul> <p></p> <p>Pour passer le param\u00e8tre [config1] ou [config2] au script [main], on proc\u00e8dera de la fa\u00e7on suivante\u00a0:</p> <p></p> <ul> <li>en [1-2], on cr\u00e9e ce qu\u2019on appelle une configuration d\u2019ex\u00e9cution\u00a0;</li> <li>en [3], on donne un nom \u00e0 cette configuration pour pouvoir la retrouver\u00a0;</li> <li>en [4], on s\u00e9lectionne le script \u00e0 ex\u00e9cuter. Si on a suivi la proc\u00e9dure [1-2], le bon script a d\u00e9j\u00e0 \u00e9t\u00e9 s\u00e9lectionn\u00e9\u00a0;</li> <li>en [5], on met ici les param\u00e8tres \u00e0 transmettre au script. On passe ici la cha\u00eene [config1] pour demander au script d\u2019utiliser la configuration n\u00b0 1\u00a0;</li> <li>en [6], on valide la configuration d\u2019ex\u00e9cution\u00a0;</li> </ul> <p></p> <ul> <li>en [1-2], on demande \u00e0 voir les contextes d\u2019ex\u00e9cution existants\u00a0;</li> <li>en [3], on s\u00e9lectionne le contexte d\u2019ex\u00e9cution existant et on le duplique [4]\u00a0;</li> </ul> <p></p> <ul> <li>en [5], le nom donn\u00e9 \u00e0 la nouvelle configuration. Ce sera celle qui ex\u00e9cute le script [main] [6] en lui passant le param\u00e8tre [config2] [7]\u00a0; Les configurations d\u2019ex\u00e9cution sont disponibles en haut \u00e0 droite de la fen\u00eatre PyCharm\u00a0:</li> </ul> <p></p> <p>Il suffit de s\u00e9lectionner [2] ou [3] puis d\u2019appuyer sur [4] pour ex\u00e9cuter le script [main] avec l\u2019un ou l\u2019autre des param\u00e8tres [config1] ou [config2].</p> <p>Avec [config1], l\u2019ex\u00e9cution de [main] donne les r\u00e9sultats suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/troiscouches/v02/main/main.py config1\n34\n\nProcess finished with exit code 0\n</code></pre> <p>Avec [config2], l\u2019ex\u00e9cution de [main] donne les r\u00e9sultats suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/troiscouches/v02/main/main.py config2\n-10\n\nProcess finished with exit code 0\n</code></pre> <p>Le lecteur est invit\u00e9 \u00e0 v\u00e9rifier ces r\u00e9sultats.</p>"},{"location":"avant-propos.html","title":"1. Avant-propos","text":"<p>Ce document propose une liste de scripts Python dans diff\u00e9rents domaines\u00a0:</p> <ul> <li>les fondamentaux du langage\u00a0;</li> <li>la gestion de bases de donn\u00e9es MySQL\u00a0et PostgreSQL\u00a0;</li> <li>la programmation r\u00e9seau TCP/ IP\u00a0(protocoles HTTP, POP3, IMAP, SMTP)\u00a0;</li> <li>la programmation web\u00a0MVC avec le Framework FLASK\u00a0;</li> <li>les architectures trois couches et la programmation par interfaces\u00a0; Ce n'est pas un cours Python exhaustif mais un recueil d'exemples destin\u00e9s \u00e0 des d\u00e9veloppeurs ayant d\u00e9j\u00e0 utilis\u00e9 un langage de script tel que Perl, PHP, VBScript ou des d\u00e9veloppeurs habitu\u00e9s aux langages typ\u00e9s tels que Java ou C# et qui seraient int\u00e9ress\u00e9s par d\u00e9couvrir un langage de script orient\u00e9 objet. Ce document est peu appropri\u00e9 pour des lecteurs n'ayant jamais ou peu programm\u00e9.</li> </ul> <p>Ce document n'est pas non plus un recueil de \"bonnes pratiques\". Le d\u00e9veloppeur exp\u00e9riment\u00e9 pourra ainsi trouver que certains codes pourraient \u00eatre mieux \u00e9crits. Ce document a pour seul objectif de donner des exemples \u00e0 une personne d\u00e9sireuse de s'initier au langage Python 3 et au Framework Flask. Elle approfondira ensuite son apprentissage avec d'autres documents.</p> <p>Les scripts sont comment\u00e9s et les r\u00e9sultats de leur ex\u00e9cution reproduits. Parfois des explications suppl\u00e9mentaires sont fournies. Le document n\u00e9cessite une lecture active\u00a0: pour comprendre un script, il faut \u00e0 la fois lire son code, ses commentaires et ses r\u00e9sultats d\u2019ex\u00e9cution.</p> <p>Les exemples du document sont disponibles \u00e0 l'adresse |https://tahe.developpez.com/tutoriels-cours/python-flask-2020/documents/python-flask-2020.rar|\u00a0:</p> <p></p> <p>Le document est une mise \u00e0 jour d'un ancien document paru en juin 2011 |https://tahe.developpez.com/tutoriels-cours/python/|. Le document de 2011 avait \u00e9t\u00e9 construit avec l'interpr\u00e9teur Python 2.7. Depuis, des versions Python 3.x sont apparues. En f\u00e9vrier 2020, on en est \u00e0 la version 3.8. Les versions 3.x ont amen\u00e9 une discontinuit\u00e9 dans la portabilit\u00e9 entre versions : des codes s'ex\u00e9cutant sous Python 2.7 peuvent se r\u00e9v\u00e9ler inutilisables sous Python 3.x. C'est notamment le cas pour l'\u00e9criture console. En 2.7 on peut \u00e9crire [print \"toto\"] alors qu'en 3.x il faut \u00e9crire [print(\"toto\")] : il faut mettre des parenth\u00e8ses. Cette simple \u00e9volution fait que les codes fournis avec le document de 2011 sont pour la plupart inutilisables directement avec Python 3.x. Il faut les modifier.</p> <p>Ce nouveau document ne se contente pas de mettre \u00e0 jour les codes de 2011 pour qu'ils soient ex\u00e9cutables avec Python 3.8\u00a0:</p> <ul> <li>les sections sur la programmation TCP-IP et l\u2019usage des bases de donn\u00e9es ont subi d\u2019importantes \u00e9volutions\u00a0;</li> <li>la section sur la programmation web qui n\u2019\u00e9tait qu\u2019une introduction est d\u00e9sormais un cours complet utilisant le framework FLASK\u00a0; Pour construire ce cours, j\u2019ai suivi une d\u00e9marche inhabituelle : j\u2019ai fait un portage du cours PHP [Introduction au langage PHP7 par l\u2019exemple]. Je n\u2019ai donc pas suivi les structures traditionnelles des cours Python ou Flask. Je voulais avant tout savoir comment je pouvais faire avec Python 3 ce que j\u2019avais fait en PHP 7. Le r\u00e9sultat est que j\u2019ai pu refaire, en Python 3 / Flask,  tous les exemples du cours PHP 7.</li> </ul> <p>Ce document peut comporter des erreurs ou des insuffisances. Le lecteur peut utiliser le flux de discussion |forum| pour les signaler.</p> <p>Le contenu du document\u00a0est le suivant\u00a0:</p> <p>Chapitre</p><p>Dossier du code</p><p>Contenu</p> <p>Chapitre 1</p> <p>Pr\u00e9sentation du cours</p><p>Chapitre 2</p> <p>Installation d\u2019un environnement de travail</p><p>Chapitre 3</p><p>[bases]</p><p>Les bases du langage Python \u2013 structures du langage \u2013 type de donn\u00e9es \u2013 fonctions \u2013 affichage console \u2013 cha\u00eenes de formatage \u2013 changement de types \u2013 les listes \u2013 les dictionnaires \u2013 les expression sr\u00e9guli\u00e8res</p><p>Chapitre 4</p><p>[strings]</p><p>Notation des cha\u00eenes de caract\u00e8res \u2013 m\u00e9thodes de la classe &lt;str&gt; - encodage / d\u00e9codage des cha\u00eenes de caract\u00e8res en UTF-8</p><p>Chapitre 5</p><p>[exceptions]</p><p>Gestion des exceptions</p><p>Chapitre 6</p><p>[fonctions]</p><p>Port\u00e9e des variables \u2013 mode de passage des param\u00e8tres \u2013 utiliser des modules \u2013 le Python Path \u2013 param\u00e8tres nomm\u00e9s \u2013 fonctions r\u00e9cursives</p><p>Chapitre 7</p><p>[fichiers]</p><p>Lecture / \u00e9criture d\u2019un fichier texte \u2013 gestion des fichiers encod\u00e9s en UTF-8 \u2013 gestion des fichiers jSON</p><p>Chapitre 8</p><p>[impots/v01]</p><p>Version 1 de l\u2019exercice d\u2019application, un calcul d\u2019imp\u00f4t sur les revenus. L\u2019application est d\u00e9clin\u00e9e en 18 versions \u2013 La version 1 impl\u00e9mente une solution proc\u00e9durale</p><p>Chapitre 9</p><p>[imports]</p><p>Gestion des d\u00e9pendances d\u2019une application par importation de modules \u2013 une m\u00e9thode de gestion des d\u00e9pendances est pr\u00e9sent\u00e9e \u2013 elle est utilis\u00e9e dans tout le document \u2013 gestion du Python Path</p><p>Chapitre 10</p><p>[impots/v02]</p><p>La version 2 de l\u2019application reprend la version 1 en rassemblant toutes les constantes de la configuration dans un fichier de configuration qui g\u00e8re \u00e9galement le Python Path</p><p>Chapitre 11</p><p>[impots/v03]</p><p>La version 3 de l\u2019application reprend la version 2 en utilisant des fonctions encapsul\u00e9es dans un module \u2013 la gestion des d\u00e9pendances est faite par configuration \u2013 introduction de fichier jSON pour lire les donn\u00e9es n\u00e9cessaires au calcul de l\u2019imp\u00f4t et \u00e9crire les r\u00e9sultats des calculs</p><p>Chapitre 12</p><p>[classes/01]</p><p>Classes \u2013 h\u00e9ritage \u2013 m\u00e9thodes et propri\u00e9t\u00e9s \u2013 getters / setters \u2013 constructeur \u2013 propri\u00e9t\u00e9 [__dict__]</p><p>Chapitre 13</p><p>[classes/02]</p><p>Pr\u00e9sentation des classes [BaseEntity] et [MyException] utilis\u00e9es dans le reste du document \u2013 [BaseEntity] facilite les conversions objet / dictionnaire</p><p>Chapitre 14</p><p>[troiscouches]</p><p>Architecture en couches et programmation par interfaces. Ce chapitre pr\u00e9sente les m\u00e9thodes de programmation utilis\u00e9es dans le reste du document</p><p>Chapitre 15</p><p>[impots/v04]</p><p>Version 4 de l\u2019application \u2013 cette version impl\u00e9mente une solution avec une architecture en couches, la programmation par interfaces, l\u2019utilisation de classes d\u00e9riv\u00e9es de [BaseEntity] et [MyException]</p><p>Chapitre 16</p><p>[databases/mysql]</p><p>Installation du SGBD MySQL \u2013 connexion \u00e0 une base de donn\u00e9es \u2013 cr\u00e9ation d\u2019une table \u2013 ex\u00e9cution d\u2019ordres SQL SELECT, UPDATE, DELETE, INSERT \u2013 transaction \u2013 requ\u00eates SQL param\u00e9tr\u00e9es</p><p>Chapitre 17</p><p>[databases/postgresql]</p><p>Installation du SGBD PostgreSQL \u2013 connexion \u00e0 une base de donn\u00e9es \u2013 cr\u00e9ation d\u2019une table \u2013 ex\u00e9cution d\u2019ordres SQL SELECT, UPDATE, DELETE, INSERT \u2013 transaction \u2013 requ\u00eates SQL param\u00e9tr\u00e9es</p><p>Chapitre 18</p><p>[databases/anysgbd]</p><p>Ecriture de code ind\u00e9pendant du SGBD</p><p>Chapitre 19</p><p>[databases/sqlalchemy]</p><p>L\u2019ORM (Object Relational Mapper) SqlAlchemy \u2013 un ORM permet de travailler de fa\u00e7on unifi\u00e9e avec diff\u00e9rents SGBD - mapping classes / tables SQL \u2013 op\u00e9rations sur les classes images des tables SQL</p><p>Chapitre 20</p><p>[impots/v05]</p><p>Version 5 de l\u2019application de calcul de l\u2019imp\u00f4t \u2013 Utilisation de l\u2019architecture en couches de la version 04 et de l\u2019ORM SqlAlchemy pour travailler avec les SGBD MySQL et PostgreSQL</p><p>Chapitre 21</p><p>[inet]</p><p>Programmation internet \u2013 protocole TCP / IP (Transfer Control Protocol / Internet Protocol) - protocoles HTTP (HyperText Transfer Protocol) \u2013 SMTP (Simple Mail Transfer Protocol) \u2013 POP (Post Office Protocol) \u2013 IMAP (Internet Message Access Protocol)</p><p>Chapitre 22</p><p>[flask]</p><p>Services web avec le framework web Flask \u2013 affichage d\u2019une page HTML \u2013 service web jSON \u2013 requ\u00eates GET et POST \u2013 gstion d\u2019une session web</p><p>Chapitre 23</p><p>[impots/http-servers/01]</p><p>[impots/http-clients/01]</p><p>Version 6 de l\u2019exercice d\u2019application - Cr\u00e9ation d\u2019un service web jSON de calcul de l\u2019imp\u00f4t avec une architecture multicouche - Ecriture d\u2019un client web pour ce serveur avec une architecture multicouche \u2013 programmation client / serveur \u2013 utilisation du module [requests]</p><p>Chapitre 24</p><p>[impots/http-servers/02]</p><p>[impots/http-clients/02]</p><p>Version 7 de l\u2019exercice de l\u2019application \u2013 la version 6 est am\u00e9lior\u00e9e\u00a0: le client et le serveur sont multithtread\u00e9s \u2013 utilitaires [Logger] pour loguer les \u00e9changes client / serveur \u2013 [SendMail] pour envoyer un mail \u00e0 l\u2019administrateur de l\u2019application</p><p>Chapitre 25</p><p>[impots/http-servers/03]</p><p>[impots/http-clients/03]</p><p>Version 8 de l\u2019exercice d\u2019application \u2013 la version 7 est am\u00e9lior\u00e9e par l\u2019usage d\u2019une session web</p><p>Chapitre 26</p><p>[xml]</p><p>Gestion du XML (eXtended Markup Language) avec le module [xmltodict]</p><p>Chapitre 27</p><p>[impots/http-servers/04]</p><p>[impots/http-clients/04]</p><p>Version 9 de l\u2019exercice d\u2019application \u2013 la version 8 est modifi\u00e9e pour avoir des \u00e9changes client / serveur en XML\u00a0;</p><p>Chapitre 28</p><p>[impots/http-servers/05]</p><p>[impots/http-clients/05]</p><p>Version 10 de l\u2019exercice d\u2019application \u2013 au lieu de traiter N contribuables par N requ\u00eates GET, on utilise une unique requ\u00eate POST avec les N contribuables dans le corps du POST</p><p>Chapitre 29</p><p>[impots/http-servers/06]</p><p>[impots/http-clients/06]</p><p>Version 11 de l\u2019exercice d\u2019application \u2013 l\u2019architecture client / serveur de l\u2019application est modifi\u00e9e\u00a0: la couche [m\u00e9tier] passe du serveur au client</p><p>Chapitre 30</p><p>[impots/http-servers/07]</p><p>Version 12 de l\u2019exercice d\u2019application \u2013 cette version impl\u00e9mente un serveur MVC (Model \u2013 View \u2013 Controller) d\u00e9livrant indiff\u00e9remment, \u00e0 la demande du client, du jSON, du XML et du HTML. Ce chapitre impl\u00e9mente les versions jSON et XML du serveur</p><p>Chapitre 31</p><p>[impots/http-clients/07]</p><p>Impl\u00e9mentation des clients jSON et XML du serveur MVC de la version 12</p><p>Chapitre 32</p><p>[impots/http-servers/07]</p><p>Impl\u00e9mentation du serveur HTML de la version 12 \u2013 utilisation du framework CSS Bootstrap \u2013</p><p>Chapitre 33</p><p>[impots/http-servers/08]</p><p>Version 13 de l\u2019exercice d\u2019application - Refactorisation du code de la version 12 \u2013 gestion de la session avec le module [flask_session] et un serveur Redis \u2013 utilisation de mots de passe crypt\u00e9s</p><p>Chapitre 34</p><p>[impots/http-servers/09]</p><p>[impots/http-clients/09]</p><p>Version 14 de l\u2019exercice d\u2019application \u2013 impl\u00e9mentation d\u2019URL avec un jeton CSRF (Cross Site Request Forgery)</p><p>Chapitre 35</p><p>[impots/http-servers/10]</p><p>Version 15 de l\u2019exercice d\u2019application \u2013 refactorisation du code de la version 14 pour g\u00e9rer deux types d\u2019actions\u00a0: ASV (Action Show View) qui ne servent qu\u2019\u00e0 afficher une vue sans modifier l\u2019\u00e9tat du serveur, ADS (Action Do Something) qui font une action qui modifie l\u2019\u00e9tat du serveur \u2013 ces actions se terminent toutes par une redirection vers une action ASV \u2013 cela permet de g\u00e9rer correctement les rafra\u00eechissements de page du navigateur client</p><p>Chapitre 36</p><p>[impots/http-servers/11]</p><p>Version 16 de l\u2019application \u2013 gestion des URL avec pr\u00e9fixe</p><p>Chapitre 37</p><p>[impots/http-servers/12]</p><p>Version 17 de l\u2019application \u2013 portage de la version 16 sur un serveur Apache / Windows</p><p>Chapitre 38</p><p>[impots/http-servers/13]</p><p>Version 18 de l\u2019application \u2013 corrige une anomalie de la version 17</p> <p>La version finale de l\u2019exercice d\u2019application est une application client / serveur de calcul de l\u2019imp\u00f4t avec l\u2019architecture suivante\u00a0:</p> <p></p> <p>La couche [web] ci-dessus est impl\u00e9ment\u00e9e avec une architecture MVC\u00a0:</p> <p></p> <p>Le contenu du document est dense. Le lecteur qui ira jusqu\u2019au bout aura une bonne vision de la programmation web MVC en Python / Flask et au-del\u00e0 une bonne vision de la programmation web MVC dans d\u2019autres langages.</p> <p>Le lecteur qui pr\u00e9f\u00e8re voir du code, le tester et le modifier plut\u00f4t que de lire un cours pourra proc\u00e9der ainsi\u00a0:</p> <ul> <li>installer un environnement de travail\u00a0:</li> <li>un interpr\u00e9teur Python\u00a0;</li> <li>l\u2019IDE PyCharm Community\u00a0;</li> <li>Laragon (serveur Apache, SGBD MySQL, serveur Redis)\u00a0;</li> <li>le SGBD PostgreSQL\u00a0;</li> <li>le client HTTP Postman\u00a0;</li> <li>le serveur de mails hMailServer\u00a0;</li> <li>explorer le code des exemples |https://tahe.developpez.com/tutoriels-cours/python-flask-2020/documents/python-flask-2020.rar|\u00a0:</li> <li>dans chaque dossier, on trouve un fichier [README.md] qui lie le dossier \u00e0 un chapitre du cours et r\u00e9sume son contenu\u00a0:</li> </ul> <p></p> <p>Le fichier [README.md] ressemble \u00e0 ceci\u00a0:</p> <p></p> <p>Il est peu probable que le lecteur lise la totalit\u00e9 du cours\u00a0:</p> <ul> <li>le lecteur d\u00e9butant pourra lire les chapitres 1 \u00e0 15 et s\u2019arr\u00eater l\u00e0. Il pourra ensuite passer du temps \u00e0 coder ses propres scripts Python avant de revenir \u00e0 ce cours\u00a0;</li> <li>le lecteur ayant les bases de Python et voulant s\u2019initier aux bases de donn\u00e9es et \u00e0 l\u2019ORM (Object Relational Mapper) [sqlalchemy] pourra se contenter des chapitres 16 \u00e0 20\u00a0;</li> <li>le lecteur voulant s\u2019initier \u00e0 la programmation internet (HTTP, SMTP, POP3, IMAP) pourra lire le chapitre 21. Ce chapitre est assez complexe et montre des scripts avanc\u00e9s. On peut le lire \u00e0 deux niveaux\u00a0:</li> <li>pour d\u00e9couvrir les protocoles de l\u2019internet\u00a0;</li> <li>pour obtenir des scripts exploitant ces protocoles\u00a0;</li> <li>le lecteur ayant les bases de Python et voulant s\u2019initier \u00e0 la programmation web avec le framework Flask lira le chapitre 22\u00a0;</li> <li>le lecteur d\u00e9sirant approfondir la programmation web avec le framework Flask pourra \u00e9tudier les chapitres 23 \u00e0 38. On y construit des applications client / serveur de plus en plus complexes ainsi qu\u2019une application HTML / Python suivant le mod\u00e8le de d\u00e9veloppement MVC (Mod\u00e8le \u2013 Vue \u2013 Contr\u00f4leur). Cette application est d\u00e9velopp\u00e9e au chapitre 32. On pourra s\u2019arr\u00eater l\u00e0. Les chapitres suivants am\u00e8nent des modifications non fondamentales\u00a0; Serge Tah\u00e9, septembre 2020</li> </ul>"},{"location":"clients-web-pour-les-services-json-et-xml-de-la-version-12.html","title":"31. Clients web pour les services jSON et XML de la version 12","text":"<p>Nous allons \u00e9crire trois applications console clientes des services jSON et XML du serveur web que nous venons d\u2019\u00e9crire. Nous reprenons l\u2019architecture client / serveur de la version 11\u00a0:</p> <p></p> <p>Nous \u00e9crirons trois scripts console\u00a0:</p> <ul> <li>les scripts [main] et [main3] utiliseront la couche [m\u00e9tier] du serveur\u00a0;</li> <li>le script [main2] utilisera la couche [m\u00e9tier] du client\u00a0;</li> </ul>"},{"location":"clients-web-pour-les-services-json-et-xml-de-la-version-12.html#311-larborescence-des-scripts-des-clients","title":"31.1. L\u2019arborescence des scripts des clients","text":"<p>Le dossier [http-clients/07] est obtenu initialement par recopie du dossier [http-clients/06]. Il est ensuite modifi\u00e9.</p> <p></p> <ul> <li>en [1]\u00a0: les donn\u00e9es exploit\u00e9es ou cr\u00e9\u00e9es par le client\u00a0;</li> <li>en [2], la configuration et les scripts console du client\u00a0;</li> <li>en [3], la couche [dao] du client\u00a0;</li> <li>en [4], le dossier des tests de la couche [dao] du client\u00a0;</li> </ul>"},{"location":"clients-web-pour-les-services-json-et-xml-de-la-version-12.html#312-la-couche-dao-des-clients","title":"31.2. La couche [dao] des clients","text":""},{"location":"clients-web-pour-les-services-json-et-xml-de-la-version-12.html#3121-interface","title":"31.2.1. Interface","text":"<p>La couche [dao] impl\u00e9mentera l\u2019interface [InterfaceImp\u00f4tsDaoWithHttpSession] suivante\u00a0:</p> <pre><code>from\u00a0abc\u00a0import\u00a0abstractmethod\n\nfrom\u00a0AbstractImp\u00f4tsDao\u00a0import\u00a0AbstractImp\u00f4tsDao\nfrom\u00a0AdminData\u00a0import\u00a0AdminData\nfrom\u00a0TaxPayer\u00a0import\u00a0TaxPayer\n\nclass\u00a0InterfaceImp\u00f4tsDaoWithHttpSession(AbstractImp\u00f4tsDao):\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0par\u00a0unit\u00e9\n\u00a0\u00a0\u00a0\u00a0@abstractmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0calculate_tax(self,\u00a0taxpayer:\u00a0TaxPayer):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0par\u00a0lots\n\u00a0\u00a0\u00a0\u00a0@abstractmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0calculate_tax_in_bulk_mode(self,\u00a0taxpayers:\u00a0list):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0initialisation\u00a0d'une\u00a0session\n\u00a0\u00a0\u00a0\u00a0@abstractmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0init_session(self,\u00a0type_session:\u00a0str):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0fin\u00a0de\u00a0session\n\u00a0\u00a0\u00a0\u00a0@abstractmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0end_session(self):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0authentification\n\u00a0\u00a0\u00a0\u00a0@abstractmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0authenticate_user(self,\u00a0user:\u00a0str,\u00a0password:\u00a0str):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0liste\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0@abstractmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0get_simulations(self)\u00a0-&gt;\u00a0list:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0supprimer\u00a0une\u00a0simulation\n\u00a0\u00a0\u00a0\u00a0@abstractmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0delete_simulation(self,\u00a0id:\u00a0int)\u00a0-&gt;\u00a0list:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0obtenir\u00a0les\u00a0donn\u00e9es\u00a0permettant\u00a0le\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0@abstractmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0get_admindata(self)\u00a0-&gt;\u00a0AdminData:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n</code></pre> <p>Chaque m\u00e9thode de l\u2019interface correspond \u00e0 une URL de service du serveur de calcul de l\u2019imp\u00f4t.</p> <ul> <li>ligne 7\u00a0: l\u2019interface \u00e9tend la classe [AbstractDao] qui g\u00e8re les acc\u00e8s au syst\u00e8me de fichiers\u00a0; La correspondance entre les m\u00e9thodes et les URL de service est faite dans le fichier de configuration [config]\u00a0:</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0serveur\u00a0de\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"server\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"urlServer\":\u00a0\"http://127.0.0.1:5000\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"user\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"login\":\u00a0\"admin\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"admin\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"url_services\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"calculate-tax\":\u00a0\"/calculer-impot\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"get-admindata\":\u00a0\"/get-admindata\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"calculate-tax-in-bulk-mode\":\u00a0\"/calculer-impots\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"init-session\":\u00a0\"/init-session\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"end-session\":\u00a0\"/fin-session\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"authenticate-user\":\u00a0\"/authentifier-utilisateur\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"get-simulations\":\u00a0\"/lister-simulations\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"delete-simulation\":\u00a0\"/supprimer-simulation\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n</code></pre>"},{"location":"clients-web-pour-les-services-json-et-xml-de-la-version-12.html#3122-implementation","title":"31.2.2. Impl\u00e9mentation","text":"<p>L\u2019interface [InterfaceImp\u00f4tsDaoWithHttpSession] est impl\u00e9ment\u00e9e par la classe [Imp\u00f4tsDaoWithHttpSession] suivante\u00a0:</p> <pre><code>#\u00a0imports\nimport\u00a0json\n\nimport\u00a0requests\nimport\u00a0xmltodict\nfrom\u00a0flask_api\u00a0import\u00a0status\n\nfrom\u00a0AbstractImp\u00f4tsDao\u00a0import\u00a0AbstractImp\u00f4tsDao\nfrom\u00a0AdminData\u00a0import\u00a0AdminData\nfrom\u00a0Imp\u00f4tsError\u00a0import\u00a0Imp\u00f4tsError\nfrom\u00a0InterfaceImp\u00f4tsDaoWithHttpSession\u00a0import\u00a0InterfaceImp\u00f4tsDaoWithHttpSession\nfrom\u00a0TaxPayer\u00a0import\u00a0TaxPayer\n\nclass\u00a0Imp\u00f4tsDaoWithHttpSession(InterfaceImp\u00f4tsDaoWithHttpSession):\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0constructeur\n\u00a0\u00a0\u00a0\u00a0def\u00a0__init__(self,\u00a0config:\u00a0dict):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0initialisation\u00a0parent\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0AbstractImp\u00f4tsDao.__init__(self,\u00a0config)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0m\u00e9morisation\u00a0\u00e9l\u00e9ments\u00a0de\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0config\u00a0g\u00e9n\u00e9rale\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__config\u00a0=\u00a0config\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0serveur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__config_server\u00a0=\u00a0config[\"server\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0services\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__config_services\u00a0=\u00a0config[\"server\"]['url_services']\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mode\u00a0debug\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__debug\u00a0=\u00a0config[\"debug\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0logger\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__logger\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0cookies\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__cookies\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0type\u00a0de\u00a0session\u00a0(json,\u00a0xml)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__session_type\u00a0=\u00a0None\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a0request\u00a0/\u00a0response\n\u00a0\u00a0\u00a0\u00a0 def\u00a0get_response(self,\u00a0method:\u00a0str,\u00a0url_service:\u00a0str,\u00a0data_value:\u00a0dict\u00a0=\u00a0None,\u00a0json_value=None):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0[method]\u00a0:\u00a0m\u00e9thode\u00a0HTTP\u00a0GET\u00a0ou\u00a0POST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0[url_service]\u00a0:\u00a0URL\u00a0de\u00a0service\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0[data]\u00a0:\u00a0param\u00e8tres\u00a0du\u00a0POST\u00a0en\u00a0x-www-form-urlencoded\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0[json]\u00a0:\u00a0param\u00e8tres\u00a0du\u00a0POST\u00a0en\u00a0json\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0[cookies]:\u00a0cookies\u00a0\u00e0\u00a0inclure\u00a0dans\u00a0la\u00a0requ\u00eate\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0doit\u00a0avoir\u00a0une\u00a0session\u00a0XML\u00a0ou\u00a0JSON,\u00a0sinon\u00a0on\u00a0ne\u00a0pourra\u00a0pas\u00a0g\u00e9rer\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0self.__session_type\u00a0not\u00a0in\u00a0['json',\u00a0'xml']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0raise\u00a0Imp\u00f4tsError(73,\u00a0\"il\u00a0n'y\u00a0a\u00a0pas\u00a0de\u00a0session\u00a0valide\u00a0en\u00a0cours\")\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0connexion\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0method\u00a0==\u00a0\"GET\":\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0GET\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response\u00a0=\u00a0requests.get(url_service,\u00a0cookies=self.__cookies)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0POST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response\u00a0=\u00a0requests.post(url_service,\u00a0data=data_value,\u00a0json=json_value,\u00a0cookies=self.__cookies)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mode\u00a0debug\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0self.__debug:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0logueur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0self.__logger:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__logger\u00a0=\u00a0self.__config['logger']\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0logue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__logger.write(f\"{response.text}\\n\")\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0self.__session_type\u00a0==\u00a0\"json\":\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0json.loads(response.text)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\u00a0\u00a0#\u00a0xml\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0xmltodict.parse(response.text[39:])['root']\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0cookies\u00a0de\u00a0la\u00a0r\u00e9ponse\u00a0s'il\u00a0y\u00a0en\u00a0a\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0response.cookies:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__cookies\u00a0=\u00a0response.cookies\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0code\u00a0de\u00a0statut\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0status_code\u00a0=\u00a0response.status_code\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0si\u00a0code\u00a0de\u00a0statut\u00a0diff\u00e9rent\u00a0de\u00a0200\u00a0OK\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0status_code\u00a0!=\u00a0status.HTTP_200_OK:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0raise\u00a0Imp\u00f4tsError(35,\u00a0r\u00e9sultat['r\u00e9ponse'])\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0r\u00e9sultat['r\u00e9ponse']\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0init_session(self,\u00a0session_type:\u00a0str):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0le\u00a0type\u00a0de\u00a0la\u00a0session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__session_type\u00a0=\u00a0session_type\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0url\u00a0de\u00a0service\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config_server\u00a0=\u00a0self.__config_server\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_service\u00a0=\u00a0f\"{config_server['urlServer']}{self.__config_services['init-session']}/{session_type}\"\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ex\u00e9cution\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.get_response(\"GET\",\u00a0url_service)\n\u2026\n</code></pre> <ul> <li>lignes 16-34\u00a0: le constructeur de la classe\u00a0;</li> <li>ligne 19\u00a0: la classe parent est initialis\u00e9e\u00a0;</li> <li>lignes 21-28\u00a0: on m\u00e9morise certaines donn\u00e9es de la configuration\u00a0;</li> <li>lignes 29-34\u00a0: on cr\u00e9e trois propri\u00e9t\u00e9s utilis\u00e9es dans les m\u00e9thodes de la classe\u00a0;</li> <li>lignes 36-82\u00a0: la m\u00e9thode [get_response] factorise ce qui est commun \u00e0 toutes les m\u00e9thodes de la couche [dao]\u00a0: l\u2019envoi d\u2019une requ\u00eate HTTP et la r\u00e9cup\u00e9ration de la r\u00e9ponse HTTP du serveur\u00a0;</li> <li>lignes 38-42\u00a0: d\u00e9finition des 5 param\u00e8tres de la m\u00e9thode [get_response]\u00a0;</li> <li>ligne 42\u00a0: on notera que parce que le serveur maintient une session, le client a besoin de lire / renvoyer des cookies\u00a0;</li> <li>lignes 44-46\u00a0: on v\u00e9rifie qu\u2019il y a bien une session en cours valide\u00a0;</li> <li>ligne 51\u00a0: cas du GET. On renvoie les cookies re\u00e7us\u00a0;</li> <li>ligne 54\u00a0: cas du POST. Celui-ci peut avoir deux types de param\u00e8tres\u00a0:</li> <li>le type [x-www-form-urlencoded]. C\u2019est le cas des URL [/calculer-impot] et [/authentifier-utilisateur]. On utilise alors le param\u00e8tre [data_value]\u00a0re\u00e7u par la m\u00e9thode\u00a0;</li> <li> <p>le type [json]. C\u2019est le cas de l\u2019URL [/calculer-impots]. On utilise alors le param\u00e8tre [json_value]\u00a0re\u00e7u par la m\u00e9thode\u00a0; L\u00e0 \u00e9galement, le cookie de session est renvoy\u00e9.</p> </li> <li> <p>lignes 56-62\u00a0: si on est en mode [debug], la r\u00e9ponse du serveur est logu\u00e9e. Ce log est important car il permet de savoir exactement ce qu\u2019a renvoy\u00e9 le serveur\u00a0;</p> </li> <li>lignes 64-68\u00a0: selon que l\u2019on est en mode json ou xml, la r\u00e9ponse texte du serveur est transform\u00e9e en dictionnaire. Prenons l\u2019exemple de l\u2019URL [/init-session]\u00a0: La r\u00e9ponse jSON est la suivante\u00a0:</li> </ul> <pre><code>2020-08-03 11:45:21.218116, MainThread : {\"action\": \"init-session\", \"\u00e9tat\": 700, \"r\u00e9ponse\": [\"session d\u00e9marr\u00e9e avec le type de r\u00e9ponse json\"]}\n</code></pre> <p>La r\u00e9ponse XML est la suivante\u00a0:</p> <pre><code>2020-08-03 11:45:54.671871, MainThread : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;init-session&lt;/action&gt;&lt;\u00e9tat&gt;700&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;session d\u00e9marr\u00e9e avec le type de r\u00e9ponse xml&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n</code></pre> <p>Le code des lignes 64-68 assure que dans les deux cas, on obtient dans [r\u00e9sultat] un dictionnaire avec les cl\u00e9s [action, \u00e9tat, r\u00e9ponse]\u00a0;</p> <ul> <li>lignes 70-72\u00a0: si la r\u00e9ponse contient des cookies on les r\u00e9cup\u00e8re. Il faudra les renvoyer lors de la prochaine requ\u00eate\u00a0;</li> <li>lignes 74-79\u00a0: si le statut HTTP de la r\u00e9ponse est diff\u00e9rent de 200, on l\u00e8ve une exception avec le message d\u2019erreur contenu dans r\u00e9sultat[\u2019r\u00e9ponse\u2019]. Ce peut \u00eatre une erreur ou une liste d\u2019erreurs\u00a0;</li> <li> <p>lignes 81-82\u00a0: on rend la r\u00e9ponse du serveur au code appelant\u00a0; [init_session]</p> </li> <li> <p>ligne 84\u00a0: la m\u00e9thode [init_session] sert \u00e0 fixer le type de session json ou xml que veut commencer le client avec le serveur\u00a0;</p> </li> <li>ligne 86\u00a0: on note le type de session d\u00e9sir\u00e9 au sein de la classe. En effet, toutes les m\u00e9thodes ont besoin de cette information pour d\u00e9coder correctement la r\u00e9ponse du serveur\u00a0;</li> <li>lignes 88-90\u00a0: \u00e0 l\u2019aide de la configuration de l\u2019application, on d\u00e9termine l\u2019URL de service qu\u2019il faut interroger\u00a0;</li> <li>ligne 93\u00a0: l\u2019URL de service est interrog\u00e9e. On ne r\u00e9cup\u00e8re pas le r\u00e9sultat de la m\u00e9thode [get_response]\u00a0:</li> <li>si elle lance une exception, alors l\u2019op\u00e9ration a \u00e9chou\u00e9. L\u2019exception n\u2019est pas g\u00e9r\u00e9e ici et remontera directement au code appelant\u00a0qui arr\u00eatera alors le client avec un message d\u2019erreur\u00a0;</li> <li>si elle ne lance pas d\u2019exception, alors c\u2019est que l\u2019initialisation de la session a r\u00e9ussi\u00a0; [authenticate_user]</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0def\u00a0authenticate_user(self,\u00a0user:\u00a0str,\u00a0password:\u00a0str):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0url\u00a0de\u00a0service\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config_server\u00a0=\u00a0self.__config_server\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_service\u00a0=\u00a0f\"{config_server['urlServer']}{self.__config_services['authenticate-user']}\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0post_params\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"user\":\u00a0user,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0password\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ex\u00e9cution\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.get_response(\"POST\",\u00a0url_service,\u00a0post_params)\n</code></pre> <ul> <li>la m\u00e9thode [authenticate_user] sert \u00e0 s\u2019authentifier aupr\u00e8s du serveur. Pour cela elle re\u00e7oit les identifiants de connexion [user, password] en ligne 1\u00a0;</li> <li>lignes 2-4\u00a0: on d\u00e9termine l\u2019URL de service \u00e0 interroger\u00a0;</li> <li>lignes 5-8\u00a0: les param\u00e8tres du POST puisque l\u2019URL [/authentifier-utilisateur] attend un POST avec des param\u00e8tres [user, password]\u00a0;</li> <li>ligne 11\u00a0: la requ\u00eate est ex\u00e9cut\u00e9e. L\u00e0 encore on ne r\u00e9cup\u00e8re pas la r\u00e9ponse du serveur. C\u2019est l\u2019exception lanc\u00e9e par [get_response] qui indique si on a r\u00e9ussi ou pas\u00a0; [calculate_tax]</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0def\u00a0calculate_tax(self,\u00a0taxpayer:\u00a0TaxPayer):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0url\u00a0de\u00a0service\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config_server\u00a0=\u00a0self.__config_server\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_service\u00a0=\u00a0f\"{config_server['urlServer']}{self.__config_services['calculate-tax']}\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0param\u00e8tres\u00a0du\u00a0POST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0post_params\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"mari\u00e9\":\u00a0taxpayer.mari\u00e9,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"enfants\":\u00a0taxpayer.enfants,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"salaire\":\u00a0taxpayer.salaire\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ex\u00e9cution\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response\u00a0=\u00a0self.get_response(\"POST\",\u00a0url_service,\u00a0post_params)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mise\u00a0\u00e0\u00a0jour\u00a0du\u00a0TaxPayer\u00a0avec\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0taxpayer.fromdict(response)\n</code></pre> <ul> <li>la m\u00e9thode [calculate_tax] permet de calculer l\u2019imp\u00f4t d\u2019un contribuable [taxpayer] pass\u00e9 en param\u00e8tre. Ce param\u00e8tre est modifi\u00e9 par la m\u00e9thode (ligne 15) et constitue donc le r\u00e9sultat de la m\u00e9thode\u00a0;</li> <li>lignes 2-4\u00a0: on d\u00e9finit l\u2019URL de service \u00e0 interroger\u00a0;</li> <li>lignes 6-10\u00a0: les param\u00e8tres du POST \u00e0 \u00e9mettre. En effet, l\u2019URL de service [/calculer-impot] attend un POST avec les param\u00e8tres [mari\u00e9, enfants, salaire]\u00a0;</li> <li>lignes 12-13\u00a0: la requ\u00eate est ex\u00e9cut\u00e9e et la r\u00e9ponse du serveur r\u00e9cup\u00e9r\u00e9e. L\u2019URL de service [/calculer-impot] renvoie un dictionnaire avec les cl\u00e9s [imp\u00f4t, d\u00e9c\u00f4te, surc\u00f4te, r\u00e9duction, taux] de l\u2019imp\u00f4t\u00a0;</li> <li>ligne 15\u00a0: le dictionnaire [response] obtenu est utilis\u00e9 pour mettre \u00e0 jour le contribuable [taxpayer]\u00a0; [calculate_tax_in_bulk_mode]</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0en\u00a0mode\u00a0bulk\n\u00a0\u00a0\u00a0\u00a0def\u00a0calculate_tax_in_bulk_mode(self,\u00a0taxpayers:\u00a0list):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0laisse\u00a0remonter\u00a0les\u00a0exceptions\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0transforme\u00a0les\u00a0taxpayers\u00a0en\u00a0liste\u00a0de\u00a0dictionnaires\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ne\u00a0garde\u00a0que\u00a0les\u00a0propri\u00e9t\u00e9s\u00a0[mari\u00e9,\u00a0enfants,\u00a0salaire]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0list_dict_taxpayers\u00a0=\u00a0list(\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0map(lambda\u00a0taxpayer:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0taxpayer.asdict(included_keys=[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0'_TaxPayer__mari\u00e9',\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0'_TaxPayer__enfants',\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0'_TaxPayer__salaire']),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0taxpayers))\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0url\u00a0de\u00a0service\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config_server\u00a0=\u00a0self.__config_server\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_service\u00a0=\u00a0f\"{config_server['urlServer']}{self.__config_services['calculate-tax-in-bulk-mode']}\"\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ex\u00e9cution\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0list_dict_taxpayers2\u00a0=\u00a0self.get_response(\"POST\",\u00a0url_service,\u00a0data_value=None,\u00a0json_value=list_dict_taxpayers)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0lorsqu'il\u00a0n'y\u00a0a\u00a0qu'un\u00a0contribuable\u00a0et\u00a0qu'on\u00a0est\u00a0dans\u00a0une\u00a0session\u00a0xml,\u00a0[list_dict_taxpayers2]\u00a0n'est\u00a0pas\u00a0une\u00a0liste\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dans\u00a0ce\u00a0cas\u00a0on\u00a0en\u00a0fait\u00a0une\u00a0liste\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0isinstance(list_dict_taxpayers2,\u00a0list):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0list_dict_taxpayers2\u00a0=\u00a0[list_dict_taxpayers2]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0met\u00a0\u00e0\u00a0jour\u00a0la\u00a0liste\u00a0initiale\u00a0des\u00a0taxpayers\u00a0avec\u00a0les\u00a0r\u00e9sultats\u00a0re\u00e7us\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for\u00a0i\u00a0in\u00a0range(len(taxpayers)):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mise\u00a0\u00e0\u00a0jour\u00a0de\u00a0taxpayers[i]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0taxpayers[i].fromdict(list_dict_taxpayers2[i])\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ici\u00a0le\u00a0param\u00e8tre\u00a0[taxpayers]\u00a0a\u00a0\u00e9t\u00e9\u00a0mis\u00a0\u00e0\u00a0jour\u00a0avec\u00a0les\u00a0r\u00e9sultats\u00a0du\u00a0serveur\n</code></pre> <ul> <li>ligne 2\u00a0: la m\u00e9thode re\u00e7oit une liste de contribuables\u00a0de type TaxPayer\u00a0;</li> <li>lignes 7-13\u00a0: cette liste d\u2019\u00e9lements de type [TaxPayer] est transform\u00e9e en liste de dictionnaires [mari\u00e9, enfants, salaire]\u00a0;</li> <li>lignes 15-17\u00a0: on fixe l\u2019URL de service\u00a0;</li> <li>lignes 19-20\u00a0: on ex\u00e9cute une requ\u00eate POST dont le corps jSON est form\u00e9 de la liste des dictionnaires cr\u00e9\u00e9e ligne 7. On r\u00e9cup\u00e8re la r\u00e9ponse du serveur\u00a0;</li> <li>lignes 23-24\u00a0: les tests ont montr\u00e9 un probl\u00e8me lorsque la session est de type XML\u00a0:</li> <li>si la liste initiale des contribuables a N \u00e9l\u00e9ments (N&gt;1) on obtient comme r\u00e9sultat une liste de N dictionnaires de type [OrderedDict]\u00a0;</li> <li> <p>si la liste initiale n\u2019a qu\u2019un \u00e9l\u00e9ment, on obtient non pas une liste mais un \u00e9l\u00e9ment de type [OrderedDict]\u00a0; lignes 23-24\u00a0: si on est dans ce dernier cas (1 \u00e9l\u00e9ment), on transforme le r\u00e9sultat en liste de 1 \u00e9l\u00e9ment\u00a0;</p> </li> <li> <p>lignes 25-28\u00a0: cette liste de dictionnaires re\u00e7us contient l\u2019imp\u00f4t de chaque contribuable de la liste initiale. On met \u00e0 jour alors chacun d\u2019eux avec les r\u00e9sultats re\u00e7us\u00a0; [get_simulations]</p> </li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0def\u00a0get_simulations(self)\u00a0-&gt;\u00a0list:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0url\u00a0de\u00a0service\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config_server\u00a0=\u00a0self.__config_server\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_service\u00a0=\u00a0f\"{config_server['urlServer']}{self.__config_services['get-simulations']}\"\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ex\u00e9cution\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0self.get_response(\"GET\",\u00a0url_service)\n</code></pre> <ul> <li>ligne 1\u00a0: la m\u00e9thode demande la liste des simulations faites dans la session courante\u00a0;</li> <li>ligne 2\u00a0: la m\u00e9thode rend la r\u00e9ponse du serveur\u00a0; [delete_simulation]</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0def\u00a0delete_simulation(self,\u00a0id:\u00a0int)\u00a0-&gt;\u00a0list:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0url\u00a0de\u00a0service\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config_server\u00a0=\u00a0self.__config_server\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_service\u00a0=\u00a0f\"{config_server['urlServer']}{self.__config_services['delete-simulation']}/{id}\"\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ex\u00e9cution\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0self.get_response(\"GET\",\u00a0url_service)\n</code></pre> <ul> <li>ligne 1\u00a0: la m\u00e9thode supprime la simulation dont on passe l\u2019identifiant\u00a0;</li> <li>ligne 7\u00a0: elle rend la r\u00e9ponse du serveur, la liste des simulations restantes apr\u00e8s la suppression demand\u00e9e\u00a0; [get-admindata]</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0def\u00a0get_admindata(self)\u00a0-&gt;\u00a0AdminData:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0laisse\u00a0remonter\u00a0les\u00a0exceptions\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0url\u00a0de\u00a0service\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config_server\u00a0=\u00a0self.__config_server\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_service\u00a0=\u00a0f\"{config_server['urlServer']}{self.__config_services['get-admindata']}\"\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ex\u00e9cution\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0self.get_response(\"GET\",\u00a0url_service)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9sultat\u00a0est\u00a0un\u00a0dictionnaire\u00a0de\u00a0valeurs\u00a0de\u00a0type\u00a0str\u00a0si\u00a0session\u00a0xml\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0self.__session_type\u00a0==\u00a0'xml':\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0nouveau\u00a0dictionnaire\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat2\u00a0=\u00a0{}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0passe\u00a0tout\u00a0en\u00a0num\u00e9rique\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for\u00a0key,\u00a0value\u00a0in\u00a0r\u00e9sultat.items():\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0certains\u00a0\u00e9l\u00e9ments\u00a0du\u00a0dictionnaire\u00a0sont\u00a0des\u00a0listes\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0isinstance(value,\u00a0list):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0values\u00a0=\u00a0[]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for\u00a0value2\u00a0in\u00a0value:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0values.append(float(value2))\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat2[key]\u00a0=\u00a0values\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0d'autres\u00a0de\u00a0simples\u00a0\u00e9l\u00e9ments\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat2[key]\u00a0=\u00a0float(value)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat2\u00a0=\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9sultat\u00a0de\u00a0type\u00a0AdminData\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0AdminData().fromdict(r\u00e9sultat2)\n</code></pre> <ul> <li>ligne 1\u00a0: la m\u00e9thode demande au serveur les constantes fiscales permettant le calcul de l\u2019imp\u00f4t\u00a0;</li> <li>ligne 29\u00a0: elle rend un type [AdminData]\u00a0;</li> <li>ligne 9\u00a0: on r\u00e9cup\u00e8re la r\u00e9ponse du serveur sous la forme d\u2019un dictionnaire. Les tests montrent qu\u2019il y a un probl\u00e8me lorsque la session est une session XML\u00a0: au lieu d\u2019\u00eatre des valeurs num\u00e9riques, les valeurs du dictionnaire sont des cha\u00eenes de caract\u00e8res. Nous avions signal\u00e9 ce probl\u00e8me lors de l\u2019\u00e9tude du module [xmltodict] et constat\u00e9 que c\u2019\u00e9tait un fonctionnement normal. [xmltodict] n\u2019a pas d\u2019informations de types dans le flux XML qu\u2019on lui donne. Ceci dit, dans ce cas pr\u00e9cis, il faut convertir en num\u00e9rique toutes les valeurs du dictionnaire re\u00e7u. Celui-ci contient trois listes [limites, coeffr, coeffn] et une suite de propri\u00e9t\u00e9s num\u00e9riques\u00a0;</li> <li>lignes 13-25\u00a0: cr\u00e9ation d\u2019un dictionnaire [r\u00e9sultat2] \u00e0 valeurs num\u00e9riques \u00e0 partir du dictionnaire [r\u00e9sultat] \u00e0 valeurs de type cha\u00eene de caract\u00e8res\u00a0;</li> <li>ligne 29\u00a0: le dictionnaire [resultat2] est utilis\u00e9 pour initialiser un type [AdminData]\u00a0;</li> </ul>"},{"location":"clients-web-pour-les-services-json-et-xml-de-la-version-12.html#3123-la-factory-de-la-couche-dao","title":"31.2.3. La factory de la couche [dao]","text":"<p>Nos clients seront multi-thread\u00e9s. Comme la couche [dao] est impl\u00e9ment\u00e9e par une classe ayant un \u00e9tat en lecture / \u00e9criture (= des propri\u00e9t\u00e9s en lecture / \u00e9criture), chaque thread doit avoir sa propre couche [dao] ou alors il faut synchroniser l\u2019acc\u00e8s aux donn\u00e9es partag\u00e9es entre les threads. Ici nous prenons la premi\u00e8re solution. Nous utilisons une classe [Imp\u00f4tsDaoWithHttpSessionFactory] capable de cr\u00e9er des instances de la couche [dao]\u00a0:</p> <pre><code>from\u00a0Imp\u00f4tsDaoWithHttpSession\u00a0import\u00a0Imp\u00f4tsDaoWithHttpSession\n\nclass\u00a0Imp\u00f4tsDaoWithHttpSessionFactory:\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0__init__(self,\u00a0config:\u00a0dict):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0m\u00e9morise\u00a0le\u00a0param\u00e8tre\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__config\u00a0=\u00a0config\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0new_instance(self):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0une\u00a0instance\u00a0de\u00a0la\u00a0couche\u00a0[dao]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0Imp\u00f4tsDaoWithHttpSession(self.__config)\n</code></pre>"},{"location":"clients-web-pour-les-services-json-et-xml-de-la-version-12.html#313-configuration-des-clients","title":"31.3. Configuration des clients","text":"<p>Les clients sont configur\u00e9s par les fichiers [config] et [config_layers]. Le fichier [config] est le suivant\u00a0:</p> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a01\u00a0------\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0de\u00a0ce\u00a0fichier\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0racine\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020\"\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\u00a0absolues\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossiers\u00a0du\u00a0projet\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0BaseEntity,\u00a0MyException\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/classes/02/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0InterfaceImp\u00f4tsDao,\u00a0InterfaceImp\u00f4tsM\u00e9tier,\u00a0InterfaceImp\u00f4tsUi\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AbstractImp\u00f4tsdao,\u00a0Imp\u00f4tsConsole,\u00a0Imp\u00f4tsM\u00e9tier\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ImpotsDaoWithAdminDataInDatabase\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AdminData,\u00a0Imp\u00f4tsError,\u00a0TaxPayer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Constantes,\u00a0tranches\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Imp\u00f4tsDaoWithHttpSession,\u00a0Imp\u00f4tsDaoWithHttpSessionFactory,\u00a0InterfaceImp\u00f4tsDaoWithHttpSession\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0scripts\u00a0de\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0script_dir,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Logger\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/http-servers/02/utilities\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fixe\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a02\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\u00a0avec\u00a0des\u00a0constantes\n\u00a0\u00a0\u00a0\u00a0config.update({\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0des\u00a0contribuables\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"taxpayersFilename\":\u00a0f\"{script_dir}/../data/input/taxpayersdata.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0des\u00a0r\u00e9sultats\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"resultsFilename\":\u00a0f\"{script_dir}/../data/output/r\u00e9sultats.json\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0des\u00a0erreurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"errorsFilename\":\u00a0f\"{script_dir}/../data/output/errors.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0de\u00a0logs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"logsFilename\":\u00a0f\"{script_dir}/../data/logs/logs.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0serveur\u00a0de\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"server\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"urlServer\":\u00a0\"http://127.0.0.1:5000\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"user\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"login\":\u00a0\"admin\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"admin\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"url_services\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"calculate-tax\":\u00a0\"/calculer-impot\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"get-admindata\":\u00a0\"/get-admindata\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"calculate-tax-in-bulk-mode\":\u00a0\"/calculer-impots\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"init-session\":\u00a0\"/init-session\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"end-session\":\u00a0\"/fin-session\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"authenticate-user\":\u00a0\"/authentifier-utilisateur\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"get-simulations\":\u00a0\"/lister-simulations\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"delete-simulation\":\u00a0\"/supprimer-simulation\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mode\u00a0debug\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"debug\":\u00a0True\n\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a03\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\n\u00a0\u00a0\u00a0\u00a0import\u00a0config_layers\n\u00a0\u00a0\u00a0\u00a0config['layers']\u00a0=\u00a0config_layers.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuation\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <p>Le fichier [config_layers] est le suivant\u00a0:</p> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\u00a0de\u00a0l'applicatuon\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0couche\u00a0[m\u00e9tier]\n\u00a0\u00a0\u00a0\u00a0from\u00a0Imp\u00f4tsM\u00e9tier\u00a0import\u00a0Imp\u00f4tsM\u00e9tier\n\u00a0\u00a0\u00a0\u00a0m\u00e9tier\u00a0=\u00a0Imp\u00f4tsM\u00e9tier()\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0factory\u00a0de\u00a0la\u00a0couche\u00a0dao\n\u00a0\u00a0\u00a0\u00a0from\u00a0Imp\u00f4tsDaoWithHttpSessionFactory\u00a0import\u00a0Imp\u00f4tsDaoWithHttpSessionFactory\n\u00a0\u00a0\u00a0\u00a0dao_factory\u00a0=\u00a0Imp\u00f4tsDaoWithHttpSessionFactory(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\u00a0des\u00a0couches\n\u00a0\u00a0\u00a0\u00a0return\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"dao_factory\":\u00a0dao_factory,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"m\u00e9tier\":\u00a0m\u00e9tier\n\u00a0\u00a0\u00a0\u00a0}\n</code></pre> <ul> <li>les clients n\u2019auront pas un acc\u00e8s direct \u00e0 la couche [dao]. Pour en avoir une, ils devront passer par la factory de la couche [dao]\u00a0;</li> </ul>"},{"location":"clients-web-pour-les-services-json-et-xml-de-la-version-12.html#314-le-client-main","title":"31.4. Le client [main]","text":"<p>Le client [main] permet de tester les URL [/init-session, /authentifier-utilisateur, /calculer-impots, /fin-session]\u00a0:</p> <pre><code>#\u00a0on\u00a0attend\u00a0un\u00a0param\u00e8tre\u00a0json\u00a0ou\u00a0xml\nimport\u00a0sys\n\nsyntaxe\u00a0=\u00a0f\"{sys.argv[0]}\u00a0json\u00a0/\u00a0xml\"\nerreur\u00a0=\u00a0len(sys.argv)\u00a0!=\u00a02\nif\u00a0not\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0session_type\u00a0=\u00a0sys.argv[1].lower()\n\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0session_type\u00a0!=\u00a0\"json\"\u00a0and\u00a0session_type\u00a0!=\u00a0\"xml\"\nif\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0print(f\"syntaxe\u00a0:\u00a0{syntaxe}\")\n\u00a0\u00a0\u00a0\u00a0sys.exit()\n\n#\u00a0on\u00a0configure\u00a0l'application\nimport\u00a0config\nconfig\u00a0=\u00a0config.configure({\"session_type\":\u00a0session_type})\n\n#\u00a0d\u00e9pendances\nfrom\u00a0Imp\u00f4tsError\u00a0import\u00a0Imp\u00f4tsError\nimport\u00a0random\nimport\u00a0sys\nimport\u00a0threading\nfrom\u00a0Logger\u00a0import\u00a0Logger\n\n#\u00a0ex\u00e9cution\u00a0de\u00a0la\u00a0couche\u00a0[dao]\u00a0dans\u00a0un\u00a0thread\n#\u00a0taxpayers\u00a0est\u00a0une\u00a0liste\u00a0de\u00a0contribuables\ndef\u00a0thread_function(config:\u00a0dict,\u00a0taxpayers:\u00a0list):\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0la\u00a0factory\u00a0de\u00a0la\u00a0couche\u00a0[dao]\n\u00a0\u00a0\u00a0\u00a0dao_factory\u00a0=\u00a0config['layers']['dao_factory']\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0cr\u00e9e\u00a0une\u00a0instance\u00a0de\u00a0couche\u00a0[dao]\n\u00a0\u00a0\u00a0\u00a0dao\u00a0=\u00a0dao_factory.new_instance()\n\u00a0\u00a0\u00a0\u00a0#\u00a0type\u00a0de\u00a0la\u00a0session\n\u00a0\u00a0\u00a0\u00a0session_type\u00a0=\u00a0config['session_type']\n\u00a0\u00a0\u00a0\u00a0#\u00a0nombre\u00a0de\u00a0contribuables\n\u00a0\u00a0\u00a0\u00a0nb_taxpayers\u00a0=\u00a0len(taxpayers)\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\n\u00a0\u00a0\u00a0\u00a0logger.write(f\"d\u00e9but\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0des\u00a0{nb_taxpayers}\u00a0contribuables\\n\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0initialise\u00a0la\u00a0session\n\u00a0\u00a0\u00a0\u00a0dao.init_session(session_type)\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0s'authentifie\n\u00a0\u00a0\u00a0\u00a0dao.authenticate_user(config['server']['user']['login'],\u00a0config['server']['user']['password'])\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0calcule\u00a0l'imp\u00f4t\u00a0des\u00a0contribuables\n\u00a0\u00a0\u00a0\u00a0dao.calculate_tax_in_bulk_mode(taxpayers)\n\u00a0\u00a0\u00a0\u00a0#\u00a0fin\u00a0de\u00a0session\n\u00a0\u00a0\u00a0\u00a0dao.end_session()\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\n\u00a0\u00a0\u00a0\u00a0logger.write(f\"fin\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0des\u00a0{nb_taxpayers}\u00a0contribuables\\n\")\n\n#\u00a0liste\u00a0des\u00a0threads\u00a0du\u00a0client\nthreads\u00a0=\u00a0[]\nlogger\u00a0=\u00a0None\n#\u00a0code\ntry:\n\u00a0\u00a0\u00a0\u00a0#\u00a0logger\n\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0Logger(config[\"logsFilename\"])\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0le\u00a0m\u00e9morise\u00a0dans\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0config[\"logger\"]\u00a0=\u00a0logger\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0de\u00a0d\u00e9but\n\u00a0\u00a0\u00a0\u00a0logger.write(\"d\u00e9but\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0des\u00a0contribuables\\n\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0la\u00a0factory\u00a0de\u00a0la\u00a0couche\u00a0[dao]\n\u00a0\u00a0\u00a0\u00a0dao_factory\u00a0=\u00a0config[\"layers\"][\"dao_factory\"]\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0cr\u00e9e\u00a0une\u00a0instance\u00a0de\u00a0la\u00a0couche\u00a0[dao]\n\u00a0\u00a0\u00a0\u00a0dao\u00a0=\u00a0dao_factory.new_instance()\n\u00a0\u00a0\u00a0\u00a0#\u00a0lecture\u00a0des\u00a0donn\u00e9es\u00a0des\u00a0contribuables\n\u00a0\u00a0\u00a0\u00a0taxpayers\u00a0=\u00a0dao.get_taxpayers_data()[\"taxpayers\"]\n\u00a0\u00a0\u00a0\u00a0#\u00a0des\u00a0contribuables\u00a0?\n\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0taxpayers:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0raise\u00a0Imp\u00f4tsError(36,\u00a0f\"Pas\u00a0de\u00a0contribuables\u00a0valides\u00a0dans\u00a0le\u00a0fichier\u00a0{config['taxpayersFilename']}\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0des\u00a0contribuables\u00a0avec\u00a0plusieurs\u00a0threads\n\u00a0\u00a0\u00a0\u00a0i\u00a0=\u00a00\n\u00a0\u00a0\u00a0\u00a0l_taxpayers\u00a0=\u00a0len(taxpayers)\n\u00a0\u00a0\u00a0\u00a0while\u00a0i\u00a0&lt;\u00a0len(taxpayers):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0chaque\u00a0thread\u00a0va\u00a0traiter\u00a0de\u00a01\u00a0\u00e0\u00a04\u00a0contribuables\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0nb_taxpayers\u00a0=\u00a0min(l_taxpayers\u00a0-\u00a0i,\u00a0random.randint(1,\u00a04))\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0liste\u00a0des\u00a0contribuables\u00a0trait\u00e9s\u00a0par\u00a0le\u00a0thread\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0thread_taxpayers\u00a0=\u00a0taxpayers[slice(i,\u00a0i\u00a0+\u00a0nb_taxpayers)]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0incr\u00e9mente\u00a0i\u00a0pour\u00a0le\u00a0thread\u00a0suivant\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0i\u00a0+=\u00a0nb_taxpayers\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0cr\u00e9e\u00a0le\u00a0thread\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0thread\u00a0=\u00a0threading.Thread(target=thread_function,\u00a0args=(config,\u00a0thread_taxpayers))\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0l'ajoute\u00a0\u00e0\u00a0la\u00a0liste\u00a0des\u00a0threads\u00a0du\u00a0script\u00a0principal\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0threads.append(thread)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0lance\u00a0le\u00a0thread\u00a0-\u00a0cette\u00a0op\u00e9ration\u00a0est\u00a0asynchrone\u00a0-\u00a0on\u00a0n'attend\u00a0pas\u00a0le\u00a0r\u00e9sultat\u00a0du\u00a0thread\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0thread.start()\n\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0thread\u00a0principal\u00a0attend\u00a0la\u00a0fin\u00a0de\u00a0tous\u00a0les\u00a0threads\u00a0qu'il\u00a0a\u00a0lanc\u00e9s\n\u00a0\u00a0\u00a0\u00a0for\u00a0thread\u00a0in\u00a0threads:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0thread.join()\n\u00a0\u00a0\u00a0\u00a0#\u00a0ici\u00a0tous\u00a0les\u00a0threads\u00a0ont\u00a0fini\u00a0leur\u00a0travail\u00a0-\u00a0chacun\u00a0a\u00a0modifi\u00e9\u00a0un\u00a0ou\u00a0plusieurs\u00a0objets\u00a0[taxpayer]\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0enregistre\u00a0les\u00a0r\u00e9sultats\u00a0dans\u00a0le\u00a0fichier\u00a0jSON\n\u00a0\u00a0\u00a0\u00a0dao.write_taxpayers_results(taxpayers)\n\u00a0\u00a0\u00a0\u00a0#\u00a0fin\nexcept\u00a0BaseException\u00a0as\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0de\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0print(f\"L'erreur\u00a0suivante\u00a0s'est\u00a0produite\u00a0:\u00a0{erreur}\")\nfinally:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ferme\u00a0le\u00a0logueur\n\u00a0\u00a0\u00a0\u00a0if\u00a0logger:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0de\u00a0fin\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(\"fin\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0des\u00a0contribuables\\n\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fermeture\u00a0du\u00a0logueur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.close()\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0a\u00a0fini\n\u00a0\u00a0\u00a0\u00a0print(\"Travail\u00a0termin\u00e9...\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0fin\u00a0des\u00a0threads\u00a0qui\u00a0pourraient\u00a0encore\u00a0exister\u00a0si\u00a0on\u00a0s'est\u00a0arr\u00eat\u00e9\u00a0sur\u00a0erreur\n\u00a0\u00a0\u00a0\u00a0sys.exit()\n</code></pre> <ul> <li>lignes 4-11\u00a0: le client attend un param\u00e8tre lui indiquant le type de session, json ou xml, \u00e0 utiliser avec le serveur\u00a0;</li> <li>lignes 13-15\u00a0: le client est configur\u00e9\u00a0;</li> <li>lignes 48-104\u00a0: ce code est connu. Il a \u00e9t\u00e9 utilis\u00e9 de nombreuses fois. Il r\u00e9partit les contribuables pour lesquels on veut calculer l\u2019imp\u00f4t sur plusieurs threads\u00a0;</li> <li>ligne 26\u00a0: la m\u00e9thode [thread_function] est la m\u00e9thode ex\u00e9cut\u00e9e par chaque thread pour calculer l\u2019imp\u00f4t des contribuables qui lui ont \u00e9t\u00e9 attribu\u00e9s\u00a0;</li> <li>lignes 27-30\u00a0: chaque thread a sa propre couche [dao]\u00a0;</li> <li>le calcul de l\u2019imp\u00f4t se fait en quatre \u00e9tapes\u00a0:</li> <li>lignes 37-38\u00a0: initialisation d\u2019une session, json ou xml, avec le serveur\u00a0;</li> <li>lignes 39-40\u00a0: authentification aupr\u00e8s du serveur\u00a0;</li> <li>lignes 41-42\u00a0: calcul de l\u2019imp\u00f4t\u00a0;</li> <li>lignes 43-44\u00a0: fermeture de la session avec le serveur\u00a0; Lorsqu\u2019on ex\u00e9cute ce code en mode [json], on obtient les logs suivants\u00a0:</li> </ul> <pre><code>2020-08-03 14:28:34.320751, MainThread : d\u00e9but du calcul de l'imp\u00f4t des contribuables\n2020-08-03 14:28:34.328749, Thread-1 : d\u00e9but du calcul de l'imp\u00f4t des 4 contribuables\n2020-08-03 14:28:34.328749, Thread-2 : d\u00e9but du calcul de l'imp\u00f4t des 4 contribuables\n2020-08-03 14:28:34.333592, Thread-3 : d\u00e9but du calcul de l'imp\u00f4t des 3 contribuables\n2020-08-03 14:28:34.368651, Thread-2 : {\"action\": \"init-session\", \"\u00e9tat\": 700, \"r\u00e9ponse\": [\"session d\u00e9marr\u00e9e avec le type de r\u00e9ponse json\"]}\n2020-08-03 14:28:34.375699, Thread-1 : {\"action\": \"init-session\", \"\u00e9tat\": 700, \"r\u00e9ponse\": [\"session d\u00e9marr\u00e9e avec le type de r\u00e9ponse json\"]}\n2020-08-03 14:28:34.377432, Thread-3 : {\"action\": \"init-session\", \"\u00e9tat\": 700, \"r\u00e9ponse\": [\"session d\u00e9marr\u00e9e avec le type de r\u00e9ponse json\"]}\n2020-08-03 14:28:34.385653, Thread-2 : {\"action\": \"authentifier-utilisateur\", \"\u00e9tat\": 200, \"r\u00e9ponse\": \"Authentification r\u00e9ussie\"}\n2020-08-03 14:28:34.392656, Thread-1 : {\"action\": \"authentifier-utilisateur\", \"\u00e9tat\": 200, \"r\u00e9ponse\": \"Authentification r\u00e9ussie\"}\n2020-08-03 14:28:34.396377, Thread-3 : {\"action\": \"authentifier-utilisateur\", \"\u00e9tat\": 200, \"r\u00e9ponse\": \"Authentification r\u00e9ussie\"}\n2020-08-03 14:28:34.406528, Thread-2 : {\"action\": \"calculer-impots\", \"\u00e9tat\": 1500, \"r\u00e9ponse\": [{\"mari\u00e9\": \"non\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 16782, \"surc\u00f4te\": 7176, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 1}, {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 9200, \"surc\u00f4te\": 2180, \"taux\": 0.3, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 2}, {\"mari\u00e9\": \"oui\", \"enfants\": 5, \"salaire\": 100000, \"imp\u00f4t\": 4230, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 3}, {\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 100000, \"imp\u00f4t\": 22986, \"surc\u00f4te\": 0, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 4}]}\n2020-08-03 14:28:34.413837, Thread-1 : {\"action\": \"calculer-impots\", \"\u00e9tat\": 1500, \"r\u00e9ponse\": [{\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555, \"imp\u00f4t\": 2814, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 1}, {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 50000, \"imp\u00f4t\": 1384, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 384, \"r\u00e9duction\": 347, \"id\": 2}, {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 50000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 720, \"r\u00e9duction\": 0, \"id\": 3}, {\"mari\u00e9\": \"non\", \"enfants\": 2, \"salaire\": 100000, \"imp\u00f4t\": 19884, \"surc\u00f4te\": 4480, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 4}]}\n2020-08-03 14:28:34.416695, Thread-3 : {\"action\": \"calculer-impots\", \"\u00e9tat\": 1500, \"r\u00e9ponse\": [{\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 30000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.0, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 1}, {\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 200000, \"imp\u00f4t\": 64210, \"surc\u00f4te\": 7498, \"taux\": 0.45, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 2}, {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000, \"imp\u00f4t\": 42842, \"surc\u00f4te\": 17283, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 3}]}\n2020-08-03 14:28:34.425747, Thread-2 : {\"action\": \"fin-session\", \"\u00e9tat\": 400, \"r\u00e9ponse\": \"session r\u00e9initialis\u00e9e\"}\n2020-08-03 14:28:34.425747, Thread-2 : fin du calcul de l'imp\u00f4t des 4 contribuables\n2020-08-03 14:28:34.428956, Thread-1 : {\"action\": \"fin-session\", \"\u00e9tat\": 400, \"r\u00e9ponse\": \"session r\u00e9initialis\u00e9e\"}\n2020-08-03 14:28:34.428956, Thread-1 : fin du calcul de l'imp\u00f4t des 4 contribuables\n2020-08-03 14:28:34.428956, Thread-3 : {\"action\": \"fin-session\", \"\u00e9tat\": 400, \"r\u00e9ponse\": \"session r\u00e9initialis\u00e9e\"}\n2020-08-03 14:28:34.428956, Thread-3 : fin du calcul de l'imp\u00f4t des 3 contribuables\n2020-08-03 14:28:34.428956, MainThread : fin du calcul de l'imp\u00f4t des contribuables\n</code></pre> <p>On voit ci-dessus le parcours du thread [Thread-2].</p> <p>Si on ex\u00e9cute [main] en mode XML, les logs sont les suivants\u00a0:</p> <pre><code>2020-08-03 14:32:48.495316, MainThread : d\u00e9but du calcul de l'imp\u00f4t des contribuables\n2020-08-03 14:32:48.496452, Thread-1 : d\u00e9but du calcul de l'imp\u00f4t des 2 contribuables\n2020-08-03 14:32:48.498992, Thread-2 : d\u00e9but du calcul de l'imp\u00f4t des 2 contribuables\n2020-08-03 14:32:48.498992, Thread-3 : d\u00e9but du calcul de l'imp\u00f4t des 4 contribuables\n2020-08-03 14:32:48.498992, Thread-4 : d\u00e9but du calcul de l'imp\u00f4t des 3 contribuables\n2020-08-03 14:32:48.538637, Thread-1 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;init-session&lt;/action&gt;&lt;\u00e9tat&gt;700&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;session d\u00e9marr\u00e9e avec le type de r\u00e9ponse xml&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.540783, Thread-4 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;init-session&lt;/action&gt;&lt;\u00e9tat&gt;700&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;session d\u00e9marr\u00e9e avec le type de r\u00e9ponse xml&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.547811, Thread-3 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;init-session&lt;/action&gt;&lt;\u00e9tat&gt;700&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;session d\u00e9marr\u00e9e avec le type de r\u00e9ponse xml&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.547811, Thread-2 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;init-session&lt;/action&gt;&lt;\u00e9tat&gt;700&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;session d\u00e9marr\u00e9e avec le type de r\u00e9ponse xml&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.555184, Thread-1 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;authentifier-utilisateur&lt;/action&gt;&lt;\u00e9tat&gt;200&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;Authentification r\u00e9ussie&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.564793, Thread-2 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;authentifier-utilisateur&lt;/action&gt;&lt;\u00e9tat&gt;200&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;Authentification r\u00e9ussie&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.564793, Thread-3 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;authentifier-utilisateur&lt;/action&gt;&lt;\u00e9tat&gt;200&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;Authentification r\u00e9ussie&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.568333, Thread-4 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;authentifier-utilisateur&lt;/action&gt;&lt;\u00e9tat&gt;200&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;Authentification r\u00e9ussie&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.568333, Thread-1 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;calculer-impots&lt;/action&gt;&lt;\u00e9tat&gt;1500&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;&lt;mari\u00e9&gt;oui&lt;/mari\u00e9&gt;&lt;enfants&gt;2&lt;/enfants&gt;&lt;salaire&gt;55555&lt;/salaire&gt;&lt;imp\u00f4t&gt;2814&lt;/imp\u00f4t&gt;&lt;surc\u00f4te&gt;0&lt;/surc\u00f4te&gt;&lt;taux&gt;0.14&lt;/taux&gt;&lt;d\u00e9c\u00f4te&gt;0&lt;/d\u00e9c\u00f4te&gt;&lt;r\u00e9duction&gt;0&lt;/r\u00e9duction&gt;&lt;id&gt;1&lt;/id&gt;&lt;/r\u00e9ponse&gt;&lt;r\u00e9ponse&gt;&lt;mari\u00e9&gt;oui&lt;/mari\u00e9&gt;&lt;enfants&gt;2&lt;/enfants&gt;&lt;salaire&gt;50000&lt;/salaire&gt;&lt;imp\u00f4t&gt;1384&lt;/imp\u00f4t&gt;&lt;surc\u00f4te&gt;0&lt;/surc\u00f4te&gt;&lt;taux&gt;0.14&lt;/taux&gt;&lt;d\u00e9c\u00f4te&gt;384&lt;/d\u00e9c\u00f4te&gt;&lt;r\u00e9duction&gt;347&lt;/r\u00e9duction&gt;&lt;id&gt;2&lt;/id&gt;&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.579205, Thread-2 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;calculer-impots&lt;/action&gt;&lt;\u00e9tat&gt;1500&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;&lt;mari\u00e9&gt;oui&lt;/mari\u00e9&gt;&lt;enfants&gt;3&lt;/enfants&gt;&lt;salaire&gt;50000&lt;/salaire&gt;&lt;imp\u00f4t&gt;0&lt;/imp\u00f4t&gt;&lt;surc\u00f4te&gt;0&lt;/surc\u00f4te&gt;&lt;taux&gt;0.14&lt;/taux&gt;&lt;d\u00e9c\u00f4te&gt;720&lt;/d\u00e9c\u00f4te&gt;&lt;r\u00e9duction&gt;0&lt;/r\u00e9duction&gt;&lt;id&gt;1&lt;/id&gt;&lt;/r\u00e9ponse&gt;&lt;r\u00e9ponse&gt;&lt;mari\u00e9&gt;non&lt;/mari\u00e9&gt;&lt;enfants&gt;2&lt;/enfants&gt;&lt;salaire&gt;100000&lt;/salaire&gt;&lt;imp\u00f4t&gt;19884&lt;/imp\u00f4t&gt;&lt;surc\u00f4te&gt;4480&lt;/surc\u00f4te&gt;&lt;taux&gt;0.41&lt;/taux&gt;&lt;d\u00e9c\u00f4te&gt;0&lt;/d\u00e9c\u00f4te&gt;&lt;r\u00e9duction&gt;0&lt;/r\u00e9duction&gt;&lt;id&gt;2&lt;/id&gt;&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.579205, Thread-3 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;calculer-impots&lt;/action&gt;&lt;\u00e9tat&gt;1500&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;&lt;mari\u00e9&gt;non&lt;/mari\u00e9&gt;&lt;enfants&gt;3&lt;/enfants&gt;&lt;salaire&gt;100000&lt;/salaire&gt;&lt;imp\u00f4t&gt;16782&lt;/imp\u00f4t&gt;&lt;surc\u00f4te&gt;7176&lt;/surc\u00f4te&gt;&lt;taux&gt;0.41&lt;/taux&gt;&lt;d\u00e9c\u00f4te&gt;0&lt;/d\u00e9c\u00f4te&gt;&lt;r\u00e9duction&gt;0&lt;/r\u00e9duction&gt;&lt;id&gt;1&lt;/id&gt;&lt;/r\u00e9ponse&gt;&lt;r\u00e9ponse&gt;&lt;mari\u00e9&gt;oui&lt;/mari\u00e9&gt;&lt;enfants&gt;3&lt;/enfants&gt;&lt;salaire&gt;100000&lt;/salaire&gt;&lt;imp\u00f4t&gt;9200&lt;/imp\u00f4t&gt;&lt;surc\u00f4te&gt;2180&lt;/surc\u00f4te&gt;&lt;taux&gt;0.3&lt;/taux&gt;&lt;d\u00e9c\u00f4te&gt;0&lt;/d\u00e9c\u00f4te&gt;&lt;r\u00e9duction&gt;0&lt;/r\u00e9duction&gt;&lt;id&gt;2&lt;/id&gt;&lt;/r\u00e9ponse&gt;&lt;r\u00e9ponse&gt;&lt;mari\u00e9&gt;oui&lt;/mari\u00e9&gt;&lt;enfants&gt;5&lt;/enfants&gt;&lt;salaire&gt;100000&lt;/salaire&gt;&lt;imp\u00f4t&gt;4230&lt;/imp\u00f4t&gt;&lt;surc\u00f4te&gt;0&lt;/surc\u00f4te&gt;&lt;taux&gt;0.14&lt;/taux&gt;&lt;d\u00e9c\u00f4te&gt;0&lt;/d\u00e9c\u00f4te&gt;&lt;r\u00e9duction&gt;0&lt;/r\u00e9duction&gt;&lt;id&gt;3&lt;/id&gt;&lt;/r\u00e9ponse&gt;&lt;r\u00e9ponse&gt;&lt;mari\u00e9&gt;non&lt;/mari\u00e9&gt;&lt;enfants&gt;0&lt;/enfants&gt;&lt;salaire&gt;100000&lt;/salaire&gt;&lt;imp\u00f4t&gt;22986&lt;/imp\u00f4t&gt;&lt;surc\u00f4te&gt;0&lt;/surc\u00f4te&gt;&lt;taux&gt;0.41&lt;/taux&gt;&lt;d\u00e9c\u00f4te&gt;0&lt;/d\u00e9c\u00f4te&gt;&lt;r\u00e9duction&gt;0&lt;/r\u00e9duction&gt;&lt;id&gt;4&lt;/id&gt;&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.588051, Thread-4 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;calculer-impots&lt;/action&gt;&lt;\u00e9tat&gt;1500&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;&lt;mari\u00e9&gt;oui&lt;/mari\u00e9&gt;&lt;enfants&gt;2&lt;/enfants&gt;&lt;salaire&gt;30000&lt;/salaire&gt;&lt;imp\u00f4t&gt;0&lt;/imp\u00f4t&gt;&lt;surc\u00f4te&gt;0&lt;/surc\u00f4te&gt;&lt;taux&gt;0.0&lt;/taux&gt;&lt;d\u00e9c\u00f4te&gt;0&lt;/d\u00e9c\u00f4te&gt;&lt;r\u00e9duction&gt;0&lt;/r\u00e9duction&gt;&lt;id&gt;1&lt;/id&gt;&lt;/r\u00e9ponse&gt;&lt;r\u00e9ponse&gt;&lt;mari\u00e9&gt;non&lt;/mari\u00e9&gt;&lt;enfants&gt;0&lt;/enfants&gt;&lt;salaire&gt;200000&lt;/salaire&gt;&lt;imp\u00f4t&gt;64210&lt;/imp\u00f4t&gt;&lt;surc\u00f4te&gt;7498&lt;/surc\u00f4te&gt;&lt;taux&gt;0.45&lt;/taux&gt;&lt;d\u00e9c\u00f4te&gt;0&lt;/d\u00e9c\u00f4te&gt;&lt;r\u00e9duction&gt;0&lt;/r\u00e9duction&gt;&lt;id&gt;2&lt;/id&gt;&lt;/r\u00e9ponse&gt;&lt;r\u00e9ponse&gt;&lt;mari\u00e9&gt;oui&lt;/mari\u00e9&gt;&lt;enfants&gt;3&lt;/enfants&gt;&lt;salaire&gt;200000&lt;/salaire&gt;&lt;imp\u00f4t&gt;42842&lt;/imp\u00f4t&gt;&lt;surc\u00f4te&gt;17283&lt;/surc\u00f4te&gt;&lt;taux&gt;0.41&lt;/taux&gt;&lt;d\u00e9c\u00f4te&gt;0&lt;/d\u00e9c\u00f4te&gt;&lt;r\u00e9duction&gt;0&lt;/r\u00e9duction&gt;&lt;id&gt;3&lt;/id&gt;&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.594058, Thread-1 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;fin-session&lt;/action&gt;&lt;\u00e9tat&gt;400&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;session r\u00e9initialis\u00e9e&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.595198, Thread-1 : fin du calcul de l'imp\u00f4t des 2 contribuables\n2020-08-03 14:32:48.595198, Thread-2 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;fin-session&lt;/action&gt;&lt;\u00e9tat&gt;400&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;session r\u00e9initialis\u00e9e&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.595198, Thread-2 : fin du calcul de l'imp\u00f4t des 2 contribuables\n2020-08-03 14:32:48.595198, Thread-3 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;fin-session&lt;/action&gt;&lt;\u00e9tat&gt;400&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;session r\u00e9initialis\u00e9e&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.595198, Thread-3 : fin du calcul de l'imp\u00f4t des 4 contribuables\n2020-08-03 14:32:48.603351, Thread-4 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;fin-session&lt;/action&gt;&lt;\u00e9tat&gt;400&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;session r\u00e9initialis\u00e9e&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:32:48.603351, Thread-4 : fin du calcul de l'imp\u00f4t des 3 contribuables\n2020-08-03 14:32:48.603351, MainThread : fin du calcul de l'imp\u00f4t des contribuables\n</code></pre> <p>Ci-dessus, le parcours du thread [Thread-2].</p>"},{"location":"clients-web-pour-les-services-json-et-xml-de-la-version-12.html#315-le-client-main2","title":"31.5. Le client [main2]","text":"<p>Le client [main2] permet de tester les URL [/init-session, /authentifier-utilisateur, /get-admindata, /fin-session]\u00a0:</p> <pre><code>#\u00a0on\u00a0attend\u00a0un\u00a0param\u00e8tre\u00a0json\u00a0ou\u00a0xml\nimport\u00a0sys\n\nsyntaxe\u00a0=\u00a0f\"{sys.argv[0]}\u00a0json\u00a0/\u00a0xml\"\nerreur\u00a0=\u00a0len(sys.argv)\u00a0!=\u00a02\nif\u00a0not\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0session_type\u00a0=\u00a0sys.argv[1].lower()\n\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0session_type\u00a0!=\u00a0\"json\"\u00a0and\u00a0session_type\u00a0!=\u00a0\"xml\"\nif\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0print(f\"syntaxe\u00a0:\u00a0{syntaxe}\")\n\u00a0\u00a0\u00a0\u00a0sys.exit()\n\n#\u00a0on\u00a0configure\u00a0l'application\nimport\u00a0config\nconfig\u00a0=\u00a0config.configure({\"session_type\":\u00a0session_type})\n\n#\u00a0d\u00e9pendances\nfrom\u00a0Imp\u00f4tsError\u00a0import\u00a0Imp\u00f4tsError\nfrom\u00a0Logger\u00a0import\u00a0Logger\n\nlogger\u00a0=\u00a0None\n#\u00a0code\ntry:\n\u00a0\u00a0\u00a0\u00a0#\u00a0logger\n\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0Logger(config[\"logsFilename\"])\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0le\u00a0m\u00e9morise\u00a0dans\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0config[\"logger\"]\u00a0=\u00a0logger\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0de\u00a0d\u00e9but\n\u00a0\u00a0\u00a0\u00a0logger.write(\"d\u00e9but\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0des\u00a0contribuables\\n\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0la\u00a0factory\u00a0de\u00a0la\u00a0couche\u00a0[dao]\n\u00a0\u00a0\u00a0\u00a0dao_factory\u00a0=\u00a0config['layers']['dao_factory']\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0cr\u00e9e\u00a0une\u00a0instance\u00a0de\u00a0la\u00a0couche\u00a0[dao]\n\u00a0\u00a0\u00a0\u00a0dao\u00a0=\u00a0dao_factory.new_instance()\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0contribuables\n\u00a0\u00a0\u00a0\u00a0taxpayers\u00a0=\u00a0dao.get_taxpayers_data()[\"taxpayers\"]\n\u00a0\u00a0\u00a0\u00a0#\u00a0des\u00a0contribuables\u00a0?\n\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0taxpayers:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0raise\u00a0Imp\u00f4tsError(36,\u00a0f\"Pas\u00a0de\u00a0contribuables\u00a0valides\u00a0dans\u00a0le\u00a0fichier\u00a0{config['taxpayersFilename']}\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0type\u00a0de\u00a0la\u00a0session\n\u00a0\u00a0\u00a0\u00a0session_type\u00a0=\u00a0config['session_type']\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0initialise\u00a0la\u00a0session\n\u00a0\u00a0\u00a0\u00a0dao.init_session(session_type)\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0s'authentifie\n\u00a0\u00a0\u00a0\u00a0dao.authenticate_user(config['server']['user']['login'],\u00a0config['server']['user']['password'])\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0donn\u00e9es\u00a0de\u00a0l'administration\u00a0fiscale\n\u00a0\u00a0\u00a0\u00a0admindata\u00a0=\u00a0dao.get_admindata()\n\u00a0\u00a0\u00a0\u00a0#\u00a0fin\u00a0de\u00a0session\n\u00a0\u00a0\u00a0\u00a0dao.end_session()\n\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0des\u00a0contribuables\u00a0par\u00a0la\u00a0couche\u00a0[m\u00e9tier]\n\u00a0\u00a0\u00a0\u00a0m\u00e9tier\u00a0=\u00a0config['layers']['m\u00e9tier']\n\u00a0\u00a0\u00a0\u00a0for\u00a0taxpayer\u00a0in\u00a0taxpayers:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0m\u00e9tier.calculate_tax(taxpayer,\u00a0admindata)\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0enregistre\u00a0les\u00a0r\u00e9sultats\u00a0dans\u00a0le\u00a0fichier\u00a0jSON\n\u00a0\u00a0\u00a0\u00a0dao.write_taxpayers_results(taxpayers)\n\u00a0except\u00a0BaseException\u00a0as\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0de\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0print(f\"L'erreur\u00a0suivante\u00a0s'est\u00a0produite\u00a0:\u00a0{erreur}\")\nfinally:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ferme\u00a0le\u00a0logueur\n\u00a0\u00a0\u00a0\u00a0if\u00a0logger:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0de\u00a0fin\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(\"fin\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0des\u00a0contribuables\\n\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fermeture\u00a0du\u00a0logueur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.close()\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0a\u00a0fini\n\u00a0\u00a0\u00a0\u00a0print(\"Travail\u00a0termin\u00e9...\")\n</code></pre> <ul> <li>lignes 1-11\u00a0: on r\u00e9cup\u00e8re le param\u00e8tre [json, xml] qui fixe le type de la session \u00e0 \u00e9tablir avec le serveur\u00a0;</li> <li>lignes 13-15\u00a0: on configure le client\u00a0;</li> <li>lignes 30-33\u00a0: on cr\u00e9e une couche [dao]\u00a0;</li> <li>lignes 34-35\u00a0: avec elle, on r\u00e9cup\u00e8re la liste des contribuables pour lesquels il faut calculer l\u2019imp\u00f4t\u00a0;</li> <li>on retrouve ensuite les quatre \u00e9tapes du dialogue avec le serveur\u00a0;</li> <li>lignes 41-42\u00a0: une session est d\u00e9marr\u00e9e avec le serveur\u00a0;</li> <li>lignes 43-44\u00a0: on s\u2019authentifie aupr\u00e8s du serveur\u00a0;</li> <li>lignes 45-46\u00a0: on demande au serveur les constantes fiscales permettant le calcul de l\u2019imp\u00f4t\u00a0;</li> <li>lignes 47-48\u00a0: on ferme la session avec le serveur\u00a0;</li> <li>lignes 49-52\u00a0: avec ces constantes, on est capables de calculer l\u2019imp\u00f4t des contribuables \u00e0 l\u2019aide de la couche [m\u00e9tier] locale au client\u00a0;</li> <li>lignes 53-54\u00a0: on enregistre les r\u00e9sultats obtenus\u00a0; Pour une session XML, les r\u00e9sultats sont les suivants\u00a0:</li> </ul> <pre><code>2020-08-03 14:44:43.194294, MainThread : d\u00e9but du calcul de l'imp\u00f4t des contribuables\n2020-08-03 14:44:43.231633, MainThread : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;init-session&lt;/action&gt;&lt;\u00e9tat&gt;700&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;session d\u00e9marr\u00e9e avec le type de r\u00e9ponse xml&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:44:43.240872, MainThread : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;authentifier-utilisateur&lt;/action&gt;&lt;\u00e9tat&gt;200&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;Authentification r\u00e9ussie&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:44:43.250061, MainThread : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;get-admindata&lt;/action&gt;&lt;\u00e9tat&gt;1000&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;&lt;limites&gt;9964.0&lt;/limites&gt;&lt;limites&gt;27519.0&lt;/limites&gt;&lt;limites&gt;73779.0&lt;/limites&gt;&lt;limites&gt;156244.0&lt;/limites&gt;&lt;limites&gt;93749.0&lt;/limites&gt;&lt;coeffr&gt;0.0&lt;/coeffr&gt;&lt;coeffr&gt;0.14&lt;/coeffr&gt;&lt;coeffr&gt;0.3&lt;/coeffr&gt;&lt;coeffr&gt;0.41&lt;/coeffr&gt;&lt;coeffr&gt;0.45&lt;/coeffr&gt;&lt;coeffn&gt;0.0&lt;/coeffn&gt;&lt;coeffn&gt;1394.96&lt;/coeffn&gt;&lt;coeffn&gt;5798.0&lt;/coeffn&gt;&lt;coeffn&gt;13913.7&lt;/coeffn&gt;&lt;coeffn&gt;20163.4&lt;/coeffn&gt;&lt;abattement_dixpourcent_min&gt;437.0&lt;/abattement_dixpourcent_min&gt;&lt;plafond_impot_couple_pour_decote&gt;2627.0&lt;/plafond_impot_couple_pour_decote&gt;&lt;plafond_decote_couple&gt;1970.0&lt;/plafond_decote_couple&gt;&lt;valeur_reduc_demi_part&gt;3797.0&lt;/valeur_reduc_demi_part&gt;&lt;plafond_revenus_celibataire_pour_reduction&gt;21037.0&lt;/plafond_revenus_celibataire_pour_reduction&gt;&lt;id&gt;1&lt;/id&gt;&lt;abattement_dixpourcent_max&gt;12502.0&lt;/abattement_dixpourcent_max&gt;&lt;plafond_impot_celibataire_pour_decote&gt;1595.0&lt;/plafond_impot_celibataire_pour_decote&gt;&lt;plafond_decote_celibataire&gt;1196.0&lt;/plafond_decote_celibataire&gt;&lt;plafond_revenus_couple_pour_reduction&gt;42074.0&lt;/plafond_revenus_couple_pour_reduction&gt;&lt;plafond_qf_demi_part&gt;1551.0&lt;/plafond_qf_demi_part&gt;&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:44:43.269850, MainThread : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;action&gt;fin-session&lt;/action&gt;&lt;\u00e9tat&gt;400&lt;/\u00e9tat&gt;&lt;r\u00e9ponse&gt;session r\u00e9initialis\u00e9e&lt;/r\u00e9ponse&gt;&lt;/root&gt;\n2020-08-03 14:44:43.269850, MainThread : fin du calcul de l'imp\u00f4t des contribuables\n</code></pre>"},{"location":"clients-web-pour-les-services-json-et-xml-de-la-version-12.html#316-le-client-main3","title":"31.6. Le client [main3]","text":"<p>Le client [main3] permet de tester les URL [/init-session,\u00a0/calculer-impots, /get-simulations, /delete-simulation, /fin-session]\u00a0:</p> <p></p> <pre><code>#\u00a0on\u00a0attend\u00a0un\u00a0param\u00e8tre\u00a0json\u00a0ou\u00a0xml\nimport\u00a0sys\n\nsyntaxe\u00a0=\u00a0f\"{sys.argv[0]}\u00a0json\u00a0/\u00a0xml\"\nerreur\u00a0=\u00a0len(sys.argv)\u00a0!=\u00a02\nif\u00a0not\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0session_type\u00a0=\u00a0sys.argv[1].lower()\n\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0session_type\u00a0!=\u00a0\"json\"\u00a0and\u00a0session_type\u00a0!=\u00a0\"xml\"\nif\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0print(f\"syntaxe\u00a0:\u00a0{syntaxe}\")\n\u00a0\u00a0\u00a0\u00a0sys.exit()\n\n#\u00a0on\u00a0configure\u00a0l'application\nimport\u00a0config\nconfig\u00a0=\u00a0config.configure({\"session_type\":\u00a0session_type})\n\n#\u00a0d\u00e9pendances\nfrom\u00a0Imp\u00f4tsError\u00a0import\u00a0Imp\u00f4tsError\nimport\u00a0sys\nfrom\u00a0Logger\u00a0import\u00a0Logger\n\nlogger\u00a0=\u00a0None\n#\u00a0code\ntry:\n\u00a0\u00a0\u00a0\u00a0#\u00a0logger\n\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0Logger(config[\"logsFilename\"])\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0le\u00a0m\u00e9morise\u00a0dans\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0config[\"logger\"]\u00a0=\u00a0logger\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0de\u00a0d\u00e9but\n\u00a0\u00a0\u00a0\u00a0logger.write(\"d\u00e9but\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0des\u00a0contribuables\\n\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0la\u00a0factory\u00a0de\u00a0la\u00a0couche\u00a0[dao]\n\u00a0\u00a0\u00a0\u00a0dao_factory\u00a0=\u00a0config[\"layers\"][\"dao_factory\"]\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0cr\u00e9e\u00a0une\u00a0instance\u00a0de\u00a0la\u00a0couche\u00a0[dao]\n\u00a0\u00a0\u00a0\u00a0dao\u00a0=\u00a0dao_factory.new_instance()\n\u00a0\u00a0\u00a0\u00a0#\u00a0lecture\u00a0des\u00a0donn\u00e9es\u00a0des\u00a0contribuables\n\u00a0\u00a0\u00a0\u00a0taxpayers\u00a0=\u00a0dao.get_taxpayers_data()[\"taxpayers\"]\n\u00a0\u00a0\u00a0\u00a0#\u00a0des\u00a0contribuables\u00a0?\n\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0taxpayers:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0raise\u00a0Imp\u00f4tsError(36,\u00a0f\"Pas\u00a0de\u00a0contribuables\u00a0valides\u00a0dans\u00a0le\u00a0fichier\u00a0{config['taxpayersFilename']}\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0des\u00a0contribuables\n\u00a0\u00a0\u00a0\u00a0#\u00a0nombre\u00a0de\u00a0contribuables\n\u00a0\u00a0\u00a0\u00a0nb_taxpayers\u00a0=\u00a0len(taxpayers)\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\n\u00a0\u00a0\u00a0\u00a0logger.write(f\"d\u00e9but\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0des\u00a0{nb_taxpayers}\u00a0contribuables\\n\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0initialise\u00a0la\u00a0session\n\u00a0\u00a0\u00a0\u00a0dao.init_session(session_type)\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0s'authentifie\n\u00a0\u00a0\u00a0\u00a0dao.authenticate_user(config['server']['user']['login'],\u00a0config['server']['user']['password'])\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0calcule\u00a0l'imp\u00f4t\u00a0des\u00a0contribuables\n\u00a0\u00a0\u00a0\u00a0dao.calculate_tax_in_bulk_mode(taxpayers)\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0demande\u00a0la\u00a0liste\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0simulations\u00a0=\u00a0dao.get_simulations()\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0en\u00a0supprime\u00a0une\u00a0sur\u00a0deux\n\u00a0\u00a0\u00a0\u00a0for\u00a0i\u00a0in\u00a0range(len(simulations)):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0i\u00a0%\u00a02\u00a0==\u00a00:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0supprime\u00a0la\u00a0simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.delete_simulation(simulations[i]['id'])\n\u00a0\u00a0\u00a0\u00a0#\u00a0fin\u00a0de\u00a0session\n\u00a0\u00a0\u00a0\u00a0dao.end_session()\n\u00a0\u00a0\u00a0\u00a0#\u00a0consultez\u00a0les\u00a0logs\u00a0pour\u00a0voir\u00a0les\u00a0diff\u00e9rents\u00a0r\u00e9sultats\u00a0(mode\u00a0debug=True)\nexcept\u00a0BaseException\u00a0as\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0de\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0print(f\"L'erreur\u00a0suivante\u00a0s'est\u00a0produite\u00a0:\u00a0{erreur}\")\nfinally:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ferme\u00a0le\u00a0logueur\n\u00a0\u00a0\u00a0\u00a0if\u00a0logger:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0de\u00a0fin\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(\"fin\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0des\u00a0contribuables\\n\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fermeture\u00a0du\u00a0logueur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.close()\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0a\u00a0fini\n\u00a0\u00a0\u00a0\u00a0print(\"Travail\u00a0termin\u00e9...\")\n</code></pre> <ul> <li>lignes 1-11\u00a0: on r\u00e9cup\u00e8re le type de la session dans les param\u00e8tres du script\u00a0;</li> <li>lignes 13-15\u00a0: on configure l\u2019application\u00a0;</li> <li>lignes 25-50\u00a0: on retrouve du code d\u00e9j\u00e0 expliqu\u00e9 \u00e0 un moment ou \u00e0 un autre\u00a0;</li> <li>lignes 51-52\u00a0: on demande la liste des simulations faites dans la session courante\u00a0;</li> <li>lignes 53-57\u00a0: on supprime une simulation sur deux\u00a0;</li> <li>lignes 58-59\u00a0: on termine la session\u00a0; Lors d\u2019une session jSON, les logs sont les suivants\u00a0:</li> </ul> <pre><code>2020-08-03 15:01:52.702297, MainThread : d\u00e9but du calcul de l'imp\u00f4t des contribuables\n2020-08-03 15:01:52.702297, MainThread : d\u00e9but du calcul de l'imp\u00f4t des 11 contribuables\n2020-08-03 15:01:52.734806, MainThread : {\"action\": \"init-session\", \"\u00e9tat\": 700, \"r\u00e9ponse\": [\"session d\u00e9marr\u00e9e avec le type de r\u00e9ponse json\"]}\n2020-08-03 15:01:52.747961, MainThread : {\"action\": \"authentifier-utilisateur\", \"\u00e9tat\": 200, \"r\u00e9ponse\": \"Authentification r\u00e9ussie\"}\n2020-08-03 15:01:52.765721, MainThread : {\"action\": \"calculer-impots\", \"\u00e9tat\": 1500, \"r\u00e9ponse\": [{\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555, \"imp\u00f4t\": 2814, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 1}, {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 50000, \"imp\u00f4t\": 1384, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 384, \"r\u00e9duction\": 347, \"id\": 2}, {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 50000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 720, \"r\u00e9duction\": 0, \"id\": 3}, {\"mari\u00e9\": \"non\", \"enfants\": 2, \"salaire\": 100000, \"imp\u00f4t\": 19884, \"surc\u00f4te\": 4480, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 4}, {\"mari\u00e9\": \"non\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 16782, \"surc\u00f4te\": 7176, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 5}, {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 9200, \"surc\u00f4te\": 2180, \"taux\": 0.3, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 6}, {\"mari\u00e9\": \"oui\", \"enfants\": 5, \"salaire\": 100000, \"imp\u00f4t\": 4230, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 7}, {\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 100000, \"imp\u00f4t\": 22986, \"surc\u00f4te\": 0, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 8}, {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 30000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.0, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 9}, {\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 200000, \"imp\u00f4t\": 64210, \"surc\u00f4te\": 7498, \"taux\": 0.45, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 10}, {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000, \"imp\u00f4t\": 42842, \"surc\u00f4te\": 17283, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 11}]}\n2020-08-03 15:01:52.785505, MainThread : {\"action\": \"lister-simulations\", \"\u00e9tat\": 500, \"r\u00e9ponse\": [{\"d\u00e9c\u00f4te\": 0, \"enfants\": 2, \"id\": 1, \"imp\u00f4t\": 2814, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 55555, \"surc\u00f4te\": 0, \"taux\": 0.14}, {\"d\u00e9c\u00f4te\": 384, \"enfants\": 2, \"id\": 2, \"imp\u00f4t\": 1384, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 347, \"salaire\": 50000, \"surc\u00f4te\": 0, \"taux\": 0.14}, {\"d\u00e9c\u00f4te\": 720, \"enfants\": 3, \"id\": 3, \"imp\u00f4t\": 0, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 50000, \"surc\u00f4te\": 0, \"taux\": 0.14}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 2, \"id\": 4, \"imp\u00f4t\": 19884, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 4480, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 5, \"imp\u00f4t\": 16782, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 7176, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 6, \"imp\u00f4t\": 9200, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 2180, \"taux\": 0.3}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 5, \"id\": 7, \"imp\u00f4t\": 4230, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 0, \"taux\": 0.14}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 0, \"id\": 8, \"imp\u00f4t\": 22986, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 0, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 2, \"id\": 9, \"imp\u00f4t\": 0, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 30000, \"surc\u00f4te\": 0, \"taux\": 0.0}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 0, \"id\": 10, \"imp\u00f4t\": 64210, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 200000, \"surc\u00f4te\": 7498, \"taux\": 0.45}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 11, \"imp\u00f4t\": 42842, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 200000, \"surc\u00f4te\": 17283, \"taux\": 0.41}]}\n2020-08-03 15:01:52.801475, MainThread : {\"action\": \"supprimer-simulation\", \"\u00e9tat\": 600, \"r\u00e9ponse\": [{\"d\u00e9c\u00f4te\": 384, \"enfants\": 2, \"id\": 2, \"imp\u00f4t\": 1384, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 347, \"salaire\": 50000, \"surc\u00f4te\": 0, \"taux\": 0.14}, {\"d\u00e9c\u00f4te\": 720, \"enfants\": 3, \"id\": 3, \"imp\u00f4t\": 0, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 50000, \"surc\u00f4te\": 0, \"taux\": 0.14}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 2, \"id\": 4, \"imp\u00f4t\": 19884, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 4480, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 5, \"imp\u00f4t\": 16782, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 7176, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 6, \"imp\u00f4t\": 9200, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 2180, \"taux\": 0.3}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 5, \"id\": 7, \"imp\u00f4t\": 4230, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 0, \"taux\": 0.14}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 0, \"id\": 8, \"imp\u00f4t\": 22986, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 0, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 2, \"id\": 9, \"imp\u00f4t\": 0, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 30000, \"surc\u00f4te\": 0, \"taux\": 0.0}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 0, \"id\": 10, \"imp\u00f4t\": 64210, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 200000, \"surc\u00f4te\": 7498, \"taux\": 0.45}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 11, \"imp\u00f4t\": 42842, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 200000, \"surc\u00f4te\": 17283, \"taux\": 0.41}]}\n2020-08-03 15:01:52.810129, MainThread : {\"action\": \"supprimer-simulation\", \"\u00e9tat\": 600, \"r\u00e9ponse\": [{\"d\u00e9c\u00f4te\": 384, \"enfants\": 2, \"id\": 2, \"imp\u00f4t\": 1384, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 347, \"salaire\": 50000, \"surc\u00f4te\": 0, \"taux\": 0.14}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 2, \"id\": 4, \"imp\u00f4t\": 19884, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 4480, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 5, \"imp\u00f4t\": 16782, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 7176, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 6, \"imp\u00f4t\": 9200, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 2180, \"taux\": 0.3}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 5, \"id\": 7, \"imp\u00f4t\": 4230, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 0, \"taux\": 0.14}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 0, \"id\": 8, \"imp\u00f4t\": 22986, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 0, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 2, \"id\": 9, \"imp\u00f4t\": 0, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 30000, \"surc\u00f4te\": 0, \"taux\": 0.0}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 0, \"id\": 10, \"imp\u00f4t\": 64210, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 200000, \"surc\u00f4te\": 7498, \"taux\": 0.45}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 11, \"imp\u00f4t\": 42842, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 200000, \"surc\u00f4te\": 17283, \"taux\": 0.41}]}\n2020-08-03 15:01:52.818803, MainThread : {\"action\": \"supprimer-simulation\", \"\u00e9tat\": 600, \"r\u00e9ponse\": [{\"d\u00e9c\u00f4te\": 384, \"enfants\": 2, \"id\": 2, \"imp\u00f4t\": 1384, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 347, \"salaire\": 50000, \"surc\u00f4te\": 0, \"taux\": 0.14}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 2, \"id\": 4, \"imp\u00f4t\": 19884, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 4480, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 6, \"imp\u00f4t\": 9200, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 2180, \"taux\": 0.3}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 5, \"id\": 7, \"imp\u00f4t\": 4230, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 0, \"taux\": 0.14}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 0, \"id\": 8, \"imp\u00f4t\": 22986, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 0, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 2, \"id\": 9, \"imp\u00f4t\": 0, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 30000, \"surc\u00f4te\": 0, \"taux\": 0.0}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 0, \"id\": 10, \"imp\u00f4t\": 64210, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 200000, \"surc\u00f4te\": 7498, \"taux\": 0.45}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 11, \"imp\u00f4t\": 42842, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 200000, \"surc\u00f4te\": 17283, \"taux\": 0.41}]}\n2020-08-03 15:01:52.834604, MainThread : {\"action\": \"supprimer-simulation\", \"\u00e9tat\": 600, \"r\u00e9ponse\": [{\"d\u00e9c\u00f4te\": 384, \"enfants\": 2, \"id\": 2, \"imp\u00f4t\": 1384, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 347, \"salaire\": 50000, \"surc\u00f4te\": 0, \"taux\": 0.14}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 2, \"id\": 4, \"imp\u00f4t\": 19884, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 4480, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 6, \"imp\u00f4t\": 9200, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 2180, \"taux\": 0.3}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 0, \"id\": 8, \"imp\u00f4t\": 22986, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 0, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 2, \"id\": 9, \"imp\u00f4t\": 0, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 30000, \"surc\u00f4te\": 0, \"taux\": 0.0}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 0, \"id\": 10, \"imp\u00f4t\": 64210, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 200000, \"surc\u00f4te\": 7498, \"taux\": 0.45}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 11, \"imp\u00f4t\": 42842, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 200000, \"surc\u00f4te\": 17283, \"taux\": 0.41}]}\n2020-08-03 15:01:52.843803, MainThread : {\"action\": \"supprimer-simulation\", \"\u00e9tat\": 600, \"r\u00e9ponse\": [{\"d\u00e9c\u00f4te\": 384, \"enfants\": 2, \"id\": 2, \"imp\u00f4t\": 1384, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 347, \"salaire\": 50000, \"surc\u00f4te\": 0, \"taux\": 0.14}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 2, \"id\": 4, \"imp\u00f4t\": 19884, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 4480, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 6, \"imp\u00f4t\": 9200, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 2180, \"taux\": 0.3}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 0, \"id\": 8, \"imp\u00f4t\": 22986, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 0, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 0, \"id\": 10, \"imp\u00f4t\": 64210, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 200000, \"surc\u00f4te\": 7498, \"taux\": 0.45}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 11, \"imp\u00f4t\": 42842, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 200000, \"surc\u00f4te\": 17283, \"taux\": 0.41}]}\n2020-08-03 15:01:52.851855, MainThread : {\"action\": \"supprimer-simulation\", \"\u00e9tat\": 600, \"r\u00e9ponse\": [{\"d\u00e9c\u00f4te\": 384, \"enfants\": 2, \"id\": 2, \"imp\u00f4t\": 1384, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 347, \"salaire\": 50000, \"surc\u00f4te\": 0, \"taux\": 0.14}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 2, \"id\": 4, \"imp\u00f4t\": 19884, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 4480, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 3, \"id\": 6, \"imp\u00f4t\": 9200, \"mari\u00e9\": \"oui\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 2180, \"taux\": 0.3}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 0, \"id\": 8, \"imp\u00f4t\": 22986, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 100000, \"surc\u00f4te\": 0, \"taux\": 0.41}, {\"d\u00e9c\u00f4te\": 0, \"enfants\": 0, \"id\": 10, \"imp\u00f4t\": 64210, \"mari\u00e9\": \"non\", \"r\u00e9duction\": 0, \"salaire\": 200000, \"surc\u00f4te\": 7498, \"taux\": 0.45}]}\n2020-08-03 15:01:52.863165, MainThread : {\"action\": \"fin-session\", \"\u00e9tat\": 400, \"r\u00e9ponse\": \"session r\u00e9initialis\u00e9e\"}\n2020-08-03 15:01:52.863165, MainThread : fin du calcul de l'imp\u00f4t des contribuables\n</code></pre> <ul> <li>ligne 6\u00a0: nous avons 11 simulations\u00a0;</li> <li>ligne 12\u00a0: apr\u00e8s les diff\u00e9rentes suppressions, il n\u2019y en a plus que 5\u00a0;</li> </ul>"},{"location":"clients-web-pour-les-services-json-et-xml-de-la-version-12.html#317-la-classe-de-test-test2httpclientdaowithsession","title":"31.7. La classe de test [Test2HttpClientDaoWithSession]","text":"<p>La classe [Test2HttpClientDaoWithSession] teste la couche [dao] des clients de la fa\u00e7on suivante\u00a0:</p> <pre><code>import\u00a0unittest\n\nfrom\u00a0Imp\u00f4tsError\u00a0import\u00a0Imp\u00f4tsError\nfrom\u00a0Logger\u00a0import\u00a0Logger\nfrom\u00a0TaxPayer\u00a0import\u00a0TaxPayer\n\nclass\u00a0Test2HttpClientDaoWithSession(unittest.TestCase):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0test_init_session_json(self)\u00a0-&gt;\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0print('test_init_session_json')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.init_session('json')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0except\u00a0Imp\u00f4tsError\u00a0as\u00a0ex:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0print(ex)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0il\u00a0ne\u00a0doit\u00a0oas\u00a0y\u00a0avoir\u00a0d'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.assertFalse(erreur)\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0test_init_session_xml(self)\u00a0-&gt;\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0print('test_init_session_xml')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.init_session('xml')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0except\u00a0Imp\u00f4tsError\u00a0as\u00a0ex:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0print(ex)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0in\u00a0ne\u00a0doit\u00a0pas\u00a0y\u00a0avoir\u00a0d'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.assertFalse(erreur)\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0test_init_session_xxx(self)\u00a0-&gt;\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0print('test_init_session_xxx')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.init_session('xxx')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0except\u00a0Imp\u00f4tsError\u00a0as\u00a0ex:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0print(ex)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0il\u00a0doit\u00a0y\u00a0avoir\u00a0une\u00a0erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.assertTrue(erreur)\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0test_authenticate_user_success(self)\u00a0-&gt;\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0print('test_authenticate_user_success')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0init\u00a0session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.init_session('json')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0test\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.authenticate_user(config['server']['user']['login'],\u00a0config['server']['user']['password'])\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0except\u00a0Imp\u00f4tsError\u00a0as\u00a0ex:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0print(ex)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0il\u00a0ne\u00a0doit\u00a0pas\u00a0y\u00a0avoir\u00a0d'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.assertFalse(erreur)\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0test_authenticate_user_failed(self)\u00a0-&gt;\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0print('test_authenticate_user_failed')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0init\u00a0session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.init_session('json')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0test\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.authenticate_user('x',\u00a0'y')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0except\u00a0Imp\u00f4tsError\u00a0as\u00a0ex:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0print(ex)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0il\u00a0doit\u00a0y\u00a0avoir\u00a0une\u00a0erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.assertTrue(erreur)\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0test_get_simulations(self)\u00a0-&gt;\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0print('test_get_simulations')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0init\u00a0session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.init_session('json')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0authentification\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.authenticate_user('admin',\u00a0'admin')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0{'mari\u00e9':\u00a0'oui',\u00a0'enfants':\u00a02,\u00a0'salaire':\u00a055555,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0'imp\u00f4t':\u00a02814,\u00a0'surc\u00f4te':\u00a00,\u00a0'd\u00e9c\u00f4te':\u00a00,\u00a0'r\u00e9duction':\u00a00,\u00a0'taux':\u00a00.14}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0taxpayer\u00a0=\u00a0TaxPayer().fromdict({\"mari\u00e9\":\u00a0\"oui\",\u00a0\"enfants\":\u00a02,\u00a0\"salaire\":\u00a055555})\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.calculate_tax(taxpayer)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0get_simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0simulations\u00a0=\u00a0dao.get_simulations()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0v\u00e9rifications\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0il\u00a0doit\u00a0y\u00a0avoir\u00a01\u00a0simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.assertEqual(1,\u00a0len(simulations))\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0simulation\u00a0=\u00a0simulations[0]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0v\u00e9rification\u00a0de\u00a0l'imp\u00f4t\u00a0calcul\u00e9\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.assertAlmostEqual(simulation['imp\u00f4t'],\u00a02815,\u00a0delta=1)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.assertEqual(simulation['d\u00e9c\u00f4te'],\u00a00)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.assertEqual(simulation['r\u00e9duction'],\u00a00)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.assertAlmostEqual(simulation['taux'],\u00a00.14,\u00a0delta=0.01)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.assertEqual(simulation['surc\u00f4te'],\u00a00)\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0test_delete_simulation(self)\u00a0-&gt;\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0print('test_delete_simulation')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0init\u00a0session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.init_session('json')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0authentification\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.authenticate_user('admin',\u00a0'admin')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0taxpayer\u00a0=\u00a0TaxPayer().fromdict({\"mari\u00e9\":\u00a0\"oui\",\u00a0\"enfants\":\u00a02,\u00a0\"salaire\":\u00a055555})\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.calculate_tax(taxpayer)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0get_simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0simulations\u00a0=\u00a0dao.get_simulations()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0delete_simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.delete_simulation(simulations[0]['id'])\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0get_simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0simulations\u00a0=\u00a0dao.get_simulations()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0v\u00e9rification\u00a0-\u00a0il\u00a0ne\u00a0doit\u00a0plus\u00a0y\u00a0avoir\u00a0de\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.assertEqual(0,\u00a0len(simulations))\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0supprime\u00a0une\u00a0simulation\u00a0qui\u00a0n'existe\u00a0pas\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dao.delete_simulation(100)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0except\u00a0Imp\u00f4tsError\u00a0as\u00a0ex:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0print(ex)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0il\u00a0doit\u00a0y\u00a0avoir\u00a0une\u00a0erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.assertTrue(erreur)\n\nif\u00a0__name__\u00a0==\u00a0'__main__':\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0configure\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0import\u00a0config\n\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0config.configure({})\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0logger\n\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0Logger(config[\"logsFilename\"])\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0le\u00a0m\u00e9morise\u00a0dans\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0config[\"logger\"]\u00a0=\u00a0logger\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0couche\u00a0[dao]\n\u00a0\u00a0\u00a0\u00a0dao_factory\u00a0=\u00a0config['layers']['dao_factory']\n\u00a0\u00a0\u00a0\u00a0dao\u00a0=\u00a0dao_factory.new_instance()\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0les\u00a0m\u00e9thodes\u00a0de\u00a0test\n\u00a0\u00a0\u00a0\u00a0print(\"tests\u00a0en\u00a0cours...\")\n\u00a0\u00a0\u00a0\u00a0unittest.main()\n</code></pre> <ul> <li>la couche [dao] envoie une requ\u00eate au serveur, r\u00e9ceptionne sa r\u00e9ponse et la met en forme pour la rendre au code appelant. Lorsque le serveur envoie un r\u00e9ponse avec un code de statut diff\u00e9rent de 200, la couche [dao] lance une exception. Aussi un certain nombre de tests consiste \u00e0 savoir s\u2019il y a eu exception ou pas\u00a0;</li> <li>lignes 9-18\u00a0: on initialise une session jSON. On ne doit pas avoir d\u2019erreur\u00a0;</li> <li>lignes 20-29\u00a0: on initialise une session XML. On ne doit pas avoir d\u2019erreur\u00a0;</li> <li>lignes 31-40\u00a0: on initialise une session avec un type incorrect. on doit avoir une erreur\u00a0;</li> <li>lignes 42-54\u00a0: on s\u2019authentifie avec les bons identifiants. On ne doit pas avoir d\u2019erreur\u00a0;</li> <li>lignes 56-68\u00a0: on s\u2019authentifie avec des identifiants incorrects. On doit avoir une erreur\u00a0;</li> <li>lignes 70-92\u00a0: on fait un calcul d\u2019imp\u00f4t puis on demande la liste des simulations. On doit en avoir une. Par ailleurs on verifie que cette simulation contient bien l\u2019imp\u00f4t demand\u00e9\u00a0;</li> <li>lignes 94-119\u00a0: on fait une simulation qu\u2019on supprime ensuite. Puis on essaie ensuite de supprimer une simulation alors qu\u2019il n\u2019y en a plus. On doit avoir une erreur\u00a0;</li> <li>lignes 121-137\u00a0: le test est lanc\u00e9 comme un script console classique\u00a0;</li> <li>lignes 122-124\u00a0: on configure l\u2019application\u00a0;</li> <li>lignes 126-129\u00a0: on configure le logger. Cela nous permettra de suivre les logs\u00a0;</li> <li>lignes 131-133\u00a0: on instancie la couche [dao] qui va \u00eatre test\u00e9e\u00a0;</li> <li>lignes 135-137\u00a0: on lance les tests\u00a0; Les r\u00e9sultats console sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots/http-clients/07/tests/Test2HttpClientDaoWithSession.py\ntests en cours...\ntest_authenticate_user_failed\n..MyException[35, [\"Echec de l'authentification\"]]\ntest_authenticate_user_success\ntest_delete_simulation\nMyException[35, [\"la simulation n\u00b0 [100] n'existe pas\"]]\ntest_get_simulations\ntest_init_session_json\ntest_init_session_xml\ntest_init_session_xxx\nMyException[73, il n'y a pas de session valide en cours]\n----------------------------------------------------------------------\nRan 7 tests in 0.171s\n\nOK\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"conclusion.html","title":"39. Conclusion","text":"<p>Rappelons le travail fait dans ce document\u00a0:</p> <p>Chapitre</p><p>Dossier</p><p>Contenu</p> <p>Chapitre 1</p> <p>Pr\u00e9sentation du cours</p><p>Chapitre 2</p> <p>Installation d\u2019un environnement de travail</p><p>Chapitre 3</p><p>[bases]</p><p>Les bases du langage Python \u2013 structures du langage \u2013 type de donn\u00e9es \u2013 fonctions \u2013 affichage console \u2013 cha\u00eenes de formatage \u2013 changement de types \u2013 les listes \u2013 les dictionnaires \u2013 les expression sr\u00e9guli\u00e8res</p><p>Chapitre 4</p><p>[strings]</p><p>Notation des cha\u00eenes de caract\u00e8res \u2013 m\u00e9thodes de la classe &lt;str&gt; - encodage / d\u00e9codage des cha\u00eenes de caract\u00e8res en UTF-8</p><p>Chapitre 5</p><p>[exceptions]</p><p>Gestion des exceptions</p><p>Chapitre 6</p><p>[fonctions]</p><p>Port\u00e9e des variables \u2013 mode de passage des param\u00e8tres \u2013 utiliser des modules \u2013 le Python Path \u2013 param\u00e8tres nomm\u00e9s \u2013 fonctions r\u00e9cursives</p><p>Chapitre 7</p><p>[fichiers]</p><p>Lecture / \u00e9criture d\u2019un fichier texte \u2013 gestion des fichiers encod\u00e9s en UTF-8 \u2013 gestion des fichiers jSON</p><p>Chapitre 8</p><p>[impots/v01]</p><p>Version 1 de l\u2019exercice d\u2019application, un calcul d\u2019imp\u00f4t sur les revenus. L\u2019application est d\u00e9clin\u00e9e en 18 versions \u2013 La version 1 impl\u00e9mente une solution proc\u00e9durale</p><p>Chapitre 9</p><p>[imports]</p><p>Gestion des d\u00e9pendances d\u2019une application par importation de modules \u2013 une m\u00e9thode de gestion des d\u00e9pendances est pr\u00e9sent\u00e9e \u2013 elle est utilis\u00e9e dans tout le document \u2013 gestion du Python Path</p><p>Chapitre 10</p><p>[impots/v02]</p><p>La version 2 de l\u2019application reprend la version 1 en rassemblant toutes les constantes de la configuration dans un fichier de configuration</p><p>Chapitre 11</p><p>[impots/v03]</p><p>La version 3 de l\u2019application reprend la version 2 en utilisant des fonctions encapsul\u00e9es dans un module \u2013 la gestion des d\u00e9pendances est faite par configuration \u2013 introduction de fichier jSON pour lire les donn\u00e9es n\u00e9cessaires au calcul de l\u2019imp\u00f4t et \u00e9crire les r\u00e9sultats des calculs</p><p>Chapitre 12</p><p>[classes/01]</p><p>Classes \u2013 h\u00e9ritage \u2013 m\u00e9thodes et propri\u00e9t\u00e9s \u2013 getters / setters \u2013 constructeur \u2013 propri\u00e9t\u00e9 [__dict__]</p><p>Chapitre 13</p><p>[classes/02]</p><p>Pr\u00e9sentation des classes [BaseEntity] et [MyException] utilis\u00e9es dans le reste du document \u2013 [BaseEntity] facilite les conversions objet / dictionnaire</p><p>Chapitre 14</p><p>[troiscouches]</p><p>Architecture en couches et programmation par interfaces. Ce chapitre pr\u00e9sente les m\u00e9thodes de programmation utilis\u00e9es dans le reste du document</p><p>Chapitre 15</p><p>[impots/v04]</p><p>Version 4 de l\u2019application \u2013 cette version impl\u00e9mente une solution avec une architecture en couches, la programmation par interfaces, l\u2019utilisation de classes d\u00e9riv\u00e9es de [BaseEntity] et [MyException]</p><p>Chapitre 16</p><p>[databases/mysql]</p><p>Installation du SGBD MySQL \u2013 connexion \u00e0 la base de donn\u00e9es \u2013 cr\u00e9ation d\u2019une table \u2013 ex\u00e9cution d\u2019ordres SQL SELECT, UPDATE, DELETE, INSERT \u2013 transaction \u2013 requ\u00eates SQL param\u00e9tr\u00e9es</p><p>Chapitre 17</p><p>[databases/postgresql]</p><p>Installation du SGBD PostgreSQL \u2013 connexion \u00e0 la base de donn\u00e9es \u2013 cr\u00e9ation d\u2019une table \u2013 ex\u00e9cution d\u2019ordres SQL SELECT, UPDATE, DELETE, INSERT \u2013 transaction \u2013 requ\u00eates SQL param\u00e9tr\u00e9es</p><p>Chapitre 18</p><p>[databases/anysgbd]</p><p>Ecrire du code ind\u00e9pendant du SGBD</p><p>Chapitre 19</p><p>[databases/sqlalchemy]</p><p>L\u2019ORM (Object Relational Mapper) SqlAlchemy \u2013 un ORM permet de travailler de fa\u00e7on unifi\u00e9e avec diff\u00e9rents SGBD - mapping classes / tables SQL \u2013 op\u00e9rations sur les classes images des tables SQL</p><p>Chapitre 20</p><p>[impots/v05]</p><p>Version 5 de l\u2019application de calcul de l\u2019imp\u00f4t \u2013 Utilisation de l\u2019architecture en couches de la version 04 et de l\u2019ORM SqlAlchemy pour travailler avec les SGBD MySQL et PostgreSQL</p><p>Chapitre 21</p><p>[inet]</p><p>Programmation internet \u2013 protocole TCP / IP (Transfer Control Protocol / Internet Protocol) - protocoles HTTP (HyperText Transfer Protocol) \u2013 SMTP (Simple Mail Transfer Protocol) \u2013 POP (Post Office Protocol) \u2013 IMAP (Internet Message Access Protocol)</p><p>Chapitre 22</p><p>[flask]</p><p>Services web avec le framework web Flask \u2013 affichage d\u2019une page HTML \u2013 service web jSON \u2013 requ\u00eates GET et POST \u2013 gstion d\u2019une session web</p><p>Chapitre 23</p><p>[impots/http-servers/01]</p><p>[impots/http-clients/01]</p><p>Version 6 de l\u2019exercice d\u2019application - Cr\u00e9ation d\u2019un service web jSON de calcul de l\u2019imp\u00f4t avec une architecture multicouche - Ecriture d\u2019un client web pour ce serveur avec une architecture multicouche \u2013 programmation client / serveur \u2013 utilisation du module [requests]</p><p>Chapitre 24</p><p>[impots/http-servers/02]</p><p>[impots/http-clients/02]</p><p>Version 7 de l\u2019exercice de l\u2019application \u2013 la version 6 est am\u00e9lior\u00e9e\u00a0: le client et le serveur sont multithtread\u00e9s \u2013 utilitaires [Logger] pour loguer les \u00e9changes client / serveur \u2013 [SendMail] pour envoyer un mail \u00e0 l\u2019administrateur de l\u2019application</p><p>Chapitre 25</p><p>[impots/http-servers/03]</p><p>[impots/http-clients/03]</p><p>Version 8 de l\u2019exercice d\u2019application \u2013 la version 7 est am\u00e9lior\u00e9e par l\u2019usage d\u2019une session</p><p>Chapitre 26</p><p>[xml]</p><p>Gestion XML avec le module [xmltodict]</p><p>Chapitre 27</p><p>[impots/http-servers/04]</p><p>[impots/http-clients/04]</p><p>Version 9 de l\u2019exercice d\u2019application \u2013 la version 8 est modifi\u00e9e pour avoir des \u00e9changes client / serveur en XML\u00a0;</p><p>Chapitre 28</p><p>[impots/http-servers/05]</p><p>[impots/http-clients/05]</p><p>Version 10 de l\u2019exercice d\u2019application \u2013 au lieu de traiter N contribuables par N requ\u00eates GET, on utilise une unique requ\u00eate POST avec les N contribuables dans le corps du POST</p><p>Chapitre 29</p><p>[impots/http-servers/06]</p><p>[impots/http-clients/06]</p><p>Version 11 de l\u2019exercice d\u2019application \u2013 l\u2019architecture client / serveur de l\u2019application est modifi\u00e9e\u00a0: la couche [m\u00e9tier] passe du serveur au client</p><p>Chapitre 30</p><p>[impots/http-servers/07]</p><p>Version 12 de l\u2019exercice d\u2019application \u2013 cette version impl\u00e9mente un serveur MVC (Model \u2013 View \u2013 Controller) d\u00e9livrant indiff\u00e9remment, \u00e0 la demande du client, du jSON, du XML et du HTML. Ce chapitre impl\u00e9mente les versions jSON et XML du serveur</p><p>Chapitre 31</p><p>[impots/http-clients/07]</p><p>Impl\u00e9mentation des clients jSON et XML du serveur MVC de la version 12</p><p>Chapitre 32</p><p>[impots/http-servers/07]</p><p>Impl\u00e9mentation du serveur HTML de la version 12 \u2013 utilisation du framework CSS Bootstrap \u2013</p><p>Chapitre 33</p><p>[impots/http-servers/08]</p><p>Version 13 de l\u2019exercice d\u2019application - Refactorisation du code de la version 12 \u2013 gestion de la session avec le module [flask_session] et un serveur Redis \u2013 utilisation de mots de passe crypt\u00e9s</p><p>Chapitre 34</p><p>[impots/http-servers/09]</p><p>[impots/http-clients/09]</p><p>Version 14 de l\u2019exercice d\u2019application \u2013 impl\u00e9mentation d\u2019URL avec un jeton CSRF (Cross Site Request Forgery)</p><p>Chapitre 35</p><p>[impots/http-servers/10]</p><p>Version 15 de l\u2019exercice d\u2019application \u2013 refactorisation du code de la version 14 pour g\u00e9rer deux types d\u2019actions\u00a0: ASV (Action Show View) qui ne servent qu\u2019\u00e0 afficher une vue sans modifier l\u2019\u00e9tat du serveur, ADS (Action Do Something) qui font une action qui modifie l\u2019\u00e9tat du serveur \u2013 ces actions se terminent toutes par une redirection vers une action ASV \u2013 cela permet de g\u00e9rer correctement les rafra\u00eechissements de page du navigateur client</p><p>Chapitre 36</p><p>[impots/http-servers/11]</p><p>Version 16 de l\u2019application \u2013 gestion des URL avec pr\u00e9fixe</p><p>Chapitre 37</p><p>[impots/http-servers/12]</p><p>Version 17 de l\u2019application \u2013 portage de la version 16 sur un serveur Apache / Windows</p><p>Chapitre 38</p><p>[impots/http-servers/13]</p><p>Version 18 de l\u2019application \u2013 corrige une anomalie de la version 17</p> <p>Les applications client / serveur du calcul de l\u2019imp\u00f4t ont impl\u00e9ment\u00e9 l\u2019architecture suivante\u00a0:</p> <p></p> <p>La couche [web] ci-dessus a \u00e9t\u00e9 impl\u00e9ment\u00e9e avec une architecture MVC\u00a0:</p> <p></p> <p>Le contenu du document est dense. Le lecteur qui ira jusqu\u2019au bout aura une bonne vision de la programmation web MVC en Python / Flask et au-del\u00e0 une bonne vision de la programmation web MVC dans d\u2019autres langages.</p> <p>On pourra trouver des informations compl\u00e9mentaires sur le framework Flask dans le document [https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world] de l\u2019auteur Miguel Grinberg. J\u2019ai lu quelques \u00e9l\u00e9ments de son cours et ceux-ci m\u2019ont sembl\u00e9 tr\u00e8s p\u00e9dagogiques. L\u2019auteur pr\u00e9sente beaucoup de notions non abord\u00e9es dans ce document.</p>"},{"location":"du-dictionnaire-a-xml-et-vice-versa.html","title":"26. Du dictionnaire \u00e0 XML et vice-versa","text":"<p>Nous nous proposons ici de d\u00e9couvrir le module [xml2dict] qui permet de transformer\u00a0:</p> <ul> <li>une cha\u00eene XML en dictionnaire\u00a0:</li> <li>un dictionnaire en cha\u00eene XML\u00a0; Avant l\u2019av\u00e8nement du jSON, la r\u00e9ponse des services web \u00e9tait souvent du XML (eXtended Markup Language). Par ailleurs, le protocole de ces services web \u00e9tait souvent SOAP (Simple Object Process Protocol). SOAP est un protocole qui s\u2019appuie sur le protocole HTTP du web. Actuellement (2020), les services web sont plut\u00f4t de type REST (Representational State Transfer). Les services web que nous avons \u00e9tudi\u00e9s ne sont d\u2019aucun de ces types mais sont d\u00e9finitivement plus proches de REST que de SOAP. N\u00e9anmoins je pr\u00e9f\u00e8re dire qu\u2019ils sont de type \u2018libre\u2019 ou \u2018inconnu\u2019 car ils ne respectent pas toutes les r\u00e8gles du REST.</li> </ul> <p>Nous allons montrer combien il est facile de transformer nos architectures client / serveur jSON en architectures client / serveur XML. Il suffit d\u2019utiliser le module [xmltodict].</p> <p>Nous commen\u00e7ons par l\u2019installer dans un terminal Python\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\packages&gt;pip install xmltodict\nCollecting xmltodict\n  Using cached xmltodict-0.12.0-py2.py3-none-any.whl (9.2 kB)\nInstalling collected packages: xmltodict\nSuccessfully installed xmltodict-0.12.0\n</code></pre> <p>Ceci fait, nous allons \u00e9tudier sur un exemple ce qu\u2019on peut faire avec ce module\u00a0:</p> <p></p> <p>Le script [xml_01] est le suivant\u00a0:</p> <pre><code>from collections import OrderedDict\n\nimport xmltodict\n\n\n# xmltodict.parse pour passer du XML au dictionnaire. Le dictionnaire doit avoir une racine\n# le dictionnaire produit est de type OrderedDict\n# xmltodict.unparse pour passer du dictionnaire au XML\n\ndef ordereddict2dict(ordered_dictionary) -&gt; dict:\n    \u2026\n\n\ndef transform(message: str, dictionary: dict):\n    # logs\n    print(f\"\\n{message}-------\")\n    print(f\"dictionnaire={dictionary}\")\n    # dict -&gt; xml\n    xml1 = xmltodict.unparse(dictionary)\n    print(f\"xml={xml1}\")\n    # xml -&gt; OrderedDict\n    ordereddict_dictionary1 = xmltodict.parse(xml1)\n    print(f\"ordereddict_dictionary1={ordereddict_dictionary1}\")\n    # OrderedDict -&gt; dict\n    print(f\"dict_dictionary1={ordereddict2dict(ordereddict_dictionary1)}\")\n\n\n# test 1\ntransform(\"test 1\", {\"nom\": \"s\u00e9l\u00e9n\u00e9\"})\n# test 2\ntransform(\"test 2\", {\"famille\": {\"p\u00e8re\": {\"pr\u00e9nom\": \"andr\u00e9\"}, \"m\u00e8re\": {\"pr\u00e9nom\": \"ang\u00e8le\"}, \"nom\": \"s\u00e9l\u00e9n\u00e9\"}})\n# test 3\ntransform(\"test 3\", {\"famille\": {\"nom\": \"s\u00e9l\u00e9n\u00e9\", \"p\u00e8re\": {\"pr\u00e9nom\": \"andr\u00e9\"}, \"m\u00e8re\": {\"pr\u00e9nom\": \"ang\u00e8le\"},\n                                 \"hobbies\": [\"chant\", \"footing\"]}})\n# test 4\ntransform(\"test 4\", {'r\u00e9ponse': {\n    'erreurs': ['M\u00e9thode GET requise avec les seuls param\u00e8tres [mari\u00e9, enfants, salaire]', 'param\u00e8tre [mari\u00e9] manquant',\n                'param\u00e8tre [enfants] manquant', 'param\u00e8tre [salaire] manquant']}})\n# test 5\ntransform(\"test 5\", {'r\u00e9ponse': {\n    'result': {'id': 0, 'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 50000, 'imp\u00f4t': 1384, 'd\u00e9c\u00f4te': 384, 'surc\u00f4te': 0,\n               'r\u00e9duction': 347, 'taux': 0.14}}})\n# test 6\ntransform(\"test 6\", {\"root\": {'liste': [\"un\", \"deux\", \"trois\"]}})\n# test 7\ntransform(\"test 7\", {\"root\": {'liste': [{\"un\": [10, 11]}, {\"deux\": [20, 21]}, {\"trois\": [30, 31]}]}})\n</code></pre> <ul> <li>lignes 14-25\u00a0: la fonction [transform]\u00a0re\u00e7oit un texte \u00e0 \u00e9crire [message] et un dictionnaire [dictionary]\u00a0;</li> <li>ligne 16\u00a0: affichage du message\u00a0;</li> <li>ligne 17\u00a0: on affiche le dictionnaire re\u00e7u\u00a0;</li> <li>lignes 19-20\u00a0: ce dictionnaire est transform\u00e9 en cha\u00eene XML et celle-ci est affich\u00e9e. La m\u00e9thode qui sait faire cela est [xmltodict.unparse]\u00a0;</li> <li>lignes 21-23\u00a0: la cha\u00eene XML pr\u00e9c\u00e9dente est transform\u00e9e en dictionnaire et celui-ci est affich\u00e9. La m\u00e9thode qui sait faire cela est [xmltodict.parse]. Cette m\u00e9thode ne produit pas un dictionnaire de type [dict] mais de type [OrderedDict] (ligne 1)\u00a0;</li> <li>lignes 24-25\u00a0: on transforme le type [OrderedDict] obtenu en type [dict] \u00e0 l\u2019aide de la m\u00e9thode (non encore \u00e9crite) [ordereddict2dict]. Cette m\u00e9thode travaille de fa\u00e7on r\u00e9cursive. Si certaines valeurs du dictionnaire sont de type [OrderedDict, list], les valeurs de ces collections sont examin\u00e9es pour savoir si elles-aussi sont de type [OrderedDict]. Si c\u2019est le cas, elles sont transform\u00e9es en type [dict]. On remarquera que la m\u00e9thode [xmltodict.parse] ne produit aucun dictionnaire de type [dict]\u00a0; Avant d\u2019examiner les fonctions manquantes, examinons les r\u00e9sultats pour voir ce qui est cherch\u00e9\u00a0:</li> </ul> <p>Le test 1 (lignes 28-29) produit les r\u00e9sultats suivants\u00a0:</p> <pre><code>test 1-------\ndictionnaire={'nom': 's\u00e9l\u00e9n\u00e9'}\nxml=&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;nom&gt;s\u00e9l\u00e9n\u00e9&lt;/nom&gt;\nordereddict_dictionary1=OrderedDict([('nom', 's\u00e9l\u00e9n\u00e9')])\ndict_dictionary1={'nom': 's\u00e9l\u00e9n\u00e9'}\n</code></pre> <ul> <li>ligne 2\u00a0: le dictionnaire test\u00e9. Il faut noter un point important\u00a0: la m\u00e9thode [xml2dict.unparse] exisge que le dictionnaire soit de la forme {\u2018cl\u00e9\u2019\u00a0: valeur} o\u00f9 [valeur] peut \u00eatre ensuite un dictionnaire, une liste, un type simple\u00a0;</li> <li>lignes 3-4\u00a0: la cha\u00eene XML issue du dictionnaire. Elle est pr\u00e9c\u00e9d\u00e9e de l\u2019ent\u00eate [&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\\n] qui est normalement la 1\u00e8re ligne d\u2019un fichier XML\u00a0;</li> <li>ligne 5\u00a0: le type [OrderedDict] obtenu par la m\u00e9thode [xml2dict.parse] recevant pour param\u00e8tre la cha\u00eene XML pr\u00e9c\u00e9dente\u00a0;</li> <li>ligne 6\u00a0: le dictionnaire de type [dict] obtenu en appliquant la m\u00e9thode [ordereddict2dict] au type pr\u00e9c\u00e9dent. On retrouve le dictionnaire d\u2019origine de la ligne 2\u00a0; Tous les autres tests sont construits sur le m\u00eame sch\u00e9ma et devraient vous permettre de comprendre comment passer d\u2019un dictionnaire \u00e0 une cha\u00eene XML puis de cette cha\u00eene XML au dictionnaire d\u2019origine.</li> </ul> <p>Les autres tests donnent les r\u00e9sultats suivants\u00a0:</p> <pre><code>test 2-------\ndictionnaire={'famille': {'p\u00e8re': {'pr\u00e9nom': 'andr\u00e9'}, 'm\u00e8re': {'pr\u00e9nom': 'ang\u00e8le'}, 'nom': 's\u00e9l\u00e9n\u00e9'}}\nxml=&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;famille&gt;&lt;p\u00e8re&gt;&lt;pr\u00e9nom&gt;andr\u00e9&lt;/pr\u00e9nom&gt;&lt;/p\u00e8re&gt;&lt;m\u00e8re&gt;&lt;pr\u00e9nom&gt;ang\u00e8le&lt;/pr\u00e9nom&gt;&lt;/m\u00e8re&gt;&lt;nom&gt;s\u00e9l\u00e9n\u00e9&lt;/nom&gt;&lt;/famille&gt;\nordereddict_dictionary1=OrderedDict([('famille', OrderedDict([('p\u00e8re', OrderedDict([('pr\u00e9nom', 'andr\u00e9')])), ('m\u00e8re', OrderedDict([('pr\u00e9nom', 'ang\u00e8le')])), ('nom', 's\u00e9l\u00e9n\u00e9')]))])\ndict_dictionary1={'famille': {'p\u00e8re': {'pr\u00e9nom': 'andr\u00e9'}, 'm\u00e8re': {'pr\u00e9nom': 'ang\u00e8le'}, 'nom': 's\u00e9l\u00e9n\u00e9'}}\n\ntest 3-------\ndictionnaire={'famille': {'nom': 's\u00e9l\u00e9n\u00e9', 'p\u00e8re': {'pr\u00e9nom': 'andr\u00e9'}, 'm\u00e8re': {'pr\u00e9nom': 'ang\u00e8le'}, 'hobbies': ['chant', 'footing']}}\nxml=&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;famille&gt;&lt;nom&gt;s\u00e9l\u00e9n\u00e9&lt;/nom&gt;&lt;p\u00e8re&gt;&lt;pr\u00e9nom&gt;andr\u00e9&lt;/pr\u00e9nom&gt;&lt;/p\u00e8re&gt;&lt;m\u00e8re&gt;&lt;pr\u00e9nom&gt;ang\u00e8le&lt;/pr\u00e9nom&gt;&lt;/m\u00e8re&gt;&lt;hobbies&gt;chant&lt;/hobbies&gt;&lt;hobbies&gt;footing&lt;/hobbies&gt;&lt;/famille&gt;\nordereddict_dictionary1=OrderedDict([('famille', OrderedDict([('nom', 's\u00e9l\u00e9n\u00e9'), ('p\u00e8re', OrderedDict([('pr\u00e9nom', 'andr\u00e9')])), ('m\u00e8re', OrderedDict([('pr\u00e9nom', 'ang\u00e8le')])), ('hobbies', ['chant', 'footing'])]))])\ndict_dictionary1={'famille': {'nom': 's\u00e9l\u00e9n\u00e9', 'p\u00e8re': {'pr\u00e9nom': 'andr\u00e9'}, 'm\u00e8re': {'pr\u00e9nom': 'ang\u00e8le'}, 'hobbies': ['chant', 'footing']}}\n\ntest 4-------\ndictionnaire={'r\u00e9ponse': {'erreurs': ['M\u00e9thode GET requise avec les seuls param\u00e8tres [mari\u00e9, enfants, salaire]', 'param\u00e8tre [mari\u00e9] manquant', 'param\u00e8tre [enfants] manquant', 'param\u00e8tre [salaire] manquant']}}\nxml=&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;r\u00e9ponse&gt;&lt;erreurs&gt;M\u00e9thode GET requise avec les seuls param\u00e8tres [mari\u00e9, enfants, salaire]&lt;/erreurs&gt;&lt;erreurs&gt;param\u00e8tre [mari\u00e9] manquant&lt;/erreurs&gt;&lt;erreurs&gt;param\u00e8tre [enfants] manquant&lt;/erreurs&gt;&lt;erreurs&gt;param\u00e8tre [salaire] manquant&lt;/erreurs&gt;&lt;/r\u00e9ponse&gt;\nordereddict_dictionary1=OrderedDict([('r\u00e9ponse', OrderedDict([('erreurs', ['M\u00e9thode GET requise avec les seuls param\u00e8tres [mari\u00e9, enfants, salaire]', 'param\u00e8tre [mari\u00e9] manquant', 'param\u00e8tre [enfants] manquant', 'param\u00e8tre [salaire] manquant'])]))])\ndict_dictionary1={'r\u00e9ponse': {'erreurs': ['M\u00e9thode GET requise avec les seuls param\u00e8tres [mari\u00e9, enfants, salaire]', 'param\u00e8tre [mari\u00e9] manquant', 'param\u00e8tre [enfants] manquant', 'param\u00e8tre [salaire] manquant']}}\n\ntest 5-------\ndictionnaire={'r\u00e9ponse': {'result': {'id': 0, 'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 50000, 'imp\u00f4t': 1384, 'd\u00e9c\u00f4te': 384, 'surc\u00f4te': 0, 'r\u00e9duction': 347, 'taux': 0.14}}}\nxml=&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;r\u00e9ponse&gt;&lt;result&gt;&lt;id&gt;0&lt;/id&gt;&lt;mari\u00e9&gt;oui&lt;/mari\u00e9&gt;&lt;enfants&gt;2&lt;/enfants&gt;&lt;salaire&gt;50000&lt;/salaire&gt;&lt;imp\u00f4t&gt;1384&lt;/imp\u00f4t&gt;&lt;d\u00e9c\u00f4te&gt;384&lt;/d\u00e9c\u00f4te&gt;&lt;surc\u00f4te&gt;0&lt;/surc\u00f4te&gt;&lt;r\u00e9duction&gt;347&lt;/r\u00e9duction&gt;&lt;taux&gt;0.14&lt;/taux&gt;&lt;/result&gt;&lt;/r\u00e9ponse&gt;\nordereddict_dictionary1=OrderedDict([('r\u00e9ponse', OrderedDict([('result', OrderedDict([('id', '0'), ('mari\u00e9', 'oui'), ('enfants', '2'), ('salaire', '50000'), ('imp\u00f4t', '1384'), ('d\u00e9c\u00f4te', '384'), ('surc\u00f4te', '0'), ('r\u00e9duction', '347'), ('taux', '0.14')]))]))])\ndict_dictionary1={'r\u00e9ponse': {'result': {'id': '0', 'mari\u00e9': 'oui', 'enfants': '2', 'salaire': '50000', 'imp\u00f4t': '1384', 'd\u00e9c\u00f4te': '384', 'surc\u00f4te': '0', 'r\u00e9duction': '347', 'taux': '0.14'}}}\n\ntest 6-------\ndictionnaire={'root': {'liste': ['un', 'deux', 'trois']}}\nxml=&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;liste&gt;un&lt;/liste&gt;&lt;liste&gt;deux&lt;/liste&gt;&lt;liste&gt;trois&lt;/liste&gt;&lt;/root&gt;\nordereddict_dictionary1=OrderedDict([('root', OrderedDict([('liste', ['un', 'deux', 'trois'])]))])\ndict_dictionary1={'root': {'liste': ['un', 'deux', 'trois']}}\n\ntest 7-------\ndictionnaire={'root': {'liste': [{'un': [10, 11]}, {'deux': [20, 21]}, {'trois': [30, 31]}]}}\nxml=&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;root&gt;&lt;liste&gt;&lt;un&gt;10&lt;/un&gt;&lt;un&gt;11&lt;/un&gt;&lt;/liste&gt;&lt;liste&gt;&lt;deux&gt;20&lt;/deux&gt;&lt;deux&gt;21&lt;/deux&gt;&lt;/liste&gt;&lt;liste&gt;&lt;trois&gt;30&lt;/trois&gt;&lt;trois&gt;31&lt;/trois&gt;&lt;/liste&gt;&lt;/root&gt;\nordereddict_dictionary1=OrderedDict([('root', OrderedDict([('liste', [OrderedDict([('un', ['10', '11'])]), OrderedDict([('deux', ['20', '21'])]), OrderedDict([('trois', ['30', '31'])])])]))])\ndict_dictionary1={'root': {'liste': [{'un': ['10', '11']}, {'deux': ['20', '21']}, {'trois': ['30', '31']}]}}\n\nProcess finished with exit code 0\n</code></pre> <ul> <li>les lignes 23 et 27 montrent un point important\u00a0:</li> <li>ligne 23\u00a0: les valeurs associ\u00e9es aux cl\u00e9s du dictionnaire [result] sont des nombres\u00a0;</li> <li>ligne 26\u00a0: les valeurs associ\u00e9es aux cl\u00e9s du dictionnaire [ordereddict_dictionary1] sont des cha\u00eenes de caract\u00e8res. C\u2019est une faiblesse de la biblioth\u00e8que [xmltodict]. Sa m\u00e9thode [parse] ne produit que des cha\u00eenes de caract\u00e8res. Cela peut se comprendre ais\u00e9ment\u00a0:</li> <li>ligne 25\u00a0: la cha\u00eene XML \u00e0 partir de laquelle est produit le dictionnaire. Dans cette cha\u00eene, il n\u2019y a aucune indication du type des donn\u00e9es encapsul\u00e9es dans les balises XML. [xmltodict.parse] fait ce qu\u2019il y a de plus logique\u00a0: elle laisse tout en cha\u00eene de caract\u00e8res dans le dictionnaire produit. On trouve d\u2019autres biblioth\u00e8ques similaires \u00e0 [xmltodict] o\u00f9 le type des donn\u00e9es encapsul\u00e9es est indiqu\u00e9 dans les balises. On pourrait trouver par exemple la balise [&lt;enfants type=\u2019int\u2019&gt;2&lt;/enfants&gt;]\u00a0;</li> <li>la cons\u00e9quence de ceci est que lorsqu\u2019on exploite un dictionnaire produit par le module [xmltodict] on doit conna\u00eetre le type des donn\u00e9es qu\u2019il encapsule\u00a0pour pouvoir passer du type \u2018str\u2019 au type r\u00e9el de la donn\u00e9e\u00a0; Attardons-nous maintenant sur la m\u00e9thode [ordereddict2dict] qui transforme un type [OrderedDict] en type [dict]\u00a0:</li> </ul> <pre><code># xmltodict.parse pour passer du XML au dictionnaire. Le dictionnaire doit avoir une racine\n# le dictionnaire produit est de type OrderedDict\n# xmltodict.unparse pour passer du dictionnaire au XML\n\ndef check(value):\n    # si la valeur est de type OrderedDict, on la transforme\n    if isinstance(value, OrderedDict):\n        value2 = ordereddict2dict(value)\n    # si la valeur est de type list, on la transforme\n    elif isinstance(value, list):\n        value2 = list2list(value)\n    else:\n        # on est en pr\u00e9sence d'un type simple pas d'une collection\n        value2 = value\n    # on rend la nouvelle valeur\n    return value2\n\n\ndef list2list(liste: list) -&gt; list:\n    # la nouvelle liste\n    newliste = []\n    # on exploite les \u00e9l\u00e9ments de la liste param\u00e8tre\n    for value in liste:\n        # on ajoute value \u00e0 la nouvelle liste\n        newliste.append(check(value))\n    # on rend la nouvelle liste\n    return newliste\n\n\ndef ordereddict2dict(ordered_dictionary: OrderedDict) -&gt; dict:\n    # OrderedDict -&gt; dict de fa\u00e7on r\u00e9cursive\n    newdict = {}\n    for key, value in ordered_dictionary.items():\n        # on m\u00e9morise la valeur dans le nouveau dictionnaire\n        newdict[key] = check(value)\n    # on rend le dictionnaire\n    return newdict\n</code></pre> <ul> <li>ligne 30\u00a0: la fonction [ordereddict2dict] re\u00e7oit un type [OrderedDict] comme param\u00e8tre\u00a0;</li> <li>ligne 32\u00a0: le dictionnaire de type [dict] qui sera rendu ligne 37 par la fonction\u00a0;</li> <li>ligne 33\u00a0: on explore tous les tuples (cl\u00e9, valeur) du dictionnaire [ordered_dictionary]\u00a0;</li> <li> <p>ligne 35\u00a0: dans le nouveau dictionnaire, la cl\u00e9 [key] est gard\u00e9e mais la valeur associ\u00e9e n\u2019est pas [value] mais [check(value)]. La fonction [check(value)] est charg\u00e9e de trouver, si [value] est une collection, tous les \u00e9l\u00e9ments de type [OrderedDict] et de les transformer en type [dict]\u00a0; La m\u00e9thode [check] est d\u00e9finie aux lignes 5-16\u00a0:</p> </li> <li> <p>ligne 5\u00a0: on ne conna\u00eet pas le type de [value], aussi n\u2019a-t-on pu \u00e9crire [value\u00a0: type]\u00a0;</p> </li> <li>lignes 7-8\u00a0: si [value] est de type [OrderedDict] alors on appelle de fa\u00e7on r\u00e9cursive la fonction [ordereddict2dict] qu\u2019on vient de commenter\u00a0;</li> <li>lignes 9-11\u00a0: un autre cas possible est que [value] soit une liste. Dans ce cas, ligne 11, on appelle la fonction [list2list] des 19-27\u00a0;</li> <li>lignes 12-14\u00a0: le dernier cas est que [value] n\u2019est pas une collection mais un type simple. La fonction [check], comme les fonctions [ordereddict2dict] et [list2list] sont r\u00e9cursives. On sait qu\u2019alors il faut toujours pr\u00e9voir le cas o\u00f9 la r\u00e9cursion s\u2019arr\u00eate. Les lignes 12-14 sont ce cas\u00a0;</li> <li> <p>ligne 16\u00a0: la fonction [check] appel\u00e9e r\u00e9cursivement ou pas produit une valeur [valeur2] qui doit remplacer le param\u00e8tre [value] de la ligne 5\u00a0; La m\u00e9thode [list2list] d\u00e9finie aux lignes 19-27\u00a0exploite une liste pass\u00e9e en param\u00e8tre. Elle va l\u2019explorer et remplacer toute valeur de type [OrderedDict] trouv\u00e9e dedans en un type [dict].</p> </li> <li> <p>ligne 21\u00a0: la nouvelle liste que va cr\u00e9er la fonction\u00a0;</p> </li> <li>lignes 23-25\u00a0: toutes les valeurs [value] de la liste sont explor\u00e9es et remplac\u00e9es par la valeur [check(value)]. Cette valeur [value] peut elle-m\u00eame contenir des \u00e9l\u00e9ments de type [list] ou [OrderedDict]. Ils seront trait\u00e9s correctement par la fonction r\u00e9cursive [check]\u00a0;</li> </ul>"},{"location":"ecrire-du-code-independant-du-sgbd.html","title":"18. Ecrire du code ind\u00e9pendant du SGBD","text":"<p>Nous avons vu pr\u00e9c\u00e9demment que dans certains cas il \u00e9tait possible de migrer simplement du code Python \u00e9crit pour le SGBD MySQL vers du code \u00e9crit pour le SGBD PostgreSQL. Dans ce chapitre, nous montrons comment syst\u00e9matiser cette approche. L\u2019architecture propos\u00e9e devient la suivante\u00a0:</p> <p></p> <p>On souhaite que le choix du connecteur et donc du SGBD se fasse par configuration et ne n\u00e9cessite pas de r\u00e9\u00e9criture du script. On rappelle que cela n\u2019est possible que dans les cas o\u00f9 le script n\u2019utilise pas d\u2019extensions propri\u00e9taires du SGBD.</p> <p>L\u2019arborescence des scripts sera la suivante\u00a0:</p> <p></p> <p>Les scripts [any_xx] reprennent les scripts d\u00e9j\u00e0 \u00e9tudi\u00e9s pour les SGBD MySQL et PostgreSQL. Nous n\u2019allons pas tous les reprendre. Nous allons nous concentrer sur le script [any_04] qui est le plus complexe. On rappelle que ce script ex\u00e9cute les commandes SQL du fichier [data/commandes.sql] suivant\u00a0:</p> <pre><code># suppression de la table [personnes]\ndrop table if exists personnes\n# cr\u00e9ation de la table personnes\ncreate table personnes (id int primary key, prenom varchar(30) not null, nom varchar(30) not null, age integer not null, unique (nom,prenom))\n# insertion de deux personnes\ninsert into personnes(id, prenom, nom, age) values(1, 'Paul','Langevin',48)\ninsert into personnes(id, prenom, nom, age) values (2, 'Sylvie','Lefur',70)\n# affichage de la table\nselect prenom, nom, age from personnes\n# erreur volontaire\nxx\n# insertion de trois personnes\ninsert into personnes(id, prenom, nom, age) values (3, 'Pierre','Nicazou',35)\ninsert into personnes(id, prenom, nom, age) values (4, 'Geraldine','Colou',26)\ninsert into personnes(id, prenom, nom, age) values (5, 'Paulette','Girond',56)\n# affichage de la table\nselect prenom, nom, age from personnes\n# liste des personnes par ordre alphab\u00e9tique des noms et \u00e0 nom \u00e9gal par ordre alphab\u00e9tique des pr\u00e9noms\nselect nom,prenom from personnes order by nom asc, prenom desc\n# liste des personnes ayant un \u00e2ge dans l'intervalle [20,40] par ordre d\u00e9croissant de l'\u00e2ge\n# puis \u00e0 \u00e2ge \u00e9gal par ordre alphab\u00e9tique des noms et \u00e0 nom \u00e9gal par ordre alphab\u00e9tique des pr\u00e9noms\nselect nom,prenom,age from personnes where age between 20 and 40 order by age desc, nom asc, prenom asc\n# insertion de mme Bruneau\ninsert into personnes(id, prenom, nom, age) values(6, 'Josette','Bruneau',46)\n# mise \u00e0 jour de son \u00e2ge\nupdate personnes set age=47 where nom='Bruneau'\n# liste des personnes ayant Bruneau pour nom\nselect nom,prenom,age from personnes where nom='Bruneau'\n# suppression de Mme Bruneau\ndelete from personnes where nom='Bruneau'\n# liste des personnes ayant Bruneau pour nom\nselect nom,prenom,age from personnes where nom='Bruneau'\n</code></pre> <p>Nous avons modifi\u00e9 la ligne 2 pour que la commande ait le m\u00eame comportement pour les SGBD MySQL et PostgreSQL si la table [personnes] n\u2019existe pas.</p> <p>Le script [any_04] est configur\u00e9 par le script [config.py] suivant\u00a0:</p> <pre><code>def\u00a0configure():\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0absolu\u00a0du\u00a0dossier\u00a0de\u00a0ce\u00a0script\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0des\u00a0dossiers\u00a0du\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossiers\u00a0locaux\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/shared\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0fixation\u00a0du\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0sgbd\u00a0g\u00e9r\u00e9s\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"sgbds\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"mysql\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0connecteur\u00a0du\u00a0sgbd\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"sgbd_connector\":\u00a0\"mysql.connector\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0nom\u00a0du\u00a0module\u00a0rassemblant\u00a0des\u00a0fonctions\u00a0de\u00a0gestion\u00a0du\u00a0sgbd\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"sgbd_fonctions\":\u00a0\"any_module\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0identifiants\u00a0de\u00a0la\u00a0connexion\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"user\":\u00a0\"admpersonnes\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"nobody\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"host\":\u00a0\"localhost\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"database\":\u00a0\"dbpersonnes\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"postgresql\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0connecteur\u00a0du\u00a0sgbd\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"sgbd_connector\":\u00a0\"psycopg2\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0nom\u00a0du\u00a0module\u00a0rassemblant\u00a0des\u00a0fonctions\u00a0de\u00a0gestion\u00a0du\u00a0sgbd\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"sgbd_fonctions\":\u00a0\"any_module\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0identifiants\u00a0de\u00a0la\u00a0connexion\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"user\":\u00a0\"admpersonnes\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"nobody\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"host\":\u00a0\"localhost\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"database\":\u00a0\"dbpersonnes\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0de\u00a0commandes\u00a0SQL\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"commands_filename\":\u00a0f\"{script_dir}/data/commandes.sql\"\n\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0#\u00a0syspath\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <p>La nouveaut\u00e9 r\u00e9side dans les lignes 18-43\u00a0:</p> <ul> <li>ligne 20\u00a0: [sgbds] est un dictionnaire avec deux cl\u00e9s [mysql] ligne 21 et [postgresql] ligne 32\u00a0;</li> <li>la valeur associ\u00e9e \u00e0 ces cl\u00e9s est un dictionnaire donnant les \u00e9l\u00e9ments permettant la connexion \u00e0 un SGBD\u00a0:</li> <li>lignes 21-32\u00a0: les \u00e9l\u00e9ments d\u2019une connexion au SGBD MySQL\u00a0;</li> <li>ligne 23\u00a0: le connecteur Python \u00e0 utiliser\u00a0;</li> <li>ligne 25\u00a0: le module contenant des fonctions partag\u00e9es\u00a0;</li> <li>lignes 26-30\u00a0: les identifiants de la connexion\u00a0;</li> <li>lignes 32-41\u00a0: les m\u00eames \u00e9l\u00e9ments pour une connexion au SGBD PostgreSQL\u00a0; Le script [any_04] qui ex\u00e9cute le fichier de commandes SQL [data/commandes.sql] est le suivant\u00a0:</li> </ul> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nimport importlib\nimport sys\n\n# v\u00e9rification de la syntaxe de l'appel\n# argv[0] sgbd_name true / false\n# il faut 3 param\u00e8tres\nargs = sys.argv\nerreur = len(args) != 3\nif not erreur:\n    # on r\u00e9cup\u00e8re les deux param\u00e8tres qui nous int\u00e9ressent\n    sgbd_name = args[1].lower()\n    with_transaction = args[2].lower()\n    # v\u00e9rification des deux param\u00e8tres\n    erreur = (with_transaction != \"true\" and with_transaction != \"false\") \\\n             or sgbd_name not in config[\"sgbds\"].keys()\n# erreur ?\nif erreur:\n    print(f\"syntaxe : {args[0]} (1) sgbd_name (2) true / false\")\n    sys.exit()\n\n# configuration du sgbd_name\nsgbd_config = config[\"sgbds\"][sgbd_name]\n# connecteur du sgbd_name\nsgbd_connector = importlib.import_module(sgbd_config[\"sgbd_connector\"])\n# biblioth\u00e8que de fonctions\nlib = importlib.import_module(sgbd_config[\"sgbd_fonctions\"])\n\n\n# calcul d'un texte \u00e0 afficher\nwith_transaction = with_transaction == \"true\"\nif with_transaction:\n    texte = \"avec transaction\"\nelse:\n    texte = \"sans transaction\"\n\n# affichage\ncommands_filename=config['commands_filename']\nprint(\"--------------------------------------------------------------------\")\nprint(f\"Ex\u00e9cution du fichier SQL {commands_filename} {texte}\")\nprint(\"--------------------------------------------------------------------\")\n\n# ex\u00e9cution des ordres SQL du fichier\nconnexion = None\ntry:\n    # connexion\n    connexion = sgbd_connector.connect(\n        host=sgbd_config['host'],\n        user=sgbd_config['user'],\n        password=sgbd_config['password'],\n        database=sgbd_config['database'])\n    # ex\u00e9cution du fichier des commandes SQL\n    erreurs = lib.execute_file_of_commands(sgbd_connector, connexion, commands_filename, suivi=True, arr\u00eat=False,\n                                           with_transaction=with_transaction)\nexcept (sgbd_connector.InterfaceError, sgbd_connector.DatabaseError) as erreur:\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\nfinally:\n    # fermeture de la connexion\n    if connexion:\n        connexion.close()\n\n# affichage nombre d'erreurs\nprint(\"--------------------------------------------------------------------\")\nprint(f\"Ex\u00e9cution termin\u00e9e\")\nprint(\"--------------------------------------------------------------------\")\nprint(f\"Il y a eu {len(erreurs)} erreur(s)\")\n# affichage des erreurs\nfor erreur in erreurs:\n    print(erreur)\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 1-4\u00a0: on r\u00e9cup\u00e8re la configuration [config] de l\u2019application\u00a0;</li> <li>lignes 10-21\u00a0: le script s\u2019appelle avec deux param\u00e8tres [sgbd_name with_transaction]\u00a0:</li> <li>[sgbd_name]\u00a0: le nom du SGBD \u00e0 utiliser\u00a0;</li> <li>[with_transaction]\u00a0: True si on veut ex\u00e9cuter le fichier de commandes SQL au sein d\u2019une transaction, False sinon\u00a0;</li> <li>lignes 10-25\u00a0: les param\u00e8tres sont r\u00e9cup\u00e9r\u00e9s et v\u00e9rifi\u00e9s\u00a0;</li> <li>ligne 28\u00a0: la configuration du SGBD choisi\u00a0;</li> <li>ligne 30\u00a0: on importe le connecteur du SGBD choisi. On utilise pour cela la biblioth\u00e8que [importlib] (ligne 7) qui permet d\u2019importer un module dont le nom est dans une variable. Le r\u00e9sultat de l\u2019op\u00e9ration [importlib.import_module] est un module. Ainsi apr\u00e8s la ligne 30, tout se passe comme si l\u2019instruction ex\u00e9cut\u00e9e avait \u00e9t\u00e9\u00a0: <pre><code>import sgbd_connector\n</code></pre></li> </ul> <p>Ceci va nous permettre d\u2019\u00e9crire ligne 52 [sgbd_connector.connect] o\u00f9 on utilise la fonction [connect] du module [sgbd_connector]. Il faut se rappeler ici que [sgbd_connector] est soit [mysql.connector] ou [psycopg2]. Ces deux modules ont la fonction [connect]. De m\u00eame, ligne 60, on peut \u00e9crire [sgbd_connector.InterfaceError, sgbd_connector.DatabaseError].</p> <ul> <li>ligne 32\u00a0: on importe le module des fonctions utilis\u00e9es par le script\u00a0;</li> <li>ligne 58\u00a0: on ex\u00e9cute la fonction [execute_file_of_commands] du module des fonctions utilis\u00e9es par le script. Par rapport aux versions pr\u00e9c\u00e9dentes, la signature de cette fonction a un param\u00e8tre de plus, le premier. On passe \u00e0 la fonction le connecteur Python [sgbd_connector] qu\u2019elle doit utiliser\u00a0;</li> <li>en-dehors de ces points, le script [any_04] reste ce qu\u2019il \u00e9tait dans les versions pr\u00e9c\u00e9dentes\u00a0; La biblioth\u00e8que de fonctions [any_module] est la suivante\u00a0:</li> </ul> <pre><code># ---------------------------------------------------------------------------------\n\ndef afficher_infos(curseur):\n    \u2026\n\n\n# ---------------------------------------------------------------------------------\ndef execute_list_of_commands(sgbd_connector, connexion, sql_commands: list,\n                             suivi: bool = False, arr\u00eat: bool = True, with_transaction: bool = True):\n    \u2026\n\n    # initialisations\n    curseur = None\n    connexion.autocommit = not with_transaction\n    erreurs = []\n    try:\n        # on demande un curseur\n        curseur = connexion.cursor()\n        # ex\u00e9cution des sql_commands SQL contenues dans sql_commands\n        # on les ex\u00e9cute une \u00e0 une\n        for command in sql_commands:\n            # on \u00e9limine les blancs de d\u00e9but et de fin de la commande courante\n            command = command.strip()\n            # a-t-on une commande vide ou un commentaire ? Si oui, on passe \u00e0 la commande suivante\n            if command == '' or command[0] == \"#\":\n                continue\n            # ex\u00e9cution de la commande courante\n            error = None\n            try:\n                curseur.execute(command)\n            except (sgbd_connector.InterfaceError, sgbd_connector.DatabaseError) as erreur:\n                error = erreur\n            # y-a-t-il eu une erreur ?\n            \u2026\n\n\n# ---------------------------------------------------------------------------------\ndef execute_file_of_commands(sgbd_connector, connexion, sql_filename: str,\n                             suivi: bool = False, arr\u00eat: bool = True, with_transaction: bool = True):\n    \u2026\n\n    # exploitation du fichier SQL\n    try:\n        # ouverture du fichier en lecture\n        file = open(sql_filename, \"r\")\n        # exploitation\n        return execute_list_of_commands(sgbd_connector, connexion, file.readlines(), suivi, arr\u00eat, with_transaction)\n    except BaseException as erreur:\n        # on rend un tableau d'erreurs\n        return [f\"Le fichier {sql_filename} n'a pu \u00eatre \u00eatre exploit\u00e9 : {erreur}\"]\n    finally:\n        pass\n</code></pre> <p>Le param\u00e8tre [sgbd_connector] a \u00e9t\u00e9 utilis\u00e9 ligne 31 pour pr\u00e9ciser le type des exceptions intercept\u00e9es.</p> <p>L\u2019ex\u00e9cution du script [any_04] avec les param\u00e8tres [mysql false] donne les r\u00e9sultats suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/anysgbd/any_04.py mysql false\n--------------------------------------------------------------------\nEx\u00e9cution du fichier SQL C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\databases\\anysgbd/data/commandes.sql sans transaction\n--------------------------------------------------------------------\n[drop table if exists personnes] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 0\n[create table personnes (id int primary key, prenom varchar(30) not null, nom varchar(30) not null, age integer not null, unique (nom,prenom))] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 0\n[insert into personnes(id, prenom, nom, age) values(1, 'Paul','Langevin',48)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[insert into personnes(id, prenom, nom, age) values (2, 'Sylvie','Lefur',70)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[select prenom, nom, age from personnes] : Ex\u00e9cution r\u00e9ussie\nprenom, nom, age,\n*****************\n('Paul', 'Langevin', 48)\n('Sylvie', 'Lefur', 70)\n*****************\nxx : Erreur (1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'xx' at line 1)\n[insert into personnes(id, prenom, nom, age) values (3, 'Pierre','Nicazou',35)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[insert into personnes(id, prenom, nom, age) values (4, 'Geraldine','Colou',26)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[insert into personnes(id, prenom, nom, age) values (5, 'Paulette','Girond',56)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[select prenom, nom, age from personnes] : Ex\u00e9cution r\u00e9ussie\nprenom, nom, age,\n*****************\n('Paul', 'Langevin', 48)\n('Sylvie', 'Lefur', 70)\n('Pierre', 'Nicazou', 35)\n('Geraldine', 'Colou', 26)\n('Paulette', 'Girond', 56)\n*****************\n[select nom,prenom from personnes order by nom asc, prenom desc] : Ex\u00e9cution r\u00e9ussie\nnom, prenom,\n************\n('Colou', 'Geraldine')\n('Girond', 'Paulette')\n('Langevin', 'Paul')\n('Lefur', 'Sylvie')\n('Nicazou', 'Pierre')\n************\n[select nom,prenom,age from personnes where age between 20 and 40 order by age desc, nom asc, prenom asc] : Ex\u00e9cution r\u00e9ussie\nnom, prenom, age,\n*****************\n('Nicazou', 'Pierre', 35)\n('Colou', 'Geraldine', 26)\n*****************\n[insert into personnes(id, prenom, nom, age) values(6, 'Josette','Bruneau',46)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[update personnes set age=47 where nom='Bruneau'] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[select nom,prenom,age from personnes where nom='Bruneau'] : Ex\u00e9cution r\u00e9ussie\nnom, prenom, age,\n*****************\n('Bruneau', 'Josette', 47)\n*****************\n[delete from personnes where nom='Bruneau'] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[select nom,prenom,age from personnes where nom='Bruneau'] : Ex\u00e9cution r\u00e9ussie\nnom, prenom, age,\n*****************\n*****************\n--------------------------------------------------------------------\nEx\u00e9cution termin\u00e9e\n--------------------------------------------------------------------\nIl y a eu 1 erreur(s)\nxx : Erreur (1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'xx' at line 1)\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"exercice-dapplication-version-10.html","title":"28. Exercice d\u2019application\u00a0: version 10","text":""},{"location":"exercice-dapplication-version-10.html#281-introduction","title":"28.1. Introduction","text":"<p>Dans les exemples de clients du serveur de calcul de l\u2019imp\u00f4t, les threads envoyaient N requ\u00eates s\u00e9quentiellement si elles devaient traiter N contribuables. L\u2019id\u00e9e ici est d\u2019envoyer une seule requ\u00eate encapsulant les N contribuables. Pour chacun d\u2019entre-eux, il faut envoyer les informations [mari\u00e9, enfants, salaire]. On peut les envoyer comme param\u00e8tres\u00a0:</p> <ul> <li>de l\u2019URL. On aura alors une longue URL peu significative\u00a0;</li> <li>dans le corps (body) de la requ\u00eate HTTP. On sait que ce corps est cach\u00e9 \u00e0 l\u2019utilisateur utilisant un navigateur\u00a0; Dans les deux cas, on peut utiliser une requ\u00eate [GET] ou [POST]. Nous utiliserons une requ\u00eate POST avec les param\u00e8tres encapsul\u00e9s dans le corps de la requ\u00eate HTTP.</li> </ul> <p>L\u2019architecture client / serveur n\u2019a pas chang\u00e9\u00a0:</p> <p></p>"},{"location":"exercice-dapplication-version-10.html#282-le-serveur-web","title":"28.2. Le serveur web","text":"<p>Le dossier [http-servers/05] est obtenu initialement par recopie du dossier [http-servers/02]. On revient aux \u00e9changes jSON entre le client et le serveur. On a vu que passer du jSON au XML est tr\u00e8s simple.</p>"},{"location":"exercice-dapplication-version-10.html#2821-configuration","title":"28.2.1. Configuration","text":"<p>La configuration [config, config_database, config_layers] reste analogue \u00e0 celle des versions pr\u00e9c\u00e9dentes. Nous ne revenons pas dessus.</p>"},{"location":"exercice-dapplication-version-10.html#2822-le-script-principal-main","title":"28.2.2. Le script principal [main]","text":"<p>Le script [main] est identique \u00e0 celui du dossier [http-servers/02] qu\u2019on a recopi\u00e9. Une seule chose diff\u00e8re\u00a0:</p> <pre><code># Home URL\n@app.route('/', methods=['POST'])\n@auth.login_required\ndef index():\n    \u2026\n</code></pre> <ul> <li>ligne 2\u00a0: d\u00e9sormais l\u2019URL / s\u2019obtient via un POST\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-10.html#2823-le-controleur-index_controller","title":"28.2.3. Le contr\u00f4leur [index_controller]","text":"<p>Le contr\u00f4leur [index_controller] \u00e9volue de la fa\u00e7on suivante\u00a0:</p> <pre><code># import des d\u00e9pendances\n\nimport json\n\nfrom flask_api import status\nfrom werkzeug.local import LocalProxy\n\n\ndef execute(request: LocalProxy, config: dict) -&gt; tuple:\n    # d\u00e9pendances\n    from Imp\u00f4tsError import Imp\u00f4tsError\n    from TaxPayer import TaxPayer\n\n    # on r\u00e9cup\u00e8re le corps du post - on attend une liste de dictionnaires\n    msg_erreur = None\n    list_dict_taxpayers = None\n    # le corps jSON du POST\n    request_text = request.data\n    try:\n        # qu'on transforme en une liste de dictionnaires\n        list_dict_taxpayers = json.loads(request_text)\n    except BaseException as erreur:\n        # on note l'erreur\n        msg_erreur = f\"le corps du POST n'est pas une cha\u00eene jSON valide : {erreur}\"\n    # a-t-on une liste non vide ?\n    if not msg_erreur and (not isinstance(list_dict_taxpayers, list) or len(list_dict_taxpayers) == 0):\n        # on note l'erreur\n        msg_erreur = \"le corps du POST n'est pas une liste ou alors cette liste est vide\"\n    # a-t-on une liste de dictionnaires ?\n    if not msg_erreur:\n        erreur = False\n        i = 0\n        while not erreur and i &lt; len(list_dict_taxpayers):\n            erreur = not isinstance(list_dict_taxpayers[i], dict)\n            i += 1\n        # erreur ?\n        if erreur:\n            msg_erreur = \"le corps du POST doit \u00eatre une liste de dictionnaires\"\n    # erreur ?\n    if msg_erreur:\n        # on envoie une r\u00e9ponse d'erreur au client\n        r\u00e9sultats = {\"r\u00e9ponse\": {\"erreurs\": [msg_erreur]}}\n        return r\u00e9sultats, status.HTTP_400_BAD_REQUEST\n\n    # on v\u00e9rifie les TaxPayers un par un\n    # au d\u00e9part pas d'erreurs\n    list_erreurs = []\n    for dict_taxpayer in list_dict_taxpayers:\n        # on cr\u00e9e un TaxPayer \u00e0 partir de dict_taxpayer\n        msg_erreur = None\n        try:\n            # l'op\u00e9ration suivante va \u00e9liminer les cas o\u00f9 les param\u00e8tres ne sont pas\n            # des propri\u00e9t\u00e9s de la classe TaxPayer ainsi que les cas o\u00f9 leurs valeurs\n            # sont incorrectes\n            TaxPayer().fromdict(dict_taxpayer)\n        except BaseException as erreur:\n            msg_erreur = f\"{erreur}\"\n        # certaines cl\u00e9s doivent \u00eatre pr\u00e9sentes dans le dictionnaire\n        if not msg_erreur:\n            # les cl\u00e9s [mari\u00e9, enfants, salaire] doivent \u00eatre pr\u00e9sentes dans le dictionnaire\n            keys = dict_taxpayer.keys()\n            if 'mari\u00e9' not in keys or 'enfants' not in keys or 'salaire' not in keys:\n                msg_erreur = \"le dictionnaire doit inclure les cl\u00e9s [mari\u00e9, enfants, salaire]\"\n        # des erreurs ?\n        if msg_erreur:\n            # on note l'erreur dans le TaxPayer lui-m\u00eame\n            dict_taxpayer['erreur'] = msg_erreur\n            # on ajoute le TaxPayer \u00e0 la liste des erreurs\n            list_erreurs.append(dict_taxpayer)\n\n    # on a trait\u00e9 tous les taxpayers - y-a-t-il des erreurs ?\n    if list_erreurs:\n        # on envoie une r\u00e9ponse d'erreur au client\n        r\u00e9sultats = {\"r\u00e9ponse\": {\"erreurs\": list_erreurs}}\n        return r\u00e9sultats, status.HTTP_400_BAD_REQUEST\n\n    # pas d'erreurs, on peut travailler\n    # r\u00e9cup\u00e9ration des donn\u00e9es de l'administration fiscale\n    admindata = config[\"admindata\"]\n    m\u00e9tier = config[\"layers\"][\"m\u00e9tier\"]\n    try:\n        # on traite les TaxPayer un \u00e0 un\n        list_taxpayers = []\n        for dict_taxpayer in list_dict_taxpayers:\n            # calcul de l'imp\u00f4t\n            taxpayer = TaxPayer().fromdict(\n                {'mari\u00e9': dict_taxpayer['mari\u00e9'], 'enfants': dict_taxpayer['enfants'],\n                 'salaire': dict_taxpayer['salaire']})\n            m\u00e9tier.calculate_tax(taxpayer, admindata)\n            # on m\u00e9morise le r\u00e9sultat en tant que dictionnaire\n            list_taxpayers.append(taxpayer.asdict())\n        # on envoie la r\u00e9ponse au client\n        return {\"r\u00e9ponse\": {\"results\": list_taxpayers}}, status.HTTP_200_OK\n    except Imp\u00f4tsError as erreur:\n        # on envoie une r\u00e9ponse d'erreur au client\n        return {\"r\u00e9ponse\": {\"erreurs\": f\"[{erreur}]\"}}, status.HTTP_500_INTERNAL_SERVER_ERROR\n</code></pre> <ul> <li>ligne 9\u00a0: le contr\u00f4leur re\u00e7oit\u00a0:</li> <li>la requ\u00eate [request] du client\u00a0;</li> <li>la configuration [config] du serveur\u00a0;</li> <li>lignes 14-18\u00a0: on r\u00e9cup\u00e8re le corps du POST. Les param\u00e8tres encapsul\u00e9s dans le corps de la requ\u00eate HTTP peuvent \u00eatre encod\u00e9s de diff\u00e9rentes fa\u00e7ons. Nous en avons d\u00e9j\u00e0 rencontr\u00e9 une\u00a0: [x-www-form-urlencoded]. Nous allons ici utiliser un autre encodage\u00a0: jSON\u00a0;</li> <li>ligne 18\u00a0: [request.data] permet de r\u00e9cup\u00e9rer le corps (body) de la requ\u00eate HTTP. On r\u00e9cup\u00e8re ici du texte et nous savons que ce texte est du jSON\u00a0qui repr\u00e9sente une liste de dictionnaire [mari\u00e9, enfants, salaire]\u00a0;</li> <li>lignes 19-24\u00a0: on r\u00e9cup\u00e8re cette liste de dictionnaires\u00a0;</li> <li>lignes 22-24\u00a0: si la r\u00e9cup\u00e9ration du jSON s\u2019est mal pass\u00e9e, on note l\u2019erreur\u00a0;</li> <li>lignes 26-28\u00a0: si on d\u00e9couvre que l\u2019objet r\u00e9cup\u00e9r\u00e9 n\u2019est pas une liste ou que c\u2019est une liste vode, on note l\u2019erreur\u00a0;</li> <li>lignes 29-38\u00a0: si on a bien r\u00e9cup\u00e9r\u00e9 une liste, on v\u00e9rifie que c\u2019est bien une liste de dictionnaires\u00a0;</li> <li>lignes 40-43\u00a0: s\u2019il y a eu erreur, on s\u2019arr\u00eate l\u00e0 et on envoie une r\u00e9ponse d\u2019erreur au client\u00a0;</li> <li>lignes 45-69\u00a0: on v\u00e9rifie maintenant chacun des dictionnaires\u00a0:</li> <li>ils doivent contenir les cl\u00e9s [mari\u00e9, enfants, salaire]\u00a0;</li> <li>ils doivent permettre de construire un objet [TaxPayer] valide\u00a0;</li> <li>lignes 65-69\u00a0: si une erreur a \u00e9t\u00e9 d\u00e9tect\u00e9e dans un dictionnaire, alors elle est mise dans ce m\u00eame dictionnaire associ\u00e9e \u00e0 la cl\u00e9 \u2018erreur\u2019\u00a0;</li> <li>lignes 72-75\u00a0: les dictionnaires erron\u00e9s ont \u00e9t\u00e9 cumul\u00e9s dans la liste [list_erreurs]. Si cette liste n\u2019est pas vide, alors on l\u2019envoie dans une r\u00e9ponse d\u2019erreur faite au client\u00a0;</li> <li>ligne 77\u00a0: arriv\u00e9 l\u00e0, on sait qu\u2019on peut cr\u00e9er une liste d\u2019objets de type [TaxPayer] \u00e0 partir du corps de la requ\u00eate envoy\u00e9e par le client\u00a0;</li> <li>lignes 84-91\u00a0: on exploite la liste\u00a0des dictionnaires re\u00e7us\u00a0;</li> <li>ligne 86\u00a0: \u00e0 partir d\u2019un dictionnaire, on cr\u00e9e un objet [TaxPayer]\u00a0;</li> <li>ligne 89\u00a0: on calcule l\u2019imp\u00f4t de ce [TaxPayer]\u00a0;</li> <li>ligne 91\u00a0: on sait que [taxpayer] a \u00e9t\u00e9 modifi\u00e9 par le calcul de l\u2019imp\u00f4t. On le transforme en dictionnaire et on l\u2019ajoute \u00e0 une liste de r\u00e9sultats\u00a0;</li> <li>ligne 93\u00a0: on envoie cette liste de r\u00e9sultats au client\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-10.html#2824-tests-du-serveur","title":"28.2.4. Tests du serveur","text":"<p>Nous allons tester le serveur avec un client Postman\u00a0:</p> <ul> <li>nous lan\u00e7ons le serveur web, le SGBD, le serveur de mails [hMailServer]\u00a0;</li> <li>nous lan\u00e7ons le client Postman ainsi que sa console (Ctrl-Alt-C)\u00a0;</li> </ul> <p></p> <ul> <li>en [1]\u00a0: on \u00e9met une requ\u00eate [POST]\u00a0;</li> <li>en [2]\u00a0: l\u2019URL du serveur\u00a0;</li> <li>en [3]\u00a0: le corps de la requ\u00eate HTTP\u00a0;</li> <li>en [5]\u00a0: on indique que ce corps devra \u00eatre envoy\u00e9 sous la forme d\u2019une cha\u00eene jSON\u00a0;</li> <li>en [4]\u00a0: on se met en mode [raw] pour pouvoir copier / coller une cha\u00eene jSON\u00a0;</li> <li>en [6]\u00a0: on colle la cha\u00eene jSON prise dans un des fichiers [r\u00e9sultats.json] des diff\u00e9rentes versions. Puis on ne garde pour chaque contribuable que les propri\u00e9t\u00e9s [mari\u00e9, salaire, enfants]\u00a0;</li> </ul> <p></p> <ul> <li>en [7], on regarde les ent\u00eates HTTP que va envoyer le client Postman au serveur\u00a0;</li> <li>en [8], on voit qu\u2019il va lui envoyer un ent\u00eate [Content-Type] lui indiquant que la requ\u00eate contient un corps cod\u00e9 en jSON. Cela vient du choix [5] fait pr\u00e9c\u00e9demment\u00a0;</li> </ul> <p></p> <ul> <li>en [9-12]\u00a0: on met dans la requ\u00eate les identifiants attendus par le serveur\u00a0; On envoie cette requ\u00eate. La r\u00e9ponse du serveur est la suivante\u00a0:</li> </ul> <p></p> <ul> <li>en [3], on a re\u00e7u du jSON\u00a0;</li> <li>en [4], l\u2019imp\u00f4t des contribuables\u00a0; Examinons dans la console Postman (Ctrl-Alt-C) le dialogue client / serveur qui a eu lieu\u00a0:</li> </ul> <p>Le client Postman a envoy\u00e9 le texte suivant\u00a0:</p> <pre><code>POST / HTTP/1.1\nAuthorization: Basic YWRtaW46YWRtaW4=\nContent-Type: application/json\nUser-Agent: PostmanRuntime/7.26.2\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 03c4aa28-5a5d-4bb5-ac51-7ad51968c71d\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\nContent-Length: 824\n\n[\n  {\n    \"mari\u00e9\": \"oui\",\n    \"enfants\": 2,\n    \"salaire\": 55555\n  },\n  {\n    \"mari\u00e9\": \"oui\",\n    \"enfants\": 2,\n    \"salaire\": 50000\n  },\n  {\n    \"mari\u00e9\": \"oui\",\n    \"enfants\": 3,\n    \"salaire\": 50000\n  },\n  {\n    \"mari\u00e9\": \"non\",\n    \"enfants\": 2,\n    \"salaire\": 100000\n  },\n  {\n    \"mari\u00e9\": \"non\",\n    \"enfants\": 3,\n    \"salaire\": 100000\n  },\n  {\n    \"mari\u00e9\": \"oui\",\n    \"enfants\": 3,\n    \"salaire\": 100000\n  },\n  {\n    \"mari\u00e9\": \"oui\",\n    \"enfants\": 5,\n    \"salaire\": 100000\n  },\n  {\n    \"mari\u00e9\": \"non\",\n    \"enfants\": 0,\n    \"salaire\": 100000\n  },\n  {\n    \"mari\u00e9\": \"oui\",\n    \"enfants\": 2,\n    \"salaire\": 30000\n  },\n  {\n    \"mari\u00e9\": \"non\",\n    \"enfants\": 0,\n    \"salaire\": 200000\n  },\n  {\n    \"mari\u00e9\": \"oui\",\n    \"enfants\": 3,\n    \"salaire\": 200000\n  }\n]\n</code></pre> <ul> <li>ligne 1\u00a0: le POST vers le serveur\u00a0;</li> <li>ligne 2\u00a0: l\u2019ent\u00eate HTTP d\u2019authentification\u00a0;</li> <li>ligne 3\u00a0: le client dit au serveur qu\u2019il lui envoie une cha\u00eene jSON et que cette cha\u00eene fait 824 octets (ligne 11)\u00a0;</li> <li>lignes 13-69\u00a0: le corps jSON de la requ\u00eate\u00a0; Le serveur lui a r\u00e9pondu le texte suivant\u00a0:</li> </ul> <pre><code>HTTP/1.0 200 OK\nContent-Type: application/json; charset=utf-8\nContent-Length: 1461\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Tue, 28 Jul 2020 07:16:34 GMT\n\n{\"r\u00e9ponse\": {\"results\": [{\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555, \"imp\u00f4t\": 2814, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 50000, \"imp\u00f4t\": 1384, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 384, \"r\u00e9duction\": 347}, {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 50000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 720, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"non\", \"enfants\": 2, \"salaire\": 100000, \"imp\u00f4t\": 19884, \"surc\u00f4te\": 4480, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"non\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 16782, \"surc\u00f4te\": 7176, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 9200, \"surc\u00f4te\": 2180, \"taux\": 0.3, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"oui\", \"enfants\": 5, \"salaire\": 100000, \"imp\u00f4t\": 4230, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 100000, \"imp\u00f4t\": 22986, \"surc\u00f4te\": 0, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 30000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.0, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 200000, \"imp\u00f4t\": 64210, \"surc\u00f4te\": 7498, \"taux\": 0.45, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000, \"imp\u00f4t\": 42842, \"surc\u00f4te\": 17283, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}]}}\n</code></pre> <ul> <li>ligne 1\u00a0: la requ\u00eate a r\u00e9ussi\u00a0;</li> <li>ligne 2\u00a0: le corps de la r\u00e9ponse du serveur est une cha\u00eene jSON. Celle-ci fait 1461 octets (ligne 3)\u00a0;</li> <li>ligne 7\u00a0: la r\u00e9ponse jSON du serveur\u00a0; Testons maintenant des cas d\u2019erreur.</li> </ul> <p>Cas 1\u00a0: on envoie n\u2019importe quoi</p> <pre><code>POST / HTTP/1.1\nAuthorization: Basic YWRtaW46YWRtaW4=\nContent-Type: application/json\nUser-Agent: PostmanRuntime/7.26.2\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 47652706-9744-46a0-a682-de010e5406c0\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\nContent-Length: 3\n\nabc\n\nHTTP/1.0 400 BAD REQUEST\nContent-Type: application/json; charset=utf-8\nContent-Length: 125\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Tue, 28 Jul 2020 07:43:27 GMT\n\n{\"r\u00e9ponse\": {\"erreurs\": [\"le corps du POST n'est pas une cha\u00eene jSON valide : Expecting value: line 1 column 1 (char 0)\"]}}\n</code></pre> <ul> <li>ligne 13\u00a0: on a envoy\u00e9 la cha\u00eene [abc] qui n\u2019est pas une cha\u00eene jSON valide (ligne 3)\u00a0;</li> <li>ligne 15\u00a0: le serveur r\u00e9pond par un code d\u2019erreur 400\u00a0;</li> <li>ligne 21\u00a0: la r\u00e9ponse jSON du serveur\u00a0; Cas 2\u00a0: envoyons une cha\u00eene jSON valide qui ne soit pas une liste</li> </ul> <pre><code>POST / HTTP/1.1\nAuthorization: Basic YWRtaW46YWRtaW4=\nContent-Type: application/json\nUser-Agent: PostmanRuntime/7.26.2\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 03b64735-9239-47b3-b92d-be7c9ebc7559\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\nContent-Length: 17\n\n{\"att1\":\"value1\"}\n\nHTTP/1.0 400 BAD REQUEST\nContent-Type: application/json; charset=utf-8\nContent-Length: 97\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Tue, 28 Jul 2020 07:50:11 GMT\n\n{\"r\u00e9ponse\": {\"erreurs\": [\"le corps du POST n'est pas une liste ou alors cette liste est vide\"]}}\n</code></pre> <p>Cas 3\u00a0: envoyons une cha\u00eene jSON qui soit une liste dont les \u00e9l\u00e9ments ne sont pas tous des dictionnaires</p> <pre><code>POST / HTTP/1.1\nAuthorization: Basic YWRtaW46YWRtaW4=\nContent-Type: application/json\nUser-Agent: PostmanRuntime/7.26.2\nAccept: */*\nCache-Control: no-cache\nPostman-Token: a1528a5f-777c-413f-b3be-7d4e9955b12a\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\nContent-Length: 7\n\n[0,1,2]\n\nHTTP/1.0 400 BAD REQUEST\nContent-Type: application/json; charset=utf-8\nContent-Length: 85\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Tue, 28 Jul 2020 07:52:10 GMT\n\n{\"r\u00e9ponse\": {\"erreurs\": [\"le corps du POST doit \u00eatre une liste de dictionnaires\"]}}\n</code></pre> <p>Cas 4\u00a0: envoyons une liste de dictionnaires avec un dictionnaire n\u2019ayant pas les bonnes cl\u00e9s</p> <pre><code>POST / HTTP/1.1\nAuthorization: Basic YWRtaW46YWRtaW4=\nContent-Type: application/json\nUser-Agent: PostmanRuntime/7.26.2\nAccept: */*\nCache-Control: no-cache\nPostman-Token: ba964d81-c9d9-46ff-a521-b4c4e5639484\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\nContent-Length: 19\n\n[{\"att1\":\"value1\"}]\n\nHTTP/1.0 400 BAD REQUEST\nContent-Type: application/json; charset=utf-8\nContent-Length: 112\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Tue, 28 Jul 2020 07:54:33 GMT\n\n{\"r\u00e9ponse\": {\"erreurs\": [{\"att1\": \"value1\", \"erreur\": \"MyException[2, la cl\u00e9 [att1] n'est pas autoris\u00e9e]\"}]}}\n</code></pre> <p>Cas 5\u00a0: envoyons une liste de dictionnaires avec un dictionnaire avec des cl\u00e9s manquantes\u00a0:</p> <pre><code>POST / HTTP/1.1\nAuthorization: Basic YWRtaW46YWRtaW4=\nContent-Type: application/json\nUser-Agent: PostmanRuntime/7.26.2\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 98aec51d-f37d-4c14-81cd-c7ffcbbcdc65\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\nContent-Length: 18\n\n[{\"mari\u00e9\":\"oui\"}]\n\nHTTP/1.0 400 BAD REQUEST\nContent-Type: application/json; charset=utf-8\nContent-Length: 125\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Tue, 28 Jul 2020 07:56:40 GMT\n\n{\"r\u00e9ponse\": {\"erreurs\": [{\"mari\u00e9\": \"oui\", \"erreur\": \"le dictionnaire doit inclure les cl\u00e9s [mari\u00e9, enfants, salaire]\"}]}}\n</code></pre> <p>Cas 6\u00a0: envoyons une liste de dictionnaires avec un dictionnaire ayant les bonnes cl\u00e9s mais certaines ayant des valeurs erron\u00e9es\u00a0:</p> <pre><code>POST / HTTP/1.1\nAuthorization: Basic YWRtaW46YWRtaW4=\nContent-Type: application/json\nUser-Agent: PostmanRuntime/7.26.2\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 3083e601-dee4-4e15-9ea4-fc0328d0fcf0\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\nContent-Length: 46\n\n[{\"mari\u00e9\":\"x\", \"enfants\":\"x\", \"salaire\":\"x\"}]\n\nHTTP/1.0 400 BAD REQUEST\nContent-Type: application/json; charset=utf-8\nContent-Length: 167\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Tue, 28 Jul 2020 07:59:32 GMT\n\n{\"r\u00e9ponse\": {\"erreurs\": [{\"mari\u00e9\": \"x\", \"enfants\": \"x\", \"salaire\": \"x\", \"erreur\": \"MyException[31, l'attribut mari\u00e9 [x] doit avoir l'une des valeurs oui / non]\"}]}}\n</code></pre>"},{"location":"exercice-dapplication-version-10.html#283-le-client-web","title":"28.3. Le client web","text":"<p>Le dossier [http-clients/05] (version 10) est obtenu initialement par recopie du dossier [http-clients/02] (version 7). Il est ensuite modifi\u00e9.</p>"},{"location":"exercice-dapplication-version-10.html#2831-la-couche-dao","title":"28.3.1. La couche [dao]","text":"<p>La couche [dao] est impl\u00e9ment\u00e9e par la classe [Imp\u00f4tsDaoWithHttpClient] suivante\u00a0:</p> <pre><code># imports\n\nimport requests\nfrom flask_api import status\n\nfrom AbstractImp\u00f4tsDao import AbstractImp\u00f4tsDao\nfrom AdminData import AdminData\nfrom Imp\u00f4tsError import Imp\u00f4tsError\nfrom InterfaceImp\u00f4tsM\u00e9tier import InterfaceImp\u00f4tsM\u00e9tier\nfrom TaxPayer import TaxPayer\n\n\nclass Imp\u00f4tsDaoWithHttpClient(AbstractImp\u00f4tsDao, InterfaceImp\u00f4tsM\u00e9tier):\n\n    # constructeur\n    def __init__(self, config: dict):\n        \u2026\n\n    # m\u00e9thode inutilis\u00e9e\n    def get_admindata(self) -&gt; AdminData:\n        pass\n\n    # calcul de l'imp\u00f4t\n    def calculate_tax(self, taxpayer: TaxPayer, admindata: AdminData = None):\n        \u2026\n\n    # calcul de l'imp\u00f4t en mode bulk\n    def calculate_tax_in_bulk_mode(self, taxpayers: list) -&gt; list:\n        # on laisse remonter les exceptions\n\n        # on transforme les taxpayers en liste de dictionnaires\n        # on ne garde que les propri\u00e9t\u00e9s [mari\u00e9, enfants, salaire]\n        list_dict_taxpayers = list(\n            map(lambda taxpayer:\n                taxpayer.asdict(included_keys=[\n                    '_TaxPayer__mari\u00e9',\n                    '_TaxPayer__enfants',\n                    '_TaxPayer__salaire']),\n                taxpayers))\n\n        # connexion au serveur\n        config_server = self.__config_server\n        if config_server['authBasic']:\n            response = requests.post(config_server['urlServer'], json=list_dict_taxpayers,\n                                     auth=(config_server[\"user\"][\"login\"],\n                                           config_server[\"user\"][\"password\"]))\n        else:\n            response = requests.post(config_server['urlServer'], json=list_dict_taxpayers)\n        # mode debug ?\n        if self.__debug:\n            # logueur\n            if not self.__logger:\n                self.__logger = self.__config['logger']\n            # on logue\n            self.__logger.write(f\"{response.text}\\n\")\n        # code de statut de la r\u00e9ponse HTTP\n        status_code = response.status_code\n        # on met la r\u00e9ponse jSON dans un dictionnaire\n        r\u00e9sultat = response.json()\n        # erreur si code de statut diff\u00e9rent de 200 OK\n        if status_code != status.HTTP_200_OK:\n            # on sait que les erreurs ont \u00e9t\u00e9 associ\u00e9es \u00e0 la cl\u00e9 [erreurs] de la r\u00e9ponse\n            raise Imp\u00f4tsError(93, r\u00e9sultat['r\u00e9ponse']['erreurs'])\n        # on sait que le r\u00e9sultat a \u00e9t\u00e9 associ\u00e9 \u00e0 la cl\u00e9 [results] de la r\u00e9ponse\n        list_dict_taxpayers2 = r\u00e9sultat['r\u00e9ponse']['results']\n        # on met \u00e0 jour la liste initiale des taxpayers avec les r\u00e9sultats re\u00e7us\n        for i in range(len(taxpayers)):\n            # mise \u00e0 jour de taxpayers[i]\n            taxpayers[i].fromdict(list_dict_taxpayers2[i])\n        # ici le param\u00e8tre [taxpayers] a \u00e9t\u00e9 mis \u00e0 jour avec les r\u00e9sultats du serveur\n</code></pre> <ul> <li>lignes 1-26\u00a0: le code reste ce qu\u2019il \u00e9tait dans la version 7 et dans d\u2019autres versions\u00a0;</li> <li>lignes 27-70\u00a0: on introduit une nouvelle m\u00e9thode [calculate_tax_in_bulk_mode] dont le r\u00f4le est de calculer l\u2019imp\u00f4t d\u2019une liste de contribuables\u00a0;</li> <li>ligne 28\u00a0: [taxpayers] est cette liste de contribuables\u00a0;</li> <li>lignes 31-39\u00a0: on passe d\u2019une liste d\u2019objets de type [TaxPayer] \u00e0 une liste de dictionnaires gr\u00e2ce \u00e0 une fonction [map]\u00a0;</li> <li>lignes 34-38\u00a0: la fonction lambda utilis\u00e9e transforme un objet de type [TaxPayer] en un dictionnaire de type [dict] ayant les seules cl\u00e9s [mari\u00e9, enfants, salaire]. On utilise pour cela le param\u00e8tre nomm\u00e9 [included_keys] de la m\u00e9thode [BaseEntity.asdict]. On rappelle que pour conna\u00eetre les noms exacts des propri\u00e9t\u00e9s \u00e0 mettre dans les param\u00e8tres [excluded_keys, included_keys], il faut utiliser le dictionnaire pr\u00e9d\u00e9fini [taxpayer.dict]\u00a0;</li> <li>lignes 41-48\u00a0: connexion au serveur puis obtention de sa r\u00e9ponse HTTP\u00a0;</li> <li>lignes 44, 48\u00a0:</li> <li>on utilise la m\u00e9thode statique [requests.post] pour faire un POST vers le serveur\u00a0;</li> <li>on utilise le param\u00e8tre nomm\u00e9 [json] pour indiquer que le corps du POST est une cha\u00eene jSON. Cela va avoir deux cons\u00e9quences\u00a0:</li> <li>l\u2019objet affect\u00e9 au param\u00e8tre nomm\u00e9 [json], ici une liste de dictionnaires, va \u00eatre transform\u00e9 en cha\u00eene jSON\u00a0;</li> <li>l\u2019ent\u00eate <pre><code>Content-Type: application/json\n</code></pre></li> </ul> <p>sera inclus dans les ent\u00eates HTTP du POST\u00a0;</p> <ul> <li>ligne 59\u00a0: la r\u00e9ponse jSON du serveur est d\u00e9s\u00e9rialis\u00e9e dans le dictionnaire [r\u00e9sultat]\u00a0;</li> <li>lignes 61-63\u00a0: on g\u00e8re l\u2019\u00e9ventuelle erreur envoy\u00e9e par le serveur\u00a0;</li> <li>ligne 65\u00a0: les r\u00e9sultats du calcul de l\u2019imp\u00f4t sont dans une liste de dictionnaires\u00a0;</li> <li>lignes 67-69\u00a0: ces r\u00e9sultats sont exploit\u00e9s pour mettre \u00e0 jour la liste initiale des contribuables [taxpayers] initialement re\u00e7us par la m\u00e9thode, ligne 28\u00a0;</li> <li>ligne 70\u00a0: ici la liste la liste initiale des contribuables a \u00e9t\u00e9 mise \u00e0 jour avec les r\u00e9sultats du calcul de l\u2019imp\u00f4t\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-10.html#2832-le-script-principal-main","title":"28.3.2. Le script principal [main]","text":"<p>Le script principal [main] \u00e9volue de la fa\u00e7on suivante\u00a0: seule la fonction [thread_function] ex\u00e9cut\u00e9e par les threads cr\u00e9\u00e9s par le client est modifi\u00e9e. Le reste du code reste \u00e0 l\u2019identique.</p> <pre><code># ex\u00e9cution de la couche [dao] dans un thread\n# taxpayers est une liste de contribuables\ndef thread_function(dao: Imp\u00f4tsDaoWithHttpClient, logger: Logger, taxpayers: list):\n    # log d\u00e9but du thread\n    thread_name = threading.current_thread().name\n    nb_taxpayers = len(taxpayers)\n    # log\n    logger.write(f\"d\u00e9but du calcul de l'imp\u00f4t des {nb_taxpayers} contribuables\\n\")\n    # on calcule l'imp\u00f4t des contribuables\n    dao.calculate_tax_in_bulk_mode(taxpayers)\n    # log\n    logger.write(f\"fin du calcul de l'imp\u00f4t des {nb_taxpayers} contribuables\\n\")\n</code></pre> <ul> <li>lignes 9-10\u00a0: alors que pr\u00e9c\u00e9demment on avait une boucle qui passait successivement chacun des contribuables \u00e0 la m\u00e9thode [dao.calculate_tax], ici on ne fait qu\u2019un unique appel \u00e0 la m\u00e9thode [dao.calculate_tax_in_bulk_mode] \u00e0 laquelle on passe tous les contribuables\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-10.html#2833-execution-du-client","title":"28.3.3. Ex\u00e9cution du client","text":"<p>Nous allons comparer les temps d\u2019ex\u00e9cution des versions\u00a0:</p> <ul> <li>7, o\u00f9 chaque contribuable fait l\u2019objet d\u2019une requ\u00eate\u00a0HTTP\u00a0;</li> <li>10 (celle-ci) o\u00f9 on rassemble des contribuables dans une unique requ\u00eate\u00a0HTTP\u00a0; Tout d\u2019abord la version 6. Pour comparer les deux versions, on met la propri\u00e9t\u00e9 [sleep_time] du serveur \u00e0 z\u00e9ro pour qu\u2019il n\u2019y ait pas d\u2019attente forc\u00e9e des threads. Les logs du client sont les suivants\u00a0:</li> </ul> <pre><code>2020-07-28 14:20:45.811347, Thread-1 : d\u00e9but du thread [Thread-1] avec 4 contribuable(s)\n2020-07-28 14:20:45.811347, Thread-1 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 1, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555}\n\u2026\n2020-07-28 14:20:45.913065, Thread-3 : fin du calcul de l'imp\u00f4t de {\"id\": 11, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000, \"imp\u00f4t\": 42842, \"surc\u00f4te\": 17283, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-28 14:20:45.913065, Thread-3 : fin du thread [Thread-3]\n</code></pre> <p>La dur\u00e9e de l\u2019ex\u00e9cution du client pour calculer l\u2019imp\u00f4t de 11 contribuables est donc [913065-811347= 101718], \u00e7-\u00e0-d environ 102 millisecondes.</p> <p>Faisons la m\u00eame chose avec la version 10 (sleep_time du serveur \u00e0 z\u00e9ro). Les logs du client sont alors les suivants\u00a0:</p> <pre><code>2020-07-28 14:25:31.871428, Thread-1 : d\u00e9but du calcul de l'imp\u00f4t des 4 contribuables\n2020-07-28 14:25:31.873594, Thread-2 : d\u00e9but du calcul de l'imp\u00f4t des 3 contribuables\n2020-07-28 14:25:31.877429, Thread-3 : d\u00e9but du calcul de l'imp\u00f4t des 3 contribuables\n2020-07-28 14:25:31.882855, Thread-4 : d\u00e9but du calcul de l'imp\u00f4t des 1 contribuables\n2020-07-28 14:25:31.930723, Thread-2 : {\"r\u00e9ponse\": {\"results\": [{\"mari\u00e9\": \"non\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 16782, \"surc\u00f4te\": 7176, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 9200, \"surc\u00f4te\": 2180, \"taux\": 0.3, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"oui\", \"enfants\": 5, \"salaire\": 100000, \"imp\u00f4t\": 4230, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}]}}\n\u2026.\n2020-07-28 14:25:31.935958, Thread-4 : fin du calcul de l'imp\u00f4t des 1 contribuables\n2020-07-28 14:25:31.935958, Thread-1 : fin du calcul de l'imp\u00f4t des 4 contribuables\n</code></pre> <p>La dur\u00e9e de l\u2019ex\u00e9cution du client pour calculer l\u2019imp\u00f4t de 11 contribuables est donc [935958-871428= 64530 ns] (ligne 8 \u2013 ligne 1), \u00e7-\u00e0-d environ 65 millisecondes. Cette nouvelle version 10 am\u00e8ne ainsi un gain de 57 % environ sur la version 7.</p>"},{"location":"exercice-dapplication-version-10.html#2834-tests-de-la-couche-dao-du-client","title":"28.3.4. Tests de la couche [dao] du client","text":"<p>Le test [TestHttpClientDao] du client de la version 10 est tr\u00e8s proche de celui de la version 7\u00a0:</p> <p></p> <pre><code>import unittest\n\nfrom Logger import Logger\n\n\nclass TestHttpClientDao(unittest.TestCase):\n\n    def test_1(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 55555,\n        # 'imp\u00f4t': 2814, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.14}\n        taxpayer = TaxPayer().fromdict({\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555})\n        dao.calculate_tax_in_bulk_mode([taxpayer])\n        # v\u00e9rification\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 2815, delta=1)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.14, delta=0.01)\n        self.assertEqual(taxpayer.surc\u00f4te, 0)\n\n    \u2026\n\nif __name__ == '__main__':\n    # on configure l'application\n    import config\n    config = config.configure({})\n\n    # logger\n    logger = Logger(config[\"logsFilename\"])\n    # on le m\u00e9morise dans la config\n    config[\"logger\"] = logger\n    # on r\u00e9cup\u00e8re la couche [dao]\n    dao = config[\"layers\"][\"dao\"]\n\n    # on ex\u00e9cute les m\u00e9thodes de test\n    print(\"tests en cours...\")\n    unittest.main()\n</code></pre> <ul> <li>ligne 14\u00a0: au lieu d\u2019appeler la m\u00e9thode [dao.calculate_tax], on appelle la m\u00e9thode [dao.calculate_tax_in_bulk_mode] \u00e0 laquelle on passe une liste (pr\u00e9sence des crochets) d\u2019un contribuable\u00a0; Tous les tests passent.</li> </ul>"},{"location":"exercice-dapplication-version-11.html","title":"29. Exercice d\u2019application\u00a0: version 11","text":""},{"location":"exercice-dapplication-version-11.html#291-introduction","title":"29.1. Introduction","text":"<p>Dans les versions pr\u00e9c\u00e9dentes de l\u2019application client / serveur de calcul de l\u2019imp\u00f4t, la couche [m\u00e9tier] qui impl\u00e9mente les r\u00e8gles m\u00e9tier de ce calcul \u00e9tait c\u00f4t\u00e9 serveur. On se propose maintenant de la d\u00e9placer c\u00f4t\u00e9 client. Quel est l\u2019int\u00e9r\u00eat\u00a0? Du travail que faisait le serveur va \u00eatre d\u00e9plac\u00e9 c\u00f4t\u00e9 client. Si on pense \u00e0 la situation d\u2019un serveur interrog\u00e9 par N clients, N calculs m\u00e9tier de l\u2019imp\u00f4t seront faits par les clients. Dans les versions pr\u00e9c\u00e9dentes, le serveur faisait ces N calculs m\u00e9tier. Parce qu\u2019il ne fait plus le calcul m\u00e9tier, le serveur va r\u00e9pondre plus rapidement \u00e0 ses clients et va alors pouvoir en servir davantage simultan\u00e9ment.</p> <p>L\u2019architecture client / serveur devient la suivante\u00a0:</p> <p></p> <ul> <li>la couche [m\u00e9tier] [10] a \u00e9t\u00e9 dupliqu\u00e9e [12] sur le client\u00a0;</li> <li> <p>un nouveau script [main2] [11] a \u00e9t\u00e9 ajout\u00e9 au client\u00a0; Le client web aura deux fa\u00e7on de calculer l\u2019impp\u00f4t de la liste de contribuables trouv\u00e9e en [3]\u00a0:</p> </li> <li> <p>utiliser la m\u00e9thode de la version pr\u00e9c\u00e9dente. Il utilise la couche [m\u00e9tier] [10] du serveur. Le script [main] utilisera cette m\u00e9thode\u00a0;</p> </li> <li>se contenter de demander au serveur les donn\u00e9es de l\u2019administration fiscale [2-4] puis utiliser la couche [m\u00e9tier] [12] locale au client\u00a0; Nous comparerons les performances des deux m\u00e9thodes.</li> </ul>"},{"location":"exercice-dapplication-version-11.html#292-le-serveur-web","title":"29.2. Le serveur web","text":"<p>L\u2019arborescence du serveur web sera la suivante\u00a0:</p> <p></p> <ul> <li>le dossier [http-servers/06] est initialement obtenu par recopie du dossier [http-servers/05]. On va en effet conserver l\u2019acquis de la version 10 pr\u00e9c\u00e9dente. On va simplement lui ajouter une nouvelle fonctionnalit\u00e9. Celle-ci est mat\u00e9rialis\u00e9e par la pr\u00e9sence d\u2019un nouveau contr\u00f4leur [get_admindata_controller] [1]. L\u2019autre contr\u00f4leur [calculate_tax_controller] n\u2019est autre que l\u2019ancien contr\u00f4leur [index_controller] qui a \u00e9t\u00e9 renomm\u00e9\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-11.html#293-configuration","title":"29.3. Configuration","text":"<p>Le serveur offrira deux URL de service\u00a0:</p> <ul> <li>[/calculate-tax] pour calculer l\u2019imp\u00f4t d\u2019une liste de contribuables pass\u00e9e dans le corps d\u2019un POST. Elle correspond donc \u00e0 l\u2019URL [/] de la version 10 pr\u00e9c\u00e9dente\u00a0;</li> <li>[/get-admindata] d\u00e9livre la cha\u00eene jSON des donn\u00e9es de l\u2019administration fiscale\u00a0; La configuration [config] associe chacune de ces URL au contr\u00f4leur qui la traite\u00a0:</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0#\u00a0dictionnaire\u00a0des\u00a0contr\u00f4leurs\u00a0de\u00a0l'application\u00a0web\n\u00a0\u00a0\u00a0\u00a0import\u00a0calculate_tax_controller,\u00a0get_admindata_controller\n\u00a0\u00a0\u00a0\u00a0controllers\u00a0=\u00a0{\"calculate-tax\":\u00a0calculate_tax_controller,\u00a0\"get-admindata\":\u00a0get_admindata_controller}\n\u00a0\u00a0\u00a0\u00a0config['controllers']\u00a0=\u00a0controllers\n</code></pre>"},{"location":"exercice-dapplication-version-11.html#294-le-script-principal-main","title":"29.4. Le script principal [main]","text":"<p>Le script principal [main] restructure le script [main] de la version pr\u00e9c\u00e9dente\u00a0:</p> <pre><code>#\u00a0on\u00a0attend\u00a0un\u00a0param\u00e8tre\u00a0mysql\u00a0ou\u00a0pgres\nimport\u00a0sys\nsyntaxe\u00a0=\u00a0f\"{sys.argv[0]}\u00a0mysql\u00a0/\u00a0pgres\"\nerreur\u00a0=\u00a0len(sys.argv)\u00a0!=\u00a02\nif\u00a0not\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0sgbd\u00a0=\u00a0sys.argv[1].lower()\n\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0sgbd\u00a0!=\u00a0\"mysql\"\u00a0and\u00a0sgbd\u00a0!=\u00a0\"pgres\"\nif\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0print(f\"syntaxe\u00a0:\u00a0{syntaxe}\")\n\u00a0\u00a0\u00a0\u00a0sys.exit()\n\n#\u00a0on\u00a0configure\u00a0l'application\nimport\u00a0config\nconfig\u00a0=\u00a0config.configure({'sgbd':\u00a0sgbd})\n\n#\u00a0d\u00e9pendances\n\u2026\n\n#\u00a0r\u00e9cup\u00e9ration\u00a0des\u00a0donn\u00e9es\u00a0de\u00a0l'administration\u00a0fiscale\nerreur\u00a0=\u00a0False\ntry:\n\u00a0\u00a0\u00a0\u00a0#\u00a0admindata\u00a0sera\u00a0une\u00a0donn\u00e9e\u00a0de\u00a0port\u00e9e\u00a0application\u00a0en\u00a0lecture\u00a0seule\n\u00a0\u00a0\u00a0\u00a0config[\"admindata\"]\u00a0=\u00a0config[\"layers\"][\"dao\"].get_admindata()\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0de\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0logger.write(\"[serveur]\u00a0connexion\u00a0\u00e0\u00a0la\u00a0base\u00a0de\u00a0donn\u00e9es\u00a0r\u00e9ussie\\n\")\nexcept\u00a0Imp\u00f4tsError\u00a0as\u00a0ex:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0\u2026\n\u2026\n#\u00a0s'il\u00a0y\u00a0a\u00a0eu\u00a0erreur\u00a0on\u00a0s'arr\u00eate\nif\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0sys.exit(2)\n\n#\u00a0l'application\u00a0Flask\u00a0peut\u00a0d\u00e9marrer\napp\u00a0=\u00a0Flask(__name__)\n\n#\u00a0contr\u00f4leur\u00a0principal\ndef\u00a0main_controller()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0l'action\u00a0demand\u00e9e\n\u00a0\u00a0\u00a0\u00a0dummy,\u00a0action=request.path.split('/')\n\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0logger\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0Logger(config[\"logsFilename\"])\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0le\u00a0m\u00e9morise\u00a0dans\u00a0une\u00a0config\u00a0associ\u00e9e\u00a0au\u00a0thread\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0thread_config\u00a0=\u00a0{\"logger\":\u00a0logger}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0thread_name\u00a0=\u00a0threading.current_thread().name\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config[thread_name]\u00a0=\u00a0{\"config\":\u00a0thread_config}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0logue\u00a0la\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(f\"[index]\u00a0requ\u00eate\u00a0:\u00a0{request}\\n\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0interrompt\u00a0le\u00a0thread\u00a0si\u00a0cela\u00a0a\u00a0\u00e9t\u00e9\u00a0demand\u00e9\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0sleep_time\u00a0=\u00a0config[\"sleep_time\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0sleep_time\u00a0!=\u00a00:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0pause\u00a0est\u00a0al\u00e9atoire\u00a0pour\u00a0que\u00a0certains\u00a0threads\u00a0soient\u00a0interrompus\u00a0et\u00a0d'autres\u00a0pas\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0al\u00e9a\u00a0=\u00a0randint(0,\u00a01)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0al\u00e9a\u00a0==\u00a01:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0avant\u00a0pause\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(f\"[index]\u00a0mis\u00a0en\u00a0pause\u00a0du\u00a0thread\u00a0pendant\u00a0{sleep_time}\u00a0seconde(s)\\n\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pause\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0time.sleep(sleep_time)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fait\u00a0ex\u00e9cuter\u00a0la\u00a0requ\u00eate\u00a0par\u00a0le\u00a0contr\u00f4leur\u00a0de\u00a0la\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0controller\u00a0=\u00a0config['controllers'][action]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat,\u00a0status_code\u00a0=\u00a0controller.execute(request,\u00a0config)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0y-a-t-il\u00a0eu\u00a0une\u00a0erreur\u00a0fatale\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0status_code\u00a0==\u00a0status.HTTP_500_INTERNAL_SERVER_ERROR:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0un\u00a0mail\u00a0\u00e0\u00a0l'administrateur\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config_mail\u00a0=\u00a0config[\"adminMail\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config_mail[\"logger\"]\u00a0=\u00a0logger\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0SendAdminMail.send(config_mail,\u00a0json.dumps(r\u00e9sultat,\u00a0ensure_ascii=False))\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0logue\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(f\"[index]\u00a0{r\u00e9sultat}\\n\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0print(r\u00e9sultat)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0json_response(r\u00e9sultat,\u00a0status_code)\n\u00a0\u00a0\u00a0\u00a0except\u00a0BaseException\u00a0as\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0logue\u00a0l'erreur\u00a0si\u00a0c'est\u00a0possible\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0logger:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(f\"[index]\u00a0{erreur}\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0pr\u00e9pare\u00a0la\u00a0r\u00e9ponse\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"r\u00e9ponse\":\u00a0{\"erreurs\":\u00a0[f\"{erreur}\"]}}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0json_response(r\u00e9sultat,\u00a0status.HTTP_500_INTERNAL_SERVER_ERROR)\n\u00a0\u00a0\u00a0\u00a0finally:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ferme\u00a0le\u00a0fichier\u00a0de\u00a0logs\u00a0s'il\u00a0a\u00a0\u00e9t\u00e9\u00a0ouvert\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0logger:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.close()\n\n#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n@app.route('/calculate-tax',\u00a0methods=['POST'])\n@auth.login_required\ndef\u00a0calculate_tax():\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0passe\u00a0la\u00a0main\u00a0au\u00a0contr\u00f4leur\u00a0principal\n\u00a0\u00a0\u00a0\u00a0return\u00a0main_controller()\n\n#\u00a0obtenir\u00a0les\u00a0donn\u00e9es\u00a0de\u00a0l'administration\u00a0fiscale\n@app.route('/get-admindata',\u00a0methods=['GET'])\n@auth.login_required\ndef\u00a0get_admindata():\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0passe\u00a0la\u00a0main\u00a0au\u00a0contr\u00f4leur\u00a0principal\n\u00a0\u00a0\u00a0\u00a0return\u00a0main_controller()\n\n#\u00a0main\u00a0uniquement\nif\u00a0__name__\u00a0==\u00a0'__main__':\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0lance\u00a0le\u00a0serveur\n\u00a0\u00a0\u00a0\u00a0app.config.update(ENV=\"development\",\u00a0DEBUG=True)\n\u00a0\u00a0\u00a0\u00a0app.run(threaded=True)\n</code></pre> <ul> <li>lignes 88-93\u00a0: la fonction [calculate_tax] traite l\u2019URL [/calculate-tax]\u00a0;</li> <li>lignes 95-100\u00a0: la fonction [get_admindata] traite l\u2019URL [/get-admindata]\u00a0;</li> <li>ces deux fonctions ne font rien par elles-m\u00eames. Elles passent imm\u00e9diatement la main au contr\u00f4leur principal [main_controller] des lignes 37-86\u00a0;</li> <li>lignes 37-86\u00a0: le contr\u00f4leur principal [main_controller] n\u2019est rien d\u2019autre que la fonction [index] de la version pr\u00e9c\u00e9dente \u00e0 un d\u00e9tail pr\u00e8s\u00a0: l\u00e0 o\u00f9 la fonction [index] ne traitait qu\u2019une unique URL, ici [main_controller] traite deux URL. Il lui faut donc faire traiter celles-ci par l\u2019un des deux contr\u00f4leurs [calculate_tax_controller, get_admin,data_controller]\u00a0;</li> <li>lignes 39-40\u00a0: on r\u00e9cup\u00e8re l\u2019action demand\u00e9e [calculate_tax] ou [get_admindata]. Cette information est dans le chemin de l\u2019URL [request.path]. Selon les cas, [request.path] vaut [/get-admindata] ou [/calculate_tax]. Le split de la ligne 40 va donner deux \u00e9l\u00e9ments\u00a0:</li> <li>la cha\u00eene vide pour la partie qui pr\u00e9c\u00e8de le /\u00a0;</li> <li>le nom de l\u2019action demand\u00e9e pour la partie qui suit le /\u00a0;</li> <li>lignes 62-63\u00a0: une fois l\u2019action de l\u2019URL r\u00e9cup\u00e9r\u00e9e, on sait quel contr\u00f4leur utiliser pour traiter l\u2019URL. Cette informations sont dans la configuration [config]\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-11.html#295-les-controleurs","title":"29.5. Les contr\u00f4leurs","text":"<p>Le contr\u00f4leur [calculate_tax_controller] n\u2019est autre que le contr\u00f4leur [index_controller] de la version pr\u00e9c\u00e9dente.</p> <p>Le contr\u00f4leur [get_admindata_controller] est lui le suivant\u00a0:</p> <pre><code>from\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\ndef\u00a0execute(request:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0return\u00a0{\"r\u00e9ponse\":\u00a0{\"result\":\u00a0config[\"admindata\"].asdict()}},\u00a0status.HTTP_200_OK\n</code></pre> <ul> <li>l\u2019URL [/get-admindata] doit rendre la cha\u00eene jSON des donn\u00e9es de l\u2019administration fiscale\u00a0;</li> <li>ligne 6\u00a0: celles-ci ont \u00e9t\u00e9 r\u00e9cup\u00e9r\u00e9es par le script principal [main] et mises dans le dictionnaire [config]\u00a0sous la forme d\u2019un objet [AdminData]. On rend le dictionnaire de cet objet\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-11.html#296-tests-postman","title":"29.6. Tests Postman","text":"<p>On lance le serveur web, le SGBD et le serveur de mails [hMailServer]. Puis avec un client Postman, on fait le calcul de l\u2019imp\u00f4t de plusieurs contribuables\u00a0:</p> <p></p> <p>Dans la console Postman, le dialogue client / serveur est le suivant\u00a0:</p> <pre><code>POST /calculate-tax HTTP/1.1\nAuthorization: Basic YWRtaW46YWRtaW4=\nContent-Type: application/json\nUser-Agent: PostmanRuntime/7.26.2\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 5e71461a-fec8-4315-85e8-41721de939e5\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\nContent-Length: 824\n\n[ \n{ \n\"mari\u00e9\": \"oui\", \n\"enfants\": 2, \n\"salaire\": 55555 \n}, \n\u2026\n{ \n\"mari\u00e9\": \"oui\", \n\"enfants\": 3, \n\"salaire\": 200000 \n} \n]\n\nHTTP/1.0 200 OK\nContent-Type: application/json; charset=utf-8\nContent-Length: 1461\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Wed, 29 Jul 2020 07:02:07 GMT\n\n{\"r\u00e9ponse\": {\"results\": [{\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555, \"imp\u00f4t\": 2814, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 50000, \"imp\u00f4t\": 1384, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 384, \"r\u00e9duction\": 347\u2026]}}\n</code></pre> <p>Maintenant demandons l\u2019URL [/get-admindata] avec un GET\u00a0:</p> <p></p> <p>Le dialogue client / serveur dans la console Postman est le suivant\u00a0:</p> <pre><code>GET /get-admindata HTTP/1.1\nAuthorization: Basic YWRtaW46YWRtaW4=\nUser-Agent: PostmanRuntime/7.26.2\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 4af342c4-7ecb-4ab2-9e12-d653f81da424\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\n\nHTTP/1.0 200 OK\nContent-Type: application/json; charset=utf-8\nContent-Length: 596\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Wed, 29 Jul 2020 07:07:24 GMT\n\n{\"r\u00e9ponse\": {\"result\": {\"limites\": [9964.0, 27519.0, 73779.0, 156244.0, 93749.0], \"coeffr\": [0.0, 0.14, 0.3, 0.41, 0.45], \"coeffn\": [0.0, 1394.96, 5798.0, 13913.7, 20163.4], \"plafond_decote_couple\": 1970.0, \"valeur_reduc_demi_part\": 3797.0, \"plafond_revenus_celibataire_pour_reduction\": 21037.0, \"plafond_qf_demi_part\": 1551.0, \"abattement_dixpourcent_max\": 12502.0, \"plafond_impot_celibataire_pour_decote\": 1595.0, \"plafond_decote_celibataire\": 1196.0, \"plafond_revenus_couple_pour_reduction\": 42074.0, \"id\": 1, \"abattement_dixpourcent_min\": 437.0, \"plafond_impot_couple_pour_decote\": 2627.0}}}\n</code></pre>"},{"location":"exercice-dapplication-version-11.html#297-le-client-web","title":"29.7. Le client web","text":"<p>Le dossier [http-clients/06] est initialement obtenu par recopie du dossier [http-clients/05]. Le travail de modification consiste essentiellement \u00e0\u00a0:</p> <ul> <li>modifier la configuration [config_layers] pour qu\u2019elle int\u00e9gre d\u00e9sormais une couche [m\u00e9tier]. Auparavant elle n\u2019avait qu\u2019une couche [dao]\u00a0;</li> <li>ajouter une nouvelle m\u00e9thode \u00e0 la couche [dao]\u00a0;</li> <li>\u00e9crire un script [main2] qui s\u2019appuiera sur la couche [m\u00e9tier] du client pour calculer l\u2019imp\u00f4t des contribuables\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-11.html#2971-configuration-des-couches-du-client","title":"29.7.1. Configuration des couches du client","text":"<p>La configuration des couches intervient en deux points\u00a0:</p> <ul> <li>dans la configuration [config] qui doit inclure dans les d\u00e9pendances du client le dossier contenant l\u2019impl\u00e9mentation de la couche [m\u00e9tier]. Ce dossier \u00e9tait d\u00e9j\u00e0 inclus dans les d\u00e9pendances\u00a0: <pre><code>absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossiers\u00a0du\u00a0projet\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0BaseEntity,\u00a0MyException\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/classes/02/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0InterfaceImp\u00f4tsDao,\u00a0InterfaceImp\u00f4tsM\u00e9tier,\u00a0InterfaceImp\u00f4tsUi\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AbstractImp\u00f4tsdao,\u00a0Imp\u00f4tsConsole,\u00a0Imp\u00f4tsM\u00e9tier\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ImpotsDaoWithAdminDataInDatabase\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AdminData,\u00a0Imp\u00f4tsError,\u00a0TaxPayer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Constantes,\u00a0tranches\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Imp\u00f4tsDaoWithHttpClient\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0scripts\u00a0de\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0script_dir,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Logger\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/http-servers/02/utilities\",\n\u00a0\u00a0\u00a0\u00a0]\n</code></pre></li> </ul> <p>Puis le fichier [config_layers] doit \u00eatre modifi\u00e9\u00a0:</p> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\u00a0de\u00a0l'applicatuon\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0couche\u00a0[m\u00e9tier]\n\u00a0\u00a0\u00a0\u00a0from\u00a0Imp\u00f4tsM\u00e9tier\u00a0import\u00a0Imp\u00f4tsM\u00e9tier\n\u00a0\u00a0\u00a0\u00a0m\u00e9tier\u00a0=\u00a0Imp\u00f4tsM\u00e9tier()\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0couche\u00a0dao\n\u00a0\u00a0\u00a0\u00a0from\u00a0Imp\u00f4tsDaoWithHttpClient\u00a0import\u00a0Imp\u00f4tsDaoWithHttpClient\n\u00a0\u00a0\u00a0\u00a0dao\u00a0=\u00a0Imp\u00f4tsDaoWithHttpClient(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\u00a0des\u00a0couches\n\u00a0\u00a0\u00a0\u00a0return\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"dao\":\u00a0dao,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"m\u00e9tier\":\u00a0m\u00e9tier\n\u00a0\u00a0\u00a0\u00a0}\n</code></pre> <ul> <li>lignes 4-6\u00a0: instanciation de la couche [m\u00e9tier]\u00a0;</li> <li>lignes 13-16\u00a0: la couche [m\u00e9tier] est rendue dans le dictionnaire des couches\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-11.html#2972-implementation-de-la-couche-dao","title":"29.7.2. Impl\u00e9mentation de la couche [dao]","text":"<p>La couche [dao] pr\u00e9sentera l\u2019interface [InterfaceImp\u00f4tsDaoWithHttpClient] suivante\u00a0:</p> <pre><code>from\u00a0abc\u00a0import\u00a0abstractmethod\n\nfrom\u00a0AbstractImp\u00f4tsDao\u00a0import\u00a0AbstractImp\u00f4tsDao\n\nclass\u00a0InterfaceImp\u00f4tsDaoWithHttpClient(AbstractImp\u00f4tsDao):\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0@abstractmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0calculate_tax_in_bulk_mode(self,\u00a0taxpayers:\u00a0list):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n</code></pre> <ul> <li>ligne 5\u00a0: l\u2019interface [InterfaceImp\u00f4tsDaoWithHttpClient] h\u00e9rite de la classe abstraite [AbstractImp\u00f4tsDao] qui g\u00e8re l\u2019acc\u00e8s au syst\u00e8me de fichiers du client. On rappelle qu\u2019elle a une m\u00e9thode abstraite [get_admindata]\u00a0;</li> <li>lignes 7-10\u00a0: la m\u00e9thode [calculate_tax_in_bulk_mode] que nous avons d\u00e9finie dans la version pr\u00e9c\u00e9dente permet le calcul de l\u2019imp\u00f4t d\u2019une liste de contribuables\u00a0; Cette interface est impl\u00e9ment\u00e9e par la classe [Imp\u00f4tsDaoWithHttpClient] suivante\u00a0:</li> </ul> <pre><code>#\u00a0imports\n\nimport\u00a0json\n\nimport\u00a0requests\nfrom\u00a0flask_api\u00a0import\u00a0status\n\nfrom\u00a0AbstractImp\u00f4tsDao\u00a0import\u00a0AbstractImp\u00f4tsDao\nfrom\u00a0AdminData\u00a0import\u00a0AdminData\nfrom\u00a0Imp\u00f4tsError\u00a0import\u00a0Imp\u00f4tsError\nfrom\u00a0InterfaceImp\u00f4tsDaoWithHttpClient\u00a0import\u00a0InterfaceImp\u00f4tsDaoWithHttpClient\n\nclass\u00a0Imp\u00f4tsDaoWithHttpClient(InterfaceImp\u00f4tsDaoWithHttpClient):\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0constructeur\n\u00a0\u00a0\u00a0\u00a0def\u00a0__init__(self,\u00a0config:\u00a0dict):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0initialisation\u00a0parent\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0AbstractImp\u00f4tsDao.__init__(self,\u00a0config)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0m\u00e9morisation\u00a0\u00e9l\u00e9ments\u00a0de\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0config\u00a0g\u00e9n\u00e9rale\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__config\u00a0=\u00a0config\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0serveur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__config_server\u00a0=\u00a0config[\"server\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mode\u00a0debug\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__debug\u00a0=\u00a0config[\"debug\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0logger\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__logger\u00a0=\u00a0None\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0get_admindata(self)\u00a0-&gt;\u00a0AdminData:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0laisse\u00a0remonter\u00a0les\u00a0exceptions\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0url\u00a0de\u00a0service\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config_server\u00a0=\u00a0self.__config_server\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config_services\u00a0=\u00a0config_server['url_services']\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_service\u00a0=\u00a0f\"{config_server['urlServer']}{config_services['get-admindata']}\"\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0connexion\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0config_server['authBasic']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response\u00a0=\u00a0requests.get(url_service,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0auth=(\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config_server[\"user\"][\"login\"],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config_server[\"user\"][\"password\"]))\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response\u00a0=\u00a0requests.get(url_service)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mode\u00a0debug\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0self.__debug:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0logueur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0self.__logger:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__logger\u00a0=\u00a0self.__config['logger']\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0logue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__logger.write(f\"{response.text}\\n\")\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0code\u00a0de\u00a0statut\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0status_code\u00a0=\u00a0response.status_code\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9sultat\u00a0sous\u00a0forme\u00a0d'un\u00a0dictionnaire\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0json.loads(response.text)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0si\u00a0code\u00a0de\u00a0statut\u00a0diff\u00e9rent\u00a0de\u00a0200\u00a0OK\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0status_code\u00a0!=\u00a0status.HTTP_200_OK:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0raise\u00a0Imp\u00f4tsError(58,\u00a0r\u00e9sultat['r\u00e9ponse']['erreurs'])\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0r\u00e9sultat\u00a0(un\u00a0dictionnaire)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0AdminData().fromdict(r\u00e9sultat[\"r\u00e9ponse\"][\"result\"])\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0en\u00a0mode\u00a0bulk\n\u00a0\u00a0\u00a0\u00a0def\u00a0calculate_tax_in_bulk_mode(self,\u00a0taxpayers:\u00a0list):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0laisse\u00a0remonter\u00a0les\u00a0exceptions\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n</code></pre> <ul> <li>ligne 13\u00a0: la classe [Imp\u00f4tsDaoWithHttpClient] impl\u00e9mente l\u2019interface [InterfaceImp\u00f4tsDaoWithHttpClient]. Elle d\u00e9rive donc de la classe [AbstractImp\u00f4tsDao]\u00a0;</li> <li>lignes 65-66\u00a0: la m\u00e9thode [calculate_tax_in_bulk_mode] \u00e9tudi\u00e9e dans la version pr\u00e9c\u00e9dente\u00a0;</li> <li>lignes 29-62\u00a0: la m\u00e9thode [get_admindata] que la classe parent [AbstractImp\u00f4tsDao]\u00a0a d\u00e9clar\u00e9e abstraite. Elle est donc impl\u00e9ment\u00e9e dans la classe fille\u00a0;</li> <li> <p>lignes 33-35\u00a0: on d\u00e9termine l\u2019URL du service web que la m\u00e9thode [get-admindata] doit interroger. Ces URL de service sont d\u00e9finies dans la configuration [config] du client\u00a0: <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0serveur\u00a0de\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"server\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"urlServer\":\u00a0\"http://127.0.0.1:5000\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"authBasic\":\u00a0True,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"user\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"login\":\u00a0\"admin\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"admin\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"url_services\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"calculate-tax\":\u00a0\"/calculate-tax\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"get-admindata\":\u00a0\"/get-admindata\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n</code></pre></p> </li> <li> <p>lignes 9-12\u00a0: les deux URL du serveur web\u00a0;</p> </li> <li>lignes 37-44\u00a0: l\u2019URL de service est interrog\u00e9e de fa\u00e7on synchrone\u00a0;</li> <li>lignes 46-42\u00a0: si la configuration le demande, la r\u00e9ponse du serevur est logu\u00e9e\u00a0;</li> <li>ligne 57\u00a0: on sait que le serveur a envoy\u00e9 une cha\u00eene jSON d\u2019un dictionnaire\u00a0;</li> <li>lignes 58-60\u00a0: si le statut HTTP de la r\u00e9ponse n\u2019est pas 200, alors on lance une exception\u00a0;</li> <li>lignes 61-62\u00a0: on rend l\u2019objet [AdminData] encapsulant les donn\u00e9es de l\u2019administration fiscale envoy\u00e9es par le serveur\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-11.html#298-les-scripts-main-main2","title":"29.8. Les scripts [main, main2]","text":"<p>Le script [main] est celui de la version pr\u00e9c\u00e9dente. Il utilise la m\u00e9thode [calculate_tax_in_bulk_mode] de la couche [dao] et utilise donc la couche [m\u00e9tier] du serveur\u00a0;</p> <p>Le script [main2] fait la m\u00eame chose que le script [main] mais en utilisant la couche [m\u00e9tier] du client\u00a0:</p> <pre><code>#\u00a0on\u00a0configure\u00a0l'application\n\nimport\u00a0config\nconfig\u00a0=\u00a0config.configure({})\n\n#\u00a0d\u00e9pendances\nfrom\u00a0Imp\u00f4tsError\u00a0import\u00a0Imp\u00f4tsError\nfrom\u00a0Logger\u00a0import\u00a0Logger\n\nlogger\u00a0=\u00a0None\n#\u00a0code\ntry:\n\u00a0\u00a0\u00a0\u00a0#\u00a0logger\n\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0Logger(config[\"logsFilename\"])\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0le\u00a0m\u00e9morise\u00a0dans\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0config[\"logger\"]\u00a0=\u00a0logger\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0de\u00a0d\u00e9but\n\u00a0\u00a0\u00a0\u00a0logger.write(\"d\u00e9but\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0des\u00a0contribuables\\n\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0la\u00a0couche\u00a0[dao]\n\u00a0\u00a0\u00a0\u00a0dao\u00a0=\u00a0config[\"layers\"][\"dao\"]\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0contribuables\n\u00a0\u00a0\u00a0\u00a0taxpayers\u00a0=\u00a0dao.get_taxpayers_data()[\"taxpayers\"]\n\u00a0\u00a0\u00a0\u00a0#\u00a0des\u00a0contribuables\u00a0?\n\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0taxpayers:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0raise\u00a0Imp\u00f4tsError(36,\u00a0f\"Pas\u00a0de\u00a0contribuables\u00a0valides\u00a0dans\u00a0le\u00a0fichier\u00a0{config['taxpayersFilename']}\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0donn\u00e9es\u00a0de\u00a0l'administration\u00a0fiscale\n\u00a0\u00a0\u00a0\u00a0admindata\u00a0=\u00a0dao.get_admindata()\n\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0des\u00a0contribuables\u00a0par\u00a0la\u00a0couche\u00a0[m\u00e9tier]\n\u00a0\u00a0\u00a0\u00a0m\u00e9tier\u00a0=\u00a0config['layers']['m\u00e9tier']\n\u00a0\u00a0\u00a0\u00a0for\u00a0taxpayer\u00a0in\u00a0taxpayers:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0m\u00e9tier.calculate_tax(taxpayer,\u00a0admindata)\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0enregistre\u00a0les\u00a0r\u00e9sultats\u00a0dans\u00a0le\u00a0fichier\u00a0jSON\n\u00a0\u00a0\u00a0\u00a0dao.write_taxpayers_results(taxpayers)\n#\u00a0except\u00a0BaseException\u00a0as\u00a0erreur:\n#\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0de\u00a0l'erreur\n#\u00a0\u00a0\u00a0\u00a0\u00a0print(f\"L'erreur\u00a0suivante\u00a0s'est\u00a0produite\u00a0:\u00a0{erreur}\")\nfinally:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ferme\u00a0le\u00a0logueur\n\u00a0\u00a0\u00a0\u00a0if\u00a0logger:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0de\u00a0fin\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(\"fin\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0des\u00a0contribuables\\n\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fermeture\u00a0du\u00a0logueur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.close()\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0a\u00a0fini\n\u00a0\u00a0\u00a0\u00a0print(\"Travail\u00a0termin\u00e9...\")\n</code></pre> <ul> <li>lignes 26-27\u00a0: on r\u00e9cup\u00e8re les donn\u00e9es de l\u2019administration fiscale aupr\u00e8s du serveur\u00a0;</li> <li>lignes 28-31\u00a0: ensuite le calcul de l\u2019imp\u00f4t des contribuables est fait localement\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-11.html#299-tests-du-client","title":"29.9. Tests du client","text":"<p>Dans chacun des scripts [main, main2] on logue le d\u00e9but et la fin du script. On pourra ainsi calculer la dur\u00e9e d\u2019ex\u00e9cution du script. Faisons quelques pronostics\u00a0:</p> <ul> <li>le script [main] de la version pr\u00e9c\u00e9dente\u00a0:</li> <li>cr\u00e9e N threads qui s\u2019ex\u00e9cutent simultan\u00e9ment\u00a0;</li> <li>chaque thread traite un lot de contribuables dont il fait calculer l\u2019imp\u00f4t via une unique requ\u00eate au serveur\u00a0;</li> <li>parce que les N threads s\u2019ex\u00e9cutent simultan\u00e9ment, la requ\u00eate N+1 est lanc\u00e9e avant que la requ\u00eate N ait re\u00e7u sa r\u00e9ponse. Ainsi les N requ\u00eates co\u00fbtent plus cher qu\u2019une unique requ\u00eate mais probablement pas beaucoup plus. Il y a par ailleurs 11 (le nombre de contribuables) calculs m\u00e9tier\u00a0sur le serveur\u00a0;</li> <li>le script [main2] de cette version\u00a0:</li> <li>fait une unique requ\u00eate au serveur\u00a0;</li> <li>fait 11 calculs m\u00e9tier localement sur le client\u00a0; Les calculs m\u00e9tier auront la m\u00eame dur\u00e9e que ce soit sur le serveur ou le client. La diff\u00e9rence va alors se faire sur les requ\u00eates. On peut s\u2019attendre alors que la dur\u00e9e d\u2019ex\u00e9cution de [main] soit l\u00e9g\u00e8rement sup\u00e9rieure \u00e0 celle de [main2].</li> </ul> <p>On lance le serveur de la version 11, le SGBD et le serveur de mails [hMailServer]. C\u00f4t\u00e9 serveur, on met le param\u00e8tre [sleep_time] \u00e0 z\u00e9ro pour que les deux tests soient ex\u00e9cut\u00e9s dans les m\u00eames conditions.</p> <p>Ex\u00e9cution 1 [main]</p> <p>L\u2019ex\u00e9cution de [main] donne les logs suivants\u00a0:</p> <pre><code>2020-07-29 14:35:50.016079, MainThread : d\u00e9but du calcul de l'imp\u00f4t des contribuables\n2020-07-29 14:35:50.016079, Thread-1 : d\u00e9but du calcul de l'imp\u00f4t des 1 contribuables\n2020-07-29 14:35:50.016079, Thread-2 : d\u00e9but du calcul de l'imp\u00f4t des 4 contribuables\n2020-07-29 14:35:50.016079, Thread-3 : d\u00e9but du calcul de l'imp\u00f4t des 2 contribuables\n2020-07-29 14:35:50.016079, Thread-4 : d\u00e9but du calcul de l'imp\u00f4t des 2 contribuables\n2020-07-29 14:35:50.024426, Thread-5 : d\u00e9but du calcul de l'imp\u00f4t des 2 contribuables\n2020-07-29 14:35:50.050473, Thread-1 : {\"r\u00e9ponse\": {\"results\": [{\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555, \"imp\u00f4t\": 2814, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}]}}\n2020-07-29 14:35:50.050473, Thread-1 : fin du calcul de l'imp\u00f4t des 1 contribuables\n2020-07-29 14:35:50.050473, Thread-3 : {\"r\u00e9ponse\": {\"results\": [{\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 9200, \"surc\u00f4te\": 2180, \"taux\": 0.3, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"oui\", \"enfants\": 5, \"salaire\": 100000, \"imp\u00f4t\": 4230, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}]}}\n2020-07-29 14:35:50.051214, Thread-3 : fin du calcul de l'imp\u00f4t des 2 contribuables\n2020-07-29 14:35:50.051214, Thread-5 : {\"r\u00e9ponse\": {\"results\": [{\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 200000, \"imp\u00f4t\": 64210, \"surc\u00f4te\": 7498, \"taux\": 0.45, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000, \"imp\u00f4t\": 42842, \"surc\u00f4te\": 17283, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}]}}\n2020-07-29 14:35:50.051214, Thread-5 : fin du calcul de l'imp\u00f4t des 2 contribuables\n2020-07-29 14:35:50.051214, Thread-2 : {\"r\u00e9ponse\": {\"results\": [{\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 50000, \"imp\u00f4t\": 1384, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 384, \"r\u00e9duction\": 347}, {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 50000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 720, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"non\", \"enfants\": 2, \"salaire\": 100000, \"imp\u00f4t\": 19884, \"surc\u00f4te\": 4480, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"non\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 16782, \"surc\u00f4te\": 7176, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}]}}\n2020-07-29 14:35:50.051214, Thread-2 : fin du calcul de l'imp\u00f4t des 4 contribuables\n2020-07-29 14:35:50.051214, Thread-4 : {\"r\u00e9ponse\": {\"results\": [{\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 100000, \"imp\u00f4t\": 22986, \"surc\u00f4te\": 0, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}, {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 30000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.0, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}]}}\n2020-07-29 14:35:50.051214, Thread-4 : fin du calcul de l'imp\u00f4t des 2 contribuables\n2020-07-29 14:35:50.051214, MainThread : fin du calcul de l'imp\u00f4t des contribuables\n</code></pre> <p>La dur\u00e9e de l\u2019ex\u00e9cution a \u00e9t\u00e9 de [051214-016079] nanosecondes (ligne 17 \u2013 ligne 1), \u00e7-\u00e0-d 35\u00a0millisecondes et 135 nanosecondes.</p> <p>On voit qu\u2019entre la 1\u00e8re demande faite au serveur et la derni\u00e8re r\u00e9ponse re\u00e7ue par le client, il y a la m\u00eame dur\u00e9e [051214-016079] (ligne 15 \u2013 ligne 1), 35\u00a0millisecondes et 135 nanosecondes.</p> <p>Ex\u00e9cution 2 [main2]</p> <p>L\u2019ex\u00e9cution de [main2] donne les logs suivants\u00a0:</p> <pre><code>2020-07-29 14:41:03.303520, MainThread : d\u00e9but du calcul de l'imp\u00f4t des contribuables\n2020-07-29 14:41:03.345084, MainThread : {\"r\u00e9ponse\": {\"result\": {\"limites\": [9964.0, 27519.0, 73779.0, 156244.0, 13500.0], \"coeffr\": [0.0, 0.14, 0.3, 0.41, 0.45], \"coeffn\": [0.0, 1394.96, 5798.0, 13913.7, 20163.4], \"plafond_decote_couple\": 1970.0, \"valeur_reduc_demi_part\": 3797.0, \"plafond_revenus_celibataire_pour_reduction\": 21037.0, \"plafond_qf_demi_part\": 1551.0, \"abattement_dixpourcent_max\": 12502.0, \"plafond_impot_celibataire_pour_decote\": 1595.0, \"plafond_decote_celibataire\": 1196.0, \"plafond_revenus_couple_pour_reduction\": 42074.0, \"id\": 1, \"abattement_dixpourcent_min\": 437.0, \"plafond_impot_couple_pour_decote\": 2627.0}}}\n2020-07-29 14:41:03.349975, MainThread : fin du calcul de l'imp\u00f4t des contribuables\n</code></pre> <p>La dur\u00e9e de l\u2019ex\u00e9cution a \u00e9t\u00e9 de [349975-303520] nanosecondes (ligne 3 - ligne 1), \u00e7-\u00e0-d 46\u00a0millisecondes et 455 nanosecondes. De fa\u00e7on tout \u00e0 fait inattendue [main] est plus rapide que [main2].</p> <p>On voit que l\u2019unique requ\u00eate de [main2] a dur\u00e9 [345084-303520] (ligne 2 \u2013 ligne 1), \u00e7-\u00e0-d 41 millisecondes et 564 nanosecondes. Le calcul de l\u2019imp\u00f4t a ensuite dur\u00e9 [349975-345084] (ligne 3 \u2013 ligne 2) \u00e7-\u00e0-d 4 millisecondes et 91 nanosecondes. C\u2019est la requ\u00eate HTTP qui fait la dur\u00e9e d\u2019ex\u00e9cution. De fa\u00e7on surprenante, on voit ici que l\u2019unique requ\u00eate de [main2] a dur\u00e9 plus longtemps [41 millisecondes] que les quatre requ\u00eates simultan\u00e9es de [main] [35 millisecondes]. </p> <p>C\u00f4t\u00e9 serveur, les logs sont les suivants\u00a0:</p> <pre><code>2020-07-29 14:35:27.047721, MainThread : [serveur] d\u00e9marrage du serveur\n2020-07-29 14:35:27.140927, MainThread : [serveur] connexion \u00e0 la base de donn\u00e9es r\u00e9ussie\n2020-07-29 14:35:28.790716, MainThread : [serveur] d\u00e9marrage du serveur\n2020-07-29 14:35:28.847518, MainThread : [serveur] connexion \u00e0 la base de donn\u00e9es r\u00e9ussie\n2020-07-29 14:35:50.039178, Thread-2 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/calculate-tax' [POST]&gt;\n2020-07-29 14:35:50.039178, Thread-3 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/calculate-tax' [POST]&gt;\n2020-07-29 14:35:50.043220, Thread-4 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/calculate-tax' [POST]&gt;\n2020-07-29 14:35:50.044307, Thread-5 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/calculate-tax' [POST]&gt;\n2020-07-29 14:35:50.045796, Thread-2 : [index] {'r\u00e9ponse': {'results': [{'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 100000, 'imp\u00f4t': 9200, 'surc\u00f4te': 2180, 'taux': 0.3, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}, {'mari\u00e9': 'oui', 'enfants': 5, 'salaire': 100000, 'imp\u00f4t': 4230, 'surc\u00f4te': 0, 'taux': 0.14, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}]}}\n2020-07-29 14:35:50.045796, Thread-3 : [index] {'r\u00e9ponse': {'results': [{'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 55555, 'imp\u00f4t': 2814, 'surc\u00f4te': 0, 'taux': 0.14, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}]}}\n2020-07-29 14:35:50.046825, Thread-6 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/calculate-tax' [POST]&gt;\n2020-07-29 14:35:50.046825, Thread-6 : [index] {'r\u00e9ponse': {'results': [{'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 50000, 'imp\u00f4t': 1384, 'surc\u00f4te': 0, 'taux': 0.14, 'd\u00e9c\u00f4te': 384, 'r\u00e9duction': 347}, {'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 50000, 'imp\u00f4t': 0, 'surc\u00f4te': 0, 'taux': 0.14, 'd\u00e9c\u00f4te': 720, 'r\u00e9duction': 0}, {'mari\u00e9': 'non', 'enfants': 2, 'salaire': 100000, 'imp\u00f4t': 19884, 'surc\u00f4te': 4480, 'taux': 0.41, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}, {'mari\u00e9': 'non', 'enfants': 3, 'salaire': 100000, 'imp\u00f4t': 16782, 'surc\u00f4te': 7176, 'taux': 0.41, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}]}}\n2020-07-29 14:35:50.046825, Thread-4 : [index] {'r\u00e9ponse': {'results': [{'mari\u00e9': 'non', 'enfants': 0, 'salaire': 200000, 'imp\u00f4t': 64210, 'surc\u00f4te': 7498, 'taux': 0.45, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}, {'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 200000, 'imp\u00f4t': 42842, 'surc\u00f4te': 17283, 'taux': 0.41, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}]}}\n2020-07-29 14:35:50.046825, Thread-5 : [index] {'r\u00e9ponse': {'results': [{'mari\u00e9': 'non', 'enfants': 0, 'salaire': 100000, 'imp\u00f4t': 22986, 'surc\u00f4te': 0, 'taux': 0.41, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}, {'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 30000, 'imp\u00f4t': 0, 'surc\u00f4te': 0, 'taux': 0.0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}]}}\n2020-07-29 14:41:03.341582, Thread-7 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/get-admindata' [GET]&gt;\n2020-07-29 14:41:03.341582, Thread-7 : [index] {'r\u00e9ponse': {'result': {'limites': [9964.0, 27519.0, 73779.0, 156244.0, 13500.0], 'coeffr': [0.0, 0.14, 0.3, 0.41, 0.45], 'coeffn': [0.0, 1394.96, 5798.0, 13913.7, 20163.4], 'plafond_decote_couple': 1970.0, 'valeur_reduc_demi_part': 3797.0, 'plafond_revenus_celibataire_pour_reduction': 21037.0, 'plafond_qf_demi_part': 1551.0, 'abattement_dixpourcent_max': 12502.0, 'plafond_impot_celibataire_pour_decote': 1595.0, 'plafond_decote_celibataire': 1196.0, 'plafond_revenus_couple_pour_reduction': 42074.0, 'id': 1, 'abattement_dixpourcent_min': 437.0, 'plafond_impot_couple_pour_decote': 2627.0}}}\n</code></pre> <ul> <li>ligne 5\u00a0: la 1\u00e8re requ\u00eate du client\u00a0[main]\u00a0;</li> <li>ligne 14\u00a0: la derni\u00e8re r\u00e9ponse au client [main]. Il y a 6 millisecondes et 647 nanosecondes entre les deux\u00a0;</li> <li>lignes 15-16\u00a0: l\u2019unique requ\u00eate du client [main2]. La r\u00e9ponse est instantan\u00e9e\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-12.html","title":"30. Exercice d\u2019application\u00a0: version 12","text":"<p>Nous allons dans ce chapitre \u00e9crire une application web respectant l\u2019architecture MVC (Mod\u00e8le-Vue-Contr\u00f4leur). L\u2019application pourra d\u00e9livrer ses r\u00e9ponses dans trois formats\u00a0: jSON, XML, HTML. Il y a un saut de complexit\u00e9 entre ce que nous allons faire maintenant et ce qui a \u00e9t\u00e9 fait pr\u00e9c\u00e9demment. Nous allons r\u00e9utiliser la plupart des concepts vus jusqu\u2019\u00e0 maintenant et allons d\u00e9tailler toutes les \u00e9tapes menant \u00e0 l\u2019application finale.</p>"},{"location":"exercice-dapplication-version-12.html#301-architecture-mvc","title":"30.1. Architecture MVC","text":"<p>Nous allons impl\u00e9menter le mod\u00e8le d'architecture dit MVC (Mod\u00e8le \u2013 Vue \u2013 Contr\u00f4leur) de la fa\u00e7on suivante\u00a0:</p> <p></p> <p>Le traitement d'une demande d'un client se d\u00e9roulera de la fa\u00e7on suivante\u00a0:</p> <ul> <li> <p>1 - demande Les URL demand\u00e9es seront de la forme http://machine:port/action/param1/param2/\u2026 Le [Contr\u00f4leur principal] utilisera un fichier de configuration pour \"\u00a0router\u00a0\" la demande vers le bon contr\u00f4leur. Pour cela, il utilisera le champ [action] de l'URL. Le reste de l'URL [param1/param2/\u2026] est form\u00e9 de param\u00e8tres facultatifs qui seront transmis \u00e0 l'action. Le C de MVC est ici la cha\u00eene [Contr\u00f4leur principal, Contr\u00f4leur / Action]. Si aucun contr\u00f4leur ne peut traiter l'action demand\u00e9e, le serveur web r\u00e9pondra que l'URL demand\u00e9e n'a pas \u00e9t\u00e9 trouv\u00e9e.</p> </li> <li> <p>2 - traitement</p> </li> <li>l'action choisie [2a] peut exploiter les param\u00e8tres parami que le [Contr\u00f4leur principal] lui a transmis. Ceux-ci pourront provenir de deux sources\u00a0:</li> <li>du chemin [/param1/param2/\u2026] de l'URL,</li> <li>de param\u00e8tres post\u00e9s dans le corps de la requ\u00eate du client\u00a0;</li> <li>dans le traitement de la demande de l'utilisateur, l'action peut avoir besoin de la couche [m\u00e9tier] [2b]. Une fois la demande du client trait\u00e9e, celle-ci peut appeler diverses r\u00e9ponses. Un exemple classique est\u00a0:</li> <li>une r\u00e9ponse d'erreur si la demande n'a pu \u00eatre trait\u00e9e correctement\u00a0;</li> <li>une r\u00e9ponse de confirmation sinon\u00a0;</li> <li>le [Contr\u00f4leur / Action] rendra sa r\u00e9ponse [2c] au contr\u00f4leur principal ainsi qu\u2019un code d\u2019\u00e9tat. Ces codes d\u2019\u00e9tat repr\u00e9senteront de fa\u00e7on unique l\u2019\u00e9tat dans lequel se trouve l\u2019application. Ce sera soit un code de r\u00e9ussite, soit un code d\u2019erreur\u00a0;</li> <li>3 - r\u00e9ponse</li> <li>selon que le client a demand\u00e9 une r\u00e9ponse jSON, XML ou HTML, le [Contr\u00f4leur principal] instanciera [3a] le type de r\u00e9ponse appropri\u00e9e et demandera \u00e0 celle-ci d\u2019envoyer la r\u00e9ponse au client. Le [Contr\u00f4leur principal] lui transmettra et la r\u00e9ponse et le code d\u2019\u00e9tat fournis par le [Contr\u00f4leur / Action] qui a \u00e9t\u00e9 ex\u00e9cut\u00e9\u00a0;</li> <li>si la r\u00e9ponse souhait\u00e9e est de type jSON ou XML, la r\u00e9ponse s\u00e9lectionn\u00e9e mettra en forme la r\u00e9ponse du [Contr\u00f4leur / Action] qu\u2019on lui a donn\u00e9e et l\u2019enverra [3c]. Le client capable d\u2019exploiter cette r\u00e9ponse peut \u00eatre un script console Python ou un script Javascript log\u00e9 dans une page HTML\u00a0;</li> <li>si la r\u00e9ponse souhait\u00e9e est de type HTML, la r\u00e9ponse s\u00e9lectionn\u00e9e s\u00e9lectionnera [3b] une des vues HTML [Vuei] \u00e0 l\u2019aide du code d\u2019\u00e9tat qu\u2019on lui a donn\u00e9. C\u2019est le V de MVC. A un code d\u2019\u00e9tat correspond une unique vue. Cette vue V va afficher la r\u00e9ponse du  [Contr\u00f4leur / Action] qui a \u00e9t\u00e9 ex\u00e9cut\u00e9. Elle habille avec du HTML, CSS, Javascript les donn\u00e9es de cette r\u00e9ponse. On appelle ces donn\u00e9es le mod\u00e8le de la vue. C'est le M de MVC. Le client est alors le plus souvent un navigateur\u00a0; Maintenant, pr\u00e9cisons le lien entre architecture web MVC et architecture en couches. Selon la d\u00e9finition qu'on donne au mod\u00e8le, ces deux concepts sont li\u00e9s ou non. Prenons une application web MVC \u00e0 une couche\u00a0:</li> </ul> <p></p> <p>Ci-dessus, les [Contr\u00f4leur / Action] int\u00e8grent chacun une partie des couches [m\u00e9tier] et [dao]. Dans la couche [web] on a bien une architecture MVC mais l\u2019ensemble de l\u2019application n\u2019a pas une architecture en couches. Ici il n\u2019y a qu\u2019une couche, la couche web, qui fait tout.</p> <p>Maintenant, consid\u00e9rons une architecture web multicouche\u00a0:</p> <p></p> <p>La couche [web] peut \u00eatre impl\u00e9ment\u00e9e sans suivre le mod\u00e8le MVC. On a bien alors une architecture multicouche mais la couche web n'impl\u00e9mente pas le mod\u00e8le MVC.</p> <p>Par exemple, dans le monde .NET la couche [web] ci-dessus peut \u00eatre impl\u00e9ment\u00e9e avec ASP.NET MVC et on a alors une architecture en couches avec une couche [web] de type MVC. Ceci fait, on peut remplacer cette couche ASP.NET MVC par une couche ASP.NET classique (WebForms) tout en gardant le reste (m\u00e9tier, DAO, Pilote) \u00e0 l'identique.  On a alors une architecture en couches avec une couche [web] qui n'est plus de type MVC.</p> <p>Dans MVC, nous avons dit que le mod\u00e8le M \u00e9tait celui de la vue V, c.a.d. l'ensemble des donn\u00e9es affich\u00e9es par la vue V. Une autre d\u00e9finition du mod\u00e8le M de MVC est donn\u00e9e\u00a0:</p> <p></p> <p>Beaucoup d'auteurs consid\u00e8rent que ce qui est \u00e0 droite de la couche [web] forme le mod\u00e8le M du MVC. Pour \u00e9viter les ambig\u00fcit\u00e9s on peut parler\u00a0:</p> <ul> <li>du mod\u00e8le du domaine lorsqu'on d\u00e9signe tout ce qui est \u00e0 droite de la couche [web]\u00a0;</li> <li>du mod\u00e8le de la vue lorsqu'on d\u00e9signe les donn\u00e9es affich\u00e9es par une vue V\u00a0; Dans ce qui suit, lorsque nous parlerons de mod\u00e8le, il s\u2019agita toujours du mod\u00e8le de la vue.</li> </ul>"},{"location":"exercice-dapplication-version-12.html#302-architecture-de-lapplication-client-serveur","title":"30.2. Architecture de l\u2019application client / serveur","text":"<p>L\u2019application web aura l\u2019architecture suivante\u00a0:</p> <p></p> <ul> <li>en [1] le serveur web aura deux types de clients\u00a0:</li> <li>en [2], un client console\u00a0qui \u00e9changera du jSON et du XML avec le serveur\u00a0;</li> <li>en [3], un navigateur qui recevra du HTML du serveur et l\u2019affichera\u00a0; </li> <li>le serveur web [1] conserve les couches [m\u00e9tier] et [dao] des versions pr\u00e9c\u00e9dentes\u00a0;</li> <li>le client web [2] \u00e9voluera pour tenir compte des nouvelles URL de service de l\u2019application web\u00a0;</li> <li> <p>l\u2019application HTML afich\u00e9e par le navigateur est \u00e0 \u00e9crire compl\u00e8tement\u00a0; Nous allons d\u00e9velopper l\u2019application en plusieurs temps\u00a0:</p> </li> <li> <p>nous allons d\u00e9velopper la version jSON du serveur. Nous testerons les URL de service du serveur les unes apr\u00e8s les autres avec un client Postman. Cette m\u00e9thode nous permet de construire l\u2019ossature du seveur web sans nous pr\u00e9occuper des vues (=HTML) de l\u2019application\u00a0;</p> </li> <li>apr\u00e8s avoir test\u00e9 le serveur jSON avec Postman, nous le testerons avec un client console\u00a0;</li> <li>puis nous passerons \u00e0 la version XML du serveur. Nous avons vu que le passage du jSON au XML \u00e9tait trivial\u00a0;</li> <li>enfin nous passerons \u00e0 la version HTML du serveur. Nous construirons une architecture MVC et d\u00e9finirons les vues \u00e0 afficher. L\u2019application HTML sera test\u00e9e \u00e0 la fois avec le client Postman et un navigateur classique\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-12.html#303-larborescence-du-code-du-serveur","title":"30.3. L\u2019arborescence du code du serveur","text":"<ul> <li>en [1\u00a0: le serveur web dans sa globalit\u00e9\u00a0;</li> </ul> <ul> <li>en [2]\u00a0: nous ignorerons pour l\u2019instant les dossiers [static, templates, tests_views] qui concernent la version HTML du serveur. En-dehors de ce dossier nous trouverons le script principal [main] et sa configuration\u00a0;</li> <li>en [3], les contr\u00f4leurs du serveur web. Ce seront des instances de classes\u00a0;</li> </ul> <ul> <li>en [4], la r\u00e9ponse HTTP du serveur sera g\u00e9r\u00e9e par des classes\u00a0;</li> <li>en [5], nous conservons le fichier de logs des serveurs pr\u00e9c\u00e9dents\u00a0; Lorsque nous construirons la version HTML du serveur, d\u2019autres dossiers interviendront\u00a0:</li> </ul> <ul> <li>en [6], les \u00e9l\u00e9ments statiques de l\u2019application HTML\u00a0;</li> <li>en [7], les templates de l\u2019application HTML d\u00e9compos\u00e9s en vues [9] et en fragments de vue [8]\u00a0;</li> <li>en [9], les classes impl\u00e9mentant les mod\u00e8les des vues\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-12.html#304-les-url-de-service-de-lapplication","title":"30.4. Les URL de service de l\u2019application","text":"<p>Pour construire le serveur web, nous allons proc\u00e9der de la fa\u00e7on suivante\u00a0:</p> <ul> <li>\u00e0 partir des vues de l\u2019application HTML, nous allons d\u00e9finir les actions que doit impl\u00e9menter l\u2019application web. Nous allons ici utiliser les vues r\u00e9elles mais ce pourrait \u00eatre simplement des vues sur papier\u00a0;</li> <li>\u00e0 partir de ces actions, nous allons d\u00e9finir les URL de service de l\u2019application HTML\u00a0;</li> <li>nous allons impl\u00e9menter ces URL de service avec un serveur d\u00e9livrant du jSON. Cela permet de d\u00e9finir l\u2019ossature du serveur web sans se pr\u00e9occuper des pages HTML \u00e0 d\u00e9livrer. Nous testerons ces URL de service avec Postman\u00a0;</li> <li>nous testerons ensuite notre serveur jSON avec un client console\u00a0;</li> <li> <p>une fois que le serveur jSON aura \u00e9t\u00e9 valid\u00e9, nous passerons \u00e0 l\u2019\u00e9riture de l\u2019application HTML\u00a0; La 1\u00e8re vue sera la vue d\u2019authentification\u00a0:</p> </li> <li> <p>l\u2019action qui m\u00e8ne \u00e0 cette 1\u00e8re vue s\u2019appellera [init-session] [1]\u00a0;</p> </li> </ul> <p></p> <ul> <li>le clic sur le bouton [Valider] va d\u00e9clencher l\u2019action [authentifier-utilisateur] avec deux param\u00e8tres post\u00e9s [2-3]\u00a0; La vue du calcul de l\u2019imp\u00f4t\u00a0:</li> </ul> <p></p> <ul> <li>en [1], l\u2019action [authentifier-utilisateur] qui a amen\u00e9 \u00e0 cette vue\u00a0;</li> <li>en [2], le clic sur le bouton [Valider] d\u00e9clenche l\u2019ex\u00e9cution de l\u2019action [calculer-impot] avec trois param\u00e8tres post\u00e9s [2-5]\u00a0;</li> <li>le clic sur le lien [6] d\u00e9clenche l\u2019action [lister-simulations] sans param\u00e8tres\u00a0;</li> <li>le clic sur le lien [7] d\u00e9clenche l\u2019action [fin-session] sans param\u00e8tres\u00a0; La 3i\u00e8me vue est celle des simulations faites par l\u2019utilisateur authentifi\u00e9\u00a0:</li> </ul> <p></p> <ul> <li>en [3], l\u2019action [lister-simulations] qui a amen\u00e9 \u00e0 cette vue\u00a0;</li> <li>en [2], un clic sur le lien [Supprimer] d\u00e9clenche l\u2019action [supprimer-simulation]\u00a0avec un param\u00e8tre, le n\u00b0 de la simulation \u00e0 supprimer dans la liste\u00a0;</li> <li>un clic sur le lien [3] d\u00e9clenche l\u2019action [afficher-calcul-impot] sans param\u00e8tres qui r\u00e9affiche la vue du calcul de l\u2019imp\u00f4t\u00a0;</li> <li>un clic sur le lien [4] d\u00e9clenche l\u2019action [fin-session]\u00a0sans param\u00e8tres\u00a0; Avec ces premi\u00e8res informations, nous pouvons d\u00e9finir les diff\u00e9rentes URL de service du serveur\u00a0:</li> </ul> <p>Action</p><p>R\u00f4le</p><p>Contexte d\u2019ex\u00e9cution</p><p>/init-session</p><p>Sert \u00e0 fixer le type (json, xml, html) des r\u00e9ponses souhait\u00e9es</p><p>Requ\u00eate GET</p><p>Peut \u00eatre \u00e9mise \u00e0 tout moment</p><p>/authentifier-utilisateur</p><p>Autorise ou non un utilisateur \u00e0 se connecter</p><p>Requ\u00eate POST.</p><p>La requ\u00eate doit avoir deux param\u00e8tres post\u00e9s [user, password]</p><p>Ne peut \u00eatre \u00e9mise que si le type de la session (json, xml, html) est connu</p><p>/calculer-impot</p><p>Fait une simulation de calcul d\u2019imp\u00f4t</p><p>Requ\u00eate POST.</p><p>La requ\u00eate doit avoir trois param\u00e8tres post\u00e9s [mari\u00e9, enfants, salaire]</p><p>Ne peut \u00eatre \u00e9mise que si le type de la session (json, xml, html) est connu et l\u2019utilisateur authentifi\u00e9</p><p>/lister-simulations</p><p>Demande \u00e0 voir la liste des simulations op\u00e9r\u00e9es depuis le d\u00e9but de la session</p><p>Requ\u00eate GET.</p><p>Ne peut \u00eatre \u00e9mise que si le type de la session (json, xml, html) est connu et l\u2019utilisateur authentifi\u00e9</p><p>/supprimer-simulation/num\u00e9ro</p><p>Supprime une simulation de la liste des simulations</p><p>Requ\u00eate GET.</p><p>Ne peut \u00eatre \u00e9mise que si le type de la session (json, xml, html) est connu et l\u2019utilisateur authentifi\u00e9</p><p>/afficher-calcul-impot</p><p>Affiche la page HTML du calul de l\u2019imp\u00f4t</p><p>Requ\u00eate GET.</p><p>Ne peut \u00eatre \u00e9mise que si le type de la session (json, xml, html) est connu et l\u2019utilisateur authentifi\u00e9</p><p>/fin-session</p><p>Termine la session de simulations.</p><p>Techniquement l\u2019ancienne session web est supprim\u00e9e et une nouvelle session est cr\u00e9\u00e9e</p><p>Ne peut \u00eatre \u00e9mise que si le type de la session (json, xml, html) est connu et l\u2019utilisateur authentifi\u00e9</p> <p>Ces diff\u00e9rentes URL de service seront utilis\u00e9es aussi bien pour le serveur HTML que pour les serveurs jSON ou XML. Deux URL ne seront utilis\u00e9es que pour ces deux derniers serveurs\u00a0: ce sont les URL de la version pr\u00e9c\u00e9dente du client / serveur web que nous reprenons ici\u00a0:</p> <p>Action</p><p>R\u00f4le</p><p>Contexte d\u2019ex\u00e9cution</p><p>/get-admindata</p><p>Rend les donn\u00e9es fiscales permettant le calcul de l\u2019imp\u00f4t</p><p>Requ\u00eate GET.</p><p>N\u2019est utilis\u00e9e que si le type de la session est json ou xml. L\u2019utilisateur doit \u00eatre authentifi\u00e9</p><p>/calculer-impots</p><p>Fait le calcul de l\u2019imp\u00f4t d\u2019une liste de contribuables post\u00e9s en jSON</p><p>Requ\u00eate GET.</p><p>N\u2019est utilis\u00e9e que si le type de la session est json ou xml. L\u2019utilisateur doit \u00eatre authentifi\u00e9</p> <p>Tous les contr\u00f4leurs associ\u00e9s \u00e0 ces actions proc\u00e8deront de la m\u00eame fa\u00e7on\u00a0:</p> <ul> <li>ils v\u00e9rifieront leurs param\u00e8tres. Ceux-ci sont trouv\u00e9s dans l\u2019objet\u00a0:</li> <li>[request.path] pour les param\u00e8tres pr\u00e9sents dans l\u2019URL\u00a0sous la forme [/action/param1/param2/\u2026]\u00a0;</li> <li>dans l\u2019objet [request.form] pour ceux qui sont transmis en [x-www-form-urlencoded] dans le corps de la requ\u00eate\u00a0;</li> <li>dans l\u2019objet [request.data] pour ceux qui sont transmis en jSON\u00a0dans le corps de la requ\u00eate\u00a0;</li> <li>un contr\u00f4leur s\u2019apparente \u00e0 une fonction ou m\u00e9thode qui v\u00e9rifie la validit\u00e9 de ses param\u00e8tres. Pour le contr\u00f4leur c\u2019est cependant un peu plus compliqu\u00e9\u00a0:</li> <li>les param\u00e8tres attendus peuvent \u00eatre absents\u00a0;</li> <li>les param\u00e8tres r\u00e9cup\u00e9r\u00e9s par le contr\u00f4leur sont des cha\u00eenes de caract\u00e8res. Si le param\u00e8tre attendu est un nombre, alors le contr\u00f4leur doit v\u00e9rifier que la cha\u00eene de caract\u00e8res du param\u00e8tre est bien celle d\u2019un nombre\u00a0;</li> <li>une fois v\u00e9rifi\u00e9, que les param\u00e8tres attendus sont pr\u00e9sents et syntaxiquement corrects, il faut v\u00e9rifier qu\u2019ils sont valides dans le contexte d\u2019ex\u00e9cution du moment. Ce contexte est pr\u00e9sent dans la session. L\u2019exemple de l\u2019authentification est un exemple de contexte d\u2019ex\u00e9cution. Certaines actions ne doivent \u00eatre trait\u00e9es qu\u2019une fois le client authentifi\u00e9. G\u00e9n\u00e9ralement, une cl\u00e9 dans la session indique si cette authentification a eu lieu ou pas\u00a0;</li> <li>une fois, les v\u00e9rifications pr\u00e9c\u00e9dentes faites, le contr\u00f4leur secondaire peut travailler. Ce travail de v\u00e9rification des param\u00e8tres est tr\u00e8s important. On ne peut pas accepter qu\u2019un client nous envoie n\u2019importe quoi \u00e0 n\u2019importe quel moment de la vie de l\u2019application. On doit contr\u00f4ler totalement la vie de celle-ci\u00a0;</li> <li>une fois son travail fait, le contr\u00f4leur secondaire rend un dictionnaire avec les cl\u00e9s [action, \u00e9tat, r\u00e9ponse] au contr\u00f4leur principal qui l\u2019a appel\u00e9\u00a0:</li> <li>[action] est l\u2019action qui vient d\u2019\u00eatre ex\u00e9cut\u00e9e\u00a0;</li> <li>[\u00e9tat] est un nombre \u00e0 trois chiffres qui indique le r\u00e9sultat du traitement de l\u2019action\u00a0:</li> <li>[x00] signalera une r\u00e9ussite du traitement\u00a0;</li> <li>[x01] signalera un \u00e9chec du traitement\u00a0;</li> <li>[r\u00e9ponse] est le dictionnaire des r\u00e9sultats sous la forme {\u2018r\u00e9ponse\u2019:objet}. L\u2019objet aura des structures diff\u00e9rentes selon l\u2019action trait\u00e9e\u00a0; Nous allons maintenant passer en revue les diff\u00e9rents contr\u00f4leurs ou ce qui revient au m\u00eame les diff\u00e9rentes actions que ces contr\u00f4leurs traitent et qui rythment la vie de l\u2019application web.</li> </ul>"},{"location":"exercice-dapplication-version-12.html#305-configuration-du-serveur","title":"30.5. Configuration du serveur","text":"<p>La configuration de la base de donn\u00e9es [config_database] ainsi que celle des couches du serveur [config_layers] sont identiques \u00e0 celles des versions pr\u00e9c\u00e9dentes. Le fichier [config] voit appara\u00eetre de nouvelles informations\u00a0:</p> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a01\u00a0------\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0de\u00a0ce\u00a0fichier\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0racine\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020\"\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossiers\u00a0du\u00a0projet\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0BaseEntity,\u00a0MyException\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/classes/02/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0InterfaceImp\u00f4tsDao,\u00a0InterfaceImp\u00f4tsM\u00e9tier,\u00a0InterfaceImp\u00f4tsUi\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AbstractImp\u00f4tsdao,\u00a0Imp\u00f4tsConsole,\u00a0Imp\u00f4tsM\u00e9tier\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ImpotsDaoWithAdminDataInDatabase\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AdminData,\u00a0Imp\u00f4tsError,\u00a0TaxPayer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Constantes,\u00a0tranches\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Logger,\u00a0SendAdminMail\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/http-servers/02/utilities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0scripts\u00a0[config_database,\u00a0config_layers]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0script_dir,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0contr\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../controllers\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9ponses\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../responses\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mod\u00e8les\u00a0des\u00a0vues\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../models_for_views\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fixe\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\u00a0du\u00a0serveur\u00a0web\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0contr\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0from\u00a0AfficherCalculImpotController\u00a0import\u00a0AfficherCalculImpotController\n\u00a0\u00a0\u00a0\u00a0from\u00a0AuthentifierUtilisateurController\u00a0import\u00a0AuthentifierUtilisateurController\n\u00a0\u00a0\u00a0\u00a0from\u00a0CalculerImpotController\u00a0import\u00a0CalculerImpotController\n\u00a0\u00a0\u00a0\u00a0from\u00a0CalculerImpotsController\u00a0import\u00a0CalculerImpotsController\n\u00a0\u00a0\u00a0\u00a0from\u00a0FinSessionController\u00a0import\u00a0FinSessionController\n\u00a0\u00a0\u00a0\u00a0from\u00a0GetAdminDataController\u00a0import\u00a0GetAdminDataController\n\u00a0\u00a0\u00a0\u00a0from\u00a0InitSessionController\u00a0import\u00a0InitSessionController\n\u00a0\u00a0\u00a0\u00a0from\u00a0ListerSimulationsController\u00a0import\u00a0ListerSimulationsController\n\u00a0\u00a0\u00a0\u00a0from\u00a0MainController\u00a0import\u00a0MainController\n\u00a0\u00a0\u00a0\u00a0from\u00a0SupprimerSimulationController\u00a0import\u00a0SupprimerSimulationController\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0r\u00e9ponses\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0from\u00a0HtmlResponse\u00a0import\u00a0HtmlResponse\n\u00a0\u00a0\u00a0\u00a0from\u00a0JsonResponse\u00a0import\u00a0JsonResponse\n\u00a0\u00a0\u00a0\u00a0from\u00a0XmlResponse\u00a0import\u00a0XmlResponse\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0mod\u00e8les\u00a0des\u00a0vues\n\u00a0\u00a0\u00a0\u00a0from\u00a0ModelForAuthentificationView\u00a0import\u00a0ModelForAuthentificationView\n\u00a0\u00a0\u00a0\u00a0from\u00a0ModelForCalculImpotView\u00a0import\u00a0ModelForCalculImpotView\n\u00a0\u00a0\u00a0\u00a0from\u00a0ModelForErreursView\u00a0import\u00a0ModelForErreursView\n\u00a0\u00a0\u00a0\u00a0from\u00a0ModelForListeSimulationsView\u00a0import\u00a0ModelForListeSimulationsView\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a02\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0config.update({\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0utilisateurs\u00a0autoris\u00e9s\u00a0\u00e0\u00a0utiliser\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"users\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"login\":\u00a0\"admin\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"admin\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0de\u00a0logs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"logsFilename\":\u00a0f\"{script_dir}/../data/logs/logs.txt\",\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0config\u00a0serveur\u00a0SMTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"adminMail\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0serveur\u00a0SMTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"smtp-server\":\u00a0\"localhost\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0port\u00a0du\u00a0serveur\u00a0SMTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"smtp-port\":\u00a0\"25\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0administrateur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"from\":\u00a0\"guest@localhost.com\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"to\":\u00a0\"guest@localhost.com\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0sujet\u00a0du\u00a0mail\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"subject\":\u00a0\"plantage\u00a0du\u00a0serveur\u00a0de\u00a0calcul\u00a0d'imp\u00f4ts\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0tls\u00a0\u00e0\u00a0True\u00a0si\u00a0le\u00a0serveur\u00a0SMTP\u00a0requiert\u00a0une\u00a0autorisation,\u00a0\u00e0\u00a0False\u00a0sinon\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"tls\":\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dur\u00e9e\u00a0pause\u00a0thread\u00a0en\u00a0secondes\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"sleep_time\":\u00a00,\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0autoris\u00e9es\u00a0et\u00a0leurs\u00a0contr\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"controllers\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0initialisation\u00a0d'une\u00a0session\u00a0de\u00a0calcul\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"init-session\":\u00a0InitSessionController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0authentification\u00a0d'un\u00a0utilisateur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"authentifier-utilisateur\":\u00a0AuthentifierUtilisateurController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0en\u00a0mode\u00a0individuel\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"calculer-impot\":\u00a0CalculerImpotController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0en\u00a0mode\u00a0lots\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"calculer-impots\":\u00a0CalculerImpotsController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0liste\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"lister-simulations\":\u00a0ListerSimulationsController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0suppression\u00a0d'une\u00a0simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"supprimer-simulation\":\u00a0SupprimerSimulationController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fin\u00a0de\u00a0la\u00a0session\u00a0de\u00a0calcul\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"fin-session\":\u00a0FinSessionController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0de\u00a0la\u00a0vue\u00a0de\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"afficher-calcul-impot\":\u00a0AfficherCalculImpotController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0obtention\u00a0des\u00a0donn\u00e9es\u00a0de\u00a0l'administration\u00a0fiscale\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"get-admindata\":\u00a0GetAdminDataController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0main\u00a0controller\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"main-controller\":\u00a0MainController()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0diff\u00e9rents\u00a0types\u00a0de\u00a0r\u00e9ponse\u00a0(json,\u00a0xml,\u00a0html)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"responses\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"json\":\u00a0JsonResponse(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"html\":\u00a0HtmlResponse(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"xml\":\u00a0XmlResponse()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0vues\u00a0HTML\u00a0et\u00a0leurs\u00a0mod\u00e8les\u00a0d\u00e9pendent\u00a0de\u00a0l'\u00e9tat\u00a0rendu\u00a0par\u00a0le\u00a0contr\u00f4leur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"views\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0d'authentification\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/init-session\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0700,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/authentifier-utilisateur\u00a0\u00e9chec\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0201\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-authentification.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForAuthentificationView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/authentifier-utilisateur\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0200,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/calculer-impot\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0300,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/calculer-impot\u00a0\u00e9chec\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0301,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/afficher-calcul-impot\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0800\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-calcul-impot.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForCalculImpotView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0de\u00a0la\u00a0liste\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/lister-simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0500,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/supprimer-simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0600\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-liste-simulations.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForListeSimulationsView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0des\u00a0erreurs\u00a0inattendues\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view-erreurs\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-erreurs.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForErreursView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0redirections\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"redirections\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0400,\u00a0\u00a0#\u00a0/fin-session\u00a0r\u00e9ussi\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"to\":\u00a0\"/init-session/html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a03\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0la\u00a0base\u00a0de\u00a0donn\u00e9es\n\u00a0\u00a0\u00a0\u00a0import\u00a0config_database\n\u00a0\u00a0\u00a0\u00a0config[\"database\"]\u00a0=\u00a0config_database.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a04\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0import\u00a0config_layers\n\u00a0\u00a0\u00a0\u00a0config['layers']\u00a0=\u00a0config_layers.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <ul> <li>jusqu\u2019\u00e0 la ligne 41, on retrouve des choses classiques\u00a0;</li> <li>lignes 43-66\u00a0: arriv\u00e9 \u00e0 la ligne 43, le Python Path du serveur est d\u00e9fini. On peut alors importer les d\u00e9pendances du projet\u00a0:</li> <li>lignes 45-55\u00a0: la liste des contr\u00f4leurs\u00a0;</li> <li>lignes 57-60\u00a0: la liste des r\u00e9ponses HTTP\u00a0;</li> <li>lignes 62-66\u00a0: la liste des mod\u00e8les de vues\u00a0;</li> <li>lignes 68-189\u00a0: la configuration de l\u2019application avec une s\u00e9rie de constantes\u00a0;</li> <li>lignes 71-98\u00a0: nous connaissons d\u00e9\u00e0 ces lignes rencontr\u00e9es dans les versions pr\u00e9c\u00e9dentes\u00a0;</li> <li>lignes 101-122\u00a0: le dictionnaire des contr\u00f4leurs\u00a0:</li> <li>les cl\u00e9s sont les noms des actions\u00a0;</li> <li>les valeurs sont une instance du contr\u00f4leur qui doit g\u00e9rer cette action. Chaque contr\u00f4leur n\u2019est instanci\u00e9 qu\u2019en un unique exemplaire (singleton). La m\u00eame instance sera ex\u00e9cut\u00e9e par diff\u00e9rents threads du serveur. Il faudra donc veiller aux donn\u00e9es partag\u00e9es que chaque contr\u00f4leur pourrait vouloir modifier\u00a0;</li> <li>lignes 125-129\u00a0: le dictionnaire des trois r\u00e9ponses HTTP possibles\u00a0:</li> <li>les cl\u00e9s sont le type de r\u00e9ponse souhait\u00e9 par le client (jSON, xml, html)\u00a0;</li> <li>les valeurs sont une instance de la r\u00e9ponse HTTP. Chaque g\u00e9n\u00e9rateur de r\u00e9ponse n\u2019est instanci\u00e9 qu\u2019en un unique exemplaire (singleton). Le m\u00eame g\u00e9n\u00e9rateur sera ex\u00e9cut\u00e9 par diff\u00e9rents threads du serveur. Il faudra donc veiller aux donn\u00e9es partag\u00e9es que chaque g\u00e9n\u00e9rateur pourrait vouloir modifier\u00a0;</li> <li>lignbes 132-186\u00a0: configuration des vues HTML. Pour l\u2019instant, on ignore ces lignes\u00a0;</li> <li>lignes 191-202\u00a0: nous avons d\u00e9j\u00e0 rencontr\u00e9 ces lignes dans les versions pr\u00e9c\u00e9dentes\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-12.html#306-cheminement-dune-requete-client-au-sein-du-serveur","title":"30.6. Cheminement d\u2019une requ\u00eate client au sein du serveur","text":"<p>Nous allons suivre le cheminement d\u2019une requ\u00eate client arrivant sur le serveur jusqu\u2019\u00e0 la r\u00e9ponse HTTP envoy\u00e9e en retour. Elle suit le cheminement du serveur MVC.</p> <p></p>"},{"location":"exercice-dapplication-version-12.html#3061-le-script-main","title":"30.6.1. Le script [main]","text":"<p>Le script [main] est identique en de nombreux points \u00e0 celui des versions pr\u00e9c\u00e9dentes. Nous le donnons n\u00e9anmoins en entier pour repartir sur de bonnes bases\u00a0:</p> <pre><code>#\u00a0on\u00a0attend\u00a0un\u00a0param\u00e8tre\u00a0mysql\u00a0ou\u00a0pgres\nimport\u00a0sys\n\nsyntaxe\u00a0=\u00a0f\"{sys.argv[0]}\u00a0mysql\u00a0/\u00a0pgres\"\nerreur\u00a0=\u00a0len(sys.argv)\u00a0!=\u00a02\nif\u00a0not\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0sgbd\u00a0=\u00a0sys.argv[1].lower()\n\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0sgbd\u00a0!=\u00a0\"mysql\"\u00a0and\u00a0sgbd\u00a0!=\u00a0\"pgres\"\nif\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0print(f\"syntaxe\u00a0:\u00a0{syntaxe}\")\n\u00a0\u00a0\u00a0\u00a0sys.exit()\n\n#\u00a0on\u00a0configure\u00a0l'application\nimport\u00a0config\nconfig\u00a0=\u00a0config.configure({'sgbd':\u00a0sgbd})\n\n#\u00a0d\u00e9pendances\nfrom\u00a0flask\u00a0import\u00a0request,\u00a0Flask,\u00a0session,\u00a0url_for, redirect\nfrom\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0SendAdminMail\u00a0import\u00a0SendAdminMail\nfrom\u00a0myutils\u00a0import\u00a0json_response\nfrom\u00a0Logger\u00a0import\u00a0Logger\nimport\u00a0threading\nimport\u00a0time\nfrom\u00a0random\u00a0import\u00a0randint\nfrom\u00a0Imp\u00f4tsError\u00a0import\u00a0Imp\u00f4tsError\nimport\u00a0os\n\n#\u00a0envoi\u00a0d'un\u00a0mail\u00a0\u00e0\u00a0l'administrateur\ndef\u00a0send_adminmail(config:\u00a0dict,\u00a0message:\u00a0str):\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0un\u00a0mail\u00a0\u00e0\u00a0l'administrateur\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0config_mail\u00a0=\u00a0config[\"adminMail\"]\n\u00a0\u00a0\u00a0\u00a0config_mail[\"logger\"]\u00a0=\u00a0config['logger']\n\u00a0\u00a0\u00a0\u00a0SendAdminMail.send(config_mail,\u00a0message)\n\n#\u00a0v\u00e9rification\u00a0du\u00a0fichier\u00a0de\u00a0logs\nlogger\u00a0=\u00a0None\nerreur\u00a0=\u00a0False\nmessage_erreur\u00a0=\u00a0None\ntry:\n\u00a0\u00a0\u00a0\u00a0#\u00a0logueur\n\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0Logger(config[\"logsFilename\"])\nexcept\u00a0BaseException\u00a0as\u00a0exception:\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0console\n\u00a0\u00a0\u00a0\u00a0print(f\"L'erreur\u00a0suivante\u00a0s'est\u00a0produite\u00a0:\u00a0{exception}\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0message_erreur\u00a0=\u00a0f\"{exception}\"\n#\u00a0on\u00a0m\u00e9morise\u00a0le\u00a0logueur\u00a0dans\u00a0la\u00a0config\nconfig['logger']\u00a0=\u00a0logger\n#\u00a0gestion\u00a0de\u00a0l'erreur\nif\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0#\u00a0mail\u00a0\u00e0\u00a0l'administrateur\n\u00a0\u00a0\u00a0\u00a0send_adminmail(config,\u00a0message_erreur)\n\u00a0\u00a0\u00a0\u00a0#\u00a0fin\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0sys.exit(1)\n\n#\u00a0log\u00a0de\u00a0d\u00e9marrage\nlog\u00a0=\u00a0\"[serveur]\u00a0d\u00e9marrage\u00a0du\u00a0serveur\"\nlogger.write(f\"{log}\\n\")\nprint(log)\n\n#\u00a0r\u00e9cup\u00e9ration\u00a0des\u00a0donn\u00e9es\u00a0de\u00a0l'administration\u00a0fiscale\nerreur\u00a0=\u00a0False\ntry:\n\u00a0\u00a0\u00a0\u00a0#\u00a0admindata\u00a0sera\u00a0une\u00a0donn\u00e9e\u00a0de\u00a0port\u00e9e\u00a0application\u00a0en\u00a0lecture\u00a0seule\n\u00a0\u00a0\u00a0\u00a0config[\"admindata\"]\u00a0=\u00a0config[\"layers\"][\"dao\"].get_admindata().asdict()\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0de\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0logger.write(\"[serveur]\u00a0connexion\u00a0\u00e0\u00a0la\u00a0base\u00a0de\u00a0donn\u00e9es\u00a0r\u00e9ussie\\n\")\nexcept\u00a0Imp\u00f4tsError\u00a0as\u00a0ex:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0d'erreur\n\u00a0\u00a0\u00a0\u00a0log\u00a0=\u00a0f\"L'erreur\u00a0suivante\u00a0s'est\u00a0produite\u00a0:\u00a0{ex}\"\n\u00a0\u00a0\u00a0\u00a0#\u00a0console\n\u00a0\u00a0\u00a0\u00a0print(log)\n\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0de\u00a0logs\n\u00a0\u00a0\u00a0\u00a0logger.write(f\"{log}\\n\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0mail\u00a0\u00e0\u00a0l'administrateur\n\u00a0\u00a0\u00a0\u00a0send_adminmail(config,\u00a0log)\n\n#\u00a0le\u00a0thread\u00a0principal\u00a0n'a\u00a0plus\u00a0besoin\u00a0du\u00a0logger\nlogger.close()\n\n#\u00a0s'il\u00a0y\u00a0a\u00a0eu\u00a0erreur\u00a0on\u00a0s'arr\u00eate\nif\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0sys.exit(2)\n\n#\u00a0application\u00a0Flask\napp\u00a0=\u00a0Flask(__name__,\u00a0template_folder=\"templates\",\u00a0static_folder=\"static\")\n#\u00a0cl\u00e9\u00a0secr\u00e8te\u00a0de\u00a0la\u00a0session\napp.secret_key\u00a0=\u00a0os.urandom(12).hex()\n\n#\u00a0le front controller\ndef\u00a0front_controller()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0traite\u00a0la\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u2026\n\n@app.route('/',\u00a0methods=['GET'])\ndef\u00a0index()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\u00a0/init-session/html\n\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(url_for(\"init_session\",\u00a0type_response=\"html\"),\u00a0status.HTTP_302_FOUND)\n\n#\u00a0init-session\n@app.route('/init-session/&lt;string:type_response&gt;',\u00a0methods=['GET'])\ndef\u00a0init_session(type_response:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0authentifier-utilisateur\n@app.route('/authentifier-utilisateur',\u00a0methods=['POST'])\ndef\u00a0authentifier_utilisateur()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0calculer-impot\n@app.route('/calculer-impot',\u00a0methods=['POST'])\ndef\u00a0calculer_impot()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0lister-simulations\n@app.route('/lister-simulations',\u00a0methods=['GET'])\ndef\u00a0lister_simulations()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0supprimer-simulation\n@app.route('/supprimer-simulation/&lt;int:numero&gt;',\u00a0methods=['GET'])\ndef\u00a0supprimer_simulation(numero:\u00a0int)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0fin-session\n@app.route('/fin-session',\u00a0methods=['GET'])\ndef\u00a0fin_session()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0afficher-calcul-impot\n@app.route('/afficher-calcul-impot',\u00a0methods=['GET'])\ndef\u00a0afficher_calcul_impot()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0get-admindata\n@app.route('/get-admindata/&lt;int:numero&gt;',\u00a0methods=['GET'])\ndef\u00a0get_admindata()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0main\u00a0uniquement\nif\u00a0__name__\u00a0==\u00a0'__main__':\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0lance\u00a0le\u00a0serveur\n\u00a0\u00a0\u00a0\u00a0app.config.update(ENV=\"development\",\u00a0DEBUG=True)\n\u00a0\u00a0\u00a0\u00a0app.run(threaded=True)\n</code></pre> <ul> <li>lignes 1-92\u00a0: toutes ces lignes ont \u00e9t\u00e9 d\u00e9j\u00e0 rencontr\u00e9es et expliqu\u00e9es\u00a0;</li> <li>ligne 92\u00a0: le serveur va g\u00e9rer une session. Il nous faut donc une cl\u00e9 secr\u00e8te. Nous mettrons pour chaque utilisateur deux informations dans la session\u00a0:</li> <li>si l\u2019utilisateur s\u2019est correctement authentifi\u00e9\u00a0;</li> <li>\u00e0 chaque fois qu\u2019il fera un calcul d\u2019imp\u00f4t, les r\u00e9sultats de ce calcul seront plac\u00e9s dans une liste qu\u2019on appellera la liste des simulations de l\u2019utilisateur. Cette liste sera plac\u00e9e en session\u00a0;</li> <li>lignes 100-151\u00a0: la liste des URL de service du serveur. Les fonctions associ\u00e9es servent de filtre\u00a0: toutes les URL non pr\u00e9sentes dans cette liste seront rejet\u00e9es par le serveur Flask avec l\u2019erreur [404 NOT FOUND]. Une fois pass\u00e9e ce filtrage, la requ\u00eate est syst\u00e9matiquement transmise \u00e0 un \u2018Front Controller\u2019 impl\u00e9ment\u00e9 par la fonction [front_controller] des lignes 94-98 que nous allons bient\u00f4t pr\u00e9senter\u00a0;</li> <li>lignes 100-103\u00a0: gestion de la route [/]. Le point d\u2019entr\u00e9e de l\u2019application web sera l\u2019URL de la ligne 107. Aussi ligne 103, nous redirigeons le client vers cette URL\u00a0:</li> <li>la fonction [url_for] est import\u00e9e ligne 18. Elle a ici deux param\u00e8tres\u00a0:</li> <li>le 1er param\u00e8tre est le nom d\u2019une des fonctions de routage, ici celle de la ligne 107. On voit que cette fonction attend un param\u00e8tre [type_response] qui est le type (json, xml, html) de r\u00e9ponse souhait\u00e9 par le client\u00a0;</li> <li>le 2i\u00e8me param\u00e8tre reprend le nom du param\u00e8tre de la ligne 107, [type_response] et lui donne une valeur. S\u2019il y avait d\u2019autres param\u00e8tres, on r\u00e9p\u00e9terait l\u2019op\u00e9ration pour chacun d\u2019eux\u00a0;</li> <li>elle rend l\u2019URL associ\u00e9e \u00e0 la fonction d\u00e9sign\u00e9e par les deux param\u00e8tres qui lui ont \u00e9t\u00e9 donn\u00e9s. Ici cela donnera l\u2019URL de la ligne 106 o\u00f9 le param\u00e8tre est remplac\u00e9 par sa valeur [/init-session/html]\u00a0;</li> <li>la fonction [redirect] a \u00e9t\u00e9 import\u00e9e ligne 18. Elle a pour r\u00f4le d\u2019envoyer un ent\u00eate HTTP de redirection au client\u00a0:</li> <li>le 1er param\u00e8tre est l\u2019URL vers laquelle le client doit \u00eatre redirig\u00e9\u00a0;</li> <li>le 2i\u00e8me param\u00e8tre est le code de statut de la r\u00e9ponse HTTP faite au client. Le code [status.HTTP_302_FOUND] correspond \u00e0 une redirection HTTP\u00a0; La fonction [front_controller] des lignes 94-98 fait les premiers traitements de la requ\u00eate du client\u00a0:</li> </ul> <pre><code>#\u00a0le\u00a0front\u00a0controller\ndef\u00a0front_controller()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0traite\u00a0la\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0logger\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0Logger(config[\"logsFilename\"])\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0le\u00a0m\u00e9morise\u00a0dans\u00a0une\u00a0config\u00a0associ\u00e9e\u00a0au\u00a0thread\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0thread_config\u00a0=\u00a0{\"logger\":\u00a0logger}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0thread_name\u00a0=\u00a0threading.current_thread().name\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config[thread_name]\u00a0=\u00a0{\"config\":\u00a0thread_config}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0logue\u00a0la\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(f\"[ front_controller]\u00a0requ\u00eate\u00a0:\u00a0{request}\\n\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0interrompt\u00a0le\u00a0thread\u00a0si\u00a0cela\u00a0a\u00a0\u00e9t\u00e9\u00a0demand\u00e9\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0sleep_time\u00a0=\u00a0config[\"sleep_time\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0sleep_time\u00a0!=\u00a00:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0pause\u00a0est\u00a0al\u00e9atoire\u00a0pour\u00a0que\u00a0certains\u00a0threads\u00a0soient\u00a0interrompus\u00a0et\u00a0d'autres\u00a0pas\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0al\u00e9a\u00a0=\u00a0randint(0,\u00a01)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0al\u00e9a\u00a0==\u00a01:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0avant\u00a0pause\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(f\"[ front_controller]\u00a0mis\u00a0en\u00a0pause\u00a0du\u00a0thread\u00a0pendant\u00a0{sleep_time}\u00a0seconde(s)\\n\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pause\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0time.sleep(sleep_time)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fait\u00a0suivre\u00a0la\u00a0requ\u00eate\u00a0au\u00a0contr\u00f4leur\u00a0principal\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0main_controller\u00a0=\u00a0config['controllers'][\"main-controller\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat,\u00a0status_code\u00a0=\u00a0main_controller.execute(request,\u00a0session,\u00a0config)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0logue\u00a0le\u00a0r\u00e9sultat\u00a0envoy\u00e9\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0log\u00a0=\u00a0f\"[front_controller]\u00a0{r\u00e9sultat}\\n\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(log)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0y-a-t-il\u00a0eu\u00a0une\u00a0erreur\u00a0fatale\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0status_code\u00a0==\u00a0status.HTTP_500_INTERNAL_SERVER_ERROR:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0un\u00a0mail\u00a0\u00e0\u00a0l'administrateur\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0send_adminmail(config,\u00a0log)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0d\u00e9termine\u00a0le\u00a0type\u00a0souhait\u00e9\u00a0pour\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0session.get('typeResponse')\u00a0is\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0type\u00a0de\u00a0session\u00a0n'a\u00a0pas\u00a0encore\u00a0\u00e9t\u00e9\u00a0\u00e9tabli\u00a0-\u00a0ce\u00a0sera\u00a0du\u00a0jSON\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response\u00a0=\u00a0'json'\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response\u00a0=\u00a0session['typeResponse']\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0construit\u00a0la\u00a0r\u00e9ponse\u00a0\u00e0\u00a0envoyer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response_builder\u00a0=\u00a0config[\"responses\"][type_response]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response,\u00a0status_code\u00a0=\u00a0response_builder\u00a0\\\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0.build_http_response(request,\u00a0session,\u00a0config,\u00a0status_code,\u00a0r\u00e9sultat)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0response,\u00a0status_code\n\u00a0\u00a0\u00a0\u00a0except\u00a0BaseException\u00a0as\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0c'est\u00a0une\u00a0erreur\u00a0inattendue\u00a0-\u00a0on\u00a0logue\u00a0l'erreur\u00a0si\u00a0c'est\u00a0possible\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0logger:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(f\"[ front_controller]\u00a0{erreur}\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0pr\u00e9pare\u00a0la\u00a0r\u00e9ponse\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"r\u00e9ponse\":\u00a0{\"erreurs\":\u00a0[f\"{erreur}\"]}}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0lune\u00a0r\u00e9ponse\u00a0en\u00a0jSON\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0json_response(r\u00e9sultat,\u00a0status.HTTP_500_INTERNAL_SERVER_ERROR)\n\u00a0\u00a0\u00a0\u00a0finally:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ferme\u00a0le\u00a0fichier\u00a0de\u00a0logs\u00a0s'il\u00a0a\u00a0\u00e9t\u00e9\u00a0ouvert\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0logger:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.close()\n</code></pre> <ul> <li>lignes 1-57\u00a0: nous connaissons ce code. C\u2019\u00e9tait par exemple le code de la fonction appel\u00e9e [main] dans le script [main] de la version pr\u00e9c\u00e9dente. Une seule chose est \u00e0 noter, le contr\u00f4leur utilis\u00e9 aux lignes 25-26\u00a0:</li> <li> <p>ligne 25\u00a0: on r\u00e9cup\u00e8re dans la configuration l\u2019instance de contr\u00f4leur associ\u00e9e au nom [main-controller]. Il s\u2019agit des lignes suivantes\u00a0: <pre><code>\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\u00a0du\u00a0serveur\u00a0web\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0cont\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0\u2026\n\u00a0\u00a0\u00a0\u00a0from\u00a0MainController\u00a0import\u00a0MainController\n\n    #\u00a0actions\u00a0autoris\u00e9es\u00a0et\u00a0leurs\u00a0contr\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"controllers\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0main\u00a0controller\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"main-controller\":\u00a0MainController()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n</code></pre></p> </li> <li> <p>ligne 10 ci-dessus, on remarquera qu\u2019on r\u00e9cup\u00e8re une instance de classe\u00a0;</p> </li> <li>ligne 26\u00a0: on demande on contr\u00f4leur [MainController] de traiter la requ\u00eate\u00a0;</li> <li>lignes 30-45\u00a0: la r\u00e9ponse rendue par le contr\u00f4leur [MainController] est envoy\u00e9e au client. Nous reviendrons sur ces lignes un peu plus tard\u00a0; Le travail de la fonction [front_controller] puis de la classe [MainController] est de faire le travail commun \u00e0 toutes les requ\u00eates\u00a0:</li> </ul> <p>Dans le sch\u00e9ma ci-dessus, on en est toujours \u00e0 la phase 1 du traitement de la requ\u00eate. Le contr\u00f4leur principal [MainController] va poursuivre l\u2019\u00e9tape 1.</p> <p></p>"},{"location":"exercice-dapplication-version-12.html#3062-le-controleur-principal-maincontroller","title":"30.6.2. Le contr\u00f4leur principal [MainController]","text":"<p>Le contr\u00f4leur principal [MainController] continue le travail commenc\u00e9 par la fonction [front_controller]\u00a0:</p> <p>Tous les contr\u00f4leurs impl\u00e9mentent l\u2019interface [InterfaceController] [2] suivante\u00a0:</p> <p></p> <pre><code>from\u00a0abc\u00a0import\u00a0ABC,\u00a0abstractmethod\n\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nclass\u00a0InterfaceController(ABC):\n\n\u00a0\u00a0\u00a0\u00a0@abstractmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n</code></pre> <ul> <li>l\u2019interface [InterfaceController] ne d\u00e9finit que l\u2019unique m\u00e9thode [execute] de la ligne 8. Cette m\u00e9thode re\u00e7oit trois param\u00e8tres\u00a0:</li> <li>[request]\u00a0: la requ\u00eate du client\u00a0;</li> <li>[session]\u00a0: la session du client\u00a0;</li> <li> <p>[config]\u00a0: la configuration de l\u2019application\u00a0; La m\u00e9thode [execute] rend un tuple de deux \u00e9l\u00e9ments\u00a0:</p> </li> <li> <p>le 1er est le dictionnaire des r\u00e9sultats sous la forme {\u2018action\u2019: action, \u2018\u00e9tat\u2019:\u00e9tat, \u2018r\u00e9ponse\u2019:r\u00e9sultats}\u00a0;</p> </li> <li>le 2i\u00e8me est le code de statut HTTP \u00e0 rendre au client\u00a0; Le contr\u00f4leur principal [MainController] [1] impl\u00e9mente l\u2019interface [InterfaceController] de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code>#\u00a0import\u00a0des\u00a0d\u00e9pendances\n\nfrom\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\n#\u00a0contr\u00f4leurs\u00a0de\u00a0l'application\u00a0web\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\n\nclass\u00a0MainController(InterfaceController):\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8res\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0params\u00a0=\u00a0request.path.split('/')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0action\u00a0=\u00a0params[1]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0erreurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0type\u00a0de\u00a0session\u00a0doit\u00a0\u00eatre\u00a0connu\u00a0avant\u00a0certaines\u00a0actions\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response\u00a0=\u00a0session.get('typeResponse')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0type_response\u00a0is\u00a0None\u00a0and\u00a0action\u00a0!=\u00a0\"init-session\":\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0101,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"r\u00e9ponse\":\u00a0[\"pas\u00a0de\u00a0session\u00a0en\u00a0cours.\u00a0Commencer\u00a0par\u00a0action\u00a0[init-session]\"]}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pour\u00a0certaines\u00a0actions\u00a0on\u00a0doit\u00a0\u00eatre\u00a0authentifi\u00e9\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0user\u00a0=\u00a0session.get('user')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0erreur\u00a0and\u00a0user\u00a0is\u00a0None\u00a0and\u00a0action\u00a0not\u00a0in\u00a0[\"init-session\",\u00a0\"authentifier-utilisateur\"]:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0101,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"r\u00e9ponse\":\u00a0[f\"action\u00a0[{action}]\u00a0demand\u00e9e\u00a0par\u00a0utilisateur\u00a0non\u00a0authentifi\u00e9\"]}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0y-a-t-il\u00a0des\u00a0erreurs\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0renvoie\u00a0un\u00a0msg\u00a0d'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0r\u00e9sultat,\u00a0status.HTTP_400_BAD_REQUEST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0controller\u00a0=\u00a0config[\"controllers\"][action]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat,\u00a0status_code\u00a0=\u00a0controller.execute(request,\u00a0session,\u00a0config)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0r\u00e9sultat,\u00a0status_code\n</code></pre> <p>Le contr\u00f4leur [MainController] fait les premi\u00e8res v\u00e9rifications de la validit\u00e9 de la requ\u00eate.</p> <ul> <li>lignes 11-13\u00a0: le contr\u00f4leur commence par r\u00e9cup\u00e9rer l\u2019action demand\u00e9e par le client. On rappelle que les URL de service sont de la forme [/action/param1/param2/\u2026] et que cette URL est dans [request.path]\u00a0;</li> <li>lignes 17-23\u00a0: l\u2019action [init-session] sert \u00e0 initialiser le type de r\u00e9ponse (json, xml, html) d\u00e9sir\u00e9 par le client. Cette information est mise en session associ\u00e9e \u00e0 la cl\u00e9 [typeR\u00e9ponse]. Si donc l\u2019action n\u2019est pas [init-session] alors la session doit contenir la cl\u00e9 [typeR\u00e9ponse], sinon la requ\u00eate est erron\u00e9e\u00a0;</li> <li>lignes 21-22\u00a0: la structure du r\u00e9sultat rendu par chaque contr\u00f4leur, ici un r\u00e9sultat d\u2019erreur\u00a0:</li> <li>[action]\u00a0: est le nom de l\u2019action en cours. Cela va permettre d\u2019avoir son nom lorsqu\u2019on va loguer le r\u00e9sultat de la requ\u00eate\u00a0;</li> <li>[\u00e9tat]\u00a0: est un code d\u2019\u00e9tat \u00e0 trois chiffres\u00a0:</li> <li>[x00] pour une r\u00e9ussite\u00a0;</li> <li>[x01] pour un \u00e9chec\u00a0;</li> <li>[r\u00e9ponse]\u00a0: est la r\u00e9ponse \u00e0 la requ\u00eate. Sa nature est propre \u00e0 chaque requ\u00eate\u00a0;</li> <li>lignes 24-30\u00a0: l\u2019action [authentifier-utilisateur] sert \u00e0 authentifier l\u2019utilisateur. Si elle r\u00e9ussit, une cl\u00e9 [user=True] est mise dans la session de l\u2019utilisateur. Certaines URL de service ne sont accessibles que par un utilisateur authentifi\u00e9. C\u2019est ce qu\u2019on v\u00e9rifie ici\u00a0;</li> <li>ligne 26\u00a0: seules les actions [init-session] et [authentifier-utilisateur] peuvent \u00eatre faites par un utilisateur non encore authentifi\u00e9\u00a0;</li> <li>lignes 28-29\u00a0: le r\u00e9sultat \u00e0 envoyer en cas d\u2019erreur\u00a0;</li> <li>lignes 32-34\u00a0: si l\u2019une des deux erreurs pr\u00e9c\u00e9dentes s\u2019est produite, alors on envoie la r\u00e9ponse d\u2019erreur au client avec le statut HTTP 400 BAD REQUEST\u00a0;</li> <li> <p>lignes 35-39\u00a0: s\u2019il n\u2019y a pas eu d\u2019erreur alors on passe la main au contr\u00f4leur charg\u00e9 de traiter l\u2019action en cours. Son instance est trouv\u00e9e dans la configuration de l\u2019application\u00a0; La classe [MainController] continue le travail de la fonction [front_controller]\u00a0: \u00e0 elles deux, elles rassemblent tout ce qui peut \u00eatre factoris\u00e9 dans le traitement des requ\u00eates, attendant le dernier moment pour passer la requ\u00eate \u00e0 un contr\u00f4leur sp\u00e9cifique. La r\u00e9partition du code entre la fonction [front_controller] et la classe [MainController] est tout \u00e0 fait subjective. Ici j\u2019ai voulu conserver l\u2019acquis de la version pr\u00e9c\u00e9dente\u00a0: la fonction [front_controller] existait d\u00e9j\u00e0 sous le nom [main]. Dans la pratique, on pourrait\u00a0:</p> </li> <li> <p>tout mettre dans la fonction [front_controller] et \u00e9liminer la classe [MainController]\u00a0;</p> </li> <li>tout mettre dans la classe [MainController] et \u00e9liminer la fonction [front_controller]. C\u2019est plut\u00f4t cette solution que je choisirais car elle a le m\u00e9rite d\u2019all\u00e9ger le code du script principal [main]\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-12.html#307-traitement-specifique-a-une-action","title":"30.7. Traitement sp\u00e9cifique \u00e0 une action","text":"<p>Revenons \u00e0 l\u2019architecture MVC de l\u2019application\u00a0:</p> <p></p> <p>Nous en sommes toujours \u00e0 l\u2019\u00e9tape 1 ci-dessus. S\u2019il n\u2019y a pas eu d\u2019erreur, l\u2019\u00e9tape 2 va commencer. La requ\u00eate a \u00e9t\u00e9 transmise au contr\u00f4leur sp\u00e9cifique \u00e0 l\u2019action demand\u00e9e par la requ\u00eate. Supposons que cette action soit [/init-session] d\u00e9finie par la route\u00a0:</p> <pre><code>#\u00a0init-session\n@app.route('/init-session/&lt;string:type_response&gt;',\u00a0methods=['GET'])\ndef\u00a0init_session(type_response:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre> <p>Cette action est reli\u00e9e \u00e0 un contr\u00f4leur dans la configuration [config]\u00a0:</p> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0autoris\u00e9es\u00a0et\u00a0leurs\u00a0contr\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"controllers\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0initialisation\u00a0d'une\u00a0session\u00a0de\u00a0calcul\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"init-session\":\u00a0InitSessionController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n</code></pre> <p>Le contr\u00f4leur [InitSessionController] (ligne 4) prend donc la main. Son code est le suivant\u00a0:</p> <pre><code>from\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\n\nclass\u00a0InitSessionController(InterfaceController):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dummy,\u00a0action,\u00a0type_response\u00a0=\u00a0request.path.split('/')\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0au\u00a0d\u00e9part\u00a0pas\u00a0d'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0v\u00e9rification\u00a0du\u00a0type\u00a0de\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0type_response\u00a0not\u00a0in\u00a0config['responses'].keys():\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0701,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"r\u00e9ponse\":\u00a0[f\"param\u00e8tre\u00a0[type={type_response}]\u00a0invalide\"]}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0si\u00a0pas\u00a0d'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0met\u00a0le\u00a0type\u00a0de\u00a0la\u00a0session\u00a0dans\u00a0la\u00a0session\u00a0flask\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0session['typeResponse']\u00a0=\u00a0type_response\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0700,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"r\u00e9ponse\":\u00a0[f\"session\u00a0d\u00e9marr\u00e9e\u00a0avec\u00a0le\u00a0type\u00a0de\u00a0r\u00e9ponse\u00a0{type_response}\"]}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0r\u00e9sultat,\u00a0status.HTTP_200_OK\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0r\u00e9sultat,\u00a0status.HTTP_400_BAD_REQUEST\n</code></pre> <ul> <li>ligne 6\u00a0: comme les autres contr\u00f4leurs, le contr\u00f4leur [InitSessionController] impl\u00e9mente l\u2019interface [InterfaceController]\u00a0;</li> <li>ligne 10\u00a0: l\u2019URL est de type [/init-session/type_response]. On r\u00e9cup\u00e8re l\u2019action [init-session] et le type de r\u00e9ponse souhait\u00e9\u00a0;</li> <li> <p>ligne 15\u00a0: le type de r\u00e9ponse souhait\u00e9 ne peut \u00eatre que l\u2019un de ceux pr\u00e9sents dans la configuration des r\u00e9ponses\u00a0: <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0diff\u00e9rents\u00a0types\u00a0de\u00a0r\u00e9ponse\u00a0(json,\u00a0xml,\u00a0html)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"responses\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"json\":\u00a0JsonResponse(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"html\":\u00a0HtmlResponse(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"xml\":\u00a0XmlResponse()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n</code></pre></p> </li> <li> <p>si ce n\u2019est pas le cas on pr\u00e9pare une r\u00e9ponse d\u2019erreur 701 (ligne 17)\u00a0;</p> </li> <li>lignes 20-25\u00a0: cas o\u00f9 le type de r\u00e9ponse souhait\u00e9 est valide\u00a0;</li> <li>ligne 22\u00a0: le type de r\u00e9ponse souhait\u00e9 est mis en session. En effet, il va falloir s\u2019en souvenir pour les requ\u00eates qui vont suivre\u00a0;</li> <li>lignes 23-24\u00a0: on pr\u00e9pare une r\u00e9ponse de r\u00e9ussite 700\u00a0;</li> <li>ligne 25\u00a0: la r\u00e9ponse de r\u00e9ussite est rendue au code appelant\u00a0;</li> <li>ligne 27\u00a0: s\u2019il y a eu erreur, la r\u00e9ponse d\u2019erreur est rendue au code appelant\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-12.html#308-elaboration-de-la-reponse-http-du-serveur","title":"30.8. Elaboration de la r\u00e9ponse HTTP du serveur","text":"<p>Revenons \u00e0 l\u2019architecture MVC de l\u2019application\u00a0:</p> <p></p> <p>Nous venons de voir les \u00e9tapes 1 et 2. Nous avons rencontr\u00e9 trois codes d\u2019\u00e9tat\u00a0:</p> <ul> <li>700\u00a0: /init-session a r\u00e9ussi\u00a0;</li> <li>701\u00a0: /init-session a \u00e9chou\u00e9\u00a0;</li> <li>101\u00a0: requ\u00eate invalide soit parce que la session n\u2019a pas \u00e9t\u00e9 initialis\u00e9e soit parce que l\u2019utilisateur n\u2019est pas authentifi\u00e9\u00a0; Examinons comment la r\u00e9ponse du serveur va \u00eatre envoy\u00e9e au client lors de l\u2019\u00e9tape 3 ci-dessus. Cela se passe dans la fonction [front_controller] du script [main]\u00a0:</li> </ul> <pre><code>#\u00a0le\u00a0front\u00a0controller\ndef\u00a0front_controller()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0traite\u00a0la\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0logger\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0Logger(config[\"logsFilename\"])\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0le\u00a0m\u00e9morise\u00a0dans\u00a0une\u00a0config\u00a0associ\u00e9e\u00a0au\u00a0thread\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0thread_config\u00a0=\u00a0{\"logger\":\u00a0logger}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0thread_name\u00a0=\u00a0threading.current_thread().name\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config[thread_name]\u00a0=\u00a0{\"config\":\u00a0thread_config}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0logue\u00a0la\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(f\"[ front_controller]\u00a0requ\u00eate\u00a0:\u00a0{request}\\n\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0interrompt\u00a0le\u00a0thread\u00a0si\u00a0cela\u00a0a\u00a0\u00e9t\u00e9\u00a0demand\u00e9\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0sleep_time\u00a0=\u00a0config[\"sleep_time\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0sleep_time\u00a0!=\u00a00:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0pause\u00a0est\u00a0al\u00e9atoire\u00a0pour\u00a0que\u00a0certains\u00a0threads\u00a0soient\u00a0interrompus\u00a0et\u00a0d'autres\u00a0pas\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0al\u00e9a\u00a0=\u00a0randint(0,\u00a01)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0al\u00e9a\u00a0==\u00a01:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0avant\u00a0pause\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(f\"[ front_controller]\u00a0mis\u00a0en\u00a0pause\u00a0du\u00a0thread\u00a0pendant\u00a0{sleep_time}\u00a0seconde(s)\\n\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pause\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0time.sleep(sleep_time)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fait\u00a0suivre\u00a0la\u00a0requ\u00eate\u00a0au\u00a0contr\u00f4leur\u00a0principal\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0main_controller\u00a0=\u00a0config['controllers'][\"main-controller\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat,\u00a0status_code\u00a0=\u00a0main_controller.execute(request,\u00a0session,\u00a0config)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0logue\u00a0le\u00a0r\u00e9sultat\u00a0envoy\u00e9\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0log\u00a0=\u00a0f\"[front_controller]\u00a0{r\u00e9sultat}\\n\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(log)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0y-a-t-il\u00a0eu\u00a0une\u00a0erreur\u00a0fatale\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0status_code\u00a0==\u00a0status.HTTP_500_INTERNAL_SERVER_ERROR:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0un\u00a0mail\u00a0\u00e0\u00a0l'administrateur\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0send_adminmail(config,\u00a0log)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0d\u00e9termine\u00a0le\u00a0type\u00a0souhait\u00e9\u00a0pour\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0session.get('typeResponse')\u00a0is\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0type\u00a0de\u00a0session\u00a0n'a\u00a0pas\u00a0encore\u00a0\u00e9t\u00e9\u00a0\u00e9tabli\u00a0-\u00a0ce\u00a0sera\u00a0du\u00a0jSON\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response\u00a0=\u00a0'json'\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response\u00a0=\u00a0session['typeResponse']\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0construit\u00a0la\u00a0r\u00e9ponse\u00a0\u00e0\u00a0envoyer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response_builder\u00a0=\u00a0config[\"responses\"][type_response]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response,\u00a0status_code\u00a0=\u00a0response_builder\u00a0\\\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0.build_http_response(request,\u00a0session,\u00a0config,\u00a0status_code,\u00a0r\u00e9sultat)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0response,\u00a0status_code\n\u00a0\u00a0\u00a0\u00a0except\u00a0BaseException\u00a0as\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0c'est\u00a0une\u00a0erreur\u00a0inattendue\u00a0-\u00a0on\u00a0logue\u00a0l'erreur\u00a0si\u00a0c'est\u00a0possible\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0logger:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(f\"[ front_controller]\u00a0{erreur}\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0pr\u00e9pare\u00a0la\u00a0r\u00e9ponse\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"r\u00e9ponse\":\u00a0{\"erreurs\":\u00a0[f\"{erreur}\"]}}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0lune\u00a0r\u00e9ponse\u00a0en\u00a0jSON\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0json_response(r\u00e9sultat,\u00a0status.HTTP_500_INTERNAL_SERVER_ERROR)\n\u00a0\u00a0\u00a0\u00a0finally:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ferme\u00a0le\u00a0fichier\u00a0de\u00a0logs\u00a0s'il\u00a0a\u00a0\u00e9t\u00e9\u00a0ouvert\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0logger:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.close()\n</code></pre> <ul> <li>nous en sommes \u00e0 la ligne 26\u00a0: le contr\u00f4leur principal a rendu sa r\u00e9ponse d\u2019erreur\u00a0;</li> <li>lignes 27-29\u00a0: quelque soit la r\u00e9ponse du contr\u00f4leur principal (r\u00e9ussite ou \u00e9chec) cette r\u00e9ponse est logu\u00e9e dans le fichier de logs\u00a0;</li> <li>lignes 30-33\u00a0: comme dans les versions pr\u00e9c\u00e9dentes, si le statut HTTP est [500 INTERNAL SERVER ERROR], on envoie un mail \u00e0 l\u2019administrateur de l\u2019application avec le log de l\u2019erreur\u00a0;</li> <li>lignes 34-39\u00a0: on va envoyer la r\u00e9ponse HTTP et le r\u00e9sultat rendu par le contr\u00f4leur va \u00eatre mis dans le corps de cette r\u00e9ponse. Il nous faut savoir sous quelle forme (json, xml, html) le client veut cette r\u00e9ponse. On cherche le type de r\u00e9ponse souhait\u00e9e dans la session. S\u2019il n\u2019y est pas, alors on fixe arbitrairement ce type \u00e0 du jSON\u00a0;</li> <li>lignes 40-43\u00a0: la r\u00e9ponse HTTP est construite\u00a0; Dans le fichier de configuration, chaque type de r\u00e9ponse (json, xml, html) a \u00e9t\u00e9 associ\u00e9 \u00e0 une instance de classe\u00a0:</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0diff\u00e9rents\u00a0types\u00a0de\u00a0r\u00e9ponse\u00a0(json,\u00a0xml,\u00a0html)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"responses\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"json\":\u00a0JsonResponse(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"html\":\u00a0HtmlResponse(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"xml\":\u00a0XmlResponse()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n</code></pre> <p>Les classes de r\u00e9ponses sont dans le dossier [responses] de l\u2019arborescence du serveur\u00a0:</p> <p></p> <p>Chaque classe de r\u00e9ponse impl\u00e9mente l\u2019interface [InterfaceResponse] suivante\u00a0:</p> <pre><code>from\u00a0abc\u00a0import\u00a0ABC,\u00a0abstractmethod\n\nfrom\u00a0flask.wrappers\u00a0import\u00a0Response\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nclass\u00a0InterfaceResponse(ABC):\n\n\u00a0\u00a0\u00a0\u00a0@abstractmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0build_http_response(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0status_code:\u00a0int,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0(Response,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n</code></pre> <ul> <li>lignes 8-11\u00a0: l\u2019interface [InterfaceResponse] d\u00e9finit une unique m\u00e9thode [build_http_response] ayant les param\u00e8tres suivants\u00a0:</li> <li>[request, session, config]\u00a0: ce sont les param\u00e8tres re\u00e7us par le contr\u00f4leur de l\u2019action\u00a0;</li> <li>[r\u00e9sultat, status_code]\u00a0: ce sont les r\u00e9sultats produits par le contr\u00f4leur de l\u2019action\u00a0; Nous allons pr\u00e9senter la r\u00e9ponse jSON. Elle est produite par la classe [JsonResponse] suivante\u00a0:</li> </ul> <pre><code>import\u00a0json\n\nfrom\u00a0flask\u00a0import\u00a0make_response\nfrom\u00a0flask.wrappers\u00a0import\u00a0Response\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceResponse\u00a0import\u00a0InterfaceResponse\n\nclass\u00a0JsonResponse(InterfaceResponse):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0build_http_response(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0status_code:\u00a0int,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0(Response,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9sultats\u00a0:\u00a0le\u00a0dictionnaire\u00a0des\u00a0r\u00e9sultats\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0status_code\u00a0:\u00a0le\u00a0code\u00a0de\u00a0statut\u00a0de\u00a0la\u00a0r\u00e9ponse\u00a0HTTP\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0r\u00e9ponse\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response\u00a0=\u00a0make_response(json.dumps(r\u00e9sultat,\u00a0ensure_ascii=False))\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response.headers['Content-Type']\u00a0=\u00a0'application/json;\u00a0charset=utf-8'\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0response,\u00a0status_code\n</code></pre> <p>Nous connaissons ce code que nous avons rencontr\u00e9 de nombreuses fois. C\u2019est le code de la fonction [json_response] du module [myutils].</p>"},{"location":"exercice-dapplication-version-12.html#309-premiers-tests","title":"30.9. Premiers tests","text":"<p>Dans le code \u00e9tudi\u00e9, nous avons rencontr\u00e9 trois codes d\u2019\u00e9tat\u00a0:</p> <ul> <li>700\u00a0: /init-session a r\u00e9ussi\u00a0;</li> <li>701\u00a0: /init-session a \u00e9chou\u00e9\u00a0;</li> <li> <p>101\u00a0: requ\u00eate invalide soit parce que la session n\u2019a pas \u00e9t\u00e9 initialis\u00e9e soit parce que l\u2019utilisateur n\u2019est pas authentifi\u00e9\u00a0; Nous allons essayer de les obtenir avec une session jSON.</p> </li> <li> <p>nous lan\u00e7ons le seveur web, le SGBD, le serveur de mails\u00a0;</p> </li> <li>nous lan\u00e7ons un client Postman\u00a0; Test 1</li> </ul> <p>Nous montrons tout d\u2019abord une requ\u00eate invalide parce que la session n\u2019a pas \u00e9t\u00e9 initialis\u00e9\u00a0:</p> <p></p> <ul> <li>[1-2]\u00a0: la requ\u00eate [POST http://localhost:5000/authentifier-utilisateur] est une route valide\u00a0: <pre><code>#\u00a0authentifier-utilisateur\n@app.route('/authentifier-utilisateur',\u00a0methods=['POST'])\ndef\u00a0authentifier_utilisateur()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre></li> </ul> <p>mais elle n\u2019est accept\u00e9e que si la session a \u00e9t\u00e9 initialis\u00e9e auparavant avec l\u2019action [/init-session].</p> <p>Ex\u00e9cutons la requ\u00eate et voyons le r\u00e9sultat envoy\u00e9 par le serveur\u00a0:</p> <p></p> <ul> <li>[1-2]\u00a0: on a obtenu une r\u00e9ponse jSON. Lorsque le type de r\u00e9ponse n\u2019a pas encore \u00e9t\u00e9 fix\u00e9 par le client, le serveur utilise le jSON pour r\u00e9pondre\u00a0;</li> <li>[3-5]\u00a0: le dictionnaire jSON de la r\u00e9ponse\u00a0;</li> <li>[action]\u00a0: l\u2019action qui a \u00e9t\u00e9 ex\u00e9cut\u00e9e\u00a0;</li> <li>[\u00e9tat]\u00a0: le code d\u2019\u00e9tat de la r\u00e9ponse. Un code [x01] indique une erreur\u00a0;</li> <li>[r\u00e9ponse]\u00a0: est adapt\u00e9e \u00e0 chaque action. Ici elle contient un message d\u2019erreur\u00a0; Maintenant initialisons une session avec un type de r\u00e9ponse incorrect\u00a0:</li> </ul> <p></p> <ul> <li>[1-2] est une route correcte\u00a0: <pre><code>#\u00a0init-session\n@app.route('/init-session/&lt;string:type_response&gt;',\u00a0methods=['GET'])\ndef\u00a0init_session(type_response:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre></li> </ul> <p>Elle va donc entrer dans le tunnel de traitement des requ\u00eates du serveur MVC. N\u00e9anmoins elle devrait \u00eatre refus\u00e9e au cours de ce traitement parce que le type de session demand\u00e9 est incorrect.</p> <p>La r\u00e9ponse est la suivante\u00a0:</p> <p></p> <ul> <li>en [4], un code d\u2019erreur [x01]\u00a0;</li> <li>en [5], l\u2019explication de l\u2019erreur\u00a0; Maintenant, initialisons une session jSON\u00a0:</li> </ul> <p></p> <p>La r\u00e9ponse est la suivante\u00a0:</p> <p></p> <p>Maintenant, initialisons une session XML. La r\u00e9ponse jSON va \u00eatre remplac\u00e9e par une r\u00e9ponse XML g\u00e9n\u00e9r\u00e9e par la classe [XmlResponse] suivante\u00a0:</p> <pre><code>import\u00a0xmltodict\nfrom\u00a0flask\u00a0import\u00a0make_response\nfrom\u00a0flask.wrappers\u00a0import\u00a0Response\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceResponse\u00a0import\u00a0InterfaceResponse\nfrom\u00a0Logger\u00a0import\u00a0Logger\n\nclass\u00a0XmlResponse(InterfaceResponse):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0build_http_response(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0status_code:\u00a0int,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0(Response,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9sultats\u00a0:\u00a0le\u00a0dictionnaire\u00a0des\u00a0r\u00e9sultats\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0status_code\u00a0:\u00a0le\u00a0code\u00a0de\u00a0statut\u00a0de\u00a0la\u00a0r\u00e9ponse\u00a0HTTP\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9sultat\u00a0:\u00a0le\u00a0dictionnaire\u00a0\u00e0\u00a0transformer\u00a0en\u00a0cha\u00eene\u00a0XML\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0xml_string\u00a0=\u00a0xmltodict.unparse({\"root\":\u00a0r\u00e9sultat})\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0r\u00e9ponse\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response\u00a0=\u00a0make_response(xml_string)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response.headers['Content-Type']\u00a0=\u00a0'application/xml;\u00a0charset=utf-8'\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0response,\u00a0status_code\n</code></pre> <p>C\u2019est du code que nous connaissons, celui de la fonction [xml_response] du module partag\u00e9 [myutils].</p> <p>Nous initialisons une session XML\u00a0:</p> <p></p> <p>Le r\u00e9sultat du serveur est alors le suivant\u00a0:</p> <p></p> <p>Nous obtenons la m\u00eame r\u00e9ponse qu\u2019en jSON mais cette fois-ci la r\u00e9ponse est habilll\u00e9e en XML.</p>"},{"location":"exercice-dapplication-version-12.html#3010-laction-authentifier-utilisateur","title":"30.10. L\u2019action [authentifier-utilisateur]","text":"<p>L\u2019action [authentifier-utilisateur] permet d\u2019authentifier un utilisateur d\u00e9sirant utiliser l\u2019application de calcul de l\u2019imp\u00f4t. Sa route est d\u00e9finie de la fa\u00e7on suivante\u00a0dans le script [main]\u00a0:</p> <pre><code>#\u00a0authentifier-utilisateur\n@app.route('/authentifier-utilisateur',\u00a0methods=['POST'])\ndef\u00a0authentifier_utilisateur()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre> <p>Le serveur attend deux param\u00e8tres post\u00e9s\u00a0:</p> <ul> <li>[user]\u00a0: l\u2019identifiant de l\u2019utilisateur\u00a0;</li> <li>[password]\u00a0: son mot de passe\u00a0; La liste des utilisateurs autoris\u00e9s est d\u00e9finie dans la configuration [config]\u00a0:</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0utilisateurs\u00a0autoris\u00e9s\u00a0\u00e0\u00a0utiliser\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"users\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"login\":\u00a0\"admin\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"admin\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n</code></pre> <p>Ici, nous avons une liste \u00e0 un \u00e9l\u00e9ment.</p> <p>L\u2019action [authentifier-utilisateur] est trait\u00e9e par le contr\u00f4leur [AuthentifierUtilisateurController] suivant\u00a0:</p> <pre><code>from\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\nfrom\u00a0Logger\u00a0import\u00a0Logger\n\nclass\u00a0AuthentifierUtilisateurController(InterfaceController):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dummy,\u00a0action\u00a0=\u00a0request.path.split('/')\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0param\u00e8tres\u00a0du\u00a0POST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0post_params\u00a0=\u00a0request.form\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0code\u00a0de\u00a0statut\u00a0de\u00a0la\u00a0r\u00e9ponse\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0status_code\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0au\u00a0d\u00e9part\u00a0pas\u00a0d'erreurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreurs\u00a0=\u00a0[]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0il\u00a0faut\u00a0un\u00a0POST\u00a0avec\u00a0deux\u00a0param\u00e8tres\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0len(post_params)\u00a0!=\u00a02:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0status_code\u00a0=\u00a0status.HTTP_400_BAD_REQUEST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreurs.append(\"m\u00e9thode\u00a0POST\u00a0requise,\u00a0param\u00e8tre\u00a0[action]\u00a0dans\u00a0l'URL,\u00a0param\u00e8tres\u00a0post\u00e9s\u00a0[user,\u00a0password]\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0param\u00e8tres\u00a0du\u00a0POST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0param\u00e8tre\u00a0[user]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0user\u00a0=\u00a0post_params.get(\"user\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0user\u00a0is\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreurs.append(\"param\u00e8tre\u00a0[user]\u00a0manquant\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0param\u00e8tre\u00a0[password]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0password\u00a0=\u00a0post_params.get(\"password\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0password\u00a0is\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreurs.append(\"param\u00e8tre\u00a0[password]\u00a0manquant\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0erreur\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0status_code\u00a0=\u00a0status.HTTP_400_BAD_REQUEST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0erreur\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0v\u00e9rifie\u00a0la\u00a0validit\u00e9\u00a0du\u00a0couple\u00a0(user,\u00a0password)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0users\u00a0=\u00a0config['users']\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0i\u00a0=\u00a00\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0nbusers\u00a0=\u00a0len(users)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0trouv\u00e9\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0while\u00a0not\u00a0trouv\u00e9\u00a0and\u00a0i\u00a0&lt;\u00a0nbusers:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0trouv\u00e9\u00a0=\u00a0user\u00a0==\u00a0users[i][\"login\"]\u00a0and\u00a0password\u00a0==\u00a0users[i][\"password\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0i\u00a0+=\u00a01\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0trouv\u00e9\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0trouv\u00e9:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0status_code\u00a0=\u00a0status.HTTP_401_UNAUTHORIZED\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreurs.append(f\"Echec\u00a0de\u00a0l'authentification\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0dans\u00a0la\u00a0session\u00a0qu'on\u00a0a\u00a0trouv\u00e9\u00a0l'utilisateur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0session[\"user\"]\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0c'est\u00a0fini\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0retour\u00a0sans\u00a0erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0200,\u00a0\"r\u00e9ponse\":\u00a0f\"Authentification\u00a0r\u00e9ussie\"}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0r\u00e9sultat,\u00a0status.HTTP_200_OK\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0retour\u00a0avec\u00a0erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0201,\u00a0\"r\u00e9ponse\":\u00a0erreurs},\u00a0status_code\n</code></pre> <ul> <li>ligne 14\u00a0: on r\u00e9cup\u00e8re les param\u00e8tres du POST\u00a0;</li> <li>ligne 19\u00a0: la liste des erreurs trouv\u00e9es dans la requ\u00eate\u00a0;</li> <li>lignes 20-24\u00a0: on v\u00e9rifie qu\u2019il y a bien deux param\u00e8tres post\u00e9s\u00a0;</li> <li>lignes 27-31\u00a0: on v\u00e9rifie la pr\u00e9sence d\u2019un param\u00e8tre [users]\u00a0;</li> <li>lignes 32-36\u00a0: on v\u00e9rifie la pr\u00e9sence d\u2019un param\u00e8tre [password]\u00a0;</li> <li>lignes 38-39\u00a0: si les param\u00e8tres post\u00e9s sont erron\u00e9s, on pr\u00e9pare une r\u00e9ponse HTTP 400 BAD REQUEST\u00a0;</li> <li>lignes 40-58\u00a0: on v\u00e9rifie que les identifiants [user, password] sont ceux d\u2019un utilisateur autoris\u00e9 \u00e0 utiliser l\u2019application\u00a0;</li> <li>lignes 51-55\u00a0: si l\u2019utilisateur (user, password) n\u2019est pas autoris\u00e9 \u00e0 utiliser l\u2019application, on pr\u00e9pare une r\u00e9ponse HTTP 401 UNAUTHORIZED\u00a0;</li> <li>lignes 56-58\u00a0: s\u2019il est autoris\u00e9, alors on note avec la cl\u00e9 [user] dans la session qu\u2019il s\u2019est authentifi\u00e9\u00a0; On notera que si l\u2019utilisateur \u00e9tait authentifi\u00e9 avec les identifiants [identifiants1] et qu\u2019il \u00e9choue \u00e0 s\u2019authentifier avec les identifiants [identifiants2], il reste n\u00e9anmoins authentifi\u00e9 avec les identifiants [identifiants1].</li> </ul> <p>Faisons des tests Postman\u00a0:</p> <ul> <li>on lance le serveur web, le SGBD et le serveur de mails\u00a0;</li> <li>avec le client Postman\u00a0:</li> <li>on d\u00e9marre une session jSON\u00a0;</li> <li>puis on s\u2019authentifie\u00a0; Voil\u00e0 diff\u00e9rents cas.</li> </ul> <p>Cas 1\u00a0: POST sans param\u00e8tres post\u00e9s</p> <p></p> <ul> <li>en [3-5], le POST n\u2019a pas de corps\u00a0; Le r\u00e9sultat de la requ\u00eate est le suivant\u00a0:</li> </ul> <p></p> <ul> <li>en [2], on a eu une r\u00e9ponse HTTP 400 BAD REQUEST\u00a0;</li> <li>en [5], on a eu un code d\u2019erreur [201]\u00a0; Cas 2\u00a0: POST avec identifiants erron\u00e9s</li> </ul> <p></p> <ul> <li>en [6], les identifiants sont erron\u00e9s\u00a0; Le serveur envoie la r\u00e9ponse suivante\u00a0:</li> </ul> <p></p> <ul> <li>en [2], la r\u00e9ponse HTTP 401 UNAUTHORIZED\u00a0;</li> <li>en [5], la r\u00e9ponse d\u2019erreur\u00a0; Cas 2\u00a0: POST avec identifiants corrects</li> </ul> <p></p> <ul> <li> <p>en [6], les identifiants sont corrects\u00a0; La r\u00e9ponse du serveur est la suivante\u00a0:</p> </li> <li> <p>en [2], un r\u00e9ponse HTTP 200 OK\u00a0;</p> </li> </ul> <p></p> <ul> <li>en [5], la r\u00e9ponse de r\u00e9ussite\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-12.html#3011-laction-calculer_impot","title":"30.11. L\u2019action [calculer_impot]","text":"<p>L\u2019action [calculer_impot] permet de calculer l\u2019imp\u00f4t d\u2019un contribuable. Sa route est d\u00e9finie de la fa\u00e7on suivante\u00a0dans le script [main]\u00a0:</p> <pre><code>#\u00a0calculer-impot\n@app.route('/calculer-impot',\u00a0methods=['POST'])\ndef\u00a0calculer_impot()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre> <p>Le serveur attend trois param\u00e8tres post\u00e9s\u00a0:</p> <ul> <li>[mari\u00e9]\u00a0: oui / non\u00a0;</li> <li>[enfants]\u00a0: nombre d\u2019enfants du contribuable\u00a0;</li> <li>[salaire]\u00a0: salaire annuel du contribuable\u00a0; Le contr\u00f4leur [CalculerImpotController] traite l\u2019action [calculer_impot]\u00a0:</li> </ul> <pre><code>import\u00a0re\n\nfrom\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\nfrom\u00a0TaxPayer\u00a0import\u00a0TaxPayer\n\nclass\u00a0CalculerImpotController(InterfaceController):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dummy,\u00a0action\u00a0=\u00a0request.path.split('/')\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pas\u00a0d'erreur\u00a0au\u00a0d\u00e9part\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreurs\u00a0=\u00a0[]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0param\u00e8tres\u00a0du\u00a0POST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0post_params\u00a0=\u00a0request.form\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0il\u00a0faut\u00a0un\u00a0POST\u00a0avec\u00a0trois\u00a0param\u00e8tres\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0len(post_params)\u00a0!=\u00a03:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreurs.append(\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"m\u00e9thode\u00a0POST\u00a0requise\u00a0avec\u00a0les\u00a0param\u00e8tres\u00a0post\u00e9s\u00a0[mari\u00e9,\u00a0enfants,\u00a0salaire]\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0analyse\u00a0les\u00a0param\u00e8tres\u00a0post\u00e9s\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0param\u00e8tre\u00a0mari\u00e9\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mari\u00e9\u00a0=\u00a0post_params.get(\"mari\u00e9\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0mari\u00e9\u00a0is\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreurs.append(\"param\u00e8tre\u00a0[mari\u00e9]\u00a0manquant\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0param\u00e8tre\u00a0est-il\u00a0valide\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mari\u00e9\u00a0=\u00a0mari\u00e9.lower()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0mari\u00e9\u00a0!=\u00a0\"oui\"\u00a0and\u00a0mari\u00e9\u00a0!=\u00a0\"non\":\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreurs.append(f\"valeur\u00a0[{mari\u00e9}]\u00a0invalide\u00a0pour\u00a0le\u00a0param\u00e8tre\u00a0[mari\u00e9\u00a0(oui/non)]\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0param\u00e8tre\u00a0[enfants]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0enfants\u00a0=\u00a0post_params.get(\"enfants\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0enfants\u00a0is\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreurs.append(\"param\u00e8tre\u00a0[enfants]\u00a0manquant\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0param\u00e8tre\u00a0est-il\u00a0valide\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0enfants\u00a0=\u00a0enfants.strip()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0match\u00a0=\u00a0re.match(r\"\\d+\",\u00a0enfants)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0match:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreurs.append(f\"valeur\u00a0[{enfants}]\u00a0invalide\u00a0pour\u00a0le\u00a0param\u00e8tre\u00a0[enfants\u00a0(entier&gt;=0)]\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0param\u00e8tre\u00a0salaire\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0salaire\u00a0=\u00a0post_params.get(\"salaire\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0salaire\u00a0is\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreurs.append(\"param\u00e8tre\u00a0[salaire]\u00a0manquant\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0param\u00e8tre\u00a0est-il\u00a0valide\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0salaire\u00a0=\u00a0salaire.strip()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0match\u00a0=\u00a0re.match(r\"\\d+\",\u00a0salaire)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0match:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreurs.append(f\"valeur\u00a0[{salaire}]\u00a0invalide\u00a0pour\u00a0le\u00a0param\u00e8tre\u00a0[salaire\u00a0(entier&gt;=0)]\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0erreur\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0status_code\u00a0=\u00a0status.HTTP_400_BAD_REQUEST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0301,\u00a0\"r\u00e9ponse\":\u00a0erreurs}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0r\u00e9sultat,\u00a0status_code\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0la\u00a0couche\u00a0[m\u00e9tier]\u00a0et\u00a0le\u00a0dictionnaire\u00a0[adminData]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0m\u00e9tier\u00a0=\u00a0config[\"layers\"][\"m\u00e9tier\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0admin_data\u00a0=\u00a0config[\"admindata\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0taxpayer\u00a0=\u00a0TaxPayer().fromdict({'mari\u00e9':\u00a0mari\u00e9,\u00a0'enfants':\u00a0enfants,\u00a0'salaire':\u00a0salaire})\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0m\u00e9tier.calculate_tax(taxpayer,\u00a0admin_data)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0n\u00b0\u00a0de\u00a0la\u00a0simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0id_simulation\u00a0=\u00a0session.get('id_simulation',\u00a00)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0id_simulation\u00a0+=\u00a01\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0session['id_simulation']\u00a0=\u00a0id_simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0met\u00a0le\u00a0r\u00e9sultat\u00a0en\u00a0session\u00a0ous\u00a0la\u00a0forme\u00a0du\u00a0dictionnaire\u00a0d'un\u00a0TaxPayer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0simulation\u00a0=\u00a0taxpayer.fromdict({'id':\u00a0id_simulation}).asdict()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ajoute\u00a0le\u00a0r\u00e9sultat\u00a0\u00e0\u00a0la\u00a0liste\u00a0des\u00a0simulations\u00a0d\u00e9j\u00e0\u00a0faites\u00a0et\u00a0on\u00a0met\u00a0celle-ci\u00a0en\u00a0session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0simulations\u00a0=\u00a0session.get(\"simulations\",\u00a0[])\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0simulations.append(simulation)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0session[\"simulations\"]\u00a0=\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0300,\u00a0\"r\u00e9ponse\":\u00a0simulation}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0status_code\u00a0=\u00a0status.HTTP_200_OK\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0r\u00e9sultat,\u00a0status_code\n</code></pre> <ul> <li>ligne 13\u00a0: on r\u00e9cup\u00e8re le nom de l\u2019action en cours\u00a0;</li> <li>ligne 17: on va cumuler les erreurs dans une liste\u00a0;</li> <li>ligne 19\u00a0: on r\u00e9cup\u00e8re les param\u00e8tres post\u00e9s. Ceux-ci sont post\u00e9s sous la forme [x-www-form-urlencoded] et c\u2019est pourquoi on les r\u00e9cup\u00e8re dans [request.form]. S\u2019ils avaient \u00e9t\u00e9 post\u00e9s en jSON on les aurait r\u00e9cup\u00e9r\u00e9s dans [request.data]\u00a0;</li> <li>lignes 21-24\u00a0: on v\u00e9rifie qu\u2019il y a bien trois param\u00e8tres post\u00e9s\u00a0;</li> <li>lignes 27-36\u00a0: v\u00e9rification de la pr\u00e9sence et de la validit\u00e9 du param\u00e8tre post\u00e9 [mari\u00e9]\u00a0;</li> <li>lignes 37-48\u00a0: v\u00e9rification de la pr\u00e9sence et de la validit\u00e9 du param\u00e8tre post\u00e9 [enfants]\u00a0;</li> <li>lignes 49-60\u00a0: v\u00e9rification de la pr\u00e9sence et de la validit\u00e9 du param\u00e8tre post\u00e9 [salaire]\u00a0;</li> <li>lignes 62-66\u00a0: s\u2019il y a eu erreur, on envoie une r\u00e9ponse d\u2019erreur 400 BAD REQUEST avec un code d\u2019\u00e9tat [301]\u00a0;</li> <li>lignes 69-71\u00a0: s\u2019il n\u2019y a pas eu erreur, on se pr\u00e9pare \u00e0 calculer l\u2019imp\u00f4t. Pour cela,</li> <li>ligne 70\u00a0: on r\u00e9cup\u00e8re une r\u00e9f\u00e9rence sur la couche [m\u00e9tier]\u00a0;</li> <li>ligne 71\u00a0: on r\u00e9cup\u00e8re les donn\u00e9es de l\u2019administration fiscale dans la configuration du serveur\u00a0;</li> <li>lignes 72-74\u00a0: l\u2019imp\u00f4t du contribuable est calcul\u00e9\u00a0;</li> <li>lignes 75-77\u00a0: on va compter le nombre de calculs d\u2019imp\u00f4t faits par l\u2019utilisateur\u00a0;</li> <li>ligne 76\u00a0: on r\u00e9cup\u00e8re en session, le n\u00b0 du dernier calcul fait. On appelle ici [simulation] le r\u00e9sultat d\u2019un calcul\u00a0;</li> <li>ligne 77\u00a0: on incr\u00e9mente le n\u00b0 de la derni\u00e8re simulation\u00a0;</li> <li>ligne 78\u00a0: on remet ce n\u00b0 en session\u00a0;</li> <li>lignes 79-84\u00a0: pour suivre les calculs faits par l\u2019utilisateur, on va mettre dans sa session, la liste des simulations qu\u2019il a faites\u00a0;</li> <li>ligne 80\u00a0: une simulation sera le dictionnaire d\u2019un objet TaxPayer dont la propri\u00e9t\u00e9 [id] aura pour valeur le n\u00b0 de la simulation\u00a0;</li> <li>lignes 82-84\u00a0: la simulation courante est ajout\u00e9e \u00e0 la liste des simulations pr\u00e9sente en session\u00a0;</li> <li>lignes 86-87\u00a0: on pr\u00e9pare une r\u00e9ponse HTTP de r\u00e9ussite\u00a0;</li> <li>ligne 90\u00a0: on rend le r\u00e9sultat\u00a0; Faisons quelques tests\u00a0: le serveur web, le SGBD, le serveur de mails, un client Postman sont lanc\u00e9s. </li> </ul> <p>Cas 1\u00a0: faire un calcul d\u2019imp\u00f4t alors que la session n\u2019est pas initialis\u00e9e</p> <p></p> <p>La r\u00e9ponse est la suivante\u00a0:</p> <p></p> <p>Cas 2\u00a0: faire un calcul d\u2019imp\u00f4t sans \u00eatre authentifi\u00e9</p> <p>On lance tout d\u2019abord une session jSON avec [/init-session/json]. Puis on fait la m\u00eame requ\u00eate que pr\u00e9c\u00e9demment. La r\u00e9ponse est alors la suivante\u00a0:</p> <p></p> <p>Cas 3\u00a0: faire un calcul d\u2019imp\u00f4t avec des param\u00e8tres manquants</p> <p>On initialise une session jSON, on s\u2019authentifie puis on fait la requ\u00eate suivante\u00a0:</p> <p></p> <ul> <li>en [5], il manque le param\u00e8tre [mari\u00e9]\u00a0; La r\u00e9ponse est la suivante\u00a0:</li> </ul> <p>Cas 4\u00a0: faire un calcul d\u2019imp\u00f4t avec des param\u00e8tres erron\u00e9s </p> <p></p> <p></p> <p>La r\u00e9ponse du serveur est la suivante\u00a0:</p> <p></p> <p>Cas 4\u00a0: faire un calcul d\u2019imp\u00f4t avec des param\u00e8tres corrects</p> <p></p> <p>La r\u00e9ponse du serveur est la suivante\u00a0:</p>"},{"location":"exercice-dapplication-version-12.html#3012-laction-lister-simulations","title":"30.12. L\u2019action [lister-simulations]","text":"<p>L\u2019action [lister-simulations] permet \u00e0 un utilisateur de conna\u00eetre la liste des simulations qu\u2019il a faites depuis le d\u00e9but de la session. Sa route est d\u00e9finie de la fa\u00e7on suivante\u00a0dans le script [main]\u00a0:</p> <pre><code>#\u00a0lister-simulations\n@app.route('/lister-simulations',\u00a0methods=['GET'])\ndef\u00a0lister_simulations()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre> <p>Le serveur n\u2019attend aucun param\u00e8tre. L\u2019action [lister-simulations] est trait\u00e9e par le contr\u00f4leur [ListerSimulationsController] suivant\u00a0:</p> <pre><code>from\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\n\nclass\u00a0ListerSimulationsController(InterfaceController):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dummy,\u00a0action\u00a0=\u00a0request.path.split('/')\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0la\u00a0liste\u00a0des\u00a0simulations\u00a0dans\u00a0la\u00a0session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0simulations\u00a0=\u00a0session.get(\"simulations\",\u00a0[])\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0500,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"r\u00e9ponse\":\u00a0simulations},\u00a0status.HTTP_200_OK\n</code></pre> <ul> <li>ligne 13\u00a0: la liste des simulations est prise dans la session\u00a0;</li> <li> <p>lignes 15-16\u00a0: on retourne une r\u00e9ponse de r\u00e9ussite\u00a0; Faisons le test Postman suivant\u00a0:</p> </li> <li> <p>on lance une session jSON\u00a0;</p> </li> <li>on s\u2019authentifie\u00a0;</li> <li>on fait deux calculs d\u2019imp\u00f4t\u00a0;</li> <li> <p>on demande la liste des simulations\u00a0; La requ\u00eate est la suivante\u00a0:</p> </li> <li> <p>en [3], il n\u2019y a aucun param\u00e8tre\u00a0;</p> </li> </ul> <p></p> <p>La r\u00e9ponse du serveur est la suivante\u00a0:</p> <p></p> <ul> <li>en [4], la liste des simulations de l\u2019utilisateur\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-12.html#3013-laction-supprimer-simulation","title":"30.13. L\u2019action [supprimer-simulation]","text":"<p>L\u2019action [supprimer-simulation] permet \u00e0 un utilisateur de supprimer une des simulations de sa liste de simulations. Sa route est d\u00e9finie de la fa\u00e7on suivante\u00a0dans le script [main]\u00a0:</p> <pre><code>#\u00a0supprimer-simulation\n@app.route('/supprimer-simulation/&lt;int:numero&gt;',\u00a0methods=['GET'])\ndef\u00a0supprimer_simulation(numero:\u00a0int)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre> <p>Le serveur attend un unique param\u00e8tre, le n\u00b0 de la simulation \u00e0 supprimer. L\u2019action [supprimer-simulation] est trait\u00e9e par le contr\u00f4leur [SupprimerSimulationController] suivant\u00a0:</p> <pre><code>from\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\n\nclass\u00a0SupprimerSimulationController(InterfaceController):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dummy,\u00a0action,\u00a0num\u00e9ro\u00a0=\u00a0request.path.split('/')\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0param\u00e8tre\u00a0[num\u00e9ro]\u00a0est\u00a0un\u00a0entier\u00a0positif\u00a0ou\u00a0nul\u00a0d'apr\u00e8s\u00a0sa\u00a0route\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0num\u00e9ro\u00a0=\u00a0int(num\u00e9ro)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0simulation\u00a0id=num\u00e9ro\u00a0doit\u00a0exister\u00a0dans\u00a0la\u00a0liste\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0simulations\u00a0=\u00a0session.get(\"simulations\",\u00a0[])\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0liste_simulations\u00a0=\u00a0list(filter(lambda\u00a0simulation:\u00a0simulation['id']\u00a0==\u00a0num\u00e9ro,\u00a0simulations))\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0liste_simulations:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0msg_erreur\u00a0=\u00a0f\"la\u00a0simulation\u00a0n\u00b0\u00a0[{num\u00e9ro}]\u00a0n'existe\u00a0pas\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0601,\u00a0\"r\u00e9ponse\":\u00a0[msg_erreur]},\u00a0status.HTTP_400_BAD_REQUEST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0suppression\u00a0de\u00a0la\u00a0simulation\u00a0id=num\u00e9ro\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0simulation\u00a0=\u00a0liste_simulations.pop(0)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0simulations.remove(simulation)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0remet\u00a0les\u00a0simulations\u00a0dans\u00a0la\u00a0session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0session[\"simulations\"]\u00a0=\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0600,\u00a0\"r\u00e9ponse\":\u00a0simulations},\u00a0status.HTTP_200_OK\n</code></pre> <ul> <li>ligne 10\u00a0: on r\u00e9cup\u00e8re les deux \u00e9l\u00e9ments du chemin de la requ\u00eate. On les r\u00e9cup\u00e8re en temps que cha\u00eene de caract\u00e8res\u00a0;</li> <li>ligne 13\u00a0: le param\u00e8tre [num\u00e9ro] est transform\u00e9 en entier. On sait que c\u2019est possible \u00e0 cause de la signature de sa route,  <pre><code>@app.route('/supprimer-simulation/&lt;int:numero&gt;',\u00a0methods=['GET'])\n</code></pre></li> </ul> <p>On sait de plus que c\u2019est un entier &gt;=0. On ne peut pas en effet avoir une URL [/supprimer-simulation/-4]. Celle-ci est refus\u00e9e par le serveur Flask\u00a0;</p> <ul> <li>ligne 15\u00a0: on r\u00e9cup\u00e8re la liste des simulations dans la session\u00a0;</li> <li>ligne 16\u00a0: avec la fonction [filter], on cherche la simulation ayant id==num\u00e9ro. On obtient un objet [filter] qu\u2019on convertit en type [list]\u00a0;</li> <li>lignes 17-20\u00a0: si le filtre n\u2019a rien ramen\u00e9, alors c\u2019est que la simulation \u00e0 supprimer n\u2019existe pas. On rend une r\u00e9ponse d\u2019erreur qui l\u2019indique\u00a0;</li> <li>lignes 21-23\u00a0: on supprime la simulation ramen\u00e9e par le filtre\u00a0;</li> <li>ligne 25\u00a0: on remet la nouvelle liste de simulations en session\u00a0;</li> <li>ligne 27\u00a0: on rend dans la r\u00e9ponse, la nouvelle liste de simulations\u00a0; Nous faisons un test de r\u00e9ussite et un test d\u2019\u00e9chec. On fait des simulations puis on demande la liste des simulations\u00a0:</li> </ul> <p></p> <ul> <li>les simulations ont ici les n\u00b0s 2 et 3\u00a0; On demande \u00e0 supprimer la simulation ayant le n\u00b0 3.</li> </ul> <p></p> <p>La r\u00e9ponse est la suivante\u00a0:</p> <p>Maintenant, recommen\u00e7ons la m\u00eame op\u00e9ration (suppression de la simulation d\u2019id=3). La r\u00e9ponse est alors la suivante\u00a0:</p> <p></p>"},{"location":"exercice-dapplication-version-12.html#3014-laction-fin-session","title":"30.14. L\u2019action [fin-session]","text":"<p>L\u2019action [fin-session] permet \u00e0 un utilisateur de terminer sa session de simulations. Sa route est d\u00e9finie de la fa\u00e7on suivante\u00a0dans le script [main]\u00a0:</p> <pre><code>#\u00a0fin-session\n@app.route('/fin-session',\u00a0methods=['GET'])\ndef\u00a0fin_session()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre> <p>Le serveur n\u2019attend aucun param\u00e8tre. L\u2019action est trait\u00e9e par le contr\u00f4leur [FinSessionController] suivant\u00a0:</p> <pre><code>from\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\n\nclass\u00a0FinSessionController(InterfaceController):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dummy,\u00a0action\u00a0=\u00a0request.path.split('/')\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0supprime\u00a0toutes\u00a0les\u00a0cl\u00e9s\u00a0la\u00a0session\u00a0courante\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0session.clear()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0400,\u00a0\"r\u00e9ponse\":\u00a0\"session\u00a0r\u00e9initialis\u00e9e\"},\u00a0status.HTTP_200_OK\n</code></pre> <ul> <li>ligne 13\u00a0: on supprime toutes les cl\u00e9s de la session. Cela supprime\u00a0:</li> <li>[typeResponse]\u00a0: le type des r\u00e9ponses HTTP (json, xml, html)\u00a0;</li> <li>[id_simulation]\u00a0: n\u00b0 de la derni\u00e8re simulation faite\u00a0;</li> <li>[simulations]\u00a0: la liste des simulations de l\u2019utilisateur\u00a0;</li> <li>[user]\u00a0: l\u2019indicateur que l\u2019utilisateur a \u00e9t\u00e9 authentifi\u00e9\u00a0;</li> <li>on rend la r\u00e9ponse\u00a0; On peut se demander comment va \u00eatre rendue la r\u00e9ponse HTTP de la ligne 15, maintenant que le type de r\u00e9ponse n\u2019est plus dans la session. Pour le savoir, il faut revenir \u00e0 la fonction |front_controller| du script principal [main]\u00a0et la modifier de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code>\u2026\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n        \u00a0#\u00a0on\u00a0note\u00a0le\u00a0type\u00a0de\u00a0r\u00e9ponse\u00a0souhait\u00e9\u00a0si\u00a0cette\u00a0information\u00a0est\u00a0dans\u00a0la\u00a0session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response1\u00a0=\u00a0session.get('typeResponse',\u00a0None)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fait\u00a0suivre\u00a0la\u00a0requ\u00eate\u00a0au\u00a0contr\u00f4leur\u00a0principal\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0main_controller\u00a0=\u00a0config['controllers'][\"main-controller\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat,\u00a0status_code\u00a0=\u00a0main_controller.execute(request,\u00a0session,\u00a0config)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0logue\u00a0le\u00a0r\u00e9sultat\u00a0envoy\u00e9\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0log\u00a0=\u00a0f\"[front_controller]\u00a0{r\u00e9sultat}\\n\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(log)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0y-a-t-il\u00a0eu\u00a0une\u00a0erreur\u00a0fatale\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0status_code\u00a0==\u00a0status.HTTP_500_INTERNAL_SERVER_ERROR:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0un\u00a0mail\u00a0\u00e0\u00a0l'administrateur\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0send_adminmail(config,\u00a0log)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0d\u00e9termine\u00a0le\u00a0type\u00a0souhait\u00e9\u00a0pour\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response2=session.get('typeResponse')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0\u00a0type_response2\u00a0is\u00a0None\u00a0and\u00a0type_response1\u00a0is\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0type\u00a0de\u00a0session\u00a0n'a\u00a0pas\u00a0encore\u00a0\u00e9t\u00e9\u00a0\u00e9tabli\u00a0-\u00a0ce\u00a0sera\u00a0du\u00a0jSON\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response\u00a0=\u00a0'json'\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0elif\u00a0type_response2\u00a0is\u00a0not\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0type\u00a0de\u00a0la\u00a0r\u00e9ponse\u00a0est\u00a0connu\u00a0et\u00a0dans\u00a0la\u00a0session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response\u00a0=\u00a0type_response2\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response=type_response1\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0construit\u00a0la\u00a0r\u00e9ponse\u00a0\u00e0\u00a0envoyer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response_builder\u00a0=\u00a0config[\"responses\"][type_response]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response,\u00a0status_code\u00a0=\u00a0response_builder\u00a0\\\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0.build_http_response(request,\u00a0session,\u00a0config,\u00a0status_code,\u00a0r\u00e9sultat)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0response,\u00a0status_code\n</code></pre> <ul> <li>ligne 3\u00a0: le type de la r\u00e9ponse actuellement en session est m\u00e9moris\u00e9\u00a0;</li> <li>ligne 6\u00a0: l\u2019action est ex\u00e9cut\u00e9e. S\u2019il s\u2019agit de\u00a0:</li> <li>[fin-session], la cl\u00e9 [typeResponse] n\u2019est alors plus dans la session\u00a0;</li> <li>[init-session], la cl\u00e9 [typeResponse] de la session\u00a0a pu changer de valeur\u00a0;;</li> <li>lignes 14-20\u00a0: on doit \u00e9mettre la r\u00e9ponse HTTP. Il nous faut savoir sous quelle forme\u00a0:</li> <li>lignes 16-18\u00a0: si le type de la r\u00e9ponse n\u2019est d\u00e9finie ni par [type_response1] de la ligne 3, ni par [type_response2] de la ligne 15, alors le type de r\u00e9ponse n\u2019\u00e9tait d\u00e9fini ni avant ni apr\u00e8s l\u2019action. On utilise alors du jSON (ligne 18)\u00a0;</li> <li>lignes 19-21\u00a0: si [type_response2] existe, le type dans la session apr\u00e8s l\u2019action, alors c\u2019est ce type qu\u2019il faut utiliser\u00a0;</li> <li>lignes 22-23\u00a0: sinon c\u2019est [type_response1], le type de r\u00e9ponse avant l\u2019action (celle-ci est forc\u00e9ment [fin-session]) qu\u2019il faut utiliser\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-12.html#3015-laction-get-admindata","title":"30.15. L\u2019action [get-admindata]","text":"<p>Nous abordons maintenant les deux URL r\u00e9serv\u00e9es aux services jSON et XML\u00a0:</p> <p>Action</p><p>R\u00f4le</p><p>Contexte d\u2019ex\u00e9cution</p><p>/get-admindata</p><p>Rend les donn\u00e9es fiscales permettant le calcul de l\u2019imp\u00f4t</p><p>Requ\u00eate GET.</p><p>N\u2019est utilis\u00e9e que si le type de la session est json ou xml. L\u2019utilisateur doit \u00eatre authentifi\u00e9</p><p>/calculer-impots</p><p>Fait le calcul de l\u2019imp\u00f4t d\u2019une liste de contribuables post\u00e9s en jSON</p><p>Requ\u00eate GET.</p><p>N\u2019est utilis\u00e9e que si le type de la session est json ou xml. L\u2019utilisateur doit \u00eatre authentifi\u00e9</p> <p>L\u2019URL [/get-admindata] est d\u00e9finie dans les routes du script principal [main] de la fa\u00e7on suivante\u00a0:</p> <pre><code>#\u00a0get-admindata\n@app.route('/get-admindata',\u00a0methods=['GET'])\ndef\u00a0get_admindata()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre> <p>La route [/get-admindata] est trait\u00e9e par le contr\u00f4leur [GetAdminDataController] suivant\u00a0:</p> <pre><code>#\u00a0import\u00a0des\u00a0d\u00e9pendances\n\nfrom\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\n\nclass\u00a0GetAdminDataController(InterfaceController):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dummy,\u00a0action\u00a0=\u00a0request.path.split('/')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0seules\u00a0les\u00a0sessions\u00a0json\u00a0et\u00a0xml\u00a0sont\u00a0accept\u00e9es\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response\u00a0=\u00a0session.get('typeResponse')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0type_response\u00a0!=\u00a0'json'\u00a0and\u00a0type_response\u00a0!=\u00a0'xml':\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0une\u00a0r\u00e9ponse\u00a0d'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"action\":\u00a0action,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tat\":\u00a01001,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"r\u00e9ponse\":\u00a0[\"cette\u00a0action\u00a0n'est\u00a0possible\u00a0que\u00a0pour\u00a0les\u00a0sessions\u00a0json\u00a0ou\u00a0xml\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\u00a0status.HTTP_400_BAD_REQUEST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0une\u00a0r\u00e9ponse\u00a0de\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a01000,\u00a0\"r\u00e9ponse\":\u00a0config[\"adminData\"].asdict()},\u00a0status.HTTP_200_OK\n</code></pre> <ul> <li>lignes 13-21\u00a0: on v\u00e9rifie qu\u2019on est dans une session json ou xml\u00a0;</li> <li>ligne 24\u00a0: on rend le dictionnaire des donn\u00e9es de l\u2019administration fiscale qui d\u00e8s le d\u00e9marrage du serveur avaient \u00e9t\u00e9 plac\u00e9es dans la configuration\u00a0: <pre><code>\u00a0\u00a0\u00a0\u00a0#\u00a0admindata\u00a0sera\u00a0une\u00a0donn\u00e9e\u00a0de\u00a0port\u00e9e\u00a0application\u00a0en\u00a0lecture\u00a0seule\n\u00a0\u00a0\u00a0\u00a0config[\"admindata\"]\u00a0=\u00a0config[\"layers\"][\"dao\"].get_admindata()\n</code></pre></li> </ul> <p>Prenons un client Postman et demandons l\u2019URL [/get-admindata], apr\u00e8s avoir d\u00e9marr\u00e9 une session jSON et s\u2019\u00eatre authentifi\u00e9\u00a0:</p> <p></p> <p>La r\u00e9ponse du serveur est la suivante\u00a0:</p> <p></p>"},{"location":"exercice-dapplication-version-12.html#3016-laction-calculer-impots","title":"30.16. L\u2019action [calculer-impots]","text":"<p>L\u2019action [calculer-impots] calcule l\u2019imp\u00f4ts d\u2019une liste de contribuables trouv\u00e9e dans le corps de la requ\u00eate sous la forme d\u2019une cha\u00eene jSON. Nous connaissons d\u00e9j\u00e0 cette action\u00a0: elle s\u2019appelait [calculate_tax_in_bulk_mode] dans la version pr\u00e9c\u00e9dente.</p> <p>Sa route est la suivante\u00a0:</p> <pre><code>#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0par\u00a0lots\n@app.route('/calculer-impots',\u00a0methods=['POST'])\ndef\u00a0calculer_impots():\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre> <p>Cette action est trait\u00e9e par le contr\u00f4leur [CalculerImpotsController] suivant\u00a0:</p> <pre><code>import\u00a0json\n\nfrom\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0Imp\u00f4tsError\u00a0import\u00a0Imp\u00f4tsError\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\nfrom\u00a0TaxPayer\u00a0import\u00a0TaxPayer\n\nclass\u00a0CalculerImpotsController(InterfaceController):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dummy,\u00a0action\u00a0=\u00a0request.path.split('/')\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0seules\u00a0les\u00a0sessions\u00a0json\u00a0et\u00a0xml\u00a0sont\u00a0accept\u00e9es\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response\u00a0=\u00a0session.get('typeResponse')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0type_response\u00a0!=\u00a0'json'\u00a0and\u00a0type_response\u00a0!=\u00a0'xml':\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0une\u00a0r\u00e9ponse\u00a0d'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"action\":\u00a0action,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tat\":\u00a01501,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"r\u00e9ponse\":\u00a0[\"cette\u00a0action\u00a0n'est\u00a0possible\u00a0que\u00a0pour\u00a0les\u00a0sessions\u00a0json\u00a0ou\u00a0xml\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\u00a0status.HTTP_400_BAD_REQUEST\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0le\u00a0corps\u00a0du\u00a0post\u00a0-\u00a0on\u00a0attend\u00a0une\u00a0liste\u00a0de\u00a0dictionnaires\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0msg_erreur\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0list_dict_taxpayers\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0corps\u00a0jSON\u00a0du\u00a0POST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0request_text\u00a0=\u00a0request.data\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0qu'on\u00a0transforme\u00a0en\u00a0une\u00a0liste\u00a0de\u00a0dictionnaires\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0list_dict_taxpayers\u00a0=\u00a0json.loads(request_text)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0except\u00a0BaseException\u00a0as\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0msg_erreur\u00a0=\u00a0f\"le\u00a0corps\u00a0du\u00a0POST\u00a0n'est\u00a0pas\u00a0une\u00a0cha\u00eene\u00a0jSON\u00a0valide\u00a0:\u00a0{erreur}\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0a-t-on\u00a0une\u00a0liste\u00a0non\u00a0vide\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0msg_erreur\u00a0and\u00a0(not\u00a0isinstance(list_dict_taxpayers,\u00a0list)\u00a0or\u00a0len(list_dict_taxpayers)\u00a0==\u00a00):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0msg_erreur\u00a0=\u00a0\"le\u00a0corps\u00a0du\u00a0POST\u00a0n'est\u00a0pas\u00a0une\u00a0liste\u00a0ou\u00a0alors\u00a0cette\u00a0liste\u00a0est\u00a0vide\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0a-t-on\u00a0une\u00a0liste\u00a0de\u00a0dictionnaires\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0msg_erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0i\u00a0=\u00a00\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0while\u00a0not\u00a0erreur\u00a0and\u00a0i\u00a0&lt;\u00a0len(list_dict_taxpayers):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0not\u00a0isinstance(list_dict_taxpayers[i],\u00a0dict)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0i\u00a0+=\u00a01\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0erreur\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0msg_erreur\u00a0=\u00a0\"le\u00a0corps\u00a0du\u00a0POST\u00a0doit\u00a0\u00eatre\u00a0une\u00a0liste\u00a0de\u00a0dictionnaires\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0erreur\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0msg_erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0une\u00a0r\u00e9ponse\u00a0d'erreur\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultats\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a01501,\u00a0\"r\u00e9ponse\":\u00a0[msg_erreur]}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0r\u00e9sultats,\u00a0status.HTTP_400_BAD_REQUEST\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0v\u00e9rifie\u00a0les\u00a0TaxPayers\u00a0un\u00a0par\u00a0un\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0au\u00a0d\u00e9part\u00a0pas\u00a0d'erreurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0list_erreurs\u00a0=\u00a0[]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for\u00a0dict_taxpayer\u00a0in\u00a0list_dict_taxpayers:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0cr\u00e9e\u00a0un\u00a0TaxPayer\u00a0\u00e0\u00a0partir\u00a0de\u00a0dict_taxpayer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0msg_erreur\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0l'op\u00e9ration\u00a0suivante\u00a0va\u00a0\u00e9liminer\u00a0les\u00a0cas\u00a0o\u00f9\u00a0les\u00a0param\u00e8tres\u00a0ne\u00a0sont\u00a0pas\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0des\u00a0propri\u00e9t\u00e9s\u00a0de\u00a0la\u00a0classe\u00a0TaxPayer\u00a0ainsi\u00a0que\u00a0les\u00a0cas\u00a0o\u00f9\u00a0leurs\u00a0valeurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0sont\u00a0incorrectes\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0TaxPayer().fromdict(dict_taxpayer)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0except\u00a0BaseException\u00a0as\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0msg_erreur\u00a0=\u00a0f\"{erreur}\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0certaines\u00a0cl\u00e9s\u00a0doivent\u00a0\u00eatre\u00a0pr\u00e9sentes\u00a0dans\u00a0le\u00a0dictionnaire\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0msg_erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0cl\u00e9s\u00a0[mari\u00e9,\u00a0enfants,\u00a0salaire]\u00a0doivent\u00a0\u00eatre\u00a0pr\u00e9sentes\u00a0dans\u00a0le\u00a0dictionnaire\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0keys\u00a0=\u00a0dict_taxpayer.keys()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0'mari\u00e9'\u00a0not\u00a0in\u00a0keys\u00a0or\u00a0'enfants'\u00a0not\u00a0in\u00a0keys\u00a0or\u00a0'salaire'\u00a0not\u00a0in\u00a0keys:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0msg_erreur\u00a0=\u00a0\"le\u00a0dictionnaire\u00a0doit\u00a0inclure\u00a0les\u00a0cl\u00e9s\u00a0[mari\u00e9,\u00a0enfants,\u00a0salaire]\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0des\u00a0erreurs\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0msg_erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\u00a0dans\u00a0le\u00a0TaxPayer\u00a0lui-m\u00eame\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dict_taxpayer['erreur']\u00a0=\u00a0msg_erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ajoute\u00a0le\u00a0TaxPayer\u00a0\u00e0\u00a0la\u00a0liste\u00a0des\u00a0erreurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0list_erreurs.append(dict_taxpayer)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0a\u00a0trait\u00e9\u00a0tous\u00a0les\u00a0taxpayers\u00a0-\u00a0y-a-t-il\u00a0des\u00a0erreurs\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0list_erreurs:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0une\u00a0r\u00e9ponse\u00a0d'erreur\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultats\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a01501,\u00a0\"r\u00e9ponse\":\u00a0list_erreurs}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0r\u00e9sultats,\u00a0status.HTTP_400_BAD_REQUEST\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pas\u00a0d'erreurs,\u00a0on\u00a0peut\u00a0travailler\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9cup\u00e9ration\u00a0des\u00a0donn\u00e9es\u00a0de\u00a0l'administration\u00a0fiscale\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0admindata\u00a0=\u00a0config[\"admindata\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0m\u00e9tier\u00a0=\u00a0config[\"layers\"][\"m\u00e9tier\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0traite\u00a0les\u00a0TaxPayer\u00a0un\u00a0\u00e0\u00a0un\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0list_taxpayers\u00a0=\u00a0[]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for\u00a0dict_taxpayer\u00a0in\u00a0list_dict_taxpayers:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0taxpayer\u00a0=\u00a0TaxPayer().fromdict(\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{'mari\u00e9':\u00a0dict_taxpayer['mari\u00e9'],\u00a0'enfants':\u00a0dict_taxpayer['enfants'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0'salaire':\u00a0dict_taxpayer['salaire']})\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0m\u00e9tier.calculate_tax(taxpayer,\u00a0admindata)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0m\u00e9morise\u00a0le\u00a0r\u00e9sultat\u00a0en\u00a0tant\u00a0que\u00a0dictionnaire\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0list_taxpayers.append(taxpayer.asdict())\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ajoute\u00a0list_taxpayers\u00a0aux\u00a0simulations\u00a0actuelles\u00a0en\u00a0donnant\u00a0\u00e0\u00a0chaque\u00a0simulation\u00a0un\u00a0n\u00b0\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0simulations\u00a0=\u00a0session.get(\"simulations\",\u00a0[])\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0id_simulation\u00a0=\u00a0session.get(\"id_simulation\",\u00a00)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for\u00a0simulation\u00a0in\u00a0list_taxpayers:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0donne\u00a0un\u00a0n\u00b0\u00a0\u00e0\u00a0chaque\u00a0simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0id_simulation\u00a0+=\u00a01\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0simulation['id']\u00a0=\u00a0id_simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0l'ajoute\u00a0\u00e0\u00a0la\u00a0liste\u00a0actuelle\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0simulations.append(simulation)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0remet\u00a0le\u00a0tout\u00a0en\u00a0session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0session[\"simulations\"]\u00a0=\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0session[\"id_simulation\"]\u00a0=\u00a0id_simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0la\u00a0r\u00e9ponse\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a01500,\u00a0\"r\u00e9ponse\":\u00a0list_taxpayers},\u00a0status.HTTP_200_OK\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0except\u00a0Imp\u00f4tsError\u00a0as\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0une\u00a0r\u00e9ponse\u00a0d'erreur\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a01501,\u00a0\"r\u00e9ponse\":\u00a0[f\"{erreur}\"]},\u00a0status.HTTP_500_INTERNAL_SERVER_ERROR\n</code></pre> <ul> <li>lignes 16-24\u00a0: on v\u00e9rifie qu\u2019on est bien dans une session json ou xml</li> <li>lignes 26-120\u00a0: ce code nous est globalement connu. C\u2019est celui de la fonction |index_controller| de la version 10 de l\u2019application\u00a0qui a \u00e9t\u00e9 am\u00e9nag\u00e9 pour r\u00e9pondre aux sp\u00e9cifications de l\u2019interface [InterfaceController] impl\u00e9ment\u00e9e\u00a0;</li> <li>lignes 104-115\u00a0: le code ajout\u00e9 pour tenir compte du nouvel environnement de ce contr\u00f4leur. On vient de faire des calculs d\u2019imp\u00f4t. Il nous faut m\u00e9moriser les r\u00e9sultats dans la liste des simulations maintenues en session\u00a0;</li> <li>ligne 105\u00a0: on r\u00e9cup\u00e8re la liste des simulations en session\u00a0;</li> <li>ligne 106\u00a0: on r\u00e9cup\u00e8re le n\u00b0 de la derni\u00e8re simulation faite\u00a0;</li> <li>lignes 107-112\u00a0: on parcourt la liste des dictionnaires des r\u00e9sultats du calcul de l\u2019imp\u00f4t, \u00e0 chacun d\u2019eux on attribue un n\u00b0 [id] de simulation\u00a0et chaque dictionnaire est ajout\u00e9 \u00e0 la liste des simulations\u00a0;</li> <li>lignes 113-115\u00a0: la nouvelle liste des simulations ainsi que le n\u00b0 de la derni\u00e8re simulation faite sont remis en session\u00a0; Nous faisons le test Postman suivant, apr\u00e8s avoir initialis\u00e9 une session jSON et s\u2019\u00eatre authentifi\u00e9\u00a0:</li> </ul> <p></p> <p></p> <p>La r\u00e9ponse du serveur est la suivante\u00a0:</p> <p></p> <p>Si maintenant, on demande la liste des simulations\u00a0:</p> <p>On remarquera que dans la liste r\u00e9sultat de [/calcul-impots], les contribuables n\u2019ont pas d\u2019attribut [id] alors que dans la liste des simulations, chaque simulation a un n\u00b0 qui l\u2019identifie.</p> <p></p>"},{"location":"exercice-dapplication-version-13.html","title":"33. Exercice d\u2019application\u00a0: version 13","text":"<p>La version 13 modifie la version 12 sur les points suivants\u00a0:</p> <ul> <li>on restructure certaines parties du code (refactoring)\u00a0;</li> <li>on g\u00e8re la session diff\u00e9remment \u00e0 l\u2019aide du module [flask_session]\u00a0;</li> <li>on utilise des mots de passe crypt\u00e9s dans le fichier de configuration\u00a0; La version 13 est obtenue initialement par recopie de la version 12\u00a0:</li> </ul> <p></p> <p></p> <ul> <li>en [1], la configuration va \u00eatre refactoris\u00e9e. On la sort notamment du dossier [flask]\u00a0;</li> <li>en [2], le script principal va \u00eatre refactoris\u00e9. On le sort \u00e9galement du dossier [flask]\u00a0;</li> <li>en [3], la configuration va \u00eatre \u00e9clat\u00e9e sur plusieurs fichiers\u00a0;</li> <li>en [4]\u00a0: on va simplifier le script principal [main] en d\u00e9portant du code sur d\u2019autres fichiers\u00a0;</li> <li>en [5], le contr\u00f4leur d\u2019authentification va \u00eatre modifi\u00e9 puisque d\u00e9sormais les mots de passe des utilisateurs seront crypt\u00e9s\u00a0;</li> <li>en [6], le contr\u00f4leur principal va int\u00e9grer du code pr\u00e9c\u00e9demment pr\u00e9sent dans le script principal [main]\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-13.html#331-refactorisation-de-la-configuration-de-lapplication","title":"33.1. Refactorisation de la configuration de l\u2019application","text":"<p>Trois nouveaux fichiers de configuration apparaissent\u00a0:</p> <ul> <li>[mvc]\u00a0: pour param\u00e9trer l\u2019architecture MVC de l\u2019application\u00a0;</li> <li>[parameters]\u00a0: qui va rassembler toutes les constantes de l\u2019application\u00a0;</li> <li>[syspath]\u00a0: qui configure le Python Path de l\u2019application\u00a0; Le fichier [syspath.py] est le suivant\u00a0:</li> </ul> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0de\u00a0ce\u00a0fichier\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0racine\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020\"\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossiers\u00a0du\u00a0projet\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0BaseEntity,\u00a0MyException\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/classes/02/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0InterfaceImp\u00f4tsDao,\u00a0InterfaceImp\u00f4tsM\u00e9tier,\u00a0InterfaceImp\u00f4tsUi\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AbstractImp\u00f4tsdao,\u00a0Imp\u00f4tsConsole,\u00a0Imp\u00f4tsM\u00e9tier\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ImpotsDaoWithAdminDataInDatabase\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AdminData,\u00a0Imp\u00f4tsError,\u00a0TaxPayer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Constantes,\u00a0tranches\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Logger,\u00a0SendAdminMail\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/http-servers/02/utilities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0du\u00a0script\u00a0principal\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0script_dir,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0configs\u00a0[database,\u00a0layers,\u00a0parameters,\u00a0controllers,\u00a0views]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../configs\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0contr\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../controllers\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9ponses\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../responses\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mod\u00e8les\u00a0des\u00a0vues\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../models_for_views\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fixe\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0return\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"root_dir\":\u00a0root_dir,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"script_dir\":\u00a0script_dir\n\u00a0\u00a0\u00a0\u00a0}\n</code></pre> <ul> <li>le script [syspath] sert \u00e0 configurer le Python Path de l\u2019application (lignes 40-41)\u00a0;</li> <li>il rend deux informations utiles aux autres scripts de configuration (lignes 45-46)\u00a0; Le script [mvc] configure l\u2019architecture MVC de l\u2019application web\u00a0jSON / XML / HTML\u00a0:</li> </ul> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\u00a0MVC\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0contr\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0from\u00a0AfficherCalculImpotController\u00a0import\u00a0AfficherCalculImpotController\n\u00a0\u00a0\u00a0\u00a0from\u00a0AuthentifierUtilisateurController\u00a0import\u00a0AuthentifierUtilisateurController\n\u00a0\u00a0\u00a0\u00a0from\u00a0CalculerImpotController\u00a0import\u00a0CalculerImpotController\n\u00a0\u00a0\u00a0\u00a0from\u00a0CalculerImpotsController\u00a0import\u00a0CalculerImpotsController\n\u00a0\u00a0\u00a0\u00a0from\u00a0FinSessionController\u00a0import\u00a0FinSessionController\n\u00a0\u00a0\u00a0\u00a0from\u00a0GetAdminDataController\u00a0import\u00a0GetAdminDataController\n\u00a0\u00a0\u00a0\u00a0from\u00a0InitSessionController\u00a0import\u00a0InitSessionController\n\u00a0\u00a0\u00a0\u00a0from\u00a0ListerSimulationsController\u00a0import\u00a0ListerSimulationsController\n\u00a0\u00a0\u00a0\u00a0from\u00a0MainController\u00a0import\u00a0MainController\n\u00a0\u00a0\u00a0\u00a0from\u00a0SupprimerSimulationController\u00a0import\u00a0SupprimerSimulationController\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0r\u00e9ponses\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0from\u00a0HtmlResponse\u00a0import\u00a0HtmlResponse\n\u00a0\u00a0\u00a0\u00a0from\u00a0JsonResponse\u00a0import\u00a0JsonResponse\n\u00a0\u00a0\u00a0\u00a0from\u00a0XmlResponse\u00a0import\u00a0XmlResponse\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0mod\u00e8les\u00a0des\u00a0vues\n\u00a0\u00a0\u00a0\u00a0from\u00a0ModelForAuthentificationView\u00a0import\u00a0ModelForAuthentificationView\n\u00a0\u00a0\u00a0\u00a0from\u00a0ModelForCalculImpotView\u00a0import\u00a0ModelForCalculImpotView\n\u00a0\u00a0\u00a0\u00a0from\u00a0ModelForErreursView\u00a0import\u00a0ModelForErreursView\n\u00a0\u00a0\u00a0\u00a0from\u00a0ModelForListeSimulationsView\u00a0import\u00a0ModelForListeSimulationsView\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0autoris\u00e9es\u00a0et\u00a0leurs\u00a0contr\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0controllers\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0initialisation\u00a0d'une\u00a0session\u00a0de\u00a0calcul\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"init-session\":\u00a0InitSessionController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0authentification\u00a0d'un\u00a0utilisateur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"authentifier-utilisateur\":\u00a0AuthentifierUtilisateurController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0en\u00a0mode\u00a0individuel\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"calculer-impot\":\u00a0CalculerImpotController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0en\u00a0mode\u00a0lots\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"calculer-impots\":\u00a0CalculerImpotsController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0liste\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"lister-simulations\":\u00a0ListerSimulationsController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0suppression\u00a0d'une\u00a0simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"supprimer-simulation\":\u00a0SupprimerSimulationController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fin\u00a0de\u00a0la\u00a0session\u00a0de\u00a0calcul\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"fin-session\":\u00a0FinSessionController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0de\u00a0la\u00a0vue\u00a0de\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"afficher-calcul-impot\":\u00a0AfficherCalculImpotController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0obtention\u00a0des\u00a0donn\u00e9es\u00a0de\u00a0l'administration\u00a0fiscale\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"get-admindata\":\u00a0GetAdminDataController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0main\u00a0controller\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"main-controller\":\u00a0MainController()\n\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0diff\u00e9rents\u00a0types\u00a0de\u00a0r\u00e9ponse\u00a0(json,\u00a0xml,\u00a0html)\n\u00a0\u00a0\u00a0\u00a0responses\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"json\":\u00a0JsonResponse(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"html\":\u00a0HtmlResponse(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"xml\":\u00a0XmlResponse()\n\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0vues\u00a0HTML\u00a0et\u00a0leurs\u00a0mod\u00e8les\u00a0d\u00e9pendent\u00a0de\u00a0l'\u00e9tat\u00a0rendu\u00a0par\u00a0le\u00a0contr\u00f4leur\n\u00a0\u00a0\u00a0\u00a0views\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0d'authentification\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0700,\u00a0\u00a0\u00a0\u00a0#\u00a0/init-session\u00a0-\u00a0succ\u00e8s\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0201,\u00a0\u00a0\u00a0\u00a0#\u00a0/authentifier-utilisateur\u00a0\u00e9chec\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-authentification.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForAuthentificationView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0200,\u00a0\u00a0\u00a0\u00a0#\u00a0/authentifier-utilisateur\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0300,\u00a0\u00a0\u00a0\u00a0#\u00a0/calculer-impot\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0301,\u00a0\u00a0\u00a0\u00a0#\u00a0/calculer-impot\u00a0\u00e9chec\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0800,\u00a0\u00a0\u00a0\u00a0#\u00a0/afficher-calcul-impot\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-calcul-impot.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForCalculImpotView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0de\u00a0la\u00a0liste\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0500,\u00a0\u00a0\u00a0\u00a0#\u00a0/lister-simulations\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0600,\u00a0\u00a0\u00a0\u00a0#\u00a0/supprimer-simulation\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-liste-simulations.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForListeSimulationsView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\n\u00a0\u00a0\u00a0\u00a0]\n\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0des\u00a0erreurs\u00a0inattendues\n\u00a0\u00a0\u00a0\u00a0view_erreurs\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-erreurs.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForErreursView()\n\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0#\u00a0redirections\n\u00a0\u00a0\u00a0\u00a0redirections\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0400,\u00a0\u00a0#\u00a0/fin-session\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers l\u2019URL\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"to\":\u00a0\"/init-session/html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0]\n\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\u00a0MVC\n\u00a0\u00a0\u00a0\u00a0return\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0contr\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"controllers\":\u00a0controllers,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9ponses\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"responses\":\u00a0responses,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vues\u00a0et\u00a0mod\u00e8les\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"views\":\u00a0views,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0liste\u00a0des\u00a0redirections\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"redirections\":\u00a0redirections,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0des\u00a0erreurs\u00a0inattendues\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_erreurs\":\u00a0view_erreurs\n\u00a0\u00a0\u00a0\u00a0}\n</code></pre> <ul> <li>lignes 1-101\u00a0: ce code est connu\u00a0;</li> <li>lignes 105-116\u00a0: on rend la configuration MVC de l\u2019application\u00a0; Le script [parameters] rassemble les constantes de l\u2019application\u00a0:</li> </ul> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0#\u00a0param\u00e9trage\u00a0de\u00a0l'application\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0script_dir\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0config['syspath']['script_dir']\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0parameters\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0utilisateurs\u00a0autoris\u00e9s\u00a0\u00e0\u00a0utiliser\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"users\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"login\":\u00a0\"admin\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"$pbkdf2-sha256$29000$mPM.h3COkTIGYOzde68VIg$7LH5Q7rN/1hW.Xa.6rcmR6h52PntvVqd5.na7EtgQNw\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0de\u00a0logs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"logsFilename\":\u00a0f\"{script_dir}/../data/logs/logs.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0config\u00a0serveur\u00a0SMTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"adminMail\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0serveur\u00a0SMTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"smtp-server\":\u00a0\"localhost\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0port\u00a0du\u00a0serveur\u00a0SMTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"smtp-port\":\u00a0\"25\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0administrateur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"from\":\u00a0\"guest@localhost.com\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"to\":\u00a0\"guest@localhost.com\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0sujet\u00a0du\u00a0mail\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"subject\":\u00a0\"plantage\u00a0du\u00a0serveur\u00a0de\u00a0calcul\u00a0d'imp\u00f4ts\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0tls\u00a0\u00e0\u00a0True\u00a0si\u00a0le\u00a0serveur\u00a0SMTP\u00a0requiert\u00a0une\u00a0autorisation,\u00a0\u00e0\u00a0False\u00a0sinon\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"tls\":\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dur\u00e9e\u00a0pause\u00a0thread\u00a0en\u00a0secondes\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"sleep_time\":\u00a00,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0serveur\u00a0Redis\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"redis\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"host\":\u00a0\"127.0.0.1\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"port\":\u00a06379\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0}\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0param\u00e9trage\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0return\u00a0parameters\n</code></pre> <ul> <li>ligne 13\u00a0: d\u00e9sormais les mots de passe des utilisateurs seront crypt\u00e9s\u00a0;</li> <li>lignes 34-38\u00a0: la configuration d\u2019un serveur [Redis] sur lequel nous reviendrons\u00a0; Avec ces nouveaux fichiers de configuration, le script [config] devient le suivant\u00a0:</li> </ul> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0du\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0import\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0config['syspath']\u00a0=\u00a0syspath.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0param\u00e9trage\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0import\u00a0parameters\n\u00a0\u00a0\u00a0\u00a0config['parameters']\u00a0=\u00a0parameters.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0la\u00a0base\u00a0de\u00a0donn\u00e9es\n\u00a0\u00a0\u00a0\u00a0import\u00a0database\n\u00a0\u00a0\u00a0\u00a0config[\"database\"]\u00a0=\u00a0database.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0import\u00a0layers\n\u00a0\u00a0\u00a0\u00a0config['layers']\u00a0=\u00a0layers.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0MVC\u00a0de\u00a0la\u00a0couche\u00a0[web]\n\u00a0\u00a0\u00a0\u00a0import\u00a0mvc\n\u00a0\u00a0\u00a0\u00a0config['mvc']\u00a0=\u00a0mvc.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre>"},{"location":"exercice-dapplication-version-13.html#332-refactorisation-du-script-principal-main","title":"33.2. Refactorisation du script principal [main]","text":"<p>Le script principal [main.py] se contente de mettre en route le serveur\u00a0:</p> <pre><code>#\u00a0on\u00a0attend\u00a0un\u00a0param\u00e8tre\u00a0mysql\u00a0ou\u00a0pgres\nimport\u00a0sys\n\nsyntaxe\u00a0=\u00a0f\"{sys.argv[0]}\u00a0mysql\u00a0/\u00a0pgres\"\nerreur\u00a0=\u00a0len(sys.argv)\u00a0!=\u00a02\nif\u00a0not\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0sgbd\u00a0=\u00a0sys.argv[1].lower()\n\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0sgbd\u00a0!=\u00a0\"mysql\"\u00a0and\u00a0sgbd\u00a0!=\u00a0\"pgres\"\nif\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0print(f\"syntaxe\u00a0:\u00a0{syntaxe}\")\n\u00a0\u00a0\u00a0\u00a0sys.exit()\n\n#\u00a0on\u00a0configure\u00a0l'application\nimport\u00a0config\nconfig\u00a0=\u00a0config.configure({'sgbd':\u00a0sgbd})\n\n#\u00a0d\u00e9pendances\nfrom\u00a0SendAdminMail\u00a0import\u00a0SendAdminMail\nfrom\u00a0Logger\u00a0import\u00a0Logger\nfrom\u00a0Imp\u00f4tsError\u00a0import\u00a0Imp\u00f4tsError\nimport\u00a0redis\n\n#\u00a0envoi\u00a0d'un\u00a0mail\u00a0\u00e0\u00a0l'administrateur\ndef\u00a0send_adminmail(config:\u00a0dict,\u00a0message:\u00a0str):\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0un\u00a0mail\u00a0\u00e0\u00a0l'administrateur\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0config_mail\u00a0=\u00a0config['parameters']['adminMail']\n\u00a0\u00a0\u00a0\u00a0config_mail[\"logger\"]\u00a0=\u00a0config['logger']\n\u00a0\u00a0\u00a0\u00a0SendAdminMail.send(config_mail,\u00a0message)\n\n#\u00a0v\u00e9rification\u00a0du\u00a0fichier\u00a0de\u00a0logs\nlogger\u00a0=\u00a0None\nerreur\u00a0=\u00a0False\nmessage_erreur\u00a0=\u00a0None\ntry:\n\u00a0\u00a0\u00a0\u00a0#\u00a0logueur\n\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0Logger(config['parameters']['logsFilename'])\nexcept\u00a0BaseException\u00a0as\u00a0exception:\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0console\n\u00a0\u00a0\u00a0\u00a0print(f\"L'erreur\u00a0suivante\u00a0s'est\u00a0produite\u00a0:\u00a0{exception}\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0message_erreur\u00a0=\u00a0f\"{exception}\"\n#\u00a0on\u00a0m\u00e9morise\u00a0le\u00a0logueur\u00a0dans\u00a0la\u00a0config\nconfig['logger']\u00a0=\u00a0logger\n#\u00a0gestion\u00a0de\u00a0l'erreur\nif\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0#\u00a0mail\u00a0\u00e0\u00a0l'administrateur\n\u00a0\u00a0\u00a0\u00a0send_adminmail(config,\u00a0message_erreur)\n\u00a0\u00a0\u00a0\u00a0#\u00a0fin\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0sys.exit(1)\n\n#\u00a0log\u00a0de\u00a0d\u00e9marrage\nlog\u00a0=\u00a0\"[serveur]\u00a0d\u00e9marrage\u00a0du\u00a0serveur\"\nlogger.write(f\"{log}\\n\")\n\n#\u00a0on\u00a0v\u00e9rifie\u00a0la\u00a0disponibilit\u00e9\u00a0du\u00a0serveur\u00a0Redis\nredis_client\u00a0=\u00a0redis.Redis(host=config[\"parameters\"][\"redis\"][\"host\"],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0port=config[\"parameters\"][\"redis\"][\"port\"])\n#\u00a0on\u00a0ping\u00a0le\u00a0serveur\u00a0Redis\ntry:\n\u00a0\u00a0\u00a0\u00a0redis_client.ping()\nexcept\u00a0BaseException\u00a0as\u00a0exception:\n\u00a0\u00a0\u00a0\u00a0#\u00a0Redis\u00a0pas\u00a0disponible\n\u00a0\u00a0\u00a0\u00a0log\u00a0=\u00a0f\"[serveur]\u00a0Le\u00a0serveur\u00a0Redis\u00a0n'est\u00a0pas\u00a0disponible\u00a0:\u00a0{exception}\"\n\u00a0\u00a0\u00a0\u00a0#\u00a0console\n\u00a0\u00a0\u00a0\u00a0print(log)\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\n\u00a0\u00a0\u00a0\u00a0logger.write(f\"{log}\\n\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0fin\n\u00a0\u00a0\u00a0\u00a0sys.exit(1)\n\n#\u00a0on\u00a0m\u00e9morise\u00a0le\u00a0client\u00a0[redis]\u00a0dans\u00a0la\u00a0config\nconfig['redis_client']\u00a0=\u00a0redis_client\n\n#\u00a0r\u00e9cup\u00e9ration\u00a0des\u00a0donn\u00e9es\u00a0de\u00a0l'administration\u00a0fiscale\nerreur\u00a0=\u00a0False\ntry:\n\u00a0\u00a0\u00a0\u00a0#\u00a0admindata\u00a0sera\u00a0une\u00a0donn\u00e9e\u00a0de\u00a0port\u00e9e\u00a0application\u00a0en\u00a0lecture\u00a0seule\n\u00a0\u00a0\u00a0\u00a0config[\"admindata\"]\u00a0=\u00a0config[\"layers\"][\"dao\"].get_admindata()\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0de\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0logger.write(\"[serveur]\u00a0connexion\u00a0\u00e0\u00a0la\u00a0base\u00a0de\u00a0donn\u00e9es\u00a0r\u00e9ussie\\n\")\nexcept\u00a0Imp\u00f4tsError\u00a0as\u00a0ex:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0d'erreur\n\u00a0\u00a0\u00a0\u00a0log\u00a0=\u00a0f\"L'erreur\u00a0suivante\u00a0s'est\u00a0produite\u00a0:\u00a0{ex}\"\n\u00a0\u00a0\u00a0\u00a0#\u00a0console\n\u00a0\u00a0\u00a0\u00a0print(log)\n\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0de\u00a0logs\n\u00a0\u00a0\u00a0\u00a0logger.write(f\"{log}\\n\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0mail\u00a0\u00e0\u00a0l'administrateur\n\u00a0\u00a0\u00a0\u00a0send_adminmail(config,\u00a0log)\n\n#\u00a0le\u00a0thread\u00a0principal\u00a0n'a\u00a0plus\u00a0besoin\u00a0du\u00a0logger\nlogger.close()\n\n#\u00a0s'il\u00a0y\u00a0a\u00a0eu\u00a0erreur\u00a0on\u00a0s'arr\u00eate\nif\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0sys.exit(2)\n\n#\u00a0import\u00a0des\u00a0routes\u00a0de\u00a0l'application\u00a0web\nimport\u00a0routes\nroutes.config=config\nroutes.execute(__name__)\n</code></pre> <ul> <li>lignes 56-73\u00a0: on introduit un serveur Redis et son client\u00a0;</li> <li>lignes 102-104\u00a0: les routes de l\u2019application ont \u00e9t\u00e9 externalis\u00e9es dans le script [routes]\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-13.html#3321-les-modules-flask_session-et-redis","title":"33.2.1. Les modules [flask_session], et [redis]","text":"<p>Le serveur [Redis] va \u00eatre utilis\u00e9 pour m\u00e9moriser les sessions des utilisateurs. Nous allons utiliser le module [flask_session] pour g\u00e9rer ces sessions. Ce module peut m\u00e9moriser les sessions des utilisateurs \u00e0 plusieurs endroits. Redis est l\u2019un de ceux-l\u00e0 et nous allons l\u2019utiliser.</p> <p>Le module [flask_session] doit \u00eatre install\u00e9 dans un terminal PyCharm\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\packages&gt;pip install flask-session\nCollecting flask-session\n  \u2026\n</code></pre> <p>Pour dialoguer avec le serveur Redis, il nous faut un client Redis. Celui nous sera fourni par le module [redis] que nous installons \u00e9galement\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\packages&gt;pip install redis\nCollecting redis\n\u2026\n</code></pre>"},{"location":"exercice-dapplication-version-13.html#3322-le-serveur-redis","title":"33.2.2. Le serveur Redis","text":"<p>Le serveur Redis va servir \u00e0 stocker les sessions des utilisateurs. Le module [flask_session] fonctionne de la fa\u00e7on suivante\u00a0:</p> <ul> <li>chaque utilisateur a un identifiant de session et c\u2019est \u00e7a qui est envoy\u00e9 au client\u00a0et uniquement \u00e7a. Le client ne re\u00e7oit de cookie de session qu\u2019une seule fois, \u00e0 l\u2019issue de sa premi\u00e8re requ\u00eate. Ce cookie contient l\u2019identifiant de session de l\u2019utilisateur qui ne changera plus au fil des requ\u00eates du client. C\u2019est pourquoi le serveur n\u2019a pas \u00e0 renvoyer de nouveau cookie de session\u00a0;</li> <li>pr\u00e9c\u00e9demment le contenu de la session \u00e9tait envoy\u00e9 au client. Ce ne sera donc plus le cas. Le contenu de la session de l\u2019utilisateur sera stock\u00e9 sur le serveur Redis\u00a0; Laragon vient avec un serveur Redis non activ\u00e9 par d\u00e9faut. Il faut donc commencer par l\u2019activer\u00a0:</li> </ul> <p></p> <ul> <li>en [3], activer le serveur [Redis]\u00a0;</li> <li>en [4], laisser le port [6379] que les clients Redis utilisent par d\u00e9faut\u00a0; Les services Laragon sont automatiquement relanc\u00e9s apr\u00e8s activation de Redis\u00a0:</li> </ul> <p></p> <p>Le serveur Redis peut \u00eatre interrog\u00e9 en mode commande. On ouvre un terminal Laragon [6]\u00a0:</p> <p></p> <ul> <li>en [1], la commande [redis-cli] lance le client en mode commande du serveur Redis\u00a0; En juillet 2019, le client Redis peut utiliser 172 commandes pour dialoguer avec le serveur [https://redis.io/commands#list]. L\u2019une d\u2019elles [command count] [2], affiche ce nombre [3].</li> </ul> <p>L\u2019\u00e9criture dans [Redis] se fait avec la commande Redis [set attribut valeur] [4]. La valeur peut ensuite \u00eatre r\u00e9cup\u00e9r\u00e9e avec la commande [get attribut] [5].</p> <p>Il peut \u00eatre n\u00e9cessaire de vider la m\u00e9moire de Redis. Cela se fait avec la commande [flushdb] [6]. Ensuite si on demande la valeur de l\u2019attribut [titre] [7], on obtient une r\u00e9f\u00e9rence [nil] [8] indiquant que l\u2019attribut n\u2019a pas \u00e9t\u00e9 trouv\u00e9. On peut \u00e9galement utiliser la commande [exists] [9-10] pour v\u00e9rifier l\u2019existence d\u2019un attribut.</p> <p>Pour quitter le client Redis, taper la commande [quit] [11].</p> <p>On peut \u00e9galement utiliser une interface web pour g\u00e9rer les cl\u00e9s pr\u00e9sentes dans le serveur Redis. Pour cela, il faut que le serveur Apache de Laragon soit lanc\u00e9\u00a0:</p> <p></p> <p>On obtient l\u2019interface suivante\u00a0:</p> <p></p> <ul> <li>en [1-4], l\u2019une des sessions stock\u00e9es sur le serveur Redis\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-13.html#3323-gestion-du-serveur-redis-dans-le-script-principal-main","title":"33.2.3. Gestion du serveur Redis dans le script principal [main]","text":"<p>Le script [main] v\u00e9rifie la pr\u00e9sence du serveur Redis de la fa\u00e7on suivante\u00a0:</p> <pre><code>import\u00a0redis\n\u2026\n#\u00a0on\u00a0v\u00e9rifie\u00a0la\u00a0disponibilit\u00e9\u00a0du\u00a0serveur\u00a0Redis\nredis_client\u00a0=\u00a0redis.Redis(host=config[\"parameters\"][\"redis\"][\"host\"],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0port=config[\"parameters\"][\"redis\"][\"port\"])\n#\u00a0on\u00a0ping\u00a0le\u00a0serveur\u00a0Redis\ntry:\n\u00a0\u00a0\u00a0\u00a0redis_client.ping()\nexcept\u00a0BaseException\u00a0as\u00a0exception:\n\u00a0\u00a0\u00a0\u00a0#\u00a0Redis\u00a0pas\u00a0disponible\n\u00a0\u00a0\u00a0\u00a0log\u00a0=\u00a0f\"[serveur]\u00a0Le\u00a0serveur\u00a0Redis\u00a0n'est\u00a0pas\u00a0disponible\u00a0:\u00a0{exception}\"\n\u00a0\u00a0\u00a0\u00a0#\u00a0console\n\u00a0\u00a0\u00a0\u00a0print(log)\n\u00a0\u00a0\u00a0\u00a0#\u00a0log\n\u00a0\u00a0\u00a0\u00a0logger.write(f\"{log}\\n\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0fin\n\u00a0\u00a0\u00a0\u00a0sys.exit(1)\n\n#\u00a0on\u00a0m\u00e9morise\u00a0le\u00a0client\u00a0[redis]\u00a0dans\u00a0la\u00a0config\nconfig['redis_client']\u00a0=\u00a0redis_client\n</code></pre> <ul> <li>ligne 4\u00a0: le constructeur de la classe [redis.Redis] construit un client du serveur Redis. Les caract\u00e9ristiques de celui-ci (adresse, port) sont trouv\u00e9es dans le script [parameters]\u00a0;</li> <li>ligne 8\u00a0: la m\u00e9thode [ping] permet de v\u00e9rifier la pr\u00e9sence du serveur Redis\u00a0;</li> <li>lignes 9-17\u00a0: si le ping n\u2019aboutit pas, alors on logue l\u2019erreur et on arr\u00eate le serveur\u00a0;</li> <li>ligne 20\u00a0: la r\u00e9f\u00e9rence du client Redis est mise dans la configuration\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-13.html#3324-gestion-des-routes-dans-le-script-principal-main","title":"33.2.4. Gestion des routes dans le script principal [main]","text":"<p>La gestion des routes dans [main] se limite aux lignes suivantes\u00a0:</p> <pre><code>#\u00a0import\u00a0des\u00a0routes\u00a0de\u00a0l'application\u00a0web\nimport\u00a0routes\nroutes.config=config\nroutes.execute(__name__)\n</code></pre> <ul> <li>ligne 1\u00a0: les routes ont \u00e9t\u00e9 externalis\u00e9es dans le module [routes]\u00a0;</li> <li>ligne 3\u00a0: les routes ont besoin de conna\u00eetre la configuration de l\u2019ex\u00e9cution\u00a0;</li> <li>ligne 4\u00a0: on lance l\u2019application Flask en lui passant le nom du script ex\u00e9cut\u00e9 (main)\u00a0; Le script des routes est le suivant\u00a0:</li> </ul> <pre><code>#\u00a0d\u00e9pendances\nimport\u00a0os\n\nfrom\u00a0flask\u00a0import\u00a0Flask,\u00a0redirect,\u00a0request,\u00a0session,\u00a0url_for\nfrom\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0flask_session\u00a0import\u00a0Session\n\n#\u00a0application\u00a0Flask\napp\u00a0=\u00a0Flask(__name__,\u00a0template_folder=\"../flask/templates\",\u00a0static_folder=\"../flask/static\")\n\n#\u00a0configuration\u00a0application\nconfig\u00a0=\u00a0{}\n\n#\u00a0le\u00a0front\u00a0controller\ndef\u00a0front_controller()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fait\u00a0suivre\u00a0la\u00a0requ\u00eate\u00a0au\u00a0contr\u00f4leur\u00a0principal\n\u00a0\u00a0\u00a0\u00a0main_controller\u00a0=\u00a0config['mvc']['controllers']['main-controller']\n\u00a0\u00a0\u00a0\u00a0return\u00a0main_controller.execute(request,\u00a0session,\u00a0config)\n\n@app.route('/',\u00a0methods=['GET'])\ndef\u00a0index()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\u00a0/init-session/html\n\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(url_for(\"init_session\",\u00a0type_response=\"html\"),\u00a0status.HTTP_302_FOUND)\n\n#\u00a0init-session\n@app.route('/init-session/&lt;string:type_response&gt;',\u00a0methods=['GET'])\ndef\u00a0init_session(type_response:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0authentifier-utilisateur\n@app.route('/authentifier-utilisateur',\u00a0methods=['POST'])\ndef\u00a0authentifier_utilisateur()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0calculer-impot\n@app.route('/calculer-impot',\u00a0methods=['POST'])\ndef\u00a0calculer_impot()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0par\u00a0lots\n@app.route('/calculer-impots',\u00a0methods=['POST'])\ndef\u00a0calculer_impots():\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0lister-simulations\n@app.route('/lister-simulations',\u00a0methods=['GET'])\ndef\u00a0lister_simulations()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0supprimer-simulation\n@app.route('/supprimer-simulation/&lt;int:numero&gt;',\u00a0methods=['GET'])\ndef\u00a0supprimer_simulation(numero:\u00a0int)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0fin-session\n@app.route('/fin-session',\u00a0methods=['GET'])\ndef\u00a0fin_session()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0afficher-calcul-impot\n@app.route('/afficher-calcul-impot',\u00a0methods=['GET'])\ndef\u00a0afficher_calcul_impot()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0get-admindata\n@app.route('/get-admindata',\u00a0methods=['GET'])\ndef\u00a0get_admindata()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\ndef\u00a0execute(name:\u00a0str):\n\u00a0\u00a0\u00a0\u00a0#\u00a0cl\u00e9\u00a0secr\u00e8te\u00a0de\u00a0la\u00a0session\n\u00a0\u00a0\u00a0\u00a0app.secret_key\u00a0=\u00a0os.urandom(12).hex()\n\u00a0\u00a0\u00a0\u00a0#\u00a0Flask-Session\n\u00a0\u00a0\u00a0\u00a0app.config.update(SESSION_TYPE='redis',\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0SESSION_REDIS=config['redis_client'])\n\u00a0\u00a0\u00a0\u00a0Session(app)\n\u00a0\u00a0\u00a0\u00a0#\u00a0cas\u00a0o\u00f9\u00a0on\u00a0lance\u00a0l'application\u00a0Flask\u00a0via\u00a0un\u00a0script\u00a0console\n\u00a0\u00a0\u00a0\u00a0if\u00a0name\u00a0==\u00a0'__main__':\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0app.config.update(ENV=\"development\",\u00a0DEBUG=True)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0app.run(threaded=True)\n</code></pre> <ul> <li>ligne 9\u00a0: l\u2019application Flask est instanci\u00e9e\u00a0;</li> <li>ligne 12\u00a0: la configuration de l\u2019application n\u2019est pas encore connue \u00e0 l\u2019\u00e9criture du script. Elle n\u2019est connue qu\u2019au moment de son ex\u00e9cution\u00a0;</li> <li>lignes 20-77\u00a0: les routes de l\u2019application telles qu\u2019elles \u00e9taient d\u00e9finies dans la version pr\u00e9c\u00e9dente. Ca ne change pas\u00a0;</li> <li>lignes 14-18\u00a0: toutes les routes se contentent d\u2019appeler la fonction [front_controller]. Nous avons d\u00e9pouill\u00e9 celle-ci de son code initial. Elle se contente maintenant d\u2019appeler le contr\u00f4leur principal de l\u2019application web\u00a0;</li> <li>lignes 79-89\u00a0: [execute] est la fonction appel\u00e9e par le script [main] pour lancer l\u2019application web\u00a0;</li> <li>ligne 81\u00a0: le module [flask_session] utilise la cl\u00e9 secr\u00e8te de Flask\u00a0;</li> <li>lignes 82-84\u00a0: configuration du module [flask_session]. Celle-ci consiste \u00e0 ajouter les cl\u00e9s [SESSION_TYPE, SESSION_REDIS] \u00e0 la configuration [app.config] de l\u2019application Flask [app]\u00a0:</li> <li>[SESSION_TYPE]\u00a0: le type de la session. Il en existe plusieurs. Le type [redis] indique que [flask_session] utilise un serveur [redis] pour m\u00e9moriser les sessions des utilisateurs. A cause de cela, on doit d\u00e9finir la cl\u00e9 [SESSION_REDIS] qui doit \u00eatre la r\u00e9f\u00e9rence d\u2019un client Redis\u00a0;</li> <li>ligne 85\u00a0: la session [Flask-Session] est associ\u00e9e \u00e0 l\u2019application Flask\u00a0;</li> <li>lignes 86-89\u00a0: si le param\u00e8tre [name] de ligne 79 est la cha\u00eene [main], alors l\u2019application Flask est lanc\u00e9e\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-13.html#333-refactorisation-du-controleur-principal","title":"33.3. Refactorisation du contr\u00f4leur principal","text":"<p>Le code autrefois dans la fonction [front_controller] du script [main] a \u00e9t\u00e9 d\u00e9plac\u00e9 dans le contr\u00f4leur principal\u00a0:</p> <p></p> <pre><code>#\u00a0import\u00a0des\u00a0d\u00e9pendances\nimport\u00a0threading\nimport\u00a0time\nfrom\u00a0random\u00a0import\u00a0randint\n\nfrom\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\nfrom\u00a0Logger\u00a0import\u00a0Logger\nfrom\u00a0SendAdminMail\u00a0import\u00a0SendAdminMail\n\ndef\u00a0send_adminmail(config:\u00a0dict,\u00a0message:\u00a0str):\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0un\u00a0mail\u00a0\u00e0\u00a0l'administrateur\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0config_mail\u00a0=\u00a0config['parameters']['adminMail']\n\u00a0\u00a0\u00a0\u00a0config_mail[\"logger\"]\u00a0=\u00a0config['logger']\n\u00a0\u00a0\u00a0\u00a0SendAdminMail.send(config_mail,\u00a0message)\n\n#\u00a0contr\u00f4leur\u00a0principal\u00a0de\u00a0l'application\nclass\u00a0MainController(InterfaceController):\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0traite\u00a0la\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0action\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response1\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0params\u00a0=\u00a0request.path.split('/')\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0l'action\u00a0est\u00a0le\u00a01er\u00a0\u00e9l\u00e9ment\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0action\u00a0=\u00a0params[1]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pas\u00a0d'erreurs\u00a0au\u00a0d\u00e9part\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0False\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0type\u00a0de\u00a0session\u00a0doit\u00a0\u00eatre\u00a0connu\u00a0avant\u00a0certaines\u00a0actions\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response1\u00a0=\u00a0session.get('typeResponse')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0type_response1\u00a0is\u00a0None\u00a0and\u00a0action\u00a0!=\u00a0\"init-session\":\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0101,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"r\u00e9ponse\":\u00a0[\"pas\u00a0de\u00a0session\u00a0en\u00a0cours.\u00a0Commencer\u00a0par\u00a0action\u00a0[init-session]\"]}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0logger\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0Logger(config['parameters']['logsFilename'])\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0le\u00a0m\u00e9morise\u00a0dans\u00a0une\u00a0config\u00a0associ\u00e9e\u00a0au\u00a0thread\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0thread_config\u00a0=\u00a0{\"logger\":\u00a0logger}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0thread_name\u00a0=\u00a0threading.current_thread().name\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config[thread_name]\u00a0=\u00a0{\"config\":\u00a0thread_config}\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0logue\u00a0la\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(f\"[MainController]\u00a0requ\u00eate\u00a0:\u00a0{request}\\n\")\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0interrompt\u00a0le\u00a0thread\u00a0si\u00a0cela\u00a0a\u00a0\u00e9t\u00e9\u00a0demand\u00e9\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0sleep_time\u00a0=\u00a0config['parameters']['sleep_time']\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0sleep_time\u00a0!=\u00a00:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0pause\u00a0est\u00a0al\u00e9atoire\u00a0pour\u00a0que\u00a0certains\u00a0threads\u00a0soient\u00a0interrompus\u00a0et\u00a0d'autres\u00a0pas\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0al\u00e9a\u00a0=\u00a0randint(0,\u00a01)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0al\u00e9a\u00a0==\u00a01:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0log\u00a0avant\u00a0pause\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(f\"[front_controller]\u00a0mis\u00a0en\u00a0pause\u00a0du\u00a0thread\u00a0pendant\u00a0{sleep_time}\u00a0seconde(s)\\n\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pause\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0time.sleep(sleep_time)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pour\u00a0certaines\u00a0actions\u00a0on\u00a0doit\u00a0\u00eatre\u00a0authentifi\u00e9\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0user\u00a0=\u00a0session.get('user')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0erreur\u00a0and\u00a0user\u00a0is\u00a0None\u00a0and\u00a0action\u00a0not\u00a0in\u00a0[\"init-session\",\u00a0\"authentifier-utilisateur\"]:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0101,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"r\u00e9ponse\":\u00a0[f\"action\u00a0[{action}]\u00a0demand\u00e9e\u00a0par\u00a0utilisateur\u00a0non\u00a0authentifi\u00e9\"]}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0y-a-t-il\u00a0des\u00a0erreurs\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0requ\u00eate\u00a0est\u00a0invalide\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0status_code\u00a0=\u00a0status.HTTP_400_BAD_REQUEST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0controller\u00a0=\u00a0config['mvc']['controllers'][action]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat,\u00a0status_code\u00a0=\u00a0controller.execute(request,\u00a0session,\u00a0config)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0except\u00a0BaseException\u00a0as\u00a0exception:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0autres\u00a0exceptions\u00a0(inattendues)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0131,\u00a0\"r\u00e9ponse\":\u00a0[f\"{exception}\"]}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0status_code\u00a0=\u00a0status.HTTP_400_BAD_REQUEST\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0finally:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0logue\u00a0le\u00a0r\u00e9sultat\u00a0envoy\u00e9\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0log\u00a0=\u00a0f\"[MainController]\u00a0{r\u00e9sultat}\\n\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(log)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0y-a-t-il\u00a0eu\u00a0une\u00a0erreur\u00a0fatale\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0status_code\u00a0==\u00a0status.HTTP_500_INTERNAL_SERVER_ERROR:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0un\u00a0mail\u00a0\u00e0\u00a0l'administrateur\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0send_adminmail(config,\u00a0log)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0d\u00e9termine\u00a0le\u00a0type\u00a0souhait\u00e9\u00a0pour\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response2\u00a0=\u00a0session.get('typeResponse')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0type_response2\u00a0is\u00a0None\u00a0and\u00a0type_response1\u00a0is\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0type\u00a0de\u00a0session\u00a0n'a\u00a0pas\u00a0encore\u00a0\u00e9t\u00e9\u00a0\u00e9tabli\u00a0-\u00a0ce\u00a0sera\u00a0du\u00a0jSON\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response\u00a0=\u00a0'json'\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0elif\u00a0type_response2\u00a0is\u00a0not\u00a0None:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0type\u00a0de\u00a0la\u00a0r\u00e9ponse\u00a0est\u00a0connu\u00a0et\u00a0dans\u00a0la\u00a0session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response\u00a0=\u00a0type_response2\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0sinon\u00a0on\u00a0continue\u00a0\u00e0\u00a0utiliser\u00a0type_response1\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response\u00a0=\u00a0type_response1\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0construit\u00a0la\u00a0r\u00e9ponse\u00a0\u00e0\u00a0envoyer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response_builder\u00a0=\u00a0config['mvc']['responses'][type_response]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response,\u00a0status_code\u00a0=\u00a0response_builder\u00a0\\\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0.build_http_response(request,\u00a0session,\u00a0config,\u00a0status_code,\u00a0r\u00e9sultat)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ferme\u00a0le\u00a0fichier\u00a0de\u00a0logs\u00a0s'il\u00a0a\u00a0\u00e9t\u00e9\u00a0ouvert\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0logger:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.close()\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0la\u00a0r\u00e9ponse\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0response,\u00a0status_code\n</code></pre> <p>Tout ce code a \u00e9t\u00e9 vu \u00e0 un moment ou \u00e0 un autre.</p>"},{"location":"exercice-dapplication-version-13.html#334-gestion-des-mots-de-passe-cryptes","title":"33.4. Gestion des mots de passe crypt\u00e9s","text":"<p>Pour g\u00e9rer des mots de passe crypt\u00e9s nous allons utiliser le module [passlib] qu\u2019on installe \u00e0 partir d\u2019un terminal Pycharm\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\packages&gt;pip install passlib\nCollecting passlib\n\u2026\n</code></pre> <p>Voici un exemple de script cryptant le mot de passe qu\u2019on lui passe en param\u00e8tre\u00a0:</p> <p></p> <p>Le script [create_hashed_password] est le suivant (https://passlib.readthedocs.io/en/stable/)\u00a0:</p> <pre><code>import\u00a0sys\n\n#\u00a0fonction\u00a0de\u00a0cryptage\nfrom\u00a0passlib.hash\u00a0import\u00a0pbkdf2_sha256\n\n#\u00a0on\u00a0attend\u00a0le\u00a0mot\u00a0de\u00a0passe\u00a0\u00e0\u00a0cryter\nsyntaxe\u00a0=\u00a0f\"{sys.argv[0]}\u00a0password\"\nerreur\u00a0=\u00a0len(sys.argv)\u00a0!=\u00a02\nif\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0print(f\"syntaxe\u00a0:\u00a0{syntaxe}\")\n\u00a0\u00a0\u00a0\u00a0sys.exit()\nelse:\n\u00a0\u00a0\u00a0\u00a0password\u00a0=\u00a0sys.argv[1]\n\n#\u00a0on\u00a0crypte\u00a0le\u00a0mot\u00a0de\u00a0passe\nhash\u00a0=\u00a0pbkdf2_sha256.hash(password)\nprint(f\"version\u00a0crypt\u00e9e\u00a0de\u00a0[{password}]\u00a0=\u00a0{hash}\")\n\n#\u00a0v\u00e9rification\ncorrect\u00a0=\u00a0pbkdf2_sha256.verify(password,\u00a0hash)\nprint(correct)\n</code></pre> <ul> <li>ligne 16\u00a0: on crypte le mot de passe pass\u00e9 en param\u00e8tre\u00a0;</li> <li>ligne 20\u00a0: on compare le mot de passe [password] pass\u00e9 en param\u00e8tre \u00e0 sa version crypt\u00e9e [hash]. La fonction [verify] crypte le mot de passe [password] et compare la cha\u00eene crypt\u00e9e obtenue \u00e0 [hash]. Rend True si les deux cha\u00eenes sont \u00e9gales\u00a0; Le script ci-dessus nous permet d\u2019avoir la version crypt\u00e9e du mot de passe [admin]\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots/http-servers/08/passlib/create_hashed_password.py admin\nversion crypt\u00e9e de [admin] = $pbkdf2-sha256$29000$fU9pTendO6c0ZoyR8r5Xqg$5ZXywIUnbMfN2hPnBaefiuqWjEbmAY.Lu06i4dwcnek\nTrue\n</code></pre> <p>Ligne 2, la valeur que nous mettons dans le script [parameters]\u00a0:</p> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"users\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"login\":\u00a0\"admin\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"$pbkdf2-sha256$29000$fU9pTendO6c0ZoyR8r5Xqg$5ZXywIUnbMfN2hPnBaefiuqWjEbmAY.Lu06i4dwcnek\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n</code></pre> <p>Le contr\u00f4leur d\u2019authentification [AuthentifierUtilisateurController] \u00e9volue de la fa\u00e7on suivante\u00a0:</p> <pre><code>from\u00a0passlib.handlers.pbkdf2\u00a0import\u00a0pbkdf2_sha256\n\u2026\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0v\u00e9rifie\u00a0la\u00a0validit\u00e9\u00a0du\u00a0couple\u00a0(user,\u00a0password)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0users\u00a0=\u00a0config['parameters']['users']\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0i\u00a0=\u00a00\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0nbusers\u00a0=\u00a0len(users)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0trouv\u00e9\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0while\u00a0not\u00a0trouv\u00e9\u00a0and\u00a0i\u00a0&lt;\u00a0nbusers:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0trouv\u00e9\u00a0=\u00a0user\u00a0==\u00a0users[i][\"login\"]\u00a0and\u00a0pbkdf2_sha256.verify(password,\u00a0users[i][\"password\"])\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0i\u00a0+=\u00a01\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0trouv\u00e9\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0trouv\u00e9:\n\u2026\n</code></pre>"},{"location":"exercice-dapplication-version-13.html#335-tests","title":"33.5. Tests","text":"<p>Outre les tests avec un navigateur, on peut \u00e9galement utiliser les clients du dossier [http-servers/07] \u00e9crits pour la version 12. Ils doivent \u2018marcher\u2019 \u00e9galement pour la version 13\u00a0:</p> <p></p> <ul> <li>en [1], les trois clients doivent fonctionner\u00a0;</li> <li>en [2], les deux tests doivent fonctionner\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-14.html","title":"34. Exercice d\u2019application\u00a0: version 14","text":"<p>Le dossier [http-servers/09] de la version 14 est obtenu par recopie du dossier [http-servers/08] de la version 13.</p>"},{"location":"exercice-dapplication-version-14.html#341-introduction","title":"34.1. Introduction","text":"<p>CSRF (Cross Site Request Forgery) est une technique de vol de session. Elle est expliqu\u00e9e ainsi dans Wikipedia (https://fr.wikipedia.org/wiki/Cross-site_request_forgery):</p> <p>Supposons qu'Alice soit l'administratrice d'un forum et qu'elle soit connect\u00e9e \u00e0 celui-ci par un syst\u00e8me de sessions. Malorie est un membre de ce m\u00eame forum, elle veut supprimer un des messages du forum. Comme elle n'a pas les droits n\u00e9cessaires avec son compte, elle utilise celui d'Alice gr\u00e2ce \u00e0 une attaque de type CSRF.</p> <ul> <li>Malorie arrive \u00e0 connaitre le lien qui permet de supprimer le message en question.</li> <li>Malorie envoie un message \u00e0 Alice contenant une pseudo-image \u00e0 afficher (qui est en fait un script). L'URL de l'image est le lien vers le script permettant de supprimer le message d\u00e9sir\u00e9.</li> <li>Alice doit avoir une session ouverte dans son navigateur pour le site vis\u00e9 par Malorie. C'est une condition requise pour que l'attaque r\u00e9ussisse de fa\u00e7on silencieuse sans requ\u00e9rir une demande d'authentification qui alerterait Alice. Cette session doit disposer des droits requis pour ex\u00e9cuter la requ\u00eate destructrice de Malorie. Il n'est pas n\u00e9cessaire qu'un onglet du navigateur soit ouvert sur le site cible ni m\u00eame que le navigateur soit d\u00e9marr\u00e9. Il suffit que la session soit active.</li> <li>Alice lit le message de Malorie, son navigateur utilise la session ouverte d'Alice et ne demande pas d'authentification interactive. Il tente de r\u00e9cup\u00e9rer le contenu de l'image. En faisant cela, le navigateur actionne le lien et supprime le message, il r\u00e9cup\u00e8re une page web texte comme contenu pour l'image. Ne reconnaissant pas le type d'image associ\u00e9, il n'affiche pas d'image et Alice ne sait pas que Malorie vient de lui faire supprimer un message contre son gr\u00e9. M\u00eame expliqu\u00e9 comme \u00e7a, la technique du CSRF est  difficile \u00e0 comprendre. Faisons un sch\u00e9ma\u00a0:</li> </ul> <p></p> <ul> <li>en [1-2], Alice communique avec le forum (Site A). Ce forum maintient une session pour chaque utilisateur. Le navigateur d\u2019Alice stocke localement ce cookie de session et le renvoie \u00e0 chaque fois qu\u2019il fait une nouvelle requ\u00eate au site A\u00a0;</li> <li>en [3], Malorie envoie un message \u00e0 Alice. Celle-ci le lit avec son navigateur. Le message lu est au format HTML et contient un lien vers une image du site B. En fait ce lien est un lien vers un script Javascript qui s\u2019ex\u00e9cute une fois arriv\u00e9 sur le navigateur d\u2019Alice\u00a0;</li> <li> <p>ce script Javascript r\u00e9alise alors une requ\u00eate vers le site A. Le navigateur d\u2019Alice envoie alors automatiquement la requ\u00eate avec le cookie de session stock\u00e9 localement. C\u2019est ici que se produit l\u2019attaque\u00a0: Malorie a r\u00e9ussi \u00e0 interroger le site A avec les droits (session) de Alice. Ensuite, peu importe ce qui se passe, l\u2019attaque a eu lieu\u00a0; Pour contrer ce type d\u2019attaque, le site A peut proc\u00e9der de la fa\u00e7on suivante\u00a0:</p> </li> <li> <p>\u00e0 chaque \u00e9change [1-2] avec Alice, le site A envoie une cl\u00e9, appel\u00e9e par la suite token (jeton) CSRF, qu\u2019Alice doit lui renvoyer lors de la requ\u00eate suivante. Ainsi Alice doit envoyer \u00e0 chaque requ\u00eate deux informations\u00a0:</p> </li> <li>le cookie de session\u00a0;</li> <li>le token CSRF\u00a0re\u00e7u lors de la r\u00e9ponse \u00e0 sa derni\u00e8re requ\u00eate au site A\u00a0; La protection est l\u00e0\u00a0: si le navigateur renvoie automatiquement au site A le cookie de session, il ne le fait pas pour le token CSRF. Pour cette raison, l\u2019\u00e9change 6-7 fait par le script d\u2019attaque sera refus\u00e9 car la requ\u00eate 6 n\u2019aura pas envoy\u00e9 le jeton CSRF\u00a0;</li> </ul> <p>Le site A peut envoyer \u00e0 Alice le jeton CSRF de diverses fa\u00e7ons pour une application HTML\u00a0:</p> <ul> <li>il peut \u00e0 chaque requ\u00eate envoyer une page HTML o\u00f9 tous les liens auront le jeton CSRF, par exemple [http://siteA/chemin/csrf_token]. Lors de la requ\u00eate suivante, Alice cliquant sur l\u2019un de ces liens, le site A n\u2019aura qu\u2019\u00e0 r\u00e9cup\u00e9rer le jeton CSRF dans l\u2019URL de la requ\u00eate et v\u00e9rifier qu\u2019il est correct. C\u2019est ce qui sera fait ici\u00a0;</li> <li>il peut, pour les pages HTML contenant un formulaire, envoyer celui-ci avec un champ cach\u00e9 [input type=\u2019hidden\u2019] contenant le jeton CSRF. Celui-ci sera alors post\u00e9 automatiquement avec le formulaire lorsqu\u2019Alice validera la page. Le site A r\u00e9cup\u00e8rera le jeton CSRF dans le corps (body) de la requ\u00eate\u00a0;</li> <li>d\u2019autres techniques sont envisageables\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-14.html#342-configuration","title":"34.2. Configuration","text":"<p>Nous introduisons dans la configuration [parameters] de l\u2019application deux bool\u00e9ens\u00a0:</p> <ul> <li>[with_redissession]\u00a0: \u00e0 True, l\u2019application utilise une session Redis. A False, l\u2019application utilise une session Flask normale\u00a0;</li> <li>[with_csrftoken]\u00a0: \u00e0 True, les URL de l\u2019application contiennent un jeton CSRF\u00a0; <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dur\u00e9e\u00a0pause\u00a0thread\u00a0en\u00a0secondes\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"sleep_time\":\u00a00,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0serveur\u00a0Redis\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"with_redissession\":\u00a0True,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"redis\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"host\":\u00a0\"127.0.0.1\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"port\":\u00a06379\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0token\u00a0csrf\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"with_csrftoken\":\u00a0False,\n</code></pre></li> </ul>"},{"location":"exercice-dapplication-version-14.html#343-implementation-csrf","title":"34.3. Impl\u00e9mentation CSRF","text":"<p>Nous allons faire en sorte que lorsque\u00a0:</p> <pre><code>config['parameters']['with_csrftoken']\n</code></pre> <p>vaut [True], l\u2019application envoie au navigateur client des pages web dont les liens contiendront un jeton CSRF.</p>"},{"location":"exercice-dapplication-version-14.html#3431-le-module-flask_wtf","title":"34.3.1. Le module [flask_wtf]","text":"<p>L\u2019impl\u00e9mentation du jeton CSRF sera faite avec le module [flask_wtf] que nous installons dans un terminal PyCharm\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\packages&gt;pip install flask_wtf\nCollecting flask_wtf\n\u2026\n</code></pre>"},{"location":"exercice-dapplication-version-14.html#3432-les-modeles-des-vues","title":"34.3.2. Les mod\u00e8les des vues","text":"<p>Nous introduisons une nouvelle classe dans les mod\u00e8les\u00a0:</p> <p></p> <p>La classe [AbstractBaseModelForView] est la suivante\u00a0:</p> <pre><code>from\u00a0abc\u00a0import\u00a0abstractmethod\n\nfrom\u00a0flask\u00a0import\u00a0Request\nfrom\u00a0flask_wtf.csrf\u00a0import\u00a0generate_csrf\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceModelForView\u00a0import\u00a0InterfaceModelForView\n\nclass\u00a0AbstractBaseModelForView(InterfaceModelForView):\n\n\u00a0\u00a0\u00a0\u00a0@abstractmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0get_model_for_view(self,\u00a0request:\u00a0Request,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0get_csrftoken(self,\u00a0config:\u00a0dict):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0csrf_token\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0config['parameters']['with_csrftoken']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0f\"/{generate_csrf()}\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0\"\"\n</code></pre> <ul> <li>ligne 9\u00a0: la classe [AbstractBaseModelForView] impl\u00e9mente l\u2019interface [InterfaceModelForView] impl\u00e9ment\u00e9e par les classes des mod\u00e8les\u00a0;</li> <li>lignes 11-13\u00a0: la m\u00e9thode [get_model_for_view] n\u2019est pas impl\u00e9ment\u00e9e\u00a0;</li> <li>lignes 15-20\u00a0: la m\u00e9thode [get_csrftoken] g\u00e9n\u00e8re le jeton CSRF si l\u2019application a \u00e9t\u00e9 configur\u00e9e pour les utiliser. Selon les cas, la fonction rend un jeton pr\u00e9c\u00e9d\u00e9 du signe / sinon une cha\u00eene vide. La fonction [generate_csrf] a la particularit\u00e9 de toujours g\u00e9n\u00e9rer la m\u00eame valeur pour une requ\u00eate client donn\u00e9e. Le traitement d\u2019une requ\u00eate implique l\u2019ex\u00e9cution de diff\u00e9rentes fonctions. Utiliser [generate_csrf] dans celles-ci g\u00e9n\u00e8re toujours la m\u00eame valeur. Lors de la requ\u00eate suivante, en revanche, un nouveau jeton CSRF est g\u00e9n\u00e9r\u00e9\u00a0; Tous les mod\u00e8les M de vue V inclueront le jeton CSRF de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code>class\u00a0ModelForAuthentificationView(AbstractBaseModelForView):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0get_model_for_view(self,\u00a0request:\u00a0Request,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0encapsule\u00a0les\u00a0donn\u00e9es\u00a0de\u00a0la\u00a0pag\u00e9\u00a0dans\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le\u00a0=\u00a0{}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0jeton\u00a0csrf\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le['csrf_token']\u00a0=\u00a0super().get_csrftoken(config)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0mod\u00e8le\n</code></pre> <ul> <li>chaque classe de mod\u00e8le \u00e9tend la classe de base [AbstractBaseModelForView]\u00a0;</li> <li>ligne 8\u00a0: le jeton CSRF est demand\u00e9 \u00e0 la classe parent. On obtient soit la cha\u00eene vide, soit une cha\u00eene du genre [/Ijk4NjQ2ZDdjZjI0ZDJiYTVjZTZjYmFhZGNjMjE3Y2U5M2I3ODI0NzYi.Xy5Okg.n-kSR_nslkndfT7AFVy2UDtdb8c]\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-14.html#3433-les-vues","title":"34.3.3. Les vues","text":"<p>De ce qu\u2019on vient de voir, toutes les vues V auront dans leur mod\u00e8le M le jeton CSRF. Elles pourront donc l\u2019utiliser dans les liens qu\u2019elles contiennent. Prenons quelques exemples\u00a0:</p> <p>Le fragment d\u2019authentification [v_authentification.html]</p> <pre><code>&lt;!--\u00a0formulaire\u00a0HTML\u00a0-\u00a0on\u00a0poste\u00a0ses\u00a0valeurs\u00a0avec\u00a0l'action\u00a0[authentifier-utilisateur]\u00a0--&gt;\n&lt;form\u00a0method=\"post\"\u00a0action=\"/authentifier-utilisateur{{mod\u00e8le.csrf_token}}\"&gt;\n\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0titre\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"alert\u00a0alert-primary\"\u00a0role=\"alert\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;h4&gt;Veuillez\u00a0vous\u00a0authentifier&lt;/h4&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u2026\n\n&lt;/form&gt;\n</code></pre> <ul> <li>ligne 2\u00a0: d\u2019apr\u00e8s ce qui vient d\u2019\u00eatre vu, l\u2019URL de l\u2019attribut [action] sera\u00a0: <pre><code>[/authentifier-utilisateur/Ijk4NjQ2ZDdjZjI0ZDJiYTVjZTZjYmFhZGNjMjE3Y2U5M2I3ODI0NzYi.Xy5Okg.n-kSR_nslkndfT7AFVy2UDtdb8c]\n</code></pre></li> </ul> <p>ou</p> <pre><code>[/authentifier-utilisateur]\n</code></pre> <p>selon que l\u2019application a \u00e9t\u00e9 configur\u00e9e pour utiliser ou non des jetons CSRF\u00a0;</p> <p>Le fragment de calcul de l\u2019imp\u00f4t [v-calcul-impot.html]</p> <pre><code>&lt;!--\u00a0formulaire\u00a0HTML\u00a0post\u00e9\u00a0--&gt;\n&lt;form\u00a0method=\"post\"\u00a0action=\"/calculer-impot{{mod\u00e8le.csrf_token}}\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0message\u00a0sur\u00a012\u00a0colonnes\u00a0sur\u00a0fond\u00a0bleu\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-12\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"alert\u00a0alert-primary\"\u00a0role=\"alert\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;h4&gt;Remplissez\u00a0le\u00a0formulaire\u00a0ci-dessous\u00a0puis\u00a0validez-le&lt;/h4&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u2026\n&lt;/form&gt;\n</code></pre> <p>Le fragment des simulations [v-liste-simulations.html]</p> <pre><code>{%\u00a0if\u00a0mod\u00e8le.simulations\u00a0is\u00a0undefined\u00a0or\u00a0mod\u00e8le.simulations|length==0\u00a0%}\n&lt;!--\u00a0message\u00a0sur\u00a0fond\u00a0bleu\u00a0--&gt;\n&lt;div\u00a0class=\"alert\u00a0alert-primary\"\u00a0role=\"alert\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;h4&gt;Votre\u00a0liste\u00a0de\u00a0simulations\u00a0est\u00a0vide&lt;/h4&gt;\n&lt;/div&gt;\n{%\u00a0endif\u00a0%}\n\n{%\u00a0if\u00a0mod\u00e8le.simulations\u00a0is\u00a0defined\u00a0and\u00a0mod\u00e8le.simulations|length!=0\u00a0%}\n&lt;!--\u00a0message\u00a0sur\u00a0fond\u00a0bleu\u00a0--&gt;\n&lt;div\u00a0class=\"alert\u00a0alert-primary\"\u00a0role=\"alert\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;h4&gt;Liste\u00a0de\u00a0vos\u00a0simulations&lt;/h4&gt;\n&lt;/div&gt;\n\n&lt;!--\u00a0tableau\u00a0des\u00a0simulations\u00a0--&gt;\n&lt;table\u00a0class=\"table\u00a0table-sm\u00a0table-hover\u00a0table-striped\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u2026\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0corps\u00a0du\u00a0tableau\u00a0(donn\u00e9es\u00a0affich\u00e9es)\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;tbody&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0on\u00a0affiche\u00a0chaque\u00a0simulation\u00a0en\u00a0parcourant\u00a0le\u00a0tableau\u00a0des\u00a0simulations\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0for\u00a0simulation\u00a0in\u00a0mod\u00e8le.simulations\u00a0%}\n\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0affichage\u00a0d'une\u00a0ligne\u00a0du\u00a0tableau\u00a0avec\u00a06\u00a0colonnes\u00a0-\u00a0balise\u00a0&lt;tr&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a01\u00a0:\u00a0ent\u00eate\u00a0ligne\u00a0(n\u00b0\u00a0simulation)\u00a0-\u00a0balise\u00a0&lt;th\u00a0scope='row'\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a02\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[mari\u00e9]\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a03\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[enfants]\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a04\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[salaire]\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a05\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[imp\u00f4t]\u00a0(de\u00a0l'imp\u00f4t)\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a06\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[surc\u00f4te]\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a07\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[d\u00e9c\u00f4te]\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a08\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[r\u00e9duction]\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a09\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[taux]\u00a0(de\u00a0l'imp\u00f4t)\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a010\u00a0:\u00a0lien\u00a0de\u00a0suppression\u00a0de\u00a0la\u00a0simulation\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;tr&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;th\u00a0scope=\"row\"&gt;{{simulation.id}}&lt;/th&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.mari\u00e9}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.enfants}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.salaire}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.imp\u00f4t}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.surc\u00f4te}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.d\u00e9c\u00f4te}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.r\u00e9duction}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.taux}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;&lt;a\u00a0href=\"/supprimer-simulation/{{simulation.id}}{{mod\u00e8le.csrf_token}}\"&gt;Supprimer&lt;/a&gt;&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/tr&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0endfor\u00a0%}\n\u00a0\u00a0\u00a0\u00a0&lt;/tr&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/tbody&gt;\n&lt;/table&gt;\n{%\u00a0endif\u00a0%}\n</code></pre> <p>Le fragment du menu [v-menu.html]</p> <pre><code>&lt;!--\u00a0menu\u00a0Bootstrap\u00a0--&gt;\n&lt;nav\u00a0class=\"nav\u00a0flex-column\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0affichage\u00a0d'une\u00a0liste\u00a0de\u00a0liens\u00a0HTML\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0for\u00a0optionMenu\u00a0in\u00a0mod\u00e8le.optionsMenu\u00a0%}\n\u00a0\u00a0\u00a0\u00a0&lt;a\u00a0class=\"nav-link\"\u00a0href=\"{{optionMenu.url}}{{mod\u00e8le.csrf_token}}\"&gt;{{optionMenu.text}}&lt;/a&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0endfor\u00a0%}\n&lt;/nav&gt;\n</code></pre>"},{"location":"exercice-dapplication-version-14.html#3434-les-routes","title":"34.3.4. Les routes","text":"<p>Il y a d\u00e9sormais deux types de routes, selon que celles-ci utilisent ou non un jeton CSRF\u00a0:</p> <p></p> <ul> <li>[routes_without_csrftoken] sont les routes sans jeton CSRF. Ce sont les routes de la version pr\u00e9c\u00e9dente\u00a0;</li> <li>[routes_with_csrftoken] sont les routes avec jeton CSRF. Dans [routes_with_csrftoken], les routes ont d\u00e9sormais un param\u00e8tre suppl\u00e9mentaire, le jeton CSRF\u00a0:</li> </ul> <pre><code>#\u00a0le\u00a0front\u00a0controller\ndef\u00a0front_controller()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fait\u00a0suivre\u00a0la\u00a0requ\u00eate\u00a0au\u00a0contr\u00f4leur\u00a0principal\n\u00a0\u00a0\u00a0\u00a0main_controller\u00a0=\u00a0config['mvc']['controllers']['main-controller']\n\u00a0\u00a0\u00a0\u00a0return\u00a0main_controller.execute(request,\u00a0session,\u00a0config)\n\n@app.route('/',\u00a0methods=['GET'])\ndef\u00a0index()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\u00a0/init-session/html\n\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(url_for(\"init_session\",\u00a0type_response=\"html\",\u00a0csrf_token=generate_csrf()),\u00a0status.HTTP_302_FOUND)\n\n#\u00a0init-session\n@app.route('/init-session/&lt;string:type_response&gt;/&lt;string:csrf_token&gt;',\u00a0methods=['GET'])\ndef\u00a0init_session(type_response:\u00a0str,\u00a0csrf_token:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0authentifier-utilisateur\n@app.route('/authentifier-utilisateur/&lt;string:csrf_token&gt;',\u00a0methods=['POST'])\ndef\u00a0authentifier_utilisateur(csrf_token:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0calculer-impot\n@app.route('/calculer-impot/&lt;string:csrf_token&gt;',\u00a0methods=['POST'])\ndef\u00a0calculer_impot(csrf_token:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0par\u00a0lots\n@app.route('/calculer-impots/&lt;string:csrf_token&gt;',\u00a0methods=['POST'])\ndef\u00a0calculer_impots(csrf_token:\u00a0str):\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0lister-simulations\n@app.route('/lister-simulations/&lt;string:csrf_token&gt;',\u00a0methods=['GET'])\ndef\u00a0lister_simulations(csrf_token:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0supprimer-simulation\n@app.route('/supprimer-simulation/&lt;int:numero&gt;/&lt;string:csrf_token&gt;',\u00a0methods=['GET'])\ndef\u00a0supprimer_simulation(numero:\u00a0int,\u00a0csrf_token:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0fin-session\n@app.route('/fin-session/&lt;string:csrf_token&gt;',\u00a0methods=['GET'])\ndef\u00a0fin_session(csrf_token:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0afficher-calcul-impot\n@app.route('/afficher-calcul-impot/&lt;string:csrf_token&gt;',\u00a0methods=['GET'])\ndef\u00a0afficher_calcul_impot(csrf_token:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0get-admindata\n@app.route('/get-admindata/&lt;string:csrf_token&gt;',\u00a0methods=['GET'])\ndef\u00a0get_admindata(csrf_token:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre> <p>Toutes les routes ont d\u00e9sormais le jeton CSRF dans leurs param\u00e8tres, m\u00eame la route [/init-session]. Cela signifie que le client ne peut pas d\u00e9marrer l\u2019application en tapant directement l\u2019URL [/init-session/html] car il y manquera le jeton CSRF. Il doit d\u00e9sormais obligatoirement passer par l\u2019URL [/] des lignes 7-10.</p> <p>Le choix des routes est fait dans le script principal [main]\u00a0:</p> <pre><code>\u2026\n#\u00a0le\u00a0thread\u00a0principal\u00a0n'a\u00a0plus\u00a0besoin\u00a0du\u00a0logger\nlogger.close()\n\n#\u00a0s'il\u00a0y\u00a0a\u00a0eu\u00a0erreur\u00a0on\u00a0s'arr\u00eate\nif\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0sys.exit(2)\n\n#\u00a0import\u00a0des\u00a0routes\u00a0de\u00a0l'application\u00a0web\nif\u00a0config['parameters']['with_csrftoken']:\n\u00a0\u00a0\u00a0\u00a0import\u00a0routes_with_csrftoken\u00a0as\u00a0routes\nelse:\n\u00a0\u00a0\u00a0\u00a0import\u00a0routes_without_csrftoken\u00a0as\u00a0routes\n\n#\u00a0configuration\u00a0des\u00a0routes\nroutes.config\u00a0=\u00a0config\n\n#\u00a0d\u00e9marrage\u00a0application\u00a0Flask\nroutes.execute(__name__)\n</code></pre> <ul> <li>lignes 9-13\u00a0: choix des routes selon que l\u2019application utilise ou non des jetons CSRF\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-14.html#3435-le-controleur-maincontroller","title":"34.3.5. Le contr\u00f4leur [MainController]","text":"<p>A chaque requ\u00eate, le serveur doit v\u00e9rifier la pr\u00e9sence du jeton CSRF. Nous ferons cela dans le contr\u00f4leur principal [MainController] qui voit passer toutes les requ\u00eates\u00a0:</p> <pre><code>from\u00a0flask_wtf.csrf\u00a0import\u00a0generate_csrf,\u00a0validate_csrf\n\u2026\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0traite\u00a0la\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0logger\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0Logger(config['parameters']['logsFilename'])\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0params\u00a0=\u00a0request.path.split('/')\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0l'action\u00a0est\u00a0le\u00a01er\u00a0\u00e9l\u00e9ment\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0action\u00a0=\u00a0params[1]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0config['parameters']['with_csrftoken']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0csrf_token\u00a0est\u00a0le\u00a0dernier\u00a0\u00e9l\u00e9ment\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrf_token\u00a0=\u00a0params.pop()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0v\u00e9rifie\u00a0la\u00a0validit\u00e9\u00a0du\u00a0token\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0une\u00a0exception\u00a0sera\u00a0lanc\u00e9e\u00a0si\u00a0le\u00a0csrf_token\u00a0n'est\u00a0pas\u00a0celui\u00a0attendu\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0validate_csrf(csrf_token)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0except\u00a0ValidationError\u00a0as\u00a0exception:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0csrf\u00a0token\u00a0invalide\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0121,\u00a0\"r\u00e9ponse\":\u00a0[f\"{exception}\"]}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0status_code\u00a0=\u00a0status.HTTP_400_BAD_REQUEST\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0except\u00a0BaseException\u00a0as\u00a0exception:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0autres\u00a0exceptions\u00a0(inattendues)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0131,\u00a0\"r\u00e9ponse\":\u00a0[f\"{exception}\"]}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0status_code\u00a0=\u00a0status.HTTP_400_BAD_REQUEST\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0finally:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ajoute\u00a0le\u00a0csrf_token\u00a0au\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat['csrf_token']\u00a0=\u00a0generate_csrf()\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0logue\u00a0le\u00a0r\u00e9sultat\u00a0envoy\u00e9\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0log\u00a0=\u00a0f\"[MainController]\u00a0{r\u00e9sultat}\\n\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger.write(log)\n</code></pre> <ul> <li>ligne 20\u00a0: on r\u00e9cup\u00e8re le jeton CSRF dans l\u2019URL de la requ\u00eate du type [http://machine\u00a0:port/chemin/action/param1/param2/\u2026/csrf_token]. Le jeton de session est toujours le dernier \u00e9l\u00e9ment de l\u2019URL\u00a0;</li> <li>ligne 23\u00a0: la validit\u00e9 du jeton CSRF r\u00e9cup\u00e9r\u00e9 dans l\u2019URL avec le jeton CSRF de la session est v\u00e9rifi\u00e9e. S\u2019il n\u2019est pas valide, la fonction [validate_csrf] lance une exception de type [ValidationError] (ligne 27)\u00a0;</li> <li>ligne 41\u00a0: le jeton CSRF est mis dans le r\u00e9sultat envoy\u00e9 au client. Les clients jSON et XML en auront besoin. En effet, ces clients ne re\u00e7oivent pas de pages HTML avec le jeton CSRF dans les liens contenus dans les pages. Ils le recevront donc dans le r\u00e9sultat jSON ou XML envoy\u00e9 par le serveur\u00a0; Note\u00a0: la fonction [validate_csrf] de la ligne 23 ne v\u00e9rifie pas une concordance stricte. Le jeton CSRF est m\u00e9moris\u00e9 dans la session avec la cl\u00e9 [csrf_token]. Les test semblent montrer qu\u2019un jeton CSRF est valide s\u2019il a \u00e9t\u00e9 g\u00e9n\u00e9r\u00e9 au cours de la session. Ainsi si manuellement, dans l\u2019URL affich\u00e9e dans le navigateur, par exemple (/lister-simulations/xyz), vous remplacez le jeton [xyz] CSRF par un autre [abc] d\u00e9j\u00e0 re\u00e7u lors d\u2019une pr\u00e9c\u00e9dente action, l\u2019action [/lister-simulations] va r\u00e9ussir\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-14.html#344-tests-avec-un-navigateur","title":"34.4. Tests avec un navigateur","text":"<p>On\u00a0:</p> <ul> <li>lance le serveur\u00a0avec le param\u00e8tre [with_csrftoken] \u00e0 [True]\u00a0;</li> <li>demande l\u2019URL [http://localhost:5000] avec un navigateur\u00a0;</li> </ul> <p></p> <ul> <li>en [1], le jeton CSRF\u00a0; Faisons des manipulations jusqu\u2019\u00e0 avoir une liste de simulations\u00a0:</li> </ul> <p></p> <p>Maintenant, tapons \u00e0 la main, l\u2019URL [http://localhost:5000/supprimer-simulation/1/x] pour supprimer la simulation d\u2019id=1. On met volontairement un jeton CSRF incorrect pour voir ce qui se passe. La r\u00e9ponse du serveur est la suivante\u00a0:</p> <p></p> <p>Note 1\u00a0: il n\u2019est pas s\u00fbr que la m\u00e9thode utilis\u00e9e ici soit toujours suffisante pour contrer les attaques CSRF. Revenons au sch\u00e9ma de l\u2019attaque\u00a0:</p> <p></p> <p>Si le script Javascript t\u00e9l\u00e9charg\u00e9 en [5] est capable de lire l\u2019historique du navigateur utilis\u00e9 par Alice, il sera capable de r\u00e9cup\u00e9rer les URL ex\u00e9cut\u00e9es par le navigateur, des URL telles que [/cible/csrf_token]. Il pourra alors r\u00e9cup\u00e9rer le jeton de session [csrf_token] et faire son attaque en [6-7]. N\u00e9anmoins, le navigateur autorise uniquement l\u2019exploitation de l\u2019historique de la fen\u00eatre du navigateur dans laquelle s\u2019ex\u00e9cute le script. Si donc Alice n\u2019utilise pas la m\u00eame fen\u00eatre pour travailler avec le site A [1-2] et lire le message de Malorie [3], l\u2019attaque CSRF ne sera pas possible.</p>"},{"location":"exercice-dapplication-version-14.html#345-clients-console","title":"34.5. Clients console","text":"<p>Une autre fa\u00e7on de tester la version 14 de l\u2019application est de reprendre les tests de la version 12 et de les adapter au nouveau serveur.</p> <p></p> <p>Le dossier [impots/http-clients/09] est obtenu initialement par recopie du dossier [impots/http-clients/07]. Il est ensuite modifi\u00e9.</p> <p>Revenons aux routes qui initialisent une session\u00a0:</p> <pre><code>#\u00a0racine\u00a0de\u00a0l'application\n@app.route('/',\u00a0methods=['GET'])\ndef\u00a0index()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\u00a0/init-session/html\n\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(url_for(\"init_session\",\u00a0type_response=\"html\",\u00a0csrf_token=generate_csrf()),\u00a0status.HTTP_302_FOUND)\n\n#\u00a0init-session-with-csrf-token\n@app.route('/init-session/&lt;string:type_response&gt;/&lt;string:csrf_token&gt;',\u00a0methods=['GET'])\ndef\u00a0init_session(type_response:\u00a0str,\u00a0csrf_token:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre> <p>Aucune de ces routes ne convient pour initialiser une session jSON ou XML\u00a0:</p> <ul> <li>lignes 2-5\u00a0: la route [/] initialise une session HTML\u00a0;</li> <li>lignes 8-11\u00a0: la route [/init-session] n\u00e9cessite un jeton CSRF qu\u2019on ne conna\u00eet pas\u00a0; Nous d\u00e9cidons d\u2019ajouter une nouvelle route au serveur\u00a0:</li> </ul> <pre><code>#\u00a0init-session-without-csrftoken\n@app.route('/init-session-without-csrftoken/&lt;string:type_response&gt;',\u00a0methods=['GET'])\ndef\u00a0init_session_without_csrftoken(type_response:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\u00a0/init-session/type_response\n\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(url_for(\"init_session\",\u00a0type_response=type_response,\u00a0csrf_token=generate_csrf()),\u00a0status.HTTP_302_FOUND)\n</code></pre> <ul> <li>ligne 2\u00a0: la nouvelle route. Elle n\u2019attend pas de jeton CSRF. On est ainsi revenu \u00e0 la route [/init-session] de la version pr\u00e9c\u00e9dente\u00a0;</li> <li>lignes 4-5\u00a0: on redirige le client (jSON, XML, HTML) vers la route [/init-session] ayant le jeton CSRF dans ses param\u00e8tres\u00a0; On peut essayer cette nouvelle route avec un navigateur\u00a0:</li> </ul> <p></p> <p>La r\u00e9ponse du serveur (configur\u00e9 avec [with_csrftoken=True]) est la suivante\u00a0:</p> <p></p> <ul> <li>en [1], le serveur a \u00e9t\u00e9 redirig\u00e9 vers la route [/init-session] avec jeton CSRF dans l\u2019URL\u00a0;</li> <li>en [2], le jeton CSRF est dans le dictionnaire jSON envoy\u00e9 par le serveur associ\u00e9 \u00e0 la cl\u00e9 [csrf_token]\u00a0; Revenons au code du client\u00a0:</li> </ul> <p></p> <p>Nous modifions la configuration [config] de la fa\u00e7on suivante\u00a0:</p> <pre><code>\u00a0\u00a0\u00a0config.update({\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0des\u00a0contribuables\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"taxpayersFilename\":\u00a0f\"{script_dir}/../data/input/taxpayersdata.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0des\u00a0r\u00e9sultats\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"resultsFilename\":\u00a0f\"{script_dir}/../data/output/r\u00e9sultats.json\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0des\u00a0erreurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"errorsFilename\":\u00a0f\"{script_dir}/../data/output/errors.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0de\u00a0logs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"logsFilename\":\u00a0f\"{script_dir}/../data/logs/logs.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0serveur\u00a0de\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"server\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"urlServer\":\u00a0\"http://127.0.0.1:5000\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"user\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"login\":\u00a0\"admin\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"admin\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"url_services\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"calculate-tax\":\u00a0\"/calculer-impot\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"get-admindata\":\u00a0\"/get-admindata\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"calculate-tax-in-bulk-mode\":\u00a0\"/calculer-impots\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"init-session\":\u00a0\"/init-session-without-csrftoken\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"end-session\":\u00a0\"/fin-session\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"authenticate-user\":\u00a0\"/authentifier-utilisateur\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"get-simulations\":\u00a0\"/lister-simulations\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"delete-simulation\":\u00a0\"/supprimer-simulation\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mode\u00a0debug\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"debug\":\u00a0True,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0csrf_token\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"with_csrftoken\":\u00a0True,\n\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0)\n\u2026\n\u00a0\u00a0\u00a0\u00a0#\u00a0route\u00a0init-session\n\u00a0\u00a0\u00a0\u00a0url_services\u00a0=\u00a0config['server']['url_services']\n\u00a0\u00a0\u00a0\u00a0if\u00a0config['with_csrftoken']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_services['init-session']\u00a0=\u00a0'/init-session-without-csrftoken'\n\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_services['init-session']\u00a0=\u00a0'/init-session'\n</code></pre> <ul> <li>ligne 31\u00a0: un bool\u00e9en indiquera au client si le serveur auquel il s\u2019adresse travaille ou non avec des jetons CSRF\u00a0;</li> <li>lignes 37-40\u00a0: on fixe l\u2019URL de service de l\u2019action [init-session]\u00a0:</li> <li>si le serveur utilise des jetons CSRF alors l\u2019URL de service est [/init-session-without-csrftoken]\u00a0;</li> <li>sinon l\u2019URL de service est [/init-session]\u00a0; La route [/init-session-without-csrftoken] a \u00e9t\u00e9 pr\u00e9sent\u00e9e. Elle permet \u00e0 un client jSON / XML de d\u00e9marrer une session avec le serveur sans poss\u00e9der de jeton CSRF. Il trouvera ce jeton dans la r\u00e9ponse du serveur.</li> </ul> <p>Nous modifions ensuite la classe [Imp\u00f4tsDaoWithHttpSession] impl\u00e9mentant la couche [dao] du client\u00a0:</p> <p></p> <pre><code>#\u00a0imports\nimport\u00a0json\n\nimport\u00a0requests\nimport\u00a0xmltodict\nfrom\u00a0flask_api\u00a0import\u00a0status\n\nfrom\u00a0AbstractImp\u00f4tsDao\u00a0import\u00a0AbstractImp\u00f4tsDao\nfrom\u00a0AdminData\u00a0import\u00a0AdminData\nfrom\u00a0Imp\u00f4tsError\u00a0import\u00a0Imp\u00f4tsError\nfrom\u00a0InterfaceImp\u00f4tsDaoWithHttpSession\u00a0import\u00a0InterfaceImp\u00f4tsDaoWithHttpSession\nfrom\u00a0TaxPayer\u00a0import\u00a0TaxPayer\n\nclass\u00a0Imp\u00f4tsDaoWithHttpSession(InterfaceImp\u00f4tsDaoWithHttpSession):\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0constructeur\n\u00a0\u00a0\u00a0\u00a0def\u00a0__init__(self,\u00a0config:\u00a0dict):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0initialisation\u00a0parent\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0AbstractImp\u00f4tsDao.__init__(self,\u00a0config)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0m\u00e9morisation\u00a0\u00e9l\u00e9ments\u00a0de\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0config\u00a0g\u00e9n\u00e9rale\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__config\u00a0=\u00a0config\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0serveur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__config_server\u00a0=\u00a0config[\"server\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0services\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__config_services\u00a0=\u00a0config[\"server\"]['url_services']\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mode\u00a0debug\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__debug\u00a0=\u00a0config[\"debug\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0logger\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__logger\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0cookies\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__cookies\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0type\u00a0de\u00a0session\u00a0(json,\u00a0xml)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__session_type\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0jeton\u00a0CSRF\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__csrf_token\u00a0=\u00a0None\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a0request\u00a0/\u00a0response\n\u00a0\u00a0\u00a0\u00a0def\u00a0get_response(self,\u00a0method:\u00a0str,\u00a0url_service:\u00a0str,\u00a0data_value:\u00a0dict\u00a0=\u00a0None,\u00a0json_value=None):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0[method]\u00a0:\u00a0m\u00e9thode\u00a0HTTP\u00a0GET\u00a0ou\u00a0POST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0[url_service]\u00a0:\u00a0URL\u00a0de\u00a0service\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0[data]\u00a0:\u00a0param\u00e8tres\u00a0du\u00a0POST\u00a0en\u00a0x-www-form-urlencoded\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0[json]\u00a0:\u00a0param\u00e8tres\u00a0du\u00a0POST\u00a0en\u00a0json\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0[cookies]:\u00a0cookies\u00a0\u00e0\u00a0inclure\u00a0dans\u00a0la\u00a0requ\u00eate\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0doit\u00a0avoir\u00a0une\u00a0session\u00a0XML\u00a0ou\u00a0JSON,\u00a0sinon\u00a0on\u00a0ne\u00a0pourra\u00a0pas\u00a0g\u00e9rer\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0self.__session_type\u00a0not\u00a0in\u00a0['json',\u00a0'xml']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0raise\u00a0Imp\u00f4tsError(73,\u00a0\"il\u00a0n'y\u00a0a\u00a0pas\u00a0de\u00a0session\u00a0valide\u00a0en\u00a0cours\")\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ajoute\u00a0le\u00a0jeton\u00a0CSRF\u00a0\u00e0\u00a0l'URL\u00a0de\u00a0service\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0self.__csrf_token:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_service\u00a0=\u00a0f\"{url_service}/{self.__csrf_token}\"\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ex\u00e9cution\u00a0de\u00a0la\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response\u00a0=\u00a0requests.request(method,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_service,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0data=data_value,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0json=json_value,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0cookies=self.__cookies,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0allow_redirects=True)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mode\u00a0debug\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0self.__debug:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0logueur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0self.__logger:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__logger\u00a0=\u00a0self.__config['logger']\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0logue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__logger.write(f\"{response.text}\\n\")\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0self.__session_type\u00a0==\u00a0\"json\":\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0json.loads(response.text)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\u00a0\u00a0#\u00a0xml\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0xmltodict.parse(response.text[39:])['root']\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0cookies\u00a0de\u00a0la\u00a0r\u00e9ponse\u00a0s'il\u00a0y\u00a0en\u00a0a\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0response.cookies:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__cookies\u00a0=\u00a0response.cookies\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0le\u00a0jeton\u00a0CSRF\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0self.__config['with_csrftoken']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__csrf_token\u00a0=\u00a0r\u00e9sultat.get('csrf_token',\u00a0None)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0code\u00a0de\u00a0statut\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0status_code\u00a0=\u00a0response.status_code\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0si\u00a0code\u00a0de\u00a0statut\u00a0diff\u00e9rent\u00a0de\u00a0200\u00a0OK\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0status_code\u00a0!=\u00a0status.HTTP_200_OK:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0raise\u00a0Imp\u00f4tsError(35,\u00a0r\u00e9sultat['r\u00e9ponse'])\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0r\u00e9sultat['r\u00e9ponse']\n\n\u00a0\u00a0\u00a0\u00a0\n\u00a0\u00a0\u00a0\u00a0def\u00a0init_session(self,\u00a0session_type:\u00a0str):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0le\u00a0type\u00a0de\u00a0la\u00a0session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__session_type\u00a0=\u00a0session_type\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0supprime\u00a0le\u00a0jeton\u00a0CSRF\u00a0des\u00a0pr\u00e9c\u00e9dents\u00a0appels\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__csrf_token\u00a0=\u00a0None\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0demande\u00a0l'URL\u00a0de\u00a0l'action\u00a0init-session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_service\u00a0=\u00a0f\"{self.__config_server['urlServer']}{self.__config_services['init-session']}/{session_type}\"\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ex\u00e9cution\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.get_response(\"GET\",\u00a0url_service)\n\u2026\n</code></pre> <ul> <li>lignes 38-92\u00a0: la gestion du jeton CSRF se passe principalement dans la m\u00e9thode [get_response]\u00a0;</li> <li> <p>ligne 60\u00a0: le point important est le param\u00e8tre [allow_redirects=True]. C\u2019est sa valeur par d\u00e9faut mais on a tenu \u00e0 le mettre en relief\u00a0; Lorsqu\u2019on est en mode [with_csrftoken=True]\u00a0:</p> </li> <li> <p>les clients commencent leur dialogue avec le serveur par l\u2019appel \u00e0 la route [/init-session_without_csftoken/type_response]\u00a0;</p> </li> <li>le serveur r\u00e9pond \u00e0 cette requ\u00eate par une redirection vers la route [/init-session/type_response/csrf_token]\u00a0;</li> <li>\u00e0 cause du param\u00e8tre [allow_redirects=True], cette redirection va \u00eatre suivie par le client [requests]\u00a0;</li> <li> <p>le jeton CSRF sera trouv\u00e9 dans le r\u00e9sultat r\u00e9cup\u00e9r\u00e9 aux lignes 72 et 74 associ\u00e9 \u00e0 la cl\u00e9 [csrf_token]\u00a0; Lorsqu\u2019on est en mode [with_csrftoken=False]\u00a0:</p> </li> <li> <p>les clients commencent leur dialogue avec le serveur par l\u2019appel \u00e0 la route [/init-session /type_response]\u00a0;</p> </li> <li>le serveur r\u00e9pond \u00e0 cette requ\u00eate par une redirection vers la route [/init-session/type_response]\u00a0;</li> <li>\u00e0 cause du param\u00e8tre [allow_redirects=True], cette redirection va \u00eatre suivie par le client [requests]\u00a0;</li> <li>il n\u2019y a pas de jeton CSRF \u00e0 r\u00e9cup\u00e9rer aux lignes 81-82. La propri\u00e9t\u00e9 [self.__csrf_token] reste alors toujours \u00e0 None (ligne 36)\u00a0;</li> <li>lignes 51-52\u00a0: pour toutes les requ\u00eates suivantes, le jeton CSRF, s\u2019il existe, est ajout\u00e9 \u00e0 la route initiale\u00a0;</li> <li>lignes 81-82\u00a0: le nouveau jeton que g\u00e9n\u00e8re le serveur \u00e0 chaque nouvelle requ\u00eate du client est m\u00e9moris\u00e9 localement pour \u00eatre renvoy\u00e9 ligne 52 \u00e0 la requ\u00eate suivante\u00a0; Par ailleurs, la m\u00e9thode [init_session] \u00e9volue un peu\u00a0:</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0def\u00a0init_session(self,\u00a0session_type:\u00a0str):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0le\u00a0type\u00a0de\u00a0la\u00a0session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__session_type\u00a0=\u00a0session_type\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0supprime\u00a0le\u00a0jeton\u00a0CSRF\u00a0des\u00a0pr\u00e9c\u00e9dents\u00a0appels\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__csrf_token\u00a0=\u00a0None\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0demande\u00a0l'URL\u00a0de\u00a0l'action\u00a0init-session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_service\u00a0=\u00a0f\"{self.__config_server['urlServer']}{self.__config_services['init-session']}/{session_type}\"\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ex\u00e9cution\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.get_response(\"GET\",\u00a0url_service)\n</code></pre> <p>Il faut se rappeler ici qu\u2019on a cr\u00e9\u00e9 une route [/init-session-without-csrftoken/&lt;type-response&gt;] pour initialiser le dialogue client / serveur sans jeton CSRF. Or nous avons vu que la m\u00e9thode [get_response] appel\u00e9e ligne 12 du code ajoute syst\u00e9matiquement \u00e0 la fin de l\u2019URL de service le jeton CSRF m\u00e9moris\u00e9 dans [self.__csrf_token]. C\u2019est pourquoi ligne 6 du code on supprime ce jeton CSRF s\u2019il existait.</p> <p>C\u2019est tout. Pour les tests, on ex\u00e9cutera\u00a0:</p> <ul> <li>les clients console [main, main2, main3]\u00a0;</li> <li>les classes de test [Test1HttpClientDaoWithSession] et [Test2HttpClientDaoWithSession]\u00a0; en mettant successivement \u00e0 True puis False, le param\u00e8tre de configuration [with_csrftoken].</li> </ul> <p></p> <p>Voici comme exemple les logs obtenus \u00e0 l\u2019ex\u00e9cution du client [main json]\u00a0avec [with_csrftoken=True]\u00a0:</p> <pre><code>2020-08-08 16:33:23.317903, MainThread : d\u00e9but du calcul de l'imp\u00f4t des contribuables\n2020-08-08 16:33:23.317903, Thread-1 : d\u00e9but du calcul de l'imp\u00f4t des 4 contribuables\n2020-08-08 16:33:23.317903, Thread-2 : d\u00e9but du calcul de l'imp\u00f4t des 2 contribuables\n2020-08-08 16:33:23.317903, Thread-3 : d\u00e9but du calcul de l'imp\u00f4t des 4 contribuables\n2020-08-08 16:33:23.317903, Thread-4 : d\u00e9but du calcul de l'imp\u00f4t des 1 contribuables\n2020-08-08 16:33:23.379221, Thread-2 : {\"action\": \"init-session\", \"\u00e9tat\": 700, \"r\u00e9ponse\": [\"session d\u00e9marr\u00e9e avec le type de r\u00e9ponse json\"], \"csrf_token\": \"ImFiZmZkYjZmMzFkZDc2YWRjNWYwOGM0NTBmMGM4ODJjYzViOWI4NGEi.Xy63sw.H5L0--yWsvfaWvggrGw78z5VnN0\"}\n2020-08-08 16:33:23.381073, Thread-4 : {\"action\": \"init-session\", \"\u00e9tat\": 700, \"r\u00e9ponse\": [\"session d\u00e9marr\u00e9e avec le type de r\u00e9ponse json\"], \"csrf_token\": \"ImY5YzQyMjlkYzcyYmM4YmZiMGI0NWY5MjE4MzIzNDExZjc0MGQ3MWQi.Xy63sw.q6olg7IP_g2ro_RBFRCX1BX90g8\"}\n2020-08-08 16:33:23.386982, Thread-3 : {\"action\": \"init-session\", \"\u00e9tat\": 700, \"r\u00e9ponse\": [\"session d\u00e9marr\u00e9e avec le type de r\u00e9ponse json\"], \"csrf_token\": \"IjkxZGNlN2YyMmUxMjQ0M2Y0MTdjNDQ4ZmQ1MDMxZjkwNjBhNzAzZjMi.Xy63sw.-6buL11No3UJBlElpW4tX4B-lp0\"}\n2020-08-08 16:33:23.390269, Thread-1 : {\"action\": \"init-session\", \"\u00e9tat\": 700, \"r\u00e9ponse\": [\"session d\u00e9marr\u00e9e avec le type de r\u00e9ponse json\"], \"csrf_token\": \"IjIxNmU4MDQyZDFmZmIyZDlmZjE4MzNlNDUzYzFjMGYxMWYxYzEwNGYi.Xy63sw.fgs6Cm2owsJf4NjTm7gKrVESabI\"}\n2020-08-08 16:33:23.413206, Thread-2 : {\"action\": \"authentifier-utilisateur\", \"\u00e9tat\": 200, \"r\u00e9ponse\": \"Authentification r\u00e9ussie\", \"csrf_token\": \"ImFiZmZkYjZmMzFkZDc2YWRjNWYwOGM0NTBmMGM4ODJjYzViOWI4NGEi.Xy63sw.H5L0--yWsvfaWvggrGw78z5VnN0\"}\n2020-08-08 16:33:23.422877, Thread-2 : {\"action\": \"calculer-impots\", \"\u00e9tat\": 1500, \"r\u00e9ponse\": [{\"mari\u00e9\": \"non\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 16782, \"surc\u00f4te\": 7176, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 1}, {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 9200, \"surc\u00f4te\": 2180, \"taux\": 0.3, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 2}], \"csrf_token\": \"ImFiZmZkYjZmMzFkZDc2YWRjNWYwOGM0NTBmMGM4ODJjYzViOWI4NGEi.Xy63sw.H5L0--yWsvfaWvggrGw78z5VnN0\"}\n2020-08-08 16:33:23.428622, Thread-4 : {\"action\": \"authentifier-utilisateur\", \"\u00e9tat\": 200, \"r\u00e9ponse\": \"Authentification r\u00e9ussie\", \"csrf_token\": \"ImY5YzQyMjlkYzcyYmM4YmZiMGI0NWY5MjE4MzIzNDExZjc0MGQ3MWQi.Xy63sw.q6olg7IP_g2ro_RBFRCX1BX90g8\"}\n2020-08-08 16:33:23.429127, Thread-3 : {\"action\": \"authentifier-utilisateur\", \"\u00e9tat\": 200, \"r\u00e9ponse\": \"Authentification r\u00e9ussie\", \"csrf_token\": \"IjkxZGNlN2YyMmUxMjQ0M2Y0MTdjNDQ4ZmQ1MDMxZjkwNjBhNzAzZjMi.Xy63sw.-6buL11No3UJBlElpW4tX4B-lp0\"}\n2020-08-08 16:33:23.429127, Thread-1 : {\"action\": \"authentifier-utilisateur\", \"\u00e9tat\": 200, \"r\u00e9ponse\": \"Authentification r\u00e9ussie\", \"csrf_token\": \"IjIxNmU4MDQyZDFmZmIyZDlmZjE4MzNlNDUzYzFjMGYxMWYxYzEwNGYi.Xy63sw.fgs6Cm2owsJf4NjTm7gKrVESabI\"}\n2020-08-08 16:33:23.429127, Thread-2 : {\"action\": \"fin-session\", \"\u00e9tat\": 400, \"r\u00e9ponse\": \"session r\u00e9initialis\u00e9e\", \"csrf_token\": \"IjU1YjlmZDA0OWRhNTJlODFmYjgyYjlhM2ExYWNhZmUzNTk2NjA5NGIi.Xy63sw.nyNSvkcG6iG0oIMBjtYPo8ySgdw\"}\n2020-08-08 16:33:23.438519, Thread-2 : fin du calcul de l'imp\u00f4t des 2 contribuables\n2020-08-08 16:33:23.443033, Thread-4 : {\"action\": \"calculer-impots\", \"\u00e9tat\": 1500, \"r\u00e9ponse\": [{\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000, \"imp\u00f4t\": 42842, \"surc\u00f4te\": 17283, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 1}], \"csrf_token\": \"ImY5YzQyMjlkYzcyYmM4YmZiMGI0NWY5MjE4MzIzNDExZjc0MGQ3MWQi.Xy63sw.q6olg7IP_g2ro_RBFRCX1BX90g8\"}\n2020-08-08 16:33:23.446510, Thread-3 : {\"action\": \"calculer-impots\", \"\u00e9tat\": 1500, \"r\u00e9ponse\": [{\"mari\u00e9\": \"oui\", \"enfants\": 5, \"salaire\": 100000, \"imp\u00f4t\": 4230, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 1}, {\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 100000, \"imp\u00f4t\": 22986, \"surc\u00f4te\": 0, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 2}, {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 30000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.0, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 3}, {\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 200000, \"imp\u00f4t\": 64210, \"surc\u00f4te\": 7498, \"taux\": 0.45, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 4}], \"csrf_token\": \"IjkxZGNlN2YyMmUxMjQ0M2Y0MTdjNDQ4ZmQ1MDMxZjkwNjBhNzAzZjMi.Xy63sw.-6buL11No3UJBlElpW4tX4B-lp0\"}\n2020-08-08 16:33:23.453477, Thread-1 : {\"action\": \"calculer-impots\", \"\u00e9tat\": 1500, \"r\u00e9ponse\": [{\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555, \"imp\u00f4t\": 2814, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 1}, {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 50000, \"imp\u00f4t\": 1384, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 384, \"r\u00e9duction\": 347, \"id\": 2}, {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 50000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 720, \"r\u00e9duction\": 0, \"id\": 3}, {\"mari\u00e9\": \"non\", \"enfants\": 2, \"salaire\": 100000, \"imp\u00f4t\": 19884, \"surc\u00f4te\": 4480, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0, \"id\": 4}], \"csrf_token\": \"IjIxNmU4MDQyZDFmZmIyZDlmZjE4MzNlNDUzYzFjMGYxMWYxYzEwNGYi.Xy63sw.fgs6Cm2owsJf4NjTm7gKrVESabI\"}\n2020-08-08 16:33:23.457912, Thread-4 : {\"action\": \"fin-session\", \"\u00e9tat\": 400, \"r\u00e9ponse\": \"session r\u00e9initialis\u00e9e\", \"csrf_token\": \"IjQ0ZDQxODgzN2M5NjRiYWI0NjA2MTk5YWFkNGFhMzY1M2IxNWMyNDIi.Xy63sw.mOa5MKXvJ-EXf_qEok-OqC5j_mg\"}\n2020-08-08 16:33:23.458442, Thread-4 : fin du calcul de l'imp\u00f4t des 1 contribuables\n2020-08-08 16:33:23.459045, Thread-3 : {\"action\": \"fin-session\", \"\u00e9tat\": 400, \"r\u00e9ponse\": \"session r\u00e9initialis\u00e9e\", \"csrf_token\": \"ImQ0NDZlYmViYjY1ZDUxYzJhMTNmM2JiZTRkMjBjZGJkYzE0OGVkYzMi.Xy63sw.fviTJz4zFDqVLlVlkrosT_JRPww\"}\n2020-08-08 16:33:23.459700, Thread-3 : fin du calcul de l'imp\u00f4t des 4 contribuables\n2020-08-08 16:33:23.460492, Thread-1 : {\"action\": \"fin-session\", \"\u00e9tat\": 400, \"r\u00e9ponse\": \"session r\u00e9initialis\u00e9e\", \"csrf_token\": \"Ijg3MjQ1NGUyYTUyOGEyNTdmZmNmYWZkMmU2OTgyMzUwNjI1YTlhZjIi.Xy63sw.I0xBl9Q8DzsuXPSgOdeARc_VKBA\"}\n2020-08-08 16:33:23.460492, Thread-1 : fin du calcul de l'imp\u00f4t des 4 contribuables\n2020-08-08 16:33:23.460492, MainThread : fin du calcul de l'imp\u00f4t des contribuables\n</code></pre> <p>Si on regarde les jetons CSRF re\u00e7us successivement on voit qu\u2019ils sont tous diff\u00e9rents.</p>"},{"location":"exercice-dapplication-version-15.html","title":"35. Exercice d\u2019application\u00a0: version 15","text":""},{"location":"exercice-dapplication-version-15.html#351-introduction","title":"35.1. Introduction","text":"<p>Cette version vise \u00e0 r\u00e9soudre des probl\u00e8mes li\u00e9s au rafra\u00eechissement des pages de l\u2019application dans le navigateur (F5). Prenons un exemple. L\u2019utilisateur vient de suprimer la simulation d\u2019id=3\u00a0:</p> <p></p> <p>Apr\u00e8s la suppression l\u2019URL dans le navigateur est [/supprimer-simulation/3/\u2026]. Si l\u2019utilisateur rafra\u00eechit la page (F5), l\u2019URL [1] est rejou\u00e9e. On demande donc de nouveau la suppression de la simulation d\u2019id=3. Le r\u00e9sultat est alors le suivant\u00a0:</p> <p></p> <p>Voici un autre exemple. L\u2019utilisateur vient de calculer un imp\u00f4t\u00a0:</p> <ul> <li>en [1], l\u2019URL [/calculer-impot] qui vient d\u2019\u00eatre interrog\u00e9e avec un POST\u00a0;</li> </ul> <p></p> <p>Si l\u2019utilisateur rafra\u00eechit la page (F5), il obtient un message d\u2019avertissement\u00a0:</p> <p></p> <p>L\u2019op\u00e9ration de rafra\u00eechissement de page rejoue la derni\u00e8re requ\u00eate ex\u00e9cut\u00e9e par le navigateur, ici un [POST /calculer-impot]. Lorsqu\u2019on demande \u00e0 rejouer un POST, les navigateurs \u00e9mettent un avertissement analogue \u00e0 celui ci-dessus. Celui-ci avertit qu\u2019il est en train de rejouer une action d\u00e9j\u00e0 faite. Supposons que ce POST ait effectu\u00e9 un achat, il serait malheureux de refaire celui-ci.</p> <p>Par ailleurs, nous allons limiter la possibilit\u00e9 de l\u2019utilisateur de taper des URL dans son navigateur. Prenons par exemple l\u2019une des vues pr\u00e9c\u00e9dentes\u00a0:</p> <p></p> <p>Les liens offerts par cette page sont\u00a0:</p> <ul> <li>[Liste des simulations] associ\u00e9 \u00e0 l\u2019URL [/lister-simulations]\u00a0;</li> <li>[Fin de session] associ\u00e9 \u00e0 l\u2019URL [/fin-session]\u00a0;</li> <li>[Valider] associ\u00e9 \u00e0 l\u2019URL (on ne la voit pas ci-dessus) [/calculer-impot]\u00a0; Lorsque la vue du calcul de l\u2019imp\u00f4t sera affich\u00e9e, nous n\u2019accepterons que les actions [/lister-simulations, /fin-session, /calculer-impot]. Si l\u2019utilisateur tape une autre action dans son navigateur, une erreur sera d\u00e9clar\u00e9e. On fera ce type de v\u00e9rification pour les quatre vues de l\u2019application.</li> </ul> <p>Nous nous proposons de r\u00e9soudre le probl\u00e8me du rafra\u00eechissement des pages de la fa\u00e7on suivante\u00a0:</p> <ul> <li>nous allons distinguer deux types d\u2019actions\u00a0:</li> <li>les actions ADS (Action Do Something) modifiant l\u2019\u00e9tat de l\u2019application. Les actions ADS ont en g\u00e9n\u00e9ral des param\u00e8tres dans l\u2019URL ou le corps de la requ\u00eate\u00a0;</li> <li>les actions ASV (Action Show View) affichant une vue sans modifier l\u2019\u00e9tat de l\u2019application. Il y aura autant d\u2019actions ASV que de vues\u00a0V. Les actions ASV n\u2019ont aucun param\u00e8tre\u00a0;</li> <li>les actions ADS jusqu\u2019\u00e0 maintenant s\u2019ex\u00e9cutaient puis se terminaient par l\u2019affichage d\u2019une vue V apr\u00e8s avoir pr\u00e9par\u00e9 le mod\u00e8le M de celle-ci. D\u00e9sormais, elles mettront le mod\u00e8le M de la vue en session et demanderont au navigateur de se rediriger vers l\u2019action ASV charg\u00e9e d\u2019afficher la vue V\u00a0;</li> <li>les vues V ne seront affich\u00e9es qu\u2019\u00e0 l\u2019issue d\u2019une action ASV. Elles prendront leur mod\u00e8le dans la session\u00a0; L\u2019int\u00e9r\u00eat de cette m\u00e9thode est que le navigateur affichera l\u2019URL ASV dans son champ d\u2019adresse. Le rafra\u00eechissement de la page rejouera alors l\u2019action ASV. Celle-ci ne modifie pas l\u2019\u00e9tat de l\u2019application et utilise un mod\u00e8le en session. Donc la m\u00eame page sera r\u00e9affich\u00e9e sans effets de bord. Finalement, \u00e0 cause des redirections, l\u2019utilisateur ne verra que des URL d\u2019actions ASV dans son navigateur et aura l\u2019impression de naviguer de page en page\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-15.html#352-implementation","title":"35.2. Impl\u00e9mentation","text":"<p>Le dossier [impots/http-servers/10] est obtenu initialement par recopie du dossier [impots/http-servers/09]. Il est ensuite modifi\u00e9.</p>"},{"location":"exercice-dapplication-version-15.html#3521-les-nouvelles-routes","title":"35.2.1. Les nouvelles routes","text":"<p>Dans les deux fichiers [routes_with_csrftoken] et [routes_without_csrftoken], il nous faut cr\u00e9er les quatre routes des quatre actions ASV qui affichent les quatre vues. Les autres routes restent \u00e0 l\u2019identique.</p> <p>Dans [routes_with_csrftoken]\u00a0:</p> <pre><code>#\u00a0afficher-vue-calcul-impot\n@app.route('/afficher-vue-calcul-impot/&lt;string:csrf_token&gt;',\u00a0methods=['GET'])\ndef\u00a0afficher_vue_calcul_impot(csrf_token:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0afficher-vue-authentification\n@app.route('/afficher-vue-authentification/&lt;string:csrf_token&gt;',\u00a0methods=['GET'])\ndef\u00a0afficher_vue_authentification(csrf_token:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0afficher-vue-liste-simulations\n@app.route('/afficher-vue-liste-simulations/&lt;string:csrf_token&gt;',\u00a0methods=['GET'])\ndef\u00a0afficher_vue_liste_simulations(csrf_token:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0afficher-vue-liste_erreurs\n@app.route('/afficher-vue-liste-erreurs/&lt;string:csrf_token&gt;',\u00a0methods=['GET'])\ndef\u00a0afficher_vue_liste_erreurs(csrf_token:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre> <p>Lignes 1-23, nous avons cr\u00e9\u00e9 quatre routes pour quatre actions ASV\u00a0:</p> <ul> <li>[/afficher-vue-authentification], ligne 8, affiche la vue d\u2019authentification\u00a0;</li> <li>[/afficher-vue-calcul-impot], ligne 2, affiche la vue du calcul de l\u2019imp\u00f4t\u00a0;</li> <li>[/afficher-vue-liste-simulations], ligne 14, affiche la vue des simulations\u00a0;</li> <li>[/afficher-vue-liste-erreurs], ligne 20, affiche la vue des erreurs inattendues\u00a0; On fait de m\u00eame dans le fichier [routes_with_csrftoken] des routes sans jeton\u00a0:</li> </ul> <pre><code>#\u00a0routes\u00a0ASV\u00a0-------------------------\n#\u00a0afficher-vue-calcul-impot\n@app.route('/afficher-vue-calcul-impot',\u00a0methods=['GET'])\ndef\u00a0afficher_vue_calcul_impot()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0afficher-vue-authentification\n@app.route('/afficher-vue-authentification',\u00a0methods=['GET'])\ndef\u00a0afficher_vue_authentification()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0afficher-vue-liste-simulations\n@app.route('/afficher-vue-liste-simulations',\u00a0methods=['GET'])\ndef\u00a0afficher_vue_liste_simulations()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0afficher-vue-liste_erreurs\n@app.route('/afficher-vue-liste-erreurs',\u00a0methods=['GET'])\ndef\u00a0afficher_vue_liste_erreurs()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre>"},{"location":"exercice-dapplication-version-15.html#3522-les-nouveaux-controleurs","title":"35.2.2. Les nouveaux contr\u00f4leurs","text":"<p>Le contr\u00f4leur [AfficherVueAuthentificationController] ex\u00e9cute l\u2019action ASV [/afficher-vue-authentification]\u00a0:</p> <pre><code>from\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\n\nclass\u00a0AfficherVueAuthentificationController(InterfaceController):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0params\u00a0=\u00a0request.path.split('/')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0action\u00a0=\u00a0params[1]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0changement\u00a0de\u00a0vue\u00a0-\u00a0juste\u00a0un\u00a0code\u00a0d'\u00e9tat\u00a0\u00e0\u00a0positionner\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a01100,\u00a0\"r\u00e9ponse\":\u00a0\"\"},\u00a0status.HTTP_200_OK\n</code></pre> <p>On a dit que les actions ASV n\u2019avaient aucun param\u00e8tre et ne modifiaient pas l\u2019\u00e9tat de l\u2019application. On se contente d\u2019afficher la vue souhait\u00e9e en positionnant, ligne 14, un code d\u2019\u00e9tat.</p> <p>Le contr\u00f4leur [AfficherVueCalculImpotController] ex\u00e9cute l\u2019action ASV [/afficher-vue-calcul-impot]\u00a0:</p> <pre><code>from\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\n\nclass\u00a0AfficherVueCalculImpotController(InterfaceController):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0params\u00a0=\u00a0request.path.split('/')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0action\u00a0=\u00a0params[1]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0changement\u00a0de\u00a0vue\u00a0-\u00a0juste\u00a0un\u00a0code\u00a0d'\u00e9tat\u00a0\u00e0\u00a0positionner\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a01400,\u00a0\"r\u00e9ponse\":\u00a0\"\"},\u00a0status.HTTP_200_OK\n</code></pre> <p>Le contr\u00f4leur [AfficherVueListeSimulationsController] ex\u00e9cute l\u2019action ASV [/afficher-vue-liste-simulations]\u00a0:</p> <pre><code>from\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\n\nclass\u00a0AfficherVueListeSimulationsController(InterfaceController):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0params\u00a0=\u00a0request.path.split('/')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0action\u00a0=\u00a0params[1]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0changement\u00a0de\u00a0vue\u00a0-\u00a0juste\u00a0un\u00a0code\u00a0d'\u00e9tat\u00a0\u00e0\u00a0positionner\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a01200,\u00a0\"r\u00e9ponse\":\u00a0\"\"},\u00a0status.HTTP_200_OK\n</code></pre> <p>Le contr\u00f4leur [AfficherVueListeErreursController] ex\u00e9cute l\u2019action ASV [/afficher-vue-liste-erreurs]\u00a0:</p> <pre><code>from\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\n\nclass\u00a0AfficherVueListeErreursController(InterfaceController):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0params\u00a0=\u00a0request.path.split('/')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0action\u00a0=\u00a0params[1]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0changement\u00a0de\u00a0vue\u00a0-\u00a0juste\u00a0un\u00a0code\u00a0d'\u00e9tat\u00a0\u00e0\u00a0positionner\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a01300,\u00a0\"r\u00e9ponse\":\u00a0\"\"},\u00a0status.HTTP_200_OK\n</code></pre> <p>R\u00e9sumons les codes d\u2019\u00e9tat\u00a0:</p> <ul> <li>le code 1100 doit afficher la vue d\u2019authentification\u00a0;</li> <li>le code 1400 doit afficher la vue du calcul de l\u2019imp\u00f4t\u00a0;</li> <li>le code 1200 doit afficher la vue des simulations\u00a0;</li> <li>le code 1300 doit afficher la vue des erreurs inattendues\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-15.html#3523-la-nouvelle-configuration-mvc","title":"35.2.3. La nouvelle configuration MVC","text":"<p>Parce qu\u2019elle devenait trop importante, la configuration MVC a \u00e9t\u00e9 \u00e9clat\u00e9e sur quatre fichiers\u00a0:</p> <ul> <li>[controllers]\u00a0: la liste des contr\u00f4leurs C de l\u2019application MVC\u00a0;</li> <li>[ads_actions]\u00a0: liste les actions ADS (Action Do Something)\u00a0;</li> <li>[asv_actions]\u00a0: liste les actions ASV (Action Show View)\u00a0;</li> <li>[responses]\u00a0: liste les classes des r\u00e9ponses HTTP de l\u2019application\u00a0; Commen\u00e7ons par le plus simple, le fichier des r\u00e9ponses HTTP [responses]\u00a0:</li> </ul> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\u00a0MVC\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0r\u00e9ponses\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0from\u00a0HtmlResponse\u00a0import\u00a0HtmlResponse\n\u00a0\u00a0\u00a0\u00a0from\u00a0JsonResponse\u00a0import\u00a0JsonResponse\n\u00a0\u00a0\u00a0\u00a0from\u00a0XmlResponse\u00a0import\u00a0XmlResponse\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0diff\u00e9rents\u00a0types\u00a0de\u00a0r\u00e9ponse\u00a0(json,\u00a0xml,\u00a0html)\n\u00a0\u00a0\u00a0\u00a0responses\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"json\":\u00a0JsonResponse(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"html\":\u00a0HtmlResponse(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"xml\":\u00a0XmlResponse()\n\u00a0\u00a0\u00a0\u00a0}\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0dictionnaire\u00a0des\u00a0r\u00e9ponses\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0return\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9ponses\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"responses\":\u00a0responses,\n\u00a0\u00a0\u00a0\u00a0}\n</code></pre> <p>Pas de surprise.</p> <p>Le fichier [controllers] des contr\u00f4leurs est \u00e9galement sans surprise. On y a simplement ajout\u00e9 les nouveaux contr\u00f4leurs des actions ASV.</p> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\u00a0MVC\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0contr\u00f4leur\u00a0principal\n\u00a0\u00a0\u00a0\u00a0from\u00a0MainController\u00a0import\u00a0MainController\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0contr\u00f4leurs\u00a0d'actions\u00a0ADS\n\u00a0\u00a0\u00a0\u00a0from\u00a0AuthentifierUtilisateurController\u00a0import\u00a0AuthentifierUtilisateurController\n\u00a0\u00a0\u00a0\u00a0from\u00a0CalculerImpotController\u00a0import\u00a0CalculerImpotController\n\u00a0\u00a0\u00a0\u00a0from\u00a0CalculerImpotsController\u00a0import\u00a0CalculerImpotsController\n\u00a0\u00a0\u00a0\u00a0from\u00a0FinSessionController\u00a0import\u00a0FinSessionController\n\u00a0\u00a0\u00a0\u00a0from\u00a0GetAdminDataController\u00a0import\u00a0GetAdminDataController\n\u00a0\u00a0\u00a0\u00a0from\u00a0InitSessionController\u00a0import\u00a0InitSessionController\n\u00a0\u00a0\u00a0\u00a0from\u00a0ListerSimulationsController\u00a0import\u00a0ListerSimulationsController\n\u00a0\u00a0\u00a0\u00a0from\u00a0SupprimerSimulationController\u00a0import\u00a0SupprimerSimulationController\n\u00a0\u00a0\u00a0\u00a0from\u00a0AfficherCalculImpotController\u00a0import\u00a0AfficherCalculImpotController\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0contr\u00f4leurs\u00a0d'actions\u00a0ASV\n\u00a0\u00a0\u00a0\u00a0from\u00a0AfficherVueCalculImpotController\u00a0import\u00a0AfficherVueCalculImpotController\n\u00a0\u00a0\u00a0\u00a0from\u00a0AfficherVueAuthentificationController\u00a0import\u00a0AfficherVueAuthentificationController\n\u00a0\u00a0\u00a0\u00a0from\u00a0AfficherVueListeErreursController\u00a0import\u00a0AfficherVueListeErreursController\n\u00a0\u00a0\u00a0\u00a0from\u00a0AfficherVueListeSimulationsController\u00a0import\u00a0AfficherVueListeSimulationsController\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0autoris\u00e9es\u00a0et\u00a0leurs\u00a0contr\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0controllers\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0initialisation\u00a0d'une\u00a0session\u00a0de\u00a0calcul\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"init-session\":\u00a0InitSessionController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0authentification\u00a0d'un\u00a0utilisateur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"authentifier-utilisateur\":\u00a0AuthentifierUtilisateurController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0lien\u00a0vers\u00a0vue\u00a0calcul\u00a0impot\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"afficher-calcul-impot\":\u00a0AfficherCalculImpotController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0en\u00a0mode\u00a0individuel\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"calculer-impot\":\u00a0CalculerImpotController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0en\u00a0mode\u00a0lots\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"calculer-impots\":\u00a0CalculerImpotsController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0liste\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"lister-simulations\":\u00a0ListerSimulationsController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0suppression\u00a0d'une\u00a0simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"supprimer-simulation\":\u00a0SupprimerSimulationController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fin\u00a0de\u00a0la\u00a0session\u00a0de\u00a0calcul\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"fin-session\":\u00a0FinSessionController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0obtention\u00a0des\u00a0donn\u00e9es\u00a0de\u00a0l'administration\u00a0fiscale\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"get-admindata\":\u00a0GetAdminDataController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0main\u00a0controller\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"main-controller\":\u00a0MainController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0de\u00a0la\u00a0vue\u00a0d'authentification\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"afficher-vue-authentification\":\u00a0AfficherVueAuthentificationController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0de\u00a0la\u00a0vue\u00a0de\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"afficher-vue-calcul-impot\":\u00a0AfficherVueCalculImpotController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0de\u00a0la\u00a0vue\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"afficher-vue-liste-simulations\":\u00a0AfficherVueListeSimulationsController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0de\u00a0la\u00a0vue\u00a0des\u00a0erreurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"afficher-vue-liste-erreurs\":\u00a0AfficherVueListeErreursController()\n\u00a0\u00a0\u00a0\u00a0}\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\u00a0des\u00a0contr\u00f4eleurs\n\u00a0\u00a0\u00a0\u00a0return\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0contr\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"controllers\":\u00a0controllers,\n\u00a0\u00a0\u00a0\u00a0}\n</code></pre> <p>La configuration [asv_actions] des actions ASV est la suivante\u00a0:</p> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\u00a0MVC\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0vues\u00a0HTML\u00a0et\u00a0leurs\u00a0mod\u00e8les\u00a0d\u00e9pendent\u00a0de\u00a0l'\u00e9tat\u00a0rendu\u00a0par\u00a0le\u00a0contr\u00f4leur\n\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0ASV\u00a0(Action\u00a0Show\u00a0view)\n\u00a0\u00a0\u00a0\u00a0asv\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0d'authentification\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a01100,\u00a0\u00a0#\u00a0/afficher-vue-authentification\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-authentification.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a01400,\u00a0\u00a0#\u00a0/afficher-vue-calcul-impot\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-calcul-impot.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0de\u00a0la\u00a0liste\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a01200,\u00a0\u00a0#\u00a0/afficher-vue-liste-simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-liste-simulations.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0de\u00a0la\u00a0liste\u00a0des\u00a0erreurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a01300,\u00a0\u00a0#\u00a0/afficher-vue-liste-erreurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-erreurs.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\u00a0ASV\n\u00a0\u00a0\u00a0\u00a0return\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vues\u00a0et\u00a0mod\u00e8les\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"asv\":\u00a0asv,\n\u00a0\u00a0\u00a0\u00a0}\n</code></pre> <ul> <li>le fichier [asv_actions] rassemble les quatre nouvelles actions dont on rappelle le fonctionnement\u00a0:</li> <li>elles n\u2019ont aucun param\u00e8tre\u00a0;</li> <li>elles affichent une vue pr\u00e9cise dont le mod\u00e8le est en session\u00a0;</li> <li>la liste [asv] des lignes 6-35, associent une vue \u00e0 chaque action ASV\u00a0; Le fichier [ads_actions] rassemble les actions ADS\u00a0:</li> </ul> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\u00a0MVC\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0mod\u00e8les\u00a0des\u00a0vues\n\u00a0\u00a0\u00a0\u00a0from\u00a0ModelForAuthentificationView\u00a0import\u00a0ModelForAuthentificationView\n\u00a0\u00a0\u00a0\u00a0from\u00a0ModelForCalculImpotView\u00a0import\u00a0ModelForCalculImpotView\n\u00a0\u00a0\u00a0\u00a0from\u00a0ModelForErreursView\u00a0import\u00a0ModelForErreursView\n\u00a0\u00a0\u00a0\u00a0from\u00a0ModelForListeSimulationsView\u00a0import\u00a0ModelForListeSimulationsView\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0ADS\u00a0(Action\u00a0Do\u00a0Something)\n\u00a0\u00a0\u00a0\u00a0ads\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0400,\u00a0\u00a0#\u00a0/fin-session\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\u00a0action\u00a0ADS\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"to\":\u00a0\"/init-session/html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0700,\u00a0\u00a0#\u00a0/init-session\u00a0-\u00a0succ\u00e8s\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0201,\u00a0\u00a0#\u00a0/authentifier-utilisateur\u00a0\u00e9chec\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\u00a0action\u00a0ASV\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"to\":\u00a0\"/afficher-vue-authentification\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mod\u00e8le\u00a0de\u00a0la\u00a0vue\u00a0suivante\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForAuthentificationView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0200,\u00a0\u00a0#\u00a0/authentifier-utilisateur\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0300,\u00a0\u00a0#\u00a0/calculer-impot\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0301,\u00a0\u00a0#\u00a0/calculer-impot\u00a0\u00e9chec\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0800,\u00a0\u00a0#\u00a0/afficher-calcul-impot\u00a0lien\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\u00a0action\u00a0ASV\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"to\":\u00a0\"/afficher-vue-calcul-impot\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mod\u00e8le\u00a0de\u00a0la\u00a0vue\u00a0suivante\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForCalculImpotView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0500,\u00a0\u00a0#\u00a0/lister-simulations\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0600,\u00a0\u00a0#\u00a0/supprimer-simulation\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\u00a0action\u00a0ASV\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"to\":\u00a0\"/afficher-vue-liste-simulations\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mod\u00e8le\u00a0de\u00a0la\u00a0vue\u00a0suivante\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForListeSimulationsView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0des\u00a0erreurs\u00a0inattendues\n\u00a0\u00a0\u00a0\u00a0view_erreurs\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\u00a0action\u00a0ASV\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"to\":\u00a0\"/afficher-vue-liste-erreurs\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mod\u00e8le\u00a0de\u00a0la\u00a0vue\u00a0suivante\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForErreursView()\n\u00a0\u00a0\u00a0\u00a0}\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\u00a0MVC\n\u00a0\u00a0\u00a0\u00a0return\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0ADS\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"ads\":\u00a0ads,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0vue\u00a0des\u00a0erreurs\u00a0inattendues\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_erreurs\":\u00a0view_erreurs,\n\u00a0\u00a0\u00a0\u00a0}\n</code></pre> <ul> <li>lignes 11-51\u00a0: la liste des actions ADS (Action Do Something). On retrouve toutes les actions des versions pr\u00e9c\u00e9dentes. Leur fonctionnement a cependant chang\u00e9\u00a0:</li> <li>elles n\u2019affichent pas une vue V. Elles pr\u00e9parent seulement le mod\u00e8le M de cette vue V\u00a0;</li> <li>elles demandent l\u2019affichage de la vue V via une redirection vers l\u2019action ASV associ\u00e9e \u00e0 la vue V\u00a0;</li> <li>les actions ADS ne m\u00e8nent pas toutes \u00e0 une redirection vers une action ASV\u00a0: lignes 12-18, l\u2019action ADS [/fin-session] m\u00e8ne \u00e0 une redirection vers l\u2019action ADS [/init-session/html]. Pour distinguer les redirections ADS -&gt; ADS et ADS -&gt; ASV, on peut s\u2019aider du mod\u00e8le [model_for_view]. Celui-ci n\u2019existe pas pour les redirections ADS -&gt; ADS\u00a0; Le fichier [main/config] qui rassemble toutes les configurations \u00e9volue comme suit\u00a0:</li> </ul> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0du\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0import\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0config['syspath']\u00a0=\u00a0syspath.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0param\u00e9trage\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0import\u00a0parameters\n\u00a0\u00a0\u00a0\u00a0config['parameters']\u00a0=\u00a0parameters.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0la\u00a0base\u00a0de\u00a0donn\u00e9es\n\u00a0\u00a0\u00a0\u00a0import\u00a0database\n\u00a0\u00a0\u00a0\u00a0config[\"database\"]\u00a0=\u00a0database.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0import\u00a0layers\n\u00a0\u00a0\u00a0\u00a0config['layers']\u00a0=\u00a0layers.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0MVC\u00a0de\u00a0la\u00a0couche\u00a0[web]\n\u00a0\u00a0\u00a0\u00a0config['mvc']\u00a0=\u00a0{}\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0des\u00a0contr\u00f4leurs\u00a0de\u00a0la\u00a0couche\u00a0[web]\n\u00a0\u00a0\u00a0\u00a0import\u00a0controllers\n\u00a0\u00a0\u00a0\u00a0config['mvc'].update(controllers.configure(config))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0ASV\u00a0(Action\u00a0Show\u00a0View)\n\u00a0\u00a0\u00a0\u00a0import\u00a0asv_actions\n\u00a0\u00a0\u00a0\u00a0config['mvc'].update(asv_actions.configure(config))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0ADS\u00a0(Action\u00a0Do\u00a0Something)\n\u00a0\u00a0\u00a0\u00a0import\u00a0ads_actions\n\u00a0\u00a0\u00a0\u00a0config['mvc'].update(ads_actions.configure(config))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0des\u00a0r\u00e9ponses\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0import\u00a0responses\n\u00a0\u00a0\u00a0\u00a0config['mvc'].update(responses.configure(config))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre>"},{"location":"exercice-dapplication-version-15.html#3524-les-nouveaux-modeles","title":"35.2.4. Les nouveaux mod\u00e8les","text":"<p>Les mod\u00e8les vont g\u00e9n\u00e9rer une nouvelle information. Prenons par exemple, le mod\u00e8le de la vue d\u2019authentification\u00a0:</p> <pre><code>from\u00a0flask\u00a0import\u00a0Request\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0AbstractBaseModelForView\u00a0import\u00a0AbstractBaseModelForView\n\nclass\u00a0ModelForAuthentificationView(AbstractBaseModelForView):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0get_model_for_view(self,\u00a0request:\u00a0Request,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0encapsule\u00a0les\u00a0donn\u00e9es\u00a0de\u00a0la\u00a0pag\u00e9\u00a0dans\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le\u00a0=\u00a0{}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0jeton\u00a0csrf\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le['csrf_token']\u00a0=\u00a0super().get_csrftoken(config)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0possibles\u00a0\u00e0\u00a0partir\u00a0de\u00a0la\u00a0vue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le['actions_possibles']\u00a0=\u00a0[\"afficher-vue-authentification\",\u00a0\"authentifier-utilisateur\"]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0mod\u00e8le\n</code></pre> <ul> <li>la nouveaut\u00e9 est ligne 17\u00a0: chaque mod\u00e8le va g\u00e9n\u00e9rer une liste d\u2019actions possibles lorsque la vue V dont il est le mod\u00e8le M va s\u2019afficher. Pour conna\u00eetre ces actions, il faut revenir \u00e0 la vue V. Dans le cas de la vue d\u2019authentification\u00a0:</li> </ul> <p></p> <ul> <li>on voit que la vue d\u2019authentification n\u2019offre qu\u2019une action, celle du bouton [Valider]. Cette action est [/authentifier-utilisateur]\u00a0; On a \u00e9crit\u00a0:</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0possibles\u00a0\u00e0\u00a0partir\u00a0de\u00a0la\u00a0vue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le['actions_possibles']\u00a0=\u00a0[\"afficher-vue-authentification\",\u00a0\"authentifier-utilisateur\"]\n</code></pre> <p>Sur la vue ci-dessus, on voit que si l\u2019utilisateur rafra\u00eechit la vue, l\u2019action [1] [/afficher-vue-authentification] va \u00eatre rejou\u00e9e. Il faut donc qu\u2019elle soit autoris\u00e9e. On n\u2019aurait pu ne pas l\u2019autoriser auquel cas l\u2019utilisateur aurait une erreur \u00e0 chaque fois qu\u2019il rechargerait la page. On a estim\u00e9 que ce n\u2019\u00e9tait pas souhaitable.</p> <p>Les actions possibles sont mis dans le mod\u00e8le de la vue. On sait que ce mod\u00e8le va \u00eatre mis en session.</p> <p>On fait cela pour chacune des quatre vues. Les actions possibles sont alors les suivantes\u00a0:</p> <p>Vue d\u2019authentification</p> <pre><code>mod\u00e8le['actions_possibles']\u00a0=\u00a0[\"afficher-vue-authentification\",\u00a0\"authentifier-utilisateur\"]\n</code></pre> <p>Vue du calcul de l\u2019imp\u00f4t</p> <pre><code>#\u00a0actions\u00a0possibles\u00a0\u00e0\u00a0partir\u00a0de\u00a0la\u00a0vue\nmod\u00e8le['actions_possibles']\u00a0=\u00a0[\"afficher-vue-calcul-impot\",\u00a0\"calculer-impot\",\u00a0\"lister-simulations\",\"fin-session\"]\n</code></pre> <p>Vue de la liste des simulations</p> <pre><code>#\u00a0actions\u00a0possibles\u00a0\u00e0\u00a0partir\u00a0de\u00a0la\u00a0vue\nactions_possibles\u00a0=\u00a0[\"afficher-vue-liste-simulations\",\u00a0\"afficher-calcul-impot\",\u00a0\"fin-session\"]\nif\u00a0len(mod\u00e8le['simulations'])\u00a0!=\u00a00:\n\u00a0\u00a0actions_possibles.append(\"supprimer-simulation\")\nmod\u00e8le['actions_possibles']\u00a0=\u00a0actions_possibles\n</code></pre> <p>Vue de la liste des erreurs</p> <pre><code>#\u00a0actions\u00a0possibles\u00a0\u00e0\u00a0partir\u00a0de\u00a0la\u00a0vue\nmod\u00e8le['actions_possibles']\u00a0=\u00a0[\"afficher-vue-liste-erreurs\",\u00a0\"afficher-calcul-impot\",\u00a0\"lister-simulations\", \"fin-session\"]\n</code></pre>"},{"location":"exercice-dapplication-version-15.html#3525-le-nouveau-controleur-principal","title":"35.2.5. Le nouveau contr\u00f4leur principal","text":"<p>Le contr\u00f4leur [MainController] subit quelques modifications\u00a0:</p> <pre><code>#\u00a0import\u00a0des\u00a0d\u00e9pendances\nimport\u00a0threading\nimport\u00a0time\nfrom\u00a0random\u00a0import\u00a0randint\n\nfrom\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0flask_wtf.csrf\u00a0import\u00a0generate_csrf,\u00a0validate_csrf\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\nfrom\u00a0wtforms\u00a0import\u00a0ValidationError\n\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\nfrom\u00a0Logger\u00a0import\u00a0Logger\nfrom\u00a0SendAdminMail\u00a0import\u00a0SendAdminMail\n\ndef\u00a0send_adminmail(config:\u00a0dict,\u00a0message:\u00a0str):\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0un\u00a0mail\u00a0\u00e0\u00a0l'administrateur\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0config_mail\u00a0=\u00a0config['parameters']['adminMail']\n\u00a0\u00a0\u00a0\u00a0config_mail[\"logger\"]\u00a0=\u00a0config['logger']\n\u00a0\u00a0\u00a0\u00a0SendAdminMail.send(config_mail,\u00a0message)\n\n#\u00a0contr\u00f4leur\u00a0principal\u00a0de\u00a0l'application\nclass\u00a0MainController(InterfaceController):\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0traite\u00a0la\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response1\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0params\u00a0=\u00a0request.path.split('/')\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0l'action\u00a0est\u00a0le\u00a01er\u00a0\u00e9l\u00e9ment\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0action\u00a0=\u00a0params[1]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0logger\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0logger\u00a0=\u00a0Logger(config['parameters']['logsFilename'])\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0l'action\u00a0/afficher-vue-liste-erreurs\u00a0est\u00a0particuli\u00e8re\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ne\u00a0fait\u00a0aucune\u00a0v\u00e9rification,\u00a0sinon\u00a0on\u00a0risque\u00a0d'entrer\u00a0dans\u00a0une\u00a0boucle\u00a0infinie\u00a0de\u00a0redirections\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0action\u00a0!=\u00a0\"afficher-vue-liste-erreurs\":\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0si\u00a0erreur,\u00a0(r\u00e9sultat]\u00a0est\u00a0le\u00a0r\u00e9sultat\u00a0\u00e0\u00a0envoyer\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0(erreur,\u00a0r\u00e9sultat,\u00a0type_response1)\u00a0=\u00a0MainController.check_action(params,\u00a0session,\u00a0config)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0si\u00a0pas\u00a0d'erreur\u00a0-\u00a0l'action\u00a0est\u00a0ex\u00e9cut\u00e9e\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0controller\u00a0=\u00a0config['mvc']['controllers'][action]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat,\u00a0status_code\u00a0=\u00a0controller.execute(request,\u00a0session,\u00a0config)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0except\u00a0BaseException\u00a0as\u00a0exception:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0exceptions\u00a0(inattendues)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0131,\u00a0\"r\u00e9ponse\":\u00a0[f\"{exception}\"]}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0finally:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0erreur\u00a0d'ex\u00e9cution\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0erreur:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0requ\u00eate\u00a0erron\u00e9e\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0status_code\u00a0=\u00a0status.HTTP_400_BAD_REQUEST\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0config['parameters']['with_csrftoken']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ajoute\u00a0le\u00a0csrf_token\u00a0au\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat['csrf_token']\u00a0=\u00a0generate_csrf()\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026.\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0la\u00a0r\u00e9ponse\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0response,\u00a0status_code\n\n\u00a0\u00a0\u00a0\u00a0@staticmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0check_action(params:\u00a0list,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(bool,\u00a0dict,\u00a0str):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9sultat\u00a0de\u00a0la\u00a0m\u00e9thode\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0erreur,\u00a0r\u00e9sultat,\u00a0type_response1\n</code></pre> <ul> <li>lignes 39-44\u00a0: les premi\u00e8res v\u00e9rifications sont faites sur l\u2019action. Nous y reviendrons. La m\u00e9thode statique [MainController.check_action]  rend un tuple de trois \u00e9l\u00e9ments\u00a0:</li> <li>[erreur]\u00a0: True si une erreur a \u00e9t\u00e9 d\u00e9tect\u00e9e, False sinon\u00a0;</li> <li>[r\u00e9sultat]\u00a0: un r\u00e9sultat d\u2019erreur si (erreur==True), None sinon\u00a0;</li> <li>[type_response1]\u00a0: le type (json, xml, html, None) de la session, type trouv\u00e9 en session\u00a0;</li> <li>ligne 39\u00a0: aucune v\u00e9rification n\u2019est faite si l\u2019action est l\u2019action ASV [afficher-vue-liste-erreurs] qui va afficher la liste des erreurs. En effet, si une erreur \u00e9tait trouv\u00e9e lors de cette action, on serait dirig\u00e9 de nouveau vers l\u2019action [/afficher-vue-liste-erreurs] et on entrerait dans une boucle infinie de redirections\u00a0;</li> <li> <p>la m\u00e9thode statique [check_action] est la suivante\u00a0: <pre><code>\u00a0\u00a0\u00a0\u00a0@staticmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0check_action(params:\u00a0list,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(bool,\u00a0dict,\u00a0str):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0l'action\u00a0en\u00a0cours\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0action\u00a0=\u00a0params[1]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pas\u00a0d'erreur\u00a0et\u00a0de\u00a0r\u00e9sultat\u00a0au\u00a0d\u00e9part\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0None\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0type\u00a0de\u00a0session\u00a0doit\u00a0\u00eatre\u00a0connu\u00a0avant\u00a0certaines\u00a0actions\u00a0ADS\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0type_response1\u00a0=\u00a0session.get('typeResponse')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0type_response1\u00a0is\u00a0None\u00a0and\u00a0action\u00a0!=\u00a0\"init-session\":\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0101,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"r\u00e9ponse\":\u00a0[\"pas\u00a0de\u00a0session\u00a0en\u00a0cours.\u00a0Commencer\u00a0par\u00a0action\u00a0[init-session]\"]}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pour\u00a0certaines\u00a0actions\u00a0ADS\u00a0on\u00a0doit\u00a0\u00eatre\u00a0authentifi\u00e9\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0user\u00a0=\u00a0session.get('user')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0user\u00a0is\u00a0None\u00a0and\u00a0action\u00a0not\u00a0in\u00a0[\"init-session\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"authentifier-utilisateur\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"afficher-vue-authentification\"]:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0101,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"r\u00e9ponse\":\u00a0[f\"action\u00a0[{action}]\u00a0demand\u00e9e\u00a0par\u00a0utilisateur\u00a0non\u00a0authentifi\u00e9\"]}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e0\u00a0partir\u00a0d'une\u00a0vue\u00a0seules\u00a0certaines\u00a0actions\u00a0sont\u00a0possibles\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0erreur\u00a0and\u00a0action\u00a0!=\u00a0\"init-session\":\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pour\u00a0l'instant\u00a0pas\u00a0d'actions\u00a0possibles\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0actions_possibles\u00a0=\u00a0None\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0le\u00a0mod\u00e8le\u00a0de\u00a0la\u00a0future\u00a0vue\u00a0en\u00a0session\u00a0s'il\u00a0existe\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le\u00a0=\u00a0session.get('mod\u00e8le')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0si\u00a0on\u00a0a\u00a0trouv\u00e9\u00a0un\u00a0mod\u00e8le,\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0ses\u00a0actions\u00a0possibles\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0mod\u00e8le:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0actions_possibles\u00a0=\u00a0mod\u00e8le.get('actions_possibles')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0si\u00a0on\u00a0a\u00a0une\u00a0liste\u00a0d'actions\u00a0possibles,\u00a0on\u00a0v\u00e9rifie\u00a0que\u00a0l'action\u00a0en\u00a0cours\u00a0en\u00a0fait\u00a0partie\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0actions_possibles\u00a0and\u00a0action\u00a0not\u00a0in\u00a0actions_possibles:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0151,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"r\u00e9ponse\":\u00a0[f\"action\u00a0[{action}]\u00a0incorrecte\u00a0dans\u00a0l'environnement\u00a0actuel\"]}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0erreur\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0erreur\u00a0and\u00a0config['parameters']['with_csrftoken']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0v\u00e9rifie\u00a0la\u00a0validit\u00e9\u00a0du\u00a0token\u00a0csrf\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0csrf_token\u00a0est\u00a0le\u00a0dernier\u00a0\u00e9l\u00e9ment\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrf_token\u00a0=\u00a0params.pop()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0try:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0une\u00a0exception\u00a0sera\u00a0lanc\u00e9e\u00a0si\u00a0le\u00a0csrf_token\u00a0n'est\u00a0pas\u00a0valide\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0validate_csrf(csrf_token)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0except\u00a0ValidationError\u00a0as\u00a0exception:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0csrf\u00a0token\u00a0invalide\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat\u00a0=\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0121,\u00a0\"r\u00e9ponse\":\u00a0[f\"{exception}\"]}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0l'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreur\u00a0=\u00a0True\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9sultat\u00a0de\u00a0la\u00a0m\u00e9thode\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0erreur,\u00a0r\u00e9sultat,\u00a0type_response1\n</code></pre></p> </li> <li> <p>ligne 2\u00a0: la m\u00e9thode [check_action] fait plusieurs v\u00e9rifications sur la validit\u00e9 de l\u2019action en cours\u00a0;</p> </li> <li>lignes 6-26, 45-57\u00a0: les versions pr\u00e9c\u00e9dentes faisaient d\u00e9j\u00e0 ces v\u00e9rifications\u00a0;</li> <li>lignes 28-42\u00a0: on ajoute une nouvelle v\u00e9rification. On v\u00e9rifie si l\u2019action en cours est possible dans l\u2019\u00e9tat actuel de l\u2019application. Si l\u2019action en cours n\u2019est pas possible, on g\u00e9n\u00e8re un \u00e9tat 151 (ligne 40) qui nous assure que l\u2019action actuelle va \u00eatre redirig\u00e9e vers la vue des erreurs inattendues\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-15.html#3526-la-nouvelle-reponse-html","title":"35.2.6. La nouvelle r\u00e9ponse HTML","text":"<p>Les modifications en cours ne concernent que les sessions HTML. Les sessions jSON ou XML ne sont pas impact\u00e9es. La classe [HtmlResponse] \u00e9volue de la fa\u00e7on suivante\u00a0:</p> <pre><code>#\u00a0d\u00e9pendances\n\nfrom\u00a0flask\u00a0import\u00a0make_response,\u00a0redirect,\u00a0render_template\nfrom\u00a0flask.wrappers\u00a0import\u00a0Response\nfrom\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0flask_wtf.csrf\u00a0import\u00a0generate_csrf\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceResponse\u00a0import\u00a0InterfaceResponse\n\nclass\u00a0HtmlResponse(InterfaceResponse):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0build_http_response(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0status_code:\u00a0int,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0(Response,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0r\u00e9ponse\u00a0HTML\u00a0d\u00e9pend\u00a0du\u00a0code\u00a0d'\u00e9tat\u00a0rendu\u00a0par\u00a0le\u00a0contr\u00f4leur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00e9tat\u00a0=\u00a0r\u00e9sultat[\"\u00e9tat\"]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0cherche\u00a0si\u00a0l'\u00e9tat\u00a0a\u00a0\u00e9t\u00e9\u00a0produit\u00a0par\u00a0une\u00a0action\u00a0ASV\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0auquel\u00a0cas,\u00a0il\u00a0faut\u00a0afficher\u00a0une\u00a0vue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0asv_configs\u00a0=\u00a0config['mvc'][\"asv\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0trouv\u00e9\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0i\u00a0=\u00a00\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0parcourt\u00a0la\u00a0liste\u00a0des\u00a0vues\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0nb_views\u00a0=\u00a0len(asv_configs)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0while\u00a0not\u00a0trouv\u00e9\u00a0and\u00a0i\u00a0&lt;\u00a0nb_views:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0n\u00b0\u00a0i\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0asv_config\u00a0=\u00a0asv_configs[i]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tats\u00a0associ\u00e9s\u00a0\u00e0\u00a0la\u00a0vue\u00a0n\u00b0\u00a0i\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00e9tats\u00a0=\u00a0asv_config[\"\u00e9tats\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0est-ce\u00a0que\u00a0l'\u00e9tat\u00a0cherch\u00e9\u00a0se\u00a0trouve\u00a0dans\u00a0les\u00a0\u00e9tats\u00a0associ\u00e9s\u00a0\u00e0\u00a0la\u00a0vue\u00a0n\u00b0\u00a0i\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0\u00e9tat\u00a0in\u00a0\u00e9tats:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0trouv\u00e9\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0suivante\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0i\u00a0+=\u00a01\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0trouv\u00e9\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0trouv\u00e9:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0il\u00a0s'agit\u00a0d'une\u00a0action\u00a0ASV\u00a0-\u00a0il\u00a0faut\u00a0afficher\u00a0une\u00a0vue\u00a0dont\u00a0le\u00a0mod\u00e8le\u00a0est\u00a0d\u00e9j\u00e0\u00a0en\u00a0session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0g\u00e9n\u00e8re\u00a0le\u00a0code\u00a0HTML\u00a0de\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0html\u00a0=\u00a0render_template(asv_config[\"view_name\"],\u00a0mod\u00e8le=session['mod\u00e8le'])\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0construit\u00a0la\u00a0r\u00e9ponse\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response\u00a0=\u00a0make_response(html)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response.headers['Content-Type']\u00a0=\u00a0'text/html;\u00a0charset=utf-8'\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0response,\u00a0status_code\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pas\u00a0trouv\u00e9\u00a0-\u00a0il\u00a0s'agit\u00a0d'un\u00a0code\u00a0d'\u00e9tat\u00a0d'une\u00a0action\u00a0ADS\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0celle-ci\u00a0va\u00a0\u00eatre\u00a0suivie\u00a0d'une\u00a0redirection\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0redirected\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for\u00a0ads\u00a0in\u00a0config['mvc']['ads']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tats\u00a0n\u00e9cessitant\u00a0une\u00a0redirection\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00e9tats\u00a0=\u00a0ads[\"\u00e9tats\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0\u00e9tat\u00a0in\u00a0\u00e9tats:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0il\u00a0y\u00a0a\u00a0redirection\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0redirected\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0break\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dictionnaire\u00a0de\u00a0redirection\u00a0pour\u00a0le\u00a0cas\u00a0des\u00a0erreurs\u00a0inattendues\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0redirected:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0ads\u00a0=\u00a0config['mvc']['view_erreurs']\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0est-ce\u00a0une\u00a0redirection\u00a0vers\u00a0une\u00a0action\u00a0ASD\u00a0ou\u00a0ASV\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0s'il\u00a0y\u00a0a\u00a0un\u00a0mod\u00e8le,\u00a0alors\u00a0il\u00a0s'agit\u00a0d'une\u00a0redirection\u00a0vers\u00a0une\u00a0action\u00a0ASV\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0il\u00a0faut\u00a0alors\u00a0calculer\u00a0le\u00a0mod\u00e8le\u00a0de\u00a0la\u00a0vue\u00a0V\u00a0qui\u00a0sera\u00a0affich\u00e9e\u00a0par\u00a0l'action\u00a0ASV\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0model_for_view\u00a0=\u00a0ads.get(\"model_for_view\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0model_for_view:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0du\u00a0mod\u00e8le\u00a0de\u00a0la\u00a0vue\u00a0suivante\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le\u00a0=\u00a0model_for_view.get_model_for_view(request,\u00a0session,\u00a0config,\u00a0r\u00e9sultat)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0mod\u00e8le\u00a0est\u00a0mis\u00a0en\u00a0session\u00a0pour\u00a0la\u00a0vue\u00a0suivante\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0session['mod\u00e8le']\u00a0=\u00a0mod\u00e8le\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0maintenant\u00a0il\u00a0faut\u00a0g\u00e9n\u00e9rer\u00a0l'URL\u00a0de\u00a0redirection\u00a0sans\u00a0oublier\u00a0le\u00a0jeton\u00a0CSRF\u00a0s'il\u00a0est\u00a0demand\u00e9\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0config['parameters']['with_csrftoken']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrf_token\u00a0=\u00a0f\"/{generate_csrf()}\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrf_token\u00a0=\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9ponse\u00a0de\u00a0redirection\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(f\"{ads['to']}{csrf_token}\"),\u00a0status.HTTP_302_FOUND\n</code></pre> <ul> <li>lignes 18-35\u00a0: on cherche si l\u2019\u00e9tat produit par la derni\u00e8re action ex\u00e9cut\u00e9e est celui d\u2019une action ASV\u00a0;</li> <li>lignes 36-46\u00a0: si oui, la vue V associ\u00e9e \u00e0 l\u2019action ASV est affich\u00e9e avec pour mod\u00e8le le mod\u00e8le trouv\u00e9 en session associ\u00e9 \u00e0 la cl\u00e9 [\u2018mod\u00e8le\u2019]\u00a0;</li> <li>lignes 48-60\u00a0: lorsqu\u2019on arrive l\u00e0, on sait que l\u2019\u00e9tat produit par la derni\u00e8re action ex\u00e9cut\u00e9e est celui d\u2019une action ADS. Il va alors provoquer une redirection. On cherche dans le fichier de configuration, la d\u00e9finition de celle-ci\u00a0;</li> <li>ligne 62\u00a0: lorsqu\u2019on est l\u00e0, on a la configuration de la redirection \u00e0 faire. Il y a deux cas\u00a0:</li> <li>il s\u2019agit d\u2019une redirection vers une autre action ADS. Il n\u2019y a alors pas de mod\u00e8le de vue \u00e0 calculer\u00a0;</li> <li>il s\u2019agit d\u2019une redirection vers une action ASV. Il y a alors un mod\u00e8le de vue \u00e0 calculer\u00a0(lignes 67-68). Ce mod\u00e8le est ensuite mis en session (ligne 70)\u00a0;</li> <li>lignes 72-76\u00a0: on calcule l\u2019URL de redirection\u00a0;</li> <li>lignes 78-79\u00a0: on envoie la r\u00e9ponse de redirection au client\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-15.html#353-tests","title":"35.3. Tests","text":"<p>Faites les tests suivants avec un navigateur\u00a0:</p> <ul> <li>utilisez normalement l\u2019application. V\u00e9rifiez que les seules URL affich\u00e9es par le navigateur sont des URL ASV [/afficher-vue-nom_de_la_vue]\u00a0;</li> <li>rafra\u00eechissez les pages (F5) et constatez que la m\u00eame page se r\u00e9affiche alors. Il n\u2019y a aucun effet de bord\u00a0; Par ailleurs, utilisez le client [impots/http-clients/09]. Comme les modifications faites concernent uniquement les sessions HTML, les clients [main, main2, main3, Test1HttpClientDaoWithSession, Test2HttpClientDaoWithSession] doivent continuer \u00e0 fonctionner.</li> </ul> <p>Maintenant voyons un cas d\u2019action impossible. La vue suivante est affich\u00e9e\u00a0:</p> <p></p> <p>A la place de [1], on tape l\u2019URL [/supprimer-simulation/1]. L\u2019action [/supprimer-simulation] ne fait pas partie des actions propos\u00e9es par la vue qui sont les actions 1-4. Elle va donc \u00eatre refus\u00e9e. La r\u00e9ponse du serveur est la suivante\u00a0:</p> <p></p>"},{"location":"exercice-dapplication-version-16.html","title":"36. Exercice d\u2019application\u00a0: version 16","text":""},{"location":"exercice-dapplication-version-16.html#361-introduction","title":"36.1. Introduction","text":"<p>Les URL de notre application sont pour l\u2019instant de la forme [/action/param1/param2/\u2026]. Nous voudrions pouvoir pr\u00e9fixer ces URL. Par exemple avec le pr\u00e9fixe [/do], nous aurions des URL de la forme [/do/action/param1/param2/\u2026].</p>"},{"location":"exercice-dapplication-version-16.html#362-la-nouvelle-configuration-des-routes","title":"36.2. La nouvelle configuration des routes","text":"<ul> <li>en [2], le calcul des routes va \u00eatre modifi\u00e9\u00a0;</li> <li>en [1], le fichier [config] est modifi\u00e9 pour refl\u00e9ter ce changement\u00a0; La configuration [config] devient la suivante\u00a0:</li> </ul> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0du\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0import\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0config['syspath']\u00a0=\u00a0syspath.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0param\u00e9trage\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0import\u00a0parameters\n\u00a0\u00a0\u00a0\u00a0config['parameters']\u00a0=\u00a0parameters.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0la\u00a0base\u00a0de\u00a0donn\u00e9es\n\u00a0\u00a0\u00a0\u00a0import\u00a0database\n\u00a0\u00a0\u00a0\u00a0config[\"database\"]\u00a0=\u00a0database.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0import\u00a0layers\n\u00a0\u00a0\u00a0\u00a0config['layers']\u00a0=\u00a0layers.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0MVC\u00a0de\u00a0la\u00a0couche\u00a0[web]\n\u00a0\u00a0\u00a0\u00a0config['mvc']\u00a0=\u00a0{}\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0des\u00a0contr\u00f4leurs\u00a0de\u00a0la\u00a0couche\u00a0[web]\n\u00a0\u00a0\u00a0\u00a0import\u00a0controllers\n\u00a0\u00a0\u00a0\u00a0config['mvc'].update(controllers.configure(config))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0ASV\u00a0(Action\u00a0Show\u00a0View)\n\u00a0\u00a0\u00a0\u00a0import\u00a0asv_actions\n\u00a0\u00a0\u00a0\u00a0config['mvc'].update(asv_actions.configure(config))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0ADS\u00a0(Action\u00a0Do\u00a0Something)\n\u00a0\u00a0\u00a0\u00a0import\u00a0ads_actions\n\u00a0\u00a0\u00a0\u00a0config['mvc'].update(ads_actions.configure(config))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0des\u00a0r\u00e9ponses\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0import\u00a0responses\n\u00a0\u00a0\u00a0\u00a0config['mvc'].update(responses.configure(config))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0des\u00a0routes\n\u00a0\u00a0\u00a0\u00a0import\u00a0routes\n\u00a0\u00a0\u00a0\u00a0routes.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <ul> <li>lignes 37-39\u00a0: le module [routes] (ligne 38) s\u2019occupe de configurer les routes (ligne 39)\u00a0; Le fichier des routes sans jeton CSRF [configs/routes_without_csrftoken] \u00e9volue de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code>#\u00a0d\u00e9pendances\n\nfrom\u00a0flask\u00a0import\u00a0redirect,\u00a0request,\u00a0session,\u00a0url_for\nfrom\u00a0flask_api\u00a0import\u00a0status\n\n#\u00a0configuration\u00a0application\nconfig\u00a0=\u00a0{}\n\n#\u00a0le\u00a0front\u00a0controller\ndef\u00a0front_controller()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fait\u00a0suivre\u00a0la\u00a0requ\u00eate\u00a0au\u00a0contr\u00f4leur\u00a0principal\n\u00a0\u00a0\u00a0\u00a0main_controller\u00a0=\u00a0config['mvc']['controllers']['main-controller']\n\u00a0\u00a0\u00a0\u00a0return\u00a0main_controller.execute(request,\u00a0session,\u00a0config)\n\n#\u00a0racine\u00a0de\u00a0l'application\ndef\u00a0index()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\u00a0/init-session/html\n\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(url_for(\"init_session\",\u00a0type_response=\"html\"),\u00a0status.HTTP_302_FOUND)\n\n#\u00a0init-session\ndef\u00a0init_session(type_response:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0authentifier-utilisateur\ndef\u00a0authentifier_utilisateur()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0calculer-impot\ndef\u00a0calculer_impot()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n\u2026\n</code></pre> <p>Le fichier a \u00e9t\u00e9 d\u00e9barrass\u00e9 de ses routes. Il ne reste que les fonctions associ\u00e9es \u00e0 celles-ci.</p> <p>Les fichier des routes avec jeton CSRF [configs/routes_with_csrftoken] subit le m\u00eame sort\u00a0:</p> <pre><code>#\u00a0d\u00e9pendances\n\nfrom\u00a0flask\u00a0import\u00a0redirect,\u00a0request,\u00a0session,\u00a0url_for\nfrom\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0flask_wtf.csrf\u00a0import\u00a0generate_csrf\n\n#\u00a0configuration\nconfig\u00a0=\u00a0{}\n\n#\u00a0le\u00a0front\u00a0controller\ndef\u00a0front_controller()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fait\u00a0suivre\u00a0la\u00a0requ\u00eate\u00a0au\u00a0contr\u00f4leur\u00a0principal\n\u00a0\u00a0\u00a0\u00a0main_controller\u00a0=\u00a0config['mvc']['controllers']['main-controller']\n\u00a0\u00a0\u00a0\u00a0return\u00a0main_controller.execute(request,\u00a0session,\u00a0config)\n\n#\u00a0racine\u00a0de\u00a0l'application\ndef\u00a0index()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\u00a0/init-session/html\n\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(url_for(\"init_session\",\u00a0type_response=\"html\",\u00a0csrf_token=generate_csrf()),\u00a0status.HTTP_302_FOUND)\n\n#\u00a0init-session\ndef\u00a0init_session(type_response:\u00a0str,\u00a0csrf_token:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n#\u00a0authentifier-utilisateur\ndef\u00a0authentifier_utilisateur(csrf_token:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n\n\u2026\n\n#\u00a0init-session-without-csrftoken\u00a0pour\u00a0les\u00a0clients\u00a0json\u00a0et\u00a0xml\ndef\u00a0init_session_without_csrftoken(type_response:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\u00a0/init-session/type_response\n\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(url_for(\"init_session\",\u00a0type_response=type_response,\u00a0csrf_token=generate_csrf()),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0status.HTTP_302_FOUND)\n</code></pre> <p>Les routes sont calcul\u00e9es par le module [configs/routes] suivant\u00a0:</p> <pre><code>from\u00a0flask\u00a0import\u00a0Flask\n\ndef\u00a0configure(config:\u00a0dict):\n\u00a0\u00a0\u00a0\u00a0#\u00a0param\u00e9trage\u00a0des\u00a0routes\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0application\u00a0Flask\n\u00a0\u00a0\u00a0\u00a0app\u00a0=\u00a0Flask(__name__,\u00a0template_folder=\"../flask/templates\",\u00a0static_folder=\"../flask/static\")\n\u00a0\u00a0\u00a0\u00a0config['app']\u00a0=\u00a0app\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0import\u00a0des\u00a0routes\u00a0de\u00a0l'application\u00a0web\n\u00a0\u00a0\u00a0\u00a0if\u00a0config['parameters']['with_csrftoken']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0import\u00a0routes_with_csrftoken\u00a0as\u00a0routes\n\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0import\u00a0routes_without_csrftoken\u00a0as\u00a0routes\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0injecte\u00a0la\u00a0configuration\u00a0dans\u00a0les\u00a0routes\n\u00a0\u00a0\u00a0\u00a0routes.config\u00a0=\u00a0config\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0pr\u00e9fixe\u00a0des\u00a0URL\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0prefix_url\u00a0=\u00a0config[\"parameters\"][\"prefix_url\"]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0jeton\u00a0CSRF\n\u00a0\u00a0\u00a0\u00a0with_csrftoken\u00a0=\u00a0config[\"parameters\"]['with_csrftoken']\n\u00a0\u00a0\u00a0\u00a0if\u00a0with_csrftoken:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrftoken_param\u00a0=\u00a0f\"/&lt;string:csrf_token&gt;\"\n\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrftoken_param\u00a0=\u00a0\"\"\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0routes\u00a0de\u00a0l'application\u00a0Flask\n\u00a0\u00a0\u00a0\u00a0#\u00a0racine\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/',\u00a0methods=['GET'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.index)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0init-session\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/init-session/&lt;string:type_response&gt;{csrftoken_param}',\u00a0methods=['GET'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.init_session)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0init-session-without-csrftoken\n\u00a0\u00a0\u00a0\u00a0if\u00a0with_csrftoken:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/init-session-without-csrftoken/&lt;string:type_response&gt;',\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0methods=['GET'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.init_session_without_csrftoken)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0authentifier-utilisateur\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/authentifier-utilisateur{csrftoken_param}',\u00a0methods=['POST'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.authentifier_utilisateur)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0calculer-impot\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/calculer-impot{csrftoken_param}',\u00a0methods=['POST'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.calculer_impot)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0par\u00a0lots\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/calculer-impots{csrftoken_param}',\u00a0methods=['POST'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.calculer_impots)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0lister-simulations\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/lister-simulations{csrftoken_param}',\u00a0methods=['GET'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.lister_simulations)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0supprimer-simulation\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/supprimer-simulation/&lt;int:numero&gt;{csrftoken_param}',\u00a0methods=['GET'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.supprimer_simulation)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0fin-session\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/fin-session{csrftoken_param}',\u00a0methods=['GET'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.fin_session)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0afficher-calcul-impot\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/afficher-calcul-impot{csrftoken_param}',\u00a0methods=['GET'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.afficher_calcul_impot)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0get-admindata\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/get-admindata{csrftoken_param}',\u00a0methods=['GET'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.get_admindata)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0afficher-vue-calcul-impot\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/afficher-vue-calcul-impot{csrftoken_param}',\u00a0methods=['GET'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.afficher_vue_calcul_impot)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0afficher-vue-authentification\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/afficher-vue-authentification{csrftoken_param}',\u00a0methods=['GET'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.afficher_vue_authentification)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0afficher-vue-liste-simulations\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/afficher-vue-liste-simulations{csrftoken_param}',\u00a0methods=['GET'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.afficher_vue_liste_simulations)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0afficher-vue-liste_erreurs\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/afficher-vue-liste-erreurs{csrftoken_param}',\u00a0methods=['GET'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.afficher_vue_liste_erreurs)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0cas\u00a0particulier\n\u00a0\u00a0\u00a0\u00a0if\u00a0with_csrftoken:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0init-session-without-csrftoken\u00a0pour\u00a0les\u00a0clients\u00a0json\u00a0et\u00a0xml\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/init-session-without-csrftoken',\u00a0methods=['GET'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.init_session_without_csrftoken)\n</code></pre> <ul> <li>lignes 6-8\u00a0: l\u2019application Flask est cr\u00e9\u00e9e et mise dans la configuration\u00a0;</li> <li>lignes 10-14\u00a0: on importe le fichier de routes qui convient \u00e0 la situation. On se rappelle que le fichier import\u00e9 est en fait d\u00e9pourvu de routes. Il ne contient que les fonctions associ\u00e9es \u00e0 celles-ci\u00a0;</li> <li>ligne 17\u00a0: les fonctions associ\u00e9es aux routes ont besoin de conna\u00eetre la configuration\u00a0de l\u2019application\u00a0;</li> <li>ligne 20\u00a0: on note le pr\u00e9fixe des URL. Celui-ci peut \u00eatre vide\u00a0;</li> <li>lignes 22-27\u00a0: les routes avec jeton CSRF ont un param\u00e8tre suppl\u00e9mentaire que celles qui n\u2019en ont pas. Pour g\u00e9rer cette diff\u00e9rence, on utilise la variable [csrftoken_param]\u00a0:</li> <li>elle contient la cha\u00eene vide s\u2019il n\u2019y a pas de jeton CSRF dans les routes\u00a0;</li> <li>elle contient la cha\u00eene [/&lt;string:csrf_token&gt;] s\u2019il y a un jeton CSRF\u00a0;</li> <li>lignes 29-96\u00a0: chaque route de l\u2019application est associ\u00e9e \u00e0 une fonction du fichier des routes import\u00e9 lignes 10-14\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-16.html#363-les-nouveaux-controleurs","title":"36.3. Les nouveaux contr\u00f4leurs","text":"<p>Dans la version pr\u00e9c\u00e9dente, tous les contr\u00f4leurs obtenaient l\u2019action en cours de traitement de la fa\u00e7on suivante\u00a0:</p> <pre><code>\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0params\u00a0=\u00a0request.path.split('/')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0action\u00a0=\u00a0params[1]\n</code></pre> <p>Ce code ne fonctionne plus s\u2019il y a un pr\u00e9fixe, par exemple [/do/lister-simulations]. Dans ce cas, l\u2019action, ligne 3 serait [do] et donc serait incorrecte.</p> <p>On transforme ce code de la fa\u00e7on suivante\u00a0:</p> <pre><code>\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0prefix_url\u00a0=\u00a0config[\"parameters\"][\"prefix_url\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0params\u00a0=\u00a0request.path[len(prefix_url):].split('/')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0action\u00a0=\u00a0params[1]\n</code></pre> <p>On fait \u00e7a dans tous les contr\u00f4leurs.</p>"},{"location":"exercice-dapplication-version-16.html#364-les-nouveaux-modeles","title":"36.4. Les nouveaux mod\u00e8les","text":"<p>Dans la version pr\u00e9c\u00e9dente, chaque classe de mod\u00e8le g\u00e9n\u00e9rait un mod\u00e8le de la fa\u00e7on suivante\u00a0:</p> <pre><code>def\u00a0get_model_for_view(self,\u00a0request:\u00a0Request,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0encapsule\u00a0les\u00a0donn\u00e9es\u00a0de\u00a0la\u00a0pag\u00e9\u00a0dans\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le\u00a0=\u00a0{}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tat\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00e9tat\u00a0=\u00a0r\u00e9sultat[\"\u00e9tat\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0mod\u00e8le\u00a0d\u00e9pend\u00a0de\u00a0l'\u00e9tat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0jeton\u00a0csrf\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le['csrf_token']\u00a0=\u00a0super().get_csrftoken(config)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0possibles\u00a0\u00e0\u00a0partir\u00a0de\u00a0la\u00a0vue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le['actions_possibles']\u00a0=\u00a0[\u2026]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0mod\u00e8le\n</code></pre> <p>D\u00e9sormais le mod\u00e8le aura une cl\u00e9 suppl\u00e9mentaire, le pr\u00e9fixe des URL\u00a0:</p> <pre><code>def\u00a0get_model_for_view(self,\u00a0request:\u00a0Request,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0encapsule\u00a0les\u00a0donn\u00e9es\u00a0de\u00a0la\u00a0pag\u00e9\u00a0dans\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le\u00a0=\u00a0{}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tat\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00e9tat\u00a0=\u00a0r\u00e9sultat[\"\u00e9tat\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0mod\u00e8le\u00a0d\u00e9pend\u00a0de\u00a0l'\u00e9tat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0jeton\u00a0csrf\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le['csrf_token']\u00a0=\u00a0super().get_csrftoken(config)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0possibles\u00a0\u00e0\u00a0partir\u00a0de\u00a0la\u00a0vue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le['actions_possibles']\u00a0=\u00a0[\u2026]\n\u00a0\u00a0\u00a0\u00a0\n        #\u00a0pr\u00e9fixe\u00a0des\u00a0URL\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"prefix_url\"]\u00a0=\u00a0config[\"parameters\"][\"prefix_url\"]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0mod\u00e8le\n</code></pre>"},{"location":"exercice-dapplication-version-16.html#365-les-nouveaux-fragments","title":"36.5. Les nouveaux fragments","text":"<p>Tous les fragments contenant des URL doivent \u00eatre modifi\u00e9s.</p> <p>Le fragment [v-authentification]</p> <pre><code>&lt;!--\u00a0formulaire\u00a0HTML\u00a0-\u00a0on\u00a0poste\u00a0ses\u00a0valeurs\u00a0avec\u00a0l'action\u00a0[authentifier-utilisateur]\u00a0--&gt;\n&lt;form\u00a0method=\"post\"\u00a0action=\"{{mod\u00e8le.prefix_url}}/authentifier-utilisateur{{mod\u00e8le.csrf_token}}\"&gt;\n\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0titre\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"alert\u00a0alert-primary\"\u00a0role=\"alert\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;h4&gt;Veuillez\u00a0vous\u00a0authentifier&lt;/h4&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u2026\n\n&lt;/form&gt;\n</code></pre> <p>Le fragment [v-calcul-impot]</p> <pre><code>&lt;!--\u00a0formulaire\u00a0HTML\u00a0post\u00e9\u00a0--&gt;\n&lt;form\u00a0method=\"post\"\u00a0action=\"{{mod\u00e8le.prefix_url}}/calculer-impot{{mod\u00e8le.csrf_token}}\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0message\u00a0sur\u00a012\u00a0colonnes\u00a0sur\u00a0fond\u00a0bleu\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u2026\n\n&lt;/form&gt;\n</code></pre> <p>Le fragment [v-liste-simulations]</p> <pre><code>\u2026\n\n{%\u00a0if\u00a0mod\u00e8le.simulations\u00a0is\u00a0defined\u00a0and\u00a0mod\u00e8le.simulations|length!=0\u00a0%}\n\u2026\n\n&lt;!--\u00a0tableau\u00a0des\u00a0simulations\u00a0--&gt;\n&lt;table\u00a0class=\"table\u00a0table-sm\u00a0table-hover\u00a0table-striped\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u2026\n\u00a0\u00a0\u00a0\u00a0&lt;tr&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;th\u00a0scope=\"row\"&gt;{{simulation.id}}&lt;/th&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.mari\u00e9}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.enfants}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.salaire}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.imp\u00f4t}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.surc\u00f4te}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.d\u00e9c\u00f4te}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.r\u00e9duction}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.taux}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;&lt;a\u00a0href=\"{{mod\u00e8le.prefix_url}}/supprimer-simulation/{{simulation.id}}{{mod\u00e8le.csrf_token}}\"&gt;Supprimer&lt;/a&gt;&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/tr&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0endfor\u00a0%}\n\u00a0\u00a0\u00a0\u00a0&lt;/tr&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/tbody&gt;\n&lt;/table&gt;\n{%\u00a0endif\u00a0%}\n</code></pre> <p>Le fragment [v-menu]</p> <pre><code>&lt;!--\u00a0menu\u00a0Bootstrap\u00a0--&gt;\n&lt;nav\u00a0class=\"nav\u00a0flex-column\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0affichage\u00a0d'une\u00a0liste\u00a0de\u00a0liens\u00a0HTML\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0for\u00a0optionMenu\u00a0in\u00a0mod\u00e8le.optionsMenu\u00a0%}\n\u00a0\u00a0\u00a0\u00a0&lt;a\u00a0class=\"nav-link\"\u00a0href=\"{{mod\u00e8le.prefix_url}}{{optionMenu.url}}{{mod\u00e8le.csrf_token}}\"&gt;{{optionMenu.text}}&lt;/a&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0endfor\u00a0%}\n&lt;/nav&gt;\n</code></pre>"},{"location":"exercice-dapplication-version-16.html#366-la-nouvelle-reponse-html","title":"36.6. La nouvelle r\u00e9ponse HTML","text":"<p>Dans la pr\u00e9c\u00e9dente version le code de la r\u00e9ponse HTML se terminait par une redirection\u00a0:</p> <pre><code>class\u00a0HtmlResponse(InterfaceResponse):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0build_http_response(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0status_code:\u00a0int,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0(Response,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0r\u00e9ponse\u00a0HTML\u00a0d\u00e9pend\u00a0du\u00a0code\u00a0d'\u00e9tat\u00a0rendu\u00a0par\u00a0le\u00a0contr\u00f4leur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00e9tat\u00a0=\u00a0r\u00e9sultat[\"\u00e9tat\"]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0maintenant\u00a0il\u00a0faut\u00a0g\u00e9n\u00e9rer\u00a0l'URL\u00a0de\u00a0redirection\u00a0sans\u00a0oublier\u00a0le\u00a0jeton\u00a0CSRF\u00a0s'il\u00a0est\u00a0demand\u00e9\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0config['parameters']['with_csrftoken']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrf_token\u00a0=\u00a0f\"/{generate_csrf()}\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrf_token\u00a0=\u00a0\"\"\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9ponse\u00a0de\u00a0redirection\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(f\"{ads['to']}{csrf_token}\"),\u00a0status.HTTP_302_FOUND\n</code></pre> <p>Ce code devient maintenant le suivant\u00a0:</p> <pre><code>def\u00a0build_http_response(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0status_code:\u00a0int,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0(Response,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0maintenant\u00a0il\u00a0faut\u00a0g\u00e9n\u00e9rer\u00a0l'URL\u00a0de\u00a0redirection\u00a0sans\u00a0oublier\u00a0le\u00a0jeton\u00a0CSRF\u00a0s'il\u00a0est\u00a0demand\u00e9\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0config['parameters']['with_csrftoken']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrf_token\u00a0=\u00a0f\"/{generate_csrf()}\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrf_token\u00a0=\u00a0\"\"\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9ponse\u00a0de\u00a0redirection\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(f\"{config['parameters']['prefix_url']}{ads['to']}{csrf_token}\"),\u00a0status.HTTP_302_FOUND\n</code></pre>"},{"location":"exercice-dapplication-version-16.html#367-tests","title":"36.7. Tests","text":"<p>Mettons le pr\u00e9fixe suivant dans le fichier de configuration [parameters]\u00a0:</p> <pre><code>\u2026\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0token\u00a0csrf\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"with_csrftoken\":\u00a0True,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0bases\u00a0g\u00e9r\u00e9es\u00a0MySQL\u00a0(mysql),\u00a0PostgreSQL\u00a0(pgres)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"databases\":\u00a0[\"mysql\",\u00a0\"pgres\"],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pr\u00e9fixe\u00a0des\u00a0URL\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mettre\u00a0la\u00a0cha\u00eene\u00a0vide\u00a0si\u00a0on\u00a0ne\u00a0veut\u00a0pas\u00a0de\u00a0pr\u00e9fixe\u00a0ou\u00a0/pr\u00e9fixe\u00a0sinon\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"prefix_url\":\u00a0\"/do\",\n\u2026\n</code></pre> <p>Lan\u00e7ons l\u2019application puis demandons l\u2019URL [http://localhost:5000/do], la r\u00e9ponse est la suivante\u00a0:</p> <p></p> <ul> <li>en [1], le pr\u00e9fixe de l\u2019URL\u00a0;</li> <li>en [2], le jeton CSRF\u00a0; L\u2019application peut \u00eatre \u00e9galement test\u00e9e avec les tests console de [http-clients/09]\u00a0:</li> </ul> <p></p> <p>Dans les fichiers de configuration [1] et [2], le pr\u00e9fixe des URL doit \u00eatre inclus dans l\u2019URL du serveur\u00a0:</p> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"server\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\"urlServer\":\u00a0\"http://127.0.0.1:5000\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"urlServer\":\u00a0\"http://127.0.0.1:5000/do\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"user\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"login\":\u00a0\"admin\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"admin\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"url_services\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n</code></pre> <ul> <li>ligne 3\u00a0: l\u2019URL du serveur inclut d\u00e9sormais le pr\u00e9fixe des URL\u00a0; Cette modification faite, tous les tests console doivent fonctionner.</li> </ul>"},{"location":"exercice-dapplication-version-17.html","title":"37. Exercice d\u2019application\u00a0: version 17","text":"<p>Cette nouvelle version am\u00e8ne les \u00e9volutions suivantes\u00a0:</p> <ul> <li>elle va \u00eatre port\u00e9e sur un serveur Apache / Windows\u00a0;</li> <li>pour r\u00e9aliser ce portage, la version 17 contient toutes les d\u00e9pendances dont elle a besoin dans son dossier [impots / http-servers/ 12]. On rappelle que les versions pr\u00e9c\u00e9dentes allaient chercher leurs d\u00e9pendances dans diff\u00e9rents dossiers de l\u2019ensemble du projet [python-flask-2020]\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-17.html#371-relocalisation-des-dependances-de-lapplication","title":"37.1. Relocalisation des d\u00e9pendances de l\u2019application","text":"<p>On rappelle que la gestion des d\u00e9pendances de l\u2019application est faite dans le script [syspath]. Dans la version pr\u00e9c\u00e9dente, ce script \u00e9tait le suivant\u00a0:</p> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0de\u00a0ce\u00a0fichier\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0racine\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020\"\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossiers\u00a0du\u00a0projet\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0BaseEntity,\u00a0MyException\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/classes/02/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0InterfaceImp\u00f4tsDao,\u00a0InterfaceImp\u00f4tsM\u00e9tier,\u00a0InterfaceImp\u00f4tsUi\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AbstractImp\u00f4tsdao,\u00a0Imp\u00f4tsConsole,\u00a0Imp\u00f4tsM\u00e9tier\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ImpotsDaoWithAdminDataInDatabase\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AdminData,\u00a0Imp\u00f4tsError,\u00a0TaxPayer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Constantes,\u00a0tranches\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Logger,\u00a0SendAdminMail\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/http-servers/02/utilities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0du\u00a0script\u00a0principal\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0script_dir,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0configs\u00a0[database,\u00a0layers,\u00a0parameters,\u00a0controllers,\u00a0views]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../configs\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0contr\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../controllers\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9ponses\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../responses\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mod\u00e8les\u00a0des\u00a0vues\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../models_for_views\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fixe\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0return\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"root_dir\":\u00a0root_dir,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"script_dir\":\u00a0script_dir\n\u00a0\u00a0\u00a0\u00a0}\n</code></pre> <p>Il faut relocaliser toutes les d\u00e9pendances dont le nom absolu d\u00e9pend de la variable [root_dir] de la ligne 8, \u00e7-\u00e0-d les lignes 13-26.</p> <p>Le script [syspath] de la nouvelle version sera le suivant\u00a0:</p> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0de\u00a0ce\u00a0fichier\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0entit\u00e9s de l\u2019application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0couche\u00a0[dao]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../layers/dao\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0couche\u00a0[m\u00e9tier]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../layers/m\u00e9tier\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0utilitaires\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../utilities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0du\u00a0script\u00a0principal\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0script_dir,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0configs\u00a0[database,\u00a0layers,\u00a0parameters,\u00a0controllers,\u00a0views]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../configs\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0contr\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../controllers\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9ponses\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../responses\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mod\u00e8les\u00a0des\u00a0vues\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../models_for_views\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fixe\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0import\u00a0sys\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0lui\u00a0ajoute\u00a0les\u00a0d\u00e9pendances\u00a0absolues\u00a0du\u00a0projet\n\u00a0\u00a0\u00a0\u00a0for\u00a0directory\u00a0in\u00a0absolute_dependencies:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0v\u00e9rifie\u00a0l'existence\u00a0du\u00a0dossier\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0existe\u00a0=\u00a0os.path.exists(directory)\u00a0and\u00a0os.path.isdir(directory)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0existe:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0avertit\u00a0le\u00a0d\u00e9veloppeur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0raise\u00a0BaseException(f\"[set_syspath]\u00a0le\u00a0dossier\u00a0du\u00a0Python\u00a0Path\u00a0[{directory}]\u00a0n'existe\u00a0pas\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ins\u00e8re\u00a0le\u00a0dossier\u00a0au\u00a0d\u00e9but\u00a0du\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0sys.path.insert(0,\u00a0directory)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0return\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"script_dir\":\u00a0script_dir,\n\u00a0\u00a0\u00a0\u00a0}\n</code></pre> <ul> <li>lignes 8-27\u00a0: toutes les d\u00e9pendances sont d\u00e9sormais relatives \u00e0 la variable [script_dir] de la ligne 5\u00a0;</li> <li>lignes 42-45\u00a0: la variable [root_dir] a disparu de la configuration du syspath\u00a0;</li> <li>ligne 10\u00a0: les entit\u00e9s de l\u2019application sont dans le dossier [entities] [1] ;</li> <li>ligne 12\u00a0: la couche [dao] est dans le dossier [layers/dao] [2] ;</li> <li>ligne 14\u00a0: la couche [m\u00e9tier] est dans le dossier [layers/m\u00e9tier] [2]\u00a0;</li> <li>ligne 16\u00a0: les utilitaires [Logger, SendMail] sont dans le dossier [utilities] [3]\u00a0;</li> <li>lignes 29-40\u00a0: on calcule le Python Path de l\u2019application sans importer le module [myutils]\u00a0;</li> </ul> <p></p>"},{"location":"exercice-dapplication-version-17.html#372-tests","title":"37.2. Tests","text":"<p>A ce stade, la version 17 doit fonctionner. V\u00e9rifiez-le.</p>"},{"location":"exercice-dapplication-version-17.html#373-portage-dune-application-python-flask-sur-un-serveur-apache-windows","title":"37.3. Portage d\u2019une application Python / Flask sur un serveur Apache / Windows","text":""},{"location":"exercice-dapplication-version-17.html#3731-sources","title":"37.3.1. Sources","text":"<p>Pour r\u00e9aliser le portage d\u2019une application Flask sur Apache / Windows, j\u2019ai d\u00fb chercher sur Internet. Voici le lien qui m\u2019a aid\u00e9\u00a0\u00e0 d\u00e9marrer\u00a0: [https://medium.com/@madumalt/flask-app-deployment-in-windows-apache-server-mod-wsgi-82e1cfeeb2ed]\u00a0;</p> <p>J\u2019ai utilis\u00e9 les informations de ce lien sauf pour la configuration du serveur Apache. Pour celle-ci j\u2019ai utilis\u00e9 un exemple de configuration du serveur Apache de Laragon.</p>"},{"location":"exercice-dapplication-version-17.html#3732-installation-du-module-python-mod_wsgi","title":"37.3.2. Installation du module Python mod_wsgi","text":"<p>L\u2019application Python / Flask que nous avons d\u00e9velopp\u00e9e utilisait le serveur WSGI (Web Server Gateway Interface) [werkzeug] d\u00e9livr\u00e9 avec Flask. Ce serveur est d\u00e9crit |ici|. Le lien [https://www.fullstackpython.com/wsgi-servers.html] d\u00e9crit le fonctionnement des serveurs WSGI. Il existe diff\u00e9rents |serveurs WSGI|. L\u2019un de ceux-ci est le serveur Apache fonctionnant en mode WSGI. C\u2019est la solution adopt\u00e9e ici parce que Laragon, que nous avons install\u00e9, vient avec un serveur Apache.</p> <p>Pour que le serveur Apache puisse h\u00e9berger une application Python, il nous faut installer le module Python [mod_wsgi]. L\u2019installation de ce module est d\u00e9licate parce qu\u2019au cours de cette installation une compilation C++ a lieu. Pour r\u00e9ussir l\u2019installation, il faut un compilateur Microsoft C++. Une solution simple est d\u2019installer la version courante de Visual Studio Community [https://visualstudio.microsoft.com/fr/vs/community/].</p> <p>Si on n\u2019a pas l\u2019utilit\u00e9 de Visual Studio autrement que pour [mod_wsgi], on peut limiter l\u2019installation \u00e0 l\u2019environnement C++\u00a0:</p> <p></p> <p>Une fois le compilateur C++ install\u00e9, l\u2019installation du module [mod_wsgi] se fait dans un terminal PyCharm\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\impots\\http-servers\\11&gt;SET MOD_WSGI_APACHE_ROOTDIR=C:\\MyPrograms\\laragon\\bin\\apache\\httpd-2.4.35-win64-VC15\n\n(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\impots\\http-servers\\11&gt;pip install mod_wsgi\nCollecting mod_wsgi\n  Using cached mod_wsgi-4.7.1.tar.gz (498 kB)\nUsing legacy setup.py install for mod-wsgi, since package 'wheel' is not installed.\nInstalling collected packages: mod-wsgi\n    Running setup.py install for mod-wsgi ... done\nSuccessfully installed mod-wsgi-4.7.1\n</code></pre> <ul> <li>ligne 1\u00a0: on fixe la valeur de la variable d\u2019environnement [MOD_WSGI_APACHE_ROOTDIR]. Cette valeur est l\u2019emplacement du serveur Apache dans le syst\u00e8me de fichiers. Ici cet emplacement est [&lt;laragon&gt;\\bin\\apache\\httpd-2.4.35-win64-VC15] o\u00f9 &lt;laragon&gt; est le dossier d\u2019installation de Laragon. Vous pouvez obtenir cet emplacement de diverses fa\u00e7ons. En voici une\u00a0obtenue \u00e0 partir d\u2019une des options de Laragon\u00a0:</li> </ul> <p></p> <p>En [1-3], le fichier [httpd.conf] est le fichier de configuration principal du serveur Apache. Le fichier en question est alors ouvert dans un \u00e9diteur de texte (Notepad ++ ci-dessous)\u00a0:</p> <p></p> <p>En [2], le dossier d\u2019installation d\u2019Apache est ce qui pr\u00e9c\u00e8de la cha\u00eene [conf\\httpd.conf].</p> <p>Revenons \u00e0 l\u2019installation du module [mod_wsgi]\u00a0:</p> <ul> <li>lignes 3-9\u00a0: installation du module [mod_wsgi]\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-17.html#3733-configuration-du-serveur-apache-de-laragon","title":"37.3.3. Configuration du serveur Apache de Laragon","text":"<p>Nous allons configurer le serveur Apache de Laragon. Nous commen\u00e7ons par son fichier de configuration principal [httpd.conf]\u00a0:</p> <p></p> <p>Nous nous pla\u00e7ons \u00e0 la fin du fichier [httpd.conf]\u00a0:</p> <pre><code>\u2026\nIncludeOptional \"C:/MyPrograms/laragon/etc/apache2/alias/*.conf\"\nIncludeOptional \"C:/MyPrograms/laragon/etc/apache2/sites-enabled/*.conf\"\nInclude \"C:/MyPrograms/laragon/etc/apache2/httpd-ssl.conf\"\nInclude \"C:/MyPrograms/laragon/etc/apache2/mod_php.conf\"\n\n# python mod_wsgi\nLoadModule wsgi_module \"c:/data/st-2020/dev/python/cours-2020/python3-flask-2020/venv/lib/site-packages/mod_wsgi/server/mod_wsgi.cp38-win_amd64.pyd\"\n</code></pre> <ul> <li>la ligne 8 a \u00e9t\u00e9 ajout\u00e9e \u00e0 l\u2019existant du fichier [httpd.conf] en fin de fichier. Elle indique au serveur Apache o\u00f9 se trouve un \u00e9l\u00e9ment du module [mod_wsgi] que nous venons d\u2019installer\u00a0; Une fa\u00e7on simple d\u2019avoir le chemin de la ligne 8 est d\u2019ex\u00e9cuter la commande suivante dans un terminal PyCharm\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\impots\\http-servers\\11&gt;mod_wsgi-express module-config\nLoadModule wsgi_module \"c:/data/st-2020/dev/python/cours-2020/python3-flask-2020/venv/lib/site-packages/mod_wsgi/server/mod_wsgi.cp38-win_amd64.pyd\"\nWSGIPythonHome \"c:/data/st-2020/dev/python/cours-2020/python3-flask-2020/venv\"\n</code></pre> <p>Certaines documentations disent qu\u2019il faut ajouter les lignes 2 et 3 \u00e0 la fin du fichier [httpd.conf]. Dans mon cas, la ligne 3 ci-dessus provoquait une erreur (module [encodings] manquant). Aussi n\u2019a-t-elle pas \u00e9t\u00e9 mise dans le fichier [httpd.conf]. Seule la ligne 2 y a \u00e9t\u00e9 mise. La signification des diff\u00e9rents param\u00e8tres du module [mod_wsgi] utilisables dans les fichiers de configuration d\u2019Apache sont d\u00e9crits |ici|.</p> <p>Ensuite, nous allons activer le protocole HTTPS du serveur Apache\u00a0:</p> <p></p> <ul> <li>en [1-4], on active le protocole HTTPS du serveur Apache\u00a0; D\u00e9sormais, nous pourrons utiliser des URL [https://serveur/chemin]\u00a0;</li> </ul> <p>Pour configurer Apache de fa\u00e7on \u00e0 servir une application Flask, le lien r\u00e9f\u00e9renc\u00e9 |plus haut|utilise des serveurs virtuels. Laragon propose \u00e9galement de g\u00e9rer des serveurs virtuels\u00a0:</p> <p></p> <ul> <li>en [1-3], on demande \u00e0 Laragon de cr\u00e9er automatiquement des h\u00f4tes virtuels\u00a0; L\u2019\u00e9tape suivante est de cr\u00e9er un projet web avec Laragon\u00a0:</li> </ul> <ul> <li>en [1-3], on cr\u00e9e un projet PHP vide\u00a0;</li> <li>en [4-8], Laragon a cr\u00e9\u00e9 un site virtuel appel\u00e9 [auto.projet-test.test] configur\u00e9 par le fichier [auto.projet-test.test.conf] [8] du dossier [sites-enabled] [7]. Ce dossier se trouve \u00e0 l\u2019adresse [&lt;laragon&gt;\\etc\\apache2\\sites-enabled] o\u00f9 [laragon] est le dossier d\u2019installation de Laragon\u00a0; Bien que \u00e7a n\u2019entre pas dans ce qui est fait en ce moment, vous pouvez avoir la curiosit\u00e9 d\u2019aller voir ce qu\u2019est ce site web [projet-test] que nous venons de cr\u00e9er\u00a0:</li> </ul> <p></p> <ul> <li>en [1-5], un projet vide a \u00e9t\u00e9 cr\u00e9\u00e9. C\u2019est un projet PHP situ\u00e9 dans le dossier [&lt;laragon&gt;/www] o\u00f9 [laragon] est le dossier d\u2019installation de Laragon\u00a0; Maintenant examinons le fichier [auto.projet-test.test.conf] g\u00e9n\u00e9r\u00e9 par Laragon\u00a0dans le dossier [&lt;laragon&gt;\\etc\\apache2\\sites-enabled]\u00a0:</li> </ul> <pre><code>define\u00a0ROOT\u00a0\"C:/MyPrograms/laragon/www/projet-test/\"\ndefine\u00a0SITE\u00a0\"projet-test.test\"\n\n&lt;VirtualHost\u00a0*:80&gt;\u00a0\n\u00a0\u00a0\u00a0\u00a0DocumentRoot\u00a0\"${ROOT}\"\n\u00a0\u00a0\u00a0\u00a0ServerName\u00a0${SITE}\n\u00a0\u00a0\u00a0\u00a0ServerAlias\u00a0*.${SITE}\n\u00a0\u00a0\u00a0\u00a0&lt;Directory\u00a0\"${ROOT}\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0AllowOverride\u00a0All\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Require\u00a0all\u00a0granted\n\u00a0\u00a0\u00a0\u00a0&lt;/Directory&gt;\n&lt;/VirtualHost&gt;\n\n&lt;VirtualHost\u00a0*:443&gt;\n\u00a0\u00a0\u00a0\u00a0DocumentRoot\u00a0\"${ROOT}\"\n\u00a0\u00a0\u00a0\u00a0ServerName\u00a0${SITE}\n\u00a0\u00a0\u00a0\u00a0ServerAlias\u00a0*.${SITE}\n\u00a0\u00a0\u00a0\u00a0&lt;Directory\u00a0\"${ROOT}\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0AllowOverride\u00a0All\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Require\u00a0all\u00a0granted\n\u00a0\u00a0\u00a0\u00a0&lt;/Directory&gt;\n\n\u00a0\u00a0\u00a0\u00a0SSLEngine\u00a0on\n\u00a0\u00a0\u00a0\u00a0SSLCertificateFile\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0C:/MyPrograms/laragon/etc/ssl/laragon.crt\n\u00a0\u00a0\u00a0\u00a0SSLCertificateKeyFile\u00a0\u00a0\u00a0C:/MyPrograms/laragon/etc/ssl/laragon.key\n\u00a0\n&lt;/VirtualHost&gt;\n</code></pre> <ul> <li>ligne 1\u00a0: la racine, dans le syst\u00e8me de fichiers, du projet cr\u00e9\u00e9\u00a0;</li> <li>ligne 2\u00a0: le nom du serveur virtuel. Les URL pour ce serveur seront de la forme [http(s)://projet-test.test/chemin]\u00a0;</li> <li>lignes 4-12\u00a0: configuration du site virtuel pour le port 80 (ligne 4) et le protocole HTTP\u00a0;</li> <li>lignes 14-27\u00a0: configuration du site virtuel pour le port 443 (ligne 14) et le protocole HTTPS\u00a0; Voyons comment fonctionne un serveur virtuel. Lan\u00e7ons tout d\u2019abord le serveur Apache et PHP\u00a0:</li> </ul> <p></p> <p>Avec un navigateur nous demandons ensuite l\u2019URL [http://projet-test.test/]\u00a0:</p> <p></p> <ul> <li>en [1], l\u2019URL demand\u00e9e\u00a0;</li> <li>en [2], le protocole HTTP a \u00e9t\u00e9 utilis\u00e9\u00a0;</li> <li>en [3], parce que le projet [projet-test] est vide, on obtient l\u2019index de son dossier (liste de son contenu), index vide\u00a0; Maintenant demandons l\u2019URL s\u00e9curis\u00e9e [https://projet-test.test/]\u00a0:</li> </ul> <p></p> <ul> <li>en [1-2], on obtient la m\u00eame r\u00e9ponse que pr\u00e9c\u00e9demment mais avec le protocole HTTPS [1]\u00a0; La cr\u00e9ation du serveur virtuel [projet-test.test] a cr\u00e9\u00e9 une nouvelle entr\u00e9e dans le fichier [&lt;windows&gt;/system32/drivers/etc/hosts]\u00a0:</li> </ul> <p></p> <pre><code># Copyright (c) 1993-2009 Microsoft Corp.\n#\n# This is a sample HOSTS file used by Microsoft TCP/IP for Windows.\n#\n# This file contains the mappings of IP addresses to host names. Each\n# entry should be kept on an individual line. The IP address should\n# be placed in the first column followed by the corresponding host name.\n# The IP address and the host name should be separated by at least one\n# space.\n#\n# Additionally, comments (such as these) may be inserted on individual\n# lines or following the machine name denoted by a '#' symbol.\n#\n# For example:\n#\n#      102.54.94.97     rhino.acme.com          # source server\n#       38.25.63.10     x.acme.com              # x client host\n\n# localhost name resolution is handled within DNS itself.\n#    127.0.0.1       localhost\n#    ::1             localhost\n\n127.0.0.1      projet-test.test     #laragon magic!   \n</code></pre> <ul> <li>ligne 23\u00a0: l\u2019adresse IP du nom [projet-test.test] est 127.0.0.1, \u00e7-\u00e0-d l\u2019adresse de [localhost] (ligne 20), la machine locale. Ainsi lorsque dans un navigateur on tape l\u2019URL [http://projet-test.test/chemin], la requ\u00eate est envoy\u00e9e \u00e0 l\u2019adresse 127.0.0.1 sur le port 80. C\u2019est alors le serveur Apache de la machine locale (localhost) qui r\u00e9pond. On peut se demander pourquoi lorsqu\u2019on tape la requ\u00eate [http://projet-test.test/], le serveur Apache utilise la configuration du fichier [&lt;laragon&gt;\\etc\\apache2\\sites-enabled\\auto.projet-test.test.conf]\u00a0:</li> </ul> <p></p> <p>Pour le comprendre, il faut voir ce qu\u2019envoie le navigateur au serveur Apache lorsqu\u2019on fait cette requ\u00eate. Faisons-la avec Postman\u00a0:</p> <p></p> <ul> <li>en [1-3], on envoie une requ\u00eate HTTPS [1]\u00a0;</li> <li>en [4], Postman indique qu\u2019il n\u2019a pas reconnu le certificat de s\u00e9curit\u00e9. Le protocole HTTPS \u00e9tablit une liaison crypt\u00e9e entre le client web (ici Postman) et le serveur Apache. Cette liaison crypt\u00e9e se fait au moyen de certificats \u00e9chang\u00e9s entre le client et le serveur. C\u2019est le serveur qui initie le dialogue d\u2019\u00e9tablissement de la liaison crypt\u00e9e en envoyant au client un certificat de s\u00e9curit\u00e9. Pour que ce certificat soit accept\u00e9 par le client il faut qu\u2019il soit sign\u00e9, en clair achet\u00e9 \u00e0 des entreprises habilit\u00e9es \u00e0 d\u00e9livrer des certificats de s\u00e9curit\u00e9. Lorsque nous avons activ\u00e9 le procole HTTPS de Laragon, Laragon a cr\u00e9\u00e9 lui-m\u00eame le certificat de s\u00e9curit\u00e9. On dit alors du certificat qu\u2019il est auto-sign\u00e9. La plupart des clients web \u00e9mettent un avertissement lorsqu\u2019ils re\u00e7oivent un certificat auto-sign\u00e9. C\u2019est ce que fait Postman en [4]. La plupart des clients web proposent alors de d\u00e9sactiver la v\u00e9rification du certificat de s\u00e9curit\u00e9 envoy\u00e9 par le serveur. C\u2019est ce que propose Postman en [5]\u00a0; Nous cliquons sur le lien [5] pour d\u00e9sactiver la v\u00e9rification SSL (Secure Sockets Layer). SSL / TSL (Transport Layer Security) est un protocole de s\u00e9curit\u00e9 qui cr\u00e9e un canal de communication s\u00e9curis\u00e9 entre deux machines de l\u2019internet. C\u2019est le protocole utilis\u00e9 ici par Apache. La r\u00e9ponse est la suivante\u00a0:</li> </ul> <p></p> <p>Nous recevons la m\u00eame page qu\u2019avec un navigateur traditionnel. Maintenant voyons le dialogue client / serveur dans la console Postman (Ctrl-Alt-C)\u00a0:</p> <pre><code>GET / HTTP/1.1\nUser-Agent: PostmanRuntime/7.26.2\nAccept: */*\nCache-Control: no-cache\nPostman-Token: d153f711-ad99-4e1d-93c3-61c25374d1be\nHost: projet-test.test\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\n\nHTTP/1.1 200 OK\nDate: Fri, 14 Aug 2020 09:19:24 GMT\nServer: Apache/2.4.35 (Win64) OpenSSL/1.1.1b PHP/7.2.19 mod_wsgi/4.7.1 Python/3.8\nContent-Length: 161\nKeep-Alive: timeout=5, max=100\nConnection: Keep-Alive\nContent-Type: text/html;charset=UTF-8\n</code></pre> <ul> <li>ligne 6\u00a0: l\u2019ent\u00eate HTTP [Host] pr\u00e9cise le nom du serveur cibl\u00e9 par le client web. C\u2019est le principe des serveurs virtuels. A une m\u00eame adresse IP (ici 127.0.0.1), un serveur web peut h\u00e9berger plusieurs sites web avec des noms diff\u00e9rents. L\u2019ent\u00eate HTTP [Host] permet au client de dire \u00e0 quel serveur (ici de l\u2019adresse 127.0.0.1) il s\u2019adresse\u00a0; Maintenant que fait Apache\u00a0?</li> </ul> <p>Lorsqu\u2019il d\u00e9marre, Apache lit tous les fichiers de configuration trouv\u00e9s dans le dossier [[&lt;laragon&gt;\\etc\\apache2\\sites-enabled]\u00a0:</p> <p></p> <p>Chaque fichier de configuration d\u00e9finit un serveur virtuel. Par exemple dans le fichier [auto.projet-test.test.conf], on trouve la ligne suivante\u00a0:</p> <pre><code>define\u00a0ROOT\u00a0\"C:/MyPrograms/laragon/www/projet-test/\"\ndefine\u00a0SITE\u00a0\"projet-test.test\"\n\u2026\n</code></pre> <p>La ligne 2 d\u00e9finit le serveur virtuel [projet-test.test]. Le fichier [auto.projet-test.test.conf] est la configuration de ce serveur virtuel. Parce qu\u2019il lit au d\u00e9marrage tous les fichiers de configuration du dossier [&lt;laragon&gt;\\etc\\apache2\\sites-enabled], le serveur Apache sait qu\u2019il existe un serveur virtuel appel\u00e9 [projet-test.test]. Ainsi lorsqu\u2019il re\u00e7oit du client Postman, la requ\u00eate HTTPS\u00a0:</p> <pre><code>GET / HTTP/1.1\nUser-Agent: PostmanRuntime/7.26.2\nAccept: */*\nCache-Control: no-cache\nPostman-Token: d153f711-ad99-4e1d-93c3-61c25374d1be\nHost: projet-test.test\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\n</code></pre> <p>il reconna\u00eet que la requ\u00eate est adress\u00e9e au serveur virtuel [projet-test.test] (ligne 6) et que celui-ci existe. Il utilise alors la configuration du serveur virtuel [projet-test.test] pour r\u00e9pondre au client Postman.</p>"},{"location":"exercice-dapplication-version-17.html#374-creation-dun-premier-serveur-virtuel-apache","title":"37.4. Cr\u00e9ation d\u2019un premier serveur virtuel Apache","text":"<p>Maintenant que nous savons \u00e0 quoi servent des serveurs virtuels et comment les d\u00e9finir, nous allons en cr\u00e9er un. Il servira \u00e0 ex\u00e9cuter une application Python Flask install\u00e9e dans un dossier [Apache] de la version 17\u00a0en cours de d\u00e9ploiement sur le serveur Apache:</p> <p>Nous avons mis dans le dossier [http-servers/12/apache/exemple] l\u2019application d\u00e9velopp\u00e9e au paragraphe |lien|, un service web de date /heure\u00a0:</p> <p></p> <p>Le serveur [date_time_server.py] est le suivant\u00a0:</p> <pre><code>#\u00a0imports\nimport\u00a0os\nimport\u00a0sys\nimport\u00a0time\n\n#\u00a0il\u00a0nous\u00a0faut\u00a0mettre\u00a0dans\u00a0le\u00a0Python\u00a0Path\u00a0le\u00a0dossier\u00a0des\u00a0modules\n#\u00a0pour\u00a0portage\u00a0vers\u00a0apache\u00a0windows\nsys.path.insert(0,\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/venv/lib/site-packages\")\n\nfrom\u00a0flask\u00a0import\u00a0Flask,\u00a0make_response,\u00a0render_template\n\n#\u00a0application\u00a0Flask\nscript_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\napplication\u00a0=\u00a0Flask(__name__,\u00a0template_folder=f\"{script_dir}\")\n\n#\u00a0Home\u00a0URL\n@application.route('/')\ndef\u00a0index():\n\u00a0\u00a0\u00a0\u00a0#\u00a0envoi\u00a0heure\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0#\u00a0time.localtime\u00a0:\u00a0nb\u00a0de\u00a0millisecondes\u00a0depuis\u00a001/01/1970\n\u00a0\u00a0\u00a0\u00a0#\u00a0time.strftime\u00a0permet\u00a0de\u00a0formater\u00a0l'heure\u00a0et\u00a0la\u00a0date\n\u00a0\u00a0\u00a0\u00a0#\u00a0format\u00a0affichage\u00a0date-heure\n\u00a0\u00a0\u00a0\u00a0#\u00a0d:\u00a0jour\u00a0sur\u00a02\u00a0chiffres\n\u00a0\u00a0\u00a0\u00a0#\u00a0m:\u00a0mois\u00a0sur\u00a02\u00a0chiffres\n\u00a0\u00a0\u00a0\u00a0#\u00a0y\u00a0:\u00a0ann\u00e9e\u00a0sur\u00a02\u00a0chiffres\n\u00a0\u00a0\u00a0\u00a0#\u00a0H\u00a0:\u00a0heure\u00a00,23\n\u00a0\u00a0\u00a0\u00a0#\u00a0M\u00a0:\u00a0minutes\n\u00a0\u00a0\u00a0\u00a0#\u00a0S:\u00a0secondes\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0date\u00a0/\u00a0heure\u00a0du\u00a0moment\n\u00a0\u00a0\u00a0\u00a0time_of_day\u00a0=\u00a0time.strftime('%d/%m/%y\u00a0%H:%M:%S',\u00a0time.localtime())\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0g\u00e9n\u00e8re\u00a0le\u00a0document\u00a0\u00e0\u00a0envoyer\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0page\u00a0=\u00a0{\"date_heure\":\u00a0time_of_day}\n\u00a0\u00a0\u00a0\u00a0document\u00a0=\u00a0render_template(\"date_time_server.html\",\u00a0page=page)\n\u00a0\u00a0\u00a0\u00a0print(\"document\",\u00a0type(document),\u00a0document)\n\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9ponse\u00a0HTTP\u00a0au\u00a0client\n\u00a0\u00a0\u00a0\u00a0response\u00a0=\u00a0make_response(document)\n\u00a0\u00a0\u00a0\u00a0print(\"response\",\u00a0type(response),\u00a0response)\n\u00a0\u00a0\u00a0\u00a0return\u00a0response\n\n#\u00a0main\u00a0seulement\nif\u00a0__name__\u00a0==\u00a0'__main__':\n\u00a0\u00a0\u00a0\u00a0application.config.update(ENV=\"development\",\u00a0DEBUG=True)\n\u00a0\u00a0\u00a0\u00a0application.run()\n</code></pre> <p>L\u2019application Flask est r\u00e9f\u00e9renc\u00e9e par l\u2019identifiant [application] (lignes 14, 43, 44). Ce nom est obligatoire. Si on r\u00e9f\u00e9rence l\u2019application Flask avec un autre identifiant l\u2019application ne va pas marcher avec un message d\u2019erreur indiquant qu\u2019elle ne trouve pas l\u2019URL demand\u00e9e. Ce message d\u2019erreur ne donne aucune indication sur la source de l\u2019erreur. Il faut donc \u00eatre vigilant sur ce point.</p> <p>Le fichier HTML r\u00e9f\u00e9renc\u00e9 ligne 34 est le suivant\u00a0:</p> <pre><code>&lt;!DOCTYPE\u00a0html&gt;\n&lt;html\u00a0lang=\"fr\"&gt;\n&lt;head&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;meta\u00a0charset=\"UTF-8\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;title&gt;Date\u00a0et\u00a0heure\u00a0du\u00a0moment&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;b&gt;Date\u00a0et\u00a0heure\u00a0du\u00a0moment\u00a0:\u00a0{{page.date_heure}}&lt;/b&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <ul> <li>[date-time-server] sera le serveur virtuel qui h\u00e9bergera cette application. Il sera configur\u00e9 par le fichier [&lt;laragon&gt;\\etc\\apache2\\sites-enabled\\date-time-server.conf] (on rappelle que ce nom est libre \u2013 Apache lit tous les fichiers pr\u00e9sents dans [sites-enabled] pour d\u00e9couvrir les sites virtuels h\u00e9berg\u00e9s)\u00a0; Nous obtenons ce fichier tout d\u2019abord par recopie du fichier [auto.projet-test.test.conf] puis nous le modifions.</li> </ul> <p></p> <p>Le fichier [date-time-server.conf] sera le suivant\u00a0:</p> <pre><code>#\u00a0dossier\u00a0du\u00a0script\u00a0python-flask\u00a0de\u00a0l'application\ndefine\u00a0ROOT\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots/http-servers/12/apache/exemple\"\n\n#\u00a0nom\u00a0du\u00a0site\u00a0web\u00a0configur\u00e9\u00a0par\u00a0ce\u00a0fichier\n#\u00a0ici\u00a0il\u00a0s'appellera\u00a0date-time-server\n#\u00a0les\u00a0URL\u00a0seront\u00a0du\u00a0type\u00a0http(s)://date-time-server/chemin\ndefine\u00a0SITE\u00a0\"date-time-server\"\n\n#\u00a0mettre\u00a0l'adresse\u00a0IP\u00a0127.0.0.1\u00a0pour\u00a0site\u00a0SITE\u00a0dans\u00a0c:/windows/system32/drivers/etc/hosts\n\n#\u00a0URL\u00a0HTTP\n&lt;VirtualHost\u00a0*:80&gt;\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0http(s)://date-time-server/chemin/...\n\u00a0\u00a0\u00a0\u00a0WSGIScriptAlias\u00a0/\u00a0\"${ROOT}/date_time_server.py\"\n\u00a0\u00a0\u00a0\u00a0DocumentRoot\u00a0\"${ROOT}\"\n\u00a0\u00a0\u00a0\u00a0ServerName\u00a0${SITE}\n\u00a0\u00a0\u00a0\u00a0ServerAlias\u00a0*.${SITE}\n\u00a0\u00a0\u00a0\u00a0&lt;Directory\u00a0\"${ROOT}\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0AllowOverride\u00a0All\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Require\u00a0all\u00a0granted\n\u00a0\u00a0\u00a0\u00a0&lt;/Directory&gt;\n&lt;/VirtualHost&gt;\n\n#\u00a0URL\u00a0s\u00e9curis\u00e9es\u00a0avec\u00a0HTTPS\n&lt;VirtualHost\u00a0*:443&gt;\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0http(s)://date-time-server/chemin/...\n\u00a0\u00a0\u00a0\u00a0WSGIScriptAlias\u00a0/\u00a0\"${ROOT}/date_time_server.py\"\n\u00a0\u00a0\u00a0\u00a0DocumentRoot\u00a0\"${ROOT}\"\n\u00a0\u00a0\u00a0\u00a0ServerName\u00a0${SITE}\n\u00a0\u00a0\u00a0\u00a0ServerAlias\u00a0*.${SITE}\n\u00a0\u00a0\u00a0\u00a0&lt;Directory\u00a0\"${ROOT}\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0AllowOverride\u00a0All\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Require\u00a0all\u00a0granted\n\u00a0\u00a0\u00a0\u00a0&lt;/Directory&gt;\n\n\u00a0\u00a0\u00a0\u00a0SSLEngine\u00a0on\n\u00a0\u00a0\u00a0\u00a0SSLCertificateFile\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0C:/MyPrograms/laragon/etc/ssl/laragon.crt\n\u00a0\u00a0\u00a0\u00a0SSLCertificateKeyFile\u00a0\u00a0\u00a0C:/myprograms/laragon/etc/ssl/laragon.key\n\n&lt;/VirtualHost&gt;\n</code></pre> <ul> <li>ligne 7\u00a0: on donne un nom au serveur virtuel\u00a0configur\u00e9 par le fichier\u00a0;</li> <li>ligne 2\u00a0: on donne la valeur de la variable [ROOT] utilis\u00e9e aux lignes 14 et 27\u00a0;</li> <li>lignes 14 et 27\u00a0: on indique le chemin du script Python qui doit \u00eatre ex\u00e9cut\u00e9 lorsque le serveur virtuel re\u00e7oit une requ\u00eate. On indique ici que les requ\u00eates pour le serveur [date-time-server] sont trait\u00e9es par le script Python [date_time_server.py]. Cette diff\u00e9rence avec le fichier [auto.projet-test.test.conf] vient du fait que ce fichier configurait un serveur PHP alors que le fichier [date-time-server.conf] configure un serveur Python\u00a0;</li> <li>lignes 14 et 27\u00a0: l\u2019attribut [WSGIScriptAlias\u00a0/] indique ici que la racine du serveur [date-time-server] sera [/]. Ainsi les URL de l\u2019application auront la forme [http(s)://date-time-server/chemin]\u00a0;</li> <li>lignes 14 et 27, on peut donner une autre racine \u00e0 l\u2019application par exemple [WSGIScriptAlias /show]. Alors les URL de l\u2019application auront la forme [http(s)://show/date-time-server/chemin]\u00a0; Il nous faut \u00e9galement ajouter une ligne au fichier [&lt;windows&gt;/system32/drivers/etc/hosts]\u00a0:</li> </ul> <pre><code># Copyright (c) 1993-2009 Microsoft Corp.\n#\n# This is a sample HOSTS file used by Microsoft TCP/IP for Windows.\n#\n# This file contains the mappings of IP addresses to host names. Each\n# entry should be kept on an individual line. The IP address should\n# be placed in the first column followed by the corresponding host name.\n# The IP address and the host name should be separated by at least one\n# space.\n#\n# Additionally, comments (such as these) may be inserted on individual\n# lines or following the machine name denoted by a '#' symbol.\n#\n# For example:\n#\n#      102.54.94.97     rhino.acme.com          # source server\n#       38.25.63.10     x.acme.com              # x client host\n\n# localhost name resolution is handled within DNS itself.\n#    127.0.0.1       localhost\n#    ::1             localhost\n\n127.0.0.1    flask-impots-withmysql        # cours python - appli imp\u00f4ts avec MySQL\n127.0.0.1    flask-impots-withpgres        # cours python - appli imp\u00f4ts avec PostgreSQL\n127.0.0.1    date-time-server            # cours python - heure et date du moment\n127.0.0.1           projet-test.test                #laragon magic!\n</code></pre> <p>On ajoute la ligne 25, pour donner l\u2019adresse IP [127.0.0.1] au serveur virtuel [date-time-server].</p> <p>V\u00e9rifions tout cela. Nous lan\u00e7ons le serveur Apache\u00a0:</p> <p></p> <p>Nous demandons ensuite l\u2019URL [https://date-time-server] avec un navigateur\u00a0:</p> <p></p> <ul> <li>en [1], l\u2019URL demand\u00e9e\u00a0;</li> <li>en [3], la r\u00e9ponse du serveur\u00a0;</li> <li>en [2], le navigateur indique que la connection HTTPS n\u2019est pas s\u00fbre car il a d\u00e9tect\u00e9 que le certificat envoy\u00e9 par le serveur Apache \u00e9tait auto-sign\u00e9\u00a0; Maintenant dans le fichier [date-time-server.conf], mettons un alias aux lignes 14 et 27\u00a0:</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0WSGIScriptAlias\u00a0/show-date-time\u00a0\"${ROOT}/date_time_server.py\"\n</code></pre> <p>La modification n\u2019est pas prise en compte imm\u00e9diatement par le serveur Apache. Il faut le recharger\u00a0:</p> <p></p> <p>On demande ensuite l\u2019URL [https://date-time-server/show-date-time]. La r\u00e9ponse du serveur est alors la suivante\u00a0:</p> <p></p>"},{"location":"exercice-dapplication-version-17.html#375-portage-de-lapplication-de-calcul-de-limpot-sur-apache-windows","title":"37.5. Portage de l\u2019application de calcul de l\u2019imp\u00f4t sur Apache / Windows","text":"<p>Le dossier [apache] [2] est obtenu initialement par recopie du dossier [main]. Il est important qu\u2019ils soient au m\u00eame niveau pour que les chemins du script [syspath.py] copi\u00e9 de [1] vers [2] restent valides. Pour ne pas polluer l\u2019application [impots / http-servers/ 12] qui fonctionne, nous mettons dans [apache] la configuration qui sera ex\u00e9cut\u00e9e par le serveur Apache\u00a0;</p> <p></p> <ul> <li>le fichier [config] de [2] est le m\u00eame que [config] de [1]\u00a0;</li> <li>le fichier [syspath] de [2] est le m\u00eame que [syspath] de [1]\u00a0;</li> <li>le fichier [main_withmysql] de [2] est le fichier [main] de [1]\u00a0avec les modifications suivantes\u00a0: Le script principal [main] recevait un param\u00e8tre [mysql / pgres] qui lui disait quel SGBD utilis\u00e9. Le script [main_withmysql] utilise le SGBD MySQL\u00a0:</li> </ul> <pre><code>#\u00a0on\u00a0attend\u00a0un\u00a0param\u00e8tre\u00a0mysql\u00a0ou\u00a0pgres\nimport\u00a0os\nimport\u00a0sys\n\n#\u00a0on\u00a0configure\u00a0l'application\u00a0avec\u00a0MySQL\nimport\u00a0config\nconfig\u00a0=\u00a0config.configure({'sgbd':\u00a0\"mysql\"})\n\n#\u00a0d\u00e9pendances\nfrom\u00a0SendAdminMail\u00a0import\u00a0SendAdminMail\nfrom\u00a0Logger\u00a0import\u00a0Logger\nfrom\u00a0Imp\u00f4tsError\u00a0import\u00a0Imp\u00f4tsError\n\u2026\n</code></pre> <p>Ligne 7, on fixe le SGBD \u00e0 MySQL.</p> <ul> <li>le fichier [main_withpgres] de [2] est le fichier [main] de [1]\u00a0avec les modifications suivantes\u00a0: il utilise le SGBD PostgreSQL\u00a0: <pre><code>#\u00a0on\u00a0attend\u00a0un\u00a0param\u00e8tre\u00a0mysql\u00a0ou\u00a0pgres\nimport\u00a0os\nimport\u00a0sys\n\n#\u00a0on\u00a0configure\u00a0l'application\u00a0avec\u00a0MySQL\nimport\u00a0config\nconfig\u00a0=\u00a0config.configure({'sgbd':\u00a0\"pgres\"})\n\n#\u00a0d\u00e9pendances\nfrom\u00a0SendAdminMail\u00a0import\u00a0SendAdminMail\nfrom\u00a0Logger\u00a0import\u00a0Logger\nfrom\u00a0Imp\u00f4tsError\u00a0import\u00a0Imp\u00f4tsError\n\u2026\n</code></pre></li> </ul> <p>Ligne 7, on fixe le SGBD \u00e0 PostgreSQL.</p> <p>Ceci fait, on cr\u00e9e le script [main_withmysql.wsgi] (le suffixe utilis\u00e9 n\u2019a pas d\u2019importance) suivant\u00a0:</p> <pre><code># dossier de ce fichier\nimport os\nscript_dir = os.path.dirname(os.path.abspath(__file__))\n\n# on l'ajoute au syspath pour que l'import qui suit soit possible\nimport sys\nsys.path.insert(0, script_dir)\n\n# on importe l'application Flask [app] en lui donnant le nom [application]\nfrom main_withmysql import app as application\n</code></pre> <p>Le script [main_withmysql.wsgi] sera la cible ex\u00e9cut\u00e9e par le serveur Apache en mode WSGI\u00a0:</p> <ul> <li>la cible du serveur Apache aurait pu \u00eatre le script [main_withmysql.py] comme il a \u00e9t\u00e9 fait pr\u00e9c\u00e9demment avec le script [date_time_server.py]. Mais il aurait fallu le modifier un peu\u00a0:</li> <li>contrairement au mode d\u2019ex\u00e9cution avec un script console, avec Apache, le dossier contenant la cible [main_withmysql.py] ne fait pas partie du Python Path. Aussi, la ligne 6 du script [main_withmysql.py] provoque-t-elle une erreur\u00a0;</li> <li>la seconde modification qu\u2019il aurait fallu faire est que dans [main_withmysql] l\u2019application Flask est r\u00e9f\u00e9renc\u00e9e par l\u2019identifiant [app]. On sait que pour Apache / WSGI elle doit \u00eatre \u00e9galement r\u00e9f\u00e9renc\u00e9e par un identifiant [application]\u00a0;</li> <li>plut\u00f4t que de modifier [main_withmysql.py], on change la cible d\u2019Apache. Ce sera d\u00e9sormais le script [main_withmysql.wsgi] ci-dessus\u00a0:</li> <li>lignes 1-7\u00a0: on met le dossier du script dans le Python Path. Du coup, la ligne 6 de [main_withmysql.py] ne provoque plus d\u2019erreur\u00a0;</li> <li>lignes 9-10\u00a0: l\u2019importation de [main_withmysql.py] provoque son ex\u00e9cution. Par ailleurs on r\u00e9f\u00e9rence l\u2019application Flask [app] trouv\u00e9e dans [main_withmysql.py] avec l\u2019identificateur [application] dont a besoin Apache\u00a0en mode WSGI\u00a0; On fait de m\u00eame avec le script [main_withpgres.wsgi]\u00a0:</li> </ul> <pre><code># dossier de ce fichier\nimport os\nscript_dir = os.path.dirname(os.path.abspath(__file__))\n\n# on l'ajoute au syspath pour que l'import qui suit soit possible\nimport sys\nsys.path.insert(0, script_dir)\n\n# on importe l'application Flask [app] en lui donnant le nom [application]\nfrom main_withpgres import app as application\n</code></pre> <p>Nous avons d\u00e9sormais les cibles ex\u00e9cutables pour le serveur Apache. Il nous faut maintenant cr\u00e9er deux serveurs virtuels, un pour chaque cible.</p> <p>Dans [&lt;laragon&gt;\\etc\\apache2\\sites-enabled], nous cr\u00e9ons le fichier [flask-impots-withmysql.conf] (le nom donn\u00e9 n\u2019a pas d\u2019importance)\u00a0:</p> <p></p> <pre><code>#\u00a0dossier\u00a0du\u00a0script\u00a0.wsgi\ndefine\u00a0ROOT\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots/http-servers/12/apache\"\n\n#\u00a0nom\u00a0du\u00a0site\u00a0web\u00a0configur\u00e9\u00a0par\u00a0ce\u00a0fichier\n#\u00a0ici\u00a0il\u00a0s'appellera\u00a0flask-impots-withmysql\n#\u00a0les\u00a0URL\u00a0seront\u00a0du\u00a0type\u00a0http(s)://flask-impots-withmysql/chemin\ndefine\u00a0SITE\u00a0\"flask-impots-withmysql\"\n\n#\u00a0mettre\u00a0l'adresse\u00a0IP\u00a0127.0.0.1\u00a0pour\u00a0site\u00a0SITE\u00a0dans\u00a0c:/windows/system32/drivers/etc/hosts\n\n#\u00a0mettre\u00a0ici\u00a0les\u00a0chemins\u00a0des\u00a0biblioth\u00e8ques\u00a0Python\u00a0\u00e0\u00a0utiliser\u00a0-\u00a0les\u00a0s\u00e9parer\u00a0par\u00a0des\u00a0virgules\n#\u00a0ici\u00a0les\u00a0biblioth\u00e8ques\u00a0d'un\u00a0environnement\u00a0virtuel\u00a0Python\nWSGIPythonPath\u00a0\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/venv/lib/site-packages\"\n\n#\u00a0Python\u00a0Home\u00a0-\u00a0n\u00e9cessaire\u00a0uniquement\u00a0s'il\u00a0y\u00a0a\u00a0plusieurs\u00a0versions\u00a0de\u00a0Python\u00a0install\u00e9es\n#\u00a0WSGIPythonHome\u00a0\"C:/Program\u00a0Files/Python38\"\n\n#\u00a0URL\u00a0HTTP\n&lt;VirtualHost\u00a0*:80&gt;\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/impots\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/impots/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0o\u00f9\u00a0[prefixe_url]\u00a0est\u00a0d\u00e9fini\u00a0dans\u00a0parameters.py\n\u00a0\u00a0\u00a0\u00a0WSGIScriptAlias\u00a0/\u00a0\"${ROOT}/main_withmysql.wsgi\"\n\u00a0\u00a0\u00a0\u00a0DocumentRoot\u00a0\"${ROOT}\"\n\u00a0\u00a0\u00a0\u00a0ServerName\u00a0${SITE}\n\u00a0\u00a0\u00a0\u00a0ServerAlias\u00a0*.${SITE}\n\u00a0\u00a0\u00a0\u00a0&lt;Directory\u00a0\"${ROOT}\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0AllowOverride\u00a0All\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Require\u00a0all\u00a0granted\n\u00a0\u00a0\u00a0\u00a0&lt;/Directory&gt;\n&lt;/VirtualHost&gt;\n\n#\u00a0URL\u00a0s\u00e9curis\u00e9es\u00a0avec\u00a0HTTPS\n&lt;VirtualHost\u00a0*:443&gt;\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/impots\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/impots/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0o\u00f9\u00a0[prefixe_url]\u00a0est\u00a0d\u00e9fini\u00a0dans\u00a0parameters.py\n\u00a0\u00a0\u00a0\u00a0WSGIScriptAlias\u00a0/\u00a0\"${ROOT}/main_withmysql.wsgi\"\n\u00a0\u00a0\u00a0\u00a0DocumentRoot\u00a0\"${ROOT}\"\n\u00a0\u00a0\u00a0\u00a0ServerName\u00a0${SITE}\n\u00a0\u00a0\u00a0\u00a0ServerAlias\u00a0*.${SITE}\n\u00a0\u00a0\u00a0\u00a0&lt;Directory\u00a0\"${ROOT}\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0AllowOverride\u00a0All\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Require\u00a0all\u00a0granted\n\u00a0\u00a0\u00a0\u00a0&lt;/Directory&gt;\n\n\u00a0\u00a0\u00a0\u00a0SSLEngine\u00a0on\n\u00a0\u00a0\u00a0\u00a0SSLCertificateFile\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0C:/MyPrograms/laragon/etc/ssl/laragon.crt\n\u00a0\u00a0\u00a0\u00a0SSLCertificateKeyFile\u00a0\u00a0\u00a0C:/myprograms/laragon/etc/ssl/laragon.key\n\n&lt;/VirtualHost&gt;\n</code></pre> <ul> <li>ligne 2\u00a0: la racine de l\u2019application, le dossier [apache] que nous avons cr\u00e9\u00e9\u00a0;</li> <li>lignes 23, 38\u00a0: la cible [main_witmysql.wsgi] que nous avons cr\u00e9\u00e9e\u00a0:</li> <li>ligne 7\u00a0: le serveur virtuel s\u2019appellera [flask-impots-withmysql]\u00a0;</li> <li>ligne 13\u00a0: la directive [WSGIPythonPath] permet d\u2019ajouter des dossiers au Python Path. Ici, Apache n\u2019a pas connaissance que nous avons utilis\u00e9 un environnement virtuel pour d\u00e9velopper l\u2019application et que tous les modules utilis\u00e9s par l\u2019application sont dans cet environnement virtuel. Aussi, ligne 13, nous ajoutons le dossier qui contient tous les modules de l\u2019environnement virtuel utilis\u00e9. Une possibilit\u00e9 est de copier ce dossier \u00e0 un autre endroit du syst\u00e8me de fichiers et de r\u00e9f\u00e9rencer cet endroit. Une autre possibilit\u00e9 est d\u2019ajouter ce dossier dans le Python Path directement dans la cible [main_witmysql.wsgi]\u00a0(c\u2019est probablement une meilleure solution)\u00a0;</li> <li>ligne 16\u00a0: on peut indiquer \u00e0 Apache le dossier d\u2019installation de Python dans le syst\u00e8me de fichiers. Normalement, celui-ci est dans le PATH de la machine et souvent cette ligne est inutile (c\u2019\u00e9tait le cas ici). Il peut cependant y avoir plusieurs installations de Python sur la machine et celle d\u00e9sir\u00e9e n\u2019est pas dans le PATH de la machine. Alors cette ligne r\u00e9soud le probl\u00e8me\u00a0; On cr\u00e9e de la m\u00eame fa\u00e7on un fichier [flask-impots-withpgres.conf]\u00a0:</li> </ul> <pre><code>#\u00a0dossier\u00a0du\u00a0script\u00a0.wsgi\ndefine\u00a0ROOT\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots/http-servers/12/apache\"\n\n#\u00a0nom\u00a0du\u00a0site\u00a0web\u00a0configur\u00e9\u00a0par\u00a0ce\u00a0fichier\n#\u00a0ici\u00a0il\u00a0s'appellera\u00a0flask-impots-withmysql\n#\u00a0les\u00a0URL\u00a0seront\u00a0du\u00a0type\u00a0http(s)://flask-impots-withmysql/chemin\ndefine\u00a0SITE\u00a0\"flask-impots-withpgres\"\n\n#\u00a0mettre\u00a0l'adresse\u00a0IP\u00a0127.0.0.1\u00a0pour\u00a0site\u00a0SITE\u00a0dans\u00a0c:/windows/system32/drivers/etc/hosts\n\n#\u00a0mettre\u00a0ici\u00a0les\u00a0chemins\u00a0des\u00a0biblioth\u00e8ques\u00a0Python\u00a0\u00e0\u00a0utiliser\u00a0-\u00a0les\u00a0s\u00e9parer\u00a0par\u00a0des\u00a0virgules\n#\u00a0ici\u00a0les\u00a0biblioth\u00e8ques\u00a0d'un\u00a0environnement\u00a0virtuel\u00a0Python\nWSGIPythonPath\u00a0\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/venv/lib/site-packages\"\n\n#\u00a0Python\u00a0Home\u00a0-\u00a0n\u00e9cessaire\u00a0uniquement\u00a0s'il\u00a0y\u00a0a\u00a0plusieurs\u00a0versions\u00a0de\u00a0Python\u00a0install\u00e9es\n#\u00a0WSGIPythonHome\u00a0\"C:/Program\u00a0Files/Python38\"\n\n#\u00a0URL\u00a0HTTP\n&lt;VirtualHost\u00a0*:80&gt;\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/impots\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/impots/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0o\u00f9\u00a0[prefixe_url]\u00a0est\u00a0d\u00e9fini\u00a0dans\u00a0parameters.py\n\u00a0\u00a0\u00a0\u00a0WSGIScriptAlias\u00a0/\u00a0\"${ROOT}/main_withpgres.wsgi\"\n\u00a0\u00a0\u00a0\u00a0DocumentRoot\u00a0\"${ROOT}\"\n\u00a0\u00a0\u00a0\u00a0ServerName\u00a0${SITE}\n\u00a0\u00a0\u00a0\u00a0ServerAlias\u00a0*.${SITE}\n\u00a0\u00a0\u00a0\u00a0&lt;Directory\u00a0\"${ROOT}\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0AllowOverride\u00a0All\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Require\u00a0all\u00a0granted\n\u00a0\u00a0\u00a0\u00a0&lt;/Directory&gt;\n&lt;/VirtualHost&gt;\n\n#\u00a0URL\u00a0s\u00e9curis\u00e9es\u00a0avec\u00a0HTTPS\n&lt;VirtualHost\u00a0*:443&gt;\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/impots\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/impots/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0o\u00f9\u00a0[prefixe_url]\u00a0est\u00a0d\u00e9fini\u00a0dans\u00a0parameters.py\n\u00a0\u00a0\u00a0\u00a0WSGIScriptAlias\u00a0/\u00a0\"${ROOT}/main_withpgres.wsgi\"\n\u00a0\u00a0\u00a0\u00a0DocumentRoot\u00a0\"${ROOT}\"\n\u00a0\u00a0\u00a0\u00a0ServerName\u00a0${SITE}\n\u00a0\u00a0\u00a0\u00a0ServerAlias\u00a0*.${SITE}\n\u00a0\u00a0\u00a0\u00a0&lt;Directory\u00a0\"${ROOT}\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0AllowOverride\u00a0All\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Require\u00a0all\u00a0granted\n\u00a0\u00a0\u00a0\u00a0&lt;/Directory&gt;\n\n\u00a0\u00a0\u00a0\u00a0SSLEngine\u00a0on\n\u00a0\u00a0\u00a0\u00a0SSLCertificateFile\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0C:/MyPrograms/laragon/etc/ssl/laragon.crt\n\u00a0\u00a0\u00a0\u00a0SSLCertificateKeyFile\u00a0\u00a0\u00a0C:/myprograms/laragon/etc/ssl/laragon.key\n\n&lt;/VirtualHost&gt;\n</code></pre> <p>Nous sauvegardons tous ces fichiers, lan\u00e7ons le serveur Apache et les SGBD MySQL et PostgreSQL. L\u2019application est configur\u00e9e avec le pr\u00e9fixe d\u2019URL [/do] et [with_csrftoken=False] (pas de jeton CSRF) dans [configs/parameters.py]. Nous demandons l\u2019URL [https://flask-impots-withmysql/do]. La r\u00e9ponse du serveur est la suivante\u00a0:</p> <p></p> <p>Nous demandons maintenant l\u2019URL [https://flask-impots-pgres/do]. La r\u00e9ponse est la suivante\u00a0:</p> <p></p> <p>Les deux applications fonctionnent normalement.</p> <p>Maintenant modifions le param\u00e8tre [WSGIScriptAlias] dans [flask-impots-withmysql.conf]\u00a0:</p> <pre><code>#\u00a0dossier\u00a0du\u00a0script\u00a0.wsgi\ndefine\u00a0ROOT\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots/http-servers/12/apache\"\n\n\u2026\n\n#\u00a0URL\u00a0HTTP\n&lt;VirtualHost\u00a0*:80&gt;\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/impots\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/impots/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0o\u00f9\u00a0[prefixe_url]\u00a0est\u00a0d\u00e9fini\u00a0dans\u00a0parameters.py\n\u00a0\u00a0\u00a0\u00a0WSGIScriptAlias\u00a0/impots\u00a0\"${ROOT}/main_withmysql.wsgi\"\n\u00a0\u00a0\u00a0\u00a0\u2026\n&lt;/VirtualHost&gt;\n\n#\u00a0URL\u00a0s\u00e9curis\u00e9es\u00a0avec\u00a0HTTPS\n&lt;VirtualHost\u00a0*:443&gt;\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/impots\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/impots/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0o\u00f9\u00a0[prefixe_url]\u00a0est\u00a0d\u00e9fini\u00a0dans\u00a0parameters.py\n\u00a0\u00a0\u00a0\u00a0WSGIScriptAlias\u00a0/impots\u00a0\"${ROOT}/main_withmysql.wsgi\"\n\u00a0\u00a0\u00a0\u00a0\u2026\n\n&lt;/VirtualHost&gt;\n</code></pre> <ul> <li>lignes 11 et 20, l\u2019alias WSI est d\u00e9sormais [/impots]\u00a0; Nous arr\u00eatons / relan\u00e7ons le serveur Apache puis nous demandons l\u2019URL [https://flask-impots-withmysql/impots/do]. La r\u00e9ponse du serveur est la suivante\u00a0:</li> </ul> <p></p> <p>Il y a un plantage. L\u2019URL [1] nous en donne la cause. Elle aurait du \u00eatre [https://flask-impots-withmysql/impots/do/afficher-vue-authentification]. L\u2019alias WSGI manque. C\u2019est une erreur de notre application. Elle sait g\u00e9rer un pr\u00e9fixe d\u2019URL (/do est bien pr\u00e9sent). On pourrait penser qu\u2019en mettant le pr\u00e9fixe [/impots/do] \u00e0 notre application cela r\u00e9soudrait le probl\u00e8me pr\u00e9c\u00e9dent. Mais non. On rencontre alors d\u2019autres types de probl\u00e8mes. L\u2019alias WSGI ne se comporte pas comme un pr\u00e9fixe d\u2019URL.</p> <p>Essayons de comprendre ce qui s\u2019est pass\u00e9. Nous avons demand\u00e9 l\u2019URL [https://flask-impots-withmysql/impots/do]. Nous nous attendions \u00e0 avoir la vue d\u2019authentification. En [1], ci-dessus on voit que l\u2019application a demand\u00e9 son affichage mais pas avec la bonne URL. Examinons le cheminement de la requ\u00eate [https://flask-impots-withmysql/impots/do].</p> <p>Tout d\u2019abord la route suivante (configs/routes.py) a \u00e9t\u00e9 ex\u00e9cut\u00e9e\u00a0:</p> <pre><code>\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0routes\u00a0de\u00a0l'application\u00a0Flask\n\u00a0\u00a0\u00a0\u00a0#\u00a0racine\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/',\u00a0methods=['GET'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.index)\n</code></pre> <p>La route de la ligne 3 est dans notre exemple [https://flask-impots-withmysql/impots/do]. On voit que la route a \u00e9t\u00e9 d\u00e9barrass\u00e9e de la partie [https://flask-impots-withmysql/impots] pour devenir simplement [/do]. Pour la partie [https://flask-impots-withmysql] c\u2019est normal, le nom du serveur n\u2019est pas repris dans la route. Mais on voit qu\u2019il ne reprend pas non plus l\u2019alias WSGI [/impots]. C\u2019est un point important. M\u00eame avec un alais WSGI nos routes initiales restent valides.</p> <p>Maintenant voyons ce que fait la fonction [index] de la ligne 4 (configs/routes_without_csrftoken)\u00a0:</p> <pre><code>#\u00a0racine\u00a0de\u00a0l'application\ndef\u00a0index()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\u00a0/init-session/html\n\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(url_for(\"init_session\",\u00a0type_response=\"html\"),\u00a0status.HTTP_302_FOUND)\n</code></pre> <p>Ligne 4, on est redirig\u00e9 vers l\u2019URL de la fonction [init_session]. Dans [configs/routes.py], cette fonction a \u00e9t\u00e9 associ\u00e9e \u00e0 la route [/do/init-session/html]\u00a0:</p> <pre><code>\u00a0\u00a0\u00a0\u00a0#\u00a0init-session\n\u00a0\u00a0\u00a0\u00a0app.add_url_rule(f'{prefix_url}/init-session/&lt;string:type_response&gt;{csrftoken_param}',\u00a0methods=['GET'],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_func=routes.init_session)\n</code></pre> <p>Ligne 2, dans notre test [csrftoken_param] est la cha\u00eene vide. L\u2019application ne g\u00e8re pas ici de jeton CSRF.</p> <p>La fonction [init_session] est d\u00e9finie de la fa\u00e7on suivante (configs/routes_without_csrftoken)\u00a0:</p> <pre><code>#\u00a0init-session\ndef\u00a0init_session(type_response:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre> <p>Ligne 4, on commence la cha\u00eene de traitement de l\u2019action [init-session]. Cette cha\u00eene se termine de la fa\u00e7on suivante dans [responses/HtmlResponse]\u00a0:</p> <pre><code>\u2026\n#\u00a0maintenant\u00a0il\u00a0faut\u00a0g\u00e9n\u00e9rer\u00a0l'URL\u00a0de\u00a0redirection\u00a0sans\u00a0oublier\u00a0le\u00a0jeton\u00a0CSRF\u00a0s'il\u00a0est\u00a0demand\u00e9\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0config['parameters']['with_csrftoken']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrf_token\u00a0=\u00a0f\"/{generate_csrf()}\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrf_token\u00a0=\u00a0\"\"\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9ponse\u00a0de\u00a0redirection\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(f\"{config['parameters']['prefix_url']}{ads['to']}{csrf_token}\"),\u00a0status.HTTP_302_FOUND\n</code></pre> <p>L\u2019action [init-session] est une action ADS (Action Do Something) qui se termine pas une redirection vers une vue, ligne 9. C\u2019est l\u00e0 que r\u00e9side le probl\u00e8me. La fonction [redirect] de la ligne 9, n\u2019ajoute pas automatiquement l\u2019alias WSGI \u00e0 l\u2019URL de redirection. C\u2019est ce que nous montre la copie d\u2019\u00e9cran ci-dessus. Il manque l\u2019alias /impots dans l\u2019URL objet de la redirection.</p> <p>La version suivante apporte une solution au probl\u00e8me d\u2019alias WSGI.</p>"},{"location":"exercice-dapplication-version-18.html","title":"38. Exercice d\u2019application\u00a0: version 18","text":""},{"location":"exercice-dapplication-version-18.html#381-implementation","title":"38.1. Impl\u00e9mentation","text":"<p>Le dossier [impots/http-servers/13] est obtenu initialement par recopie du dossier [impots/http-servers/12] puis modifi\u00e9 partiellement.</p> <p>Nous commen\u00e7ons par ajouter un nouveau param\u00e8tre dans le fichier [configs/parameters]\u00a0:</p> <pre><code>\u2026\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\n        #\u00a0token\u00a0csrf\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"with_csrftoken\":\u00a0False,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0bases\u00a0g\u00e9r\u00e9es\u00a0MySQL\u00a0(mysql),\u00a0PostgreSQL\u00a0(pgres)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"databases\":\u00a0[\"mysql\",\u00a0\"pgres\"],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pr\u00e9fixe\u00a0des\u00a0URL\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mettre\u00a0la\u00a0cha\u00eene\u00a0vide\u00a0si\u00a0on\u00a0ne\u00a0veut\u00a0pas\u00a0de\u00a0pr\u00e9fixe\u00a0ou\u00a0/pr\u00e9fixe\u00a0sinon\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"prefix_url\":\u00a0\"/do\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0url\u00a0racine\u00a0du\u00a0serveur\u00a0Apache\u00a0-\u00a0mettre\u00a0la\u00a0cha\u00eene\u00a0vide\u00a0pour\u00a0une\u00a0ex\u00e9cution\u00a0en-dehors\u00a0d'Apache\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"application_root\":\u00a0\"/impots\"\n\u2026\n</code></pre> <p>Ligne 10, le param\u00e8tre [application_root] repr\u00e9sentera l\u2019alias WSGI du serveur virtuel Apache.</p> <p>Avec ce param\u00e8tre, nous pouvons corriger l\u2019instruction de [responses/HtmlResponse] qui avait provoqu\u00e9 l\u2019erreur\u00a0:</p> <p></p> <pre><code>\u2026\n#\u00a0maintenant\u00a0il\u00a0faut\u00a0g\u00e9n\u00e9rer\u00a0l'URL\u00a0de\u00a0redirection\u00a0sans\u00a0oublier\u00a0le\u00a0jeton\u00a0CSRF\u00a0s'il\u00a0est\u00a0demand\u00e9\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0config['parameters']['with_csrftoken']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrf_token\u00a0=\u00a0f\"/{generate_csrf()}\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrf_token\u00a0=\u00a0\"\"\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9ponse\u00a0de\u00a0redirection\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(f\"{config['parameters']['application_root']}{config['parameters']['prefix_url']}{ads['to']}{csrf_token}\")\n,\u00a0status.HTTP_302_FOUND\n</code></pre> <ul> <li>ligne 9\u00a0: nous avons ajout\u00e9 la racine de l\u2019application au d\u00e9but de l\u2019URL cible de la redirection\u00a0; Il nous faut \u00e9galement corriger tous les fragments pour que les URL qu\u2019ils contiennent commencent par la racine de l\u2019application (ou alias WSGI)\u00a0:</li> </ul> <p></p> <p>Le fragment [v-authentification]</p> <pre><code>&lt;!--\u00a0formulaire\u00a0HTML\u00a0-\u00a0on\u00a0poste\u00a0ses\u00a0valeurs\u00a0avec\u00a0l'action\u00a0[authentifier-utilisateur]\u00a0--&gt;\n&lt;form\u00a0method=\"post\"\u00a0action=\"{{mod\u00e8le.application_root}}{{mod\u00e8le.prefix_url}}/authentifier-utilisateur{{mod\u00e8le.csrf_token}}\"\n&gt;\n\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0titre\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"alert\u00a0alert-primary\"\u00a0role=\"alert\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;h4&gt;Veuillez\u00a0vous\u00a0authentifier&lt;/h4&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u2026\n\n&lt;/form&gt;\n</code></pre> <p>Le fragment [v-calcul-impot]</p> <pre><code>&lt;!--\u00a0formulaire\u00a0HTML\u00a0post\u00e9\u00a0--&gt;\n&lt;form\u00a0method=\"post\"\u00a0action=\"{{mod\u00e8le.application_root}}{{mod\u00e8le.prefix_url}}/calculer-impot{{mod\u00e8le.csrf_token}}\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0message\u00a0sur\u00a012\u00a0colonnes\u00a0sur\u00a0fond\u00a0bleu\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u2026\n\n&lt;/form&gt;\n</code></pre> <p>Le fragment [v-liste-simulations]</p> <pre><code>\u2026\n\n{%\u00a0if\u00a0mod\u00e8le.simulations\u00a0is\u00a0defined\u00a0and\u00a0mod\u00e8le.simulations|length!=0\u00a0%}\n\u2026\n\n&lt;!--\u00a0tableau\u00a0des\u00a0simulations\u00a0--&gt;\n&lt;table\u00a0class=\"table\u00a0table-sm\u00a0table-hover\u00a0table-striped\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u2026\n\u00a0\u00a0\u00a0\u00a0&lt;tr&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;th\u00a0scope=\"row\"&gt;{{simulation.id}}&lt;/th&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.mari\u00e9}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.enfants}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.salaire}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.imp\u00f4t}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.surc\u00f4te}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.d\u00e9c\u00f4te}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.r\u00e9duction}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.taux}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;&lt;a\u00a0href=\"{{mod\u00e8le.application_root}}{{mod\u00e8le.prefix_url}}/supprimer-simulation/{{simulation.id}}{{mod\u00e8le.csrf_token}}\"&gt;Supprimer&lt;/a&gt;&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/tr&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0endfor\u00a0%}\n\u00a0\u00a0\u00a0\u00a0&lt;/tr&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/tbody&gt;\n&lt;/table&gt;\n{%\u00a0endif\u00a0%}\n</code></pre> <p>Le fragment [v-menu]</p> <pre><code>&lt;!--\u00a0menu\u00a0Bootstrap\u00a0--&gt;\n&lt;nav\u00a0class=\"nav\u00a0flex-column\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0affichage\u00a0d'une\u00a0liste\u00a0de\u00a0liens\u00a0HTML\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0for\u00a0optionMenu\u00a0in\u00a0mod\u00e8le.optionsMenu\u00a0%}\n\u00a0\u00a0\u00a0\u00a0&lt;a\u00a0class=\"nav-link\"\u00a0href=\"{{mod\u00e8le.application_root}}{{mod\u00e8le.prefix_url}}{{optionMenu.url}}{{mod\u00e8le.csrf_token}}\"&gt;{{optionMenu.text}}&lt;/a&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0endfor\u00a0%}\n&lt;/nav&gt;\n</code></pre> <p>Les fragments ci-dessus utilisent tous le mod\u00e8le [mod\u00e8le.application_root]. Pour l\u2019instant la cl\u00e9 [application_root] n\u2019existe pas dans les mod\u00e8les g\u00e9n\u00e9r\u00e9s par les classes de mod\u00e8les.</p> <p></p> <p>La classe [AbstractBaseModelForView] qui est la classe parent de toutes les classes g\u00e9n\u00e9rant un mod\u00e8le devient la suivante\u00a0:</p> <pre><code>from\u00a0abc\u00a0import\u00a0abstractmethod\n\nfrom\u00a0flask\u00a0import\u00a0Request\nfrom\u00a0flask_wtf.csrf\u00a0import\u00a0generate_csrf\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceModelForView\u00a0import\u00a0InterfaceModelForView\n\nclass\u00a0AbstractBaseModelForView(InterfaceModelForView):\n\n\u00a0\u00a0\u00a0\u00a0@abstractmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0get_model_for_view(self,\u00a0request:\u00a0Request,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0update_model(self,\u00a0mod\u00e8le:\u00a0dict,\u00a0config:\u00a0dict):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0du\u00a0jeton\u00a0CSRF\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0config['parameters']['with_csrftoken']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrf_token\u00a0=\u00a0f\"/{generate_csrf()}\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0csrf_token\u00a0=\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mise\u00a0\u00e0\u00a0jour\u00a0du\u00a0mod\u00e8le\u00a0pass\u00e9\u00a0en\u00a0param\u00e8tre\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le.update({\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0jeton\u00a0csrf\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0'csrf_token':\u00a0csrf_token,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0prefix_url\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0'prefix_url':\u00a0config[\"parameters\"][\"prefix_url\"],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0application_root\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0'application_root':\u00a0config[\"parameters\"][\"application_root\"],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0})\n</code></pre> <ul> <li>ligne 15\u00a0: la m\u00e9thode [update_model] a pour r\u00f4le de mettre dans le mod\u00e8le des vues\u00a0:</li> <li>ligne 24\u00a0: le jeton CSRF\u00a0;</li> <li>ligne 26\u00a0: le pr\u00e9fixe des URL\u00a0;</li> <li>ligne 28\u00a0: la racine de l\u2019application ou alias WSGI\u00a0; Les quatre classes filles font appel \u00e0 la classe parent avec le code suivant\u00a0:</li> </ul> <pre><code>\u2026\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0possibles\u00a0\u00e0\u00a0partir\u00a0de\u00a0la\u00a0vue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le['actions_possibles']\u00a0=\u00a0[\"afficher-vue-authentification\",\u00a0\"authentifier-utilisateur\"]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0finition\u00a0du\u00a0mod\u00e8le\u00a0par\u00a0la\u00a0classe\u00a0parent\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0super().update_model(mod\u00e8le,\u00a0config)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0mod\u00e8le\n</code></pre> <ul> <li>ligne 6\u00a0: chaque classe fille appelle sa classe parent pour mettre \u00e0 jour le mod\u00e8le qu\u2019elle a cr\u00e9\u00e9\u00a0; La version 18 est pr\u00eate. Nous reprenons les deux serveurs virtuels d\u2019Apache de la version 17 et nous les modifions\u00a0:</li> </ul> <p></p> <p>Les deux fichiers [flask-impots-withXX.conf] ne sont modifi\u00e9s qu\u2019en un seul point\u00a0:</p> <pre><code>#\u00a0dossier\u00a0du\u00a0script\u00a0.wsgi\ndefine\u00a0ROOT\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots/http-servers/13/apache\"\n\n#\u00a0nom\u00a0du\u00a0site\u00a0web\u00a0configur\u00e9\u00a0par\u00a0ce\u00a0fichier\n#\u00a0ici\u00a0il\u00a0s'appellera\u00a0flask-impots-withmysql\n#\u00a0les\u00a0URL\u00a0seront\u00a0du\u00a0type\u00a0http(s)://flask-impots-withmysql/chemin\ndefine\u00a0SITE\u00a0\"flask-impots-withmysql\"\n\n#\u00a0mettre\u00a0l'adresse\u00a0IP\u00a0127.0.0.1\u00a0pour\u00a0site\u00a0SITE\u00a0dans\u00a0c:/windows/system32/drivers/etc/hosts\n\n#\u00a0mettre\u00a0ici\u00a0les\u00a0chemins\u00a0des\u00a0biblioth\u00e8ques\u00a0Python\u00a0\u00e0\u00a0utiliser\u00a0-\u00a0les\u00a0s\u00e9parer\u00a0par\u00a0des\u00a0virgules\n#\u00a0ici\u00a0les\u00a0biblioth\u00e8ques\u00a0d'un\u00a0environnement\u00a0virtuel\u00a0Python\nWSGIPythonPath\u00a0\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/venv/lib/site-packages\"\n\n#\u00a0Python\u00a0Home\u00a0-\u00a0n\u00e9cessaire\u00a0uniquement\u00a0s'il\u00a0y\u00a0a\u00a0plusieurs\u00a0versions\u00a0de\u00a0Python\u00a0install\u00e9es\n#\u00a0WSGIPythonHome\u00a0\"C:/Program\u00a0Files/Python38\"\n\n#\u00a0URL\u00a0HTTP\n&lt;VirtualHost\u00a0*:80&gt;\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/impots\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/impots/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0o\u00f9\u00a0[prefixe_url]\u00a0est\u00a0d\u00e9fini\u00a0dans\u00a0parameters.py\n\u00a0\u00a0\u00a0\u00a0WSGIScriptAlias\u00a0/impots\u00a0\"${ROOT}/main_withmysql.wsgi\"\n\u00a0\u00a0\u00a0\u00a0\u2026\n&lt;/VirtualHost&gt;\n\n#\u00a0URL\u00a0s\u00e9curis\u00e9es\u00a0avec\u00a0HTTPS\n&lt;VirtualHost\u00a0*:443&gt;\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0avec\u00a0l'alias\u00a0/impots\u00a0les\u00a0URL\u00a0auront\u00a0la\u00a0forme\u00a0/impots/{prefixe_url}/action/...\n\u00a0\u00a0\u00a0\u00a0#\u00a0o\u00f9\u00a0[prefixe_url]\u00a0est\u00a0d\u00e9fini\u00a0dans\u00a0parameters.py\n\u00a0\u00a0\u00a0\u00a0WSGIScriptAlias\u00a0/impots\u00a0\"${ROOT}/main_withmysql.wsgi\"\n\u00a0\u00a0\u00a0\u00a0..\n\n&lt;/VirtualHost&gt;\n</code></pre> <ul> <li> <p>ligne 12, on utilise maintenant le dossier [impots/http-servers/13/apache]. Nous sommes pr\u00eats pour les tests de la version 18 port\u00e9e sur Apache. La configuration est la suivante\u00a0:</p> </li> <li> <p>l\u2019alias WSGI est /impots\u00a0dans les deux fichiers de configuration des serveurs virtuels\u00a0;</p> </li> <li>dans le fichier de param\u00e9trage [configs/parameters], les param\u00e8tres sont les suivants\u00a0: <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0token\u00a0csrf\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"with_csrftoken\":\u00a0False,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pr\u00e9fixe\u00a0des\u00a0URL\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mettre\u00a0la\u00a0cha\u00eene\u00a0vide\u00a0si\u00a0on\u00a0ne\u00a0veut\u00a0pas\u00a0de\u00a0pr\u00e9fixe\u00a0ou\u00a0/pr\u00e9fixe\u00a0sinon\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"prefix_url\":\u00a0\"/do\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0url\u00a0racine\u00a0du\u00a0serveur\u00a0Apache\u00a0-\u00a0mettre\u00a0la\u00a0cha\u00eene\u00a0vide\u00a0pour\u00a0une\u00a0ex\u00e9cution\u00a0en-dehors\u00a0d'Apache\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"application_root\":\u00a0\"/impots\"\n</code></pre></li> </ul> <p>On lance le serveur Apache ainsi que les deux SGBD. On demande l\u2019URL [https://flask-impots-withmysql/impots/do]. La r\u00e9ponse du serveur est la suivante\u00a0:</p> <p></p> <p>On obtient bien la vue d\u2019authentification qu\u2019on n\u2019avait pu obtenir dans la version pr\u00e9c\u00e9dente. Le reste de l\u2019application fonctionne normalement.</p> <p>Maintenant on teste l\u2019autre serveur virtuel. On demande l\u2019URL [https://flask-impots-withpgres/impots/do]. La r\u00e9ponse du serveur est la suivante\u00a0:</p> <p></p> <p>Les notions d\u2019alias WSGI et de pr\u00e9fixe d\u2019URL jouent le m\u00eame r\u00f4le. L\u2019une de ces deux notions est redondante. Ainsi pour pr\u00e9fixer les URL du serveur Apache avec la cha\u00eene [/impots/do], on peut s\u2019y prendre de trois mani\u00e8res\u00a0:</p> <p>1 \u2013 [WGSIAlias /impots] et [prefix_url=\u2019/do\u2019]\u00a0;</p> <p>2 - [WGSIAlias /] et [prefix_url=\u2019/impots/do\u2019]\u00a0;</p> <p>3 - [WGSIAlias /impots/do] et [prefix_url=\u2019\u2019]\u00a0;</p>"},{"location":"exercice-dapplication-version-18.html#382-tests-console","title":"38.2. Tests console","text":"<p>On utilise de nouveau les tests console du client [http-clients/09]\u00a0:</p> <p></p> <ul> <li>l\u2019URL du serveur doit \u00eatre modifi\u00e9e dans les configurations [1] et [3]\u00a0;</li> <li>il faut apporter une modification \u00e0 la couche [dao] pour qu\u2019elle supporte le protocole HTTPS du serveur Apache\u00a0; Dans les fichiers [config], l\u2019URL du serveur devient la suivante\u00a0:</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"server\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\"urlServer\":\u00a0\"http://127.0.0.1:5000\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\"urlServer\":\u00a0\"http://127.0.0.1:5000/do\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"urlServer\":\u00a0\"https://flask-impots-withmysql/impots/do\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"user\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"login\":\u00a0\"admin\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"admin\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"url_services\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mode\u00a0debug\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"debug\":\u00a0True,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0csrf_token\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"with_csrftoken\":\u00a0False,\n</code></pre> <ul> <li>ligne 4\u00a0: la nouvelle URL du serveur. Pour la 1\u00e8re fois dans ce document, le client utilise le protocole HTTPS\u00a0; La classe [Imp\u00f4tsDaoWihHttpSession] de la couche [dao] \u00e9volue de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code>\u2026\u00a0\u00a0\u00a0\u00a0\n    #\u00a0\u00e9tape\u00a0request\u00a0/\u00a0response\n\u00a0\u00a0\u00a0\u00a0def\u00a0get_response(self,\u00a0method:\u00a0str,\u00a0url_service:\u00a0str,\u00a0data_value:\u00a0dict\u00a0=\u00a0None,\u00a0json_value=None):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0[method]\u00a0:\u00a0m\u00e9thode\u00a0HTTP\u00a0GET\u00a0ou\u00a0POST\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0[url_service]\u00a0:\u00a0URL\u00a0de\u00a0service\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0[data]\u00a0:\u00a0param\u00e8tres\u00a0du\u00a0POST\u00a0en\u00a0x-www-form-urlencoded\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0[json]\u00a0:\u00a0param\u00e8tres\u00a0du\u00a0POST\u00a0en\u00a0json\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0[cookies]:\u00a0cookies\u00a0\u00e0\u00a0inclure\u00a0dans\u00a0la\u00a0requ\u00eate\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0doit\u00a0avoir\u00a0une\u00a0session\u00a0XML\u00a0ou\u00a0JSON,\u00a0sinon\u00a0on\u00a0ne\u00a0pourra\u00a0pas\u00a0g\u00e9rer\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0self.__session_type\u00a0not\u00a0in\u00a0['json',\u00a0'xml']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0raise\u00a0Imp\u00f4tsError(73,\u00a0\"il\u00a0n'y\u00a0a\u00a0pas\u00a0de\u00a0session\u00a0valide\u00a0en\u00a0cours\")\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ajoute\u00a0le\u00a0jeton\u00a0CSRF\u00a0\u00e0\u00a0l'URL\u00a0de\u00a0service\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0self.__csrf_token:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_service\u00a0=\u00a0f\"{url_service}/{self.__csrf_token}\"\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ex\u00e9cution\u00a0de\u00a0la\u00a0requ\u00eate\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response\u00a0=\u00a0requests.request(method,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0url_service,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0data=data_value,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0json=json_value,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0cookies=self.__cookies,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0allow_redirects=True,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0pour\u00a0le\u00a0protocole\u00a0https\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0verify=False)\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mode\u00a0debug\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0self.__debug:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0logueur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0self.__logger:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__logger\u00a0=\u00a0self.__config['logger']\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0logue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0self.__logger.write(f\"{response.text}\\n\")\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0r\u00e9sultat['r\u00e9ponse']\n</code></pre> <ul> <li>ligne 26, on ajoute le param\u00e8tre [verify=False] \u00e0 cause du protocole HTTPS utilis\u00e9 par le serveur Apache. Le module [requests] (ligne 19) sait g\u00e9rer nativement le protocole HTTPS. Par d\u00e9faut, il v\u00e9rifie la validit\u00e9 du certificat de s\u00e9curit\u00e9 que lui envoie le serveur HTTPS et lance une exception si le certificat re\u00e7u n\u2019est pas valide. C\u2019est le cas ici o\u00f9 le serveur Apache de Laragon envoie un certificat auto-sign\u00e9. Pour \u00e9viter l\u2019exception, on utilise le param\u00e8tre [verify=False] pour dire au module [requests] de ne pas lancer d\u2019exception. [requests] se contente alors d\u2019afficher un avertissement (warning) sur la console. Ces modifications faites, tous les tests console doivent fonctionner.</li> </ul>"},{"location":"exercice-dapplication-version-2.html","title":"10. Exercice d\u2019application\u00a0: version 2","text":"<p>Cette nouvelle version introduit le fichier [config.py]\u00a0suivant\u00a0:</p> <pre><code>def\u00a0configure():\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0absolu\u00a0du\u00a0dossier\u00a0de\u00a0ce\u00a0script\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0racine\u00a0\u00e0\u00a0partir\u00a0de\u00a0laquelle\u00a0vont\u00a0\u00eatre\u00a0mesur\u00e9s\u00a0certains\u00a0chemins\u00a0relatifs\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots\"\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/v01/shared\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0absolu\u00a0du\u00a0fichier\u00a0des\u00a0contribuables\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"taxpayersFilename\":\u00a0f\"{script_dir}/../data/taxpayersdata.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0chemins\u00a0absolu\u00a0du\u00a0fichier\u00a0des\u00a0r\u00e9sultats\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"resultsFilename\":\u00a0f\"{script_dir}/../data/r\u00e9sultats.txt\"\n\u00a0\u00a0\u00a0\u00a0}\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0mise\u00a0\u00e0\u00a0jour\u00a0du\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 5\u00a0: on r\u00e9cup\u00e8re le nom absolu du dossier qui contient le script qui s\u2019ex\u00e9cute, ici le script [config.py]. On obtient donc le nom absolu du dossier [main]. C\u2019est \u00e9galement ce dossier qui contient le script principal [main.py]\u00a0;</li> <li>ligne 8\u00a0: lorsqu\u2019un fichier r\u00e9f\u00e9renc\u00e9 n\u2019appartient pas au dossier de l\u2019application, on n\u2019utilisera pas [script_dir] pour le localiser mais [root_dir]. Cette ligne devra \u00eatre chang\u00e9e d\u00e8s que l\u2019application change de place dans le syst\u00e8me de fichiers\u00a0;</li> <li>lignes 11-13\u00a0: on liste les noms absolus de tous les dossiers qui doivent se trouver dans le Python Path pour que l\u2019application fonctionne. Ligne 12, on r\u00e9f\u00e9rence le dossier [shared] de la version 1 de l\u2019exercice d\u2019application\u00a0;</li> <li>lignes 16-21\u00a0: d\u00e9finissent la configuration de l\u2019application dans un dictionnaire [config]. Ici on inscrit les chemins absolus des fichiers texte manipul\u00e9s par l\u2019application. Pour cela, on utilise [script_dir] qui rappelons-le, d\u00e9signe ici le dossier [main]\u00a0;</li> <li>lignes 24-25\u00a0: on fixe le Python Path n\u00e9cessaire \u00e0 l\u2019application\u00a0; Le script principal [main.py] est le suivant\u00a0:</li> </ul> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom imp\u00f4ts_module_01 import calcul_imp\u00f4t, record_results, get_taxpayers_data\n\n# fichier des contribuables\ntaxpayers_filename = config['taxpayersFilename']\n# fichier des r\u00e9sultats\nresults_filename = config['resultsFilename']\n\n# code\ntry:\n\n    # lecture des donn\u00e9es contribuables\n    taxpayers = get_taxpayers_data(taxpayers_filename)\n    # liste des r\u00e9sultats\n    results = []\n    # on calcule l'imp\u00f4t des contribuables\n    for taxpayer in taxpayers:\n        # le calcul de l'imp\u00f4t renvoie un dictionnaire de cl\u00e9s\n        # ['mari\u00e9', 'enfants', 'salaire', 'imp\u00f4t', 'surc\u00f4te', 'd\u00e9c\u00f4te', 'r\u00e9duction', 'taux']\n        result = calcul_imp\u00f4t(taxpayer['mari\u00e9'], taxpayer['enfants'], taxpayer['salaire'])\n        # le dictionnaire est ajout\u00e9 \u00e0 la liste des r\u00e9sultats\n        results.append(result)\n    # on enregistre les r\u00e9sultats\n    record_results(results_filename, results)\nexcept BaseException as erreur:\n    # il peut y avoir diff\u00e9rentes erreurs : absence de fichier, contenu de fichier incorrect\n    # on affiche l'erreur et on quitte l'application\n    print(f\"L'erreur suivante s'est produite : {erreur}]\\n\")\nfinally:\n    print(\"Travail termin\u00e9...\")\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 1-4\u00a0: l\u2019application est configur\u00e9e\u00a0;</li> <li>ligne 7\u00a0: on sait qu\u2019apr\u00e8s la configuration, le Python Path est correct et contient notamment le dossier [shared] qui contient le script [imp\u00f4ts_module_01]. De ce script, on importe les fonctions dont on a besoin\u00a0;</li> <li>lignes 9-12\u00a0: les noms des fichiers utilis\u00e9s sont trouv\u00e9s dans la configuration. Ce sont des noms absolus\u00a0;</li> <li>lignes 14-35\u00a0: on retrouve le code de la version 1\u00a0; La version 1 ne marchait pas dans une console Python. Dans cette m\u00eame console, la version 2 donne les r\u00e9sultats suivants\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\impots\\v02&gt;python main/main.py\nTravail termin\u00e9...\n</code></pre> <p>Aucune erreur n\u2019est d\u00e9sormais rencontr\u00e9e.</p>"},{"location":"exercice-dapplication-version-3.html","title":"11. Exercice d\u2019application\u00a0: version 3","text":"<p>Cette nouvelle version introduit deux changements\u00a0:</p> <ul> <li> <p>les donn\u00e9es n\u00e9cessaires au calcul de l'imp\u00f4t et fournies par l'administration fiscale sont plac\u00e9es dans un fichier jSON\u00a0[admindata.json]: <pre><code>{\n    \"limites\": [9964, 27519, 73779, 156244, 0],\n    \"coeffR\": [0, 0.14, 0.3, 0.41, 0.45],\n    \"coeffN\": [0, 1394.96, 5798, 13913.69, 20163.45],\n    \"PLAFOND_QF_DEMI_PART\": 1551,\n    \"PLAFOND_REVENUS_CELIBATAIRE_POUR_REDUCTION\": 21037,\n    \"PLAFOND_REVENUS_COUPLE_POUR_REDUCTION\": 42074,\n    \"VALEUR_REDUC_DEMI_PART\": 3797,\n    \"PLAFOND_DECOTE_CELIBATAIRE\": 1196,\n    \"PLAFOND_DECOTE_COUPLE\": 1970,\n    \"PLAFOND_IMPOT_COUPLE_POUR_DECOTE\": 2627,\n    \"PLAFOND_IMPOT_CELIBATAIRE_POUR_DECOTE\": 1595,\n    \"ABATTEMENT_DIXPOURCENT_MAX\": 12502,\n    \"ABATTEMENT_DIXPOURCENT_MIN\": 437\n}\n</code></pre></p> </li> <li> <p>les r\u00e9sultats du calcul de l'imp\u00f4t seront eux \u00e9galement plac\u00e9s dans un fichier jSON\u00a0[r\u00e9sultats.json] : <pre><code>[\n  {\n    \"mari\u00e9\": \"oui\",\n    \"enfants\": 2,\n    \"salaire\": 55555,\n    \"imp\u00f4t\": 2814,\n    \"surc\u00f4te\": 0,\n    \"d\u00e9c\u00f4te\": 0,\n    \"r\u00e9duction\": 0,\n    \"taux\": 0.14\n  },\n  {\n    \"mari\u00e9\": \"oui\",\n    \"enfants\": 2,\n    \"salaire\": 50000,\n    \"imp\u00f4t\": 1384,\n    \"surc\u00f4te\": 0,\n    \"d\u00e9c\u00f4te\": 384,\n    \"r\u00e9duction\": 347,\n    \"taux\": 0.14\n  },\n  \u2026\n  {\n    \"mari\u00e9\": \"oui\",\n    \"enfants\": 3,\n    \"salaire\": 200000,\n    \"imp\u00f4t\": 42842,\n    \"surc\u00f4te\": 17283,\n    \"d\u00e9c\u00f4te\": 0,\n    \"r\u00e9duction\": 0,\n    \"taux\": 0.41\n  }\n]\n</code></pre></p> </li> </ul>"},{"location":"exercice-dapplication-version-3.html#111-le-script-de-configuration-configpy","title":"11.1. Le script de configuration [config.py]","text":"<p>Le script de configuration sera le suivant\u00a0:</p> <pre><code>def\u00a0configure():\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0absolu\u00a0du\u00a0dossier\u00a0de\u00a0ce\u00a0script\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../shared\",\n\u00a0\u00a0\u00a0\u00a0]\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0absolu\u00a0du\u00a0fichier\u00a0des\u00a0contribuables\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"taxpayersFilename\":\u00a0f\"{script_dir}/../data/taxpayersdata.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0absolu\u00a0du\u00a0fichier\u00a0des\u00a0r\u00e9sultats\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"resultsFilename\":\u00a0f\"{script_dir}/../data/r\u00e9sultats.json\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0absolu\u00a0du\u00a0fichier\u00a0des\u00a0donn\u00e9es\u00a0de\u00a0l'administration\u00a0fiscale\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"admindataFilename\":\u00a0f\"{script_dir}/../data/admindata.json\"\n\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0#\u00a0mise\u00a0\u00e0\u00a0jour\u00a0du\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <ul> <li>ligne 8\u00a0: on met le dossier [shared] dans le Python Path. Ce dossier contient le module [imp\u00f4ts_module_02] utilis\u00e9 par le script principal\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-3.html#112-script-principal-mainpy","title":"11.2. Script principal [main.py]","text":"<p>Le script principal de la version 3 est le suivant\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom imp\u00f4ts_module_02 import calcul_imp\u00f4t, get_admindata, get_taxpayers_data, record_results_in_json_file\n\n# fichier des contribuables\ntaxpayers_filename = config['taxpayersFilename']\n# fichier des r\u00e9sultats\nresults_filename = config['resultsFilename']\n# fichier des donn\u00e9es de l'administration fiscale\nadmindata_filename = config['admindataFilename']\n# code\ntry:\n\n    # lecture des donn\u00e9es de l'administration fiscale\n    admindata = get_admindata(admindata_filename)\n    # lecture des donn\u00e9es contribuables\n    taxpayers = get_taxpayers_data(taxpayers_filename)\n    # liste des r\u00e9sultats\n    results = []\n    # on calcule l'imp\u00f4t des contribuables\n    for taxpayer in taxpayers:\n        # le calcul de l'imp\u00f4t renvoie un dictionnaire de cl\u00e9s\n        # ['mari\u00e9', 'enfants', 'salaire', 'imp\u00f4t', 'surc\u00f4te', 'd\u00e9c\u00f4te', 'r\u00e9duction', 'taux']\n        result = calcul_imp\u00f4t(admindata, taxpayer['mari\u00e9'], taxpayer['enfants'], taxpayer['salaire'])\n        # le dictionnaire est ajout\u00e9 \u00e0 la liste des r\u00e9sultats\n        results.append(result)\n    # on enregistre les r\u00e9sultats\n    record_results_in_json_file(results_filename, results)\nexcept BaseException as erreur:\n    # il peut y avoir diff\u00e9rentes erreurs : absence de fichier, contenu de fichier incorrect\n    # on affiche l'erreur et on quitte l'application\n    print(f\"L'erreur suivante s'est produite : {erreur}]\\n\")\nfinally:\n    print(\"Travail termin\u00e9...\")\n</code></pre> <p>Notes</p> <ul> <li>lignes 2-4, on configure l\u2019application notamment son Python Path\u00a0;</li> <li>ligne 7\u00a0: on importe les fonctions dont on a besoin dans [main.py]\u00a0;</li> <li>lignes 9-14\u00a0: les noms des fichiers exploit\u00e9s par l\u2019application sont r\u00e9cup\u00e9r\u00e9s dans la configuration\u00a0;</li> <li>le script principal de la version 3 pr\u00e9sente trois diff\u00e9rences vis \u00e0 vis de celui des versions 1\u00a0et 2 :</li> <li>ligne 21\u00a0: les donn\u00e9es de l'administration fiscale sont prises dans le fichier jSON [./data/admindata.json]\u00a0;</li> <li>ligne 32\u00a0: les r\u00e9sultats du calcul de l'imp\u00f4t sont plac\u00e9s dans le fichier jSON [./data/r\u00e9sultats.json]\u00a0;</li> <li>ligne 7\u00a0: les fonctions de la version 3 sont trouv\u00e9es dans le module [impots.modules.imp\u00f4ts_module_02]\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-3.html#113-le-module-impotsv02modulesimpots_module_02","title":"11.3. Le module [impots.v02.modules.imp\u00f4ts_module_02]","text":"<p>Le module [impots.v02.modules.imp\u00f4ts_module_02] a la structure suivante\u00a0:</p> <p></p> <ul> <li>on retrouve dans le module des fonctions d\u00e9j\u00e0 pr\u00e9sentes dans le module utilis\u00e9 par la version 1 avec cependant une diff\u00e9rence. Lorsque le module de la version 2 reprend une fonction pr\u00e9sente dans le module de la version 1, elle le fait avec un param\u00e8tre suppl\u00e9mentaire\u00a0: [adminData] (lignes 29, 51, 77, 127). Ce param\u00e8tre repr\u00e9sente le dictionnaire des donn\u00e9es fiscales issues du fichier jSON [adminData.json]. Dans le module de la version 1, ces donn\u00e9es n'avaient pas besoin d'\u00eatre pass\u00e9es aux fonctions car elles \u00e9taient d\u00e9finies globalement \u00e0 celles-ci ce qui faisait que les fonctions les connaissaient\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-3.html#114-lecture-des-donnees-de-ladministration-fiscale","title":"11.4. Lecture des donn\u00e9es de l'administration fiscale","text":"<p>La fonction [get_admindata] est la suivante\u00a0:</p> <pre><code># lecture des donn\u00e9es de l'administration fiscale dans un fichier jSON\n# ----------------------------------------\ndef get_admindata(admindata_filename: str) -&gt; dict:\n    # lecture des donn\u00e9es de l'administration fiscale\n    # on laisse remonter les \u00e9ventuelles exceptions : absence du fichier, contenu jSON incorrect\n    file = None\n    try:\n        # ouverture du fichier jSON en lecture\n        file = codecs.open(admindata_filename, \"r\", \"utf8\")\n        # transfert du contenu dans un dictionnaire\n        admin_data = json.load(file)\n        # on rend le r\u00e9sultat\n        return admin_data\n    finally:\n        # fermeture du fichier s'il a \u00e9t\u00e9 ouvert\n        if file:\n            file.close()\n</code></pre> <ul> <li>ligne 9\u00a0: on r\u00e9cup\u00e8re le dictionnaire image du fichier jSON  lu\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-3.html#115-enregistrement-des-resultats","title":"11.5. Enregistrement des r\u00e9sultats","text":"<p>La fonction [record_results_in_json_file] est la suivante\u00a0:</p> <pre><code># \u00e9criture des r\u00e9sultats dans un fichier jSON\n# ----------------------------------------\ndef record_results_in_json_file(results_filename: str, results: list):\n    file = None\n    try:\n        # ouverture du fichier des r\u00e9sultats\n        file = codecs.open(results_filename, \"w\", \"utf8\")\n        # \u00e9criture en bloc\n        json.dump(results, file, ensure_ascii=False)\n    finally:\n        # on ferme le fichier s'il a \u00e9t\u00e9 ouvert\n        if file:\n            file.close()\n</code></pre> <ul> <li>ligne 7\u00a0: on cr\u00e9e un fichier encod\u00e9 en UTF-8\u00a0;</li> <li>ligne 9\u00a0: on \u00e9crit la liste [results] dans le fichier jSON. Les caract\u00e8res UTF-8 ne sont pas \u00e9chapp\u00e9s (ensure_ascii=False)\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-3.html#116-modification-des-fonctions","title":"11.6. Modification des fonctions","text":"<p>Certaines fonctions re\u00e7oivent d\u00e9sormais un param\u00e8tre [admin_data] suppl\u00e9mentaire. Cela modifie un peu leur \u00e9criture. Prenons par exemple la fonction [calcul_imp\u00f4t]\u00a0:</p> <pre><code># calcul de l'imp\u00f4t - \u00e9tape 1\n# ----------------------------------------\ndef calcul_imp\u00f4t(admin_data: dict, mari\u00e9: str, enfants: int, salaire: int) -&gt; dict:\n    # mari\u00e9 : oui, non\n    # enfants : nombre d'enfants\n    # salaire : salaire annuel\n    # limites, coeffr, coeffn : les tableaux des donn\u00e9es permettant le calcul de l'imp\u00f4t\n    #\n    # calcul de l'imp\u00f4t avec enfants\n    result1 = calcul_imp\u00f4t_2(admin_data, mari\u00e9, enfants, salaire)\n    impot1 = result1[\"imp\u00f4t\"]\n    # calcul de l'imp\u00f4t sans les enfants\n    if enfants != 0:\n        result2 = calcul_imp\u00f4t_2(admin_data, mari\u00e9, 0, salaire)\n        impot2 = result2[\"imp\u00f4t\"]\n        # application du plafonnement du quotient familial\n        if enfants &lt; 3:\n            # PLAFOND_QF_DEMI_PART euros pour les 2 premiers enfants\n            impot2 = impot2 - enfants * admin_data['plafond_qf_demi_part']\n        else:\n            # PLAFOND_QF_DEMI_PART euros pour les 2 premiers enfants, le double pour les suivants\n            impot2 = impot2 - 2 * admin_data['plafond_qf_demi_part'] - (enfants - 2) * 2 * admin_data[\n                'plafond_qf_demi_part']\n    else:\n        impot2 = impot1\n        result2 = result1\n\n    # on prend l'imp\u00f4t le plus fort avec le taux et la surc\u00f4te qui vont avec\n    if impot1 &gt; impot2:\n        impot = impot1\n        taux = result1[\"taux\"]\n        surc\u00f4te = result1[\"surc\u00f4te\"]\n    else:\n        surc\u00f4te = impot2 - impot1 + result2[\"surc\u00f4te\"]\n        impot = impot2\n        taux = result2[\"taux\"]\n\n    # calcul d'une \u00e9ventuelle d\u00e9c\u00f4te\n    d\u00e9c\u00f4te = get_d\u00e9c\u00f4te(admin_data, mari\u00e9, salaire, impot)\n    impot -= d\u00e9c\u00f4te\n    # calcul d'une \u00e9ventuelle r\u00e9duction d'imp\u00f4ts\n    r\u00e9duction = get_r\u00e9duction(admin_data, mari\u00e9, salaire, enfants, impot)\n    impot -= r\u00e9duction\n    # r\u00e9sultat\n    return {\"mari\u00e9\": mari\u00e9, \"enfants\": enfants, \"salaire\": salaire, \"imp\u00f4t\": math.floor(impot), \"surc\u00f4te\": surc\u00f4te,\n            \"d\u00e9c\u00f4te\": d\u00e9c\u00f4te, \"r\u00e9duction\": r\u00e9duction, \"taux\": taux}\n</code></pre> <p>Notes</p> <ul> <li>l\u00e0 o\u00f9 [calcul_imp\u00f4t] appelle d'autres fonctions, elle passe [admin_data] en 1er param\u00e8tre (lignes 10, 14, 39, 42)\u00a0;</li> <li>l\u00e0 o\u00f9 [calcul_imp\u00f4t] utilise des constantes fiscales, elle passe d\u00e9sormais par le dictionnaire [admin_data] (lignes 19, 22)\u00a0; Toutes les fonctions recevant [admin_data] comme param\u00e8tre, subissent ces m\u00eames types de modifications.</li> </ul>"},{"location":"exercice-dapplication-version-3.html#117-resultats","title":"11.7. R\u00e9sultats","text":"<p>Les r\u00e9sultats obtenus sont ceux pr\u00e9sent\u00e9s au d\u00e9but du paragraphe 8.3.</p>"},{"location":"exercice-dapplication-version-6.html","title":"23. Exercice d\u2019application\u00a0: version 6","text":""},{"location":"exercice-dapplication-version-6.html#231-introduction","title":"23.1. Introduction","text":"<p>Nous revenons maintenant \u00e0 notre application de calcul de l\u2019imp\u00f4t. Nous allons construire autour d\u2019elle diff\u00e9rentes applications web.</p> <p>Dans la version 5 de notre exercice d\u2019application, les donn\u00e9es de l\u2019administration fiscale \u00e9taient rang\u00e9es dans une base de donn\u00e9es. Cette version 5 comportait deux applications distinctes mais ayant des couches en commun\u00a0:</p> <ul> <li>une application qui calculait l\u2019imp\u00f4t en mode |batch| pour des contribuables enregistr\u00e9s dans un fichier texte\u00a0;</li> <li>une application qui calculait l\u2019imp\u00f4t en mode |interactif| pour des contribuables dont on saisissait les informations au clavier\u00a0; La version 5 de l\u2019application de calcul de l\u2019imp\u00f4t par lots (mode batch) avait l\u2019architecture suivante\u00a0:</li> </ul> <p></p> <p>Ultimement, la version web de cette application aura l\u2019architecture suivante\u00a0:</p> <p></p> <ul> <li>le client web [1] s\u2019adresse au serveur web [2] qui lui communique avec le SGBD [3]\u00a0;</li> <li>le serveur web [2] conserve les couches [m\u00e9tier] [8] et [dao] [9] de l\u2019application initiale\u00a0;</li> <li>l\u2019application initiale conserve son script principal [4] et sa couche [m\u00e9tier] [15]. Les couches [m\u00e9tier] [8] et [15] sont identiques;</li> <li>la communication client / serveur n\u00e9cessite deux couches suppl\u00e9mentaires\u00a0:</li> <li>la couche [web] [7] qui impl\u00e9mente l\u2019application web\u00a0;</li> <li> <p>la couche [dao] [5] cliente de l\u2019application web [7]\u00a0; Dans la version finale, le calcul de l\u2019imp\u00f4t par lots pourra se d\u00e9rouler de deux fa\u00e7ons\u00a0:</p> </li> <li> <p>le calcul m\u00e9tier de l\u2019imp\u00f4t se fait par la couche [m\u00e9tier] du serveur. Le script [main] utilisera cette m\u00e9thode\u00a0;</p> </li> <li>le calcul m\u00e9tier de l\u2019imp\u00f4t se fait par la couche [m\u00e9tier] du client. Le script [main2] utilisera cette m\u00e9thode\u00a0; A partir de maintenant, nous allons d\u00e9velopper plusieurs applications client / serveur du type ci-dessus, chacune illustrant une ou de nouvelles technologies de d\u00e9veloppement web.</li> </ul>"},{"location":"exercice-dapplication-version-6.html#232-le-serveur-web-de-calcul-de-limpot","title":"23.2. Le serveur web de calcul de l\u2019imp\u00f4t","text":""},{"location":"exercice-dapplication-version-6.html#2321-version-1","title":"23.2.1. Version 1","text":"<p>Le script [server_01] est l\u2019application web suivante\u00a0:</p> <p></p> <ul> <li>en [1], on utilise une URL param\u00e9tr\u00e9e dans laquelle on passe trois valeurs\u00a0:</li> <li>[mari\u00e9] (oui / non) pour indiquer si le contribuable est mari\u00e9\u00a0;</li> <li>[enfants]\u00a0: le nombre d\u2019enfants du contribuable\u00a0;</li> <li>[salaire]\u00a0: salaire annuel du contribuable\u00a0;</li> <li>en [2], le serveur web renvoie une cha\u00eene jSON qui donne le montant de l\u2019imp\u00f4t \u00e0 payer avec avec ses diff\u00e9rentes composantes\u00a0; L\u2019architecture de l\u2019application est la suivante\u00a0:</li> </ul> <p></p> <ul> <li>le navigateur [1] interroge le serveur [2]. Le script [server_01] impl\u00e9mente la couche [web] [2] du serveur\u00a0;</li> <li>les couches [3-8] sont celles d\u00e9j\u00e0 utilis\u00e9es dans la |version 5| de l\u2019application du calcul de l\u2019imp\u00f4t. Nous les reprenons telles-quelles\u00a0;</li> <li>la couche [m\u00e9tier] [3] est d\u00e9finie |ici|\u00a0;</li> <li> <p>la couche [dao] [4] est d\u00e9finie |ici|\u00a0; L\u2019application web [server_01] est configur\u00e9e \u00e0 l\u2019aide de trois scripts\u00a0:</p> </li> <li> <p>[config] qui configure la totalit\u00e9 de l\u2019application\u00a0;</p> </li> <li>[config_database] qui configure l\u2019acc\u00e8s \u00e0 la base de donn\u00e9es. On travaillera avec les SGBD MySQL et PostgreSQL\u00a0;</li> <li>[config_layers] qui configure les couches de l\u2019application\u00a0; Le script [config] est le suivant\u00a0:</li> </ul> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a01\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0de\u00a0ce\u00a0fichier\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0racine\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020\"\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\u00a0absolues\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossiers\u00a0du\u00a0projet\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0BaseEntity,\u00a0MyException\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/classes/02/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0InterfaceImp\u00f4tsDao,\u00a0InterfaceImp\u00f4tsM\u00e9tier,\u00a0InterfaceImp\u00f4tsUi\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AbstractImp\u00f4tsdao,\u00a0Imp\u00f4tsConsole,\u00a0Imp\u00f4tsM\u00e9tier\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ImpotsDaoWithAdminDataInDatabase\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AdminData,\u00a0Imp\u00f4tsError,\u00a0TaxPayer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Constantes,\u00a0tranches\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0IndexController\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../controllers\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0scripts\u00a0[config_database,\u00a0config_layers]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0script_dir,\n\u00a0\u00a0\u00a0\u00a0]\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fixe\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a02\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0#\u00a0liste\u00a0des\u00a0utilisateurs\u00a0autoris\u00e9s\u00a0\u00e0\u00a0utiliser\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0config['users']\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"login\":\u00a0\"admin\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"admin\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a03\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0base\u00a0de\u00a0donn\u00e9es\n\u00a0\u00a0\u00a0\u00a0import\u00a0config_database\n\u00a0\u00a0\u00a0\u00a0config[\"database\"]\u00a0=\u00a0config_database.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a04\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0import\u00a0config_layers\n\u00a0\u00a0\u00a0\u00a0config['layers']\u00a0=\u00a0config_layers.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <ul> <li>la fonction [configure] re\u00e7oit un dictionnaire [config] en param\u00e8tre (ligne 1) et le rend comme r\u00e9sultat (ligne 54) apr\u00e8s avoir enrichi son contenu. On aurait pu dire depuis longtemps qu\u2019il n\u2019\u00e9tait pas n\u00e9cessaire de rendre le r\u00e9sultat [config]. En effet [config] est une r\u00e9f\u00e9rence de dictionnaire que le code appelant partage avec le code appel\u00e9. Le code appelant poss\u00e8de donc d\u00e9j\u00e0 cette r\u00e9f\u00e9rence (ligne 1) et il est inutile de la lui redonner (ligne 54). Ainsi \u00e9crire\u00a0: <pre><code>config=[module].configure(config) (1)\n</code></pre></li> </ul> <p>est redondant. Il suffit d\u2019\u00e9crire\u00a0:</p> <pre><code>[module].configure(config) (2)\n</code></pre> <p>N\u00e9anmoins, j\u2019ai gard\u00e9 le type (1) d\u2019\u00e9criture parce que j\u2019ai pens\u00e9 qu\u2019il montrait peut-\u00eatre mieux, que le code appel\u00e9 modifiait le dictionnaire [config].</p> <ul> <li>ligne 1\u00a0: le dictionnaire [config] re\u00e7u par la fonction [configure] a une cl\u00e9 \u2018sgbd\u2019 qui prend sa valeur dans la liste [\u2018mysql\u2019, \u2018pgres\u2019]. [mysql] signifie que la base de donn\u00e9es utilis\u00e9e est g\u00e9r\u00e9e par MySQL alors que \u2018pgres\u2019 signifie que la base de donn\u00e9es utilis\u00e9e est g\u00e9r\u00e9e par PostgreSQL\u00a0;</li> <li>lignes 4-27\u00a0: on liste tous les dossiers contenant des \u00e9l\u00e9ments n\u00e9cessaires \u00e0 l\u2019application web. Ils feront partie du Python Path de l\u2019application (lignes 30-31)\u00a0;</li> <li>lignes 33-40\u00a0: on ne va autoriser que certains utilisateurs \u00e0 acc\u00e9der \u00e0 l\u2019application. Ici on a une liste avec un unique utilisateur\u00a0;</li> <li>lignes 43-46\u00a0: c\u2019est le script [config_database] qui construit la configuration de la base de donn\u00e9es utilis\u00e9e\u00a0;</li> <li>ligne 46\u00a0: la configuration construite par le script [config_database] est un dictionnaire qu\u2019on range dans la configuration g\u00e9n\u00e9rale associ\u00e9 \u00e0 la cl\u00e9 \u2018database\u2019\u00a0;</li> <li>lignes 48-51\u00a0: le script [config_layers] instancie les couches de l\u2019application web. Il rend un dictionnaire qu\u2019on range dans la configuration g\u00e9n\u00e9rale associ\u00e9 \u00e0 la cl\u00e9 \u2018layers\u2019\u00a0; Le script [config_database] est celui d\u00e9j\u00e0 utilis\u00e9 dans la |version 5|. On le redonne pour m\u00e9moire\u00a0:</li> </ul> <pre><code>def configure(config: dict) -&gt; dict:\n    # configuration sqlalchemy\n    from sqlalchemy import create_engine, Table, Column, Integer, MetaData, Float\n    from sqlalchemy.orm import mapper, sessionmaker\n\n    # cha\u00eenes de connexion aux bases de donn\u00e9es exploit\u00e9es\n    connection_strings = {\n        'mysql': \"mysql+mysqlconnector://admimpots:mdpimpots@localhost/dbimpots-2019\",\n        'pgres': \"postgresql+psycopg2://admimpots:mdpimpots@localhost/dbimpots-2019\"\n    }\n    # cha\u00eene de connexion \u00e0 la base de donn\u00e9es exploit\u00e9e\n    engine = create_engine(connection_strings[config['sgbd']])\n\n    # metadata\n    metadata = MetaData()\n\n    # la table des constantes\n    constantes_table = Table(\"tbconstantes\", metadata,\n                             Column('id', Integer, primary_key=True),\n                             Column('plafond_qf_demi_part', Float, nullable=False),\n                             Column('plafond_revenus_celibataire_pour_reduction', Float, nullable=False),\n                             Column('plafond_revenus_couple_pour_reduction', Float, nullable=False),\n                             Column('valeur_reduc_demi_part', Float, nullable=False),\n                             Column('plafond_decote_celibataire', Float, nullable=False),\n                             Column('plafond_decote_couple', Float, nullable=False),\n                             Column('plafond_impot_celibataire_pour_decote', Float, nullable=False),\n                             Column('plafond_impot_couple_pour_decote', Float, nullable=False),\n                             Column('abattement_dixpourcent_max', Float, nullable=False),\n                             Column('abattement_dixpourcent_min', Float, nullable=False)\n                             )\n\n    # la table des tranches de l'imp\u00f4t\n    tranches_table = Table(\"tbtranches\", metadata,\n                           Column('id', Integer, primary_key=True),\n                           Column('limite', Float, nullable=False),\n                           Column('coeffr', Float, nullable=False),\n                           Column('coeffn', Float, nullable=False)\n                           )\n    # les mappings\n    from Tranche import Tranche\n    mapper(Tranche, tranches_table)\n\n    from Constantes import Constantes\n    mapper(Constantes, constantes_table)\n\n    # la session factory\n    session_factory = sessionmaker()\n    session_factory.configure(bind=engine)\n\n    # une session\n    session = session_factory()\n\n    # on enregistre certaines informations et on les rend dans un dictionnaire\n    return {\"engine\": engine, \"metadata\": metadata, \"tranches_table\": tranches_table,\n            \"constantes_table\": constantes_table, \"session\": session}\n</code></pre> <p>Le script [config_layers] configure les couches du serveur web. On reprend un |script| d\u00e9j\u00e0 rencontr\u00e9\u00a0:</p> <pre><code>def configure(config: dict) -&gt; dict:\n    # instanciation des couches de l'application\n\n    # dao\n    from ImpotsDaoWithAdminDataInDatabase import ImpotsDaoWithAdminDataInDatabase\n    dao = ImpotsDaoWithAdminDataInDatabase(config)\n\n    # m\u00e9tier\n    from Imp\u00f4tsM\u00e9tier import Imp\u00f4tsM\u00e9tier\n    m\u00e9tier = Imp\u00f4tsM\u00e9tier()\n\n    # on met les instances de couches dans un dictionnaire qu'on rend au code appelant\n    return {\n        \"dao\": dao,\n        \"m\u00e9tier\": m\u00e9tier\n    }\n</code></pre> <ul> <li>ligne 6\u00a0: la couche [dao] est impl\u00e9ment\u00e9e avec une base de donn\u00e9es\u00a0;</li> <li>[ImpotsDaoWithAdminDataInDatabase] a \u00e9t\u00e9 d\u00e9finie |ici|\u00a0;</li> <li>[Imp\u00f4tsM\u00e9tier] a \u00e9t\u00e9 d\u00e9finie |ici|\u00a0; Le script principal [server_01] est le suivant\u00a0:</li> </ul> <pre><code># on attend un param\u00e8tre mysql ou pgres\nimport sys\nsyntaxe = f\"{sys.argv[0]} mysql / pgres\"\nerreur = len(sys.argv) != 2\nif not erreur:\n    sgbd = sys.argv[1].lower()\n    erreur = sgbd != \"mysql\" and sgbd != \"pgres\"\nif erreur:\n    print(f\"syntaxe : {syntaxe}\")\n    sys.exit()\n\n# on configure l'application\nimport config\nconfig = config.configure({'sgbd': sgbd})\n\n# d\u00e9pendances\nfrom Imp\u00f4tsError import Imp\u00f4tsError\nfrom TaxPayer import TaxPayer\nimport re\nfrom flask import request\nfrom myutils import json_response\nfrom flask import Flask\nfrom flask_api import status\n\n# r\u00e9cup\u00e9ration des donn\u00e9es de l'administration fiscale\ntry:\n    # admindata sera une donn\u00e9e de port\u00e9e application en lecture seule\n    admindata = config[\"layers\"][\"dao\"].get_admindata()\nexcept Imp\u00f4tsError as erreur:\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\n    sys.exit(1)\n\n# application Flask\napp = Flask(__name__)\n\n\n# Home URL\u00a0: /?mari\u00e9=xx&amp;enfants=yy&amp;salaire=zz\n@app.route('/', methods=['GET'])\ndef index():\n    # au d\u00e9part pas d'erreurs\n    erreurs = []\n    # la requ\u00eate doit avoir trois param\u00e8tres dans l\u2019URL\n    if len(request.args) != 3:\n        erreurs.append(\"M\u00e9thode GET requise avec les seuls param\u00e8tres [mari\u00e9, enfants, salaire]\")\n\n    # on r\u00e9cup\u00e8re le statut marital dans l\u2019URL\n    mari\u00e9 = request.args.get('mari\u00e9')\n    if mari\u00e9 is None:\n        erreurs.append(\"param\u00e8tre [mari\u00e9] manquant\")\n    else:\n        mari\u00e9 = mari\u00e9.strip().lower()\n        erreur = mari\u00e9 != \"oui\" and mari\u00e9 != \"non\"\n        if erreur:\n            erreurs.append(f\"param\u00e9tre mari\u00e9 [{mari\u00e9}] invalide\")\n\n    # on r\u00e9cup\u00e8re le nombre d'enfants dans l\u2019URL\n    enfants = request.args.get('enfants')\n    if enfants is None:\n        erreurs.append(\"param\u00e8tre [enfants] manquant\")\n    else:\n        enfants = enfants.strip()\n        match = re.match(r\"^\\d+\", enfants)\n        if not match:\n            erreurs.append(f\"param\u00e9tre enfants [{enfants}] invalide\")\n        else:\n            enfants = int(enfants)\n\n    # on r\u00e9cup\u00e8re le salaire dans l\u2019URL\n    salaire = request.args.get('salaire')\n    if salaire is None:\n        erreurs.append(\"param\u00e8tre [salaire] manquant\")\n    else:\n        salaire = salaire.strip()\n        match = re.match(r\"^\\d+\", salaire)\n        if not match:\n            erreurs.append(f\"param\u00e9tre salaire [{salaire}] invalide\")\n        else:\n            salaire = int(salaire)\n\n    # des param\u00e8tres invalides dans l\u2019URL ?\n    for key in request.args.keys():\n        if key not in ['mari\u00e9', 'enfants', 'salaire']:\n            erreurs.append(f\"param\u00e8tre [{key}] invalide\")\n\n    # des erreurs ?\n    if erreurs:\n        # on envoie une r\u00e9ponse d'erreur au client\n        r\u00e9sultats = {\"r\u00e9ponse\": {\"erreurs\": erreurs}}\n        return json_response(r\u00e9sultats, status.HTTP_400_BAD_REQUEST)\n\n    # pas d'erreurs, on peut travailler\n    # calcul de l'imp\u00f4t\n    taxpayer = TaxPayer().fromdict({'mari\u00e9': mari\u00e9, 'enfants': enfants, 'salaire': salaire})\n    config[\"layers\"][\"m\u00e9tier\"].calculate_tax(taxpayer, admindata)\n    # on envoie la r\u00e9ponse au client\n    return json_response({\"r\u00e9ponse\": {\"result\": taxpayer.asdict()}}, status.HTTP_200_OK)\n\n\n# main uniquement\nif __name__ == '__main__':\n    # on lance le serveur Flask\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>lignes 1-10\u00a0: on r\u00e9cup\u00e8re le param\u00e8tre qui indique quel SGBD utiliser\u00a0;</li> <li>lignes 12-14\u00a0: munie de cette information on peut configurer l\u2019application. Le Python Path est notamment construit\u00a0;</li> <li>lignes 16-23\u00a0: muni du nouveau Python Path, on importe les \u00e9l\u00e9ments dont on a besoin\u00a0;</li> <li>lignes 25-31\u00a0: on r\u00e9cup\u00e8re les donn\u00e9es de l\u2019administration fiscale qui permettent de faire le calcul de l\u2019imp\u00f4t\u00a0;</li> <li>lignes 33-34\u00a0: instanciation de l\u2019application Flask\u00a0;</li> <li>ligne 38\u00a0: l\u2019application Flask ne sert que l\u2019URL [/]. Elle attend une URL param\u00e9tr\u00e9e de la fa\u00e7on suivante [/\u00a0?mari\u00e9=xx&amp;enfants=yy&amp;salaire=zz] avec\u00a0:</li> <li>xx\u00a0: oui / non\u00a0;</li> <li>yy\u00a0: nombre d\u2019enfants\u00a0;</li> <li>zz\u00a0: salaire annuel\u00a0;</li> <li>lignes 40-89\u00a0: on v\u00e9rifie la validit\u00e9 des param\u00e8tres de l\u2019URL\u00a0;</li> <li>ligne 41\u00a0: on va cumuler les messages d\u2019erreur dans la liste [erreurs]\u00a0;</li> <li>ligne 43\u00a0: on se rappelle peut-\u00eatre que les param\u00e8tres de l\u2019URL param\u00e9tr\u00e9e sont retrouv\u00e9s dans [request.args] (voir |ici|)\u00a0:</li> <li>l\u2019objet [request] est l\u2019objet Flask import\u00e9 ligne 20\u00a0;</li> <li>l\u2019objet [request.args] se comporte comme un dictionnaire\u00a0;</li> <li>lignes 43-44\u00a0: on v\u00e9rifie qu\u2019on a trois param\u00e8tres exactement (pas moins, pas plus)\u00a0;</li> <li>lignes 46-49\u00a0: on v\u00e9rifie que le param\u00e8tre [mari\u00e9] est pr\u00e9sent dans l\u2019URL\u00a0;</li> <li>lignes 50-54\u00a0: s\u2019il est pr\u00e9sent on v\u00e9rifie que sa valeur minuscule d\u00e9barrass\u00e9e des \u2018blancs\u2019 de d\u00e9but / fin est oui ou non\u00a0;</li> <li>lignes 56-59\u00a0: on v\u00e9rifie que le param\u00e8tre [enfants] est dans l\u2019URL\u00a0;</li> <li>lignes 60-66\u00a0: s\u2019il est pr\u00e9sent on v\u00e9rifie que sa valeur est un entier positif\u00a0;</li> <li>ligne 66\u00a0: il ne faut pas oublier que les param\u00e8tres de l\u2019URL et leurs valeurs sont des cha\u00eenes de caract\u00e8res. La valeur du param\u00e8tre [enfants] est transform\u00e9e en \u2018int\u2019\u00a0;</li> <li>lignes 68-78\u00a0: pour le param\u00e8tre [salaire], on fait les m\u00eames tests que pour le param\u00e8tre [enfants]\u00a0;</li> <li>lignes 81-83\u00a0: on v\u00e9rifie qu\u2019il n\u2019y a pas de param\u00e8tres autres que [\u2018mari\u00e9, \u2018enfants\u2019, \u2018salaire\u2019] dans l\u2019URL\u00a0;</li> <li>lignes 85-89\u00a0: si apr\u00e8s toutes ces v\u00e9rifications, la liste [erreurs] n\u2019est pas vide alors on envoie cette liste d\u2019erreurs au client sous la forme d\u2019une cha\u00eene jSON\u00a0 et le code de statut [400 Bad Request]\u00a0; Comme par la suite, nous aurons souvent l\u2019occasion d\u2019envoyer une cha\u00eene jSON en r\u00e9ponse au client, les quelques lignes n\u00e9cessaires \u00e0 cet envoi ont \u00e9t\u00e9 factoris\u00e9es dans le module [myutils.py] que nous avons d\u00e9j\u00e0 utilis\u00e9\u00a0:</li> </ul> <p></p> <p>Le script [myutils.py] devient le suivant\u00a0:</p> <pre><code># imports\nimport json\nimport os\nimport sys\n\nfrom flask import make_response\n\n\ndef set_syspath(absolute_dependencies: list):\n    # absolute_dependencies : une liste de noms absolus de dossiers\n\n    \u2026.\n\n\n# g\u00e9n\u00e9ration d'une r\u00e9ponse HTTP jSON\ndef json_response(r\u00e9ponse: dict, status_code: int) -&gt; tuple:\n    # corps de la r\u00e9ponse HTTP\n    response = make_response(json.dumps(r\u00e9ponse, ensure_ascii=False))\n    # corps de la r\u00e9ponse HTTP est du jSON\n    response.headers['Content-Type'] = 'application/json; charset=utf-8'\n    # on envoie la r\u00e9ponse HTTP\n    return response, status_code\n</code></pre> <ul> <li>ligne 16\u00a0: la fonction [json_response] attend deux param\u00e8tres\u00a0:</li> <li>[r\u00e9ponse]\u00a0: le dictionnaire dont il faut envoyer la cha\u00eene jSON au client web\u00a0;</li> <li>[status_code]\u00a0: le code de statut HTTP de la r\u00e9ponse\u00a0;</li> <li>ligne 18\u00a0: on fixe le corps jSON de la r\u00e9ponse\u00a0;</li> <li>ligne 20\u00a0: on ajoute l\u2019ent\u00eate HTTP qui dit au client web qu\u2019il va recevoir du jSON\u00a0;</li> <li>ligne 22\u00a0: on envoie la r\u00e9ponse HTTP au code appelant. A charge pour lui de l\u2019envoyer au client web\u00a0; Le fichier [init.py] \u00e9volue de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code>from .myutils import set_syspath, json_response\n</code></pre> <p>La nouvelle version de [myutils] est install\u00e9e parmi les modules de port\u00e9e machine avec la commande [pip install .] dans un terminal Pycharm\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\packages&gt;pip install .\nProcessing c:\\data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\packages\nUsing legacy setup.py install for myutils, since package 'wheel' is not installed.\nInstalling collected packages: myutils\n  Attempting uninstall: myutils\n    Found existing installation: myutils 0.1\n    Uninstalling myutils-0.1:\n      Successfully uninstalled myutils-0.1\n    Running setup.py install for myutils ... done\nSuccessfully installed myutils-0.1\n</code></pre> <ul> <li>ligne 1\u00a0: il faut \u00eatre dans le dossier [packages] pour taper cette instruction\u00a0; Le code du script [server_01] se poursuit de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code>\u2026    \n    # des erreurs ?\n    if erreurs:\n        # on envoie une r\u00e9ponse d'erreur au client\n        r\u00e9sultats = {\"r\u00e9ponse\": {\"erreurs\": erreurs}}\n        return json_response(r\u00e9sultats, status.HTTP_400_BAD_REQUEST)\n\n    # pas d'erreurs, on peut travailler\n    # calcul de l'imp\u00f4t\n    taxpayer = TaxPayer().fromdict({'id': 0, 'mari\u00e9': mari\u00e9, 'enfants': enfants, 'salaire': salaire})\n    config[\"layers\"][\"m\u00e9tier\"].calculate_tax(taxpayer, admindata)\n    # on envoie la r\u00e9ponse au client\n    return json_response({\"r\u00e9ponse\": {\"result\": taxpayer.asdict()}}, status.HTTP_200_OK)\n</code></pre> <ul> <li>ligne 10\u00a0: lorsqu\u2019on est l\u00e0, les param\u00e8tres attendus dans l\u2019URL sont l\u00e0 et sont corrects\u00a0;</li> <li>ligne 10\u00a0: on cr\u00e9e l\u2019objet [TaxPayer] qui mod\u00e9lise le contribuable\u00a0;</li> <li>ligne 11\u00a0: on demande \u00e0 la couche [m\u00e9tier] de calculer l\u2019imp\u00f4t. On rappelle que les \u00e9l\u00e9ments calcul\u00e9s par la couche [m\u00e9tier] sont ins\u00e9r\u00e9s dans l\u2019objet [taxpayer] pass\u00e9 en param\u00e8tre\u00a0;</li> <li>ligne 13\u00a0: la r\u00e9ponse est envoy\u00e9e au client web sous la forme d\u2019une cha\u00eene jSON. Celle-ci est la cha\u00eene jSON d\u2019un dictionnaire. Associ\u00e9 \u00e0 la cl\u00e9 [result], on y met le dictionnaire de l\u2019objet [taxpayer]. On ne pouvait pas mettre l\u2019objet [taxpayer] lui-m\u00eame car celui-ci n\u2019est pas s\u00e9rialisable en jSON\u00a0; On cr\u00e9e deux configurations d\u2019ex\u00e9cution, une pour MySQL, l\u2019autre pour PostgreSQL\u00a0:</li> </ul> <p></p> <p>Voici quelques exemples d\u2019ex\u00e9cution (vous avez lanc\u00e9 l\u2019application [server_01] et le SGBD utilis\u00e9 puis vous demandez l\u2019URL http://localhost:5000/ avec un navigateur)\u00a0:</p> <p></p> <p></p> <p>Voici un exemple d\u2019ex\u00e9cution dans la console de Postman\u00a0:</p> <p></p> <pre><code>GET /?mari%C3%A9=xx&amp;enfants=yy&amp;salaire=zz HTTP/1.1\nUser-Agent: PostmanRuntime/7.26.1\nAccept: */*\nCache-Control: no-cache\nPostman-Token: e4c5df8c-4bd6-4250-b789-b7b164db4eff\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\n\nHTTP/1.0 400 BAD REQUEST\nContent-Type: application/json; charset=utf-8\nContent-Length: 134\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Fri, 17 Jul 2020 06:15:44 GMT\n\n{\"r\u00e9ponse\": {\"erreurs\": [\"param\u00e8tre mari\u00e9 [xx] invalide\", \"param\u00e8tre enfants [yy] invalide\", \"param\u00e8tre salaire [zz] invalide\"]}}\n</code></pre> <ul> <li>ligne 1\u00a0: une URL incorrecte est demand\u00e9e\u00a0;</li> <li>ligne 10\u00a0: le serveur r\u00e9pond avec le statut 400 BAD REQUEST\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-6.html#2322-version-2","title":"23.2.2. Version 2","text":"<p>La version 2 du serveur isole le traitement de l\u2019URL dans le module [index_controller] [5]\u00a0:</p> <pre><code># import des d\u00e9pendances\nimport re\n\nfrom flask_api import status\nfrom werkzeug.local import LocalProxy\n\n\n# URL param\u00e9tr\u00e9e : /?mari\u00e9=xx&amp;enfants=yy&amp;salaire=zz\ndef execute(request: LocalProxy, config: dict) -&gt; tuple:\n    # d\u00e9pendances\n    from TaxPayer import TaxPayer\n\n    # au d\u00e9part pas d'erreurs\n    erreurs = []\n    # la requ\u00eate doit avoir trois param\u00e8tres\n    if len(request.args) != 3:\n        erreurs.append(\"M\u00e9thode GET requise avec les seuls param\u00e8tres [mari\u00e9, enfants, salaire]\")\n\n    # on r\u00e9cup\u00e8re le statut marital de l'URL\n    mari\u00e9 = request.args.get('mari\u00e9')\n    if mari\u00e9 is None:\n        erreurs.append(\"param\u00e8tre [mari\u00e9] manquant\")\n    else:\n        mari\u00e9 = mari\u00e9.strip().lower()\n        erreur = mari\u00e9 != \"oui\" and mari\u00e9 != \"non\"\n        if erreur:\n            erreurs.append(f\"param\u00e9tre mari\u00e9 [{mari\u00e9}] invalide\")\n\n    # on r\u00e9cup\u00e8re le nombre d'enfants de l'URL\n    enfants = request.args.get('enfants')\n    if enfants is None:\n        erreurs.append(\"param\u00e8tre [enfants] manquant\")\n    else:\n        enfants = enfants.strip()\n        match = re.match(r\"^\\d+\", enfants)\n        if not match:\n            erreurs.append(f\"param\u00e9tre enfants {enfants} invalide\")\n        else:\n            enfants = int(enfants)\n\n    # on r\u00e9cup\u00e8re le salaire de l'URL\n    salaire = request.args.get('salaire')\n    if salaire is None:\n        erreurs.append(\"param\u00e8tre [salaire] manquant\")\n    else:\n        salaire = salaire.strip()\n        match = re.match(r\"^\\d+\", salaire)\n        if not match:\n            erreurs.append(f\"param\u00e9tre salaire {salaire} invalide\")\n        else:\n            salaire = int(salaire)\n\n    # autres param\u00e8tres dans l'URL ?\n    for key in request.args.keys():\n        if not key in ['mari\u00e9', 'enfants', 'salaire']:\n            erreurs.append(f\"param\u00e8tre [{key}] invalide\")\n\n    # des erreurs ?\n    if erreurs:\n        # on envoie une r\u00e9ponse d'erreur au client\n        r\u00e9sultats = {\"r\u00e9ponse\": {\"erreurs\": erreurs}}\n        return r\u00e9sultats, status.HTTP_400_BAD_REQUEST\n\n    # pas d'erreurs, on peut travailler\n    # calcul de l'imp\u00f4t\n    taxpayer = TaxPayer().fromdict({'mari\u00e9': mari\u00e9, 'enfants': enfants, 'salaire': salaire})\n    config[\"layers\"][\"m\u00e9tier\"].calculate_tax(taxpayer, config[\"admindata\"])\n    # on envoie la r\u00e9ponse au client\n    return {\"r\u00e9ponse\": {\"result\": taxpayer.asdict()}}, status.HTTP_200_OK\n</code></pre> <ul> <li>ligne 9\u00a0: la fonction [execute] re\u00e7oit deux param\u00e8tres\u00a0:</li> <li>[request]\u00a0: la requ\u00eate HTTP du client\u00a0;</li> <li>[config]\u00a0: le dictionnaire de configuration de l\u2019application\u00a0; Le script [server_02] est le suivant\u00a0:</li> </ul> <pre><code># on attend un param\u00e8tre mysql ou pgres\nimport sys\nsyntaxe = f\"{sys.argv[0]} mysql / pgres\"\nerreur = len(sys.argv) != 2\nif not erreur:\n    sgbd = sys.argv[1].lower()\n    erreur = sgbd != \"mysql\" and sgbd != \"pgres\"\nif erreur:\n    print(f\"syntaxe : {syntaxe}\")\n    sys.exit()\n\n# on configure l'application\nimport config\nconfig = config.configure({'sgbd': sgbd})\n\n# d\u00e9pendances\nfrom Imp\u00f4tsError import Imp\u00f4tsError\nfrom flask import request\nfrom myutils import json_response\nfrom flask import Flask\nimport index_controller\n\n# r\u00e9cup\u00e9ration des donn\u00e9es de l'administration fiscale\ntry:\n    # admindata sera une donn\u00e9e de port\u00e9e application en lecture seule\n    config['admindata'] = config[\"layers\"][\"dao\"].get_admindata()\nexcept Imp\u00f4tsError as erreur:\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\n    sys.exit(1)\n\n# application Flask\napp = Flask(__name__)\n\n\n# Home URL : /?mari\u00e9=xx&amp;enfant=yy&amp;salaire=zz\n@app.route('/', methods=['GET'])\ndef index():\n    # on ex\u00e9cute la requ\u00eate\n    r\u00e9sultat, statusCode = index_controller.execute(request, config)\n    # on envoie la r\u00e9ponse\n    return json_response(r\u00e9sultat, statusCode)\n\n\n# main uniquement\nif __name__ == '__main__':\n    # on lance le serveur\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>ligne 36-41\u00a0: le traitement de la route /\u00a0;</li> <li>ligne 39\u00a0: utilisation de la fonction [IndexController.execute]\u00a0; Nous utiliserons d\u00e9sormais cette technique\u00a0: chaque route sera trait\u00e9e par un module qui lui sera propre.</li> </ul> <p>Les r\u00e9sultats d\u2019ex\u00e9cution sont les m\u00eames que pour la version 1.</p>"},{"location":"exercice-dapplication-version-6.html#2323-version-3","title":"23.2.3. Version 3","text":"<p>La version 3 introduit la notion d\u2019authentification.</p> <p>Le script [server_03] devient le suivant\u00a0:</p> <pre><code># on attend un param\u00e8tre mysql ou pgres\nimport sys\nsyntaxe = f\"{sys.argv[0]} mysql / pgres\"\nerreur = len(sys.argv) != 2\nif not erreur:\n    sgbd = sys.argv[1].lower()\n    erreur = sgbd != \"mysql\" and sgbd != \"pgres\"\nif erreur:\n    print(f\"syntaxe : {syntaxe}\")\n    sys.exit()\n\n# on configure l'application\nimport config\nconfig = config.configure({'sgbd': sgbd})\n\n# d\u00e9pendances\nfrom Imp\u00f4tsError import Imp\u00f4tsError\nfrom flask import request\nfrom myutils import json_response\nfrom flask import Flask\nfrom flask_httpauth import HTTPBasicAuth\nimport index_controller\n\n# r\u00e9cup\u00e9ration des donn\u00e9es de l'administration fiscale\ntry:\n    # config[\u2018admindata\u2019] sera une donn\u00e9e de port\u00e9e application en lecture seule\n    config[\"admindata\"] = config[\"layers\"][\"dao\"].get_admindata()\nexcept Imp\u00f4tsError as erreur:\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\n    sys.exit(1)\n\n# gestionnaire d'authentification\nauth = HTTPBasicAuth()\n\n\n# m\u00e9thode d'authentification\n@auth.verify_password\ndef verify_credentials(login: str, password: str) -&gt; bool:\n    # liste des utilisateurs\n    users = config['users']\n    # on parcourt cette liste\n    for user in users:\n        if user['login'] == login and user['password'] == password:\n            return True\n    # on n'a pas trouv\u00e9\n    return False\n\n\n# application Flask\napp = Flask(__name__)\n\n\n# Home URL : /?mari\u00e9=xx&amp;enfant=yy&amp;salaire=zz\n@app.route('/', methods=['GET'])\n@auth.login_required\ndef index():\n    # on ex\u00e9cute la requ\u00eate\n    r\u00e9sultat, statusCode = index_controller.execute(request, config)\n    # on envoie la r\u00e9ponse\n    return json_response(r\u00e9sultat, statusCode)\n\n\n# main uniquement\nif __name__ == '__main__':\n    # on lance le serveur\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>ligne 21\u00a0: on importe un gestionnaire d\u2019authentification. Il existe divers types d\u2019authentification aupr\u00e8s d\u2019un serveur web. Celle que nous utilisons ici s\u2019appelle [HTTP Basic]. Chaque type d\u2019authentification suit un dialogue client / serveur pr\u00e9cis\u00a0;</li> <li>ligne 33\u00a0: on cr\u00e9e une instance du gestionnaire d\u2019authentification\u00a0;</li> <li>ligne 37\u00a0: l\u2019annotation [@auth.verify_password] tague la fonction \u00e0 ex\u00e9cuter lorsque le gestionnaire d\u2019authentification veut v\u00e9rifier les login / password transmis par le client selon le protocole [HTTP Basic]\u00a0;</li> <li>ligne 55\u00a0: l\u2019annotation [@auth.login_required] tague une route pour laquelle le client web doit \u00eatre authentifi\u00e9. Si le client web n\u2019a pas encore envoy\u00e9 ses identifiants, le serveur web va automatiquement les lui demander selon le protocole HTTP basic\u00a0; Le module [flask_httpauth] doit \u00eatre install\u00e9\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\impots\\http-servers\\01\\flask&gt;pip install flask_httpauth\nCollecting flask_httpauth\n  Downloading Flask_HTTPAuth-4.1.0-py2.py3-none-any.whl (5.8 kB)\nRequirement already satisfied: Flask in c:\\data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages (from flask_httpauth) (1.1.2)\nRequirement already satisfied: itsdangerous&gt;=0.24 in c:\\data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages (from Flask-&gt;flask_httpauth) (1.1.0)\nRequirement already satisfied: click&gt;=5.1 in c:\\data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages (from Flask-&gt;flask_httpauth) (7.1.2)\nRequirement already satisfied: Jinja2&gt;=2.10.1 in c:\\data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages (from Flask-&gt;flask_httpauth) (2.11.2)\nRequirement already satisfied: Werkzeug&gt;=0.15 in c:\\data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages (from Flask-&gt;flask_httpauth) (1.0.1)\nRequirement already satisfied: MarkupSafe&gt;=0.23 in c:\\data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages (from Jinja2&gt;=2.10.1-&gt;Flask-&gt;flask_httpauth) (1.1.1\n)\nInstalling collected packages: flask-httpauth\nSuccessfully installed flask-httpauth-4.1.0\n</code></pre> <p>Voyons ce qui se passe avec la console Postman. Vous\u00a0:</p> <ul> <li>cr\u00e9ez une configuration d\u2019ex\u00e9cution\u00a0;</li> <li>lancez l\u2019application web\u00a0;</li> <li>lancez le SGBD de votre choix\u00a0;</li> <li>demandez l\u2019URL [/] avec Postman\u00a0; Le dialogue client / serveur dans la console Postman est le suivant\u00a0:</li> </ul> <pre><code>GET / HTTP/1.1\nUser-Agent: PostmanRuntime/7.26.1\nAccept: */*\nCache-Control: no-cache\nPostman-Token: e65e2a28-4fe3-423b-88b3-b3e5a83092b1\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\n\nHTTP/1.0 401 UNAUTHORIZED\nContent-Type: text/html; charset=utf-8\nContent-Length: 19\nWWW-Authenticate: Basic realm=\"Authentication Required\"\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Fri, 17 Jul 2020 07:05:37 GMT\n\nUnauthorized Access\n</code></pre> <ul> <li>ligne 10\u00a0: le serveur r\u00e9pond que nous ne sommes pas autoris\u00e9s \u00e0 acc\u00e9der \u00e0 l\u2019URL [/]\u00a0;</li> <li>ligne 13\u00a0: il nous indique le protocole d\u2019authentification \u00e0 utiliser, ici le protocole dit Authentification Basic\u00a0; Il est possible de configurer Postman pour qu\u2019il envoie les identifiants de l\u2019utilisateur selon le protocole Auth Basic\u00a0:</li> </ul> <p></p> <ul> <li>en [6-7] nous mettons les identifiants pr\u00e9sents dans le script [config]\u00a0:</li> </ul> <p></p> <pre><code>    config['users'] = [\n        {\n            \"login\": \"admin\",\n            \"password\": \"admin\"\n        }\n    ]\n</code></pre> <p>Le dialogue client / serveur dans la console Postman devient le suivant\u00a0:</p> <pre><code>GET / HTTP/1.1\nAuthorization: Basic YWRtaW46YWRtaW4=\nUser-Agent: PostmanRuntime/7.26.1\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 5ce20822-e87c-4eef-a2f4-b9eaec38d881\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\n\nHTTP/1.0 400 BAD REQUEST\nContent-Type: application/json; charset=utf-8\nContent-Length: 203\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Fri, 17 Jul 2020 07:20:01 GMT\n\n{\"r\u00e9ponse\": {\"erreurs\": [\"M\u00e9thode GET requise avec les seuls param\u00e8tres [mari\u00e9, enfants, salaire]\", \"param\u00e8tre [mari\u00e9] manquant\", \"param\u00e8tre [enfants] manquant\", \"param\u00e8tre [salaire] manquant\"]}}\n</code></pre> <ul> <li>ligne 2\u00a0: le client Postman envoie sous forme cod\u00e9e les identifiants de l\u2019utilisateur [admin / admin]\u00a0;</li> <li>ligne 17\u00a0: le serveur r\u00e9pond correctement. Il signale des erreurs car on n\u2019a pas envoy\u00e9 les param\u00e8tres [mari\u00e9, enfants, salaire] (ligne 1)\u00a0mais il ne signale pas d\u2019erreur d\u2019authentification\u00a0; Maintenant demandons l\u2019URL / avec un navigateur (Firefox ci-dessous)\u00a0:</li> </ul> <p></p> <ul> <li>comme avec Postman, Firefox a re\u00e7u la r\u00e9ponse HTTP du serveur avec les ent\u00eates HTTP\u00a0: <pre><code>HTTP/1.0 401 UNAUTHORIZED\n\u2026\nWWW-Authenticate: Basic realm=\"Authentication Required\"\n\u2026\n</code></pre></li> </ul> <p>Firefox comme d\u2019autres navigateurs n\u2019arr\u00eatent pas le dialogue lorsqu\u2019il re\u00e7oit ces ent\u00eates. Il demandet \u00e0 l\u2019utilisateur les identifiants r\u00e9clam\u00e9s par le serveur. Il suffit ci-dessus de taper admin / admin pour recevoir la r\u00e9ponse du serveur\u00a0:</p> <p></p>"},{"location":"exercice-dapplication-version-6.html#233-le-client-web-du-serveur-de-calcul-de-limpot","title":"23.3. Le client web du serveur de calcul de l\u2019imp\u00f4t","text":""},{"location":"exercice-dapplication-version-6.html#2331-introduction","title":"23.3.1. Introduction","text":"<p>Dans le paragraphe pr\u00e9c\u00e9dent, le client web du serveur de calcul de l\u2019imp\u00f4t \u00e9tait un navigateur. Dans cette partie, le client web sera un script console. L\u2019architecture devient la suivante\u00a0:</p> <p></p> <ul> <li>le client web est form\u00e9 des couches [1-2]\u00a0;</li> <li>le serveur web est form\u00e9 des couches [3-9]. Il a \u00e9t\u00e9 \u00e9crit dans le paragraphe pr\u00e9c\u00e9dent\u00a0; Il nous faut donc \u00e9crire les couches [1-2].</li> </ul> <p>La couche [dao] [2] doit savoir communiquer avec le serveur web [3]. Nous connaissons maintenant le protocole HTTP et nous pourrions \u00e9crire, avec le module [pycurl] d\u00e9j\u00e0 \u00e9tudi\u00e9 par exemple, un script communiquant avec le serveur web [3]. Cependant il existe des modules sp\u00e9cialis\u00e9s dans les dialogues HTTP client / serveur. Nous allons utiliser l\u2019un d\u2019entre-eux, le module [requests]\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\impots\\http-servers\\01\\flask&gt;pip install requests\nCollecting requests\n  Downloading requests-2.24.0-py2.py3-none-any.whl (61 kB)\n     || 61 kB 137 kB/s\nCollecting idna&lt;3,&gt;=2.5\n  Downloading idna-2.10-py2.py3-none-any.whl (58 kB)\n     || 58 kB 692 kB/s\nCollecting chardet&lt;4,&gt;=3.0.2\n  Downloading chardet-3.0.4-py2.py3-none-any.whl (133 kB)\n     || 133 kB 1.3 MB/s\nCollecting urllib3!=1.25.0,!=1.25.1,&lt;1.26,&gt;=1.21.1\n  Downloading urllib3-1.25.9-py2.py3-none-any.whl (126 kB)\n     || 126 kB 1.1 MB/s\nCollecting certifi&gt;=2017.4.17\n  Downloading certifi-2020.6.20-py2.py3-none-any.whl (156 kB)\n     || 156 kB 1.1 MB/s\nInstalling collected packages: idna, chardet, urllib3, certifi, requests\nSuccessfully installed certifi-2020.6.20 chardet-3.0.4 idna-2.10 requests-2.24.0 urllib3-1.25.9\n</code></pre> <p>L\u2019arborescence des scripts du client web est la suivante\u00a0:</p> <p></p> <p>Le script va impl\u00e9menter l\u2019application de calcul de l\u2019imp\u00f4t en mode batch d\u00e9crite d\u00e8s la |version 1|. La derni\u00e8re version de cette application est la |version 5|. On rappelle son fonctionnement\u00a0:</p> <ul> <li> <p>les contribuables dont on va calculer l\u2019imp\u00f4t sont rassembl\u00e9s dans le fichier texte [taxpayersdata.txt]\u00a0: <pre><code># donn\u00e9es valides : id, mari\u00e9, enfants, salaire\n1,oui,2,55555\n2,oui,2,50000\n3,oui,3,50000\n4,non,2,100000\n5,non,3,100000\n6,oui,3,100000\n7,oui,5,100000\n8,non,0,100000\n9,oui,2,30000\n10,non,0,200000\n11,oui,3,200000\n# on cr\u00e9e des lignes erron\u00e9es\n# pas assez de valeurs\n11,12\n# des valeurs erron\u00e9es\nx,x,x,x\n</code></pre></p> </li> <li> <p>les r\u00e9sultats vont dans deux fichiers\u00a0:</p> </li> <li> <p>le fichier texte [errors.txt] rassemble les erreurs d\u00e9tect\u00e9es dans le fichier des contribuables\u00a0: <pre><code>Analyse du fichier C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\impots\\http-clients\\01\\main/../data/input/taxpayersdata.txt\n\nLigne 15, not enough values to unpack (expected 4, got 2)\nLigne 17, MyException[1, L'identifiant d'une entit\u00e9 &lt;class 'TaxPayer.TaxPayer'&gt; doit \u00eatre un entier &gt;=0]\n</code></pre></p> </li> <li> <p>le fichier jSON [r\u00e9sultats.json] rassemble les r\u00e9sultats des calculs de l\u2019imp\u00f4t des diff\u00e9rents contribuables\u00a0: <pre><code>[\n  {\n    \"id\": 0,\n    \"mari\u00e9\": \"oui\",\n    \"enfants\": 2,\n    \"salaire\": 55555,\n    \"imp\u00f4t\": 2814,\n    \"surc\u00f4te\": 0,\n    \"taux\": 0.14,\n    \"d\u00e9c\u00f4te\": 0,\n    \"r\u00e9duction\": 0\n  },\n  {\n    \"id\": 1,\n    \"mari\u00e9\": \"oui\",\n    \"enfants\": 2,\n    \"salaire\": 50000,\n    \"imp\u00f4t\": 1384,\n    \"surc\u00f4te\": 0,\n    \"taux\": 0.14,\n    \"d\u00e9c\u00f4te\": 384,\n    \"r\u00e9duction\": 347\n  },\n  \u2026\n]\n</code></pre></p> </li> </ul>"},{"location":"exercice-dapplication-version-6.html#2332-configuration-du-client-web","title":"23.3.2. Configuration du client web","text":"<p>La configuration se fait \u00e0 l\u2019aide de deux scripts\u00a0:</p> <ul> <li>[config] qui assure la totalit\u00e9 de la configuration hors couches de l\u2019architecture\u00a0;</li> <li>[config_layers] qui assure la configuration des couches de l\u2019architecture\u00a0; Le script [config] est le suivant\u00a0:</li> </ul> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a01\u00a0------\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0de\u00a0ce\u00a0fichier\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0racine\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020\"\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\u00a0absolues\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossiers\u00a0du\u00a0projet\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0BaseEntity,\u00a0MyException\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/classes/02/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0InterfaceImp\u00f4tsDao,\u00a0InterfaceImp\u00f4tsM\u00e9tier,\u00a0InterfaceImp\u00f4tsUi\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AbstractImp\u00f4tsdao,\u00a0Imp\u00f4tsConsole,\u00a0Imp\u00f4tsM\u00e9tier\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ImpotsDaoWithAdminDataInDatabase\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AdminData,\u00a0Imp\u00f4tsError,\u00a0TaxPayer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Constantes,\u00a0tranches\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Imp\u00f4tsDaoWithHttpClient\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0scripts\u00a0de\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0script_dir,\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fixe\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a02\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\u00a0avec\u00a0des\u00a0constantes\n\u00a0\u00a0\u00a0\u00a0config.update({\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"taxpayersFilename\":\u00a0f\"{script_dir}/../data/input/taxpayersdata.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"resultsFilename\":\u00a0f\"{script_dir}/../data/output/r\u00e9sultats.json\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"errorsFilename\":\u00a0f\"{script_dir}/../data/output/errors.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"server\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"urlServer\":\u00a0\"http://127.0.0.1:5000/\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"authBasic\":\u00a0True,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"user\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"login\":\u00a0\"admin\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"admin\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a03\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\n\u00a0\u00a0\u00a0\u00a0import\u00a0config_layers\n\u00a0\u00a0\u00a0\u00a0config['layers']\u00a0=\u00a0config_layers.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuation\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <ul> <li>ligne 1\u00a0: la fonction [configure] re\u00e7oit en param\u00e8tre le dictionnaire \u00e0 remplir avec les informations de configuration. Celui-ci peut \u00eatre d\u00e9j\u00e0 pr\u00e9-rempli ou vide. Ici, il sera vide\u00a0;</li> <li>lignes 40-42\u00a0: les noms absolus des trois fichiers texte g\u00e9r\u00e9s par la couche [dao]\u00a0;</li> <li>lignes 43-50\u00a0: associ\u00e9es \u00e0 la cl\u00e9 [server], les informations que doit conna\u00eetre la couche [dao] sur le serveur web avec lequel elle doit communiquer\u00a0:</li> <li>ligne 44\u00a0: l\u2019URL du service web\u00a0;</li> <li>ligne 45\u00a0: la cl\u00e9 [authBasic] vaut True si l\u2019acc\u00e8s \u00e0 l\u2019URL n\u00e9cessite une authentification de type Basic\u00a0;</li> <li>lignes 46-49\u00a0: les identifiants de l\u2019utilisateur qui va s\u2019authentifier si l\u2019authentification est demand\u00e9e\u00a0;</li> <li>lignes 56-57\u00a0: on instancie les couches, ici l\u2019unique couche [dao] et on met les r\u00e9f\u00e9rences des couches dans [config] associ\u00e9es \u00e0 la cl\u00e9 [layers]\u00a0; Le script [config_layers] est le suivant\u00a0:</li> </ul> <pre><code>def configure(config: dict) -&gt; dict:\n    # instanciation des couches de l'applicatuon\n\n    # couche dao\n    from Imp\u00f4tsDaoWithHttpClient import Imp\u00f4tsDaoWithHttpClient\n    dao = Imp\u00f4tsDaoWithHttpClient(config)\n\n    # on rend la configuation des couches\n    return {\n        \"dao\": dao\n    }\n</code></pre> <ul> <li>ligne 1\u00a0: la fonction [configure] re\u00e7oit le dictionnaire qui configure l\u2019application\u00a0;</li> <li>lignes 4-6\u00a0: la couche [dao] est instanci\u00e9e. Ligne 6, on lui passe la configuration de l\u2019application dans lequel elle trouvera les informations dont elle a besoin\u00a0;</li> <li>lignes 8-11\u00a0: on rend un dictionnaire dans lequel on a mis la r\u00e9f\u00e9rence de la couche [dao]\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-6.html#2333-le-script-principal-main","title":"23.3.3. Le script principal [main]","text":"<p>Le script principal [main] est une variante de celui de la |version 5|\u00a0:</p> <pre><code># on configure l'application\nimport config\nconfig = config.configure({})\n\n# d\u00e9pendances\nfrom Imp\u00f4tsError import Imp\u00f4tsError\n\n# code\ntry:\n    # on r\u00e9cup\u00e8re la couche [dao]\n    dao = config[\"layers\"][\"dao\"]\n    # lecture des donn\u00e9es des contribuables\n    taxpayers = dao.get_taxpayers_data()[\"taxpayers\"]\n    # des contribuables ?\n    if not taxpayers:\n        raise Imp\u00f4tsError(f\"Pas de contribuables valides dans le fichier {config['taxpayersFilename']}\")\n    # calcul de l'imp\u00f4t des contribuables\n    for taxpayer in taxpayers:\n        # taxpayer est \u00e0 la fois un param\u00e8tre d'entr\u00e9e et de sortie\n        # taxpayer va \u00eatre modifi\u00e9\n        dao.calculate_tax(taxpayer)\n    # \u00e9criture des r\u00e9sultats dans un fichier texte\n    dao.write_taxpayers_results(taxpayers)\nexcept Imp\u00f4tsError  as erreur:\n    # affichage de l'erreur\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\nfinally:\n    # termin\u00e9\n    print(\"Travail termin\u00e9...\")\n</code></pre> <ul> <li>lignes 2-3\u00a0: l\u2019application est configur\u00e9e\u00a0;</li> <li>ligne 13\u00a0: la couche [dao] fournit la liste des contribuables dont on doit calculer l\u2019imp\u00f4t\u00a0;</li> <li>ligne 21\u00a0: la couche [dao] calcule l\u2019imp\u00f4t de chacun d\u2019eux\u00a0;</li> <li>ligne 23\u00a0: les r\u00e9sultats sont enregistr\u00e9s dans un fichier jSON\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-6.html#2334-implementation-de-la-couche-dao","title":"23.3.4. Impl\u00e9mentation de la couche [dao]","text":"<p>Revenons sur l\u2019architecture client / serveur utilis\u00e9e\u00a0:</p> <p></p> <ul> <li>en [2, 6], on voit que la couche [dao] a deux r\u00f4les\u00a0:</li> <li>elle acc\u00e8de au syst\u00e8me de fichiers \u00e0 la fois pour lire les donn\u00e9es des contribuables et \u00e9crire les r\u00e9sultats des calculs de l\u2019imp\u00f4t. Nous avons d\u00e9j\u00e0 une classe |AbstractImp\u00f4tsDao| qui sait faire cela. Elle a \u00e9t\u00e9 utilis\u00e9e d\u00e8s la |version 4|\u00a0;</li> <li>elle dialogue avec le serveur web [3]\u00a0; Dans la |version 5|, le script principal [main] [1] dialoguait directement avec la couche [m\u00e9tier] [4]. On voudrait ne pas changer ce script. Pour cela, on va faire en sorte que la couche [dao] [2] impl\u00e9mente l\u2019interface de la couche [m\u00e9tier] [4]. Ainsi le script principal [main] aura l\u2019impression de dialoguer directement avec la couche [m\u00e9tier] [4] et pourra ignorer compl\u00e8tement que celle-ci se situe sur une autre machine.</li> </ul> <p>Une d\u00e9finition de la classe impl\u00e9mentant la couche [dao] [2] pourrait \u00eatre celle-ci\u00a0:</p> <pre><code>class Imp\u00f4tsDaoWithHttpClient(AbstractImp\u00f4tsDao, InterfaceImp\u00f4tsM\u00e9tier):\n</code></pre> <ul> <li>la classe [Imp\u00f4tsDaoWithHttpClient]\u00a0:</li> <li>h\u00e9rite de la classe [AbstractImp\u00f4tsDao] ce qui va lui permettre de g\u00e9rer le dialogue avec le syst\u00e8me de fichiers [6]\u00a0;</li> <li>impl\u00e9mente l\u2019interface [InterfaceImp\u00f4tsM\u00e9tier] pour ne pas avoir \u00e0 changer le script principal [main] de la |version 5|\u00a0; Le code complet de la classe [Imp\u00f4tsDaoWithHttpClient] est le suivant\u00a0:</li> </ul> <pre><code># imports\nimport requests\nfrom flask_api import status\n\nfrom AbstractImp\u00f4tsDao import AbstractImp\u00f4tsDao\nfrom AdminData import AdminData\nfrom Imp\u00f4tsError import Imp\u00f4tsError\nfrom InterfaceImp\u00f4tsM\u00e9tier import InterfaceImp\u00f4tsM\u00e9tier\nfrom TaxPayer import TaxPayer\n\n\nclass Imp\u00f4tsDaoWithHttpClient(AbstractImp\u00f4tsDao, InterfaceImp\u00f4tsM\u00e9tier):\n\n    # constructeur\n    def __init__(self, config: dict):\n        # initialisation parent\n        AbstractImp\u00f4tsDao.__init__(self, config)\n        # m\u00e9morisation param\u00e8tres\n        self.__config_server = config[\"server\"]\n\n    # m\u00e9thode inutilis\u00e9e de [AbstractImp\u00f4tsDao]\n    def get_admindata(self) -&gt; AdminData:\n        pass\n\n    # calcul de l'imp\u00f4t\n    def calculate_tax(self: object, taxpayer: TaxPayer, admindata: AdminData = None):\n        # on laisse remonter les exceptions\n        # param\u00e8tres du get\n        params = {\"mari\u00e9\": taxpayer.mari\u00e9, \"enfants\": taxpayer.enfants, \"salaire\": taxpayer.salaire}\n        # connexion avec authentification Auth Basic ?\n        if self.__config_server['authBasic']:\n            response = requests.get(\n                # URL du serveur interrog\u00e9\n                self.__config_server['urlServer'],\n                # param\u00e8tres de l'URL\n                params=params,\n                # authentification Basic\n                auth=(\n                    self.__config_server[\"user\"][\"login\"],\n                    self.__config_server[\"user\"][\"password\"]))\n        else:\n            # connexion sans authentification Auth Basic\n            response = requests.get(self.__config_server['urlServer'], params=params)\n        # v\u00e9rification\n        print(response.text)\n        # code de statut de la r\u00e9ponse HTTP\n        status_code = response.status_code\n        # on met la r\u00e9ponse jSON dans un dictionnaire\n        r\u00e9sultat = response.json()\n        # erreur si code de statut diff\u00e9rent de 200 OK\n        if status_code != status.HTTP_200_OK:\n            # on sait que les erreurs ont \u00e9t\u00e9 associ\u00e9es \u00e0 la cl\u00e9 [erreurs] de la r\u00e9ponse\n            raise Imp\u00f4tsError(87, r\u00e9sultat['r\u00e9ponse']['erreurs'])\n        # on sait que le r\u00e9sultat a \u00e9t\u00e9 associ\u00e9 \u00e0 la cl\u00e9 [result] de la r\u00e9ponse\n        # on modifie le param\u00e8tre d'entr\u00e9e avec ce r\u00e9sultat\n        taxpayer.fromdict(r\u00e9sultat[\"r\u00e9ponse\"][\"result\"])\n</code></pre> <ul> <li>lignes 21-23\u00a0: la classe [AbstractImp\u00f4tsDao] (ligne 12) poss\u00e8de une m\u00e9thode abstraite [get_admindata]. Nous sommes oblig\u00e9s de l\u2019impl\u00e9menter m\u00eame si on ne s\u2019en sert pas (admindata est g\u00e9r\u00e9 par le serveur pas par le client)\u00a0;</li> <li>ligne 26\u00a0: la m\u00e9thode [calculate_tax] appartient \u00e0 l\u2019interface [InterfaceImp\u00f4tsM\u00e9tier] (ligne 12). il nous faut l\u2019impl\u00e9menter\u00a0;</li> <li>ligne 15\u00a0: le constructeur re\u00e7oit en unique param\u00e8tre le dictionnaire de la configuration de l\u2019application\u00a0;</li> <li>lignes 16-17\u00a0: la classe parent [AbstractImp\u00f4tsDao] est initialis\u00e9e en lui passant, l\u00e0 \u00e9galement, la configuration de l\u2019application. Elle y trouvera les noms des trois fichiers texte qu\u2019elle a \u00e0 g\u00e9rer\u00a0;</li> <li>lignes 18-19\u00a0: on m\u00e9morise localement dans la classe les informations concernant le serveur web de calcul de l\u2019imp\u00f4t\u00a0;</li> <li>ligne 26\u00a0: la m\u00e9thode [calculate_tax] re\u00e7oit en param\u00e8tre un objet de type |Taxpayer|. Pour respecter la signature de la m\u00e9thode [InterfaceImp\u00f4tsM\u00e9tier.calculate_tax], elle re\u00e7oit \u00e9galement un param\u00e8tre [admindata] qui est cens\u00e9 encapsuler les donn\u00e9es de l\u2019administration fiscale. C\u00f4t\u00e9 client, on n\u2019a pas ces donn\u00e9es. Ce param\u00e8tre restera toujours \u00e0 [None]. Cette contorsion fait dire que la classe [Imp\u00f4tsM\u00e9tier] a \u00e9t\u00e9 initialement mal \u00e9crite\u00a0:</li> <li>la signature de [calculate_tax] aurait d\u00fb \u00eatre simplement\u00a0: <pre><code>def calculate_tax(self, taxpayer: TaxPayer)\n</code></pre></li> </ul> <p>et le param\u00e8tre [admindata\u00a0: AdminData] aurait d\u00fb \u00eatre pass\u00e9 au constructeur de la classe\u00a0;</p> <ul> <li>ligne 27\u00a0: le code de la m\u00e9thode [calculate_tax] n\u2019a pas \u00e9t\u00e9 encapsul\u00e9 dans un try / catch / finally. Cela veut dire que les \u00e9ventuelles exceptions ne seront pas g\u00e9r\u00e9es et remonteront au code appelant, en l\u2019occurrence le script [main]. Celui-ci arr\u00eate bien toutes les exceptions remontant de la couche [dao]\u00a0;</li> <li>ligne 28\u00a0: le calcul de l\u2019imp\u00f4t se fait c\u00f4t\u00e9 serveur. Il va donc falloir communiquer avec lui. On le fait avec le module [requests] import\u00e9 ligne 2\u00a0;</li> <li>lignes 31-43\u00a0: pour envoyer une requ\u00eate GET au serveur web, on utilise la m\u00e9thode [requests.get]\u00a0:</li> <li>lignes 33-34\u00a0: le 1er param\u00e8tre de la m\u00e9thode est l\u2019URL \u00e0 contacter\u00a0;</li> <li>lignes 35-40\u00a0: les deux autres param\u00e8tres sont des param\u00e8tres nomm\u00e9s dont l\u2019ordre n\u2019importe pas\u00a0;</li> <li>lignes 35-36\u00a0: la valeur du param\u00e8tre nomm\u00e9 [params] doit \u00eatre un dictionnaire contenant les informations \u00e0 mettre dans l\u2019URL sous la forme [/url\u00a0?param1=valeur1&amp;param2=valeur2&amp;\u2026]\u00a0;</li> <li>ligne 29\u00a0: le dictionnaire contenant les trois param\u00e8tres [mari\u00e9, enfants, salaire] que le serveur web attend. On n\u2019a pas \u00e0 s\u2019occuper de l\u2019encodage (appel\u00e9 urlencoded) que doivent subir ces param\u00e8tres. [requests] s\u2019en occupe\u00a0;</li> <li>lignes 37-40\u00a0: le param\u00e8tre nomm\u00e9 [auth] est un tuple de deux \u00e9l\u00e9ments (login, password). Il repr\u00e9sente les identifiants d\u2019une authentification de type Basic\u00a0;</li> <li>lignes 44-45\u00a0: ces deux lignes n\u2019ont qu\u2019un but p\u00e9dagogique\u00a0(on les mettra en commentaires lorsque le d\u00e9bogage sera termin\u00e9)\u00a0:</li> <li>[response] repr\u00e9sente la r\u00e9ponse HTTP du serveur\u00a0;</li> <li>[response.text] repr\u00e9sente le texte du document encapsul\u00e9 dans cette r\u00e9ponse. En phase de d\u00e9bogage, il est utile de v\u00e9rifier ce que le serveur nous a envoy\u00e9\u00a0;</li> <li>ligne 47\u00a0: [response.status_code] est le code de statut HTTP de la r\u00e9ponse re\u00e7ue. Notre serveur n\u2019en envoie que trois\u00a0:</li> <li>200 OK</li> <li>400 BAD REQUEST</li> <li>500 INTERNAL SERVER ERROR</li> <li>ligne 49\u00a0: notre serveur envoie toujours du jSON m\u00eame en cas d\u2019erreur. La fonction [response.json()] cr\u00e9e un dictionnaire \u00e0 partir de la cha\u00eene jSON re\u00e7ue. Rappelons les deux formes possibles pour la cha\u00eene jSON\u00a0: <pre><code>{\"r\u00e9ponse\": {\"erreurs\": [\"M\u00e9thode GET requise avec les seuls param\u00e8tres [mari\u00e9, enfants, salaire]\", \"param\u00e8tre [mari\u00e9] manquant\", \"param\u00e8tre [enfants] manquant\", \"param\u00e8tre [salaire] manquant\"]}}\n</code></pre></li> </ul> <pre><code>{\"r\u00e9ponse\": {\"result\": {\"id\": 0, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000, \"imp\u00f4t\": 42842, \"surc\u00f4te\": 17283, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n</code></pre> <ul> <li>lignes 51-53\u00a0: si le code de statut n\u2019est pas 200 alors on lance une exception avec les messages d\u2019erreur encapsul\u00e9s dans la r\u00e9ponse\u00a0;</li> <li>ligne 56\u00a0: on r\u00e9cup\u00e8re le dictionnaire produit par le calcul de l\u2019imp\u00f4t et on l\u2019utilise pour mettre \u00e0 jour le param\u00e8tre d\u2019entr\u00e9e [taxpayer]\u00a0; </li> </ul>"},{"location":"exercice-dapplication-version-6.html#2335-execution","title":"23.3.5. Ex\u00e9cution","text":"<p>Pour ex\u00e9cuter le client\u00a0:</p> <ul> <li>lancer le serveur [server_03] avec le SGBD de votre choix\u00a0;</li> <li>ex\u00e9cuter le script [main] du client\u00a0; Les r\u00e9sultats seront trouv\u00e9s dans le dossier [data/output]. Ce sont les m\u00eames que pour la version 5.</li> </ul>"},{"location":"exercice-dapplication-version-6.html#234-tests-de-la-couche-dao","title":"23.4. Tests de la couche [dao]","text":"<p>Revenons \u00e0 l\u2019architecture de l\u2019application client / serveur\u00a0:</p> <p></p> <ul> <li>dans le client \u00e9crit, nous nous sommes d\u00e9brouill\u00e9s pour que la couche [dao] [1] offre la m\u00eame interface que la couche [m\u00e9tier] [3]. Nous allons donc utiliser en [4], la classe de tests |TestDaoM\u00e9tier| d\u00e9j\u00e0 \u00e9tudi\u00e9e pour tester la couche [m\u00e9tier] [3]\u00a0; La classe de test sera ex\u00e9cut\u00e9e dans l\u2019environnement suivant\u00a0:</li> </ul> <p></p> <ul> <li>la configuration [2] est identique \u00e0 la configuration [1] que nous venons d\u2019\u00e9tudier\u00a0; La classe de test [TestHttpClientDao] est la suivante\u00a0:</li> </ul> <pre><code>import unittest\n\n\nclass TestHttpClientDao(unittest.TestCase):\n\n    def test_1(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 55555,\n        # 'imp\u00f4t': 2814, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.14}\n        taxpayer = TaxPayer().fromdict({\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555})\n        dao.calculate_tax(taxpayer)\n        # v\u00e9rification\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 2815, delta=1)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.14, delta=0.01)\n        self.assertEqual(taxpayer.surc\u00f4te, 0)\n\n    \u2026\n\n    def test_11(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 200000,\n        # 'imp\u00f4t': 42842, 'surc\u00f4te': 17283, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.41}\n        taxpayer = TaxPayer().fromdict({'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 200000})\n        dao.calculate_tax(taxpayer)\n        # v\u00e9rifications\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 42842, 1)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.41, delta=0.01)\n        self.assertAlmostEqual(taxpayer.surc\u00f4te, 17283, delta=1)\n\n\nif __name__ == '__main__':\n\n    # on configure l'application\n    import config\n    config = config.configure({})\n\n    # couche dao\n    dao = config['layers']['dao']\n\n    # on ex\u00e9cute les m\u00e9thodes de test\n    print(\"tests en cours...\")\n    unittest.main()\n</code></pre> <p>Cette classe est analogue \u00e0 |celle| d\u00e9j\u00e0 \u00e9tudi\u00e9e dans la version 4 de l\u2019application.</p> <ul> <li>lignes 40-41\u00a0: on configure l\u2019environnement des tests\u00a0;</li> <li>ligne 44\u00a0: on r\u00e9cup\u00e8re une r\u00e9f\u00e9rence sur la couche [dao]\u00a0;</li> <li>lignes 47-48\u00a0: on ex\u00e9cute les tests\u00a0; Pour ex\u00e9cuter les tests, on cr\u00e9e une |configuration d\u2019ex\u00e9cution|\u00a0:</li> </ul> <p></p> <ul> <li>on cr\u00e9e une configuration d\u2019ex\u00e9cution pour un script console pas pour un test UnitTest\u00a0; Lorsqu\u2019on ex\u00e9cute cette configuration, on obtient les r\u00e9sultats suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots/http-clients/01/tests/TestHttpClientDao.py\ntests en cours...\n{\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555, \"imp\u00f4t\": 2814, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n....{\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 200000, \"imp\u00f4t\": 64210, \"surc\u00f4te\": 7498, \"taux\": 0.45, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n{\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000, \"imp\u00f4t\": 42842, \"surc\u00f4te\": 17283, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n{\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 50000, \"imp\u00f4t\": 1384, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 384, \"r\u00e9duction\": 347}}}\n{\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 50000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 720, \"r\u00e9duction\": 0}}}\n...{\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"non\", \"enfants\": 2, \"salaire\": 100000, \"imp\u00f4t\": 19884, \"surc\u00f4te\": 4480, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n{\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"non\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 16782, \"surc\u00f4te\": 7176, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n{\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 9200, \"surc\u00f4te\": 2180, \"taux\": 0.3, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n{\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 5, \"salaire\": 100000, \"imp\u00f4t\": 4230, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n{\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 100000, \"imp\u00f4t\": 22986, \"surc\u00f4te\": 0, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n....\n{\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 30000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.0, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n----------------------------------------------------------------------\nRan 11 tests in 0.130s\n\nOK\n\nProcess finished with exit code 0\n</code></pre> <p>Les 11 tests ont r\u00e9ussi.</p>"},{"location":"exercice-dapplication-version-7.html","title":"24. Exercice d\u2019application\u00a0: version 7","text":""},{"location":"exercice-dapplication-version-7.html#241-introduction","title":"24.1. Introduction","text":"<p>La version 7 de l\u2019application de calcul de l\u2019imp\u00f4t est identique \u00e0 la version 6 aux d\u00e9tails pr\u00e8s\u00a0suivants : </p> <ul> <li>le client web va lancer simultan\u00e9ment plusieurs requ\u00eates HTTP. Dans la version pr\u00e9c\u00e9dente\u00a0ces requ\u00eates \u00e9taient lanc\u00e9es s\u00e9quentiellement. Le serveur ne traitait alors \u00e0 tout moment qu\u2019une unique requ\u00eate\u00a0;</li> <li>le serveur sera multi-thread\u00e9\u00a0: il pourra traiter plusieurs requ\u00eates simultan\u00e9ment\u00a0;</li> <li>pour suivre l\u2019ex\u00e9cution de ces requ\u00eates, on va doter le serveur web d\u2019un logueur avec lequel on loguera dans un fichier texte les moments importants du traitement des requ\u00eates\u00a0;</li> <li>le serveur enverra un mail \u00e0 l\u2019administrateur de l\u2019application lorsqu\u2019il rencontrera un probl\u00e8me qui l\u2019emp\u00eachera de se lancer, typiquement un probl\u00e8me avec la base de donn\u00e9es associ\u00e9e au serveur web\u00a0; L\u2019architecture de l\u2019application ne change pas\u00a0:</li> </ul> <p></p> <p>L\u2019arborescence des scripts est la suivante\u00a0:</p> <p></p> <p>Le dossier [http-servers/02] est d\u2019abord obtenue par recopie du dossier [http-servers/01]. On y fait ensuite des modifications.</p>"},{"location":"exercice-dapplication-version-7.html#242-les-utilitaires","title":"24.2. Les utilitaires","text":""},{"location":"exercice-dapplication-version-7.html#2421-la-classe-logger","title":"24.2.1. La classe [Logger]","text":"<p>La classe [Logger] va permettre de loguer dans un fichier texte certaines actions du serveur web\u00a0:</p> <pre><code>import codecs\nimport threading\nfrom datetime import date, datetime\nfrom threading import current_thread\n\nfrom Imp\u00f4tsError import Imp\u00f4tsError\n\n\nclass Logger:\n    # attribut de classe\n    verrou = threading.RLock()\n\n    # constructeur\n    def __init__(self, logs_filename: str):\n        try:\n            # on ouvre le fichier en mode append (a)\n            self.__resource = codecs.open(logs_filename, \"a\", \"utf-8\")\n        except BaseException as erreur:\n            raise Imp\u00f4tsError(18, f\"{erreur}\")\n\n    # \u00e9criture d'un log\n    def write(self, message: str):\n        # date / heure du moment\n        today = date.today()\n        now = datetime.time(datetime.now())\n        # nom du thread\n        thread_name = current_thread().name\n        # on ne veut pas \u00eatre d\u00e9rang\u00e9 pendant qu'on \u00e9crira dans le fichier de logs\n        # on demande l'objet de synchronisation (= le verrou) de la classe - un seul thread l'obtiendra\n        Logger.verrou.acquire()\n        try:\n            # \u00e9criture du log\n            self.__resource.write(f\"{today} {now}, {thread_name} : {message}\")\n            # \u00e9criture imm\u00e9diate - sinon le texte ne sera \u00e9crit que lors de la fermeture du flux d'\u00e9criture\n            # or on veut suivre les logs dans le temps\n            self.__resource.flush()\n        finally:\n            # on lib\u00e8re l'objet de synchronisation (= le verrou) pour qu'un autre thread puisse l'obtenir\n            Logger.verrou.release()\n\n    # lib\u00e9ration des ressources\n    def close(self):\n        # fermeture du fichier\n        if self.__resource:\n            self.__resource.close()\n</code></pre> <ul> <li>lignes 10-11\u00a0: on d\u00e9finit un attribut de classe. Un attribut de classe est une propri\u00e9t\u00e9 partag\u00e9e par toutes les instances de la classe. On la r\u00e9f\u00e9rence par la notation [Classe.attribut_de_classe] (lignes 30, 39). L\u2019attribut de classe [verrou] sera un objet de synchronisation pour tous les threads ex\u00e9cutant le code des lignes 31-36\u00a0;</li> <li>lignes 14-19\u00a0: le constructeur re\u00e7oit le nom absolu du fichier de logs. Ce fichier est alors ouvert et le descripteur de fichier r\u00e9cup\u00e9r\u00e9 est m\u00e9moris\u00e9 dans la classe\u00a0;</li> <li>ligne 17\u00a0: le fichier de logs est ouvert en mode \u2018append\u2019 (a). Chaque ligne \u00e9crite le sera \u00e0 la fin du fichier\u00a0;</li> <li>lignes 22-39\u00a0: la m\u00e9thode [write] permet d\u2019\u00e9crire dans le fichier de logs un message pass\u00e9 en param\u00e8tre. A celui-ci sont accol\u00e9es deux informations\u00a0:</li> <li>ligne 24\u00a0: la date du jour\u00a0;</li> <li>ligne 25\u00a0: l\u2019heure du moment\u00a0;</li> <li>ligne 27\u00a0: le nom du thread qui \u00e9crit le log. Il ne faut pas oublier ici qu\u2019une application web sert plusieurs utilisateurs \u00e0 la fois. Toute requ\u00eate se voit attribuer un thread pour l\u2019ex\u00e9cuter. Si ce thread est mis en pause, typiquement pour une op\u00e9ration d\u2019 entr\u00e9e / sortie (r\u00e9seau, fichiers, base de donn\u00e9es), alors le processeur sera donn\u00e9 \u00e0 un autre thread. A cause de ces interruptions possibles, on ne peut pas \u00eatre s\u00fbrs qu\u2019un thread va r\u00e9ussir \u00e0 \u00e9crire une ligne dans le fichier de logs sans \u00eatre interrompu. On risque alors de voir des logs de deux threads diff\u00e9rents se m\u00e9langer. Le risque est faible, peut-\u00eatre m\u00eame nul, mais on a n\u00e9anmoins d\u00e9cid\u00e9 de montrer comment synchroniser l\u2019acc\u00e8s de deux threads \u00e0 une ressource commune, ici le fichier de logs\u00a0;</li> <li>ligne 30\u00a0: avant d\u2019\u00e9crire, le thread demande la cl\u00e9 de la porte d\u2019entr\u00e9e. La cl\u00e9 demand\u00e9e est celle cr\u00e9\u00e9e ligne 11. Elle est effectivement unique\u00a0: un attribut de classe est unique pour toutes les instances de la classe\u00a0;</li> <li>au temps T1, un thread Thread1 obtient la cl\u00e9. Il peut alors ex\u00e9cuter la ligne 33\u00a0;</li> <li>au temps T2, le thread Thread1 est mis en pause avant m\u00eame d\u2019avoir termin\u00e9 l\u2019\u00e9criture du log\u00a0;</li> <li>au temps T3, le thread Thread2 qui a obtenu le processeur doit lui aussi \u00e9crire un log. Il arrive ainsi \u00e0 la ligne 30 o\u00f9 il demande la cl\u00e9 de la porte d\u2019entr\u00e9e. On lui r\u00e9pond qu\u2019un autre thread l\u2019a d\u00e9j\u00e0. Il est alors automatiquement mis en pause. Il en sera ainsi de tous les threads qui demanderont cette cl\u00e9\u00a0;</li> <li>au temps T4, le thread Thread1 qui avait \u00e9t\u00e9 mis en pause retrouve le processeur. Il termine alors l\u2019\u00e9criture du log\u00a0;</li> <li>lignes 32-36\u00a0: l\u2019\u00e9criture dans le fichier de logs se fait en deux temps\u00a0:</li> <li>ligne 33\u00a0: le descripteur de fichier obtenu ligne 17 travaille avec un buffer. L\u2019op\u00e9ration [write] de la ligne 33 \u00e9crit dans ce buffer mais pas directement dans le fichier. Le buffer est ensuite vid\u00e9 dans le fichier dans certaines conditions\u00a0:</li> <li>le buffer est plein\u00a0;</li> <li>le descripteur de fichier subit une op\u00e9ration [close] ou [flush]\u00a0;</li> <li>ligne 36\u00a0: on force l\u2019\u00e9criture de la ligne de log dans le fichier. On fait cela parce qu\u2019on veut voir s\u2019intercaler entre eux les logs des diff\u00e9rents threads. Si on ne fait pas \u00e7a, les logs d\u2019un thread seront tous \u00e9crits en m\u00eame temps lors de la fermeture du descripteur, ligne 45. Il serait alors beaucoup plus difficile de voir que certains threads ont \u00e9t\u00e9 arr\u00eat\u00e9s\u00a0: il faudrait regarder les heures dans les logs\u00a0;</li> <li>ligne 39\u00a0: le thread Thread1 rend la cl\u00e9 qu\u2019on lui avait donn\u00e9e. Elle va pouvoir \u00eatre donn\u00e9e \u00e0 un autre thread\u00a0;</li> <li>ligne 22\u00a0: la m\u00e9thode [write] est donc synchronis\u00e9e\u00a0: un seul thread \u00e0 la fois \u00e9crit dans le fichier de logs. La cl\u00e9 du dispositif est la ligne 30\u00a0: quoiqu\u2019il arrive, seul un thread r\u00e9cup\u00e8re la cl\u00e9 de passage \u00e0 la ligne suivante. Il la garde tant qu\u2019il ne la rend pas (ligne 39)\u00a0;</li> <li>lignes 41-45\u00a0: la m\u00e9thode [close] permet de lib\u00e9rer les ressources allou\u00e9es au descripteur du fichier de logs\u00a0; Les logs \u00e9crits dans le fichier de logs auront l\u2019allure suivante\u00a0:</li> </ul> <pre><code>2020-07-22 20:03:52.992152, Thread-2 : \u2026\n</code></pre>"},{"location":"exercice-dapplication-version-7.html#2422-la-classe-sendadminmail","title":"24.2.2. La classe [SendAdminMail]","text":"<p>La classe [SendAminMail] permet d\u2019envoyer un message \u00e0 l\u2019administrateur de l\u2019application lorsque celle-ci \u2018plante\u2019.</p> <p></p> <p>La classe [SendAdminMail] est configur\u00e9e dans le script [config] [2] de la fa\u00e7on suivante\u00a0:</p> <pre><code>        # config serveur SMTP\n        \"adminMail\": {\n            # serveur SMTP\n            \"smtp-server\": \"localhost\",\n            # port du serveur SMTP\n            \"smtp-port\": \"25\",\n            # administrateur\n            \"from\": \"guest@localhost.com\",\n            \"to\": \"guest@localhost.com\",\n            # sujet du mail\n            \"subject\": \"plantage du serveur de calcul d'imp\u00f4ts\",\n            # tls \u00e0 True si le serveur SMTP requiert une autorisation, \u00e0 False sinon\n            \"tls\": False\n        }\n</code></pre> <p>La classe [SendAminMail] re\u00e7oit le dictionnaire des lignes 2-13 ainsi que la configuration de l\u2019envoi du mail. La classe est la suivante\u00a0:</p> <pre><code># imports\nimport smtplib\nfrom email.mime.text import MIMEText\nfrom email.utils import formatdate\n\n\nclass SendAdminMail:\n\n    # -----------------------------------------------------------------------\n    @staticmethod\n    def send(config: dict, message: str, verbose: bool = False):\n        # envoie message au serveur smtp config['smtp-server'] sur le port config[smtp-port]\n        # si config['tls'] est vrai, le support TLS sera utilis\u00e9\n        # le mail est envoy\u00e9 de la part de config['from']\n        # pour le destinataire config['to']\n        # le message a le sujet config['subject']\n        # on trouve la r\u00e9f\u00e9rence d'un logueur dans config['logger']\n\n        # on r\u00e9cup\u00e8re le logueur dans la config - peut \u00eatre \u00e9gal \u00e0 None\n        logger = config[\"logger\"]\n        # serveur SMTP\n        server = None\n        # on envoie le message\n        try:\n            # le serveur SMTP\n            server = smtplib.SMTP(config[\"smtp-server\"])\n            # mode verbose\n            server.set_debuglevel(verbose)\n            # connexion s\u00e9curis\u00e9e ?\n            if config['tls']:\n                # d\u00e9but dialogue de s\u00e9curisation\n                server.starttls()\n                # authentification\n                server.login(config[\"user\"], config[\"password\"])\n            # construction d'un message Multipart - c'est ce message qui sera envoy\u00e9\n            msg = MIMEText(message)\n            msg['From'] = config[\"from\"]\n            msg['To'] = config[\"to\"]\n            msg['Date'] = formatdate(localtime=True)\n            msg['Subject'] = config[\"subject\"]\n            # on envoie le message\n            server.send_message(msg)\n            # log - le logger peut ne pas exister\n            if logger:\n                logger.write(f\"[SendAdminMail] Message envoy\u00e9 \u00e0 [{config['to']}] : [{message}]\\n\")\n        except BaseException as erreur:\n            # log- le logger peutne pas exister\n            if logger:\n                logger.write(\n                    f\"[SendAdminMail] Erreur [{erreur}] lors de l'envoi \u00e0 [{config['to']}] du message [{message}] : \\n\")\n        finally:\n            # on a fini - on lib\u00e8re les ressources mobilis\u00e9es par la fonction\n            if server:\n                server.quit()\n</code></pre> <ul> <li>lignes 24-54\u00a0: on retrouve le code d\u00e9j\u00e0 \u00e9tudi\u00e9 dans l\u2019exemple |smtp/02|\u00a0;</li> <li>ligne 20\u00a0: on r\u00e9cup\u00e8re la r\u00e9f\u00e9rence d\u2019un logueur. Celui-ci est utilis\u00e9 aux lignes 45 et 49\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-7.html#243-le-serveur-web","title":"24.3. Le serveur web","text":""},{"location":"exercice-dapplication-version-7.html#2431-configuration","title":"24.3.1. Configuration","text":"<p>La configuration du serveur est tr\u00e8s semblable \u00e0 celle du serveur \u00e9tudi\u00e9 pr\u00e9c\u00e9demment. Seul le fichier [config.py] \u00e9volue l\u00e9g\u00e8rement\u00a0:</p> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a01\u00a0------\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0de\u00a0ce\u00a0fichier\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0racine\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020\"\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\u00a0absolues\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossiers\u00a0du\u00a0projet\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0BaseEntity,\u00a0MyException\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/classes/02/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0InterfaceImp\u00f4tsDao,\u00a0InterfaceImp\u00f4tsM\u00e9tier,\u00a0InterfaceImp\u00f4tsUi\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AbstractImp\u00f4tsdao,\u00a0Imp\u00f4tsConsole,\u00a0Imp\u00f4tsM\u00e9tier\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ImpotsDaoWithAdminDataInDatabase\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AdminData,\u00a0Imp\u00f4tsError,\u00a0TaxPayer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Constantes,\u00a0tranches\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0IndexController\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/http-servers/01/controllers\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0scripts\u00a0[config_database,\u00a0config_layers]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0script_dir,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Logger,\u00a0SendAdminMail\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../utilities\",\n\u00a0\u00a0\u00a0\u00a0]\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fixe\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a02\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0config.update({\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0utilisateurs\u00a0autoris\u00e9s\u00a0\u00e0\u00a0utiliser\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"users\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"login\":\u00a0\"admin\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"admin\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0de\u00a0logs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"logsFilename\":\u00a0f\"{script_dir}/../data/logs/logs.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0config\u00a0serveur\u00a0SMTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"adminMail\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0serveur\u00a0SMTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"smtp-server\":\u00a0\"localhost\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0port\u00a0du\u00a0serveur\u00a0SMTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"smtp-port\":\u00a0\"25\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0administrateur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"from\":\u00a0\"guest@localhost.com\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"to\":\u00a0\"guest@localhost.com\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0sujet\u00a0du\u00a0mail\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"subject\":\u00a0\"plantage\u00a0du\u00a0serveur\u00a0de\u00a0calcul\u00a0d'imp\u00f4ts\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0tls\u00a0\u00e0\u00a0True\u00a0si\u00a0le\u00a0serveur\u00a0SMTP\u00a0requiert\u00a0une\u00a0autorisation,\u00a0\u00e0\u00a0False\u00a0sinon\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"tls\":\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dur\u00e9e\u00a0pause\u00a0thread\u00a0en\u00a0secondes\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"sleep_time\":\u00a00\n\u00a0\u00a0\u00a0\u00a0})\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a03\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0base\u00a0de\u00a0donn\u00e9es\n\u00a0\u00a0\u00a0\u00a0import\u00a0config_database\n\u00a0\u00a0\u00a0\u00a0config[\"database\"]\u00a0=\u00a0config_database.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a04\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0import\u00a0config_layers\n\u00a0\u00a0\u00a0\u00a0config['layers']\u00a0=\u00a0config_layers.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <ul> <li>lignes 40-66\u00a0: on ajoute dans le dictionnaire de configuration du serveur, les \u00e9l\u00e9ments concernant le logueur (ligne 49) et celles concernant l\u2019envoi d\u2019un mail d\u2019alerte \u00e0 l\u2019administrateur de l\u2019application (lignes 51-63)\u00a0;</li> <li>ligne 65\u00a0: pour mieux voir les threads en action on va imposer \u00e0 certains de s\u2019arr\u00eater. [sleep_time] est la dur\u00e9e de l\u2019arr\u00eat exprim\u00e9e en secondes\u00a0;</li> <li>lignes 27-28\u00a0: on notera qu\u2019on utilise le contr\u00f4leur [index_controller] de la version 6 pr\u00e9c\u00e9dente\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-7.html#2432-le-script-principal-main","title":"24.3.2. Le script principal [main]","text":"<p>Le script principal [main] est le suivant\u00a0:</p> <pre><code># on attend un param\u00e8tre mysql ou pgres\nimport sys\nsyntaxe = f\"{sys.argv[0]} mysql / pgres\"\nerreur = len(sys.argv) != 2\nif not erreur:\n    sgbd = sys.argv[1].lower()\n    erreur = sgbd != \"mysql\" and sgbd != \"pgres\"\nif erreur:\n    print(f\"syntaxe : {syntaxe}\")\n    sys.exit()\n\n# on configure l'application\nimport config\nconfig = config.configure({'sgbd': sgbd})\n\n# d\u00e9pendances\nfrom flask import request, Flask\nfrom flask_httpauth import HTTPBasicAuth\nimport json\nimport index_controller\nfrom flask_api import status\nfrom SendAdminMail import SendAdminMail\nfrom myutils import json_response\nfrom Logger import Logger\nimport threading\nimport time\nfrom random import randint\nfrom Imp\u00f4tsError import Imp\u00f4tsError\n\n# gestionnaire d'authentification\nauth = HTTPBasicAuth()\n\n\n@auth.verify_password\ndef verify_password(login, password):\n    # liste des utilisateurs\n    users = config['users']\n    # on parcourt cette liste\n    for user in users:\n        if user['login'] == login and user['password'] == password:\n            return True\n    # on n'a pas trouv\u00e9\n    return False\n\n\n# envoi d'un mail \u00e0 l'administrateur\ndef send_adminmail(config: dict, message: str):\n    # on envoie un mail \u00e0 l'administrateur de l'application\n    config_mail = config[\"adminMail\"]\n    config_mail[\"logger\"] = config['logger']\n    SendAdminMail.send(config_mail, message)\n\n\n# v\u00e9rification du fichier de logs\nlogger = None\nerreur = False\nmessage_erreur = None\ntry:\n    # logueur\n    logger = Logger(config[\"logsFilename\"])\nexcept BaseException as exception:\n    # log console\n    print(f\"L'erreur suivante s'est produite : {exception}\")\n    # on note l'erreur\n    erreur = True\n    message_erreur = f\"{exception}\"\n# on m\u00e9morise le logueur dans la config\nconfig['logger'] = logger\n# gestion de l'erreur\nif erreur:\n    # mail \u00e0 l'administrateur\n    send_adminmail(config, message_erreur)\n    # fin de l'application\n    sys.exit(1)\n\n# log de d\u00e9marrage\nlog = \"[serveur] d\u00e9marrage du serveur\"\nlogger.write(f\"{log}\\n\")\nprint(log)\n\n# r\u00e9cup\u00e9ration des donn\u00e9es de l'administration fiscale\nerreur = False\ntry:\n    # admindata sera une donn\u00e9e de port\u00e9e application en lecture seule\n    config[\"admindata\"] = config[\"layers\"][\"dao\"].get_admindata()\n    # log de r\u00e9ussite\n    logger.write(\"[serveur] connexion \u00e0 la base de donn\u00e9es r\u00e9ussie\\n\")\nexcept Imp\u00f4tsError as ex:\n    # on note l'erreur\n    erreur = True\n    # log d'erreur\n    log = f\"L'erreur suivante s'est produite : {ex}\"\n    # console\n    print(log)\n    # fichier de logs\n    logger.write(f\"{log}\\n\")\n    # mail \u00e0 l'administrateur\n    send_adminmail(config, log)\n\n# le thread principal n'a plus besoin du logger\nlogger.close()\n\n# s'il y a eu erreur on s'arr\u00eate\nif erreur:\n    sys.exit(2)\n\n# l'application Flask peut d\u00e9marrer\napp = Flask(__name__)\n\n\n# Home URL\n@app.route('/', methods=['GET'])\n@auth.login_required\ndef index():\n    \u2026\n\n\n# main uniquement\nif __name__ == '__main__':\n    # on lance le serveur\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run(threaded=True)\n</code></pre> <ul> <li>lignes 1-10\u00a0: le script attend un param\u00e8tre [mysql / pgres] qui lui indique le SGBD \u00e0 utiliser\u00a0;</li> <li>lignes 12-14\u00a0: l\u2019application est configur\u00e9e (Python Path, couches, base de donn\u00e9es)\u00a0;</li> <li>lignes 16-28\u00a0: les d\u00e9pendances n\u00e9cessaires \u00e0 l\u2019application\u00a0;</li> <li>lignes 30-43\u00a0: gestion de l\u2019authentification\u00a0;</li> <li>lignes 46-51\u00a0: une fonction qui envoie un mail \u00e0 l\u2019administrateur de l\u2019application\u00a0;</li> <li>la fonction attend deux param\u00e8tres\u00a0:</li> <li>config\u00a0: un dictionnaire ayant les cl\u00e9s [adminMail] et [logger]\u00a0;</li> <li>le message \u00e0 envoyer\u00a0;</li> <li>lignes 49-50\u00a0: on pr\u00e9pare la configuration de l\u2019envoi\u00a0;</li> <li>on envoie le mail\u00a0;</li> <li>lignes 54-74\u00a0: on v\u00e9rifie la pr\u00e9sence du fichier de logs\u00a0;</li> <li>ligne 70-74\u00a0: si on n\u2019a pas r\u00e9ussi \u00e0 ouvrir le fichier de logs, on envoie un mail \u00e0 l\u2019administrateur et on s\u2019arr\u00eate\u00a0;</li> <li>lignes 76-79\u00a0: on logue le d\u00e9marrage du serveur\u00a0;</li> <li>lignes 81-98\u00a0: on va chercher les donn\u00e9es de l\u2019administration fiscale en base de donn\u00e9es\u00a0;</li> <li>lignes 88-98\u00a0: si on n\u2019a pas r\u00e9ussi \u00e0 obtenir ces donn\u00e9es, on logue l\u2019erreur aussi bien sur la console que dans le fichier de logs\u00a0;</li> <li>lignes 100-101\u00a0: le thread principal ne fera plus de logs (les threads cr\u00e9\u00e9s n\u2019utiliseront pas le m\u00eame descripteur de fichier)\u00a0;</li> <li>lignes 103-105\u00a0: si on n\u2019a pas pu se connecter \u00e0 la base de donn\u00e9es, on s\u2019arr\u00eate\u00a0;</li> <li>ligne 122\u00a0: on lance le serveur en mode multithread\u00e9\u00a0; La fonction [index] (ligne 114) est la suivante\u00a0:</li> </ul> <pre><code># Home URL\n@app.route('/', methods=['GET'])\n@auth.login_required\ndef index():\n    logger = None\n    try:\n        # logger\n        logger = Logger(config[\"logsFilename\"])\n        # on le m\u00e9morise dans une config associ\u00e9e au thread\n        thread_config = {\"logger\": logger}\n        thread_name = threading.current_thread().name\n        config[thread_name] = {\"config\": thread_config}\n        # on logue la requ\u00eate\n        logger.write(f\"[index] requ\u00eate : {request}\\n\")\n        # on interrompt le thread si cela a \u00e9t\u00e9 demand\u00e9\n        sleep_time = config[\"sleep_time\"]\n        if sleep_time != 0:\n            # la pause est al\u00e9atoire pour que certains threads soient interrompus et d'autres pas\n            al\u00e9a = randint(0, 1)\n            if al\u00e9a == 1:\n                # log avant pause\n                logger.write(f\"[index] mis en pause du thread pendant {sleep_time} seconde(s)\\n\")\n                # pause\n                time.sleep(sleep_time)\n        # on fait ex\u00e9cuter la requ\u00eate par un contr\u00f4leur\n        r\u00e9sultat, status_code = index_controller.execute(request, config)\n        # y-a-t-il eu une erreur fatale ?\n        if status_code == status.HTTP_500_INTERNAL_SERVER_ERROR:\n            # on envoie un mail \u00e0 l'administrateur de l'application\n            config_mail = config[\"adminMail\"]\n            config_mail[\"logger\"] = logger\n            SendAdminMail.send(config_mail, json.dumps(r\u00e9sultat, ensure_ascii=False))\n        # on logue la r\u00e9ponse\n        logger.write(f\"[index] {r\u00e9sultat}\\n\")\n        # on envoie la r\u00e9ponse\n        return json_response(r\u00e9sultat, status_code)\n    except BaseException as erreur:\n        # on logue l'erreur si c'est possible\n        if logger:\n            logger.write(f\"[index] {erreur}\")\n        # on pr\u00e9pare la r\u00e9ponse au client\n        r\u00e9sultat = {\"r\u00e9ponse\": {\"erreurs\": [f\"{erreur}\"]}}\n        # on envoie la r\u00e9ponse\n        return json_response(r\u00e9sultat, status.HTTP_500_INTERNAL_SERVER_ERROR)\n    finally:\n        # on ferme le fichier de logs s'il a \u00e9t\u00e9 ouvert\n        if logger:\n            logger.close()\n</code></pre> <ul> <li>ligne 4\u00a0: la fonction ex\u00e9cut\u00e9e lorsqu\u2019un utilisateur demande l\u2019URL /. Parce que le serveur est multi-thread\u00e9 (ligne 112), un thread va \u00eatre cr\u00e9\u00e9 pour ex\u00e9cuter la fonction. Ce thread peut \u00e0 tout moment \u00eatre interrompu et mis en pause pour reprendre son ex\u00e9cution un peu plus tard. Il faut toujours se souvenir de ce point lorsque le code acc\u00e8de \u00e0 une ressource partag\u00e9e par tous les threads. Une telle ressource est ici le fichier de logs\u00a0: tous les threads \u00e9crivent dedans\u00a0;</li> <li>ligne 8\u00a0: on cr\u00e9e une instance de logueur. Donc tous les threads auront une instance diff\u00e9rence du logueur. N\u00e9anmoins tous ces logueurs pointent sur le m\u00eame fichier de logs. Il est quand m\u00eame important de noter que lorsqu\u2019un thread ferme son logueur, cela n\u2019a pas d\u2019incidence sur les logueurs des autres threads\u00a0;</li> <li>lignes 9-12\u00a0: on m\u00e9morise le logueur dans le dictionnaire [config] de l\u2019application associ\u00e9 \u00e0 une cl\u00e9 portant le nom du thread. Ainsi s\u2019il y a n threads ex\u00e9cut\u00e9s simultan\u00e9ment, on aura la cr\u00e9ation de n entr\u00e9es dans le dictionnaire [config]. [config] est une ressource partag\u00e9e entre tous les threads. Il peut donc y avoir un besoin de synchronisation. J\u2019ai fait ici une hypoth\u00e8se. J\u2019ai suppos\u00e9 que si deux threads cr\u00e9aient simultan\u00e9ment leur entr\u00e9e dans le fichier [config] et que l\u2019un d\u2019eux \u00e9tait interrompu par l\u2019autre, cela n\u2019avait pas d\u2019incidence. Celui interrompu pouvait ult\u00e9rieurement terminer la cr\u00e9ation de l\u2019entr\u00e9e. Si l\u2019exp\u00e9rience montrait que cette hypoth\u00e8se \u00e9tait fausse, il faudrait synchroniser l\u2019acc\u00e8s \u00e0 la ligne 12\u00a0;</li> <li>ligne 10\u00a0: on met le logueur dans un dictionnaire\u00a0;</li> <li>ligne 11\u00a0: [threading.current_thread()] est le thread qui ex\u00e9cute cette ligne, donc le thread qui ex\u00e9cute la fonction [index]. On note son nom. Chaque thread a un nom unique\u00a0;</li> <li>ligne 12\u00a0: on m\u00e9morise la configuration du thread. A partir de maintenant, nous proc\u00e8derons toujours ainsi\u00a0: s\u2019il y a des informations qui ne peuvent \u00eatre partag\u00e9es entre les threads, elles seront mises quand m\u00eame dans la configuration g\u00e9n\u00e9rale, mais associ\u00e9es au nom du thread\u00a0;</li> <li>ligne 14\u00a0: on logue la requ\u00eate qu\u2019on est en train d\u2019ex\u00e9cuter\u00a0;</li> <li>lignes 15-24\u00a0: de fa\u00e7on al\u00e9atoire on met certains threads en pause afin qu\u2019ils laissent le processeur \u00e0 un autre thread\u00a0;</li> <li>ligne 16\u00a0: on r\u00e9cup\u00e8re la dur\u00e9e de la pause (en secondes) dans la configuration\u00a0;</li> <li>ligne 17\u00a0: il n\u2019y a pause que si la dur\u00e9e de pause est diff\u00e9rente de 0\u00a0;</li> <li>ligne 19\u00a0: un nombre entier al\u00e9atoire dans l\u2019intervalle [0, 1]. Donc seules les valeurs 0 et 1 sont possibles\u00a0;</li> <li>ligne 20\u00a0: la pause du thread ne se fait que si le nombre al\u00e9atoire est 1\u00a0;</li> <li>ligne 22\u00a0: on logue le fait que le thread va \u00eatre interrompu\u00a0;</li> <li>ligne 24\u00a0: on interrompt le thread pendant [sleep_time] secondes\u00a0;</li> <li>ligne 26\u00a0: lorsque le thread se r\u00e9veille, il fait ex\u00e9cuter la requ\u00eate par le module [index_controller]\u00a0;</li> <li>lignes 28-32\u00a0: si cette ex\u00e9cution provoque une erreur de type [500 INTERNAL SERVER ERROR], on envoie un mail \u00e0 l\u2019administrateur\u00a0;</li> <li>lignes 30-31\u00a0: on configure le dictionnaire [config_mail] qu\u2019on va passer \u00e0 la classe [SendAdminMail]\u00a0;</li> <li>ligne 32\u00a0: le message envoy\u00e9 \u00e0 l\u2019administrateur est la cha\u00eene jSON du r\u00e9sultat qui va \u00eatre envoy\u00e9 au client\u00a0;</li> <li>lignes 33-34\u00a0: on logue la r\u00e9ponse qu\u2019on va envoyer au client (ligne 36)\u00a0;</li> <li>lignes 37-44\u00a0: traitement d\u2019une \u00e9ventuelle exception\u00a0;</li> <li>lignes 39-40\u00a0: si le logueur existe on logue l\u2019erreur qui s\u2019est produite\u00a0;</li> <li>lignes 47-48\u00a0: on ferme le logueur s\u2019il existe. Au final, le thread cr\u00e9e un logueur au d\u00e9but de la requ\u00eate et le ferme lorsque celle-ci a \u00e9t\u00e9 trait\u00e9e\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-7.html#2433-le-controleur-index_controller","title":"24.3.3. Le contr\u00f4leur [index_controller]","text":"<p>Le contr\u00f4leur [index_controller] qui ex\u00e9cute les requ\u00eates est celui de la version pr\u00e9c\u00e9dente\u00a0:</p> <p></p>"},{"location":"exercice-dapplication-version-7.html#2434-execution","title":"24.3.4. Ex\u00e9cution","text":"<p>On lance le serveur Flask, le serveur de mails |hMailServer| ainsi que le lecteur de courrier |Thunderbird|. On ne lance pas le SGBD. Le serveur s\u2019arr\u00eate avec les logs console suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots/http-servers/02/flask/main.py mysql\n[serveur] d\u00e9marrage du serveur\nL'erreur suivante s'est produite : MyException[27, (mysql.connector.errors.InterfaceError) 2003: Can't connect to MySQL server on 'localhost:3306' (10061 Aucune connexion n\u2019a pu \u00eatre \u00e9tablie car l\u2019ordinateur cible l\u2019a express\u00e9ment refus\u00e9e)\n(Background on this error at: http://sqlalche.me/e/13/rvf5)]\n\nProcess finished with exit code 2 \n</code></pre> <p>Le fichier de logs [logs.txt] est lui le suivant\u00a0:</p> <pre><code>2020-07-23 11:51:38.324752, MainThread : [serveur] d\u00e9marrage du serveur\n2020-07-23 11:51:40.355510, MainThread : L'erreur suivante s'est produite : MyException[27, (mysql.connector.errors.InterfaceError) 2003: Can't connect to MySQL server on 'localhost:3306' (10061 Aucune connexion n\u2019a pu \u00eatre \u00e9tablie car l\u2019ordinateur cible l\u2019a express\u00e9ment refus\u00e9e)\n(Background on this error at: http://sqlalche.me/e/13/rvf5)]\n2020-07-23 11:51:42.464206, MainThread : [SendAdminMail] Message envoy\u00e9 \u00e0 [guest@localhost.com] : [L'erreur suivante s'est produite : MyException[27, (mysql.connector.errors.InterfaceError) 2003: Can't connect to MySQL server on 'localhost:3306' (10061 Aucune connexion n\u2019a pu \u00eatre \u00e9tablie car l\u2019ordinateur cible l\u2019a express\u00e9ment refus\u00e9e)\n(Background on this error at: http://sqlalche.me/e/13/rvf5)]]\n</code></pre> <p>Avec Thunderbird, on v\u00e9rifie les mails de l\u2019administrateur [guest@localhost.com]\u00a0:</p> <p></p> <p>Puis on lance le SGBD et on demande l\u2019URL [http://127.0.0.1:5000/?mari%C3%A9=oui&amp;enfants=3&amp;salaire=200000]. Les logs deviennent les suivants\u00a0:</p> <pre><code>2020-07-23 11:56:38.891753, MainThread : [serveur] d\u00e9marrage du serveur\n2020-07-23 11:56:38.987999, MainThread : [serveur] connexion \u00e0 la base de donn\u00e9es r\u00e9ussie\n2020-07-23 11:56:40.586747, MainThread : [serveur] d\u00e9marrage du serveur\n2020-07-23 11:56:40.655254, MainThread : [serveur] connexion \u00e0 la base de donn\u00e9es r\u00e9ussie\n2020-07-23 11:56:54.528360, Thread-2 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=3&amp;salaire=200000' [GET]&gt;\n2020-07-23 11:56:54.530653, Thread-2 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 200000, 'imp\u00f4t': 42842, 'surc\u00f4te': 17283, 'taux': 0.41, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n</code></pre> <ul> <li>lignes 1-4\u00a0: on rappelle qu\u2019il y a deux d\u00e9marrages du serveur parce que le mode [Debug=True] provoque un second d\u00e9marrage\u00a0;</li> <li>lignes 5-6\u00a0: les logs nous donnent une id\u00e9e du temps d\u2019ex\u00e9cution d\u2019une requ\u00eate, ici 2,293 millisecondes\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-7.html#244-le-client-web","title":"24.4. Le client web","text":"<p>Le dossier [http-clients/02] est obtenu par recopie du dossier [http-clients/01]. On proc\u00e8de ensuite \u00e0 quelques modifications.</p>"},{"location":"exercice-dapplication-version-7.html#2441-la-configuration","title":"24.4.1. La configuration","text":"<p>La configuration [config] de l\u2019application [http-clients/02] est le m\u00eame que celle de l\u2019application [http-clients/01] \u00e0 quelques d\u00e9tails pr\u00e8s\u00a0:</p> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a01\u00a0------\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0de\u00a0ce\u00a0fichier\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0racine\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020\"\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\u00a0absolues\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossiers\u00a0du\u00a0projet\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0BaseEntity,\u00a0MyException\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/classes/02/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0InterfaceImp\u00f4tsDao,\u00a0InterfaceImp\u00f4tsM\u00e9tier,\u00a0InterfaceImp\u00f4tsUi\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AbstractImp\u00f4tsdao,\u00a0Imp\u00f4tsConsole,\u00a0Imp\u00f4tsM\u00e9tier\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0ImpotsDaoWithAdminDataInDatabase\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AdminData,\u00a0Imp\u00f4tsError,\u00a0TaxPayer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Constantes,\u00a0tranches\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v05/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Imp\u00f4tsDaoWithHttpClient\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0scripts\u00a0de\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0script_dir,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0Logger\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/http-servers/02/utilities\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fixe\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a02\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\u00a0avec\u00a0des\u00a0constantes\n\u00a0\u00a0\u00a0\u00a0config.update({\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0des\u00a0contribuables\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"taxpayersFilename\":\u00a0f\"{script_dir}/../data/input/taxpayersdata.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0des\u00a0r\u00e9sultats\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"resultsFilename\":\u00a0f\"{script_dir}/../data/output/r\u00e9sultats.json\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0des\u00a0erreurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"errorsFilename\":\u00a0f\"{script_dir}/../data/output/errors.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fichier\u00a0de\u00a0logs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"logsFilename\":\u00a0f\"{script_dir}/../data/logs/logs.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0serveur\u00a0de\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"server\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"urlServer\":\u00a0\"http://127.0.0.1:5000/\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"authBasic\":\u00a0True,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"user\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"login\":\u00a0\"admin\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"password\":\u00a0\"admin\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0mode\u00a0debug\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"debug\":\u00a0True\n\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a03\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\n\u00a0\u00a0\u00a0\u00a0import\u00a0config_layers\n\u00a0\u00a0\u00a0\u00a0config['layers']\u00a0=\u00a0config_layers.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuation\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <ul> <li>lignes 31-32\u00a0: on va utiliser le m\u00eame logueur |Logger| que celui utilis\u00e9 pour le serveur\u00a0;</li> <li>ligne 49\u00a0: le chemin absolu du fichier de logs\u00a0;</li> <li>ligne 60\u00a0: le mode [debug=True] sert \u00e0 \u00e9crire les r\u00e9ponses du serveur web dans le fichier de logs\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-7.html#2442-la-couche-dao","title":"24.4.2. La couche [dao]","text":"<p>Le code de la classe [Imp\u00f4tsDaoWithHttpClient] \u00e9volue l\u00e9g\u00e8rement\u00a0:</p> <pre><code># imports\n\nimport requests\nfrom flask_api import status\n\n\u2026\n\n\nclass Imp\u00f4tsDaoWithHttpClient(AbstractImp\u00f4tsDao, InterfaceImp\u00f4tsM\u00e9tier):\n\n    # constructeur\n    def __init__(self, config: dict):\n        # initialisation parent\n        AbstractImp\u00f4tsDao.__init__(self, config)\n        # m\u00e9morisation \u00e9l\u00e9ments de la configuration\n        # config g\u00e9n\u00e9rale\n        self.__config = config\n        # serveur\n        self.__config_server = config[\"server\"]\n        # mode debug\n        self.__debug = config[\"debug\"]\n        # logger\n        self.__logger = None\n\n    # m\u00e9thode inutilis\u00e9e\n    def get_admindata(self) -&gt; AdminData:\n        pass\n\n    # calcul de l'imp\u00f4t\n    def calculate_tax(self, taxpayer: TaxPayer, admindata: AdminData = None):\n        # on laisse remonter les exceptions\n        \u2026\n        # mode debug ?\n        if self.__debug:\n            # logueur\n            if not self.__logger:\n                self.__logger = self.__config['logger']\n            # on logue\n            self.__logger.write(f\"{response.text}\\n\")\n        # code de statut de la r\u00e9ponse HTTP\n        status_code = response.status_code\n        \u2026\n</code></pre> <ul> <li>lignes 17\u00a0: on m\u00e9morise la configuration g\u00e9n\u00e9rale. On verra ult\u00e9rieurement que lorsque le constructeur de la classe [Imp\u00f4tsDaoWithHttpClient] s\u2019ex\u00e9cute, le dictionnaire [config] ne contient pas encore la cl\u00e9 [logger] utilis\u00e9e ligne 37. C\u2019est pour cette raison qu\u2019on ne peut pas initialiser [self.__logger] (ligne 23) dans le constructeur\u00a0;</li> <li>ligne 21\u00a0: on a ajout\u00e9 dans la configuration une cl\u00e9 [debug] qui contr\u00f4le le log des lignes 33-39\u00a0;</li> <li>ligne 34\u00a0: si on est en mode [debug]\u00a0;</li> <li>lignes 36-37\u00a0: initialisation \u00e9ventuelle de la propri\u00e9t\u00e9 [self.__logger]. Lorsque la m\u00e9thode [calculate_tax] est utilis\u00e9e, la cl\u00e9 [logger] fait partie du dictionnaire [config]\u00a0;</li> <li>ligne 39\u00a0: on logue le document texte associ\u00e9 \u00e0 la r\u00e9ponse HTTP du serveur\u00a0; La couche [dao] va \u00eatre ex\u00e9cut\u00e9e simultan\u00e9ment par plusieurs threads. Or ici on cr\u00e9e un unique exemplaire de cette couche (cf. config_layers). Il faut donc v\u00e9rifier que le code n\u2019implique pas l\u2019acc\u00e8s en \u00e9criture \u00e0 des donn\u00e9es partag\u00e9es, typiquement les propri\u00e9t\u00e9s de la classe [Imp\u00f4tsDaoWithHttpClient] qui impl\u00e9mente la couche [dao]. Or ci-dessus la ligne 37 modifie une propri\u00e9t\u00e9 de l\u2019instance de classe. Ici \u00e7a ne porte pas \u00e0 cons\u00e9quence car tous les threads partagent le m\u00eame logueur. Si cela n\u2019avait pas \u00e9t\u00e9 le cas, l\u2019acc\u00e8s \u00e0 la ligne 37 aurait du \u00eatre synchronis\u00e9.</li> </ul>"},{"location":"exercice-dapplication-version-7.html#2443-le-script-principal","title":"24.4.3. Le script principal","text":"<p>Le script principal [main] \u00e9volue de la fa\u00e7on suivante\u00a0:</p> <pre><code># on configure l'application\n\nimport config\nconfig = config.configure({})\n\n# d\u00e9pendances\nfrom Imp\u00f4tsError import Imp\u00f4tsError\nimport random\nimport sys\nimport threading\nfrom Logger import Logger\n\n\n# ex\u00e9cution de la couche [dao] dans un thread\n# taxpayers est une liste de contribuables\ndef thread_function(dao, logger, taxpayers: list):\n    \u2026\n\n\n# liste des threads du client\nthreads = []\nlogger = None\n# code\ntry:\n    # logger\n    logger = Logger(config[\"logsFilename\"])\n    # on le m\u00e9morise dans la config\n    config[\"logger\"] = logger\n    # on r\u00e9cup\u00e8re la couche [dao]\n    dao = config[\"layers\"][\"dao\"]\n    # lecture des donn\u00e9es des contribuables\n    taxpayers = dao.get_taxpayers_data()[\"taxpayers\"]\n    # des contribuables ?\n    if not taxpayers:\n        raise Imp\u00f4tsError(36, f\"Pas de contribuables valides dans le fichier {config['taxpayersFilename']}\")\n    # calcul de l'imp\u00f4t des contribuables avec plusieurs threads\n    i = 0\n    l_taxpayers = len(taxpayers)\n    while i &lt; len(taxpayers):\n        # chaque thread va traiter de 1 \u00e0 4 contribuables\n        nb_taxpayers = min(l_taxpayers - i, random.randint(1, 4))\n        # la liste des contribuables trait\u00e9s par le thread\n        thread_taxpayers = taxpayers[slice(i, i + nb_taxpayers)]\n        # on incr\u00e9mente i pour le thread suivant\n        i += nb_taxpayers\n        # on cr\u00e9e le thread\n        thread = threading.Thread(target=thread_function, args=(dao, logger, thread_taxpayers))\n        # on l'ajoute \u00e0 la liste des threads du script principal\n        threads.append(thread)\n        # on lance le thread - cette op\u00e9ration est asynchrone - on n'attend pas le r\u00e9sultat du thread\n        thread.start()\n    # le thread principal attend la fin de tous les threads qu'il a lanc\u00e9s\n    for thread in threads:\n        thread.join()\n    # ici tous les threads ont fini leur travail - chacun a modifi\u00e9 un ou plusieurs objets [taxpayer]\n    # on enregistre les r\u00e9sultats dans le fichier jSON\n    dao.write_taxpayers_results(taxpayers)\nexcept BaseException as erreur:\n    # affichage de l'erreur\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\nfinally:\n    # on ferme le logueur\n    if logger:\n        logger.close()\n    # on a fini\n    print(\"Travail termin\u00e9...\")\n    # fin des threads qui pourraient encore exister si on s'est arr\u00eat\u00e9 sur erreur\n    sys.exit()\n</code></pre> <ul> <li>le script principal se distingue de celui du client pr\u00e9c\u00e9dent par le fait qu\u2019il va g\u00e9n\u00e9rer plusieurs threads d\u2019ex\u00e9cution pour effectuer les requ\u00eates au serveur. Le client de la version 6 faisait toutes ses requ\u00eates s\u00e9quentiellement. La requ\u00eate n\u00b0 i n\u2019\u00e9tait faite qu\u2019une fois la r\u00e9ponse \u00e0 la requ\u00eate n\u00b0 [i-1] re\u00e7ue. Ici on veut voir comment le serveur va se comporter lorsqu\u2019il re\u00e7oit plusieurs requ\u00eates simultan\u00e9es. Pour cela nous avons besoin des threads\u00a0;</li> <li>ligne 21\u00a0: les threads g\u00e9n\u00e9r\u00e9s vont \u00eatre mis dans une liste. Il faut comprendre que le script [main] est lui aussi ex\u00e9cut\u00e9 par un thread qui s\u2019appelle [MainThread]. Ce thread principal va cr\u00e9er d\u2019autres threads qui seront charg\u00e9s de calculer l\u2019imp\u00f4t d\u2019un ou plusieurs contribuables\u00a0;</li> <li>ligne 26\u00a0: on cr\u00e9e un logueur. Celui-ci sera partag\u00e9 par tous les threads\u00a0;</li> <li>ligne 32\u00a0: on r\u00e9cup\u00e8re tous les contribuables dont il faut calculer l\u2019imp\u00f4t\u00a0;</li> <li>lignes 39-51\u00a0: on va r\u00e9partir ces contribuables sur plusieurs threads\u00a0;</li> <li>lignes 40-41\u00a0: chaque thread va traiter de 1 \u00e0 4 contribuables. Ce nombre est fix\u00e9 de fa\u00e7on al\u00e9atoire\u00a0;</li> <li>[random.randint(1, 4)] donne al\u00e9atoirement un nombre dans la liste [1, 2, 3, 4]\u00a0;</li> <li>le thread ne peut avoir plus de [l-i] contribuables o\u00f9 [l-i] repr\u00e9sente le nombre de contribuables \u00e0 qui on n\u2019a pas encore attribu\u00e9 de thread\u00a0;</li> <li>on prend donc le min des deux valeurs\u00a0;</li> <li>ligne 43\u00a0: une fois que [nb_taxpayers], le nombre de contribuables trait\u00e9s par le thread, est connu, on prend ceux-ci dans la liste des contribuables\u00a0:</li> <li>[slice(10,12)] est l\u2019ensemble des indices [10, 11, 12]\u00a0;</li> <li>[taxpayers[slice(10,12)]] est la liste [taxpayers[10], taxpayers[11], taxpayers[12]\u00a0;</li> <li>ligne 45\u00a0: on incr\u00e9mente la valeur de i qui contr\u00f4le la boucle de la ligne 39\u00a0;</li> <li>ligne 47\u00a0: on cr\u00e9e un thread\u00a0:</li> <li>[target=thread_function] fixe la fonction qu\u2019ex\u00e9cutera le thread. C\u2019est la fonction des lignes 16-17. Elle attend trois param\u00e8tres\u00a0;</li> <li> <p>[ags] est la liste des trois param\u00e8tres attendus par la fonction [thread_function]\u00a0; Cr\u00e9er un thread ne l\u2019ex\u00e9cute pas. Ca cr\u00e9e un objet et c\u2019est tout\u00a0;</p> </li> <li> <p>lignes 48-49\u00a0: le thread qui vient d\u2019\u00eatre cr\u00e9\u00e9 est ajout\u00e9 \u00e0 la liste des threads\u00a0cr\u00e9\u00e9s par le thread principal\u00a0;</p> </li> <li>ligne 51\u00a0: le thread est lanc\u00e9. Il va alors \u00eatre ex\u00e9cut\u00e9 en parall\u00e8le des autres threads actifs. Ici, il va ex\u00e9cuter la fonction [thread_function] avec les arguments qu\u2019on lui a donn\u00e9s\u00a0;</li> <li>lignes 53-54\u00a0: le thread principal attend chacun des threads qu\u2019il a lanc\u00e9s. Prenons un exemple\u00a0:</li> <li>le thread principal a lanc\u00e9 trois threads [th1, th2, th3]\u00a0;</li> <li>le thread principal se met en attente de chacun des threads (lignes 53-54) dans l\u2019ordre de la boucle for\u00a0: [th1, th2, th3]\u00a0;</li> <li>supposons que les threads se terminent dans l\u2019ordre [th2, th1, th3]\u00a0;</li> <li>le thread principal attend la fin de th1. Lorsque th2 se termine, il ne se passe rien\u00a0;</li> <li>lorsque th1 se termine, le thread principal se met en attente de th2. Or celui-ci est termin\u00e9. Le thread principal passe alors au thread suivant et attend th3\u00a0;</li> <li>lorsque th3 se termine, le thread principal a termin\u00e9 son attente et passe alors \u00e0 l\u2019ex\u00e9cution de la ligne 57\u00a0;</li> <li>la ligne 57 \u00e9crit les r\u00e9sultats obtenus dans le fichier des r\u00e9sultats. On a l\u00e0 un bon exemple des r\u00e9f\u00e9rences d\u2019objets\u00a0:</li> <li>ligne 43\u00a0: la liste [thread_payers] associ\u00e9e \u00e0 un thread contient des copies des r\u00e9f\u00e9rences d\u2019objets contenus dans la liste [taxpayers]\u00a0;</li> <li>on sait que le calcul de l\u2019imp\u00f4t va modifier les objets point\u00e9s par les r\u00e9f\u00e9rences de la liste [thread_payers]. Ces objets vont se voir enrichis des r\u00e9sultats du calcul de l\u2019imp\u00f4t. N\u00e9anmoins les r\u00e9f\u00e9rences elles ne sont pas modifi\u00e9es. Donc les r\u00e9f\u00e9rences de la liste initiale [taxpayers] \u2018voient\u2019 ou \u2018pointent sur\u2019 les objets modifi\u00e9s\u00a0; La fonction [thread_function] ex\u00e9cut\u00e9e par les threads est la suivante\u00a0:</li> </ul> <pre><code># ex\u00e9cution de la couche [dao] dans un thread\n# taxpayers est une liste de contribuables\ndef thread_function(dao, logger, taxpayers: list):\n    # log d\u00e9but du thread\n    thread_name = threading.current_thread().name\n    logger.write(f\"d\u00e9but du thread [{thread_name}] avec {len(taxpayers)} contribuable(s)\\n\")\n    # on calcule l'imp\u00f4t des contribuables\n    for taxpayer in taxpayers:\n        # log\n        logger.write(f\"d\u00e9but du calcul de l'imp\u00f4t de {taxpayer}\\n\")\n        # calcul synchrone de l'imp\u00f4t\n        dao.calculate_tax(taxpayer)\n        # log\n        logger.write(f\"fin du calcul de l'imp\u00f4t de {taxpayer}\\n\")\n    # log fin du thread\n    logger.write(f\"fin du thread [{thread_name}]\\n\")\n</code></pre> <ul> <li>les fonctions ex\u00e9cut\u00e9es simultan\u00e9ment par plusieurs threads sont souvent d\u00e9licates \u00e0 \u00e9crire\u00a0: on doit toujours v\u00e9rifier que le code n\u2019essaie pas de modifier une donn\u00e9e partag\u00e9e entre threads. Lorsque ce dernier cas se produit, il faut mettre en place un acc\u00e8s synchronis\u00e9 \u00e0 la donn\u00e9e partag\u00e9e qui va \u00eatre modifi\u00e9e\u00a0;</li> <li>ligne 3\u00a0: la fonction re\u00e7oit trois param\u00e8tres\u00a0:</li> <li>[dao]\u00a0: une r\u00e9f\u00e9rence sur la couche [dao]. Cette donn\u00e9e est partag\u00e9e\u00a0;</li> <li>[logger]\u00a0: une r\u00e9f\u00e9rence sur le logueur. Cette donn\u00e9e est partag\u00e9e\u00a0;</li> <li>[taxpayers]\u00a0: une liste de contribuables. Cette donn\u00e9e n\u2019est pas partag\u00e9e\u00a0: chaque thread g\u00e8re une liste diff\u00e9rente\u00a0;</li> <li>examinons les deux r\u00e9f\u00e9rences [dao, logger]\u00a0:</li> <li>on a vu que l\u2019objet point\u00e9 par la r\u00e9f\u00e9rence [dao] avait une r\u00e9f\u00e9rence [self.__logger] qui \u00e9tait modifi\u00e9e par les threads mais pour y mettre une valeur commune \u00e0 tous les threads\u00a0;</li> <li>la r\u00e9f\u00e9rence [logger] pointe sur un descripteur de fichier. On a vu qu\u2019il pouvait y avoir un probl\u00e8me lors de l\u2019\u00e9criture des logs dans le fichier. Pour cette raison l\u2019\u00e9criture dans le fichier a \u00e9t\u00e9 synchronis\u00e9e\u00a0;</li> <li>lignes 5-6\u00a0: on logue le nom du thread et le nombre de contribuables qu\u2019il doit g\u00e9rer\u00a0;</li> <li>lignes 8-14\u00a0: calcul de l\u2019imp\u00f4t des contribuables\u00a0;</li> <li>ligne 16\u00a0: on logue la fin du thread\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-7.html#2444-execution","title":"24.4.4. Ex\u00e9cution","text":"<p>Lan\u00e7ons le serveur web comme dans le paragraphe pr\u00e9c\u00e9dent (serveur web, SGBD, hMailServer, Thunderbird), puis ex\u00e9cutons le script [main] du client. Dans les fichiers [data/output/errors.txt, data/output/r\u00e9sultats.json] on a les m\u00eames r\u00e9sultats que dans la version pr\u00e9c\u00e9dente. Dans le fichier [data/logs/logs.txt], on a les logs suivants\u00a0:</p> <pre><code>2020-07-24 10:05:20.942404, Thread-1 : d\u00e9but du thread [Thread-1] avec 1 contribuable(s)\n2020-07-24 10:05:20.943458, Thread-1 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 1, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555}\n2020-07-24 10:05:20.943458, Thread-2 : d\u00e9but du thread [Thread-2] avec 3 contribuable(s)\n2020-07-24 10:05:20.946502, Thread-3 : d\u00e9but du thread [Thread-3] avec 1 contribuable(s)\n2020-07-24 10:05:20.946502, Thread-2 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 2, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 50000}\n2020-07-24 10:05:20.947003, Thread-3 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 5, \"mari\u00e9\": \"non\", \"enfants\": 3, \"salaire\": 100000}\n2020-07-24 10:05:20.947003, Thread-4 : d\u00e9but du thread [Thread-4] avec 3 contribuable(s)\n2020-07-24 10:05:20.950324, Thread-4 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 6, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 100000}\n2020-07-24 10:05:20.948449, Thread-5 : d\u00e9but du thread [Thread-5] avec 3 contribuable(s)\n2020-07-24 10:05:20.953645, Thread-5 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 9, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 30000}\n2020-07-24 10:05:20.976143, Thread-1 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555, \"imp\u00f4t\": 2814, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-24 10:05:20.976695, Thread-1 : fin du calcul de l'imp\u00f4t de {\"id\": 1, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555, \"imp\u00f4t\": 2814, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-24 10:05:20.976695, Thread-1 : fin du thread [Thread-1]\n2020-07-24 10:05:21.973914, Thread-2 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 50000, \"imp\u00f4t\": 1384, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 384, \"r\u00e9duction\": 347}}}\n2020-07-24 10:05:21.973914, Thread-2 : fin du calcul de l'imp\u00f4t de {\"id\": 2, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 50000, \"imp\u00f4t\": 1384, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 384, \"r\u00e9duction\": 347}\n2020-07-24 10:05:21.973914, Thread-2 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 3, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 50000}\n2020-07-24 10:05:21.977130, Thread-4 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 9200, \"surc\u00f4te\": 2180, \"taux\": 0.3, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-24 10:05:21.977130, Thread-4 : fin du calcul de l'imp\u00f4t de {\"id\": 6, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 9200, \"surc\u00f4te\": 2180, \"taux\": 0.3, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-24 10:05:21.977130, Thread-4 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 7, \"mari\u00e9\": \"oui\", \"enfants\": 5, \"salaire\": 100000}\n2020-07-24 10:05:21.982634, Thread-3 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"non\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 16782, \"surc\u00f4te\": 7176, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-24 10:05:21.982634, Thread-5 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 30000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.0, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-24 10:05:21.983134, Thread-3 : fin du calcul de l'imp\u00f4t de {\"id\": 5, \"mari\u00e9\": \"non\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 16782, \"surc\u00f4te\": 7176, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-24 10:05:21.983134, Thread-5 : fin du calcul de l'imp\u00f4t de {\"id\": 9, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 30000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.0, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-24 10:05:21.983134, Thread-3 : fin du thread [Thread-3]\n2020-07-24 10:05:21.983763, Thread-5 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 10, \"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 200000}\n2020-07-24 10:05:22.008562, Thread-5 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 200000, \"imp\u00f4t\": 64210, \"surc\u00f4te\": 7498, \"taux\": 0.45, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-24 10:05:22.008562, Thread-5 : fin du calcul de l'imp\u00f4t de {\"id\": 10, \"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 200000, \"imp\u00f4t\": 64210, \"surc\u00f4te\": 7498, \"taux\": 0.45, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-24 10:05:22.009062, Thread-5 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 11, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000}\n2020-07-24 10:05:22.016848, Thread-5 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000, \"imp\u00f4t\": 42842, \"surc\u00f4te\": 17283, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-24 10:05:22.017349, Thread-5 : fin du calcul de l'imp\u00f4t de {\"id\": 11, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000, \"imp\u00f4t\": 42842, \"surc\u00f4te\": 17283, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-24 10:05:22.017349, Thread-5 : fin du thread [Thread-5]\n2020-07-24 10:05:23.008486, Thread-2 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 50000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 720, \"r\u00e9duction\": 0}}}\n2020-07-24 10:05:23.008486, Thread-2 : fin du calcul de l'imp\u00f4t de {\"id\": 3, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 50000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 720, \"r\u00e9duction\": 0}\n2020-07-24 10:05:23.009749, Thread-2 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 4, \"mari\u00e9\": \"non\", \"enfants\": 2, \"salaire\": 100000}\n2020-07-24 10:05:23.011722, Thread-4 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 5, \"salaire\": 100000, \"imp\u00f4t\": 4230, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-24 10:05:23.013723, Thread-4 : fin du calcul de l'imp\u00f4t de {\"id\": 7, \"mari\u00e9\": \"oui\", \"enfants\": 5, \"salaire\": 100000, \"imp\u00f4t\": 4230, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-24 10:05:23.013723, Thread-4 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 8, \"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 100000}\n2020-07-24 10:05:23.024135, Thread-2 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"non\", \"enfants\": 2, \"salaire\": 100000, \"imp\u00f4t\": 19884, \"surc\u00f4te\": 4480, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-24 10:05:23.024135, Thread-2 : fin du calcul de l'imp\u00f4t de {\"id\": 4, \"mari\u00e9\": \"non\", \"enfants\": 2, \"salaire\": 100000, \"imp\u00f4t\": 19884, \"surc\u00f4te\": 4480, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-24 10:05:23.025178, Thread-2 : fin du thread [Thread-2]\n2020-07-24 10:05:23.025178, Thread-4 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 100000, \"imp\u00f4t\": 22986, \"surc\u00f4te\": 0, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-24 10:05:23.026191, Thread-4 : fin du calcul de l'imp\u00f4t de {\"id\": 8, \"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 100000, \"imp\u00f4t\": 22986, \"surc\u00f4te\": 0, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-24 10:05:23.026191, Thread-4 : fin du thread [Thread-4]\n</code></pre> <ul> <li>ces logs montrent que cinq threads ont \u00e9t\u00e9 lanc\u00e9s pour calculer l\u2019imp\u00f4t de 11 contribuables. Ces cinq threads ont lanc\u00e9 des requ\u00eates simultan\u00e9es au serveur de calcul de l\u2019imp\u00f4t. Il faut comprendre comment \u00e7a marche\u00a0:</li> <li>le thread [Thread-1] est lanc\u00e9 le premier. Lorsqu\u2019il a le processeur, il avance dans le code jusqu\u2019\u00e0 envoyer sa requ\u00eate HTTP. Comme il doit attendre le r\u00e9sultat de celle-ci, il est automatiquement mis en attente. Il perd alors le processeur et un autre thread obtient celui-ci\u00a0;</li> <li>lignes 1-10\u00a0: le m\u00eame processus se r\u00e9p\u00e8te pour chacun des 5 threads. Ainsi les 5 threads sont lanc\u00e9s avant m\u00eame que le thread [Thread-1] ait re\u00e7u sa r\u00e9ponse ligne 11\u00a0;</li> <li>les threads ne se terminent pas dans l\u2019ordre o\u00f9 ils ont \u00e9t\u00e9 lanc\u00e9s. Ainsi c\u2019est le thread [Thread-3] qui termine le premier, ligne 23\u00a0; C\u00f4t\u00e9 serveur, les logs dans le fichier [data/logs/logs.txt] sont les suivants\u00a0:</li> </ul> <pre><code>2020-07-24 10:05:01.692980, MainThread : [serveur] d\u00e9marrage du serveur\n2020-07-24 10:05:01.877251, MainThread : [serveur] connexion \u00e0 la base de donn\u00e9es r\u00e9ussie\n2020-07-24 10:05:03.596162, MainThread : [serveur] d\u00e9marrage du serveur\n2020-07-24 10:05:03.661160, MainThread : [serveur] connexion \u00e0 la base de donn\u00e9es r\u00e9ussie\n2020-07-24 10:05:20.968053, Thread-2 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=2&amp;salaire=50000' [GET]&gt;\n2020-07-24 10:05:20.969132, Thread-2 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-24 10:05:20.970316, Thread-3 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=3&amp;salaire=100000' [GET]&gt;\n2020-07-24 10:05:20.970316, Thread-3 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-24 10:05:20.971335, Thread-4 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=2&amp;salaire=55555' [GET]&gt;\n2020-07-24 10:05:20.972563, Thread-4 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 55555, 'imp\u00f4t': 2814, 'surc\u00f4te': 0, 'taux': 0.14, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-24 10:05:20.974796, Thread-5 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=non&amp;enfants=3&amp;salaire=100000' [GET]&gt;\n2020-07-24 10:05:20.974796, Thread-5 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-24 10:05:20.976143, Thread-6 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=2&amp;salaire=30000' [GET]&gt;\n2020-07-24 10:05:20.976143, Thread-6 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-24 10:05:21.970615, Thread-2 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 50000, 'imp\u00f4t': 1384, 'surc\u00f4te': 0, 'taux': 0.14, 'd\u00e9c\u00f4te': 384, 'r\u00e9duction': 347}}}\n2020-07-24 10:05:21.973914, Thread-3 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 100000, 'imp\u00f4t': 9200, 'surc\u00f4te': 2180, 'taux': 0.3, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-24 10:05:21.977130, Thread-6 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 30000, 'imp\u00f4t': 0, 'surc\u00f4te': 0, 'taux': 0.0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-24 10:05:21.977130, Thread-5 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'non', 'enfants': 3, 'salaire': 100000, 'imp\u00f4t': 16782, 'surc\u00f4te': 7176, 'taux': 0.41, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-24 10:05:22.001693, Thread-7 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=3&amp;salaire=50000' [GET]&gt;\n2020-07-24 10:05:22.003013, Thread-7 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-24 10:05:22.003013, Thread-8 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=5&amp;salaire=100000' [GET]&gt;\n2020-07-24 10:05:22.003013, Thread-8 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-24 10:05:22.005871, Thread-9 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=non&amp;enfants=0&amp;salaire=200000' [GET]&gt;\n2020-07-24 10:05:22.006370, Thread-9 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'non', 'enfants': 0, 'salaire': 200000, 'imp\u00f4t': 64210, 'surc\u00f4te': 7498, 'taux': 0.45, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-24 10:05:22.014170, Thread-10 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=3&amp;salaire=200000' [GET]&gt;\n2020-07-24 10:05:22.014170, Thread-10 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 200000, 'imp\u00f4t': 42842, 'surc\u00f4te': 17283, 'taux': 0.41, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-24 10:05:23.003533, Thread-7 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 50000, 'imp\u00f4t': 0, 'surc\u00f4te': 0, 'taux': 0.14, 'd\u00e9c\u00f4te': 720, 'r\u00e9duction': 0}}}\n2020-07-24 10:05:23.006434, Thread-8 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 5, 'salaire': 100000, 'imp\u00f4t': 4230, 'surc\u00f4te': 0, 'taux': 0.14, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-24 10:05:23.018026, Thread-11 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=non&amp;enfants=2&amp;salaire=100000' [GET]&gt;\n2020-07-24 10:05:23.019074, Thread-11 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'non', 'enfants': 2, 'salaire': 100000, 'imp\u00f4t': 19884, 'surc\u00f4te': 4480, 'taux': 0.41, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-24 10:05:23.021447, Thread-12 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=non&amp;enfants=0&amp;salaire=100000' [GET]&gt;\n2020-07-24 10:05:23.022447, Thread-12 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'non', 'enfants': 0, 'salaire': 100000, 'imp\u00f4t': 22986, 'surc\u00f4te': 0, 'taux': 0.41, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n</code></pre> <ul> <li>on voit que 11 threads ont trait\u00e9 les 11 contribuables\u00a0;</li> <li>certains threads ont \u00e9t\u00e9 mis en attente (lignes 6, 8, 12, 14, 20, 22) et d\u2019autres pas (lignes 9, 23, 25, 29, 31)\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-7.html#245-tests-de-la-couche-dao","title":"24.5. Tests de la couche [dao]","text":"<p>Comme nous l\u2019avons fait dans la |version pr\u00e9c\u00e9dente| nous testons la couche [dao] du client. Le principe est exactement le m\u00eame\u00a0:</p> <p></p> <p>La classe de test sera ex\u00e9cut\u00e9e dans l\u2019environnement suivant\u00a0:</p> <p></p> <ul> <li>la configuration [2] est identique \u00e0 la configuration [1] que nous venons d\u2019\u00e9tudier\u00a0; La classe de test [TestHttpClientDao] est la suivante\u00a0:</li> </ul> <pre><code>import unittest\n\nfrom Logger import Logger\n\n\nclass TestHttpClientDao(unittest.TestCase):\n\n    def test_1(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 55555,\n        # 'imp\u00f4t': 2814, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.14}\n        taxpayer = TaxPayer().fromdict({\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555})\n        dao.calculate_tax(taxpayer)\n        # v\u00e9rification\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 2815, delta=1)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.14, delta=0.01)\n        self.assertEqual(taxpayer.surc\u00f4te, 0)\n\n    \u2026\n\n\nif __name__ == '__main__':\n    # on configure l'application\n    import config\n    config = config.configure({})\n\n    # logger\n    logger = Logger(config[\"logsFilename\"])\n    # on le m\u00e9morise dans la config\n    config[\"logger\"] = logger\n    # on r\u00e9cup\u00e8re la couche [dao]\n    dao = config[\"layers\"][\"dao\"]\n\n    # on ex\u00e9cute les m\u00e9thodes de test\n    print(\"tests en cours...\")\n    unittest.main()\n</code></pre> <ul> <li>on cr\u00e9e une |configuration d\u2019ex\u00e9cution| pour ce test\u00a0;</li> <li>on lance le serveur web avec tout son environnement\u00a0;</li> <li>on ex\u00e9cute le test\u00a0; Les r\u00e9sultats sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots/http-clients/02/tests/TestHttpClientDao.py\ntests en cours...\n...........\n----------------------------------------------------------------------\nRan 11 tests in 6.128s\n\nOK\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"exercice-dapplication-version-8.html","title":"25. Exercice d\u2019application\u00a0: version 8","text":""},{"location":"exercice-dapplication-version-8.html#251-introduction","title":"25.1. Introduction","text":"<p>Nous allons \u00e9crire une nouvelle application client / serveur. La nouveaut\u00e9 du serveur est qu\u2019il va g\u00e9rer une session. Au lieu de mettre les donn\u00e9es de l\u2019administration fiscale dans un objet de port\u00e9e [application], on va les mettre dans un objet de port\u00e9e [session]. Ce faisant, on r\u00e9gresse dans les performances du code. Lorsqu\u2019un objet peut \u00eatre partag\u00e9 en lecture seule par tous les utilisateurs, il est pr\u00e9f\u00e9rable d\u2019en faire un objet de port\u00e9e [application] plut\u00f4t que de port\u00e9e [session]. On gagne au minimum de la bande passante puisque qu\u2019on diminue ainsi la taille du cookie de session. Mais nous voulons montrer une application client / serveur o\u00f9 le client et le serveur s\u2019\u00e9changent un cookie de session.</p> <p>L\u2019architecture de l\u2019application ne change pas\u00a0:</p> <p></p>"},{"location":"exercice-dapplication-version-8.html#252-le-serveur-web","title":"25.2. Le serveur web","text":"<p>L\u2019arborescence des scripts du serveur est la suivante\u00a0:</p> <p></p> <p>Le dossier [http-servers/03] est obtenu initialement par recopie du dossier [http-servers/02]. On proc\u00e8de ensuite \u00e0 des modifications.</p>"},{"location":"exercice-dapplication-version-8.html#2521-la-configuration","title":"25.2.1. La configuration","text":"<p>Elle est la m\u00eame que dans la |version pr\u00e9c\u00e9dente| avec quelques modifications\u00a0dans le script [config]\u00a0:</p> <pre><code># d\u00e9pendances absolues\n    absolute_dependencies = [\n        # dossiers du projet\n        # BaseEntity, MyException\n        f\"{root_dir}/classes/02/entities\",\n        # InterfaceImp\u00f4tsDao, InterfaceImp\u00f4tsM\u00e9tier, InterfaceImp\u00f4tsUi\n        f\"{root_dir}/impots/v04/interfaces\",\n        # AbstractImp\u00f4tsdao, Imp\u00f4tsConsole, Imp\u00f4tsM\u00e9tier\n        f\"{root_dir}/impots/v04/services\",\n        # ImpotsDaoWithAdminDataInDatabase\n        f\"{root_dir}/impots/v05/services\",\n        # AdminData, Imp\u00f4tsError, TaxPayer\n        f\"{root_dir}/impots/v04/entities\",\n        # Constantes, Tranches\n        f\"{root_dir}/impots/v05/entities\",\n        # index_controller\n        f\"{script_dir}/../controllers\",\n        # scripts [config_database, config_layers]\n        script_dir,\n        # Logger, SendAdminMail\n        f\"{root_dir}/impots/http-servers/02/utilities\",\n    ]\n</code></pre> <ul> <li>ligne 17\u00a0: on va r\u00e9\u00e9crire un contr\u00f4leur pour la fonction [index] qui traite l\u2019URL /\u00a0;</li> <li>ligne 21\u00a0: on utilise les utilitaires de la |version pr\u00e9c\u00e9dente|\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-8.html#2522-le-script-principal-main","title":"25.2.2. Le script principal [main]","text":"<p>Le nouveau script [main] am\u00e8ne quelques modifications au script principal [main] de la version pr\u00e9c\u00e9dente\u00a0:</p> <pre><code># l'application Flask peut d\u00e9marrer\napp = Flask(__name__)\n# cl\u00e9 secr\u00e8te de la session\napp.secret_key = os.urandom(12).hex()\n</code></pre> <ul> <li>ligne 4\u00a0: on cr\u00e9e une cl\u00e9 secr\u00e8te pour l\u2019application. On sait que celle-ci est n\u00e9cessaire pour g\u00e9rer les sessions\u00a0; Ensuite, les donn\u00e9es fiscale ne sont plus demand\u00e9es dans le code de [main]. Les lignes suivantes sont supprim\u00e9es\u00a0:</li> </ul> <pre><code># r\u00e9cup\u00e9ration des donn\u00e9es de l'administration fiscale\nerreur = False\ntry:\n    # admindata sera une donn\u00e9e de port\u00e9e application en lecture seule\n    config[\"admindata\"] = config[\"layers\"][\"dao\"].get_admindata()\n    # log de r\u00e9ussite\n    logger.write(\"[serveur] connexion \u00e0 la base de donn\u00e9es r\u00e9ussie\\n\")\nexcept Imp\u00f4tsError as ex:\n    # on note l'erreur\n    erreur = True\n    # log d'erreur\n    log = f\"L'erreur suivante s'est produite : {ex}\"\n    # console\n    print(log)\n    # fichier de logs\n    logger.write(f\"{log}\\n\")\n    # mail \u00e0 l'administrateur\n    send_adminmail(config, log)\n</code></pre> <p>Par ailleurs, le contr\u00f4leur [index_controller] admet un param\u00e8tre suppl\u00e9mentaire, la session Flask\u00a0:</p> <pre><code>from flask import request, Flask, session\n\u2026.        \n        # on fait ex\u00e9cuter la requ\u00eate par un contr\u00f4leur\n        r\u00e9sultat, status_code = index_controller.execute(request, session, config)\n</code></pre>"},{"location":"exercice-dapplication-version-8.html#2523-le-controleur-index_controller","title":"25.2.3. Le contr\u00f4leur [index_controller]","text":"<p>Le contr\u00f4leur [index_controller] g\u00e8re d\u00e9sormais une session\u00a0:</p> <pre><code># import des d\u00e9pendances\nimport os\nimport re\nimport threading\n\nfrom flask_api import status\nfrom werkzeug.local import LocalProxy\n\n# URL param\u00e9tr\u00e9e : /?mari\u00e9=xx&amp;enfants=yy&amp;salaire=zz\nfrom AdminData import AdminData\nfrom Imp\u00f4tsError import Imp\u00f4tsError\n\n\ndef execute(request: LocalProxy, session: LocalProxy, config: dict) -&gt; tuple:\n    # d\u00e9pendances\n    from TaxPayer import TaxPayer\n\n    # au d\u00e9part pas d'erreurs\n    erreurs = []\n    \u2026\n\n    # des erreurs ?\n    if erreurs:\n        # on rend une r\u00e9ponse d'erreur au client\n        return {\"r\u00e9ponse\": {\"erreurs\": erreurs}}, status.HTTP_400_BAD_REQUEST\n\n    # pas d'erreurs, on peut travailler\n    # on r\u00e9cup\u00e8re la config associ\u00e9e au thread\n    thread_name = threading.current_thread().name\n    logger = config[thread_name][\"config\"][\"logger\"]\n    # on ex\u00e9cute la requ\u00eate\n    r\u00e9ponse = None\n    try:\n        # le cas le + simple - admindata est d\u00e9j\u00e0 en session\n        if session.get('client_id') is not None:\n            # on r\u00e9cup\u00e8re les informations de la session\n            client_id = session.get('client_id')\n            admindata = AdminData().fromdict(session.get('admindata'))\n            # log\n            logger.write(f\"[index_controller] client [{client_id}], donn\u00e9es fiscales prises en session\\n\")\n        else:\n            # r\u00e9cup\u00e9ration des donn\u00e9es de l'administration fiscale\n            admindata = config[\"layers\"][\"dao\"].get_admindata()\n            # mise en session de admindata\n            session['admindata'] = admindata.asdict()\n            # on donne un n\u00b0 au client et on met ce n\u00b0 en session\n            # cela va nous permettre de le suivre dans les logs du serveur\n            client_id = os.urandom(12).hex()\n            session['client_id'] = client_id\n            # log\n            logger.write(f\"[index_controller] client [{client_id}], donn\u00e9es fiscales prises dans la couche dao\\n\")\n        # calcul de l'imp\u00f4t\n        taxpayer = TaxPayer().fromdict({'mari\u00e9': mari\u00e9, 'enfants': enfants, 'salaire': salaire})\n        config[\"layers\"][\"m\u00e9tier\"].calculate_tax(taxpayer, admindata)\n        # on rend la r\u00e9ponse au client\n        return {\"r\u00e9ponse\": {\"result\": taxpayer.asdict()}}, status.HTTP_200_OK\n    except (BaseException, Imp\u00f4tsError) as erreur:\n        # on rend la r\u00e9ponse au client\n        return {\"r\u00e9ponse\": {\"erreurs\": [f\"{erreur}\"]}}, status.HTTP_500_INTERNAL_SERVER_ERROR\n</code></pre> <ul> <li>ligne 14\u00a0: le contr\u00f4leur re\u00e7oit la session courante du client web\u00a0;</li> <li>lignes 35-38\u00a0: si le client a une session, alors celle-ci contient deux cl\u00e9s\u00a0:</li> <li>[client_id]\u00a0: un n\u00b0 de client\u00a0(ligne 37)\u00a0;</li> <li>[admindata]\u00a0: les donn\u00e9es de l\u2019administration fiscale sous le forme d\u2019un dictionnaire (ligne 38)\u00a0;</li> <li>ligne 35\u00a0: on regarde si la session a une des deux cl\u00e9s attendues\u00a0;</li> <li>lignes 42-51\u00a0: cas o\u00f9 la session du client n\u2019a pas encore \u00e9t\u00e9 initialis\u00e9e\u00a0;</li> <li>ligne 43\u00a0: on r\u00e9cup\u00e8re les donn\u00e9es de l\u2019administration fiscale aupr\u00e8s de la couche [dao]\u00a0;</li> <li>ligne 45\u00a0: ces donn\u00e9es sont mises dans la session sous la forme d\u2019un dictionnaire\u00a0;</li> <li>ligne 48\u00a0: on affecte un n\u00b0 al\u00e9atoire au client. Ce n\u00b0 sera diff\u00e9rent pour chaque client\u00a0;</li> <li>ligne 49\u00a0: ce n\u00b0 est mis en session\u00a0;</li> <li>ligne 51\u00a0: on logue le fait que les donn\u00e9es de l\u2019administration fiscale ont \u00e9t\u00e9 obtenues par la couche [dao]. Les acc\u00e8s \u00e0 la couche [dao] sont en g\u00e9n\u00e9ral co\u00fbteux. C\u2019est pourquoi il faut les limiter. L\u2019id\u00e9e ici est d\u2019obtenir une fois les donn\u00e9es fiscales aupr\u00e8s de la couche [dao], de les mettre en session et d\u2019aller les chercher l\u00e0 lors des requ\u00eates ult\u00e9rieures du m\u00eame client. On rappelle que ce n\u2019est pas la meilleure solution. Les donn\u00e9es fiscales de l\u2019administration \u00e9tant les m\u00eames pour tous les clients, leur place est dans un objet de port\u00e9e application\u00a0;</li> <li>lignes 35-40\u00a0: cas o\u00f9 la session du client a \u00e9t\u00e9 initialis\u00e9e lors d\u2019une pr\u00e9c\u00e9dente requ\u00eate\u00a0;</li> <li>ligne 37\u00a0: on r\u00e9cup\u00e8re le n\u00b0 du client dans la session\u00a0;</li> <li>ligne 38\u00a0: on r\u00e9cup\u00e8re les donn\u00e9es fiscales de l\u2019administration dans la session\u00a0;</li> <li>ligne 40\u00a0: on logue le fait que le client a obtenu les donn\u00e9es fiscales de l\u2019administration dans la session\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-8.html#253-le-client-web","title":"25.3. Le client web","text":""},{"location":"exercice-dapplication-version-8.html#2531-la-couche-dao","title":"25.3.1. La couche [dao]","text":""},{"location":"exercice-dapplication-version-8.html#25311-la-classe-impotsdaowithhttpsession","title":"25.3.1.1. La classe [Imp\u00f4tsDaoWithHttpSession]","text":"<p>La couche [dao] est impl\u00e9ment\u00e9e par la classe [Imp\u00f4tsDaoWithHttpSession] suivante\u00a0:</p> <pre><code># imports\n\nimport requests\nfrom flask_api import status\nfrom myutils import decode_flask_session\n\nfrom AbstractImp\u00f4tsDao import AbstractImp\u00f4tsDao\nfrom AdminData import AdminData\nfrom Imp\u00f4tsError import Imp\u00f4tsError\nfrom InterfaceImp\u00f4tsM\u00e9tier import InterfaceImp\u00f4tsM\u00e9tier\nfrom TaxPayer import TaxPayer\n\n\nclass Imp\u00f4tsDaoWithHttpSession(AbstractImp\u00f4tsDao, InterfaceImp\u00f4tsM\u00e9tier):\n\n    # constructeur\n    def __init__(self, config: dict):\n        # initialisation parent\n        AbstractImp\u00f4tsDao.__init__(self, config)\n        # m\u00e9morisation \u00e9l\u00e9ments de la configuration\n        # config g\u00e9n\u00e9rale\n        self.__config = config\n        # serveur\n        self.__config_server = config[\"server\"]\n        # mode debug\n        self.__debug = config[\"debug\"]\n        # logger\n        self.__logger = None\n        # cookies\n        self.__cookies = None\n\n    # m\u00e9thode inutilis\u00e9e\n    def get_admindata(self) -&gt; AdminData:\n        pass\n\n    # calcul de l'imp\u00f4t\n    def calculate_tax(self, taxpayer: TaxPayer, admindata: AdminData = None):\n        # on laisse remonter les exceptions\n        # param\u00e8tres du get\n        params = {\"mari\u00e9\": taxpayer.mari\u00e9, \"enfants\": taxpayer.enfants, \"salaire\": taxpayer.salaire}\n        # connexion avec authentification Auth Basic ?\n        if self.__config_server['authBasic']:\n            response = requests.get(\n                # URL du serveur interrog\u00e9\n                self.__config_server['urlServer'],\n                # param\u00e8tres de l'URL\n                params=params,\n                # authentification Basic\n                auth=(\n                    self.__config_server[\"user\"][\"login\"],\n                    self.__config_server[\"user\"][\"password\"]),\n                cookies=self.__cookies)\n\n        else:\n            # connexion sans authentification Auth Basic\n            response = requests.get(self.__config_server['urlServer'], params=params, cookies=self.__cookies)\n        # on r\u00e9cup\u00e8re les cookies de la r\u00e9ponse s'il y en a\n        if response.cookies:\n            self.__cookies = response.cookies\n            # on r\u00e9cup\u00e8re le cookie de session\n            session_cookie = response.cookies.get('session')\n            # on le d\u00e9code pour le loguer\n            if session_cookie:\n                # logueur\n                if not self.__logger:\n                    self.__logger = self.__config['logger']\n                # on logue\n                self.__logger.write(f\"cookie de session={decode_flask_session(session_cookie)}\\n\")\n\n        # mode debug ?\n        if self.__debug:\n            # logueur\n            if not self.__logger:\n                self.__logger = self.__config['logger']\n            # on logue\n            self.__logger.write(f\"{response.text}\\n\")\n        # code de statut de la r\u00e9ponse HTTP\n        status_code = response.status_code\n        # on met la r\u00e9ponse jSON dans un dictionnaire\n        r\u00e9sultat = response.json()\n        # erreur si code de statut diff\u00e9rent de 200 OK\n        if status_code != status.HTTP_200_OK:\n            # on sait que les erreurs ont \u00e9t\u00e9 associ\u00e9es \u00e0 la cl\u00e9 [erreurs] de la r\u00e9ponse\n            raise Imp\u00f4tsError(87, r\u00e9sultat['r\u00e9ponse']['erreurs'])\n        # on sait que le r\u00e9sultat a \u00e9t\u00e9 associ\u00e9 \u00e0 la cl\u00e9 [result] de la r\u00e9ponse\n        # on modifie le param\u00e8tre d'entr\u00e9e avec ce r\u00e9sultat\n        taxpayer.fromdict(r\u00e9sultat[\"r\u00e9ponse\"][\"result\"])\n</code></pre> <ul> <li>ligne 30\u00a0: la couche [dao] va g\u00e9rer un dictionnaire de cookies\u00a0;</li> <li>ligne 58\u00a0: la propri\u00e9t\u00e9 [response.cookies] est un dictionnaire rassemblant les cookies envoy\u00e9s par le serveur dans les ent\u00eates HTTP [Set-Cookie]\u00a0;</li> <li>ligne 59\u00a0: ces cookies sont m\u00e9moris\u00e9s dans la couche [dao]. Ils seront renvoy\u00e9s au serveur lors des requ\u00eates ult\u00e9rieures du m\u00eame client\u00a0;</li> <li>lignes 60-68\u00a0: bien que ce ne soit pas indispensable on r\u00e9cup\u00e8re le cookie de session. Dans le dictionnaire des cookies envoy\u00e9s par le serveur, le cookie de session est associ\u00e9 \u00e0 la cl\u00e9 [session]\u00a0;</li> <li>lignes 62-68\u00a0: on d\u00e9code le cookie de session pour le loguer\u00a0;</li> <li>ligne 68\u00a0: nous reviendrons ult\u00e9rieurement sur la fonction [decode_flask_session] qui d\u00e9code le cookie de session\u00a0;</li> <li>lignes 52 et 57\u00a0: \u00e0 chaque requ\u00eate du m\u00eame client, les cookies envoy\u00e9s par le serveur lui sont renvoy\u00e9s. C\u2019est de cette fa\u00e7on que la session Flask est maintenue entre le client et le serveur\u00a0; Il faut se souvenir maintenant que la couche [dao] va \u00eatre ex\u00e9cut\u00e9e simultan\u00e9ment par plusieurs threads. Il faut donc regarder toutes les propri\u00e9t\u00e9s de l\u2019instance de classe et voir si l\u2019acc\u00e8s simultan\u00e9 \u00e0 ces propri\u00e9t\u00e9s pose probl\u00e8me. Ici nous avons ajout\u00e9 la propri\u00e9t\u00e9 [self.__cookies], ligne 30. Cette propri\u00e9t\u00e9 est modifi\u00e9e \u00e0 la ligne 59. On a donc un acc\u00e8s en \u00e9criture \u00e0 une donn\u00e9e partag\u00e9e par tous les threads. Or cet acc\u00e8s pose probl\u00e8me\u00a0: chaque thread repr\u00e9sentant un client donn\u00e9 a son propre cookie de session. En effet, dedans il y a un n\u00b0 de client (=thread) unique pour chaque client. Si on ne fait rien, le thread T2 peut \u00e9craser les cookies du thread T1.</li> </ul> <p>On a d\u00e9j\u00e0 vu une m\u00e9thode pour g\u00e9rer ce probl\u00e8me\u00a0: on peut cr\u00e9er dans le fichier [config] pass\u00e9 en param\u00e8tre au constructeur (ligne 17), des cl\u00e9s diff\u00e9rentes pour chaque thread. On peut par exemple utiliser comme cl\u00e9 le nom du thread\u00a0:</p> <ul> <li> <p>ligne 59, on pourrait \u00e9crire\u00a0: <pre><code>config[thread_name][\u2018cookies\u2019]=cookies\n</code></pre></p> </li> <li> <p>ligne 52, on pourrait alors \u00e9crire\u00a0: <pre><code>cookies=config[thread_name][\u2018cookies\u2019]\n</code></pre></p> </li> </ul> <p>Nous allons ici utiliser une technique diff\u00e9rente\u00a0: chaque thread (=client) aura sa propre couche [dao]. Ainsi la ligne 59 ne pose plus probl\u00e8me car les cookies utilis\u00e9s sont alors ceux d\u2019un unique client.</p> <p>Pour cela, nous allons cr\u00e9er une nouvelle classe [Imp\u00f4tsDaoWithHttpSessionFactory].</p>"},{"location":"exercice-dapplication-version-8.html#25312-la-fonction-de-decodage-de-la-session-flask","title":"25.3.1.2. La fonction de d\u00e9codage de la session Flask","text":"<p>La fonction [decode_flask_session] est d\u00e9finie dans le script [myutils]\u00a0:</p> <p></p> <p>Nous avons d\u00e9j\u00e0 \u00e9tudi\u00e9 le script |myutils|. Ce script est un module de port\u00e9e machine que les diff\u00e9rents scripts de ce cours peuvent importer avec l\u2019instruction\u00a0:</p> <pre><code>import myutils\n</code></pre> <p>On y d\u00e9finit la fonction [decode_flask_session] de la fa\u00e7on suivante\u00a0:</p> <pre><code>def decode_flask_session(cookie: str) -&gt; str:\n    # source : https://www.kirsle.net/wizards/flask-session.cgi\n    compressed = False\n    payload = cookie\n\n    if payload.startswith('.'):\n        compressed = True\n        payload = payload[1:]\n\n    data = payload.split(\".\")[0]\n\n    data = base64_decode(data)\n    if compressed:\n        data = zlib.decompress(data)\n\n    return data.decode(\"utf-8\")\n</code></pre> <ul> <li>ligne 2\u00a0: l\u2019URL o\u00f9 j\u2019ai trouv\u00e9 cette fonction\u00a0;</li> <li>ligne 1\u00a0: le param\u00e8tre [cookie] est la cha\u00eene de caract\u00e8res associ\u00e9e \u00e0 la cl\u00e9 [session] dans le dictionnaire des cookies re\u00e7us par un client web\u00a0;</li> <li>lignes 3-16\u00a0: je ne commenterai pas ce code que je ne ma\u00eetrise pas\u00a0; On ajoute une nouvelle importation dans le fichier [init.py]\u00a0:</li> </ul> <pre><code>from .myutils import set_syspath, json_response, decode_flask_session\n</code></pre> <p>La nouvelle version de [myutils] est install\u00e9e parmi les modules de port\u00e9e machine avec la commande [pip install .] dans un terminal Pycharm\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\packages&gt;pip install .\nProcessing c:\\data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\packages\nUsing legacy setup.py install for myutils, since package 'wheel' is not installed.\nInstalling collected packages: myutils\n  Attempting uninstall: myutils\n    Found existing installation: myutils 0.1\n    Uninstalling myutils-0.1:\n      Successfully uninstalled myutils-0.1\n    Running setup.py install for myutils ... done\nSuccessfully installed myutils-0.1\n</code></pre> <ul> <li>ligne 1\u00a0: il faut \u00eatre dans le dossier [packages] pour taper cette instruction\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-8.html#25313-la-classe-impotsdaowithhttpsessionfactory","title":"25.3.1.3. La classe [Imp\u00f4tsDaoWithHttpSessionFactory]","text":"<p>La classe [Imp\u00f4tsDaoWithHttpSessionFactory] est la suivante\u00a0:</p> <pre><code>from Imp\u00f4tsDaoWithHttpSession import Imp\u00f4tsDaoWithHttpSession\n\n\nclass Imp\u00f4tsDaoWithHttpSessionFactory:\n\n    def __init__(self, config: dict):\n        # on m\u00e9morise le param\u00e8tre\n        self.__config = config\n\n    def new_instance(self):\n        # on rend une instance de la couche [dao]\n        return Imp\u00f4tsDaoWithHttpSession(self.__config)\n</code></pre> <ul> <li>la classe [Imp\u00f4tsDaoWithHttpSessionFactory] permet de cr\u00e9er une nouvelle impl\u00e9mentation de la couche [dao] avec la m\u00e9thode [new_instance] des lignes 10-12\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-8.html#2532-la-configuration","title":"25.3.2. La configuration","text":"<p>Le script [config_layers] qui configure les couches du client web est modifi\u00e9 de la fa\u00e7on suivante\u00a0:</p> <pre><code>def configure(config: dict) -&gt; dict:\n    # instanciation des couches de l'applicatuon\n\n    # couche dao\n    from Imp\u00f4tsDaoWithHttpSessionFactory import Imp\u00f4tsDaoWithHttpSessionFactory\n    dao_factory = Imp\u00f4tsDaoWithHttpSessionFactory(config)\n\n    # on rend la configuation des couches\n    return {\n        \"dao_factory\": dao_factory\n    }\n</code></pre> <ul> <li>lignes 5-6\u00a0: au lieu d\u2019instancier une couche [dao] unique comme c\u2019\u00e9tait fait pr\u00e9c\u00e9demment, on instancie une \u2018factory\u2019 de cette couche (factory=usine de production d\u2019objets, ici la couche [dao])\u00a0;</li> <li>lignes 9-11\u00a0: on rend la configuration des couches\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-8.html#2533-le-script-principal-du-client","title":"25.3.3. Le script principal du client","text":"<p>Le script [main] \u00e9volue de la fa\u00e7on suivante par rapport \u00e0 celui de la version pr\u00e9c\u00e9dente\u00a0:</p> <pre><code># on configure l'application\n\nimport config\nconfig = config.configure({})\n\n# d\u00e9pendances\nfrom Imp\u00f4tsError import Imp\u00f4tsError\nimport random\nimport sys\nimport threading\nfrom Logger import Logger\n\n\n# ex\u00e9cution de la couche [dao] dans un thread\n# taxpayers est une liste de contribuables\ndef thread_function(thread_dao, logger, taxpayers: list):\n    \u2026\n\n\n# liste des threads du client\nthreads = []\nlogger = None\n# code\ntry:\n    \u2026\n    l_taxpayers = len(taxpayers)\n    while i &lt; len(taxpayers):\n        \u2026\n        # chaque thread doit avoir sa propre couche [dao] pour g\u00e9rer correctement son cookie de session\n        thread_dao = dao_factory.new_instance()\n        # on cr\u00e9e le thread\n        thread = threading.Thread(target=thread_function, args=(thread_dao, logger, thread_taxpayers))\n        # on l'ajoute \u00e0 la liste des threads du script principal\n        threads.append(thread)\n        # on lance le thread - cette op\u00e9ration est asynchrone - on n'attend pas le r\u00e9sultat du thread\n        thread.start()\n    # le thread principal attend la fin de tous les threads qu'il a lanc\u00e9s\n    \u2026\nexcept BaseException as erreur:\n    # affichage de l'erreur\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\nfinally:\n    # on ferme le logueur\n    if logger:\n        logger.close()\n    # on a fini\n    print(\"Travail termin\u00e9...\")\n    # fin des threads qui pourraient encore exister si on s'est arr\u00eat\u00e9 sur erreur\n    sys.exit()\n</code></pre> <ul> <li>lignes 29-30\u00a0: chaque thread a sa couche [dao]\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-8.html#2534-execution-du-client","title":"25.3.4. Ex\u00e9cution du client","text":"<p>Le serveur web est lanc\u00e9, le SGBD est lanc\u00e9, le serveur de mails [hMailServer] est lanc\u00e9. Puis on lance le script [main] du client web. Les logs de l\u2019ex\u00e9cution dans [data/logs/logs.txt] sont alors les suivants\u00a0:</p> <pre><code>2020-07-25 10:21:46.478511, Thread-1 : d\u00e9but du thread [Thread-1] avec 1 contribuable(s)\n2020-07-25 10:21:46.479111, Thread-1 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 1, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555}\n2020-07-25 10:21:46.479111, Thread-2 : d\u00e9but du thread [Thread-2] avec 1 contribuable(s)\n2020-07-25 10:21:46.480195, Thread-3 : d\u00e9but du thread [Thread-3] avec 2 contribuable(s)\n2020-07-25 10:21:46.480195, Thread-2 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 2, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 50000}\n2020-07-25 10:21:46.481137, Thread-4 : d\u00e9but du thread [Thread-4] avec 3 contribuable(s)\n2020-07-25 10:21:46.481137, Thread-3 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 3, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 50000}\n2020-07-25 10:21:46.482279, Thread-5 : d\u00e9but du thread [Thread-5] avec 3 contribuable(s)\n2020-07-25 10:21:46.482622, Thread-6 : d\u00e9but du thread [Thread-6] avec 1 contribuable(s)\n2020-07-25 10:21:46.482622, Thread-4 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 5, \"mari\u00e9\": \"non\", \"enfants\": 3, \"salaire\": 100000}\n2020-07-25 10:21:46.485923, Thread-5 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 8, \"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 100000}\n2020-07-25 10:21:46.485923, Thread-6 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 11, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000}\n2020-07-25 10:21:46.725910, Thread-4 : cookie de session={\"admindata\":{\"abattement_dixpourcent_max\":12502.0,\"abattement_dixpourcent_min\":437.0,\"coeffn\":[0.0,1394.96,5798.0,13913.7,20163.4],\"coeffr\":[0.0,0.14,0.3,0.41,0.45],\"id\":1,\"limites\":[9964.0,27519.0,73779.0,156244.0,90000.0],\"plafond_decote_celibataire\":1196.0,\"plafond_decote_couple\":1970.0,\"plafond_impot_celibataire_pour_decote\":1595.0,\"plafond_impot_couple_pour_decote\":2627.0,\"plafond_qf_demi_part\":1551.0,\"plafond_revenus_celibataire_pour_reduction\":21037.0,\"plafond_revenus_couple_pour_reduction\":42074.0,\"valeur_reduc_demi_part\":3797.0},\"client_id\":\"fa3c83b82761c83e13217967\"}\n2020-07-25 10:21:46.725910, Thread-4 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"non\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 16782, \"surc\u00f4te\": 7176, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-25 10:21:46.725910, Thread-4 : fin du calcul de l'imp\u00f4t de {\"id\": 5, \"mari\u00e9\": \"non\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 16782, \"surc\u00f4te\": 7176, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-25 10:21:46.726960, Thread-4 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 6, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 100000}\n2020-07-25 10:21:47.514108, Thread-3 : cookie de session={\"admindata\":{\"abattement_dixpourcent_max\":12502.0,\"abattement_dixpourcent_min\":437.0,\"coeffn\":[0.0,1394.96,5798.0,13913.7,20163.4],\"coeffr\":[0.0,0.14,0.3,0.41,0.45],\"id\":1,\"limites\":[9964.0,27519.0,73779.0,156244.0,24999.5],\"plafond_decote_celibataire\":1196.0,\"plafond_decote_couple\":1970.0,\"plafond_impot_celibataire_pour_decote\":1595.0,\"plafond_impot_couple_pour_decote\":2627.0,\"plafond_qf_demi_part\":1551.0,\"plafond_revenus_celibataire_pour_reduction\":21037.0,\"plafond_revenus_couple_pour_reduction\":42074.0,\"valeur_reduc_demi_part\":3797.0},\"client_id\":\"700e3f5dc808c7c48f0c9007\"}\n2020-07-25 10:21:47.514610, Thread-3 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 50000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 720, \"r\u00e9duction\": 0}}}\n2020-07-25 10:21:47.514939, Thread-3 : fin du calcul de l'imp\u00f4t de {\"id\": 3, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 50000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 720, \"r\u00e9duction\": 0}\n2020-07-25 10:21:47.514939, Thread-3 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 4, \"mari\u00e9\": \"non\", \"enfants\": 2, \"salaire\": 100000}\n2020-07-25 10:21:47.527211, Thread-5 : cookie de session={\"admindata\":{\"abattement_dixpourcent_max\":12502.0,\"abattement_dixpourcent_min\":437.0,\"coeffn\":[0.0,1394.96,5798.0,13913.7,20163.4],\"coeffr\":[0.0,0.14,0.3,0.41,0.45],\"id\":1,\"limites\":[9964.0,27519.0,73779.0,156244.0,90000.0],\"plafond_decote_celibataire\":1196.0,\"plafond_decote_couple\":1970.0,\"plafond_impot_celibataire_pour_decote\":1595.0,\"plafond_impot_couple_pour_decote\":2627.0,\"plafond_qf_demi_part\":1551.0,\"plafond_revenus_celibataire_pour_reduction\":21037.0,\"plafond_revenus_couple_pour_reduction\":42074.0,\"valeur_reduc_demi_part\":3797.0},\"client_id\":\"9e14a5d4a3057f69ab95ab2d\"}\n2020-07-25 10:21:47.527211, Thread-2 : cookie de session={\"admindata\":{\"abattement_dixpourcent_max\":12502.0,\"abattement_dixpourcent_min\":437.0,\"coeffn\":[0.0,1394.96,5798.0,13913.7,20163.4],\"coeffr\":[0.0,0.14,0.3,0.41,0.45],\"id\":1,\"limites\":[9964.0,27519.0,73779.0,156244.0,22500.0],\"plafond_decote_celibataire\":1196.0,\"plafond_decote_couple\":1970.0,\"plafond_impot_celibataire_pour_decote\":1595.0,\"plafond_impot_couple_pour_decote\":2627.0,\"plafond_qf_demi_part\":1551.0,\"plafond_revenus_celibataire_pour_reduction\":21037.0,\"plafond_revenus_couple_pour_reduction\":42074.0,\"valeur_reduc_demi_part\":3797.0},\"client_id\":\"a06e8fd70a44c9e311f4dce0\"}\n2020-07-25 10:21:47.527211, Thread-5 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 100000, \"imp\u00f4t\": 22986, \"surc\u00f4te\": 0, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-25 10:21:47.527211, Thread-1 : cookie de session={\"admindata\":{\"abattement_dixpourcent_max\":12502.0,\"abattement_dixpourcent_min\":437.0,\"coeffn\":[0.0,1394.96,5798.0,13913.7,20163.4],\"coeffr\":[0.0,0.14,0.3,0.41,0.45],\"id\":1,\"limites\":[9964.0,27519.0,73779.0,156244.0,90000.0],\"plafond_decote_celibataire\":1196.0,\"plafond_decote_couple\":1970.0,\"plafond_impot_celibataire_pour_decote\":1595.0,\"plafond_impot_couple_pour_decote\":2627.0,\"plafond_qf_demi_part\":1551.0,\"plafond_revenus_celibataire_pour_reduction\":21037.0,\"plafond_revenus_couple_pour_reduction\":42074.0,\"valeur_reduc_demi_part\":3797.0},\"client_id\":\"28c38df998f67685b3a482b8\"}\n2020-07-25 10:21:47.527211, Thread-2 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 50000, \"imp\u00f4t\": 1384, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 384, \"r\u00e9duction\": 347}}}\n2020-07-25 10:21:47.528341, Thread-5 : fin du calcul de l'imp\u00f4t de {\"id\": 8, \"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 100000, \"imp\u00f4t\": 22986, \"surc\u00f4te\": 0, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-25 10:21:47.528341, Thread-1 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555, \"imp\u00f4t\": 2814, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-25 10:21:47.528842, Thread-2 : fin du calcul de l'imp\u00f4t de {\"id\": 2, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 50000, \"imp\u00f4t\": 1384, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 384, \"r\u00e9duction\": 347}\n2020-07-25 10:21:47.529349, Thread-5 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 9, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 30000}\n2020-07-25 10:21:47.529699, Thread-1 : fin du calcul de l'imp\u00f4t de {\"id\": 1, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555, \"imp\u00f4t\": 2814, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-25 10:21:47.529699, Thread-2 : fin du thread [Thread-2]\n2020-07-25 10:21:47.531905, Thread-1 : fin du thread [Thread-1]\n2020-07-25 10:21:47.536121, Thread-6 : cookie de session={\"admindata\":{\"abattement_dixpourcent_max\":12502.0,\"abattement_dixpourcent_min\":437.0,\"coeffn\":[0.0,1394.96,5798.0,13913.7,20163.4],\"coeffr\":[0.0,0.14,0.3,0.41,0.45],\"id\":1,\"limites\":[9964.0,27519.0,73779.0,156244.0,93749.0],\"plafond_decote_celibataire\":1196.0,\"plafond_decote_couple\":1970.0,\"plafond_impot_celibataire_pour_decote\":1595.0,\"plafond_impot_couple_pour_decote\":2627.0,\"plafond_qf_demi_part\":1551.0,\"plafond_revenus_celibataire_pour_reduction\":21037.0,\"plafond_revenus_couple_pour_reduction\":42074.0,\"valeur_reduc_demi_part\":3797.0},\"client_id\":\"38499b63076516c02f2770ec\"}\n2020-07-25 10:21:47.537161, Thread-3 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"non\", \"enfants\": 2, \"salaire\": 100000, \"imp\u00f4t\": 19884, \"surc\u00f4te\": 4480, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-25 10:21:47.537161, Thread-6 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000, \"imp\u00f4t\": 42842, \"surc\u00f4te\": 17283, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-25 10:21:47.538156, Thread-3 : fin du calcul de l'imp\u00f4t de {\"id\": 4, \"mari\u00e9\": \"non\", \"enfants\": 2, \"salaire\": 100000, \"imp\u00f4t\": 19884, \"surc\u00f4te\": 4480, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-25 10:21:47.538557, Thread-6 : fin du calcul de l'imp\u00f4t de {\"id\": 11, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000, \"imp\u00f4t\": 42842, \"surc\u00f4te\": 17283, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-25 10:21:47.538828, Thread-3 : fin du thread [Thread-3]\n2020-07-25 10:21:47.538828, Thread-6 : fin du thread [Thread-6]\n2020-07-25 10:21:47.546198, Thread-5 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 30000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.0, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-25 10:21:47.546198, Thread-5 : fin du calcul de l'imp\u00f4t de {\"id\": 9, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 30000, \"imp\u00f4t\": 0, \"surc\u00f4te\": 0, \"taux\": 0.0, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-25 10:21:47.546198, Thread-5 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 10, \"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 200000}\n2020-07-25 10:21:47.739643, Thread-4 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 9200, \"surc\u00f4te\": 2180, \"taux\": 0.3, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-25 10:21:47.739643, Thread-4 : fin du calcul de l'imp\u00f4t de {\"id\": 6, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 9200, \"surc\u00f4te\": 2180, \"taux\": 0.3, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-25 10:21:47.740668, Thread-4 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 7, \"mari\u00e9\": \"oui\", \"enfants\": 5, \"salaire\": 100000}\n2020-07-25 10:21:48.557469, Thread-5 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 200000, \"imp\u00f4t\": 64210, \"surc\u00f4te\": 7498, \"taux\": 0.45, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-25 10:21:48.558715, Thread-5 : fin du calcul de l'imp\u00f4t de {\"id\": 10, \"mari\u00e9\": \"non\", \"enfants\": 0, \"salaire\": 200000, \"imp\u00f4t\": 64210, \"surc\u00f4te\": 7498, \"taux\": 0.45, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-25 10:21:48.558715, Thread-5 : fin du thread [Thread-5]\n2020-07-25 10:21:48.753025, Thread-4 : {\"r\u00e9ponse\": {\"result\": {\"mari\u00e9\": \"oui\", \"enfants\": 5, \"salaire\": 100000, \"imp\u00f4t\": 4230, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}}}\n2020-07-25 10:21:48.753318, Thread-4 : fin du calcul de l'imp\u00f4t de {\"id\": 7, \"mari\u00e9\": \"oui\", \"enfants\": 5, \"salaire\": 100000, \"imp\u00f4t\": 4230, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-25 10:21:48.753540, Thread-4 : fin du thread [Thread-4]\n</code></pre> <ul> <li>on a au total 6 threads donc 6 clients (lignes 1, 3, 4, 6, 8, 9)\u00a0qui interrogent simultan\u00e9ment le serveur de calcul de l\u2019imp\u00f4t\u00a0;</li> <li>nous allons suivre le thread [Thread-4] qui g\u00e8re 3 contribuables (ligne 6). Il va faire s\u00e9quentiellement trois requ\u00eates au serveur de calcul de l\u2019imp\u00f4t\u00a0;</li> <li>ligne 10\u00a0: la 1\u00e8re requ\u00eate de [Thread-4]\u00a0;</li> <li>ligne 13\u00a0: [Thread-4] a re\u00e7u la r\u00e9ponse \u00e0 sa 1\u00e8re requ\u00eate. Dedans elle trouve un cookie de session dans lequel il y a le n\u00b0 [fa3c83b82761c83e13217967] que lui a attribu\u00e9 le serveur\u00a0;</li> <li>ligne 14\u00a0: l\u2019imp\u00f4t du 1er contribuable\u00a0;</li> <li>ligne 16\u00a0: [Thread-4] fait une requ\u00eate pour le 2i\u00e8me contribuable\u00a0;</li> <li>ligne 43\u00a0: [Thread-4] re\u00e7oit l\u2019imp\u00f4t du 2i\u00e8me contribuable\u00a0;</li> <li>ligne 45\u00a0: [Thread-4] fait une requ\u00eate pour le 3i\u00e8me contribuable\u00a0;</li> <li>ligne 49\u00a0: [Thread-4] re\u00e7oit l\u2019imp\u00f4t du 3i\u00e8me contribuable\u00a0;</li> <li>ligne 51\u00a0: [Thread-4] a termin\u00e9 son travail\u00a0; Maintenant, regardons comment les 3 requ\u00eates de [Thread-4] ont \u00e9t\u00e9 trait\u00e9es c\u00f4t\u00e9 serveur. On va pouvoir le suivre dans les logs du serveur gr\u00e2ce \u00e0 son n\u00b0 de client [fa3c83b82761c83e13217967].</li> </ul> <p>Les logs [data/logs/logs.txt] c\u00f4t\u00e9 serveur sont les suivants\u00a0:</p> <pre><code>2020-07-25 10:21:39.187366, MainThread : [serveur] d\u00e9marrage du serveur\n2020-07-25 10:21:40.439093, MainThread : [serveur] d\u00e9marrage du serveur\n2020-07-25 10:21:46.502011, Thread-2 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=3&amp;salaire=50000' [GET]&gt;\n2020-07-25 10:21:46.504049, Thread-2 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-25 10:21:46.505452, Thread-3 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=2&amp;salaire=55555' [GET]&gt;\n2020-07-25 10:21:46.506257, Thread-3 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-25 10:21:46.507292, Thread-4 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=non&amp;enfants=0&amp;salaire=100000' [GET]&gt;\n2020-07-25 10:21:46.507292, Thread-4 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-25 10:21:46.508301, Thread-5 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=2&amp;salaire=50000' [GET]&gt;\n2020-07-25 10:21:46.509293, Thread-5 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-25 10:21:46.511808, Thread-6 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=non&amp;enfants=3&amp;salaire=100000' [GET]&gt;\n2020-07-25 10:21:46.517604, Thread-7 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=3&amp;salaire=200000' [GET]&gt;\n2020-07-25 10:21:46.517604, Thread-7 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-25 10:21:46.719504, Thread-6 : [index_controller] client [fa3c83b82761c83e13217967], donn\u00e9es fiscales prises dans la couche dao\n2020-07-25 10:21:46.720003, Thread-6 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'non', 'enfants': 3, 'salaire': 100000, 'imp\u00f4t': 16782, 'surc\u00f4te': 7176, 'taux': 0.41, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-25 10:21:46.736108, Thread-8 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=3&amp;salaire=100000' [GET]&gt;\n2020-07-25 10:21:46.736108, Thread-8 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-25 10:21:47.506709, Thread-2 : [index_controller] client [700e3f5dc808c7c48f0c9007], donn\u00e9es fiscales prises dans la couche dao\n2020-07-25 10:21:47.507216, Thread-2 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 50000, 'imp\u00f4t': 0, 'surc\u00f4te': 0, 'taux': 0.14, 'd\u00e9c\u00f4te': 720, 'r\u00e9duction': 0}}}\n2020-07-25 10:21:47.507216, Thread-3 : [index_controller] client [28c38df998f67685b3a482b8], donn\u00e9es fiscales prises dans la couche dao\n2020-07-25 10:21:47.508442, Thread-4 : [index_controller] client [9e14a5d4a3057f69ab95ab2d], donn\u00e9es fiscales prises dans la couche dao\n2020-07-25 10:21:47.508940, Thread-3 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 55555, 'imp\u00f4t': 2814, 'surc\u00f4te': 0, 'taux': 0.14, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-25 10:21:47.510506, Thread-4 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'non', 'enfants': 0, 'salaire': 100000, 'imp\u00f4t': 22986, 'surc\u00f4te': 0, 'taux': 0.41, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-25 10:21:47.511513, Thread-5 : [index_controller] client [a06e8fd70a44c9e311f4dce0], donn\u00e9es fiscales prises dans la couche dao\n2020-07-25 10:21:47.514939, Thread-5 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 50000, 'imp\u00f4t': 1384, 'surc\u00f4te': 0, 'taux': 0.14, 'd\u00e9c\u00f4te': 384, 'r\u00e9duction': 347}}}\n2020-07-25 10:21:47.520727, Thread-7 : [index_controller] client [38499b63076516c02f2770ec], donn\u00e9es fiscales prises dans la couche dao\n2020-07-25 10:21:47.523162, Thread-7 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 200000, 'imp\u00f4t': 42842, 'surc\u00f4te': 17283, 'taux': 0.41, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-25 10:21:47.530835, Thread-9 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=non&amp;enfants=2&amp;salaire=100000' [GET]&gt;\n2020-07-25 10:21:47.531736, Thread-9 : [index_controller] client [700e3f5dc808c7c48f0c9007], donn\u00e9es fiscales prises en session\n2020-07-25 10:21:47.531905, Thread-9 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'non', 'enfants': 2, 'salaire': 100000, 'imp\u00f4t': 19884, 'surc\u00f4te': 4480, 'taux': 0.41, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-25 10:21:47.541899, Thread-10 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=2&amp;salaire=30000' [GET]&gt;\n2020-07-25 10:21:47.542488, Thread-10 : [index_controller] client [9e14a5d4a3057f69ab95ab2d], donn\u00e9es fiscales prises en session\n2020-07-25 10:21:47.542488, Thread-10 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 30000, 'imp\u00f4t': 0, 'surc\u00f4te': 0, 'taux': 0.0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-25 10:21:47.553628, Thread-11 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=non&amp;enfants=0&amp;salaire=200000' [GET]&gt;\n2020-07-25 10:21:47.553628, Thread-11 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-25 10:21:47.736910, Thread-8 : [index_controller] client [fa3c83b82761c83e13217967], donn\u00e9es fiscales prises en session\n2020-07-25 10:21:47.737191, Thread-8 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 100000, 'imp\u00f4t': 9200, 'surc\u00f4te': 2180, 'taux': 0.3, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-25 10:21:47.748226, Thread-12 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=5&amp;salaire=100000' [GET]&gt;\n2020-07-25 10:21:47.748226, Thread-12 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-25 10:21:48.554695, Thread-11 : [index_controller] client [9e14a5d4a3057f69ab95ab2d], donn\u00e9es fiscales prises en session\n2020-07-25 10:21:48.555070, Thread-11 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'non', 'enfants': 0, 'salaire': 200000, 'imp\u00f4t': 64210, 'surc\u00f4te': 7498, 'taux': 0.45, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-25 10:21:48.748753, Thread-12 : [index_controller] client [fa3c83b82761c83e13217967], donn\u00e9es fiscales prises en session\n2020-07-25 10:21:48.748753, Thread-12 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 5, 'salaire': 100000, 'imp\u00f4t': 4230, 'surc\u00f4te': 0, 'taux': 0.14, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n</code></pre> <ul> <li>on trouve le client [fa3c83b82761c83e13217967] pour la 1\u00e8re fois en ligne 14\u00a0: pour calculer l\u2019imp\u00f4t, le serveur a d\u00fb aller chercher en base les donn\u00e9es de l\u2019administration fiscale\u00a0;</li> <li>puis on retrouve le client [fa3c83b82761c83e13217967] en ligne 36. Cette fois-ci, le serveur trouve les donn\u00e9es de l\u2019administration fiscale en session, ce qui lui \u00e9vite un acc\u00e8s, possiblement co\u00fbteux, \u00e0 la couche [dao]\u00a0;</li> <li>on retrouve le client [fa3c83b82761c83e13217967] une 3i\u00e8me fois en ligne 42, o\u00f9 l\u00e0 encore le serveur utilise la session du client\u00a0; Cet exemple montre bien l\u2019int\u00e9r\u00eat de la session pour un client\u00a0: on y met des donn\u00e9es partag\u00e9es par toutes les requ\u00eates de ce client et qui sont co\u00fbteuses \u00e0 acqu\u00e9rir.</li> </ul> <p>C\u00f4t\u00e9 client, les r\u00e9sultats dans le fichier [data/output/r\u00e9sultats.json] sont les m\u00eames que pour les versions pr\u00e9c\u00e9dentes.</p>"},{"location":"exercice-dapplication-version-8.html#254-tests-de-la-couche-dao","title":"25.4. Tests de la couche [dao]","text":"<p>Comme nous l\u2019avons fait dans les |versions pr\u00e9c\u00e9dentes| nous testons la couche [dao] du client\u00a0:</p> <p></p> <p>La classe de test sera ex\u00e9cut\u00e9e dans l\u2019environnement suivant\u00a0:</p> <p></p> <ul> <li>la configuration [2] est identique \u00e0 la configuration [1] que nous venons d\u2019\u00e9tudier\u00a0; La classe de test [TestHttpClientDao] est la suivante\u00a0:</li> </ul> <pre><code>import unittest\n\nfrom Logger import Logger\n\n\nclass TestHttpClientDao(unittest.TestCase):\n\n    def test_1(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 55555,\n        # 'imp\u00f4t': 2814, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.14}\n        taxpayer = TaxPayer().fromdict({\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555})\n        dao.calculate_tax(taxpayer)\n        # v\u00e9rification\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 2815, delta=1)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.14, delta=0.01)\n        self.assertEqual(taxpayer.surc\u00f4te, 0)\n\u2026\n\n\nif __name__ == '__main__':\n    # on configure l'application\n    import config\n    config = config.configure({})\n\n    # logger\n    logger = Logger(config[\"logsFilename\"])\n    # on le m\u00e9morise dans la config\n    config[\"logger\"] = logger\n    # on r\u00e9cup\u00e8re la factory de la couche [dao]\n    dao_factory = config[\"layers\"][\"dao_factory\"]\n    # on cr\u00e9e une instance de la couche [dao]\n    dao = dao_factory.new_instance()\n\n    # on ex\u00e9cute les m\u00e9thodes de test\n    print(\"tests en cours...\")\n    unittest.main()\n</code></pre> <ul> <li>on cr\u00e9e une |configuration d\u2019ex\u00e9cution| pour ce test\u00a0;</li> <li>on lance le serveur web avec tout son environnement\u00a0;</li> <li>on ex\u00e9cute le test\u00a0; Les r\u00e9sultats sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots/http-clients/03/tests/TestHttpClientDao.py\ntests en cours...\n...........\n----------------------------------------------------------------------\nRan 11 tests in 3.392s\n\nOK\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"exercice-dapplication-version-9.html","title":"27. Exercice d\u2019application\u00a0: version 9","text":"<p>Nous revenons \u00e0 la version 7 de l\u2019exercice d\u2019application et au lieu que le client et le serveur web s\u2019\u00e9changent des cha\u00eenes jSON ils vont ici s\u2019\u00e9changer du XML.</p> <p>L\u2019architecture reste la m\u00eame\u00a0:</p> <p></p>"},{"location":"exercice-dapplication-version-9.html#271-le-serveur-web","title":"27.1. Le serveur web","text":"<p>Le dossier [http-servers/04] est obtenue par recopie du dossier [http-servers/02] \u00e0 l\u2019exception du sous-dossier [utilities]. Puis on change les \u00e9l\u00e9ments suivants\u00a0:</p> <p></p> <p>Le fichier [config] est modifi\u00e9 de la fa\u00e7on suivante\u00a0:</p> <pre><code>    # d\u00e9pendances absolues\n    absolute_dependencies = [\n        # dossiers du projet\n        # BaseEntity, MyException\n        f\"{root_dir}/classes/02/entities\",\n        # InterfaceImp\u00f4tsDao, InterfaceImp\u00f4tsM\u00e9tier, InterfaceImp\u00f4tsUi\n        f\"{root_dir}/impots/v04/interfaces\",\n        # AbstractImp\u00f4tsdao, Imp\u00f4tsConsole, Imp\u00f4tsM\u00e9tier\n        f\"{root_dir}/impots/v04/services\",\n        # ImpotsDaoWithAdminDataInDatabase\n        f\"{root_dir}/impots/v05/services\",\n        # AdminData, Imp\u00f4tsError, TaxPayer\n        f\"{root_dir}/impots/v04/entities\",\n        # Constantes, tranches\n        f\"{root_dir}/impots/v05/entities\",\n        # index_controller\n        f\"{root_dir}/impots/http-servers/01/controllers\",\n        # scripts [config_database, config_layers]\n        script_dir,\n        # Logger, SendAdminMail\n        f\"{root_dir}/impots/http-servers/02/utilities\",\n    ]\n</code></pre> <ul> <li>ligne 21\u00a0: on indique le dossier des utilitaires qui sont rest\u00e9s dans [http-servers/02]\u00a0; Le script principal [main] \u00e9volue de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code># Home URL\n@app.route('/', methods=['GET'])\n@auth.login_required\ndef index():\n    logger = None\n    try:\n        # logger\n        logger = Logger(config[\"logsFilename\"])\n        # on le m\u00e9morise dans une config associ\u00e9e au thread\n        thread_config = {\"logger\": logger}\n        thread_name = threading.current_thread().name\n        config[thread_name] = {\"config\": thread_config}\n        # on logue la requ\u00eate\n        logger.write(f\"[index] requ\u00eate : {request}\\n\")\n        \u2026\n        # on fait ex\u00e9cuter la requ\u00eate par un contr\u00f4leur\n        r\u00e9sultat, status_code = index_controller.execute(request, config)\n        # y-a-t-il eu une erreur fatale ?\n        \u2026\n        # on logue la r\u00e9ponse\n        logger.write(f\"[index] {r\u00e9sultat}\\n\")\n        # on envoie la r\u00e9ponse\n        return xml_response(r\u00e9sultat, status_code)\n    except BaseException as erreur:\n        # on logue l'erreur si c'est possible\n        if logger:\n            logger.write(f\"[index] {erreur}\")\n        # on pr\u00e9pare la r\u00e9ponse au client\n        r\u00e9sultat = {\"r\u00e9ponse\": {\"erreurs\": [f\"{erreur}\"]}}\n        # on envoie la r\u00e9ponse\n        return xml_response(r\u00e9sultat, status.HTTP_500_INTERNAL_SERVER_ERROR)\n    finally:\n        # on ferme le fichier de logs s'il a \u00e9t\u00e9 ouvert\n        if logger:\n            logger.close()\n</code></pre> <ul> <li>l\u2019unique modification est ligne 23\u00a0: on envoie d\u00e9sormais une r\u00e9ponse XML\u00a0; La fonction [xml_response] est d\u00e9finie dans le module [myutils]\u00a0:</li> </ul> <pre><code>import xmltodict\n\u2026\ndef xml_response(r\u00e9sultat: dict, status_code: int) -&gt; tuple:\n    # r\u00e9sultat : le dictionnaire \u00e0 transformer en cha\u00eene XML\n    xmlString = xmltodict.unparse(r\u00e9sultat)\n    # on rend la r\u00e9ponse HTTP\n    response = make_response(xmlString)\n    response.headers['Content-Type'] = 'application/xml; charset=utf-8'\n    return response, status_code\n</code></pre> <ul> <li>ligne 3\u00a0: la fonction [xml_response] re\u00e7oit en param\u00e8tres\u00a0:</li> <li>le dictionnaire [r\u00e9sultat] \u00e0 transformer en XML\u00a0;</li> <li>le code de statut [status_code] \u00e0 renvoyer au client web\u00a0;</li> <li>ligne 5\u00a0: on utilise la biblioth\u00e8que [xmltodict] pour produire la cha\u00eene XML\u00a0;</li> <li>ligne 8\u00a0: on utilise l\u2019ent\u00eate [Content-Type] pour dire au client qu\u2019on lui envoie du XML\u00a0; La fonction [xml_response] doit \u00eatre import\u00e9e dans le script [init.py]\u00a0:</li> </ul> <pre><code>from .myutils import set_syspath, json_response, decode_flask_session, xml_response\n</code></pre> <p>Puis le module [myutils] doit \u00eatre incorpor\u00e9 dans les modules de port\u00e9e machine. Cela se fait dans un terminal PyCharm\u00a0avec la commande [pip install .] (dans le dossier packages).</p>"},{"location":"exercice-dapplication-version-9.html#272-le-client-web","title":"27.2. Le client web","text":""},{"location":"exercice-dapplication-version-9.html#2721-le-code","title":"27.2.1. Le code","text":"<p>Le dossier [http-clients/04] est obtenu par recopie du client [http-clients/02]. Puis nous modifions la classe [Imp\u00f4tsDaoWithHttpClient] de la fa\u00e7on suivante\u00a0:</p> <pre><code># imports\n\nimport requests\nimport xmltodict\nfrom flask_api import status\n\nfrom AbstractImp\u00f4tsDao import AbstractImp\u00f4tsDao\nfrom AdminData import AdminData\nfrom Imp\u00f4tsError import Imp\u00f4tsError\nfrom InterfaceImp\u00f4tsM\u00e9tier import InterfaceImp\u00f4tsM\u00e9tier\nfrom TaxPayer import TaxPayer\n\n\nclass Imp\u00f4tsDaoWithHttpClient(AbstractImp\u00f4tsDao, InterfaceImp\u00f4tsM\u00e9tier):\n\n    # constructeur\n    def __init__(self, config: dict):\n        \u2026\n\n    # m\u00e9thode inutilis\u00e9e\n    def get_admindata(self) -&gt; AdminData:\n        pass\n\n    # calcul de l'imp\u00f4t\n    def calculate_tax(self, taxpayer: TaxPayer, admindata: AdminData = None):\n        \u2026.\n        # code de statut de la r\u00e9ponse HTTP\n        status_code = response.status_code\n        # on met la r\u00e9ponse XML dans un dictionnaire\n        r\u00e9sultat = xmltodict.parse(response.text[39:])\n        # erreur si code de statut diff\u00e9rent de 200 OK\n        \u2026.\n</code></pre> <ul> <li>ligne 30\u00a0: la r\u00e9ponse HTTP [response] du serveur web est d\u00e9sormais une cha\u00eene XML. Les logs montrent la nature de celle-ci\u00a0: <pre><code>2020-07-27 15:53:47.886283, Thread-2 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;r\u00e9ponse&gt;&lt;result&gt;&lt;mari\u00e9&gt;non&lt;/mari\u00e9&gt;&lt;enfants&gt;2&lt;/enfants&gt;&lt;salaire&gt;100000&lt;/salaire&gt;&lt;imp\u00f4t&gt;19884&lt;/imp\u00f4t&gt;&lt;surc\u00f4te&gt;4480&lt;/surc\u00f4te&gt;&lt;taux&gt;0.41&lt;/taux&gt;&lt;d\u00e9c\u00f4te&gt;0&lt;/d\u00e9c\u00f4te&gt;&lt;r\u00e9duction&gt;0&lt;/r\u00e9duction&gt;&lt;/result&gt;&lt;/r\u00e9ponse&gt;\n</code></pre></li> </ul> <p>La cha\u00eene [&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;] compte 38 caract\u00e8res. Par ailleurs, si on regarde le fichier de logs avec un \u00e9diteur hexad\u00e9cimal, on voit que derri\u00e8re cette cha\u00eene il y a un caract\u00e8re de saut de ligne \\n. Puis vient la r\u00e9ponse &lt;r\u00e9ponse&gt;\u2026&lt;/r\u00e9ponse&gt;. La cha\u00eene XML que nous devons convertir commence donc apr\u00e8s les 39 premiers caract\u00e8res de la cha\u00eene XML. Elle commence \u00e0 partir du caract\u00e8re n\u00b0 39, le 1er caract\u00e8re \u00e9tant num\u00e9rot\u00e9 0. Cette cha\u00eene est obtenue par l\u2019expression [response.text[39:]].</p> <p>Si nous ex\u00e9cutons le client (suivez la proc\u00e9dure des exemples pr\u00e9c\u00e9dents), nous obtenons les m\u00eames r\u00e9sultats dans le fichier [r\u00e9sultats.json] que dans les versions pr\u00e9c\u00e9dentes. Les logs sont eux les suivants\u00a0:</p> <pre><code>2020-07-27 16:21:14.015941, Thread-1 : d\u00e9but du thread [Thread-1] avec 2 contribuable(s)\n2020-07-27 16:21:14.016940, Thread-1 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 1, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555}\n2020-07-27 16:21:14.016940, Thread-2 : d\u00e9but du thread [Thread-2] avec 3 contribuable(s)\n2020-07-27 16:21:14.018939, Thread-2 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 3, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 50000}\n2020-07-27 16:21:14.019979, Thread-3 : d\u00e9but du thread [Thread-3] avec 3 contribuable(s)\n2020-07-27 16:21:14.019979, Thread-3 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 6, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 100000}\n2020-07-27 16:21:14.021938, Thread-4 : d\u00e9but du thread [Thread-4] avec 2 contribuable(s)\n2020-07-27 16:21:14.021938, Thread-4 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 9, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 30000}\n2020-07-27 16:21:14.021938, Thread-5 : d\u00e9but du thread [Thread-5] avec 1 contribuable(s)\n2020-07-27 16:21:14.022939, Thread-5 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 11, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000}\n2020-07-27 16:21:14.031942, Thread-1 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;r\u00e9ponse&gt;&lt;result&gt;&lt;mari\u00e9&gt;oui&lt;/mari\u00e9&gt;&lt;enfants&gt;2&lt;/enfants&gt;&lt;salaire&gt;55555&lt;/salaire&gt;&lt;imp\u00f4t&gt;2814&lt;/imp\u00f4t&gt;&lt;surc\u00f4te&gt;0&lt;/surc\u00f4te&gt;&lt;taux&gt;0.14&lt;/taux&gt;&lt;d\u00e9c\u00f4te&gt;0&lt;/d\u00e9c\u00f4te&gt;&lt;r\u00e9duction&gt;0&lt;/r\u00e9duction&gt;&lt;/result&gt;&lt;/r\u00e9ponse&gt;\n2020-07-27 16:21:14.031942, Thread-1 : fin du calcul de l'imp\u00f4t de {\"id\": 1, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555, \"imp\u00f4t\": 2814, \"surc\u00f4te\": 0, \"taux\": 0.14, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-27 16:21:14.031942, Thread-1 : d\u00e9but du calcul de l'imp\u00f4t de {\"id\": 2, \"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 50000}\n2020-07-27 16:21:14.034941, Thread-4 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;r\u00e9ponse&gt;&lt;result&gt;&lt;mari\u00e9&gt;oui&lt;/mari\u00e9&gt;&lt;enfants&gt;2&lt;/enfants&gt;&lt;salaire&gt;30000&lt;/salaire&gt;&lt;imp\u00f4t&gt;0&lt;/imp\u00f4t&gt;&lt;surc\u00f4te&gt;0&lt;/surc\u00f4te&gt;&lt;taux&gt;0.0&lt;/taux&gt;&lt;d\u00e9c\u00f4te&gt;0&lt;/d\u00e9c\u00f4te&gt;&lt;r\u00e9duction&gt;0&lt;/r\u00e9duction&gt;&lt;/result&gt;&lt;/r\u00e9ponse&gt;\n\u2026\n2020-07-27 16:21:17.055931, Thread-3 : fin du thread [Thread-3]\n2020-07-27 16:21:17.059930, Thread-2 : &lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;r\u00e9ponse&gt;&lt;result&gt;&lt;mari\u00e9&gt;non&lt;/mari\u00e9&gt;&lt;enfants&gt;3&lt;/enfants&gt;&lt;salaire&gt;100000&lt;/salaire&gt;&lt;imp\u00f4t&gt;16782&lt;/imp\u00f4t&gt;&lt;surc\u00f4te&gt;7176&lt;/surc\u00f4te&gt;&lt;taux&gt;0.41&lt;/taux&gt;&lt;d\u00e9c\u00f4te&gt;0&lt;/d\u00e9c\u00f4te&gt;&lt;r\u00e9duction&gt;0&lt;/r\u00e9duction&gt;&lt;/result&gt;&lt;/r\u00e9ponse&gt;\n2020-07-27 16:21:17.060971, Thread-2 : fin du calcul de l'imp\u00f4t de {\"id\": 5, \"mari\u00e9\": \"non\", \"enfants\": 3, \"salaire\": 100000, \"imp\u00f4t\": 16782, \"surc\u00f4te\": 7176, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n2020-07-27 16:21:17.060971, Thread-2 : fin du thread [Thread-2]\n</code></pre> <p>C\u00f4t\u00e9 serveur, les logs sont les suivants\u00a0:</p> <pre><code>2020-07-27 16:32:04.983020, Thread-46 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=2&amp;salaire=50000' [GET]&gt;\n2020-07-27 16:32:04.983020, Thread-46 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-27 16:32:04.984021, Thread-47 : [index] requ\u00eate : &lt;Request 'http://127.0.0.1:5000/?mari\u00e9=oui&amp;enfants=2&amp;salaire=55555' [GET]&gt;\n2020-07-27 16:32:04.984021, Thread-47 : [index] mis en pause du thread pendant 1 seconde(s)\n\u2026\n2020-07-27 16:32:07.001271, Thread-56 : [index] mis en pause du thread pendant 1 seconde(s)\n2020-07-27 16:32:07.003078, Thread-54 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 5, 'salaire': 100000, 'imp\u00f4t': 4230, 'surc\u00f4te': 0, 'taux': 0.14, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-27 16:32:07.006078, Thread-55 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 200000, 'imp\u00f4t': 42842, 'surc\u00f4te': 17283, 'taux': 0.41, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n2020-07-27 16:32:08.002824, Thread-56 : [index] {'r\u00e9ponse': {'result': {'mari\u00e9': 'non', 'enfants': 2, 'salaire': 100000, 'imp\u00f4t': 19884, 'surc\u00f4te': 4480, 'taux': 0.41, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0}}}\n</code></pre> <ul> <li>le logueur continue \u00e0 \u00e9crire le dictionnaire de la r\u00e9ponse et non la cha\u00eene XML qui est envoy\u00e9e au client. Ce n\u2019est pas une erreur et c\u2019est voulu\u00a0;</li> </ul>"},{"location":"exercice-dapplication-version-9.html#2722-test-de-la-couche-dao-du-client","title":"27.2.2. Test de la couche [dao] du client","text":"<p>La classe de test [TestHttpClientDao] est la m\u00eame que dans la |version 7| et donne les m\u00eames r\u00e9sultats.</p>"},{"location":"exercice-dx27application---version-1.html","title":"8. Exercice d'application \u2013 version 1","text":""},{"location":"exercice-dx27application---version-1.html#81-le-probleme","title":"8.1. Le probl\u00e8me","text":"<p>Le tableau ci-dessus permet de calculer l\u2019imp\u00f4t dans le cas simplifi\u00e9 d'un contribuable n'ayant que son seul salaire \u00e0 d\u00e9clarer. Comme l\u2019indique la note (1), l\u2019imp\u00f4t ainsi calcul\u00e9 est l\u2019imp\u00f4t avant trois m\u00e9canismes\u00a0:</p> <ul> <li>le plafonnement du quotient familial qui intervient pour les hauts revenus\u00a0;</li> <li>la d\u00e9cote et la r\u00e9duction d\u2019imp\u00f4ts qui interviennent pour les faibles revenus\u00a0; Ainsi le calcul de l\u2019imp\u00f4t comprend les \u00e9tapes suivantes [http://impotsurlerevenu.org/comprendre-le-calcul-de-l-impot/1217-calcul-de-l-impot-2019.php]\u00a0:</li> </ul> <p></p> <p>On se propose d'\u00e9crire un programme permettant de calculer l'imp\u00f4t d'un contribuable dans le cas simplifi\u00e9 d'un contribuable n'ayant que son seul salaire \u00e0 d\u00e9clarer\u00a0:</p>"},{"location":"exercice-dx27application---version-1.html#811-calcul-de-limpot-brut","title":"8.1.1. Calcul de l\u2019imp\u00f4t brut","text":"<p>L\u2019imp\u00f4t brut peut \u00eatre calcul\u00e9 de la fa\u00e7on suivante\u00a0:</p> <p>On calcule d\u2019abord le nombre de parts du contribuable\u00a0:</p> <ul> <li>chaque parent am\u00e8ne 1 part\u00a0;</li> <li>les deux premiers enfants am\u00e8nent chacun 1/2 part\u00a0;</li> <li> <p>les enfants suivants am\u00e8nent une part chacun\u00a0: Le nombre de parts est donc\u00a0:</p> </li> <li> <p>nbParts=1+nbEnfants*0,5+(nbEnfants-2)*0,5 si le salari\u00e9 n\u2019est pas mari\u00e9\u00a0;</p> </li> <li>nbParts=2+nbEnfants*0,5+(nbEnfants-2)*0,5 s'il est mari\u00e9\u00a0;</li> <li>o\u00f9 nbEnfants est son nombre d'enfants\u00a0;</li> <li>on calcule le revenu imposable R=0.9*S o\u00f9 S est le salaire annuel\u00a0;</li> <li>on calcule le quotient familial QF=R/nbParts\u00a0;</li> <li>on calcule l\u2019imp\u00f4t brut I d'apr\u00e8s les donn\u00e9es suivantes (2019)\u00a0:</li> </ul> <p>9964</p><p>0</p><p>0</p><p>27519    </p><p>0.14</p><p>1394.96</p><p>73779    </p><p>0.3</p><p>5798</p><p>156244    </p><p>0.4</p><p>13913.69</p><p>0    </p><p>0.45</p><p>20163.45</p> <p>Chaque ligne a 3 champs\u00a0: champ1, champ2, champ3. Pour calculer l'imp\u00f4t I, on recherche la premi\u00e8re ligne o\u00f9 QF&lt;=champ1 et on prend les valeurs de cette ligne. Par exemple, pour un salari\u00e9 mari\u00e9 avec deux enfants et un salaire annuel S de 50000 euros\u00a0:</p> <p>Revenu imposable\u00a0: R=0,9*S=45000</p> <p>Nombre de parts\u00a0: nbParts=2+2*0,5=3</p> <p>Quotient familial\u00a0: QF=45000/3=15000</p> <p>La 1re ligne o\u00f9 QF&lt;=champ1 est la suivante\u00a0:</p> <pre><code>    27519    0.14    1394.96\n</code></pre> <p>L'imp\u00f4t I est alors \u00e9gal \u00e0 0.14*R \u2013 1394,96*nbParts=[0,14*45000-1394,96*3]=2115. L\u2019imp\u00f4t est arrondi \u00e0 l\u2019euro inf\u00e9rieur.</p> <p>Si la relation QF&lt;=champ1 d\u00e8s la 1re ligne, alors l\u2019imp\u00f4t est nul.</p> <p>Si QF est tel que la relation QF&lt;=champ1 n'est jamais v\u00e9rifi\u00e9e, alors ce sont les coefficients de la derni\u00e8re ligne qui sont utilis\u00e9s. Ici\u00a0:</p> <pre><code>    0    0.45    20163.45\n</code></pre> <p>ce qui donne l'imp\u00f4t brut I=0.45*R \u2013 20163,45*nbParts.</p>"},{"location":"exercice-dx27application---version-1.html#812-plafonnement-du-quotient-familial","title":"8.1.2. Plafonnement du quotient familial","text":"<p>Pour savoir si le plafonnement du quotient familial QF s\u2019applique, on refait le calcul de l\u2019imp\u00f4t brut sans les enfants. Toujours pour le salari\u00e9 mari\u00e9 avec deux enfants et un salaire annuel S de 50000 euros\u00a0:</p> <p>Revenu imposable\u00a0: R=0,9*S=45000</p> <p>Nombre de parts\u00a0: nbParts=2 (on ne compte plus les enfants)</p> <p>Quotient familial\u00a0: QF=45000/2=22500</p> <p>La 1re ligne o\u00f9 QF&lt;=champ1 est la suivante\u00a0:</p> <pre><code>    27519    0.14    1394.96\n</code></pre> <p>L'imp\u00f4t I est alors \u00e9gal \u00e0 0.14*R \u2013 1394,96*nbParts=[0,14*45000-1394,96*2]=3510.</p> <p>Gain maximal li\u00e9 aux enfants\u00a0: 1551 * 2  = 3102 euros</p> <p>Imp\u00f4t minimal\u00a0: 3510-3102 = 408 euros</p> <p>L\u2019imp\u00f4t brut avec 3 parts d\u00e9j\u00e0 calcul\u00e9 2115 euros est sup\u00e9rieur \u00e0 l\u2019imp\u00f4t minimal 408 euros, donc le plafonnement familial ne s\u2019applique pas ici.</p> <p>De fa\u00e7on g\u00e9n\u00e9rale, l\u2019imp\u00f4t brut est sup(imp\u00f4t1, imp\u00f4t2) o\u00f9\u00a0:</p> <ul> <li>[imp\u00f4t1]\u00a0: est l\u2019imp\u00f4t brut calcul\u00e9 avec les enfants\u00a0;</li> <li>[imp\u00f4t2]\u00a0: est l\u2019imp\u00f4t brut calcul\u00e9 sans les enfants et diminu\u00e9 du gain maximal (ici 1551 euros par demi-part) li\u00e9 aux enfants\u00a0;</li> </ul>"},{"location":"exercice-dx27application---version-1.html#813-calcul-de-la-decote","title":"8.1.3. Calcul de la d\u00e9cote","text":"<p>Toujours pour le salari\u00e9 mari\u00e9 avec deux enfants et un salaire annuel S de 50000 euros\u00a0:</p> <p>L\u2019imp\u00f4t brut (2115) issu de l\u2019\u00e9tape pr\u00e9c\u00e9dente est inf\u00e9rieur \u00e0 2627 euros pour un couple (1595 euros pour un c\u00e9libataire)\u00a0: la d\u00e9c\u00f4te s\u2019applique donc. Elle est obtenue avec le calcul suivant\u00a0:</p> <p>d\u00e9c\u00f4te= seuil (couple=1970/c\u00e9libataire=1196)-0,75* Imp\u00f4t brut</p> <p>d\u00e9c\u00f4te=1970-0,75*2115=383,75 arrondi \u00e0 384 euros.</p> <p>Nouvel Imp\u00f4t brut= 2115-384= 1731 euros</p>"},{"location":"exercice-dx27application---version-1.html#814-calcul-de-la-reduction-dimpots","title":"8.1.4. Calcul de la r\u00e9duction d\u2019imp\u00f4ts","text":"<p>Au-dessous d\u2019un certain seuil, une r\u00e9duction de 20\u00a0% est faite sur l\u2019imp\u00f4t brut issu des calculs pr\u00e9c\u00e9dents. En 2019, les seuils sont les suivants\u00a0:</p> <ul> <li>c\u00e9libataire : 21037 euros\u00a0;</li> <li>couple\u00a0: 42074 euros\u00a0; ( le chiffre 37968 utilis\u00e9 dans l\u2019exemple ci-dessus semble erron\u00e9)\u00a0; Ce seuil est augment\u00e9 de la valeur\u00a0: 3797 * (nombre de demi-parts amen\u00e9es par les enfants).</li> </ul> <p>Toujours pour le salari\u00e9 mari\u00e9 avec deux enfants et un salaire annuel S de 50000 euros\u00a0:</p> <ul> <li>son revenu imposable (45000 euros) est inf\u00e9rieur au seuil (42074+2*3797)=49668 euros\u00a0;</li> <li>il a donc droit \u00e0 une r\u00e9duction de 20\u00a0% de son imp\u00f4t\u00a0: 1731 * 0,2= 346,2 euros arrondi \u00e0 347 euros\u00a0;</li> <li>l\u2019imp\u00f4t brut du contribuable devient\u00a0: 1731-347= 1384 euros\u00a0;</li> </ul>"},{"location":"exercice-dx27application---version-1.html#815-calcul-de-limpot-net","title":"8.1.5. Calcul de l\u2019imp\u00f4t net","text":"<p>Notre calcul s\u2019arr\u00eatera l\u00e0\u00a0: l\u2019imp\u00f4t net \u00e0 payer sera de 1384 euros. Dans la r\u00e9alit\u00e9, le contribuable peut b\u00e9n\u00e9ficier d\u2019autres r\u00e9ductions notamment pour des dons \u00e0 des organismes d\u2019int\u00e9r\u00eat public ou g\u00e9n\u00e9ral.</p>"},{"location":"exercice-dx27application---version-1.html#816-cas-des-hauts-revenus","title":"8.1.6. Cas des hauts revenus","text":"<p>Notre exemple pr\u00e9c\u00e9dent correspond \u00e0 la majorit\u00e9 des cas de salari\u00e9s. Cependant le calcul de l\u2019imp\u00f4t est diff\u00e9rent dans le cas des hauts revenus.</p>"},{"location":"exercice-dx27application---version-1.html#8161-plafonnement-de-la-reduction-de-10-sur-les-revenus-annuels","title":"8.1.6.1. Plafonnement de la r\u00e9duction de 10\u00a0% sur les revenus annuels","text":"<p>Dans la plupart des cas, le revenu imposable est obtenu par la formule\u00a0: R=0,9*S o\u00f9 S est le salaire annuel. On appelle cela la r\u00e9duction des 10\u00a0%. Cette r\u00e9duction est plafonn\u00e9e. En 2019\u00a0:</p> <ul> <li>elle ne peut \u00eatre sup\u00e9rieure \u00e0 12502 euros\u00a0;</li> <li> <p>elle ne peut \u00eatre inf\u00e9rieure \u00e0 437 euros\u00a0; Prenons le cas d\u2019un salari\u00e9 non mari\u00e9 sans enfants et un salaire annuel de 200000 euros\u00a0:</p> </li> <li> <p>la r\u00e9duction de 10\u00a0% est de 20000 euros &gt; 12502 euros. Elle est donc ramen\u00e9e \u00e0 12502 euros\u00a0;</p> </li> </ul>"},{"location":"exercice-dx27application---version-1.html#8162-plafonnement-du-quotient-familial","title":"8.1.6.2. Plafonnement du quotient familial","text":"<p>Prenon un cas o\u00f9 le plafonnement familial pr\u00e9sent\u00e9 au paragraphe |Plafonnement du quotient familial|, intervient. Prenons le cas d\u2019un couple avec trois enfants et des revenus annuels de 100000 euros. Reprenons les \u00e9tapes du calcul\u00a0:</p> <ul> <li>l\u2019abattement de 10\u00a0% est de 10000 euros &lt; 12502 euros. Le revenu imposable R est donc 100000-10000=90000 euros\u00a0;</li> <li>le couple a nbParts=2+0,5*2+1=4 parts\u00a0;</li> <li>son quotient familial est donc QF= R/nbParts=90000/4=22500 euros\u00a0;</li> <li>son imp\u00f4t brut I1 avec enfants est I1=0,14*90000-1394,96*4= 7020 euros\u00a0;</li> <li>son imp\u00f4t brut I2 sans enfants\u00a0:</li> <li>QF=90000/2=45000 euros\u00a0;</li> <li>I2=0,3*90000-5798*2=15404 euros\u00a0;</li> <li>la r\u00e8gle du plafonnement du quotient familial dit que le gain amen\u00e9 par les enfants ne peut d\u00e9passer (1551*4 demi-parts)=6204 euros. Or ici, il est I2-I1=15404-7020= 8384 euros, donc sup\u00e9rieur \u00e0 6204 euros\u00a0;</li> <li>l\u2019imp\u00f4t brut est donc recalcul\u00e9 comme I3=I2-6204=15404-6204= 9200 euros\u00a0; Ce couple n\u2019aura ni d\u00e9cote, ni r\u00e9duction et son imp\u00f4t final sera de 9200 euros.</li> </ul>"},{"location":"exercice-dx27application---version-1.html#817-chiffres-officiels","title":"8.1.7. Chiffres officiels","text":"<p>Le calcul de l\u2019imp\u00f4t est complexe. Tout au long du document, les tests seront faits avec les exemples suivants. Les r\u00e9sultats sont ceux du simulateur de l\u2019administration fiscale |https://www3.impots.gouv.fr/simulateur/calcul_impot/2019/simplifie/index.htm|\u00a0:</p> <p>Contribuable</p><p>R\u00e9sultats officiels</p><p>R\u00e9sultats de l\u2019algorithme du document</p><p>Couple avec 2 enfants et des revenus annuels de 55555 euros</p><p>Imp\u00f4t=2815 euros</p><p>Taux d\u2019imposition=14\u00a0%</p><p>Imp\u00f4t=2814 euros</p><p>Taux d\u2019imposition=14\u00a0%</p><p>Couple avec 2 enfants et des revenus annuels de 50000 euros</p><p>Imp\u00f4t=1385 euros</p><p>D\u00e9cote=720 euros</p><p>R\u00e9duction=0 euros</p><p>Taux d\u2019imposition=14\u00a0%</p><p>Imp\u00f4t=1384 euros</p><p>D\u00e9cote=384 euros</p><p>R\u00e9duction=347 euros</p><p>Taux d\u2019imposition=14\u00a0%</p><p>Couple avec 3 enfants et des revenus annuels de 50000 euros</p><p>Imp\u00f4t=0 euro</p><p>d\u00e9cote=384 euros</p><p>R\u00e9duction=346 euros</p><p>Taux d\u2019imposition=14\u00a0%</p><p>Imp\u00f4t=0 euro</p><p>d\u00e9cote=720 euros</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=14\u00a0%</p><p>C\u00e9libataire avec 2 enfants et des revenus annuels de 100000 euros</p><p>Imp\u00f4t=19884 euros</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=41\u00a0%</p><p>Imp\u00f4t=19884 euros</p><p>Surcote=4480 euros</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=41\u00a0%</p><p>C\u00e9libataire avec 3 enfants et des revenus annuels de 100000 euros</p><p>Imp\u00f4t=16782 euros</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=41\u00a0%</p><p>Imp\u00f4t=16782 euros</p><p>Surcote=7176 euros</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=41\u00a0%</p><p>Couple avec 3 enfants et des revenus annuels de 100000 euros</p><p>Imp\u00f4t=9200 euros</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=30\u00a0%</p><p>Imp\u00f4t=9200 euros</p><p>Surcote=2180 euros</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=30\u00a0%</p><p>Couple avec 5 enfants et des revenus annuels de 100000 euros</p><p>Imp\u00f4t=4230 euros</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=14\u00a0%</p><p>Imp\u00f4t=4230 euros</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=14\u00a0%</p><p>C\u00e9libataire sans enfants et des revenus annuels de 100000 euros</p><p>Imp\u00f4t=22986 euros</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=41\u00a0%</p><p>Imp\u00f4t= 22986 euros</p><p>Surcote=0 euro</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=41\u00a0%</p><p>Couple avec 2 enfants et des revenus annuels de 30000 euros</p><p>Imp\u00f4t=0 euro</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=0\u00a0%</p><p>Imp\u00f4t=0 euro</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=0\u00a0%</p><p>C\u00e9libataire sans enfants et des revenus annuels de 200000 euros</p><p>Imp\u00f4t=64211 euro</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=45\u00a0%</p><p>Imp\u00f4t= 64210 euros</p><p>Surcote=7498 euros</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=45\u00a0%</p><p>Couple avec 3 enfants et des revenus annuels de 200000 euros</p><p>Imp\u00f4t=42843 euro</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=41\u00a0%</p><p>Imp\u00f4t=42842 euros</p><p>Surcote=17283 euros</p><p>d\u00e9cote=0 euro</p><p>R\u00e9duction=0 euro</p><p>Taux d\u2019imposition=41\u00a0%</p> <p>Ci-dessus, on appelle surcote, ce que paient en plus les hauts revenus \u00e0 cause de deux ph\u00e9nom\u00e8nes\u00a0:</p> <ul> <li>le plafonnement de l\u2019abattement de 10\u00a0% sur les revenus annuels\u00a0;</li> <li>le plafonnement du quotient familial\u00a0; Cet indicateur n\u2019a pu \u00eatre v\u00e9rifi\u00e9 car le simulateur de l\u2019administration fiscale ne le donne pas.</li> </ul> <p>On voit que l\u2019algorithme du document donne un imp\u00f4t juste \u00e0 chaque fois, avec cependant une marge d\u2019erreur de 1 euro. Cette marge d\u2019erreur provient des arrondis. Toutes les sommes d\u2019argent sont arrondies parfois \u00e0 l\u2019euro sup\u00e9rieur, parfois \u00e0 l\u2019euro inf\u00e9rieur. Comme je ne connaissais pas les r\u00e8gles officielles, les sommes d\u2019argent de l\u2019algorithme du document ont \u00e9t\u00e9 arrondies\u00a0:</p> <ul> <li>\u00e0 l\u2019euro sup\u00e9rieur pour les d\u00e9cotes et r\u00e9ductions\u00a0;</li> <li>\u00e0 l\u2019euro inf\u00e9rieur pour les surcotes et l\u2019imp\u00f4t final\u00a0; Nous allons d\u00e9velopper plusieurs versions de l'application de calcul de l'imp\u00f4t.</li> </ul>"},{"location":"exercice-dx27application---version-1.html#82-version-1","title":"8.2. Version 1","text":""},{"location":"exercice-dx27application---version-1.html#821-le-script-principal","title":"8.2.1. Le script principal","text":"<p>Nous pr\u00e9sentons un premier programme o\u00f9\u00a0:</p> <ul> <li>les donn\u00e9es n\u00e9cessaires au calcul de l'imp\u00f4t sont cod\u00e9es en dur dans le code sous forme de listes et de constantes\u00a0;</li> <li>les donn\u00e9es des contribuables (mari\u00e9, enfants, salaire) sont dans un premier fichier texte [taxpayersdata.txt]\u00a0;</li> <li>les r\u00e9sultats du calcul de l'imp\u00f4t (mari\u00e9, enfants, salaire, imp\u00f4t) sont m\u00e9moris\u00e9s dans un second fichier texte [r\u00e9sultats.txt]\u00a0; Le script [v-01/main.py] est le suivant\u00a0:</li> </ul> <pre><code># modules\nimport sys\n\nfrom impots.v01.shared.imp\u00f4ts_module_01 import *\n\n# main -----------------------\n\n# constantes\n# fichier des contribuables\nDATA = \"./data/taxpayersdata.txt\"\n# fichier des r\u00e9sultats\nRESULTATS = \"./data/r\u00e9sultats.txt\"\n\ntry:\n    # lecture des donn\u00e9es contribuables\n    tax_payers = get_taxpayers_data(DATA)\n    # liste des r\u00e9sultats\n    results = []\n    # on calcule l'imp\u00f4t des contribuables\n    for tax_payer in tax_payers:\n        # le calcul de l'imp\u00f4t renvoie un dictionnaire de cl\u00e9s\n        # ['mari\u00e9', 'enfants', 'salaire', 'imp\u00f4t', 'surc\u00f4te', 'd\u00e9c\u00f4te', 'r\u00e9duction', 'taux']\n        result = calcul_imp\u00f4t(tax_payer['mari\u00e9'], tax_payer['enfants'], tax_payer['salaire'])\n        # le dictionnaire est ajout\u00e9 \u00e0 la liste des r\u00e9sultats\n        results.append(result)\n    # on enregistre les r\u00e9sultats\n    record_results(RESULTATS, results)\nexcept BaseException as erreur:\n    # il peut y avoir diff\u00e9rentes erreurs : absence de fichier, contenu de fichier incorrect\n    # on affiche l'erreur et on quitte l'application\n    print(f\"l'erreur suivante s'est produite : {erreur}]\\n\")\n    sys.exit()\n</code></pre> <p>Notes</p> <ul> <li>ligne 4\u00a0: on utilise le module [impots.v01.modules.imp\u00f4ts_module_01]. On rappelle que ce chemin est mesur\u00e9 \u00e0 partir de la racine du projet PyCharm\u00a0;</li> <li>ligne 10\u00a0: le fichier [data/taxpayersdata.txt] est le suivant\u00a0: <pre><code>oui,2,55555\noui,2,50000\noui,3,50000\nnon,2,100000\nnon,3,100000\noui,3,100000\noui,5,100000\nnon,0,100000\noui,2,30000\nnon,0,200000\noui,3,200000\n</code></pre></li> </ul> <p>Chaque ligne repr\u00e9sente un tuple de trois \u00e9l\u00e9ments [mari\u00e9 / pacs\u00e9 ou pas, nombre d'enfants, salaire annuel en euros].</p> <ul> <li> <p>ligne 12\u00a0: le fichier o\u00f9 on placera les r\u00e9sultats du calcul de l'imp\u00f4t pour chacun des contribuables du fichier [taxpayersdata.txt]. Il aura le contenu suivant\u00a0: <pre><code>{'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 55555, 'imp\u00f4t': 2814, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.14}\n{'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 50000, 'imp\u00f4t': 1384, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 384, 'r\u00e9duction': 347, 'taux': 0.14}\n{'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 50000, 'imp\u00f4t': 0, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 720, 'r\u00e9duction': 0, 'taux': 0.14}\n{'mari\u00e9': 'non', 'enfants': 2, 'salaire': 100000, 'imp\u00f4t': 19884, 'surc\u00f4te': 4480, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.41}\n{'mari\u00e9': 'non', 'enfants': 3, 'salaire': 100000, 'imp\u00f4t': 16782, 'surc\u00f4te': 7176, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.41}\n{'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 100000, 'imp\u00f4t': 9200, 'surc\u00f4te': 2180, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.3}\n{'mari\u00e9': 'oui', 'enfants': 5, 'salaire': 100000, 'imp\u00f4t': 4230, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.14}\n{'mari\u00e9': 'non', 'enfants': 0, 'salaire': 100000, 'imp\u00f4t': 22986, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.41}\n{'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 30000, 'imp\u00f4t': 0, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0}\n{'mari\u00e9': 'non', 'enfants': 0, 'salaire': 200000, 'imp\u00f4t': 64210, 'surc\u00f4te': 7498, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.45}\n{'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 200000, 'imp\u00f4t': 42842, 'surc\u00f4te': 17283, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.41}\n</code></pre></p> </li> <li> <p>ligne 16\u00a0: on r\u00e9cup\u00e8re les donn\u00e9es des contribuables contenues dans [taxpayersdata.txt]. On r\u00e9cup\u00e8re une liste de dictionnaires de cl\u00e9s [mari\u00e9, enfants, salaire] chaque dictionnaire repr\u00e9sentant un contribuable\u00a0;</p> </li> <li>lignes 17-25\u00a0: on calcule l'imp\u00f4t des contribuables de la liste [taxPayers]. On r\u00e9cup\u00e8re une liste [results] dont chaque \u00e9l\u00e9ment est de nouveau un dictionnaire de cl\u00e9s [mari\u00e9, enfants, salaire, imp\u00f4t, surc\u00f4te, d\u00e9c\u00f4te, r\u00e9duction, taux]\u00a0;</li> <li>ligne 27\u00a0: la liste [results] des r\u00e9sultats est enregistr\u00e9e dans le fichier [r\u00e9sultats.txt] sous la forme montr\u00e9e ci-dessus\u00a0;</li> <li> <p>lignes 28-32\u00a0: on arr\u00eate toutes les exceptions qui peuvent sortir du module [impots.v01.modules.imp\u00f4ts_module_01]\u00a0; Nous allons d\u00e9tailler maintenant les trois fonctions utilis\u00e9es par le script [main]\u00a0:</p> </li> <li> <p>[get_taxpayers_data]\u00a0: pour lire les donn\u00e9es des contribuables\u00a0;</p> </li> <li>[calcul_imp\u00f4t]\u00a0: pour calculer l'imp\u00f4t de ceux-ci\u00a0;</li> <li>[record_results]\u00a0: pour enregistrer les r\u00e9sultats dans un fichier texte\u00a0; Toutes ces fonctions se trouvent dans le module [impots.modules.imp\u00f4ts_module_01].</li> </ul>"},{"location":"exercice-dx27application---version-1.html#822-le-module-impotsv01sharedimpots_module_01","title":"8.2.2. Le module [impots.v01.shared.imp\u00f4ts_module_01]","text":"<p>Les fonctions n\u00e9cessaires au calcul de l'imp\u00f4t ont \u00e9t\u00e9 rassembl\u00e9es dans le module [impots.v01.shared.imp\u00f4ts_module_01]\u00a0:</p> <p></p> <ul> <li>en [1]\u00a0: d\u00e9finition des constantes du calcul de l'imp\u00f4t\u00a0;</li> <li>en [2]\u00a0: la liste des fonctions du module\u00a0;</li> </ul>"},{"location":"exercice-dx27application---version-1.html#823-la-fonction-get_taxpayers_data","title":"8.2.3. La fonction [get_taxpayers_data]","text":"<p>La fonction [get_taxpayers_data] est la suivante\u00a0:</p> <pre><code># imports\nimport codecs\n\u2026\n\n# lecture des donn\u00e9es des contribuables\n# ----------------------------------------\ndef get_taxpayers_data(taxpayers_filename: str) -&gt; list:\n    # lecture des donn\u00e9es contribuables\n    file = None\n    try:\n        # la liste des contribuables\n        taxpayers = []\n        # ouverture du fichier\n        file = codecs.open(taxpayers_filename, \"r\", \"utf8\")\n        # on lit la premi\u00e8re ligne du fichier des contribuables\n        ligne = file.readline().strip()\n        # tant qu'il reste une ligne \u00e0 exploiter\n        while ligne != '':\n            # on r\u00e9cup\u00e8re les 3 champs mari\u00e9,enfants,salaire qui forment la ligne\n            (mari\u00e9, enfants, salaire) = ligne.split(\",\")\n            # on les ajoute \u00e0 la liste des contribuables\n            taxpayers.append({'mari\u00e9': mari\u00e9.strip().lower(), 'enfants': int(enfants), 'salaire': int(salaire)})\n            # on lit une nouvelle ligne du fichier des contribuables\n            ligne = file.readline().strip()\n        # on rend le r\u00e9sultat\n        return taxpayers\n    finally:\n        # on ferme le fichier s'il a \u00e9t\u00e9 ouvert\n        if file:\n            file.close()\n</code></pre> <p>Notes</p> <ul> <li>ligne 7\u00a0: [taxpayers_filename] est le nom du fichier \u00e0 exploiter. La fonction rend une liste\u00a0;</li> <li>lignes 18-24\u00a0: la boucle d'exploitation des lignes [mari\u00e9, enfants, salaire] du fichier texte\u00a0;</li> <li>ligne 20\u00a0: les trois \u00e9l\u00e9ments de la ligne sont r\u00e9cup\u00e9r\u00e9s. On suppose ici que la ligne est syntaxiquement correcte, \u00e7-\u00e0-d qu'elle a bien les trois \u00e9l\u00e9ments attendus\u00a0;</li> <li>ligne 22\u00a0: on construit un dictionnaire avec les cl\u00e9s [mari\u00e9, enfants, salaire] et ce dictionnaire est ajout\u00e9 \u00e0 la liste [taxPayers]\u00a0;</li> <li>ligne 26\u00a0: une fois le fichier exploit\u00e9, on rend la liste [taxPayers]\u00a0;</li> <li>lignes 10-30\u00a0: on remarquera qu'on n'a pas mis de clause [catch] au [try] de la ligne 10. La clause [catch] n'est pas obligatoire. Ligne 27, on a mis une clause [finally] pour fermer le fichier texte dans tous les cas, erreur ou pas\u00a0;</li> <li>cette structure try / finally laisse \u00e9chapper une \u00e9ventuelle exception (il n'y a pas de catch). Cette exception va remonter au script principal [main] qui va arr\u00eater et afficher l'exception (cf paragraphe |Le script principal|). Ce m\u00e9canisme a \u00e9t\u00e9 utilis\u00e9 pour la plupart des fonctions du module\u00a0;</li> </ul>"},{"location":"exercice-dx27application---version-1.html#824-la-fonction-calcul_impot","title":"8.2.4. La fonction [calcul_imp\u00f4t]","text":"<p>La fonction [calcul_imp\u00f4t] est la suivante\u00a0:</p> <pre><code># imports\nimport codecs\nimport math\n\n# tranches de l'imp\u00f4t 2019\nlimites = [9964, 27519, 73779, 156244, 0]\ncoeffr = [0, 0.14, 0.3, 0.41, 0.45]\ncoeffn = [0, 1394.96, 5798, 13913.69, 20163.45]\n\n# constantes pour le calcul de l'imp\u00f4t 2019\nPLAFOND_QF_DEMI_PART = 1551\nPLAFOND_REVENUS_CELIBATAIRE_POUR_REDUCTION = 21037\nPLAFOND_REVENUS_COUPLE_POUR_REDUCTION = 42074\nVALEUR_REDUC_DEMI_PART = 3797\nPLAFOND_DECOTE_CELIBATAIRE = 1196\nPLAFOND_DECOTE_COUPLE = 1970\nPLAFOND_IMPOT_COUPLE_POUR_DECOTE = 2627\nPLAFOND_IMPOT_CELIBATAIRE_POUR_DECOTE = 1595\nABATTEMENT_DIXPOURCENT_MAX = 12502\nABATTEMENT_DIXPOURCENT_MIN = 437\n\n\u2026\n# calcul de l'imp\u00f4t\n# ----------------------------------------\ndef calcul_imp\u00f4t(mari\u00e9: str, enfants: int, salaire: int) -&gt; dict:\n    # mari\u00e9 : oui, non\n    # enfants : nombre d'enfants\n    # salaire : salaire annuel\n    # limites, coeffr, coeffn : les tableaux des donn\u00e9es permettant le calcul de l'imp\u00f4t\n    #\n    # calcul de l'imp\u00f4t avec enfants\n    result1 = calcul_imp\u00f4t_2(mari\u00e9, enfants, salaire)\n    impot1 = result1[\"imp\u00f4t\"]\n    # calcul de l'imp\u00f4t sans les enfants\n    if enfants != 0:\n        result2 = calcul_imp\u00f4t_2(mari\u00e9, 0, salaire)\n        impot2 = result2[\"imp\u00f4t\"]\n        # application du plafonnement du quotient familial\n        if enfants &lt; 3:\n            # PLAFOND_QF_DEMI_PART euros pour les 2 premiers enfants\n            impot2 = impot2 - enfants * PLAFOND_QF_DEMI_PART\n        else:\n            # PLAFOND_QF_DEMI_PART euros pour les 2 premiers enfants, le double pour les suivants\n            impot2 = impot2 - 2 * PLAFOND_QF_DEMI_PART - (enfants - 2) * 2 * PLAFOND_QF_DEMI_PART\n    else:\n        impot2 = impot1\n        result2 = result1\n\n    # on prend l'imp\u00f4t le plus fort avec le taux et la surc\u00f4te qui vont avec\n    if impot1 &gt; impot2:\n        impot = impot1\n        taux = result1[\"taux\"]\n        surc\u00f4te = result1[\"surc\u00f4te\"]\n    else:\n        surc\u00f4te = impot2 - impot1 + result2[\"surc\u00f4te\"]\n        impot = impot2\n        taux = result2[\"taux\"]\n\n    # calcul d'une \u00e9ventuelle d\u00e9c\u00f4te\n    d\u00e9c\u00f4te = get_d\u00e9c\u00f4te(mari\u00e9, salaire, impot)\n    impot -= d\u00e9c\u00f4te\n    # calcul d'une \u00e9ventuelle r\u00e9duction d'imp\u00f4ts\n    r\u00e9duction = get_r\u00e9duction(mari\u00e9, salaire, enfants, impot)\n    impot -= r\u00e9duction\n    # r\u00e9sultat\n    return {\"mari\u00e9\": mari\u00e9, \"enfants\": enfants, \"salaire\": salaire, \"imp\u00f4t\": math.floor(impot), \"surc\u00f4te\": surc\u00f4te,\n            \"d\u00e9c\u00f4te\": d\u00e9c\u00f4te, \"r\u00e9duction\": r\u00e9duction, \"taux\": taux}\n</code></pre> <p>Notes</p> <ul> <li>lignes 6-8\u00a0: les tranches de l'imp\u00f4t (cf. paragraphe |Calcul de l\u2019imp\u00f4t brut|)\u00a0;</li> <li>lignes 11-20\u00a0: les constantes du calcul de l'imp\u00f4t\u00a0;</li> <li>on notera que les \u00e9l\u00e9ments initialis\u00e9s aux lignes 5-20 seront globaux aux fonctions que nous allons d\u00e9crire. Ils sont donc connus tant que la fonction qui les utilise ne d\u00e9clare pas de variables de m\u00eames noms\u00a0;</li> <li>les chiffres des lignes 5-20 changent chaque ann\u00e9e. Ici ce sont les chiffres 2019\u00a0;</li> <li>ligne 25\u00a0: la fonction [calcul_imp\u00f4t] re\u00e7oit trois param\u00e8tres\u00a0:</li> <li>[mari\u00e9]\u00a0: oui / non, indique si le contribuable est mari\u00e9 ou pacs\u00e9\u00a0;</li> <li>[enfants]\u00a0: son nombre d'enfants\u00a0;</li> <li>[salaire]\u00a0: son salaire annuel en euros\u00a0;</li> <li>lignes 31-33\u00a0: calcul de l\u2019imp\u00f4t en prenant en compte les enfants\u00a0; </li> <li>lignes 34-47\u00a0: ces lignes impl\u00e9mentent le plafonnement du quotient familial (cf. paragraphe |Plafonnement du quotient familial|)\u00a0;</li> <li>lignes 49-57\u00a0: ces lignes calculent le taux d'imposition du contribuable ainsi qu'une \u00e9ventuelle surcote (cf paragraphe |Cas des hauts revenus|)\u00a0;</li> <li>lignes 59-61\u00a0: calcul d'une \u00e9ventuelle d\u00e9cote (cf paragraphe |Calcul de la d\u00e9c\u00f4te|)\u00a0;</li> <li>lignes 62-64\u00a0: calcul d'une \u00e9ventuelle r\u00e9duction de l'imp\u00f4t \u00e0 payer (cf. paragraphe |Calcul de la r\u00e9duction d\u2019imp\u00f4ts|)\u00a0; L'algorithme est assez complexe et nous ne le d\u00e9taillerons pas plus que ce que disent les commentaires. L'algorithme impl\u00e9mente le mode de calcul de l'imp\u00f4t tel que d\u00e9crit au paragraphe |Le probl\u00e8me|.</li> </ul>"},{"location":"exercice-dx27application---version-1.html#825-la-fonction-calcul_impot_2","title":"8.2.5. La fonction [calcul_imp\u00f4t_2]","text":"<p>La fonction [calcul_imp\u00f4t] fait appel \u00e0 la fonction [calcul_imp\u00f4t_2] suivante\u00a0:</p> <pre><code>def calcul_imp\u00f4t_2(mari\u00e9: str, enfants: int, salaire: int) -&gt; list:\n    # mari\u00e9 : oui, non\n    # enfants : nombre d'enfants\n    # salaire : salaire annuel\n    # limites, coeffr, coeffn : les tableaux des donn\u00e9es permettant le calcul de l'imp\u00f4t\n    #\n    # nombre de parts\n    mari\u00e9 = mari\u00e9.strip().lower()\n    if mari\u00e9 == \"oui\":\n        nb_parts = enfants / 2 + 2\n    else:\n        nb_parts = enfants / 2 + 1\n\n    # 1 part par enfant \u00e0 partir du 3i\u00e8me\n    if enfants &gt;= 3:\n        # une demi-part de + pour chaque enfant \u00e0 partir du 3i\u00e8me\n        nb_parts += 0.5 * (enfants - 2)\n\n    # revenu imposable\n    revenu_imposable = get_revenu_imposable(salaire)\n    # surc\u00f4te\n    surc\u00f4te = math.floor(revenu_imposable - 0.9 * salaire)\n    # pour des pbs d'arrondi\n    if surc\u00f4te &lt; 0:\n        surc\u00f4te = 0\n\n    # quotient familial\n    quotient = revenu_imposable / nb_parts\n    # est mis \u00e0 la fin du tableau limites pour arr\u00eater la boucle qui suit\n    limites[len(limites) - 1] = quotient\n    # calcul de l'imp\u00f4t\n    i = 0\n    while quotient &gt; limites[i]:\n        i += 1\n        # du fait qu'on a plac\u00e9 quotient \u00e0 la fin du tableau limites, la boucle pr\u00e9c\u00e9dente\n    # ne peut d\u00e9border du tableau limites\n\n    # maintenant on peut calculer l'imp\u00f4t\n    imp\u00f4t = math.floor(revenu_imposable * coeffr[i] - nb_parts * coeffn[i])\n    # r\u00e9sultat\n    return {\"imp\u00f4t\": imp\u00f4t, \"surc\u00f4te\": surc\u00f4te, \"taux\": coeffr[i]}\n</code></pre> <p>Cet algorithme a \u00e9t\u00e9 d\u00e9crit au paragraphe 8.1.1.</p>"},{"location":"exercice-dx27application---version-1.html#826-la-fonction-get_decote","title":"8.2.6. La fonction [get_d\u00e9c\u00f4te]","text":"<p>La fonction [get_d\u00e9c\u00f4te] impl\u00e9mente le calcul de l'\u00e9ventuelle d\u00e9cote de l'imp\u00f4t (paragraphe |Calcul de la d\u00e9c\u00f4te|)\u00a0:</p> <pre><code># calcule une d\u00e9c\u00f4te \u00e9ventuelle\ndef get_d\u00e9c\u00f4te(mari\u00e9: str, salaire: int, impots: int) -&gt; int:\n    # au d\u00e9part, une d\u00e9c\u00f4te nulle\n    d\u00e9c\u00f4te = 0\n    # montant maximal d'imp\u00f4t pour avoir la d\u00e9c\u00f4te\n    plafond_imp\u00f4t_pour_d\u00e9c\u00f4te = PLAFOND_IMPOT_COUPLE_POUR_DECOTE if mari\u00e9 == \"oui\" else PLAFOND_IMPOT_CELIBATAIRE_POUR_DECOTE\n    if impots &lt; plafond_imp\u00f4t_pour_d\u00e9c\u00f4te:\n        # montant maximal de la d\u00e9c\u00f4te\n        plafond_d\u00e9c\u00f4te = PLAFOND_DECOTE_COUPLE if mari\u00e9 == \"oui\" else PLAFOND_DECOTE_CELIBATAIRE\n        # d\u00e9c\u00f4te th\u00e9orique\n        d\u00e9c\u00f4te = plafond_d\u00e9c\u00f4te - 0.75 * impots\n        # la d\u00e9c\u00f4te ne peut d\u00e9passer le montant de l'omp\u00f4t\n        if d\u00e9c\u00f4te &gt; impots:\n            d\u00e9c\u00f4te = impots\n\n        # pas de d\u00e9c\u00f4te &lt;0\n        if d\u00e9c\u00f4te &lt; 0:\n            d\u00e9c\u00f4te = 0\n\n    # r\u00e9sultat\n    return math.ceil(d\u00e9c\u00f4te)\n</code></pre>"},{"location":"exercice-dx27application---version-1.html#827-la-fonction-get_reduction","title":"8.2.7. La fonction [get_r\u00e9duction]","text":"<p>La fonction [get_r\u00e9duction] impl\u00e9mente le calcul de l'\u00e9ventuelle r\u00e9duction de l'imp\u00f4t \u00e0 payer (paragraphe |Calcul de la r\u00e9duction d\u2019imp\u00f4ts|)\u00a0:</p> <pre><code># calcule une r\u00e9duction \u00e9ventuelle\ndef get_r\u00e9duction(mari\u00e9: str, salaire: int, enfants: int, impots: int) -&gt; int:\n    # le plafond des revenus pour avoir droit \u00e0 la r\u00e9duction de 20%\n    plafond_revenu_pour_r\u00e9duction = PLAFOND_REVENUS_COUPLE_POUR_REDUCTION if mari\u00e9 == \"oui\" else PLAFOND_REVENUS_CELIBATAIRE_POUR_REDUCTION\n    plafond_revenu_pour_r\u00e9duction += enfants * VALEUR_REDUC_DEMI_PART\n    if enfants &gt; 2:\n        plafond_revenu_pour_r\u00e9duction += (enfants - 2) * VALEUR_REDUC_DEMI_PART\n\n    # revenu imposable\n    revenu_imposable = get_revenu_imposable(salaire)\n    # r\u00e9duction\n    r\u00e9duction = 0\n    if revenu_imposable &lt; plafond_revenu_pour_r\u00e9duction:\n        # r\u00e9duction de 20%\n        r\u00e9duction = 0.2 * impots\n\n    # r\u00e9sultat\n    return math.ceil(r\u00e9duction)\n</code></pre>"},{"location":"exercice-dx27application---version-1.html#828-la-fonction-get_revenu_imposable","title":"8.2.8. La fonction [get_revenu_imposable]","text":"<p>La fonction [get_revenu_imposable] calcule le revenu imposable \u00e0 partir du salaire annuel\u00a0:</p> <pre><code># revenu_imposable = salaireAnnuel - abattement\n# l'abattement a un min et un max\n# ----------------------------------------\ndef get_revenu_imposable(salaire: int) -&gt; int:\n    # abattement de 10% du salaire\n    abattement = 0.1 * salaire\n    # cet abattement ne peut d\u00e9passer ABATTEMENT_DIXPOURCENT_MAX\n    if abattement &gt; ABATTEMENT_DIXPOURCENT_MAX:\n        abattement = ABATTEMENT_DIXPOURCENT_MAX\n\n    # l'abattement ne peut \u00eatre inf\u00e9rieur \u00e0 ABATTEMENT_DIXPOURCENT_MIN\n    if abattement &lt; ABATTEMENT_DIXPOURCENT_MIN:\n        abattement = ABATTEMENT_DIXPOURCENT_MIN\n\n    # revenu imposable\n    revenu_imposable = salaire - abattement\n    # r\u00e9sultat\n    return math.floor(revenu_imposable)\n</code></pre>"},{"location":"exercice-dx27application---version-1.html#829-la-fonction-record_results","title":"8.2.9. La fonction [record_results]","text":"<p>La fonction [record_results] enregistre les r\u00e9sultats de calcul de l'imp\u00f4t dans un fichier texte\u00a0:</p> <pre><code># \u00e9criture des r\u00e9sultats dans un fichier texte\n# ----------------------------------------\ndef record_results(results_filename: str, results: list):\n    # results_filename : le nom du fichier texte o\u00f9 placer les r\u00e9sultats\n    # results : la liste des r\u00e9sultats sous la forme d'une liste de dictionnaires\n    # chaque dictionnaire est \u00e9crit sur une ligne de texte\n    r\u00e9sultats = None\n    try:\n        # ouverture du fichier des r\u00e9sultats\n        r\u00e9sultats = codecs.open(results_filename, \"w\", \"utf8\")\n        # exploitation des contribuables\n        for result in results:\n            # on inscrit le r\u00e9sultat dans le fichier des r\u00e9sultats\n            r\u00e9sultats.write(f\"{result}\\n\")\n            # contribuable suivant\n    finally:\n        # on ferme le fichier s'il a \u00e9t\u00e9 ouvert\n        if r\u00e9sultats:\n            r\u00e9sultats.close()\n</code></pre>"},{"location":"exercice-dx27application---version-1.html#8210-les-resultats","title":"8.2.10. Les r\u00e9sultats","text":"<p>Comme il a d\u00e9j\u00e0 \u00e9t\u00e9 dit, avec le fichier des contribuables [taxpayersdata.txt] suivant\u00a0:</p> <pre><code>oui,2,55555\noui,2,50000\noui,3,50000\nnon,2,100000\nnon,3,100000\noui,3,100000\noui,5,100000\nnon,0,100000\noui,2,30000\nnon,0,200000\noui,3,200000\n</code></pre> <p>le script [main.py] cr\u00e9e le fichier [r\u00e9sultats.txt] suivant\u00a0:</p> <pre><code>{'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 55555, 'imp\u00f4t': 2814, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.14}\n{'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 50000, 'imp\u00f4t': 1384, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 384, 'r\u00e9duction': 347, 'taux': 0.14}\n{'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 50000, 'imp\u00f4t': 0, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 720, 'r\u00e9duction': 0, 'taux': 0.14}\n{'mari\u00e9': 'non', 'enfants': 2, 'salaire': 100000, 'imp\u00f4t': 19884, 'surc\u00f4te': 4480, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.41}\n{'mari\u00e9': 'non', 'enfants': 3, 'salaire': 100000, 'imp\u00f4t': 16782, 'surc\u00f4te': 7176, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.41}\n{'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 100000, 'imp\u00f4t': 9200, 'surc\u00f4te': 2180, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.3}\n{'mari\u00e9': 'oui', 'enfants': 5, 'salaire': 100000, 'imp\u00f4t': 4230, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.14}\n{'mari\u00e9': 'non', 'enfants': 0, 'salaire': 100000, 'imp\u00f4t': 22986, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.41}\n{'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 30000, 'imp\u00f4t': 0, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0}\n{'mari\u00e9': 'non', 'enfants': 0, 'salaire': 200000, 'imp\u00f4t': 64210, 'surc\u00f4te': 7498, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.45}\n{'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 200000, 'imp\u00f4t': 42842, 'surc\u00f4te': 17283, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.41}\n</code></pre> <p>Ces r\u00e9sultats sont conformes aux chiffres officiels du paragraphe |Chiffres officiels|.</p> <p>Maintenant, ex\u00e9cutons cette version dans une fen\u00eatre console\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\impots\\v01&gt;python main.py\nTraceback (most recent call last):\n  File \"main.py\", line 4, in &lt;module&gt;\n    from impots.v01.shared.imp\u00f4ts_module_01 import *\nModuleNotFoundError: No module named 'impots'\n</code></pre> <p>On retrouve une erreur d\u00e9j\u00e0 rencontr\u00e9e\u00a0: celle o\u00f9 un module n\u2019est pas trouv\u00e9, ici le module [impots]. On rappelle que cela veut dire\u00a0que : </p> <ul> <li>l\u2019interpr\u00e9teur Python a explor\u00e9 un \u00e0 un les dossiers du Python Path\u00a0;</li> <li>dans aucun d\u2019eux, il n\u2019a trouv\u00e9 de dossier dans lequel il y aurait un sript [impots.py]\u00a0; La version [v02] am\u00e8nera une solution \u00e0 ce probl\u00e8me.</li> </ul>"},{"location":"exercice-dx27application---version-4.html","title":"15. Exercice d'application - version 4","text":"<p>Nous reprenons ici l'exercice d\u00e9crit au paragraphe |Version 3| et nous le traitons maintenant avec des classes et interfaces. Nous \u00e9crirons deux applications\u00a0:</p> <p>L\u2019application 1 sera la suivante\u00a0:</p> <p></p> <p>Un script principal [main] instanciera une couche [dao] et une couche [m\u00e9tier]\u00a0:</p> <ul> <li>la couche [dao] aura pour r\u00f4le de g\u00e9rer des donn\u00e9es stock\u00e9es dans des fichiers texte et ult\u00e9rieurement dans une base de donn\u00e9es\u00a0;</li> <li>la couche [m\u00e9tier] aura pour r\u00f4le de faire le calcul de l'imp\u00f4t\u00a0; Dans cette application, il n'y aura pas d'actions de la part d'un utilisateur\u00a0: les donn\u00e9es des contribuables seront trouv\u00e9es dans un fichier texte dont on donnera le nom au module [main].</li> </ul> <p>Dans l\u2019application 2, c'est l'utilisateur qui tapera au clavier les donn\u00e9es des contribuables. L'architecture \u00e9voluera alors de la fa\u00e7on suivante \u00a0:</p> <p></p> <ul> <li>la couche [dao] (Data Access Object) s'occupe de l'acc\u00e8s aux donn\u00e9es externes</li> <li>la couche [m\u00e9tier] s'occupe des probl\u00e8mes m\u00e9tier, ici le calcul de l'imp\u00f4t. Elle ne s'occupe pas des donn\u00e9es. Celles-ci peuvent avoir deux provenances\u00a0:</li> <li>la couche [dao] pour les donn\u00e9es persistantes\u00a0;</li> <li>la couche [ui] pour les donn\u00e9es fournies par l'utilisateur.</li> <li>la couche [ui] (User Interface) s'occupe des interactions avec l'utilisateur\u00a0;</li> <li>[main] est le chef d'orchestre\u00a0; Dans la suite, les couches [dao], [m\u00e9tier] et [ui] seront chacune impl\u00e9ment\u00e9e \u00e0 l'aide d'une classe. Les couches [m\u00e9tier] et [dao] seront les m\u00eames pour les deux applications. C\u2019est la raison pour laquelle on les a r\u00e9unies dans une m\u00eame version de l\u2019exercice d\u2019application.</li> </ul>"},{"location":"exercice-dx27application---version-4.html#151-version-4-application-1","title":"15.1. Version 4 \u2013 application 1","text":"<p>La version 4 calcule l'imp\u00f4t d'une liste de contribuables plac\u00e9e dans un fichier texte. Elle a l'architecture suivante\u00a0:</p> <p></p>"},{"location":"exercice-dx27application---version-4.html#1511-les-entites","title":"15.1.1. Les entit\u00e9s","text":"<p>Les entit\u00e9s sont des classes de donn\u00e9es. Leur r\u00f4le est d\u2019encapsuler des donn\u00e9es et d\u2019offrir des getters / setters qui permettent de v\u00e9rifier la validit\u00e9 de celles-ci. Les entit\u00e9s sont \u00e9chang\u00e9es par les couches. Une m\u00eame entit\u00e9 peut partir de la couche [ui] pour aller jusqu\u2019\u00e0 la couche [dao] et vice-versa.</p> <p></p>"},{"location":"exercice-dx27application---version-4.html#15111-la-classe-impotserror","title":"15.1.1.1. La classe [Imp\u00f4tsError]","text":"<p>Nous utiliserons une classe d'exception propri\u00e9taire\u00a0:</p> <pre><code># -------------------------------\n# classe d'exception\nfrom MyException import MyException\n\n\nclass Imp\u00f4tsError(MyException):\n    pass\n</code></pre> <p>D\u00e8s que les couches [m\u00e9tier] et [dao] rencontreront un probl\u00e8me, elles lanceront cette exception. Elle d\u00e9rive de la classe [MyException]. Elle s\u2019utilise donc de la fa\u00e7on suivante\u00a0: [raise Imp\u00f4tsError(code_erreur, msg_erreur)].</p>"},{"location":"exercice-dx27application---version-4.html#15112-la-classe-admindata","title":"15.1.1.2. La classe [AdminData]","text":"<p>La classe [AdminData] encapsule les constantes intervenant dans le calcul de l\u2019imp\u00f4t\u00a0:</p> <pre><code>from BaseEntity import BaseEntity\n\n\n# donn\u00e9es de l'administration fiscale\nclass AdminData(BaseEntity):\n    # cl\u00e9s exclues de l'\u00e9tat de la classe\n    excluded_keys = []\n\n    # cl\u00e9s auroris\u00e9es\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        return [\n            \"limites\",\n            \"coeffr\",\n            \"coeffn\",\n            \"plafond_qf_demi_part\",\n            \"plafond_revenus_celibataire_pour_reduction\",\n            \"plafond_revenus_couple_pour_reduction\",\n            \"valeur_reduc_demi_part\",\n            \"plafond_decote_celibataire\",\n            \"plafond_decote_couple\",\n            \"plafond_impot_couple_pour_decote\",\n            \"plafond_impot_celibataire_pour_decote\",\n            \"abattement_dixpourcent_max\",\n            \"abattement_dixpourcent_min\"\n        ]\n</code></pre> <ul> <li>ligne 5\u00a0: la classe [AdminData] \u00e9tend la classe [BaseEntity] d\u00e9crite au paragraphe |BaseEntity|. On se rappelle que les classes  \u00e9tendant la classe [BaseEntity] doivent d\u00e9finir\u00a0:</li> <li>un attribut de classe [excluded_keys] (ligne 7) qui liste les propri\u00e9t\u00e9s de l\u2019objet exclues lorsque l\u2019objet est transform\u00e9 en dictionnaire\u00a0;</li> <li>une m\u00e9thode statique [get_allowed_keys] (lignes 10-26) qui rend la liste des propri\u00e9t\u00e9s accept\u00e9es lorsque l\u2019objet est initialis\u00e9 avec un dictionnaire\u00a0; On n\u2019a pas utilis\u00e9 de setters pour v\u00e9rifier la validit\u00e9 des donn\u00e9es utilis\u00e9es pour initialiser un objet [AdminData]. En effet, cet objet est unique et d\u00e9fini par configuration et donc pas susceptible d\u2019\u00eatre erron\u00e9.</li> </ul>"},{"location":"exercice-dx27application---version-4.html#15113-la-classe-taxpayer","title":"15.1.1.3. La classe [TaxPayer]","text":"<p>La classe [TaxPayer] mod\u00e8lisera un contribuable\u00a0:</p> <pre><code># imports\nfrom BaseEntity import BaseEntity\nfrom Imp\u00f4tsError import Imp\u00f4tsError\n\n\n# un contribuable\nclass TaxPayer(BaseEntity):\n    # mod\u00e9lise un contribuable\n    # id : identifiant\n    # mari\u00e9 : oui / non\n    # enfants : son nombre d'enfants\n    # salaire : son salaire annuel\n    # imp\u00f4t : montant de l'imp\u00f4t \u00e0 payer\n    # surc\u00f4te : surc\u00f4te d'imp\u00f4t \u00e0 payer\n    # d\u00e9c\u00f4te : d\u00e9c\u00f4te de l'imp\u00f4t \u00e0 payer\n    # r\u00e9duction : r\u00e9duction sur l'imp\u00f4t \u00e0 payer\n    # taux : taux d'imposition du contribuable\n\n    # cl\u00e9s exclues de l'\u00e9tat de la classe\n    excluded_keys = []\n\n    # cl\u00e9s auroris\u00e9es\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        return ['id', 'mari\u00e9', 'enfants', 'salaire', 'imp\u00f4t', 'surc\u00f4te', 'd\u00e9c\u00f4te', 'r\u00e9duction', 'taux']\n\n    # properties\n    @property\n    def mari\u00e9(self) -&gt; str:\n        return self.__mari\u00e9\n\n    @property\n    def enfants(self) -&gt; int:\n        return self.__enfants\n\n    @property\n    def salaire(self) -&gt; int:\n        return self.__salaire\n\n    @property\n    def imp\u00f4t(self) -&gt; int:\n        return self.__imp\u00f4t\n\n    @property\n    def surc\u00f4te(self) -&gt; int:\n        return self.__surc\u00f4te\n\n    @property\n    def d\u00e9c\u00f4te(self) -&gt; int:\n        return self.__d\u00e9c\u00f4te\n\n    @property\n    def r\u00e9duction(self) -&gt; int:\n        return self.__r\u00e9duction\n\n    @property\n    def taux(self) -&gt; float:\n        return self.__taux\n\n    # setters\n    @mari\u00e9.setter\n    def mari\u00e9(self, mari\u00e9: str):\n        ok = isinstance(mari\u00e9, str)\n        if ok:\n            mari\u00e9 = mari\u00e9.strip().lower()\n            ok = mari\u00e9 == \"oui\" or mari\u00e9 == \"non\"\n        if ok:\n            self.__mari\u00e9 = mari\u00e9\n        else:\n            raise Imp\u00f4tsError(31, f\"l'attribut mari\u00e9 [{mari\u00e9}] doit avoir l'une des valeurs oui / non\")\n\n    @enfants.setter\n    def enfants(self, enfants):\n        # enfants doit \u00eatre un entier &gt;=0\n        try:\n            enfants = int(enfants)\n            erreur = enfants &lt; 0\n        except:\n            erreur = True\n        if not erreur:\n            self.__enfants = enfants\n        else:\n            raise Imp\u00f4tsError(32, f\"L'attribut enfants [{enfants}] doit \u00eatre un entier &gt;=0\")\n\n    @salaire.setter\n    def salaire(self, salaire):\n        # salaire doit \u00eatre un entier &gt;=0\n        try:\n            salaire = int(salaire)\n            erreur = salaire &lt; 0\n        except:\n            erreur = True\n        if not erreur:\n            self.__salaire = salaire\n        else:\n            raise Imp\u00f4tsError(33, f\"L'attribut salaire [{salaire}] doit \u00eatre un entier &gt;=0\")\n\n    @imp\u00f4t.setter\n    def imp\u00f4t(self, imp\u00f4t):\n        # imp\u00f4t doit \u00eatre un entier &gt;=0\n        try:\n            imp\u00f4t = int(imp\u00f4t)\n            erreur = imp\u00f4t &lt; 0\n        except:\n            erreur = True\n        if not erreur:\n            self.__imp\u00f4t = imp\u00f4t\n        else:\n            raise Imp\u00f4tsError(34, f\"L'attribut imp\u00f4t [{imp\u00f4t}] doit \u00eatre un nombre &gt;=0\")\n\n    @d\u00e9c\u00f4te.setter\n    def d\u00e9c\u00f4te(self, d\u00e9c\u00f4te):\n        # d\u00e9c\u00f4te doit \u00eatre un entier &gt;=0\n        try:\n            d\u00e9c\u00f4te = int(d\u00e9c\u00f4te)\n            erreur = d\u00e9c\u00f4te &lt; 0\n        except:\n            erreur = True\n        if not erreur:\n            self.__d\u00e9c\u00f4te = d\u00e9c\u00f4te\n        else:\n            raise Imp\u00f4tsError(35, f\"L'attribut d\u00e9c\u00f4te [{d\u00e9c\u00f4te}] doit \u00eatre un nombre &gt;=0\")\n\n    @surc\u00f4te.setter\n    def surc\u00f4te(self, surc\u00f4te):\n        # surc\u00f4te doit \u00eatre un entier &gt;=0\n        try:\n            surc\u00f4te = int(surc\u00f4te)\n            erreur = surc\u00f4te &lt; 0\n        except:\n            erreur = True\n        if not erreur:\n            self.__surc\u00f4te = surc\u00f4te\n        else:\n            raise Imp\u00f4tsError(36, f\"L'attribut surc\u00f4te [{surc\u00f4te}] doit \u00eatre un nombre &gt;=0\")\n\n    @r\u00e9duction.setter\n    def r\u00e9duction(self, r\u00e9duction):\n        # surc\u00f4te doit \u00eatre un entier &gt;=0\n        try:\n            r\u00e9duction = int(r\u00e9duction)\n            erreur = r\u00e9duction &lt; 0\n        except:\n            erreur = True\n        if not erreur:\n            self.__r\u00e9duction = r\u00e9duction\n        else:\n            raise Imp\u00f4tsError(37, f\"L'attribut r\u00e9duction [{r\u00e9duction}] doit \u00eatre un nombre &gt;=0\")\n\n    @taux.setter\n    def taux(self, taux):\n        # taux doit \u00eatre un r\u00e9el &gt;=0\n        try:\n            taux = float(taux)\n            erreur = taux &lt; 0\n        except:\n            erreur = True\n        if not erreur:\n            self.__taux = taux\n        else:\n            raise Imp\u00f4tsError(38, f\"L'attribut taux [{taux}] doit \u00eatre un nombre &gt;=0\")\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>la classe [TaxPayer] encapsule un contribuable\u00a0;</li> <li>ligne 7\u00a0: la classe [TaxPayer] d\u00e9rive de la classe [BaseEntity]. Elle a donc un identifiant [id]\u00a0;</li> <li>ligne 20\u00a0: aucune propri\u00e9t\u00e9 n\u2019est exclue de l\u2019\u00e9tat d\u2019un objet [AdminData]\u00a0;</li> <li>lignes 22-25\u00a0: les propri\u00e9t\u00e9s de la classe. Celles-ci sont explicit\u00e9es aux lignes 9-17\u00a0;</li> <li>lignes 27-58\u00a0: getters des attributs de la classe\u00a0;</li> <li>lignes 60-161\u00a0: les setters des attributs de la classe. On rappelle que l\u2019int\u00e9r\u00eat d\u2019une classe encapsulant des donn\u00e9es vis-\u00e0-vis d\u2019un simple dictionnaire est que la classe peut v\u00e9rifier la validit\u00e9 de ses propri\u00e9t\u00e9s gr\u00e2ce \u00e0 ses setters\u00a0;</li> </ul>"},{"location":"exercice-dx27application---version-4.html#1512-la-couche-dao","title":"15.1.2. La couche [dao]","text":"<p>Nous allons r\u00e9unir les impl\u00e9mentations des couches dans un dossier [services]. Ces classes impl\u00e9menteront des interfaces d\u00e9finies dans le dossier [interfaces].</p> <p></p>"},{"location":"exercice-dx27application---version-4.html#15121-linterface-interfaceimpotsdao","title":"15.1.2.1. L'interface [InterfaceImp\u00f4tsDao]","text":"<p>La couche [dao] impl\u00e9mentera l'interface [InterfaceImp\u00f4tsDao] suivante (fichier InterfaceImp\u00f4tsDao.py)\u00a0:</p> <pre><code># imports\nfrom abc import ABC, abstractmethod\n\n\n# interface IImp\u00f4tsDao\nfrom AdminData import AdminData\n\n\nclass InterfaceImp\u00f4tsDao(ABC):\n    # liste des tranches de l'imp\u00f4t\n    @abstractmethod\n    def get_admindata(self) -&gt; AdminData:\n        pass\n\n    # liste des donn\u00e9es contribuables\n    @abstractmethod\n    def get_taxpayers_data(self) -&gt; dict:\n        pass\n\n    # \u00e9criture des r\u00e9sultats du calcul de l'imp\u00f4t\n    @abstractmethod\n    def write_taxpayers_results(self, taxpayers_results: list):\n        pass\n</code></pre> <p>L'interface d\u00e9finit trois m\u00e9thodes\u00a0:</p> <ul> <li>[get_admindata]\u00a0: est la m\u00e9thode qui obtient le tableau des tranches d'imp\u00f4t. On notera qu'on ne donne aucun renseignement sur la fa\u00e7on d'obtenir ces donn\u00e9es. Dans la suite, elles seront trouv\u00e9es d'abord dans un fichier texte puis dans une base de donn\u00e9es. Ce seront aux classes qui impl\u00e9mentent l'interface de s'adapter au mode de stockage des donn\u00e9es. On aura donc une classe pour r\u00e9cup\u00e9rer les tranches d'imp\u00f4t dans un fichier texte et une autre pour les r\u00e9cup\u00e9rer dans une base de donn\u00e9es. Elles impl\u00e9menteront toutes deux la m\u00e9thode [get_admindata]\u00a0;</li> <li>[get_taxpayers_data]\u00a0: est la m\u00e9thode qui obtient les donn\u00e9es des contribuables. L\u00e0 encore nous ne disons pas o\u00f9 elles seront trouv\u00e9es. Nous ne traiterons que le cas o\u00f9 elles sont dans un fichier texte\u00a0;</li> <li>[write_taxpayers_results]\u00a0: est la m\u00e9thode qui va persister les r\u00e9sultats du calcul de l'imp\u00f4t. Nous ne disons pas o\u00f9. Nous ne traiterons que le cas o\u00f9 les r\u00e9sultats sont persist\u00e9s dans un fichier texte. Le param\u00e8tre [taxpayers_results] sera la liste des r\u00e9sultats \u00e0 persister\u00a0;</li> </ul>"},{"location":"exercice-dx27application---version-4.html#15122-la-classe-abstractimpotsdao","title":"15.1.2.2. La classe [AbstractImp\u00f4tsDao]","text":"<p>La couche [dao] va \u00eatre impl\u00e9ment\u00e9e par deux classes\u00a0:</p> <ul> <li>l'une ira chercher les donn\u00e9es (contribuables, r\u00e9sultats, tranches d'imp\u00f4t) dans des fichiers texte\u00a0;</li> <li> <p>l'autre ira chercher les donn\u00e9es (contribuables, r\u00e9sultats) dans des fichiers texte et les tranches de l'imp\u00f4t dans une base de donn\u00e9es\u00a0; Les deux classes ne vont diff\u00e9rer que par la gestion des tranches de l'imp\u00f4t. Les donn\u00e9es contribuables et les r\u00e9sultats des calculs de l'imp\u00f4t seront, elles, g\u00e9r\u00e9es de la m\u00eame fa\u00e7on. Pour cette raison, nous allons les g\u00e9rer dans une classe parent [AbstractImp\u00f4tsDao]. La particularit\u00e9 de la gestion des tranches d'imp\u00f4t sera, elle, g\u00e9r\u00e9e dans deux classes filles\u00a0:</p> </li> <li> <p>la classe [Imp\u00f4tsDaoWithAdminDataInJsonFile] ira chercher les tranches de l'imp\u00f4t dans un fichier texte au format jSON\u00a0;</p> </li> <li>la classe [Imp\u00f4tsDaoWithAdminDataInDatabase]  ira chercher les tranches de l'imp\u00f4t dans une base de donn\u00e9es\u00a0; La classe parent [AbstractImp\u00f4tsDao] sera la suivante\u00a0:</li> </ul> <pre><code># imports\nimport codecs\nimport json\nfrom abc import abstractmethod\n\nfrom AdminData import AdminData\nfrom Imp\u00f4tsError import Imp\u00f4tsError\nfrom InterfaceImp\u00f4tsDao import InterfaceImp\u00f4tsDao\nfrom TaxPayer import TaxPayer\n\n\n# classe de base pour la couche [dao]\nclass AbstractImp\u00f4tsDao(InterfaceImp\u00f4tsDao):\n    # les contribuables et leur imp\u00f4t seront dans des fichiers texte\n    # constructeur\n    def __init__(self, config: dict):\n        # config[taxpayersFilename] : le nom du fichier texte des contribuables\n        # config[resultsFilename] : le nom du fichier jSON des r\u00e9sultats\n        # config[errorsFilename] : le nom du fichier des erreurs\n\n        # on m\u00e9morise les param\u00e8tres\n        self.taxpayers_filename = config.get(\"taxpayersFilename\")\n        self.taxpayers_results_filename = config.get(\"resultsFilename\")\n        self.errors_filename = config.get(\"errorsFilename\")\n\n    # ------------------\n    # interface IImp\u00f4tsDao\n    # ------------------\n\n    # liste des donn\u00e9es contribuables\n    def get_taxpayers_data(self) -&gt; dict:\n        \u2026\n\n    # \u00e9criture de l'imp\u00f4t des contribuables\n    def write_taxpayers_results(self, taxpayers: list):\n        \u2026\n\n    # lecture des tranches de l'imp\u00f4t\n    @abstractmethod\n    def get_admindata(self) -&gt; AdminData:\n        pass\n</code></pre> <ul> <li>ligne 13\u00a0: la classe [AbstractImp\u00f4tsDao] impl\u00e9mente l'interface [InterfaceImp\u00f4tsDao]. Aussi trouve-t-on les trois m\u00e9thodes de cette interface\u00a0:</li> <li>[get_taxpayers_data]\u00a0: ligne 31\u00a0;</li> <li>[write_taxpayers_results]\u00a0: ligne 35\u00a0;</li> <li>[get_admindata]\u00a0: ligne 40. Cette m\u00e9thode ne sera pas impl\u00e9ment\u00e9e par la classe [AbstractImp\u00f4tsDao] aussi est-elle d\u00e9clar\u00e9e abstraite (ligne 39)\u00a0;</li> <li>ligne 16\u00a0: le constructeur re\u00e7oit un dictionnaire [config] contenant les informations suivantes\u00a0:</li> <li>[taxpayersFilename]\u00a0: le nom du fichier texte qui contient les donn\u00e9es des contribuables\u00a0;</li> <li>[resultsFilename]\u00a0: le nom du fichier texte dans lequel seront mis les r\u00e9sultats\u00a0;</li> <li>[errorsFilename]\u00a0: le nom du fichier texte listant les erreurs rencontr\u00e9es lors de l\u2019exploitation du fichier [taxpayersFilename]\u00a0; La m\u00e9thode [get_taxpayers_data] est la suivante\u00a0:</li> </ul> <pre><code>    # liste des donn\u00e9es contribuables\n    def get_taxpayers_data(self) -&gt; dict:\n        # initialisations\n        taxpayers_data = []\n        datafile = None\n        erreurs = []\n        try:\n            # ouverture du fichier des donn\u00e9es\n            datafile = open(self.taxpayers_filename, \"r\")\n            # on exploite la ligne courante du fichier\n            ligne = datafile.readline()\n            # n\u00b0 de ligne\n            numligne = 0\n            while ligne != '':\n                # une ligne de +\n                numligne += 1\n                # on enl\u00e8ve les blancs\n                ligne = ligne.strip()\n                # on ignore les lignes vides et les commentaires\n                if ligne != \"\" and ligne[0] != \"#\":\n                    try:\n                        # on r\u00e9cup\u00e8re les 4 champs id,mari\u00e9,enfants,salaire qui forment la ligne contribuable\n                        (id, mari\u00e9, enfants, salaire) = ligne.split(\",\")\n                        # on cr\u00e9e un nouveau TaxPayer\n                        taxpayers_data.append(\n                            TaxPayer().fromdict({'id': id, 'mari\u00e9': mari\u00e9, 'enfants': enfants, 'salaire': salaire}))\n                    except BaseException as erreur:\n                        # on note l'erreur\n                        erreurs.append(f\"Ligne {numligne}, {erreur}\")\n                # on lit une nouvelle ligne contribuable\n                ligne = datafile.readline()\n            # on enregistre les erreurs s'il y en a\n            if erreurs:\n                text = f\"Analyse du fichier {self.taxpayers_filename}\\n\\n\" + \"\\n\".join(erreurs)\n                with codecs.open(self.errors_filename, \"w\", \"utf-8\") as fd:\n                    fd.write(text)\n            # on rend le r\u00e9sultat\n            return {\"taxpayers\": taxpayers_data, \"erreurs\": erreurs}\n        except BaseException as erreur:\n            # on lance une exception Imp\u00f4tsError\n            raise Imp\u00f4tsError(11, f\"{erreur}\")\n        finally:\n            # on ferme le fichier\n            if datafile:\n                datafile.close()\n</code></pre> <ul> <li>ligne 4\u00a0: les donn\u00e9es des contribuables (mari\u00e9, enfants, salaire) seront plac\u00e9es dans une liste d'objets de type [TaxPayer]\u00a0;</li> <li>lignes 8-9\u00a0: on ouvre le fichier texte des contribuables en lecture. Son contenu a la forme suivante\u00a0: <pre><code># donn\u00e9es valides : id, mari\u00e9, enfants, salaire\n1,oui,2,55555\n2,oui,2,50000\n3,oui,3,50000\n4,non,2,100000\n5,non,3,100000\n6,oui,3,100000\n7,oui,5,100000\n8,non,0,100000\n9,oui,2,30000\n10,non,0,200000\n11,oui,3,200000\n# on peut avoir des lignes vides\n\n# on cr\u00e9e des lignes erron\u00e9es\n# pas assez de valeurs\n11,12\n# trop de valeurs\n12,oui,3,200000, x, y\n# des valeurs erron\u00e9es\nx,x,x,x\n</code></pre></li> </ul> <p>Par rapport aux versions pr\u00e9c\u00e9dentes\u00a0:</p> <ul> <li>chaque ligne du fichier [taxpayersFilename] commence par l'identifiant du contribuable, un simple num\u00e9ro\u00a0;</li> <li>les commentaires et les lignes vides sont autoris\u00e9s\u00a0;</li> <li> <p>on va g\u00e9rer les erreurs. Ainsi les lignes 17, 19 et 21 doivent \u00eatre d\u00e9clar\u00e9es erron\u00e9es. Les erreurs sont consign\u00e9es dans un fichier \u00e0 part\u00a0; Continuons l\u2019examen du code\u00a0:</p> </li> <li> <p>ligne 4\u00a0: les donn\u00e9es du fichier texte sont transf\u00e9r\u00e9es dans la liste [taxPayersData]\u00a0;</p> </li> <li>lignes 14-31\u00a0: le fichier des contribuables est lu ligne par ligne\u00a0;</li> <li>ligne 14\u00a0: la fin du fichier est atteinte lorsqu\u2019on lit une ligne vide\u00a0(rien \u2013 pas m\u00eame la marque de fin de ligne \\r\\n)\u00a0;</li> <li>ligne 20\u00a0: on ignore les lignes vides et les commentaires. Une ligne est un commentaire si, une fois la ligne d\u00e9barrass\u00e9e de ses blancs devant et derri\u00e8re le texte, le 1er caract\u00e8re est le caract\u00e8re #\u00a0;</li> <li>ligne 24\u00a0: une ligne correcte est compos\u00e9e de quatre champs s\u00e9par\u00e9s par une virgule. On r\u00e9cup\u00e8re ceux-ci. L\u2019affectation de donn\u00e9es \u00e0 un tuple de quatre \u00e9l\u00e9ments \u00e9choue s\u2019il n\u2019y a pas exactement quatre donn\u00e9es affect\u00e9es\u00a0;</li> <li>ligne 25\u00a0: si l\u2019un des quatre champs r\u00e9cup\u00e9r\u00e9s [id, mari\u00e9, enfants, salaire] est invalide alors la m\u00e9thode [BaseEntity.fromdict] lancera une exception de type [MyException]\u00a0;</li> <li>lignes 25-26\u00a0: un objet [TaxPayer] est ajout\u00e9 \u00e0 la liste [taxpayers_data] des contribuables\u00a0;</li> <li>lignes 27-29\u00a0: les \u00e9ventuelles erreurs sont cumul\u00e9es dans une liste [erreurs]. Cette liste a \u00e9t\u00e9 cr\u00e9\u00e9e ligne 6\u00a0;</li> <li>lignes 33-36\u00a0: la liste des erreurs rencontr\u00e9es est enregistr\u00e9e dans le fichier texte [errorsFilename]. Elles sont de deux types\u00a0:</li> <li>une ligne n\u2019avait pas le nombre correct de champs attendus\u00a0;</li> <li>les informations de la ligne \u00e9taient erron\u00e9es et ont \u00e9chou\u00e9 \u00e0 construire un objet [TaxPayer]\u00a0;</li> <li>lignes 39-41\u00a0: on intercepte toute erreur (BaseException) et on la remonte en l'encapsulant dans un type [Imp\u00f4tsError]\u00a0;</li> <li>lignes 42-45\u00a0: dans tous les cas, r\u00e9ussite ou \u00e9chec, le fichier texte des contrbuables est ferm\u00e9 s'il a \u00e9t\u00e9 ouvert\u00a0; La m\u00e9thode [write_taxpayers_results] doit produire un fichier jSON de la forme\u00a0:</li> </ul> <pre><code>[\n  {\n    \"id\": 1,\n    \"mari\u00e9\": \"oui\",\n    \"enfants\": 2,\n    \"salaire\": 55555,\n    \"imp\u00f4t\": 2814,\n    \"surc\u00f4te\": 0,\n    \"taux\": 0.14,\n    \"d\u00e9c\u00f4te\": 0,\n    \"r\u00e9duction\": 0\n  },\n  {\n    \"id\": 2,\n    \"mari\u00e9\": \"oui\",\n    \"enfants\": 2,\n    \"salaire\": 50000,\n    \"imp\u00f4t\": 1384,\n    \"surc\u00f4te\": 0,\n    \"taux\": 0.14,\n    \"d\u00e9c\u00f4te\": 384,\n    \"r\u00e9duction\": 347\n  },\n  {\n    \"id\": 3,\n    \"mari\u00e9\": \"oui\",\n    \"enfants\": 3,\n    \"salaire\": 50000,\n    \"imp\u00f4t\": 0,\n    \"surc\u00f4te\": 0,\n    \"taux\": 0.14,\n    \"d\u00e9c\u00f4te\": 720,\n    \"r\u00e9duction\": 0\n  },\n  \u2026\n]\n</code></pre> <p>La m\u00e9thode [write_taxpayers_results] est la suivante\u00a0:</p> <pre><code>    # \u00e9criture de l'imp\u00f4t des contribuables\n    def write_taxpayers_results(self, taxpayers: list):\n        # \u00e9criture des r\u00e9sultats dans un fichier jSON\n        # taxpayers : liste d'objets de type TaxPayer\n        # (id, mari\u00e9, enfants, salaire, imp\u00f4t, surc\u00f4te, d\u00e9c\u00f4te, r\u00e9duction, taux)\n        # la liste [taxpayers] est enregistr\u00e9e dans le fichier texte [self.taxpayers_results_filename]\n        file = None\n        try:\n            # ouverture du fichier des r\u00e9sultats\n            file = codecs.open(self.taxpayers_results_filename, \"w\", \"utf8\")\n            # cr\u00e9ation de la liste \u00e0 s\u00e9rialiser en jSON\n            mapping = map(lambda taxpayer: taxpayer.asdict(), taxpayers)\n            # s\u00e9rialisation jSON\n            json.dump(list(mapping), file, ensure_ascii=False)\n        except BaseException as erreur:\n            # on relance l'erreur sous un autre type\n            raise Imp\u00f4tsError(12, f\"{erreur}\")\n        finally:\n            # on ferme le fichier s'il a \u00e9t\u00e9 ouvert\n            if file:\n                file.close()\n</code></pre> <ul> <li>ligne 2\u00a0: la m\u00e9thode re\u00e7oit une liste de contribuables [taxpayers] qu'elle doit enregistrer dans le fichier texte [self.taxpayers_results_filename] au format jSON\u00a0;</li> <li>ligne 10\u00a0: cr\u00e9ation du fichier UTF-8 des r\u00e9sultats\u00a0;</li> <li>ligne 12\u00a0: nous introduisons ici la fonction [map] dont la syntaxe ici est [map (fonction, liste1)]. La fonction [fonction] est appliqu\u00e9e \u00e0 chaque \u00e9l\u00e9ment de [liste1] et produit un nouvel \u00e9l\u00e9ment qui alimente une liste [liste2]. Finalement, pour chaque i\u00a0: <pre><code>liste2[i]=fonction(liste1[i])\n</code></pre></li> </ul> <p>Ici, [liste1] est la liste [taxPayers], une liste d'objets de type [TaxPayer]. La fonction [fonction] est exprim\u00e9e ici sous la forme d'une fonction dite [lambda] qui exprime la transformation faite sur un \u00e9l\u00e9ment [taxpayer] de la liste [taxpayers]\u00a0: chaque \u00e9l\u00e9ment [taxpayer] est remplac\u00e9 par son dictionnaire [taxpayer.asdict()]. Finalement, la liste [liste2] obtenue est la liste des dictionnaires des \u00e9l\u00e9ments de la liste [taxpayers]\u00a0;</p> <ul> <li>ligne 12\u00a0: le r\u00e9sultat rendu par la fonction [map] n'est pas la liste [liste2] mais un objet de type [map]. Pour avoir [liste2], il faut utiliser l'expression [list(mapping)] (ligne 14)\u00a0;</li> <li>ligne 14\u00a0: la liste [liste2] est enregistr\u00e9e au format jSON dans le fichier [self.taxpayers_results_filename]\u00a0;</li> <li>lignes 15-17\u00a0: tout type d'exception est intercept\u00e9 et encapsul\u00e9 dans une erreur de type [Imp\u00f4tsError] avant d'\u00eatre relanc\u00e9 (ligne 17)\u00a0;</li> <li>lignes 19-21\u00a0: dans tous les cas, r\u00e9ussite ou \u00e9chec, le fichier des r\u00e9sultats est ferm\u00e9 s'il a \u00e9t\u00e9 ouvert\u00a0;</li> </ul>"},{"location":"exercice-dx27application---version-4.html#15123-classe-impotsdaowithadmindatainjsonfile","title":"15.1.2.3. Classe [Imp\u00f4tsDaoWithAdminDataInJsonFile]","text":"<p>La classe [Imp\u00f4tsDaoWithAdminDataInJsonFile] va d\u00e9river de la classe [AbstractImp\u00f4tsDao] et impl\u00e9menter la m\u00e9thode [getAdminData] que sa classe parent n'a pas impl\u00e9ment\u00e9e. Elle ira chercher les donn\u00e9es de l'administration fiscale dans un fichier jSON\u00a0:</p> <pre><code>{\n    \"limites\": [9964, 27519, 73779, 156244, 0],\n    \"coeffr\": [0, 0.14, 0.3, 0.41, 0.45],\n    \"coeffn\": [0, 1394.96, 5798, 13913.69, 20163.45],\n    \"plafond_qf_demi_part\": 1551,\n    \"plafond_revenus_celibataire_pour_reduction\": 21037,\n    \"plafond_revenus_couple_pour_reduction\": 42074,\n    \"valeur_reduc_demi_part\": 3797,\n    \"plafond_decote_celibataire\": 1196,\n    \"plafond_decote_couple\": 1970,\n    \"plafond_impot_couple_pour_decote\": 2627,\n    \"plafond_impot_celibataire_pour_decote\": 1595,\n    \"abattement_dixpourcent_max\": 12502,\n    \"abattement_dixpourcent_min\": 437\n}\n</code></pre> <p>La classe [Imp\u00f4tsDaoWithAdminDataInJsonFile] est la suivante\u00a0:</p> <pre><code># imports\nimport codecs\nimport json\n\nfrom AbstractImp\u00f4tsDao import AbstractImp\u00f4tsDao\nfrom AdminData import AdminData\nfrom Imp\u00f4tsError import Imp\u00f4tsError\n\n\n# une impl\u00e9mentation de la couche [dao] o\u00f9 les donn\u00e9es de l'administration fiscale sont dans un fichier jSON\nclass Imp\u00f4tsDaoWithAdminDataInJsonFile(AbstractImp\u00f4tsDao):\n    # constructeur\n    def __init__(self, config: dict):\n        # config[admindataFilename] : le nom du fichier jSON contenant les donn\u00e9es de l'administration fiscale\n        # config[taxpayersFilename] : le nom du fichier texte des contribuables\n        # config[resultsFilename] : le nom du fichier jSON des r\u00e9sultats\n        # config[errorsFilename] : le nom du fichier des erreurs\n\n        # initialisation de la classe Parent\n        AbstractImp\u00f4tsDao.__init__(self, config)\n        # lecture des donn\u00e9es de l'administration fiscale\n        file = None\n        try:\n            # ouverture du fichier jSON des donn\u00e9es fiscales en lecture\n            file = codecs.open(config[\"admindataFilename\"], \"r\", \"utf8\")\n            # transfert du contenu du fichier jSON dans un objet [AdminData]\n            self.admindata = AdminData().fromdict(json.load(file))\n        except BaseException as erreur:\n            # on relance l'erreur sous la forme d'un type [Imp\u00f4tsError]\n            raise Imp\u00f4tsError(21, f\"{erreur}\")\n        finally:\n            # fermeture du fichier s'il a \u00e9t\u00e9 ouvert\n            if file:\n                file.close()\n\n    # -------------\n    # interface\n    # -------------\n\n    # r\u00e9cup\u00e9ration des donn\u00e9es de l'administration fiscale\n    # la m\u00e9thode rend un objet [AdminData]\n    def get_admindata(self) -&gt; AdminData:\n        return self.admindata\n</code></pre> <ul> <li>ligne 11\u00a0: la classe [Imp\u00f4tsDaoWithAdminDataInJsonFile] h\u00e9rite de la classe [AbstractImp\u00f4tsDao]. A ce titre elle impl\u00e9mente l'interface [InterfaceImp\u00f4tsDao]\u00a0;</li> <li>ligne 13\u00a0: le constructeur re\u00e7oit en param\u00e8tre un dictionnaire contenant les informations des lignes 14-17\u00a0;</li> <li>ligne 20\u00a0: la classe parent est initialis\u00e9e\u00a0;</li> <li>ligne 24\u00a0: ouverture du fichier jSON des donn\u00e9es de l'administration fiscale\u00a0;</li> <li>ligne 25\u00a0: le fichier UTF-8 des donn\u00e9es de l\u2019administration fiscale est ouvert\u00a0;</li> <li>ligne 27\u00a0: le contenu du fichier est lu et plac\u00e9 dans l\u2019objet [self.admindata]\u00a0de type [AdminData]. Il faut que les cl\u00e9s du fichier jSON correspondent aux propri\u00e9t\u00e9s accept\u00e9es pour un objet [AdminData] sinon la m\u00e9thode [fromdict] lancera une exception\u00a0;</li> <li>lignes 28-30\u00a0: gestion des exceptions. Les exceptions qui peuvent se produire sont encapsul\u00e9es dans un type [Imp\u00f4tsError] avant d'\u00eatre relanc\u00e9es\u00a0;</li> <li>lignes 32-34\u00a0: le fichier est ferm\u00e9 s'il a \u00e9t\u00e9 ouvert\u00a0;</li> <li>lignes 42-43\u00a0: impl\u00e9mentation de la m\u00e9thode [get_admindata] de l'interface [InterfaceImp\u00f4tsDao]\u00a0;</li> </ul>"},{"location":"exercice-dx27application---version-4.html#1513-la-couche-metier","title":"15.1.3. La couche [m\u00e9tier]","text":""},{"location":"exercice-dx27application---version-4.html#15131-linterface-interfaceimpotsmetier","title":"15.1.3.1. L'interface [InterfaceImp\u00f4tsM\u00e9tier]","text":"<p>L'interface de la couche [m\u00e9tier] sera la suivante\u00a0:</p> <pre><code># imports\nfrom abc import ABC, abstractmethod\n\nfrom AdminData import AdminData\nfrom TaxPayer import TaxPayer\n\n\n# interface IImp\u00f4tsM\u00e9tier\nclass InterfaceImp\u00f4tsM\u00e9tier(ABC):\n    # calcul de l'imp\u00f4t pour 1 contribuable\n    @abstractmethod\n    def calculate_tax(self, taxpayer: TaxPayer, admindata: AdminData):\n        pass\n</code></pre> <ul> <li>l'interface [InterfaceImp\u00f4tsM\u00e9tier] d\u00e9finit une unique m\u00e9thode\u00a0:</li> <li>ligne 12\u00a0: la m\u00e9thode [calculate_tax] permet de calculer l'imp\u00f4t d'un unique contribuable [taxpayer]. [admindata] est l\u2019objet [AdminData] encapsulant les donn\u00e9es de l'administration fiscale\u00a0;</li> <li>ligne 12\u00a0: la m\u00e9thode [calculate_tax] ne rend pas de r\u00e9sultat. Les donn\u00e9es obtenues (imp\u00f4t, surc\u00f4te, d\u00e9c\u00f4te, r\u00e9duction, taux) sont incluses dans le param\u00e8tre [taxpayer]\u00a0: avant l'appel ces attributs sont vides, apr\u00e8s l'appel ils ont \u00e9t\u00e9 initialis\u00e9s\u00a0;</li> </ul>"},{"location":"exercice-dx27application---version-4.html#15132-la-classe-impotsmetier","title":"15.1.3.2. La classe [Imp\u00f4tsM\u00e9tier]","text":"<p>La classe [Imp\u00f4tsM\u00e9tier] impl\u00e9mente l'interface [InterfaceImp\u00f4tsM\u00e9tier] de la fa\u00e7on suivante\u00a0:</p> <p></p> <p>Les m\u00e9thodes de la classe sont issues du module [imp\u00f4ts_module_02] du paragraphe |Le module [impots.v02.modules.imp\u00f4ts_module_02]|. On a seulement limit\u00e9 les param\u00e8tres des m\u00e9thodes \u00e0 deux\u00a0:</p> <ul> <li>taxpayer(id, mari\u00e9, enfants, salaire, imp\u00f4t, d\u00e9c\u00f4te, surc\u00f4te, r\u00e9duction, taux)\u00a0: l'objet repr\u00e9sentant un contribuable et son imp\u00f4t\u00a0;</li> <li>admindata\u00a0: l\u2019objet encapsulant les donn\u00e9es de l'administration fiscale\u00a0; Nous montrons sur une m\u00e9thode les changements ainsi apport\u00e9s\u00a0;</li> </ul> <pre><code>    # calcul de l'imp\u00f4t - phase 1\n    # ----------------------------------------\n    def calculate_tax(self, taxpayer: TaxPayer, admindata: AdminData):\n        # taxpayer(id, mari\u00e9, enfants, salaire, imp\u00f4t, d\u00e9c\u00f4te, surc\u00f4te, r\u00e9duction, taux)\n        # admindata : donn\u00e9es de l'administration fiscale\n\n        # calcul de l'imp\u00f4t avec enfants\n        self.calculate_tax_2(taxpayer, admindata)\n        # les r\u00e9sultats sont dans taxpayer\n        taux1 = taxpayer.taux\n        surc\u00f4te1 = taxpayer.surc\u00f4te\n        impot1 = taxpayer.imp\u00f4t\n        # calcul de l'imp\u00f4t sans les enfants\n        if taxpayer.enfants != 0:\n            # calcul de l'imp\u00f4t pour le m\u00eame contribuable sans enfants\n            taxpayer2 = TaxPayer().fromdict(\n                {'id': 0, 'mari\u00e9': taxpayer.mari\u00e9, 'enfants': 0, 'salaire': taxpayer.salaire})\n            self.calculate_tax_2(taxpayer2, admindata)\n            # les r\u00e9sultats sont dans taxpayer2\n            taux2 = taxpayer2.taux\n            surc\u00f4te2 = taxpayer2.surc\u00f4te\n            impot2 = taxpayer2.imp\u00f4t\n            # application du plafonnement du quotient familial\n            if taxpayer.enfants &lt; 3:\n                # PLAFOND_QF_DEMI_PART euros pour les 2 premiers enfants\n                impot2 = impot2 - taxpayer.enfants * admindata.plafond_qf_demi_part\n            else:\n                # PLAFOND_QF_DEMI_PART euros pour les 2 premiers enfants, le double pour les suivants\n                impot2 = impot2 - 2 * admindata.plafond_qf_demi_part - (taxpayer.enfants - 2) \\\n                         * 2 * admindata.plafond_qf_demi_part\n        else:\n            # si le contribuable n'a pas d'enfants alors impot2=impot1\n            impot2 = impot1\n\n        # on prend l'imp\u00f4t le plus fort avec le taux et la surc\u00f4te qui vont avec\n        (impot, surc\u00f4te, taux) = (impot1, surc\u00f4te1, taux1) if impot1 &gt;= impot2 else (\n            impot2, impot2 - impot1 + surc\u00f4te2, taux2)\n\n        # r\u00e9sultats partiels\n        taxpayer.imp\u00f4t = impot\n        taxpayer.surc\u00f4te = surc\u00f4te\n        taxpayer.taux = taux\n        # calcul d'une \u00e9ventuelle d\u00e9c\u00f4te\n        self.get_d\u00e9c\u00f4te(taxpayer, admindata)\n        taxpayer.imp\u00f4t -= taxpayer.d\u00e9c\u00f4te\n        # calcul d'une \u00e9ventuelle r\u00e9duction d'imp\u00f4ts\n        self.get_r\u00e9duction(taxpayer, admindata)\n        taxpayer.imp\u00f4t -= taxpayer.r\u00e9duction\n        # r\u00e9sultat\n        taxpayer.imp\u00f4t = math.floor(taxpayer.imp\u00f4t)\n</code></pre> <ul> <li>ligne 3: la m\u00e9thode [calculate_tax] est l'unique m\u00e9thode de l'interface [InterfaceImp\u00f4tsM\u00e9tier]. Elle admet deux param\u00e8tres\u00a0:</li> <li>[tapPayer]\u00a0: le contribuable dont on calcule l'imp\u00f4t\u00a0;</li> <li>[admindata]\u00a0: l\u2019objet encapsulant les donn\u00e9es de l'administration fiscale\u00a0;</li> <li>les r\u00e9sultats du calcul sont encapsul\u00e9s dans le param\u00e8tre [taxpayer] (lignes 40-50). Le contenu de cet objet n'est donc pas le m\u00eame avant et apr\u00e8s l'appel \u00e0 la m\u00e9thode\u00a0;</li> </ul>"},{"location":"exercice-dx27application---version-4.html#1514-tests-des-couches-dao-et-metier","title":"15.1.4. Tests des couches [dao] et [m\u00e9tier]","text":"<ul> <li>[TestDaoM\u00e9tier] est la classe UnitTest de test des couches [dao] et [m\u00e9tier]\u00a0;</li> <li>[config] est le fichier de configuration des tests\u00a0;  La configuration [config] est la suivante\u00a0:</li> </ul> <pre><code>def\u00a0configure():\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a01\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0du\u00a0python\u00a0Path\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0de\u00a0ce\u00a0fichier\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0root_dir\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes\"\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\u00a0absolues\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/02/entities\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fixe\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a02\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0chemins\u00a0absolus\u00a0des\u00a0fichiers\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"admindataFilename\":\u00a0f\"{script_dir}/../data/input/admindata.json\"\n\u00a0\u00a0\u00a0\u00a0}\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0from\u00a0Imp\u00f4tsDaoWithAdminDataInJsonFile\u00a0import\u00a0Imp\u00f4tsDaoWithAdminDataInJsonFile\n\u00a0\u00a0\u00a0\u00a0from\u00a0Imp\u00f4tsM\u00e9tier\u00a0import\u00a0Imp\u00f4tsM\u00e9tier\n\n\u00a0\u00a0\u00a0\u00a0dao\u00a0=\u00a0Imp\u00f4tsDaoWithAdminDataInJsonFile(config)\n\u00a0\u00a0\u00a0\u00a0m\u00e9tier\u00a0=\u00a0Imp\u00f4tsM\u00e9tier()\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0met\u00a0les\u00a0instances\u00a0de\u00a0couches\u00a0dans\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0config[\"dao\"]\u00a0=\u00a0dao\n\u00a0\u00a0\u00a0\u00a0config[\"m\u00e9tier\"]\u00a0=\u00a0m\u00e9tier\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <ul> <li>lignes 4-23\u00a0: on configure le Python Path des tests\u00a0;</li> <li>lignes 32-41\u00a0: on instancie les couches [dao] et [m\u00e9tier]. On met leurs r\u00e9f\u00e9rences dans le dictionnaire [config]\u00a0;</li> <li>ligne 44\u00a0: on rend ce dictionnaire\u00a0; La classe de test [TestDaoM\u00e9tier] est la suivante\u00a0:</li> </ul> <pre><code>import unittest\n\n\ndef get_config() -&gt; dict:\n    # configuration de l'application\n    import config\n    # on rend la configuration\n    return config.configure()\n\n\nclass TestDaoM\u00e9tier(unittest.TestCase):\n\n    # ex\u00e9cut\u00e9e avant chaque m\u00e9thode test_\n    def setUp(self) -&gt; None:\n        # on r\u00e9cup\u00e8re la configuration des tests\n        config = get_config()\n        # on m\u00e9morise quelques informations\n        self.m\u00e9tier = config['m\u00e9tier']\n        self.admindata = config['dao'].get_admindata()\n\n    def test_1(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 55555,\n        # 'imp\u00f4t': 2814, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.14}\n        taxpayer = TaxPayer().fromdict({\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555})\n        self.m\u00e9tier.calculate_tax(taxpayer, self.admindata)\n        # v\u00e9rification\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 2815, delta=1)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.14, delta=0.01)\n        self.assertEqual(taxpayer.surc\u00f4te, 0)\n\n    def test_2(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 50000,\n        # 'imp\u00f4t': 1384, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 384, 'r\u00e9duction': 347, 'taux': 0.14}\n        taxpayer = TaxPayer().fromdict({'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 50000})\n        self.m\u00e9tier.calculate_tax(taxpayer, self.admindata)\n        # v\u00e9rifications\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 1384, delta=1)\n        self.assertAlmostEqual(taxpayer.d\u00e9c\u00f4te, 384, delta=1)\n        self.assertAlmostEqual(taxpayer.r\u00e9duction, 347, delta=1)\n        self.assertAlmostEqual(taxpayer.taux, 0.14, delta=0.01)\n        self.assertEqual(taxpayer.surc\u00f4te, 0)\n\n    def test_3(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 50000,\n        # 'imp\u00f4t': 0, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 720, 'r\u00e9duction': 0, 'taux': 0.14}\n        taxpayer = TaxPayer().fromdict({'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 50000})\n        self.m\u00e9tier.calculate_tax(taxpayer, self.admindata)\n        # v\u00e9rifications\n        self.assertEqual(taxpayer.imp\u00f4t, 0)\n        self.assertAlmostEqual(taxpayer.d\u00e9c\u00f4te, 720, delta=1)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.14, delta=0.01)\n        self.assertEqual(taxpayer.surc\u00f4te, 0)\n\n    def test_4(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'non', 'enfants': 2, 'salaire': 100000,\n        # 'imp\u00f4t': 19884, 'surc\u00f4te': 4480, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.41}\n        taxpayer = TaxPayer().fromdict({'mari\u00e9': 'non', 'enfants': 2, 'salaire': 100000})\n        self.m\u00e9tier.calculate_tax(taxpayer, self.admindata)\n        # v\u00e9rifications\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 19884, delta=1)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.41, delta=0.01)\n        self.assertAlmostEqual(taxpayer.surc\u00f4te, 4480, delta=1)\n\n    def test_5(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'non', 'enfants': 3, 'salaire': 100000,\n        # 'imp\u00f4t': 16782, 'surc\u00f4te': 7176, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.41}\n        taxpayer = TaxPayer().fromdict({'mari\u00e9': 'non', 'enfants': 3, 'salaire': 100000})\n        self.m\u00e9tier.calculate_tax(taxpayer, self.admindata)\n        # v\u00e9rifications\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 16782, delta=1)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.41, delta=0.01)\n        self.assertAlmostEqual(taxpayer.surc\u00f4te, 7176, delta=1)\n\n    def test_6(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 100000,\n        # 'imp\u00f4t': 9200, 'surc\u00f4te': 2180, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.3}\n        taxpayer = TaxPayer().fromdict({'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 100000})\n        self.m\u00e9tier.calculate_tax(taxpayer, self.admindata)\n        # v\u00e9rifications\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 9200, delta=1)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.3, delta=0.01)\n        self.assertAlmostEqual(taxpayer.surc\u00f4te, 2180, delta=1)\n\n    def test_7(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'oui', 'enfants': 5, 'salaire': 100000,\n        # 'imp\u00f4t': 4230, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.14}\n        taxpayer = TaxPayer().fromdict({'mari\u00e9': 'oui', 'enfants': 5, 'salaire': 100000})\n        self.m\u00e9tier.calculate_tax(taxpayer, self.admindata)\n        # v\u00e9rifications\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 4230, delta=1)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.14, delta=0.01)\n        self.assertEqual(taxpayer.surc\u00f4te, 0)\n\n    def test_8(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'non', 'enfants': 0, 'salaire': 100000,\n        # 'imp\u00f4t': 22986, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.41}\n        taxpayer = TaxPayer().fromdict({'mari\u00e9': 'non', 'enfants': 0, 'salaire': 100000})\n        self.m\u00e9tier.calculate_tax(taxpayer, self.admindata)\n        # v\u00e9rifications\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 22986, delta=1)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.41, delta=0.01)\n        self.assertEqual(taxpayer.surc\u00f4te, 0)\n\n    def test_9(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 30000,\n        # 'imp\u00f4t': 0, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0}\n        taxpayer = TaxPayer().fromdict({'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 30000})\n        self.m\u00e9tier.calculate_tax(taxpayer, self.admindata)\n        # v\u00e9rifications\n        self.assertEqual(taxpayer.imp\u00f4t, 0)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.0, delta=0.01)\n        self.assertEqual(taxpayer.surc\u00f4te, 0)\n\n    def test_10(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'non', 'enfants': 0, 'salaire': 200000,\n        # 'imp\u00f4t': 64210, 'surc\u00f4te': 7498, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.45}\n        taxpayer = TaxPayer().fromdict({'mari\u00e9': 'non', 'enfants': 0, 'salaire': 200000})\n        self.m\u00e9tier.calculate_tax(taxpayer, self.admindata)\n        # v\u00e9rifications\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 64210, 1)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.45, delta=0.01)\n        self.assertAlmostEqual(taxpayer.surc\u00f4te, 7498, delta=1)\n\n    def test_11(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 200000,\n        # 'imp\u00f4t': 42842, 'surc\u00f4te': 17283, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.41}\n        taxpayer = TaxPayer().fromdict({'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 200000})\n        self.m\u00e9tier.calculate_tax(taxpayer, self.admindata)\n        # v\u00e9rifications\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 42842, 1)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.41, delta=0.01)\n        self.assertAlmostEqual(taxpayer.surc\u00f4te, 17283, delta=1)\n\n\nif __name__ == '__main__':\n    unittest.main()\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 11\u00a0: la classe de test \u00e9tend la classe [unittest.TestCase]\u00a0;</li> <li>lignes 13-19\u00a0: dans un test UnitTest, la m\u00e9thode [setUp] est ex\u00e9cut\u00e9e avant chacune des m\u00e9thodes [test_]\u00a0;</li> <li>ligne 16\u00a0: on r\u00e9cup\u00e8re la configuration issue du script [config] \u00e9tudi\u00e9 pr\u00e9c\u00e9demment\u00a0;</li> <li>ligne 18\u00a0: on m\u00e9morise une r\u00e9f\u00e9rence sur la couche [m\u00e9tier]\u00a0;</li> <li>ligne 19\u00a0: on demande \u00e0 la couche [dao] l\u2019objet [AdminData] encapsulant les donn\u00e9es de l\u2019administration fiscale et on le m\u00e9morise\u00a0;</li> <li>lignes 21-173\u00a0: 11 tests dont les r\u00e9sultats ont \u00e9t\u00e9 v\u00e9rifi\u00e9s sur le site officiel des imp\u00f4ts 2019 |https://www3.impots.gouv.fr/simulateur/calcul_impot/2019/simplifie/index.htm|\u00a0;</li> <li>lignes 21-33\u00a0: tous les tests ont \u00e9t\u00e9 construits sur le m\u00eame mod\u00e8le\u00a0;</li> <li>ligne 22\u00a0: on importe la classe [TaxPayer]\u00a0;</li> <li>ligne 24\u00a0: contribuable test\u00e9\u00a0;</li> <li>ligne 25\u00a0: r\u00e9sultats attendus\u00a0;</li> <li>ligne 26\u00a0: construction de l\u2019objet [TaxPayer] du contribuable\u00a0;</li> <li>ligne 27\u00a0: calcul de son imp\u00f4t. Le r\u00e9sultat est dans [taxpayer]\u00a0;</li> <li>lignes 29-33\u00a0: v\u00e9rification des r\u00e9sultats obtenus\u00a0;</li> <li>ligne 29\u00a0: on v\u00e9rifie le montant de l\u2019imp\u00f4t \u00e0 l\u2019euro pr\u00e8s. Les tests ont en effet montr\u00e9 que les r\u00e9sultats obtenus par l\u2019algorithme de ce document pouvaient diff\u00e9rer des chiffres officiels au plus d\u2019un montant de 1 euro\u00a0; L\u2019ex\u00e9cution des tests donne les r\u00e9sultats suivants\u00a0:</li> </ul> <p></p> <pre><code>Testing started at 16:08 ...\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe \"C:\\Program Files\\JetBrains\\PyCharm Community Edition 2020.1.2\\plugins\\python-ce\\helpers\\pycharm\\_jb_unittest_runner.py\" --path C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots/v04/tests/TestDaoM\u00e9tier.py\nLaunching unittests with arguments python -m unittest C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots/v04/tests/TestDaoM\u00e9tier.py in C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\impots\\v04\\tests\n\n\n\nRan 11 tests in 0.055s\n\nOK\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"exercice-dx27application---version-4.html#1515-script-principal","title":"15.1.5. Script principal","text":"<p>Le script principal est configur\u00e9 par le script [config] suivant\u00a0:</p> <pre><code>def\u00a0configure():\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a01\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0du\u00a0python\u00a0Path\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0de\u00a0ce\u00a0fichier\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0root_dir\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes\"\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\u00a0locales\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../../entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../../interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../../services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/02/entities\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fixe\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a02\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0chemins\u00a0absolus\u00a0des\u00a0fichiers\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"taxpayersFilename\":\u00a0f\"{script_dir}/../../data/input/taxpayersdata.txt\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"resultsFilename\":\u00a0f\"{script_dir}/../../data/output/r\u00e9sultats.json\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"admindataFilename\":\u00a0f\"{script_dir}/../../data/input/admindata.json\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"errorsFilename\":\u00a0f\"{script_dir}/../../data/output/errors.txt\"\n\u00a0\u00a0\u00a0\u00a0}\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0from\u00a0Imp\u00f4tsDaoWithAdminDataInJsonFile\u00a0import\u00a0Imp\u00f4tsDaoWithAdminDataInJsonFile\n\u00a0\u00a0\u00a0\u00a0from\u00a0Imp\u00f4tsM\u00e9tier\u00a0import\u00a0Imp\u00f4tsM\u00e9tier\n\n\u00a0\u00a0\u00a0\u00a0dao\u00a0=\u00a0Imp\u00f4tsDaoWithAdminDataInJsonFile(config)\n\u00a0\u00a0\u00a0\u00a0m\u00e9tier\u00a0=\u00a0Imp\u00f4tsM\u00e9tier()\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0met\u00a0les\u00a0instances\u00a0de\u00a0couches\u00a0dans\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0config[\"dao\"]\u00a0=\u00a0dao\n\u00a0\u00a0\u00a0\u00a0config[\"m\u00e9tier\"]\u00a0=\u00a0m\u00e9tier\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <p>Il est analogue \u00e0 celui utilis\u00e9 pour le test des couches [m\u00e9tier] et [dao].</p> <p>Le script principal [main.py] est le suivant\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# imports\nfrom Imp\u00f4tsError import Imp\u00f4tsError\n\n# on r\u00e9cup\u00e8re les couches de l'application (elles sont d\u00e9j\u00e0 instanci\u00e9es)\ndao = config[\"dao\"]\nm\u00e9tier = config[\"m\u00e9tier\"]\n\ntry:\n    # r\u00e9cup\u00e9ration des tranches de l'imp\u00f4t\n    admindata = dao.get_admindata()\n    # lecture des donn\u00e9es des contribuables\n    taxpayers = dao.get_taxpayers_data()[\"taxpayers\"]\n    # des contribuables ?\n    if not taxpayers:\n        raise Imp\u00f4tsError(51, f\"Pas de contribuables valides dans le fichier {config['taxpayersFilename']}\")\n    # calcul de l'imp\u00f4t des contribuables\n    for taxpayer in taxpayers:\n        # taxpayer est \u00e0 la fois un param\u00e8tre d'entr\u00e9e et de sortie\n        # taxpayer va \u00eatre modifi\u00e9\n        m\u00e9tier.calculate_tax(taxpayer, admindata)\n    # \u00e9criture des r\u00e9sultats dans un fichier texte\n    dao.write_taxpayers_results(taxpayers)\nexcept Imp\u00f4tsError as erreur:\n    # affichage de l'erreur\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\nfinally:\n    # termin\u00e9\n    print(\"Travail termin\u00e9...\")\n</code></pre> <p>Notes</p> <ul> <li>lignes 2-4\u00a0: on r\u00e9cup\u00e8re la configuration de l\u2019application. On sait \u00e9galement que le Python Path de l\u2019application a \u00e9t\u00e9 construit\u00a0;</li> <li>lignes 9-11\u00a0: on r\u00e9cup\u00e8re des r\u00e9f\u00e9rences sur les couches [m\u00e9tier] et [dao]\u00a0;</li> <li>ligne 15\u00a0: on obtient les donn\u00e9es de l'administration fiscale\u00a0;</li> <li>ligne 17\u00a0: on obtient la liste des contribuables dont il faut calculer l'imp\u00f4t\u00a0;</li> <li>lignes 19-20\u00a0: si cette liste est vide, on l\u00e8ve une exception\u00a0;</li> <li>lignes 22-25\u00a0: calcul de l'imp\u00f4t des diff\u00e9rents objets [taxpayer] gr\u00e2ce \u00e0 la couche [m\u00e9tier]\u00a0;</li> <li>ligne 27\u00a0: [taxpayers] est d\u00e9sormais une liste d'objets [TaxPayer] o\u00f9 les attributs (imp\u00f4t, d\u00e9c\u00f4te, surc\u00f4te, r\u00e9duction, taux) ont re\u00e7u une valeur. Cette liste est \u00e9crite dans un fichier jSON\u00a0;</li> <li>lignes 28-30\u00a0: interception d'une \u00e9ventuelle erreur\u00a0;</li> <li>lignes 31-33\u00a0: ex\u00e9cut\u00e9es dans tous les cas\u00a0; L\u2019ex\u00e9cution du script donne les m\u00eames r\u00e9sultats que dans les versions pr\u00e9c\u00e9dentes. Le fichier des erreurs de contribuables \u00e9tait une nouveaut\u00e9 dans cette version. Apr\u00e8s ex\u00e9cution du script [main] son contenu est le suivant\u00a0:</li> </ul> <pre><code>Analyse du fichier C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\impots\\v04\\main\\01/../../data/input/taxpayersdata.txt\n\nLigne 17, not enough values to unpack (expected 4, got 2)\nLigne 19, too many values to unpack (expected 4)\nLigne 21, MyException[1, L'identifiant d'une entit\u00e9 &lt;class 'TaxPayer.TaxPayer'&gt; doit \u00eatre un entier &gt;=0]\n</code></pre> <p>Les lignes erron\u00e9es \u00e9taient les suivantes\u00a0:</p> <pre><code># donn\u00e9es valides : id, mari\u00e9, enfants, salaire\n1,oui,2,55555\n2,oui,2,50000\n3,oui,3,50000\n4,non,2,100000\n5,non,3,100000\n6,oui,3,100000\n7,oui,5,100000\n8,non,0,100000\n9,oui,2,30000\n10,non,0,200000\n11,oui,3,200000\n# on peut avoir des lignes vides\n\n# on cr\u00e9e des lignes erron\u00e9es\n# pas assez de valeurs\n11,12\n# trop de valeurs\n12,oui,3,200000, x, y\n# des valeurs erron\u00e9es\nx,x,x,x\n</code></pre>"},{"location":"exercice-dx27application---version-4.html#152-version-4-application-2","title":"15.2. Version 4 \u2013 application 2","text":"<p>Dans cette version, c'est l'utilisateur au clavier qui donne la liste des contribuables. L'architecture de l'application sera la suivante\u00a0:</p> <p></p> <p>Un nouveau module appara\u00eet\u00a0: la couche [ui] (User Interface) qui va dialoguer avec l'utilisateur. Cette couche aura une interface et sera impl\u00e9ment\u00e9e par une classe.</p> <p></p>"},{"location":"exercice-dx27application---version-4.html#1521-linterface-interfaceimpotsui","title":"15.2.1. L'interface [InterfaceImp\u00f4tsUi]","text":"<pre><code># imports\nfrom abc import ABC, abstractmethod\n\n\n# interface InterfaceImp\u00f4tsUI\nclass InterfaceImp\u00f4tsUi(ABC):\n    # ex\u00e9cution de la classe impl\u00e9mentant l'interface\n    @abstractmethod\n    def run(self):\n        pass\n</code></pre> <p>L'interface [InterfaceImp\u00f4tsUi] n'aura qu'une m\u00e9thode, celle des lignes 8-10. L'interface sera ici impl\u00e9ment\u00e9e avec une application console mais on pourrait aussi l'impl\u00e9menter avec une interface graphique. Les param\u00e8tres pass\u00e9s \u00e0 la m\u00e9thode [run] ne seraient pas les m\u00eames dans les deux impl\u00e9mentations. Pour contourner ce probl\u00e8me, la m\u00e9thode habituelle est de\u00a0:</p> <ul> <li>ne pas mettre de param\u00e8tres \u00e0 la m\u00e9thode [run] (ou le minimum de param\u00e8tres)\u00a0;</li> <li>passer des param\u00e8tres au constructeur de la classe impl\u00e9mentant l'interface. Ils peuvent \u00eatre diff\u00e9rents d'une impl\u00e9mentation \u00e0 l'autre. Ces param\u00e8tres sont enregistr\u00e9s comme attributs de la classe\u00a0;</li> <li>faire en sorte que la m\u00e9thode [run] utilise ces attributs de classe (self.x)\u00a0; Cette m\u00e9thode permet d'avoir une interface tr\u00e8s g\u00e9n\u00e9rale qui est pr\u00e9cis\u00e9e par les param\u00e8tres des constructeurs de chaque classe d'impl\u00e9mentation. Cette m\u00e9thode a d\u00e9j\u00e0 \u00e9t\u00e9 utilis\u00e9e pour la version modulaire n\u00b0 1.</li> </ul>"},{"location":"exercice-dx27application---version-4.html#1522-la-classe-impotsconsole","title":"15.2.2. La classe [Imp\u00f4tsConsole]","text":"<p>La classe [Imp\u00f4tsConsole] impl\u00e9mente l'interface [InterfaceImp\u00f4tsUi] de la fa\u00e7on suivante\u00a0:</p> <pre><code># imports\nimport re\n\nfrom InterfaceImp\u00f4tsUi import InterfaceImp\u00f4tsUi\nfrom TaxPayer import TaxPayer\n\n\n# couche [UI]\nclass Imp\u00f4tsConsole(InterfaceImp\u00f4tsUi):\n    # constructeur\n    def __init__(self, config: dict):\n        # on m\u00e9morise les param\u00e8tres\n        self.admindata = config['dao'].get_admindata()\n        self.m\u00e9tier = config['m\u00e9tier']\n\n    def run(self):\n        # dialogue interactif avec l'utilisateur\n        fini = False\n        while not fini:\n            # le contribuable est-il mari\u00e9 ?\n            mari\u00e9 = input(\"Le contribuable est-il mari\u00e9 / pacs\u00e9 (oui/non) (* pour arr\u00eater) : \").strip().lower()\n            # v\u00e9rification de la validit\u00e9 de la saisie\n            while mari\u00e9 != \"oui\" and mari\u00e9 != \"non\" and mari\u00e9 != \"*\":\n                # msg d'erreur\n                print(\"Tapez oui ou non ou *\")\n                # question de nouveau\n                mari\u00e9 = input(\"Le contribuable est-il mari\u00e9 / pacs\u00e9 (oui/non) (* pour arr\u00eater) : \").strip().lower()\n            # fini ?\n            if mari\u00e9 == \"*\":\n                # dialogue termin\u00e9\n                return\n            # nombre d'enfants\n            enfants = input(\"Nombre d'enfants : \").strip()\n            # v\u00e9rification de la validit\u00e9 de la saisie\n            if not re.match(r\"^\\d+$\", enfants):\n                # msg d'erreur\n                print(\"Tapez un nombre entier positif ou nul\")\n                # on recommence\n                enfants = input(\"Nombre d'enfants : \").strip()\n            # salaire annuel\n            salaire = input(\"Salaire annuel : \").strip()\n            # v\u00e9rification de la validit\u00e9 de la saisie\n            if not re.match(r\"^\\d+$\", salaire):\n                # msg d'erreur\n                print(\"Tapez un nombre entier positif ou nul\")\n                # on recommence\n                salaire = input(\"Salaire annuel : \").strip()\n            # calcul de l'imp\u00f4t\n            taxpayer = TaxPayer().fromdict({'id': 0, 'mari\u00e9': mari\u00e9, 'enfants': int(enfants), 'salaire': int(salaire)})\n            self.m\u00e9tier.calculate_tax(taxpayer, self.admindata)\n            # affichage\n            print(f\"Imp\u00f4t du contribuable = {taxpayer}\\n\\n\")\n            # contribuable suivant\n</code></pre> <ul> <li>ligne 9\u00a0: la classe [Imp\u00f4tsConsole] impl\u00e9mente l'interface [InterfaceImp\u00f4tsUi]\u00a0;</li> <li>ligne 11\u00a0: le constructeur de la classe re\u00e7oit un param\u00e8tre, le dictionnaire [config] \u00a0de la configuration de l\u2019application\u00a0;</li> <li>ligne 13\u00a0: on r\u00e9cup\u00e8re les donn\u00e9es de l\u2019administration fiscale permettant le calcul de l\u2019imp\u00f4t\u00a0;</li> <li>ligne 14\u00a0: on m\u00e9morise une r\u00e9f\u00e9rence sur la couche [m\u00e9tier]\u00a0;</li> <li>ligne 16\u00a0: impl\u00e9mentation de la m\u00e9thode [run] de l'interface\u00a0;</li> <li>lignes 19-53\u00a0: dialogue avec l'utilisateur. Il consiste</li> <li>\u00e0 demander les trois informations (mari\u00e9, enfants, salaire) du contribuable\u00a0;</li> <li>\u00e0 calculer son imp\u00f4t\u00a0;</li> <li>\u00e0 afficher celui-ci\u00a0;</li> <li>le dialogue se termine lorsque l'utilisateur r\u00e9pond * \u00e0 la premi\u00e8re question\u00a0;</li> <li>lignes 20-27\u00a0: on demande si le contribuable est mari\u00e9 et on v\u00e9rifie la validit\u00e9 de la r\u00e9ponse\u00a0;</li> <li>lignes 29-31\u00a0: si l\u2019utilisateur a r\u00e9pondu \u2018*\u2019 \u00e0 la question le dialogue est arr\u00eat\u00e9\u00a0;</li> <li>lignes 32-39\u00a0: on demande le nombre d'enfants du contribuable et on v\u00e9rifie la validit\u00e9 de la r\u00e9ponse\u00a0;</li> <li>lignes 40-47\u00a0: on demande le salaire annuel du contribuable et on v\u00e9rifie la validit\u00e9 de la r\u00e9ponse\u00a0;</li> <li>lignes 48-50\u00a0: avec ces informations on fait calculer, par la couche [m\u00e9tier], l'imp\u00f4t du contribuable\u00a0;</li> <li>ligne 52\u00a0: le montant de l'imp\u00f4t est affich\u00e9\u00a0;</li> </ul>"},{"location":"exercice-dx27application---version-4.html#1523-le-script-principal","title":"15.2.3. Le script principal","text":"<p>Le script principal [main] est configur\u00e9 par le fichier [config] suivant\u00a0:</p> <pre><code>def\u00a0configure():\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a01\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0du\u00a0python\u00a0Path\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0de\u00a0ce\u00a0fichier\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0root_dir\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes\"\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0d\u00e9pendances\u00a0locales\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../../entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../../interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../../services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/02/entities\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fixe\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a02\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0chemins\u00a0absolus\u00a0des\u00a0fichiers\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"admindataFilename\":\u00a0f\"{script_dir}/../../data/input/admindata.json\",\n\u00a0\u00a0\u00a0\u00a0}\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0from\u00a0Imp\u00f4tsDaoWithAdminDataInJsonFile\u00a0import\u00a0Imp\u00f4tsDaoWithAdminDataInJsonFile\n\u00a0\u00a0\u00a0\u00a0from\u00a0Imp\u00f4tsM\u00e9tier\u00a0import\u00a0Imp\u00f4tsM\u00e9tier\n\u00a0\u00a0\u00a0\u00a0from\u00a0Imp\u00f4tsConsole\u00a0import\u00a0Imp\u00f4tsConsole\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0couche\u00a0dao\n\u00a0\u00a0\u00a0\u00a0dao\u00a0=\u00a0Imp\u00f4tsDaoWithAdminDataInJsonFile(config)\n\u00a0\u00a0\u00a0\u00a0#\u00a0couche\u00a0m\u00e9tier\n\u00a0\u00a0\u00a0\u00a0m\u00e9tier\u00a0=\u00a0Imp\u00f4tsM\u00e9tier()\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0met\u00a0les\u00a0instances\u00a0de\u00a0couches\u00a0dans\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0config[\"dao\"]\u00a0=\u00a0dao\n\u00a0\u00a0\u00a0\u00a0config[\"m\u00e9tier\"]\u00a0=\u00a0m\u00e9tier\n\u00a0\u00a0\u00a0\u00a0#\u00a0couche\u00a0ui\n\u00a0\u00a0\u00a0\u00a0ui\u00a0=\u00a0Imp\u00f4tsConsole(config)\n\u00a0\u00a0\u00a0\u00a0config[\"ui\"]\u00a0=\u00a0ui\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <p>Le script chef d'orchestre est le suivant (main.py)\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# imports\nfrom Imp\u00f4tsError import Imp\u00f4tsError\n\n# on r\u00e9cup\u00e8re les couches de l'application (elles sont d\u00e9j\u00e0 instanci\u00e9es)\nui = config[\"ui\"]\n\n# code\ntry:\n    # ex\u00e9cution de la couche [ui]\n    ui.run()\nexcept Imp\u00f4tsError as erreur:\n    # on affiche le message d'erreur\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\nfinally:\n    # ex\u00e9cut\u00e9 dans tous les cas\n    print(\"Travail termin\u00e9...\")\n</code></pre> <ul> <li>lignes 1-4\u00a0: on r\u00e9cup\u00e8re la configuration de l\u2019application\u00a0;</li> <li>ligne 10\u00a0: on r\u00e9cup\u00e8re une r\u00e9f\u00e9rence sur la couche [ui]\u00a0;</li> <li>lignes 12-21\u00a0: la structure du code est la m\u00eame que dans l\u2019application pr\u00e9c\u00e9dente\u00a0: du code entour\u00e9 d'un try / catch pour arr\u00eater toute \u00e9ventuelle exception\u00a0;</li> <li>ligne 15\u00a0: on demande \u00e0 la couche [ui] de s'ex\u00e9cuter\u00a0: le dialogue avec l'utilisateur commence alors\u00a0;</li> <li>lignes 16-18\u00a0: interception d'une \u00e9ventuelle exception\u00a0; Voici un exemple d'ex\u00e9cution\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots/v04/main/02/main.py\nLe contribuable est-il mari\u00e9 / pacs\u00e9 (oui/non) (* pour arr\u00eater) : oui\nNombre d'enfants : 3\nSalaire annuel : 200000\nImp\u00f4t du contribuable = {\"id\": 0, \"mari\u00e9\": \"oui\", \"enfants\": 3, \"salaire\": 200000, \"imp\u00f4t\": 42842, \"surc\u00f4te\": 17283, \"taux\": 0.41, \"d\u00e9c\u00f4te\": 0, \"r\u00e9duction\": 0}\n\n\nLe contribuable est-il mari\u00e9 / pacs\u00e9 (oui/non) (* pour arr\u00eater) : *\nTravail termin\u00e9...\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"exercice-dx27application-version-5.html","title":"20. Exercice d'application\u00a0: version 5","text":"<p>Nous allons d\u00e9velopper trois applications\u00a0:</p> <ul> <li>l\u2019application 1 initialisera la base de donn\u00e9es qui va venir remplacer le fichier [admindata.json] de la version 4\u00a0;</li> <li>l\u2019application 2 fera le calcul des imp\u00f4ts en mode batch\u00a0;</li> <li>l\u2019application 3 fera le calcul des imp\u00f4ts en mode interactif\u00a0;</li> </ul>"},{"location":"exercice-dx27application-version-5.html#201-application-1-initialisation-de-la-base-de-donnees","title":"20.1. Application 1\u00a0: initialisation de la base de donn\u00e9es","text":"<p>L\u2019application 1 aura l'architecture suivante\u00a0:</p> <p></p> <p>C'est une \u00e9volution de l'architecture de la version 4 (paragraphe |Version 4|)\u00a0: les donn\u00e9es fiscales seront trouv\u00e9es dans une base de donn\u00e9es au lieu d'\u00eatre dans un fichier jSON. La couche [dao] va \u00e9voluer pour impl\u00e9menter ce changement.</p>"},{"location":"exercice-dx27application-version-5.html#2011-le-fichier-admindatajson","title":"20.1.1. Le fichier [admindata.json]","text":"<p>Le fichier [admindata.json] est celui qu\u2019il \u00e9tait dans la version 4\u00a0:</p> <pre><code>{\n    \"limites\": [9964, 27519, 73779, 156244, 0],\n    \"coeffr\": [0, 0.14, 0.3, 0.41, 0.45],\n    \"coeffn\": [0, 1394.96, 5798, 13913.69, 20163.45],\n    \"plafond_qf_demi_part\": 1551,\n    \"plafond_revenus_celibataire_pour_reduction\": 21037,\n    \"plafond_revenus_couple_pour_reduction\": 42074,\n    \"valeur_reduc_demi_part\": 3797,\n    \"plafond_decote_celibataire\": 1196,\n    \"plafond_decote_couple\": 1970,\n    \"plafond_impot_couple_pour_decote\": 2627,\n    \"plafond_impot_celibataire_pour_decote\": 1595,\n    \"abattement_dixpourcent_max\": 12502,\n    \"abattement_dixpourcent_min\": 437\n}\n</code></pre> <p>Nous allons utiliser comme colonnes de la base de donn\u00e9es les cl\u00e9s de ce dictionnaire.</p>"},{"location":"exercice-dx27application-version-5.html#2012-creation-des-bases-de-donnees","title":"20.1.2. Cr\u00e9ation des bases de donn\u00e9es","text":"<p>Comme il a \u00e9t\u00e9 montr\u00e9 au paragraphe |cr\u00e9ation d\u2019une base de donn\u00e9es MySQL|, nous cr\u00e9ons une base de donn\u00e9es MySQL nomm\u00e9e [dbimpots-2019] propri\u00e9t\u00e9 de l\u2019utilisateur [admimpots] de mot de passe [mdpimpots]. Dans [phpMyAdmin] cela donne la chose suivante\u00a0:</p> <p></p> <p>De m\u00eame, comme il a \u00e9t\u00e9 montr\u00e9 au paragraphe |cr\u00e9ation d\u2019une base de donn\u00e9es PostgreSQL|, nous cr\u00e9ons une base de donn\u00e9es PostgreSQL nomm\u00e9e [dbimpots-2019] propri\u00e9t\u00e9 de l\u2019utilisateur [admimpots] de mot de passe [mdpimpots]. Dans [pgAdmin] cela donne la chose suivante\u00a0:</p> <p></p> <p>Les bases sont cr\u00e9\u00e9es mais pour l\u2019instant elles n\u2019ont aucune table. Celles-ci vont \u00eatre construites par l\u2019ORM [sqlalchemy].</p>"},{"location":"exercice-dx27application-version-5.html#2013-les-entitees-mappees-par-sqlalchemy","title":"20.1.3. Les entit\u00e9es mapp\u00e9es par [sqlalchemy]","text":"<p>Nous allons cr\u00e9er deux tables pour encapsuler les donn\u00e9es de [admindata.json]\u00a0:</p> <p>D\u00e9finie par [sqlalchemy] la table [tbtranches] rassemblera les donn\u00e9es des tableaux [limites, coeffr, coeffn] du dictionnaire [admindata.json]\u00a0:</p> <pre><code>    # la table des tranches de l'imp\u00f4t\n    tranches_table = Table(\"tbtranches\", metadata,\n                           Column('id', Integer, primary_key=True),\n                           Column('limite', Float, nullable=False),\n                           Column('coeffr', Float, nullable=False),\n                           Column('coeffn', Float, nullable=False)\n                           )\n</code></pre> <p>D\u00e9finie par [sqlalchemy] la table [tbconstantes] rassemblera les constantes du dictionnaire [admindata.json]\u00a0:</p> <pre><code>    # la table des constantes\n    constantes_table = Table(\"tbconstantes\", metadata,\n                             Column('id', Integer, primary_key=True),\n                             Column('plafond_qf_demi_part', Float, nullable=False),\n                             Column('plafond_revenus_celibataire_pour_reduction', Float, nullable=False),\n                             Column('plafond_revenus_couple_pour_reduction', Float, nullable=False),\n                             Column('valeur_reduc_demi_part', Float, nullable=False),\n                             Column('plafond_decote_celibataire', Float, nullable=False),\n                             Column('plafond_decote_couple', Float, nullable=False),\n                             Column('plafond_impot_celibataire_pour_decote', Float, nullable=False),\n                             Column('plafond_impot_couple_pour_decote', Float, nullable=False),\n                             Column('abattement_dixpourcent_max', Float, nullable=False),\n                             Column('abattement_dixpourcent_min', Float, nullable=False)\n                             )\n</code></pre> <p>Les entit\u00e9s qui seront mapp\u00e9es avec ces deux tables seront les suivantes\u00a0:</p> <p></p> <p>L\u2019entit\u00e9 [Constantes] encapsule les constantes du dictionnaire [admindata.json]\u00a0:</p> <pre><code>from BaseEntity import BaseEntity\n\n\n# classe conteneur des donn\u00e9es de l'administration fiscale\nclass Constantes(BaseEntity):\n    # cl\u00e9s exclues de l'\u00e9tat de la classe\n    excluded_keys = [\"_sa_instance_state\"]\n\n    # cl\u00e9s autoris\u00e9es\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        return [\"id\",\n                \"plafond_qf_demi_part\",\n                \"plafond_revenus_celibataire_pour_reduction\",\n                \"plafond_revenus_couple_pour_reduction\",\n                \"valeur_reduc_demi_part\",\n                \"plafond_decote_celibataire\",\n                \"plafond_decote_couple\",\n                \"plafond_decote_couple\",\n                \"plafond_impot_celibataire_pour_decote\",\n                \"plafond_impot_couple_pour_decote\",\n                \"abattement_dixpourcent_max\",\n                \"abattement_dixpourcent_min\"]\n</code></pre> <ul> <li>ligne 5\u00a0: la classe [Constantes] \u00e9tend la classe [BaseEntity]\u00a0;</li> <li>ligne 7\u00a0: par mapping [sqlalchemy], la classe [Constante] va recevoir la propri\u00e9t\u00e9 [_sa_instance_state]. Nous l\u2019excluons du dictionnaire [asdict] de l\u2019entit\u00e9\u00a0;</li> <li>lignes 11-23\u00a0: les propri\u00e9t\u00e9s de l\u2019entit\u00e9. On a repris les noms utilis\u00e9s dans le dictionnaire [admindata.json] pour faciliter l\u2019\u00e9criture du code\u00a0; L\u2019entit\u00e9 [Tranche] encapsule une ligne des trois tableaux [limites, coeffr, coeffn] du dictionnaire [admindata.json]\u00a0:</li> </ul> <pre><code>from BaseEntity import BaseEntity\n\n\n# classe conteneur des donn\u00e9es de l'administration fiscale\nclass Tranche(BaseEntity):\n    # cl\u00e9s exclues de l'\u00e9tat de la classe\n    excluded_keys = [\"_sa_instance_state\"]\n\n    # cl\u00e9s autoris\u00e9es\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        return [\"id\", \"limite\", \"coeffr\", \"coeffn\"]\n</code></pre> <ul> <li>ligne 5\u00a0: la classe [Tranche] \u00e9tend la classe [BaseEntity]\u00a0;</li> <li>ligne 7\u00a0: on exclut des propri\u00e9t\u00e9s du dictionnaire [asdict] de l\u2019entit\u00e9, la propri\u00e9t\u00e9 [_sa_instance_state] ajout\u00e9e par [sqlalchemy]\u00a0;</li> <li>lignes 10-12\u00a0: les propri\u00e9t\u00e9s de la classe\u00a0; Le mapping entre les entit\u00e9s [Constantes, Tranche] et les tables [constantes, tranches] sera le suivant\u00a0:</li> </ul> <p></p> <pre><code>\u2026\n    # la table des constantes\n    constantes_table = Table(\"tbconstantes\", metadata,\n                             Column('id', Integer, primary_key=True),\n                             Column('plafond_qf_demi_part', Float, nullable=False),\n                             Column('plafond_revenus_celibataire_pour_reduction', Float, nullable=False),\n                             Column('plafond_revenus_couple_pour_reduction', Float, nullable=False),\n                             Column('valeur_reduc_demi_part', Float, nullable=False),\n                             Column('plafond_decote_celibataire', Float, nullable=False),\n                             Column('plafond_decote_couple', Float, nullable=False),\n                             Column('plafond_impot_celibataire_pour_decote', Float, nullable=False),\n                             Column('plafond_impot_couple_pour_decote', Float, nullable=False),\n                             Column('abattement_dixpourcent_max', Float, nullable=False),\n                             Column('abattement_dixpourcent_min', Float, nullable=False)\n                             )\n\n    # la table des tranches de l'imp\u00f4t\n    tranches_table = Table(\"tbtranches\", metadata,\n                           Column('id', Integer, primary_key=True),\n                           Column('limite', Float, nullable=False),\n                           Column('coeffr', Float, nullable=False),\n                           Column('coeffn', Float, nullable=False)\n                           )\n    # les mappings\n    from Tranche import Tranche\n    mapper(Tranche, tranches_table)\n\n    from Constantes import Constantes\n    mapper(Constantes, constantes_table)\n</code></pre> <ul> <li>les mappings sont faits aux lignes 24-29. On y a omis de faire les correspondances entre propri\u00e9t\u00e9s des entit\u00e9s mapp\u00e9es et tables de la base de donn\u00e9es. C\u2019est possible lorsque les noms des colonnes des tables sont les m\u00eames que ceux des propri\u00e9t\u00e9s auxquelles elles doivent \u00eatre associ\u00e9es. Pour cette raison, nous avons repris dans les tables les noms des propri\u00e9t\u00e9s des entit\u00e9s mapp\u00e9es. Cela facilite l\u2019\u00e9criture du code et sa compr\u00e9hension\u00a0;</li> </ul>"},{"location":"exercice-dx27application-version-5.html#2014-le-fichier-de-configuration-de-sqlalchemy","title":"20.1.4. Le fichier de configuration de [sqlalchemy]","text":"<p>Nous venons de d\u00e9tailler une partie de la configuration de [sqlalchemy]. Le fichier [config_database] dans sa totalit\u00e9 est le suivant\u00a0:</p> <pre><code>def configure(config: dict) -&gt; dict:\n    # configuration sqlalchemy\n    from sqlalchemy import create_engine, Table, Column, Integer, MetaData, Float\n    from sqlalchemy.orm import mapper, sessionmaker\n\n    # cha\u00eenes de connexion aux bases de donn\u00e9es exploit\u00e9es\n    connection_strings = {\n        'mysql': \"mysql+mysqlconnector://admimpots:mdpimpots@localhost/dbimpots-2019\",\n        'pgres': \"postgresql+psycopg2://admimpots:mdpimpots@localhost/dbimpots-2019\"\n    }\n    # cha\u00eene de connexion \u00e0 la base de donn\u00e9es exploit\u00e9e\n    engine = create_engine(connection_strings[config['sgbd']])\n\n    # metadata\n    metadata = MetaData()\n\n    # la table des constantes\n    constantes_table = Table(\"tbconstantes\", metadata,\n                             Column('id', Integer, primary_key=True),\n                             Column('plafond_qf_demi_part', Float, nullable=False),\n                             Column('plafond_revenus_celibataire_pour_reduction', Float, nullable=False),\n                             Column('plafond_revenus_couple_pour_reduction', Float, nullable=False),\n                             Column('valeur_reduc_demi_part', Float, nullable=False),\n                             Column('plafond_decote_celibataire', Float, nullable=False),\n                             Column('plafond_decote_couple', Float, nullable=False),\n                             Column('plafond_impot_celibataire_pour_decote', Float, nullable=False),\n                             Column('plafond_impot_couple_pour_decote', Float, nullable=False),\n                             Column('abattement_dixpourcent_max', Float, nullable=False),\n                             Column('abattement_dixpourcent_min', Float, nullable=False)\n                             )\n\n    # la table des tranches de l'imp\u00f4t\n    tranches_table = Table(\"tbtranches\", metadata,\n                           Column('id', Integer, primary_key=True),\n                           Column('limite', Float, nullable=False),\n                           Column('coeffr', Float, nullable=False),\n                           Column('coeffn', Float, nullable=False)\n                           )\n    # les mappings\n    from Tranche import Tranche\n    mapper(Tranche, tranches_table)\n\n    from Constantes import Constantes\n    mapper(Constantes, constantes_table)\n\n    # la session factory\n    session_factory = sessionmaker()\n    session_factory.configure(bind=engine)\n\n    # une session\n    session = session_factory()\n\n    # on enregistre certaines informations\n    config['database'] = {\"engine\": engine, \"metadata\": metadata, \"tranches_table\": tranches_table,\n                          \"constantes_table\": constantes_table, \"session\": session}\n\n    # r\u00e9sultat\n    return config\n</code></pre> <ul> <li>ligne 1\u00a0: la fonction [configure] re\u00e7oit en param\u00e8tre un dictionnaire dont la cl\u00e9 [sgbd] lui dit quel SGBD utiliser\u00a0: MySQL (mysql) ou PostgreSQL (pgres)\u00a0;</li> <li>lignes 6-12\u00a0: on s\u00e9lectionne la base de donn\u00e9es demand\u00e9e par la configuration\u00a0;</li> <li>lignes 14-44\u00a0: mappings entit\u00e9s / tables.  Ces mappings sont simples car il n\u2019existe aucun lien entre les tables [tranches] et [constantes]. Elles sont ind\u00e9pendantes. Il n\u2019y a donc pas de cl\u00e9 \u00e9trang\u00e8re de l\u2019une sur l\u2019autre \u00e0 g\u00e9rer\u00a0;</li> <li>lignes 46-51\u00a0: on cr\u00e9e la session [session] de travail de l\u2019application\u00a0;</li> <li>lignes 53-58\u00a0: les informations utiles sont mises dans le dictionnaire de la configuration et celui-ci est retourn\u00e9\u00a0;</li> </ul>"},{"location":"exercice-dx27application-version-5.html#2015-la-couche-dao","title":"20.1.5. La couche [dao]","text":"<p>Revenons \u00e0 l\u2019architecture de l\u2019application 1 \u00e0 construire\u00a0:</p> <p></p> <p>La couche [dao] [1] doit lire le fichier [admindata.json] [2] et transf\u00e9rer son contenu dans une des bases [3, 4]\u00a0;</p> <p></p> <p>La couche [dao] pr\u00e9sente l\u2019interface [1] et est impl\u00e9ment\u00e9e par la classe [2].</p> <p>L\u2019interface [InterfaceDao4TransferAdminData2Database] est la suivante\u00a0:</p> <pre><code># imports\nfrom abc import ABC, abstractmethod\n\n\n# interface InterfaceImp\u00f4tsUI\nclass InterfaceDao4TransferAdminData2Database(ABC):\n    # transfert des donn\u00e9es fiscales dans une base de donn\u00e9es\n    @abstractmethod\n    def transfer_admindata_in_database(self:object):\n        pass\n</code></pre> <ul> <li>lignes 8-10\u00a0: l\u2019interface ne pr\u00e9sente qu\u2019une m\u00e9thode [transfer_admindata_in_database] sans param\u00e8tres. Comme cette m\u00e9thode a besoin de param\u00e8tres (quel fichier\u00a0?, quelle base de donn\u00e9es\u00a0?), cela signifie que ceux-ci seront pass\u00e9s au constructeur des classes impl\u00e9mentant cette interface\u00a0; La classe [DaoTransferAdminDataFromJsonFile2Database] impl\u00e9mente l\u2019interface [InterfaceDao4TransferAdminData2Database] de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code># imports\nimport codecs\nimport json\n\nfrom sqlalchemy.exc import DatabaseError, IntegrityError, InterfaceError\n\nfrom Constantes import Constantes\nfrom Imp\u00f4tsError import Imp\u00f4tsError\nfrom InterfaceDao4TransferAdminData2Database import InterfaceDao4TransferAdminData2Database\nfrom Tranche import Tranche\n\n\nclass DaoTransferAdminDataFromJsonFile2Database(InterfaceDao4TransferAdminData2Database):\n\n    # constructeur\n    def __init__(self, config: dict):\n        self.config = config\n\n    # transfert\n    def transfer_admindata_in_database(self) -&gt; None:\n        # initialisations\n        session = None\n        config = self.config\n\n        try:\n            # on r\u00e9cup\u00e8re les donn\u00e9es de l'administration fiscale\n            with codecs.open(config[\"admindataFilename\"], \"r\", \"utf8\") as fd:\n                # transfert du contenu dans un dictionnaire\n                admindata = json.load(fd)\n\n            # on r\u00e9cup\u00e8re la configuration de la base de donn\u00e9es\n            database = config[\"database\"]\n\n            # suppression des deux tables de la base de donn\u00e9es\n            # checkfirst=True : v\u00e9rifie d'abord que la table existe\n            database[\"tranches_table\"].drop(database[\"engine\"], checkfirst=True)\n            database[\"constantes_table\"].drop(database[\"engine\"], checkfirst=True)\n\n            # recr\u00e9ation des tables \u00e0 partir des mappings\n            database[\"metadata\"].create_all(database[\"engine\"])\n\n            # la session [sqlalchemy] courante\n            session = database[\"session\"]\n\n            # on remplit la table des tranches de l'imp\u00f4t\n            limites = admindata[\"limites\"]\n            coeffr = admindata[\"coeffr\"]\n            coeffn = admindata[\"coeffn\"]\n            for i in range(len(limites)):\n                session.add(Tranche().fromdict(\n                    {\"limite\": limites[i], \"coeffr\": coeffr[i], \"coeffn\": coeffn[i]}))\n            # on remplit la table des constantes\n            session.add(Constantes().fromdict({\n                'plafond_qf_demi_part': admindata[\"plafond_qf_demi_part\"],\n                'plafond_revenus_celibataire_pour_reduction': admindata[\"plafond_revenus_celibataire_pour_reduction\"],\n                'plafond_revenus_couple_pour_reduction': admindata[\"plafond_revenus_couple_pour_reduction\"],\n                'valeur_reduc_demi_part': admindata[\"valeur_reduc_demi_part\"],\n                'plafond_decote_celibataire': admindata[\"plafond_decote_celibataire\"],\n                'plafond_decote_couple': admindata[\"plafond_decote_couple\"],\n                'plafond_impot_celibataire_pour_decote': admindata[\"plafond_impot_celibataire_pour_decote\"],\n                'plafond_impot_couple_pour_decote': admindata[\"plafond_impot_couple_pour_decote\"],\n                'abattement_dixpourcent_max': admindata[\"abattement_dixpourcent_max\"],\n                'abattement_dixpourcent_min': admindata[\"abattement_dixpourcent_min\"]\n            }))\n\n            # validation de la session [sqlalchemy]\n            session.commit()\n        except (IntegrityError, DatabaseError, InterfaceError) as erreur:\n            # on relance l'exception sous une autre forme\n            raise Imp\u00f4tsError(17, f\"{erreur}\")\n        finally:\n            # on lib\u00e8re les ressources de la session\n            if session:\n                session.close()\n</code></pre> <ul> <li>ligne 13\u00a0: la classe [DaoTransferAdminDataFromJsonFile2Database] impl\u00e9mente l\u2019interface [InterfaceDao4TransferAdminData2Database]\u00a0;</li> <li>lignes 15-17\u00a0: le constructeur de la classe re\u00e7oit en param\u00e8tre le dictionnaire de la configuration. Les cl\u00e9s suivantes vont \u00eatre utilis\u00e9es\u00a0:</li> <li>[admindataFilename]\u00a0(ligne 27)\u00a0: le nom du fichier jSON contenant les donn\u00e9es de l\u2019administration fiscale \u00e0 transf\u00e9rer en base\u00a0;</li> <li>[database] ligne 32\u00a0: le configuration [sqlalchemy] de l\u2019application\u00a0;</li> <li>lignes 34-37\u00a0: suppression des tables [constantes] et [tranches] si elles existent\u00a0;</li> <li>lignes 39-40\u00a0: recr\u00e9ation des deux tables\u00a0;</li> <li>ligne 43\u00a0: on r\u00e9cup\u00e8re la session [sqlalchemy] pr\u00e9sente dans la configuration\u00a0;</li> <li>lignes 45-51\u00a0: les tableaux [limites, coeffr, coeffn] du dictionnaire [admindata] sont mis dans la session. Pour cela on met dans la session des instances de l\u2019entit\u00e9 [Tranche]\u00a0;</li> <li>lignes 52-64\u00a0: une instance de l\u2019entit\u00e9 [Constantes] est mise en session\u00a0;</li> <li>lignes 66-67\u00a0: la session est valid\u00e9e. Si les donn\u00e9es de la session n\u2019\u00e9taient pas encore en base, elles y sont mises \u00e0 ce moment l\u00e0\u00a0;</li> <li>lignes 68-70\u00a0: gestion d\u2019une \u00e9ventuelle erreur\u00a0;</li> <li>lignes 71-74\u00a0: la session est ferm\u00e9e. On peut le faire car la couche [dao] n\u2019est utilis\u00e9e qu\u2019une fois\u00a0;</li> </ul>"},{"location":"exercice-dx27application-version-5.html#2016-configuration-de-lapplication","title":"20.1.6. Configuration de l\u2019application","text":"<p>L\u2019application est configur\u00e9e par trois fichiers [1]\u00a0:</p> <ul> <li>[config] est le fichier de configuration g\u00e9n\u00e9rale. C\u2019est lui qui configure l\u2019application [main]. Il se fait aider par les deux autres fichiers\u00a0:</li> <li>[config_database] que nous avons \u00e9tudi\u00e9 et qui configure l\u2019ORM [sqlalchemy]\u00a0;</li> <li>[config_layers] qui configure les couches de l\u2019application\u00a0; Le fichier [config] est le suivant\u00a0:</li> </ul> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0#\u00a0[config]\u00a0a\u00a0la\u00a0cl\u00e9\u00a0[sgbd]\u00a0qui\u00a0vaut:\n\u00a0\u00a0\u00a0\u00a0#\u00a0[mysql]\u00a0pour\u00a0g\u00e9rer\u00a0une\u00a0base\u00a0MySQL\n\u00a0\u00a0\u00a0\u00a0#\u00a0[pgres]\u00a0pour\u00a0g\u00e9rer\u00a0une\u00a0base\u00a0PostgreSQL\n\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a01\u00a0---\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0\u00e9tablit\u00a0le\u00a0Python\u00a0Path\u00a0de\u00a0l'application\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0absolu\u00a0du\u00a0dossier\u00a0de\u00a0ce\u00a0script\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0root_dir\u00a0(\u00e0\u00a0changer\u00a0\u00e9ventuellement)\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020\"\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemins\u00a0absolus\u00a0des\u00a0d\u00e9pendances\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0InterfaceImp\u00f4tsDao,\u00a0InterfaceImp\u00f4tsM\u00e9tier,\u00a0InterfaceImp\u00f4tsUi\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AbstractImp\u00f4tsDao,\u00a0Imp\u00f4tsConsole,\u00a0Imp\u00f4tsM\u00e9tier\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0AdminData,\u00a0Imp\u00f4tsError,\u00a0TaxPayer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/impots/v04/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0BaseEntity,\u00a0MyException\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/classes/02/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossiers\u00a0locaux\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../../interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../../services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../../entities\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fixe\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a02\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0compl\u00e8te\u00a0la\u00a0configuration\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0config.update({\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0chemins\u00a0absolus\u00a0des\u00a0fichiers\u00a0de\u00a0donn\u00e9es\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"admindataFilename\":\u00a0f\"{script_dir}/../../data/input/admindata.json\"\n\u00a0\u00a0\u00a0\u00a0})\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a03\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0base\u00a0de\u00a0donn\u00e9es\n\u00a0\u00a0\u00a0\u00a0import\u00a0config_database\n\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0config_database.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a04\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0import\u00a0config_layers\n\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0config_layers.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <ul> <li>lignes 8-36\u00a0: on construit le Python Path de l\u2019application\u00a0;</li> <li>lignes 38-43\u00a0: on met dans la configuration le chemin du fichier [admindata.json]\u00a0;</li> <li>lignes 45-48\u00a0: configuration [sqlalchemy]\u00a0;</li> <li>lignes 50-53\u00a0: instanciation des couches de l\u2019application\u00a0;</li> <li>ligne 56\u00a0: on rend la configuration g\u00e9n\u00e9rale\u00a0; Le fichier [config_layers] est le suivant\u00a0:</li> </ul> <pre><code>def configure(config: dict) -&gt; dict:\n    # instanciation couche [dao]\n    from DaoTransferAdminDataFromJsonFile2Database import DaoTransferAdminDataFromJsonFile2Database\n    config['dao'] = DaoTransferAdminDataFromJsonFile2Database(config)\n\n    # on rend la config\n    return config\n</code></pre> <ul> <li>lignes 3-4\u00a0: instanciation de la couche [dao]. On a vu que le constructeur de la classe [DaoTransferAdminDataFromJsonFile2Database] attendait en param\u00e8tre le dictionnaire de la configuration g\u00e9n\u00e9rale de l\u2019application\u00a0;</li> <li>ligne 4\u00a0: la r\u00e9f\u00e9rence sur la couche [dao] est mise dans la configiration\u00a0;</li> <li>ligne 7\u00a0: on rend la configuration\u00a0;</li> </ul>"},{"location":"exercice-dx27application-version-5.html#2017-le-script-main-de-lapplication","title":"20.1.7. Le script [main] de l\u2019application","text":"<p>Le script principal [main] est le suivant\u00a0:</p> <pre><code># on attend un param\u00e8tre mysql ou pgres\nimport sys\nsyntaxe = f\"{sys.argv[0]} mysql / pgres\"\nerreur = len(sys.argv) != 2\nif not erreur:\n    sgbd = sys.argv[1].lower()\n    erreur = sgbd != \"mysql\" and sgbd != \"pgres\"\nif erreur:\n    print(f\"syntaxe : {syntaxe}\")\n    sys.exit()\n\n# on configure l'application\nimport config\nconfig = config.configure({'sgbd': sgbd})\n\n# le syspath est \u00e9tabli - on peut faire les imports\nfrom Imp\u00f4tsError import Imp\u00f4tsError\n\n# on r\u00e9cup\u00e8re la couche [dao]\ndao = config[\"dao\"]\n\n# code\ntry:\n    # transfert des donn\u00e9es dans la base\n    dao.transfer_admindata_in_database()\nexcept Imp\u00f4tsError as ex1:\n    # on affiche l'erreur\n    print(f\"L'erreur 1 suivante s'est produite : {ex1}\")\nexcept BaseException as ex2:\n    # on affiche l'erreur\n    print(f\"L'erreur 2 suivante s'est produite : {ex2}\")\nfinally:\n    # fin\n    print(\"Termin\u00e9...\")\n</code></pre> <ul> <li>lignes 1-10\u00a0: on attend un param\u00e8tre. On v\u00e9rifie qu\u2019il est l\u00e0 et correct\u00a0;</li> <li>lignes 12-14\u00a0: on configure l\u2019application (g\u00e9n\u00e9rale, sqlalchemy, couches) en passant en param\u00e8tre le type de SGBD choisi\u00a0;</li> <li>lignes 19-20\u00a0: on va avoir besoin de la couche [dao]. On la r\u00e9cup\u00e8re\u00a0;</li> <li>ligne 25\u00a0: on fait le transfert en base. Toutes les informations n\u00e9cessaires \u00e0 la m\u00e9thode [transfer_admindata_in_database] sont disponibles dans les propri\u00e9t\u00e9s de la couche [dao] de la ligne 20. C\u2019est l\u00e0 qu\u2019elle ira les chercher\u00a0; Apr\u00e8s ex\u00e9cution avec la base MySQL, celle-ci contient les \u00e9l\u00e9ments suivants (phpMyAdmin)\u00a0:</li> </ul> <p></p> <p></p> <p></p> <p>Colonne [3], on voit les valeurs attribu\u00e9es par MySQL \u00e0 la cl\u00e9 primaire [id]. La num\u00e9rotation d\u00e9marre \u00e0 1. La copie d\u2019\u00e9cran ci-dessus a \u00e9t\u00e9 obtenue apr\u00e8s plusieurs ex\u00e9cutions du script.</p> <p></p> <p></p> <p>Avec la base PostgreSQL les r\u00e9sultats sont les suivants\u00a0:</p> <p></p> <ul> <li>on clique droit sur [1], puis ensuite [2-3]\u00a0;</li> <li>en [4], on a bien les donn\u00e9es des tranches d\u2019imp\u00f4ts\u00a0; On refait la m\u00eame chose pour la table des constantes [tbconstantes]\u00a0:</li> </ul> <p></p> <p></p> <p></p>"},{"location":"exercice-dx27application-version-5.html#202-application-2-calcul-de-limpot-en-mode-batch","title":"20.2. Application 2\u00a0: calcul de l\u2019imp\u00f4t en mode batch","text":""},{"location":"exercice-dx27application-version-5.html#2021-architecture","title":"20.2.1. Architecture","text":"<p>L\u2019application de calcul de l\u2019imp\u00f4t de la version 4 utilisait l'architecture suivante\u00a0:</p> <p></p> <p>La couche [dao] impl\u00e9mente une interface [InterfaceImp\u00f4tsDao]. Nous avons construit une classe impl\u00e9mentant cette interface\u00a0:</p> <ul> <li>[Imp\u00f4tsDaoWithAdminDataInJsonFile] qui allait chercher les donn\u00e9es fiscales dans un fichier jSON. C\u2019\u00e9tait la version 3\u00a0; Nous allons impl\u00e9menter l\u2019interface [InterfaceImp\u00f4tsDao] par une nouvelle classe [ImpotsDaoWithTaxAdminDataInDatabase] qui ira chercher les donn\u00e9es de l\u2019administration fiscale dans une base de donn\u00e9es. La couche [dao], comme pr\u00e9c\u00e9demment, \u00e9crira les r\u00e9sultats dans un fichier jSON et trouvera les donn\u00e9es des contribuables dans un fichier texte. Nous savons que si nous continuons \u00e0 respecter l\u2019interface [InterfaceImp\u00f4tsDao], la couche [m\u00e9tier] n\u2019aura pas \u00e0 \u00eatre modifi\u00e9e.</li> </ul> <p>La nouvelle architecture sera la suivante\u00a0:</p> <p></p>"},{"location":"exercice-dx27application-version-5.html#2022-configuration-de-lapplication","title":"20.2.2. Configuration de l\u2019application","text":"<p>Le fichier de configuration [config_database] reste ce qu\u2019il \u00e9tait dans l\u2019application 1. La configuration [config] int\u00e8gre des \u00e9l\u00e9ments nouveaux\u00a0:</p> <pre><code>    # \u00e9tape 2 ------\n    # on compl\u00e8te la configuration de l'application\n    config.update({\n        # chemins absolus des fichiers de donn\u00e9es\n        \"admindataFilename\": f\"{script_dir}/../../data/input/admindata.json\",\n        \"taxpayersFilename\": f\"{script_dir}/../../data/input/taxpayersdata.txt\",\n        \"errorsFilename\": f\"{script_dir}/../../data/output/errors.txt\",\n        \"resultsFilename\": f\"{script_dir}/../../data/output/r\u00e9sultats.json\"\n    })\n</code></pre> <ul> <li>lignes 6-8\u00a0: les chemins absolus des fichiers texte utilis\u00e9s par l\u2019application 2\u00a0; La configuration des couches [config_layers] \u00e9volue\u00a0de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code>def configure(config: dict) -&gt; dict:\n    # instanciation couche dao\n    from ImpotsDaoWithAdminDataInDatabase import ImpotsDaoWithAdminDataInDatabase\n    config[\"dao\"] = ImpotsDaoWithAdminDataInDatabase(config)\n\n    # instanciation couche [m\u00e9tier]\n    from Imp\u00f4tsM\u00e9tier import Imp\u00f4tsM\u00e9tier\n    config['m\u00e9tier'] = Imp\u00f4tsM\u00e9tier()\n\n    # on rend la config\n    return config\n</code></pre> <ul> <li>lignes 3-4\u00a0: la couche [dao] est d\u00e9sormais impl\u00e9ment\u00e9e par la classe [ImpotsDaoWithAdminDataInDatabase]. Cette classe est nouvelle mais impl\u00e9mente la m\u00eame interface [InterfaceDao] que la version 4 de l\u2019exercice d\u2019application\u00a0;</li> <li>lignes 7-8\u00a0: la couche [m\u00e9tier] est impl\u00e9ment\u00e9e par la classe [Imp\u00f4tsM\u00e9tier]. C\u2019est la classe utilis\u00e9e dans la version 4 de l\u2019exercice d\u2019application\u00a0;</li> </ul>"},{"location":"exercice-dx27application-version-5.html#2023-la-couche-dao","title":"20.2.3. La couche [dao]","text":"<p>La classe d'impl\u00e9mentation [ImpotsDaoWithAdminDataInDatabase] de l'interface [InterfaceImp\u00f4tsDao] sera la suivante\u00a0:</p> <pre><code># imports\nfrom sqlalchemy.exc import DatabaseError, IntegrityError, InterfaceError\n\nfrom AbstractImp\u00f4tsDao import AbstractImp\u00f4tsDao\nfrom AdminData import AdminData\nfrom Constantes import Constantes\nfrom Imp\u00f4tsError import Imp\u00f4tsError\nfrom Tranche import Tranche\n\n\nclass ImpotsDaoWithAdminDataInDatabase(AbstractImp\u00f4tsDao):\n    # constructeur\n    def __init__(self, config: dict):\n        # config[\"taxPayersFilename\"] : le nom du fichier texte des contribuables\n        # config[\"taxPayersResultsFilename\"] : le nom du fichier jSON des r\u00e9sultats\n        # config[\"errorsFilename\"] : enregistre les erreurs trouv\u00e9es dans taxPayersFilename\n        # config[\"database\"] : configuration de la base de donn\u00e9es\n\n        # initialisation de la classe Parent\n        AbstractImp\u00f4tsDao.__init__(self, config)\n        # m\u00e9morisation param\u00e8tre\n        self.__config = config\n        # admindata\n        self.__admindata = None\n\n    # impl\u00e9mentation de l'interface\n    def get_admindata(self):\n        # admindata a-t-il \u00e9t\u00e9 m\u00e9moris\u00e9 ?\n        if self.__admindata:\n            return self.__admindata\n        # on fait une requ\u00eate en BD\n        session = None\n        config = self.__config\n        try:\n            # une session\n            database_config = config[\"database\"]\n            session = database_config[\"session\"]\n\n            # on lit la table des tranches de l'imp\u00f4t\n            tranches = session.query(Tranche).all()\n\n            # on lit la table des constantes (1 seule ligne)\n            constantes = session.query(Constantes).first()\n\n            # on cr\u00e9e l'instance admindata\n            admindata = AdminData()\n            # on y cr\u00e9e les tableaux limtes, coeffR, coeffN\n            limites = admindata.limites = []\n            coeffr = admindata.coeffr = []\n            coeffn = admindata.coeffn = []\n            for tranche in tranches:\n                limites.append(float(tranche.limite))\n                coeffr.append(float(tranche.coeffr))\n                coeffn.append(float(tranche.coeffn))\n            # on y rajoute les constantes\n            admindata.fromdict(constantes.asdict())\n            # on m\u00e9morise admindata\n            self.__admindata = admindata\n            # on rend la valeur\n            return self.__admindata\n        except (IntegrityError, DatabaseError, InterfaceError) as erreur:\n            # on relance l'exception sous une autre forme\n            raise Imp\u00f4tsError(27, f\"{erreur}\")\n        finally:\n            # on ferme la session\n            if session:\n                session.close()\n</code></pre> <p>Notes</p> <ul> <li>ligne 11\u00a0: la classe [ImpotsDaoWithAdminDataInDatabase] h\u00e9rite de la classe [AbstractImp\u00f4tsDao] pr\u00e9sent\u00e9e dans la version 4. On sait que cette derni\u00e8re impl\u00e9mente l\u2019interface [InterfaceDao]\u00a0pr\u00e9sent\u00e9e dans cette m\u00eame version. C\u2019est le respect de cette interface qui nous permet de ne pas changer la couche [m\u00e9tier]\u00a0;</li> <li>ligne 13\u00a0: le constructeur de la classe re\u00e7oit en param\u00e8tre le dictionnaire de la configuration de l\u2019application\u00a0;</li> <li>ligne 20\u00a0: la classe parent [] est initialis\u00e9e. Elle impl\u00e9mente partiellement l\u2019interface [InterfaceDao]\u00a0:</li> <li>[get_taxpayers_data] lit le fichier [taxpayersdata.txt] qui contient les donn\u00e9es des contribuables\u00a0;</li> <li>[write_taxpayers_results] \u00e9crit les r\u00e9sultats dans le fichier jSON [r\u00e9sultats.json]\u00a0;</li> <li>[get_admindata] n\u2019est pas impl\u00e9ment\u00e9e\u00a0;</li> <li>ligne 22\u00a0: on m\u00e9morise la configuration pass\u00e9e en param\u00e8tres\u00a0;</li> <li>ligne 27\u00a0: impl\u00e9mentation de la m\u00e9thode [get_admindata] de l\u2019interface [InterfaceDao]\u00a0:</li> <li>lignes 28-30\u00a0: la m\u00e9thode [get_admindata] r\u00e9cup\u00e8re les donn\u00e9es de l\u2019administration fiscale dans un objet de type [AdminData] et m\u00e9morise cet objet dans [self.__admindata]. Si la m\u00e9thode [get_admindata] est appel\u00e9e plusieurs fois, on n\u2019interroge pas la base de donn\u00e9es plusieurs fois. On l\u2019interroge seulement la premi\u00e8re fois. Les fois suivantes, on rend l\u2019objet [self.__admindata]\u00a0;</li> <li>lignes 36-37\u00a0: on r\u00e9cup\u00e8re la session [sqlalchemy] qui a \u00e9t\u00e9 cr\u00e9\u00e9e lors de la configuration de l\u2019application\u00a0par [config_database]\u00a0;</li> <li>lignes 40\u00a0: on r\u00e9cup\u00e8re les tranches de l\u2019imp\u00f4t dans une liste\u00a0;</li> <li>lignes 43\u00a0: on r\u00e9cup\u00e8re les constantes du calcul de l\u2019imp\u00f4t\u00a0;</li> <li>ligne 46\u00a0: on cr\u00e9e une instance de la classe [AdminData]. On rappelle qu\u2019elle d\u00e9rive de [BaseEntity]\u00a0;</li> <li>lignes 48-54\u00a0: on initialise les tableaux [limites, coeffr, coeffn] de l\u2019instance [AdminData]\u00a0;</li> <li>lignes 55-56\u00a0: on initialise les autres propri\u00e9t\u00e9s de [AdminData] avec les constantes du calcul de l\u2019imp\u00f4t. On avait pris soin de donner les m\u00eames noms aux propri\u00e9t\u00e9s des classes [AdminData] et [Constantes], ce qui simplifie le code\u00a0;</li> <li>lignes 57-58\u00a0: l\u2019instance [AdminData] est m\u00e9moris\u00e9e dans la couche [dao] pour la rendre lors des prochains appels \u00e0 la m\u00e9thode [get_admindata]\u00a0;</li> <li>ligne 60\u00a0: on rend la valeur demand\u00e9e par le code appelant\u00a0;</li> <li>lignes 61-63\u00a0: gestion d\u2019une \u00e9ventuelle erreur\u00a0;</li> <li>lignes 64-67\u00a0: la base de donn\u00e9es ne fait l\u2019objet que d\u2019une unique requ\u00eate. On peut donc fermer la session [sqlalchemy]\u00a0;</li> </ul>"},{"location":"exercice-dx27application-version-5.html#2024-test-de-la-couche-dao","title":"20.2.4. Test de la couche [dao]","text":"<p>Dans la version 4 de cette application, nous avions construit une classe de test de la couche [m\u00e9tier]. Plus exactement, elle testait \u00e0 la fois les couches [m\u00e9tier] et [dao]. Nous reprenons ce test pour v\u00e9rifier que la couche [dao] fonctionne comme attendu. En effet, la couche [m\u00e9tier] elle ne change pas.</p> <p></p> <p></p> <p>Le test [TestDaoM\u00e9tier] est le suivant\u00a0:</p> <pre><code>import unittest\n\n\nclass TestDaoM\u00e9tier(unittest.TestCase):\n\n    def test_1(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'oui', 'enfants': 2, 'salaire': 55555,\n        # 'imp\u00f4t': 2814, 'surc\u00f4te': 0, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.14}\n        taxpayer = TaxPayer().fromdict({\"mari\u00e9\": \"oui\", \"enfants\": 2, \"salaire\": 55555})\n        m\u00e9tier.calculate_tax(taxpayer, admindata)\n        # v\u00e9rification\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 2815, delta=1)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.14, delta=0.01)\n        self.assertEqual(taxpayer.surc\u00f4te, 0)\n\n    \u2026\n\n    def test_11(self) -&gt; None:\n        from TaxPayer import TaxPayer\n\n        # {'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 200000,\n        # 'imp\u00f4t': 42842, 'surc\u00f4te': 17283, 'd\u00e9c\u00f4te': 0, 'r\u00e9duction': 0, 'taux': 0.41}\n        taxpayer = TaxPayer().fromdict({'mari\u00e9': 'oui', 'enfants': 3, 'salaire': 200000})\n        m\u00e9tier.calculate_tax(taxpayer, admindata)\n        # v\u00e9rifications\n        self.assertAlmostEqual(taxpayer.imp\u00f4t, 42842, 1)\n        self.assertEqual(taxpayer.d\u00e9c\u00f4te, 0)\n        self.assertEqual(taxpayer.r\u00e9duction, 0)\n        self.assertAlmostEqual(taxpayer.taux, 0.41, delta=0.01)\n        self.assertAlmostEqual(taxpayer.surc\u00f4te, 17283, delta=1)\n\n\nif __name__ == '__main__':\n    # on attend un param\u00e8tre mysql ou pgres\n    import sys\n    syntaxe = f\"{sys.argv[0]} mysql / pgres\"\n    erreur = len(sys.argv) != 2\n    if not erreur:\n        sgbd = sys.argv[1].lower()\n        erreur = sgbd != \"mysql\" and sgbd != \"pgres\"\n    if erreur:\n        print(f\"syntaxe : {syntaxe}\")\n        sys.exit()\n\n    # on configure l'application\n    import config\n    config = config.configure({'sgbd': sgbd})\n    # couche m\u00e9tier\n    m\u00e9tier = config['m\u00e9tier']\n    try:\n        # admindata\n        admindata = config['dao'].get_admindata()\n    except BaseException as ex:\n        # affichage\n        print((f\"L'erreur suivante s'est produite : {ex}\"))\n        # fin\n        sys.exit()\n    # on en\u00e8ve le param\u00e8tre re\u00e7u par le script\n    sys.argv.pop()\n    # on ex\u00e9cute les m\u00e9thodes de test\n    print(\"tests en cours...\")\n   unittest.main()\n</code></pre> <ul> <li>nous ne revenons pas sur les 11 tests d\u00e9crits au paragraphe |test couche [m\u00e9tier] version 4|\u00a0;</li> <li>lignes 37-66\u00a0: nous allons ex\u00e9cuter le script des tests comme une application normale et non pas comme un test UnitTest. C\u2019est la ligne66qui fera intervenir le framework UnitTest. Dans les tests pr\u00e9c\u00e9dents, nous utilisions la m\u00e9thode [setUp] pour configurer l\u2019ex\u00e9cution de chaque test. On refaisait 11 fois la m\u00eame configuration puisque la fonction [setUp] est ex\u00e9cut\u00e9e avant chaque test. Ici, nous faisons la configuration 1 fois. Elle consiste \u00e0 d\u00e9finir des variables globales [m\u00e9tier] ligne 53, [admindata] ligne 56 qui seront ensuite utilis\u00e9es par les m\u00e9thodes de [TestDaoM\u00e9tier], ligne 12 par exemple\u00a0;</li> <li>lignes 39-47\u00a0: le script de test attend un param\u00e8tre [mysql / pgres] qui indique si on utilise une base MySQL ou PostgreSQL\u00a0;</li> <li>lignes 50-51\u00a0: le test est configur\u00e9\u00a0;</li> <li>ligne 53\u00a0: on r\u00e9cup\u00e8re la couche [m\u00e9tier] dans la configuration\u00a0;</li> <li>ligne 56\u00a0: on fait de m\u00eame avec la couche [dao]. On r\u00e9cup\u00e8re alors l\u2019instance [admindata] qui encapsule les donn\u00e9es n\u00e9cessaires au calcul de l\u2019imp\u00f4t\u00a0;</li> <li>les tests ont montr\u00e9 que la m\u00e9thode [unittest.main()] de la ligne 66 n\u2019ignorait pas le param\u00e8tre [mysql / pgres] re\u00e7u par le script mais lui donnait une signification autre. La ligne 63 fait en sorte que cette m\u00e9thode n\u2019ait plus aucun param\u00e8tre\u00a0; Nous cr\u00e9ons deux configurations d\u2019ex\u00e9cution\u00a0:</li> </ul> <p></p> <p></p> <p>Si nous ex\u00e9cutons l\u2019une de ces deux configurations, nous obtenons les r\u00e9sultats suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/impots/v05/tests/TestDaoM\u00e9tier.py mysql\ntests en cours...\n...........\n----------------------------------------------------------------------\nRan 11 tests in 0.001s\n\nOK\n\nProcess finished with exit code 0\n</code></pre> <ul> <li>lignes 5 et 7\u00a0: les 11 tests ont \u00e9t\u00e9 r\u00e9ussis\u00a0; Rappelons que ces tests ne v\u00e9rifient que 11 cas du calcul de l\u2019imp\u00f4t. Leur r\u00e9ussite peut n\u00e9anmoins suffire pour nous donner confiance dans la couche [dao].</li> </ul>"},{"location":"exercice-dx27application-version-5.html#2025-le-script-principal","title":"20.2.5. Le script principal","text":"<p>Le script principal [main] est le m\u00eame que dans la version 4\u00a0:</p> <pre><code># on attend un param\u00e8tre mysql ou pgres\nimport sys\nsyntaxe = f\"{sys.argv[0]} mysql / pgres\"\nerreur = len(sys.argv) != 2\nif not erreur:\n    sgbd = sys.argv[1].lower()\n    erreur = sgbd != \"mysql\" and sgbd != \"pgres\"\nif erreur:\n    print(f\"syntaxe : {syntaxe}\")\n    sys.exit()\n\n# on configure l'application\nimport config\nconfig = config.configure({'sgbd': sgbd})\n\n# le syspath est \u00e9tabli - on peut faire les imports\nfrom Imp\u00f4tsError import Imp\u00f4tsError\n\n# on r\u00e9cup\u00e8re les couches de l'application (elles sont d\u00e9j\u00e0 instanci\u00e9es)\ndao = config[\"dao\"]\nm\u00e9tier = config[\"m\u00e9tier\"]\n\ntry:\n    # r\u00e9cup\u00e9ration des tranches de l'imp\u00f4t\n    admindata = dao.get_admindata()\n    # lecture des donn\u00e9es des contribuables\n    taxpayers = dao.get_taxpayers_data()[\"taxpayers\"]\n    # des contribuables ?\n    if not taxpayers:\n        raise Imp\u00f4tsError(57, f\"Pas de contribuables valides dans le fichier {config['taxpayersFilename']}\")\n    # calcul de l'imp\u00f4t des contribuables\n    for taxPayer in taxpayers:\n        # taxPayer est \u00e0 la fois un param\u00e8tre d'entr\u00e9e et de sortei\n        # taxPayer va \u00eatre modifi\u00e9\n        m\u00e9tier.calculate_tax(taxPayer, admindata)\n    # \u00e9criture des r\u00e9sultats dans un fichier texte\n    dao.write_taxpayers_results(taxpayers)\nexcept Imp\u00f4tsError as erreur:\n    # affichage de l'erreur\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\nfinally:\n    # termin\u00e9\n    print(\"Travail termin\u00e9...\")\n</code></pre> <p>Notes</p> <ul> <li>lignes 1-10\u00a0: on r\u00e9cup\u00e8re le param\u00e8tre [mysql / pgres] qui indique le SGBD \u00e0 utiliser\u00a0;</li> <li>lignes 12-14\u00a0: l\u2019application est configur\u00e9e\u00a0;</li> <li>lignes 16-17\u00a0: la classe [Imp\u00f4tsError] est import\u00e9e. On en a besoin ligne 38\u00a0;</li> <li>lignes 19-21\u00a0: on r\u00e9cup\u00e8re des r\u00e9f\u00e9rences sur les couches de l\u2019application\u00a0;</li> <li>ligne 25\u00a0: on demande \u00e0 la couche [dao] les donn\u00e9es de l\u2019administration fiscale. La couche [m\u00e9tier] en a besoin pour le calcul de l\u2019imp\u00f4t\u00a0;</li> <li>ligne 27\u00a0: on r\u00e9cup\u00e8re dans une liste, les donn\u00e9es (id, mari\u00e9, enfants, salaire) des contribuables\u00a0;</li> <li>lignes 29-30\u00a0: si cette liste est vide, on lance une exception\u00a0;</li> <li>lignes 32-35\u00a0: calcul de l'imp\u00f4t des \u00e9l\u00e9ments de la liste [taxpayers]\u00a0;</li> <li>ligne 37\u00a0: \u00e9criture des r\u00e9sultats dans le fichier jSON[r\u00e9sultats.json]\u00a0;</li> <li>lignes 38-40\u00a0: gestion de l'\u00e9ventuelle erreur\u00a0; Pour l\u2019ex\u00e9cution du script, on cr\u00e9e deux |configurations d\u2019ex\u00e9cution|\u00a0:</li> </ul> <p></p> <p>Les r\u00e9sultats obtenus dans le fichier [r\u00e9sultats.json] sont ceux de la version 4.</p> <p></p>"},{"location":"exercice-dx27application-version-5.html#203-application-3-calcul-de-limpot-en-mode-interactif","title":"20.3. Application 3\u00a0: calcul de l\u2019imp\u00f4t en mode interactif","text":"<p>Nous introduisons maintenant l\u2019application permettant de calculer l\u2019imp\u00f4t de fa\u00e7on interactive. C\u2019est un portage de l\u2019application 2 de la version 4.</p> <p></p> <p></p> <ul> <li>le script [main] lance le dialogue avec l\u2019utilisateur avec la m\u00e9thode [ui.run] de la couche [ui]\u00a0;</li> <li>la couche [ui]\u00a0:</li> <li>utilise la couche [dao] pour obtenir les donn\u00e9es permettant de faire le calcul de l\u2019imp\u00f4t\u00a0;</li> <li>demande \u00e0 l\u2019utilisateur les renseignements concernant le contribuable dont on veut calculer l\u2019imp\u00f4t\u00a0;</li> <li>utilise la couche [m\u00e9tier] pour faire ce calcul\u00a0; Le fichier [config_layers] instancie une couche suppl\u00e9mentaire\u00a0:</li> </ul> <pre><code>def configure(config: dict) -&gt; dict:\n    # instanciation couche dao\n    from ImpotsDaoWithAdminDataInDatabase import ImpotsDaoWithAdminDataInDatabase\n    config[\"dao\"] = ImpotsDaoWithAdminDataInDatabase(config)\n\n    # instanciation couche [m\u00e9tier]\n    from Imp\u00f4tsM\u00e9tier import Imp\u00f4tsM\u00e9tier\n    config['m\u00e9tier'] = Imp\u00f4tsM\u00e9tier()\n\n    # ui\n    from Imp\u00f4tsConsole import Imp\u00f4tsConsole\n    config['ui'] = Imp\u00f4tsConsole(config)\n\n    # on rend la config\n    return config\n</code></pre> <p>La classe [Imp\u00f4tsConsole], lignes 11-12, est la m\u00eame que dans la |version 4|.</p> <p>Le script principal [main] est le suivant\u00a0:</p> <pre><code># on attend un param\u00e8tre mysql ou pgres\nimport sys\nsyntaxe = f\"{sys.argv[0]} mysql / pgres\"\nerreur = len(sys.argv) != 2\nif not erreur:\n    sgbd = sys.argv[1].lower()\n    erreur = sgbd != \"mysql\" and sgbd != \"pgres\"\nif erreur:\n    print(f\"syntaxe : {syntaxe}\")\n    sys.exit()\n\n# on configure l'application\nimport config\nconfig = config.configure({'sgbd': sgbd})\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom Imp\u00f4tsError import Imp\u00f4tsError\n\n# on r\u00e9cup\u00e8re la couche [ui]\nui = config[\"ui\"]\n\n# code\ntry:\n    # ex\u00e9cution de la couche [ui]\n    ui.run()\nexcept Imp\u00f4tsError as ex1:\n    # on affiche le message d'erreur\n    print(f\"L'erreur 1 suivante s'est produite : {ex1}\")\nexcept BaseException as ex2:\n    # on affiche le message d'erreur\n    print(f\"L'erreur 2 suivante s'est produite : {ex2}\")\nfinally:\n    # ex\u00e9cut\u00e9 dans tous les cas\n    print(\"Travail termin\u00e9...\")\n</code></pre> <ul> <li>lignes 1-10, le script attend un param\u00e8tre [mysql / pgres] qui indique le SGBD \u00e0 utiliser\u00a0;</li> <li>lignes 12-14\u00a0: l\u2019application est configur\u00e9e\u00a0;</li> <li>lignes 19-20\u00a0: on r\u00e9cup\u00e8re la couche [ui] dans la configuration\u00a0;</li> <li>ligne 25\u00a0: on l\u2019ex\u00e9cute\u00a0; Les r\u00e9sultats sont identiques \u00e0 ceux de la |version 4|. Il ne pouvait en \u00eatre autrement puisque toutes les interfaces de la version 4 ont \u00e9t\u00e9 respect\u00e9es dans la version 5.</li> </ul>"},{"location":"fonctions-internet.html","title":"21. Fonctions internet","text":"<p>Nous abordons maintenant les fonctions internet de Python qui nous permettent de faire de la programmation TCP / IP (Transfer Control Protocol / Internet Protocol).</p> <p></p>"},{"location":"fonctions-internet.html#211-les-bases-de-la-programmation-internet","title":"21.1. Les bases de la programmation internet","text":""},{"location":"fonctions-internet.html#2111-generalites","title":"21.1.1. G\u00e9n\u00e9ralit\u00e9s","text":"<p>Consid\u00e9rons la communication entre deux machines distantes A et B\u00a0:</p> <p></p> <p>Lorsque une application AppA d'une machine A veut  communiquer avec une application AppB d'une machine B de l'Internet, elle doit conna\u00eetre plusieurs choses\u00a0:</p> <ul> <li>l'adresse IP (Internet Protocol) ou le nom de la machine B\u00a0;</li> <li>le num\u00e9ro du port avec lequel travaille l'application AppB. En effet la machine B peut supporter de nombreuses applications qui travaillent sur l'Internet. Lorsqu'elle re\u00e7oit des informations provenant du r\u00e9seau, elle doit savoir \u00e0 quelle application sont destin\u00e9es ces informations. Les applications de la machine B ont acc\u00e8s au r\u00e9seau via des guichets appel\u00e9s \u00e9galement des ports de communication. Cette information est contenue dans le paquet re\u00e7u par la machine B afin qu'il soit d\u00e9livr\u00e9 \u00e0 la bonne application\u00a0;</li> <li>les protocoles de communication compris par la machine B. Dans notre \u00e9tude, nous utiliserons uniquement les protocoles TCP-IP\u00a0;</li> <li>le protocole de dialogue accept\u00e9 par l'application AppB. En effet, les machines A et B vont se \"parler\". Ce qu'elles vont dire va \u00eatre encapsul\u00e9 dans les protocoles TCP-IP. N\u00e9anmoins, lorsqu'au bout de la cha\u00eene, l'application AppB va recevoir l'information envoy\u00e9e par l'applicaton AppA, il faut qu'elle soit capable de l'interpr\u00e9ter. Ceci est analogue \u00e0 la situation o\u00f9 deux personnes A et B communiquent par t\u00e9l\u00e9phone\u00a0: leur dialogue est transport\u00e9 par le t\u00e9l\u00e9phone. La parole va \u00eatre cod\u00e9e sous forme de signaux par le t\u00e9l\u00e9phone A, transport\u00e9e par des lignes t\u00e9l\u00e9phoniques, arriver au t\u00e9l\u00e9phone B pour y \u00eatre d\u00e9cod\u00e9e. La personne B entend alors des paroles. C'est l\u00e0 qu'intervient la notion de protocole de dialogue\u00a0: si A parle fran\u00e7ais et que B ne comprend pas cette langue, A et B ne pourront dialoguer utilement\u00a0; Aussi les deux applications communicantes doivent-elles \u00eatre d'accord sur le type de dialogue qu'elles vont adopter. Par exemple, le dialogue avec un service ftp n'est pas le m\u00eame qu'avec un service pop\u00a0: ces deux services n'acceptent pas les m\u00eames commandes.  Elles ont un protocole de dialogue diff\u00e9rent\u00a0;</li> </ul>"},{"location":"fonctions-internet.html#2112-les-caracteristiques-du-protocole-tcp","title":"21.1.2. Les caract\u00e9ristiques du protocole TCP","text":"<p>Nous n'\u00e9tudierons ici que des communications r\u00e9seau utilisant le protocole de transport TCP dont voici les principales caract\u00e9ristiques\u00a0:</p> <ul> <li>le processus qui souhaite \u00e9mettre \u00e9tablit tout d'abord une connexion avec le processus destinataire des informations qu'il va \u00e9mettre. Cette connexion se fait entre un port de la machine \u00e9mettrice et un port de la machine r\u00e9ceptrice. Il y a entre les deux ports un chemin virtuel qui est ainsi cr\u00e9\u00e9 et qui sera r\u00e9serv\u00e9 aux deux seuls processus ayant r\u00e9alis\u00e9 la connexion\u00a0;</li> <li>tous les paquets \u00e9mis par le processus source suivent ce chemin virtuel et arrivent dans l'ordre o\u00f9 ils ont \u00e9t\u00e9 \u00e9mis\u00a0;</li> <li>l'information \u00e9mise a un aspect continu. Le processus \u00e9metteur envoie des informations \u00e0 son rythme. Celles-ci ne sont pas n\u00e9cessairement envoy\u00e9es tout de suite\u00a0: le protocole TCP attend d'en avoir assez pour les envoyer. Elles sont stock\u00e9es dans une structure appel\u00e9e segment TCP. Ce segment une fois rempli sera transmis \u00e0 la couche IP o\u00f9 il sera encapsul\u00e9 dans un paquet IP\u00a0;</li> <li>chaque segment envoy\u00e9 par le protocole TCP est num\u00e9rot\u00e9. Le protocole TCP destinataire v\u00e9rifie qu'il re\u00e7oit bien les segments en s\u00e9quence. Pour chaque segment correctement re\u00e7u, il envoie un accus\u00e9 de r\u00e9ception \u00e0 l'exp\u00e9diteur\u00a0;</li> <li>lorsque ce dernier le re\u00e7oit, il l'indique au processus \u00e9metteur. Celui-ci peut donc savoir qu'un segment est arriv\u00e9 \u00e0 bon port\u00a0;</li> <li>si au bout d'un certain temps, le protocole TCP ayant \u00e9mis un segment ne re\u00e7oit pas d'accus\u00e9 de r\u00e9ception, il retransmet le segment en question, garantissant ainsi la qualit\u00e9 du service d'acheminement de l'information\u00a0;</li> <li>le circuit virtuel \u00e9tabli entre les deux processus qui communiquent est full-duplex\u00a0: cela signifie que l'information peut transiter dans les deux sens. Ainsi le processus destination peut envoyer des accus\u00e9s de r\u00e9ception alors m\u00eame que le processus source continue d'envoyer des informations. Cela permet par exemple au protocole TCP source d'envoyer plusieurs segments sans attendre d'accus\u00e9 de r\u00e9ception. S'il r\u00e9alise au bout d'un certain temps qu'il n'a pas re\u00e7u l'accus\u00e9 de r\u00e9ception d'un certain segment n\u00b0 n, il reprendra l'\u00e9mission des segments \u00e0 ce point\u00a0;</li> </ul>"},{"location":"fonctions-internet.html#2113-la-relation-client-serveur","title":"21.1.3. La relation client-serveur","text":"<p>Souvent, la communication sur Internet est dissym\u00e9trique\u00a0: la machine A initie une connexion pour demander un service \u00e0 la machine B\u00a0: il pr\u00e9cise qu'il veut ouvrir une connexion avec le service SB1 de la machine B. Celle-ci accepte ou refuse. Si elle accepte, la machine A peut envoyer ses demandes au service SB1. Celles-ci doivent se conformer au protocole de dialogue compris par le service SB1. Un dialogue demande-r\u00e9ponse s'instaure ainsi entre la machine A qu'on appelle machine cliente et la machine B qu'on appelle machine serveur. L'un des deux partenaires fermera la connexion.</p>"},{"location":"fonctions-internet.html#2114-architecture-dun-client","title":"21.1.4. Architecture d'un client","text":"<p>L'architecture d'un programme r\u00e9seau demandant les services d'une application serveur sera la suivante\u00a0:</p> <pre><code>ouvrir la connexion avec le service SB1 de la machine B\nsi r\u00e9ussite alors\n    tant que ce n'est pas fini\n        pr\u00e9parer une demande\n        l'\u00e9mettre vers la machine B\n        attendre et r\u00e9cup\u00e9rer la r\u00e9ponse\n        la traiter\n    fin tant que\nfinsi\nfermer la connexion\n</code></pre>"},{"location":"fonctions-internet.html#2115-architecture-dun-serveur","title":"21.1.5. Architecture d'un serveur","text":"<p>L'architecture d'un programme offrant des services sera la suivante\u00a0:</p> <pre><code>ouvrir le service sur la machine locale\ntant que le service est ouvert\n    se mettre \u00e0 l'\u00e9coute des demandes de connexion sur un port dit port d'\u00e9coute\n    lorsqu'il y a une demande, la faire traiter par une autre t\u00e2che sur un autre port dit port de service\nfin tant que\n</code></pre> <p>Le programme serveur traite diff\u00e9remment la demande de connexion initiale d'un client de ses demandes ult\u00e9rieures visant \u00e0 obtenir un service. Le programme n'assure pas le service lui-m\u00eame. S'il le faisait, pendant la dur\u00e9e du service il ne serait plus \u00e0 l'\u00e9coute des demandes de connexion et des clients ne seraient alors pas servis. Il proc\u00e8de autrement\u00a0: d\u00e8s qu'une demande de connexion est re\u00e7ue sur le port d'\u00e9coute puis accept\u00e9e, le serveur cr\u00e9e une t\u00e2che charg\u00e9e de rendre le service demand\u00e9 par le client. Ce service est rendu sur un autre port de la machine serveur appel\u00e9 port de service. On peut ainsi servir plusieurs clients en m\u00eame temps.</p> <p>Une t\u00e2che de service aura la structure suivante\u00a0:</p> <pre><code>tant que le service n'a pas \u00e9t\u00e9 rendu totalement\n    attendre une demande sur le port de service\n    lorsqu'il y en a une, \u00e9laborer la r\u00e9ponse\n    transmettre la r\u00e9ponse via le port de service\nfin tant que\nlib\u00e9rer le port de service\n</code></pre>"},{"location":"fonctions-internet.html#212-decouvrir-les-protocoles-de-communication-de-linternet","title":"21.2. D\u00e9couvrir les protocoles de communication de l'internet","text":""},{"location":"fonctions-internet.html#2121-introduction","title":"21.2.1. Introduction","text":"<p>Lorsqu'un client s'est connect\u00e9 \u00e0 un serveur, s'\u00e9tablit ensuite un dialogue entre-eux. La nature de celui-ci forme ce qu'on appelle le protocole de communication du serveur. Parmi les protocoles les plus courants de l'internet on trouve les suivants\u00a0:</p> <ul> <li>HTTP\u00a0: HyperText Transfer Protocol - le protocole de dialogue avec un serveur web (serveur HTTP)\u00a0;</li> <li>SMTP\u00a0: Simple Mail Transfer Protocol - le protocole de dialogue avec un serveur d'envoi de courriers \u00e9lectroniques (serveur SMTP)\u00a0;</li> <li>POP\u00a0: Post Office Protocol - le protocole de dialogue avec un serveur de stockage du courrier \u00e9lectronique (serveur POP). Il s'agit l\u00e0 de r\u00e9cup\u00e9rer les courriers \u00e9lectroniques re\u00e7us et non d'en envoyer\u00a0;</li> <li>IMAP\u00a0: Internet Message Access Protocol - le protocole de dialogue avec un serveur de stockage du courrier \u00e9lectronique (serveur IMAP). Ce protocole a remplac\u00e9 progressivement le protocole POP plus ancien\u00a0;</li> <li> <p>FTP\u00a0: File Transfer Protocol - le protocole de dialogue avec un serveur de stockage de fichiers (serveur FTP)\u00a0; Tous ces protocoles ont la particularit\u00e9 d'\u00eatre des protocoles \u00e0 lignes de texte\u00a0: le client et le serveur s'\u00e9changent des lignes de texte. Si on a un client capable de\u00a0:</p> </li> <li> <p>cr\u00e9er une connexion avec un serveur TCP\u00a0;</p> </li> <li>afficher \u00e0 la console les lignes de texte que le serveur lui envoie\u00a0;</li> <li>envoyer au serveur les lignes de texte qu'un utilisateur saisirait au clavier\u00a0; alors on est capable de dialoguer avec un serveur TCP ayant un protocole \u00e0 lignes de texte pour peu qu'on connaisse les r\u00e8gles de ce protocole.</li> </ul>"},{"location":"fonctions-internet.html#2122-utilitaires-tcp","title":"21.2.2. Utilitaires TCP","text":"<p>Dans les codes associ\u00e9s \u00e0 ce document, on trouve deux utilitaires de communication TCP\u00a0:</p> <ul> <li>[RawTcpClient] permet de se connecter sur le port P d\u2019un serveur S\u00a0;</li> <li>[RawTcpServer] permet de cr\u00e9er un serveur qui attend des clients sur un port P\u00a0; Ce sont deux programmes C# dont les codes sources vous sont donn\u00e9s. Vous pouvez donc les modifier.</li> </ul> <p>Le serveur TCP [RawTcpServer] s\u2019appelle avec la syntaxe [RawTcpServeur port] pour cr\u00e9er un service TCP sur le port [port] de la machine locale (l\u2019ordinateur sur lequel vous travaillez)\u00a0:</p> <ul> <li>le serveur peut servir plusieurs clients simultan\u00e9ment\u00a0;</li> <li>le serveur ex\u00e9cute les commandes tap\u00e9es par l\u2019utilisateur tap\u00e9es au clavier. Celles-ci sont les suivantes\u00a0:</li> <li>list\u00a0: liste les clients actuellement connect\u00e9s au serveur. Ceux-ci sont affich\u00e9s sous la forme [id=x-nom=y]. Le champ [id] sert \u00e0 identifier les clients\u00a0;</li> <li>send x [texte]\u00a0: envoie texte au client n\u00b0 x (id=x). Les crochets [] ne sont pas envoy\u00e9s. Ils sont n\u00e9cessaires dans la commande. Ils servent \u00e0 d\u00e9limiter visuellement le texte envoy\u00e9 au client\u00a0;</li> <li>close x\u00a0: ferme la connexion avec le client n\u00b0 x\u00a0;</li> <li>quit\u00a0: ferme toutes les connexions et arr\u00eate le service\u00a0;</li> <li>les lignes envoy\u00e9es par le client au serveur sont affich\u00e9es sur la console\u00a0;</li> <li>l\u2019ensemble des \u00e9changes est logu\u00e9 dans un fichier texte portant le nom [machine-port.txt] o\u00f9</li> <li>[machine] est le nom de la machine sur laquelle s\u2019ex\u00e9cute le code\u00a0;</li> <li> <p>[port] est le port de service qui r\u00e9pond aux demandes du client\u00a0; Le client TCP [RawTcpClient] s\u2019appelle avec la syntaxe [RawTcpClient serveur port] pour se connecter au port [port] du serveur [serveur]\u00a0:</p> </li> <li> <p>les lignes tap\u00e9es par l\u2019utilisateur au clavier sont envoy\u00e9es au serveur\u00a0;</p> </li> <li>les lignes envoy\u00e9es par le serveur sont affich\u00e9es sur la console\u00a0;</li> <li>l\u2019ensemble des \u00e9changes est logu\u00e9 dans un fichier texte portant le nom [serveur-port.txt]\u00a0; Voyons un exemple. On ouvre deux fen\u00eatres terminal PyCharm et on se positionne dans chacune d\u2019elles sur le dossier des utilitaires\u00a0:</li> </ul> <p></p> <p>Dans l\u2019une des fen\u00eatres on lance le serveur [RawTcpServer] sur le port 100\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpServer.exe 100\nserver : Serveur g\u00e9n\u00e9rique lanc\u00e9 sur le port 0.0.0.0:100\nserver : Attente d'un client...\nserver : Commandes disponibles : [list, send id [texte], close id, quit]\nuser :\n</code></pre> <ul> <li>ligne 1, nous sommes plac\u00e9s dans le dossier des utilitaires\u00a0;</li> <li>ligne 1, nous lan\u00e7ons le serveur TCP sur le port 100\u00a0;</li> <li>lignes 2-4, le serveur se met en attente d\u2019un client TCP\u00a0et affiche une liste de commandes que l\u2019utilisateur au clavier peut taper\u00a0;</li> <li>ligne 5, le serveur attend une commande tap\u00e9e par l\u2019utilisateur au clavier\u00a0; Dans l\u2019autre fen\u00eatre de commandes, on lance le client TCP\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpClient.exe localhost 100\nClient [DESKTOP-30FF5FB:51173] connect\u00e9 au serveur [localhost-100]\nTapez vos commandes (quit pour arr\u00eater) :\n</code></pre> <ul> <li>ligne 1, nous sommes plac\u00e9s dans le dossier des utilitaires\u00a0;</li> <li>ligne 1 nous lan\u00e7ons le client TCP\u00a0: nous lui disons de se connecter au port 100 de la machine locale (celle sur laquelle s\u2019ex\u00e9cute le code de [RawTcpClient])\u00a0;</li> <li>ligne 2, le client a r\u00e9ussi \u00e0 se connecter au serveur. On indique les coordonn\u00e9es du client\u00a0: il est sur la machine [DESKTOP-30FF5FB] (la machine locale dans cet exemple) et utilise le port [51173] pour communiquer avec le serveur\u00a0:</li> <li>ligne 3, le client attend une commande tap\u00e9e par l\u2019utilisateur au clavier\u00a0; Revenons sur la fen\u00eatre du serveur. Son contenu a \u00e9volu\u00e9\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpServer.exe 100\nserver : Serveur g\u00e9n\u00e9rique lanc\u00e9 sur le port 0.0.0.0:100\nserver : Attente d'un client...\nserver : Commandes disponibles : [list, send id [texte], close id, quit]\nuser : server : Client 1-DESKTOP-30FF5FB-51173 connect\u00e9...\nserver : Attente d'un client...\n</code></pre> <ul> <li>ligne 5, un client a \u00e9t\u00e9 d\u00e9tect\u00e9. Le serveur lui a donn\u00e9 le n\u00b0 1. Le serveur a correctement identifi\u00e9 le client distant (machine et port)\u00a0;</li> <li>ligne 6, le serveur se remet en attente d\u2019un nouveau client\u00a0; Revenons sur la fen\u00eatre du client et envoyons une commande au serveur\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpClient.exe localhost 100\nClient [DESKTOP-30FF5FB:51173] connect\u00e9 au serveur [localhost-100]\nTapez vos commandes (quit pour arr\u00eater) :\nhello from client\n</code></pre> <ul> <li>ligne 4, la commande envoy\u00e9e au serveur\u00a0; Revenons sur la fen\u00eatre du serveur. Son contenu a \u00e9volu\u00e9\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpServer.exe 100\nserver : Serveur g\u00e9n\u00e9rique lanc\u00e9 sur le port 0.0.0.0:100\nserver : Attente d'un client...\nserver : Commandes disponibles : [list, send id [texte], close id, quit]\nuser : server : Client 1-DESKTOP-30FF5FB-51173 connect\u00e9...\nserver : Attente d'un client...\nclient 1 : [hello from client]\n</code></pre> <ul> <li>ligne 7, entre crochets, le message re\u00e7u par le serveur\u00a0; Envoyons une r\u00e9ponse au client\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpServer.exe 100\nserver : Serveur g\u00e9n\u00e9rique lanc\u00e9 sur le port 0.0.0.0:100\nserver : Attente d'un client...\nserver : Commandes disponibles : [list, send id [texte], close id, quit]\nuser : server : Client 1-DESKTOP-30FF5FB-51173 connect\u00e9...\nserver : Attente d'un client...\nclient 1 : [hello from client]\nsend 1 [hello from server]\nuser :\n</code></pre> <ul> <li>ligne 8, la r\u00e9ponse envoy\u00e9e au client 1. Seul le texte entre les crochets est envoy\u00e9, pas les crochets eux-m\u00eames\u00a0; Revenons \u00e0 la fen\u00eatre du client\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpClient.exe localhost 100\nClient [DESKTOP-30FF5FB:51173] connect\u00e9 au serveur [localhost-100]\nTapez vos commandes (quit pour arr\u00eater) :\nhello from client\n&lt;-- [hello from server]\n</code></pre> <ul> <li>ligne 5, la r\u00e9ponse re\u00e7ue par le client. Le texte re\u00e7u est celui entre crochets\u00a0; Revenons \u00e0 la fen\u00eatre du serveur pour voir d\u2019autres commandes\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpServer.exe 100\nserver : Serveur g\u00e9n\u00e9rique lanc\u00e9 sur le port 0.0.0.0:100\nserver : Attente d'un client...\nserver : Commandes disponibles : [list, send id [texte], close id, quit]\nuser : server : Client 1-DESKTOP-30FF5FB-51173 connect\u00e9...\nserver : Attente d'un client...\nclient 1 : [hello from client]\nsend 1 [hello from server]\nuser : list\nserver : id=1-name=DESKTOP-30FF5FB-51173\nuser : close 1\nserver : Connexion client 1 ferm\u00e9e...\nuser : quit\nserver : fin du service\n</code></pre> <ul> <li>ligne 9, nous demandons la liste des clients\u00a0;</li> <li>ligne 10, la r\u00e9ponse\u00a0;</li> <li>ligne 11, nous fermons la connexion avec le client n\u00b0 1\u00a0;</li> <li>ligne 12, la confirmation du serveur\u00a0;</li> <li>ligne 13, nous arr\u00eatons le serveur\u00a0;</li> <li>ligne 14, la confirmation du serveur\u00a0; Revenons \u00e0 la fen\u00eatre du client\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpClient.exe localhost 100\nClient [DESKTOP-30FF5FB:51173] connect\u00e9 au serveur [localhost-100]\nTapez vos commandes (quit pour arr\u00eater) :\nhello from client\n&lt;-- [hello from server]\nPerte de la connexion avec le serveur...\n</code></pre> <ul> <li>ligne 6, le client a d\u00e9tect\u00e9 la fin du service\u00a0; Deux fichiers de logs ont \u00e9t\u00e9 cr\u00e9\u00e9s, un pour le serveur, un autre pour le client\u00a0:</li> </ul> <p></p> <ul> <li>en [1], les logs du serveur\u00a0: le nom du fichier est le nom du client sous la forme [machine-port]. Cela permet d\u2019avoir des fichiers de logs diff\u00e9rents pour des clients diff\u00e9rents\u00a0;</li> <li>en [2], les logs du client\u00a0: le nom du fichier est le nom du serveur sous la forme [machine-port]\u00a0; Les logs du serveur sont les suivants\u00a0:</li> </ul> <pre><code>&lt;-- [hello from client]\n--&gt; [hello from server]\n</code></pre> <p>Les logs du client sont les suivants\u00a0:</p> <pre><code>--&gt; [hello from client]\n&lt;-- [hello from server]\n</code></pre>"},{"location":"fonctions-internet.html#213-obtenir-le-nom-ou-ladresse-ip-dune-machine-de-linternet","title":"21.3. Obtenir le nom ou l'adresse IP d'une machine de l'Internet","text":"<p>Les machines de l\u2019internet sont identifi\u00e9es par une adresse IP (IPv4 ou IPv6) et le plus souvent par un nom. Mais finalement seule l\u2019adresse IP est utilis\u00e9e par les protocoles de communication de l\u2019internet. Il faut donc conna\u00eetre l\u2019adresse IP d\u2019une machine identifi\u00e9e par son nom.</p> <p>Le script [ip-01.py] est le suivant\u00a0:</p> <pre><code># imports\nimport socket\n\n\n# ------------------------------------------------\ndef get_ip_and_name(nom_machine: str):\n    # nom_machine : nom de la machine dont on veut l'adresse IP\n    try:\n        # nom_machine--&gt;adresse IP\n        ip = socket.gethostbyname(nom_machine)\n        print(f\"ip[{nom_machine}]={ip}\")\n    except socket.error as erreur:\n        # on affiche l'erreur\n        print(f\"ip[{nom_machine}]={erreur}\")\n        return\n\n    try:\n        # adresse IP --&gt; nom_machine\n        names = socket.gethostbyaddr(ip)\n        print(f\"names[{ip}]={names}\")\n    except socket.error as erreur:\n        # on affiche l'erreur\n        print(f\"names[{ip}]={erreur}\")\n        return\n\n\n# ---------------------------------------- main\n\n# les machines internet\nhosts = [\"istia.univ-angers.fr\", \"www.univ-angers.fr\", \"sergetahe.com\", \"localhost\", \"xx\"]\n\n# adresses IP des machines de HOTES\nfor host in hosts:\n    print(\"-------------------------------------\")\n    get_ip_and_name(host)\n# fin\nprint(\"Termin\u00e9...\")\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 2\u00a0: le module [socket] fournit les fonctions n\u00e9cessaires \u00e0 la gestion des sockets internet. [socket] signifie prise \u00e9lectrique, prise de r\u00e9seau\u00a0;</li> <li>ligne 6\u00a0: la fonction [get_ip_and_name] permet \u00e0 partir du nom internet d'une machine d'obtenir\u00a0:</li> <li>l'adresse IP de la machine\u00a0;</li> <li>le nom de la machine obtenu \u00e0 partir de l'adresse IP pr\u00e9c\u00e9dente\u00a0;</li> <li>ligne 10\u00a0: la fonction [socket.gethostbyname] permet d'obtenir l'adresse IP d'une machine \u00e0 partir d'un de ces noms (une machine internet peut avoir un nom principal et des alias)\u00a0;</li> <li>ligne 12\u00a0: les fonctions sur les sockets lancent l'exception [socket.error] d\u00e8s qu'une erreur survient\u00a0;</li> <li>ligne 19\u00a0: la fonction [socket.gethostbyaddr] permet d'obtenir le nom d'une machine \u00e0 partir de son adresse IP. On va voir qu'on peut obtenir un nom diff\u00e9rent de celui pass\u00e9 ligne 6\u00a0;</li> <li>ligne 30\u00a0: une liste de noms de machines. Le dernier nom est erron\u00e9. Le nom [localhost] d\u00e9signe la machine sur laquelle vous travaillez et qui ex\u00e9cute le script\u00a0;</li> <li>ligne 33-35\u00a0: on affiche les IP de ces machines\u00a0; R\u00e9sultats\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/inet/ip/ip_01.py\n-------------------------------------\nip[istia.univ-angers.fr]=193.49.144.41\nnames[193.49.144.41]=('ametys-fo-2.univ-angers.fr', [], ['193.49.144.41'])\n-------------------------------------\nip[www.univ-angers.fr]=193.49.144.41\nnames[193.49.144.41]=('ametys-fo-2.univ-angers.fr', [], ['193.49.144.41'])\n-------------------------------------\nip[sergetahe.com]=87.98.154.146\nnames[87.98.154.146]=('cluster026.hosting.ovh.net', [], ['87.98.154.146'])\n-------------------------------------\nip[localhost]=127.0.0.1\nnames[127.0.0.1]=('DESKTOP-30FF5FB', [], ['127.0.0.1'])\n-------------------------------------\nip[xx]=[Errno 11001] getaddrinfo failed\nTermin\u00e9...\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"fonctions-internet.html#214-le-protocole-http-hypertext-transfer-protocol","title":"21.4. Le protocole HTTP (HyperText Transfer Protocol)","text":""},{"location":"fonctions-internet.html#2141-exemple-1","title":"21.4.1. Exemple 1","text":"<p>Lorsqu\u2019un navigateur affiche une URL, il est le client d\u2019un serveur web ou dit autrement d\u2019un serveur HTTP. C\u2019est lui qui prend l\u2019initiative et il commence par envoyer un certain nombre de commandes au serveur. Pour ce premier exemple\u00a0:</p> <ul> <li>le serveur sera l\u2019utilitaire [RawTcpServer]\u00a0;</li> <li>le client sera un navigateur\u00a0; Nous lan\u00e7ons d\u2019abord le serveur sur le port 100\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpServer.exe 100\nserver : Serveur g\u00e9n\u00e9rique lanc\u00e9 sur le port 0.0.0.0:100\nserver : Attente d'un client...\nserver : Commandes disponibles : [list, send id [texte], close id, quit]\nuser :\n</code></pre> <p>Puis avec un navigateur, nous demandons l\u2019URL [http://localhost:100], \u00e7-a-d que nous disons que le serveur HTTP interrog\u00e9 travaille sur le port 100 de la machine locale\u00a0:</p> <p></p> <p>Revenons sur la fen\u00eatre du serveur\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpServer.exe 100\nserver : Serveur g\u00e9n\u00e9rique lanc\u00e9 sur le port 0.0.0.0:100\nserver : Attente d'un client...\nserver : Commandes disponibles : [list, send id [texte], close id, quit]\nuser : server : Client 1-DESKTOP-30FF5FB-51438 connect\u00e9...\nserver : Attente d'un client...\nserver : Client 2-DESKTOP-30FF5FB-51439 connect\u00e9...\nserver : Attente d'un client...\nclient 1 : [GET / HTTP/1.1]\nclient 1 : [Host: localhost:100]\nclient 1 : [Connection: keep-alive]\nclient 1 : [DNT: 1]\nclient 1 : [Upgrade-Insecure-Requests: 1]\nclient 1 : [User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36]\nclient 1 : [Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9]\nclient 1 : [Sec-Fetch-Site: none]\nclient 1 : [Sec-Fetch-Mode: navigate]\nclient 1 : [Sec-Fetch-User: ?1]\nclient 1 : [Sec-Fetch-Dest: document]\nclient 1 : [Accept-Encoding: gzip, deflate, br]\nclient 1 : [Accept-Language: fr-FR,fr;q=0.9,en-US;q=0.8,en;q=0.7]\nclient 1 : []\nserver : Client 3-DESKTOP-30FF5FB-51441 connect\u00e9...\nserver : Attente d'un client...\n</code></pre> <ul> <li>ligne 5, le client qui s\u2019est connect\u00e9\u00a0;</li> <li>lignes 9-22\u00a0: la s\u00e9rie de lignes de texte qu\u2019il a envoy\u00e9es\u00a0:</li> <li>ligne 9\u00a0: cette ligne a le format [GET URL HTTP/1.1]. Elle demande l\u2019URL / et demande au serveur d\u2019utiliser le protocole HTTP 1.1\u00a0;</li> <li>ligne 10\u00a0: cette ligne a le format [Host: serveur:port]. La casse de la commande [Host] n\u2019importe pas. On rappelle ici que le client interroge un serveur local op\u00e9rant sur le port 100\u00a0;</li> <li>ligne 14\u00a0: la commande [User-Agent] donne l\u2019identit\u00e9 du client\u00a0;</li> <li>ligne 15\u00a0: la commande [Accept] indique quels types de document sont accept\u00e9s par le client\u00a0;</li> <li>ligne 21\u00a0: la commande [Accept-Language] indique dans quelle langue sont souhait\u00e9s les documents demand\u00e9s s\u2019ils existent en plusieurs langues\u00a0;</li> <li>ligne 11\u00a0: la commande [Connection] indique le mode de connexion souhait\u00e9\u00a0: [keep-alive] indique que la connexion doit \u00eatre maintenue jusqu\u2019\u00e0 ce que les \u00e9changes soient termin\u00e9s\u00a0;</li> <li>ligne 22\u00a0: le client termine ses commandes par une ligne vide\u00a0;  Nous terminons la connexion en terminant le serveur\u00a0:</li> </ul> <pre><code>client 1 : []\nserver : Client 3-DESKTOP-30FF5FB-51441 connect\u00e9...\nserver : Attente d'un client...\nquit\nserver : fin du service\n</code></pre>"},{"location":"fonctions-internet.html#2142-exemple-2","title":"21.4.2. Exemple 2","text":"<p>Maintenant que nous connaissons les commandes envoy\u00e9es par un navigateur pour r\u00e9clamer une URL, nous allons r\u00e9clamer cette URL avec notre client TCP [RawTcpClient]. Le serveur Apache de Laragon (paragraphe |Installation de Laragon|) sera notre serveur web.</p> <p>Lan\u00e7ons Laragon puis le serveur web Apache\u00a0:</p> <p></p> <p></p> <p>Maintenant avec un navigateur, demandons l\u2019URL [http://localhost:80]. Ici nous ne pr\u00e9cisons que le serveur [localhost:80] et pas d\u2019URL de document. Dans ce cas c\u2019est l\u2019URL / qui est demand\u00e9e, \u00e7-\u00e0-d la racine du serveur web\u00a0:</p> <p></p> <ul> <li>en [1], l\u2019URL demand\u00e9e. On a tap\u00e9 initialement [http://localhost:80] et le navigateur (Firefox ici) l\u2019a transform\u00e9e simplement en [localhost] car le protocole [http] est implicite lorsqu\u2019aucun protocole n\u2019est mentionn\u00e9 et le port [80] est implicite lorsque le port n\u2019est pas pr\u00e9cis\u00e9\u00a0;</li> <li>en [2], la page racine / du serveur web interrog\u00e9\u00a0; Maintenant, visualisons le texte re\u00e7u par le navigateur\u00a0:</li> </ul> <p></p> <ul> <li>on clique droit sur la page re\u00e7ue et on choisit l\u2019option [2]. On obtient le code source suivant\u00a0: <pre><code>&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n    &lt;title&gt;Laragon&lt;/title&gt;\n\n    &lt;link href=\"https://fonts.googleapis.com/css?family=Karla:400\" rel=\"stylesheet\" type=\"text/css\"&gt;\n\n    &lt;style&gt;\n        html, body {\n            height: 100%;\n        }\n\n        body {\n            margin: 0;\n            padding: 0;\n            width: 100%;\n            display: table;\n            font-weight: 100;\n            font-family: 'Karla';\n        }\n\n        .container {\n            text-align: center;\n            display: table-cell;\n            vertical-align: middle;\n        }\n\n        .content {\n            text-align: center;\n            display: inline-block;\n        }\n\n        .title {\n            font-size: 96px;\n        }\n\n        .opt {\n            margin-top: 30px;\n        }\n\n            .opt a {\n                text-decoration: none;\n                font-size: 150%;\n            }\n\n        a:hover {\n            color: red;\n        }\n    &lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n    &lt;div class=\"container\"&gt;\n        &lt;div class=\"content\"&gt;\n            &lt;div class=\"title\" title=\"Laragon\"&gt;Laragon&lt;/div&gt;\n\n            &lt;div class=\"info\"&gt;\n                &lt;br /&gt;\n                Apache/2.4.35 (Win64) OpenSSL/1.1.1b PHP/7.2.19&lt;br /&gt;\n                PHP version: 7.2.19   &lt;span&gt;&lt;a title=\"phpinfo()\" href=\"/?q=info\"&gt;info&lt;/a&gt;&lt;/span&gt;&lt;br /&gt;\n                Document Root: C:/MyPrograms/laragon/www&lt;br /&gt;\n\n            &lt;/div&gt;\n            &lt;div class=\"opt\"&gt;\n                &lt;div&gt;&lt;a title=\"Getting Started\" href=\"https://laragon.org/docs\"&gt;Getting Started&lt;/a&gt;&lt;/div&gt;\n            &lt;/div&gt;\n        &lt;/div&gt;\n\n    &lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre></li> </ul> <p>Maintenant demandons l\u2019URL [http://localhost:80] avec notre client TCP\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpClient.exe localhost 80\nClient [DESKTOP-30FF5FB:51541] connect\u00e9 au serveur [localhost-80]\nTapez vos commandes (quit pour arr\u00eater) :\n</code></pre> <ul> <li>ligne 1, nous nous connectons au port 80 du serveur localhost. C\u2019est l\u00e0 qu\u2019op\u00e8re le serveur web de Laragon\u00a0; Nous tapons maintenant les commandes que nous avons d\u00e9couvertes dans le paragraphe pr\u00e9c\u00e9dent\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpClient.exe localhost 80\nClient [DESKTOP-30FF5FB:51544] connect\u00e9 au serveur [localhost-80]\nTapez vos commandes (quit pour arr\u00eater) :\nGET / HTTP/1.1\nHost: localhost:80\n\n&lt;-- [HTTP/1.1 200 OK]\n&lt;-- [Date: Sun, 05 Jul 2020 12:42:14 GMT]\n&lt;-- [Server: Apache/2.4.35 (Win64) OpenSSL/1.1.1b PHP/7.2.19]\n&lt;-- [X-Powered-By: PHP/7.2.19]\n&lt;-- [Content-Length: 1776]\n&lt;-- [Content-Type: text/html; charset=UTF-8]\n&lt;-- []\n&lt;-- [&lt;!DOCTYPE html&gt;]\n&lt;-- [&lt;html&gt;]\n&lt;-- [    &lt;head&gt;]\n&lt;-- [        &lt;title&gt;Laragon&lt;/title&gt;]\n&lt;-- []\n&lt;-- [        &lt;link href=\"https://fonts.googleapis.com/css?family=Karla:400\" rel=\"stylesheet\" type=\"text/css\"&gt;]\n&lt;-- []\n&lt;-- [        &lt;style&gt;]\n&lt;-- [            html, body {]\n&lt;-- [                height: 100%;]\n&lt;-- [            }]\n&lt;-- []\n&lt;-- [            body {]\n&lt;-- [                margin: 0;]\n&lt;-- [                padding: 0;]\n&lt;-- [                width: 100%;]\n&lt;-- [                display: table;]\n&lt;-- [                font-weight: 100;]\n&lt;-- [                font-family: 'Karla';]\n&lt;-- [            }]\n&lt;-- []\n&lt;-- [            .container {]\n&lt;-- [                text-align: center;]\n&lt;-- [                display: table-cell;]\n&lt;-- [                vertical-align: middle;]\n&lt;-- [            }]\n&lt;-- []\n&lt;-- [            .content {]\n&lt;-- [                text-align: center;]\n&lt;-- [                display: inline-block;]\n&lt;-- [            }]\n&lt;-- []\n&lt;-- [            .title {]\n&lt;-- [                font-size: 96px;]\n&lt;-- [            }]\n&lt;-- []\n&lt;-- [            .opt {]\n&lt;-- [                margin-top: 30px;]\n&lt;-- [            }]\n&lt;-- []\n&lt;-- [            .opt a {]\n&lt;-- [              text-decoration: none;]\n&lt;-- [              font-size: 150%;]\n&lt;-- [            }]\n&lt;-- [            ]\n&lt;-- [            a:hover {]\n&lt;-- [              color: red;]\n&lt;-- [            }]\n&lt;-- [        &lt;/style&gt;]\n&lt;-- [    &lt;/head&gt;]\n&lt;-- [    &lt;body&gt;]\n&lt;-- [        &lt;div class=\"container\"&gt;]\n&lt;-- [            &lt;div class=\"content\"&gt;]\n&lt;-- [                &lt;div class=\"title\" title=\"Laragon\"&gt;Laragon&lt;/div&gt;]\n&lt;-- [     ]\n&lt;-- [                &lt;div class=\"info\"&gt;&lt;br /&gt;]\n&lt;-- [                      Apache/2.4.35 (Win64) OpenSSL/1.1.1b PHP/7.2.19&lt;br /&gt;]\n&lt;-- [                      PHP version: 7.2.19   &lt;span&gt;&lt;a title=\"phpinfo()\" href=\"/?q=info\"&gt;info&lt;/a&gt;&lt;/span&gt;&lt;br /&gt;]\n&lt;-- [                      Document Root: C:/MyPrograms/laragon/www&lt;br /&gt;]\n&lt;-- []\n&lt;-- [                &lt;/div&gt;]\n&lt;-- [                &lt;div class=\"opt\"&gt;]\n&lt;-- [                  &lt;div&gt;&lt;a title=\"Getting Started\" href=\"https://laragon.org/docs\"&gt;Getting Started&lt;/a&gt;&lt;/div&gt;]\n&lt;-- [                &lt;/div&gt;]\n&lt;-- [            &lt;/div&gt;]\n&lt;-- []\n&lt;-- [        &lt;/div&gt;]\n&lt;-- [    &lt;/body&gt;]\n&lt;-- [&lt;/html&gt;]\nPerte de la connexion avec le serveur...\n</code></pre> <ul> <li>ligne 4, la commande [GET]. On demande la racine / du serveur web\u00a0;</li> <li>ligne 5, la commande [Host]\u00a0;</li> <li>ce sont les deux seules commandes indispensables. Pour les autres commandes, le serveur web prendra des valeurs par d\u00e9faut\u00a0;</li> <li>ligne 6, la ligne vide qui doit terminer les commandes du client\u00a0;</li> <li>dessous la ligne 6, vient la r\u00e9ponse du serveur web\u00a0;</li> <li>lignes 7-12\u00a0: les ent\u00eates HTTP de la r\u00e9ponse du serveur\u00a0;</li> <li>ligne 13\u00a0: la ligne vide qui signale la fin des ent\u00eates http\u00a0;</li> <li>lignes 14-82, le document HTML demand\u00e9 ligne 4\u00a0; Nous chargeons le fichier de logs [localhost-80.txt]\u00a0:</li> </ul> <p></p> <pre><code>--&gt; [GET / HTTP/1.1]\n--&gt; [Host: localhost:80]\n--&gt; []\n&lt;-- [HTTP/1.1 200 OK]\n&lt;-- [Date: Sun, 05 Jul 2020 12:42:14 GMT]\n&lt;-- [Server: Apache/2.4.35 (Win64) OpenSSL/1.1.1b PHP/7.2.19]\n&lt;-- [X-Powered-By: PHP/7.2.19]\n&lt;-- [Content-Length: 1776]\n&lt;-- [Content-Type: text/html; charset=UTF-8]\n&lt;-- []\n&lt;-- [&lt;!DOCTYPE html&gt;]\n&lt;-- [&lt;html&gt;]\n&lt;-- [    &lt;head&gt;]\n&lt;-- [        &lt;title&gt;Laragon&lt;/title&gt;]\n&lt;-- []\n&lt;-- [        &lt;link href=\"https://fonts.googleapis.com/css?family=Karla:400\" rel=\"stylesheet\" type=\"text/css\"&gt;]\n&lt;-- []\n&lt;-- [        &lt;style&gt;]\n&lt;-- [            html, body {]\n&lt;-- [                height: 100%;]\n&lt;-- [            }]\n&lt;-- []\n&lt;-- [            body {]\n&lt;-- [                margin: 0;]\n&lt;-- [                padding: 0;]\n&lt;-- [                width: 100%;]\n&lt;-- [                display: table;]\n&lt;-- [                font-weight: 100;]\n&lt;-- [                font-family: 'Karla';]\n&lt;-- [            }]\n&lt;-- []\n&lt;-- [            .container {]\n&lt;-- [                text-align: center;]\n&lt;-- [                display: table-cell;]\n&lt;-- [                vertical-align: middle;]\n&lt;-- [            }]\n&lt;-- []\n&lt;-- [            .content {]\n&lt;-- [                text-align: center;]\n&lt;-- [                display: inline-block;]\n&lt;-- [            }]\n&lt;-- []\n&lt;-- [            .title {]\n&lt;-- [                font-size: 96px;]\n&lt;-- [            }]\n&lt;-- []\n&lt;-- [            .opt {]\n&lt;-- [                margin-top: 30px;]\n&lt;-- [            }]\n&lt;-- []\n&lt;-- [            .opt a {]\n&lt;-- [              text-decoration: none;]\n&lt;-- [              font-size: 150%;]\n&lt;-- [            }]\n&lt;-- [            ]\n&lt;-- [            a:hover {]\n&lt;-- [              color: red;]\n&lt;-- [            }]\n&lt;-- [        &lt;/style&gt;]\n&lt;-- [    &lt;/head&gt;]\n&lt;-- [    &lt;body&gt;]\n&lt;-- [        &lt;div class=\"container\"&gt;]\n&lt;-- [            &lt;div class=\"content\"&gt;]\n&lt;-- [                &lt;div class=\"title\" title=\"Laragon\"&gt;Laragon&lt;/div&gt;]\n&lt;-- [     ]\n&lt;-- [                &lt;div class=\"info\"&gt;&lt;br /&gt;]\n&lt;-- [                      Apache/2.4.35 (Win64) OpenSSL/1.1.1b PHP/7.2.19&lt;br /&gt;]\n&lt;-- [                      PHP version: 7.2.19   &lt;span&gt;&lt;a title=\"phpinfo()\" href=\"/?q=info\"&gt;info&lt;/a&gt;&lt;/span&gt;&lt;br /&gt;]\n&lt;-- [                      Document Root: C:/MyPrograms/laragon/www&lt;br /&gt;]\n&lt;-- []\n&lt;-- [                &lt;/div&gt;]\n&lt;-- [                &lt;div class=\"opt\"&gt;]\n&lt;-- [                  &lt;div&gt;&lt;a title=\"Getting Started\" href=\"https://laragon.org/docs\"&gt;Getting Started&lt;/a&gt;&lt;/div&gt;]\n&lt;-- [                &lt;/div&gt;]\n&lt;-- [            &lt;/div&gt;]\n&lt;-- []\n&lt;-- [        &lt;/div&gt;]\n&lt;-- [    &lt;/body&gt;]\n&lt;-- [&lt;/html&gt;]\n</code></pre> <ul> <li>lignes 11-79\u00a0: le document HTML re\u00e7u. Dans l\u2019exemple pr\u00e9c\u00e9dent, Firefox avait re\u00e7u le m\u00eame\u00a0; Nous avons d\u00e9sormais les bases pour programmer un client TCP qui demanderait une URL.</li> </ul>"},{"location":"fonctions-internet.html#2143-exemple-3","title":"21.4.3. Exemple 3","text":"<p>Le script [http/01/main.py] est un client HTTP configur\u00e9 par le fichier [config.py]. Le contenu de celui-ci est le suivant\u00a0:</p> <pre><code>def configure():\n    # URLs \u00e0 interroger\n    urls = [\n        # site : nom du site auquel se connecter\n        # port : port du service web\n        # GET : URL demand\u00e9e\n        # headers : ent\u00eates HTTP \u00e0 envoyer dans la requ\u00eate\n        # endOfLine : marque de fin de ligne dans les ent\u00eates HTTP envoy\u00e9s\n        # encoding : encodage de la r\u00e9ponse du serveur\n        # timeout : temps d'attente maximum d'une r\u00e9ponse du serveur\n        {\n            \"site\": \"localhost\",\n            \"port\": 80,\n            \"GET\": \"/\",\n            \"headers\": {\n                \"Host\": \"localhost:80\",\n                \"User-Agent\": \"client Python\",\n                \"Accept\": \"text/HTML\",\n                \"Accept-Language\": \"fr\"\n            },\n            \"endOfLine\": \"\\r\\n\",\n            \"encoding\": \"utf-8\",\n            \"timeout\": 0.5\n        },\n        {\n            \"site\": \"sergetahe.com\",\n            \"port\": 80,\n            \"GET\": \"/\",\n            \"headers\": {\n                \"Host\": \"sergetahe.com:80\",\n                \"User-Agent\": \"client Python\",\n                \"Accept\": \"text/HTML\",\n                \"Accept-Language\": \"fr\"\n            },\n            \"endOfLine\": \"\\r\\n\",\n            \"encoding\": \"utf-8\",\n            \"timeout\": 5\n        },\n        {\n            \"site\": \"tahe.developpez.com\",\n            \"port\": 443,\n            \"GET\": \"/\",\n            \"headers\": {\n                \"Host\": \"tahe.developpez.com:443\",\n                \"User-Agent\": \"client Python\",\n                \"Accept\": \"text/HTML\",\n                \"Accept-Language\": \"fr\"\n            },\n            \"endOfLine\": \"\\r\\n\",\n            \"encoding\": \"utf-8\",\n            \"timeout\": 2\n        },\n        {\n            \"site\": \"www.sergetahe.com\",\n            \"port\": 80,\n            \"GET\": \"/cours-tutoriels-de-programmation/\",\n            \"headers\": {\n                \"Host\": \"sergetahe.com:80\",\n                \"User-Agent\": \"client Python\",\n                \"Accept\": \"text/HTML\",\n                \"Accept-Language\": \"fr\"\n            },\n            \"endOfLine\": \"\\r\\n\",\n            \"encoding\": \"utf-8\",\n            \"timeout\": 5\n        }\n    ]\n    # on rend la configuration\n    return {\n        \"urls\": urls\n    }\n</code></pre> <ul> <li>le contenu du fichier est une liste d\u2019URL, chaque \u00e9l\u00e9ment de la liste \u00e9tant un dictionnaire. Ce dictionnaire indique comment se connecter au sit\u00e9 d\u00e9sign\u00e9 par la cl\u00e9 [site]\u00a0;</li> <li>lignes 4-10\u00a0: la signification des cl\u00e9s de chaque dictionnaire\u00a0; Le script [http/01/main.py] est le suivant\u00a0:</li> </ul> <pre><code># imports\nimport codecs\nimport socket\n\n\n# -----------------------------------------------------------------------\ndef get_url(url: dict, suivi: bool = True):\n    # lit l'URL url[\"GET\"] du site url[site] et la stocke dans le fichier url[site].html\n    # le dialogue client /serveur se fait selon le protocole HTTP indiqu\u00e9 dans le dictionnaire [url]\n    # on laisse remonter les exceptions\n\n    sock = None\n    html = None\n    try:\n        # connexion \u00e0 [site] sur le port 80 avec un timeout\n        site = url['site']\n        sock = socket.create_connection((site, int(url['port'])), float(url['timeout']))\n\n        # connexion repr\u00e9sente un flux de communication bidirectionnel\n        # entre le client (ce programme) et le serveur web contact\u00e9\n        # ce canal est utilis\u00e9 pour les \u00e9changes de commandes et d'informations\n        # le protocole de dialogue est HTTP\n\n        # cr\u00e9ation du fichier site.html - on change les caract\u00e8res g\u00eanants pour un nom de fichier\n        site2 = site.replace(\"/\", \"_\")\n        site2 = site2.replace(\".\", \"_\")\n        html_filename = f'{site2}.html'\n        html = codecs.open(f\"output/{html_filename}\", \"w\", \"utf-8\")\n\n        # le client va commencer le dialogue HTTP avec le serveur\n        if suivi:\n            print(f\"Client : d\u00e9but de la communication avec le serveur [{site}]\")\n\n        # selon les serveurs, les lignes du client doivent se terminer par \\n ou \\r\\n\n        end_of_line = url[\"endOfLine\"]\n        # le client envoie la commande GET pour demander l'URL config[\"GET\"]\n        # syntaxe GET URL HTTP/1.1\n        commande = f\"GET {url['GET']} HTTP/1.1{end_of_line}\"\n        # suivi ?\n        if suivi:\n            print(f\"--&gt; {commande}\", end='')\n        # on envoie la commande au serveur\n        sock.send(bytearray(commande, 'utf-8'))\n        # \u00e9mission des ent\u00eates HTTP\n        for verb, value in url['headers'].items():\n            # on construit la commande \u00e0 envoyer\n            commande = f\"{verb}: {value}{end_of_line}\"\n            # suivi ?\n            if suivi:\n                print(f\"--&gt; {commande}\", end='')\n            # on envoie la commande au serveur\n            sock.send(bytearray(commande, 'utf-8'))\n        # on envoie l'ent\u00eate HTTP [Connection: close] pour demander au serveur web\n        # de fermer la connexion lorsqu'il aura envoy\u00e9 le document demand\u00e9\n        sock.send(bytearray(f\"Connection: close{end_of_line}\", 'utf-8'))\n        # les ent\u00eates (headers) du protocole HTTP doivent se terminer par une ligne vide\n        sock.send(bytearray(end_of_line, 'utf-8'))\n        #\n        # le serveur va maintenant r\u00e9pondre sur le canal sock. Il va envoyer toutes\n        # ses donn\u00e9es puis fermer le canal. Le client lit donc tout ce qui arrive de sock\n        # jusqu'\u00e0 la fermeture du canal\n        #\n        # on lit tout d'abord les ent\u00eates HTTP envoy\u00e9s par le serveur\n        # ils se terminent eux-aussi par une ligne vide\n        if suivi:\n            print(f\"R\u00e9ponse du serveur [{site}]\")\n\n        # lecture de la socket comme si elle \u00e9tait un fichier texte\n        encoding = f\"{url['encoding']}\" if url['encoding'] else None\n        if encoding:\n            file = sock.makefile(encoding=encoding)\n        else:\n            file = sock.makefile()\n        # on exploite ce fichier ligne par ligne\n        fini = False\n        while not fini:\n            # lecture ligne courante\n            ligne = file.readline().strip()\n            # a-t-on une ligne non vide ?\n            if ligne:\n                if suivi:\n                    # on affiche l'ent\u00eate HTTP\n                    print(f\"&lt;-- {ligne}\")\n            else:\n                # c'\u00e9tait la ligne vide - les ent\u00eates HTTP sont termin\u00e9s\n                fini = True\n        # on lit le document HTML qui va suivre la ligne vide\n        # lecture ligne courante\n        ligne = file.readline()\n        while ligne:\n            # enregistrement dans le fichier de logs\n            html.write(str(ligne))\n            # ligne suivante\n            ligne = file.readline()\n            # la boucle se finit lorsque le serveur ferme la connexion\n    finally:\n        # le client ferme la connexion\n        if sock:\n            sock.close()\n        # fermeture du fichier html\n        if html:\n            html.close()\n\n\n# -------------------main\n\n# on configure l'application\nimport config\nconfig = config.configure()\n\n# obtenir les URL du fichier de configuration\nfor url in config['urls']:\n    print(\"-------------------------\")\n    print(url['site'])\n    print(\"-------------------------\")\n    try:\n        # lecture URL du site [site]\n        get_url(url)\n    except BaseException as erreur:\n        print(f\"L'erreur suivante s'est produite : {erreur}\")\n    finally:\n        pass\n# fin\nprint(\"Termin\u00e9...\")\n</code></pre> <p>Commentaires du code\u00a0:</p> <ul> <li>lignes 108-109\u00a0: le dictionnaire [config] du module [config.py] est r\u00e9cup\u00e9r\u00e9\u00a0;</li> <li>ligne 111-122\u00a0: ce dictionnaire est exploit\u00e9\u00a0;</li> <li>ligne 118, 7\u00a0: la fonction [get_url(url)] demande un document du site web url[site] et le stocke dans le fichier texte url[site].HTML. Par d\u00e9faut, les \u00e9changes client/serveur sont logu\u00e9s sur la console (suivi=True)\u00a0;</li> <li>on fait tout dans un [try / finally] (lignes 14-96). Il n'y a pas de clause [except]. Les exceptions vont remonter au code appelant et c'est celui-ci qui les arr\u00eate et les affiche\u00a0(lignes 119-120)\u00a0;</li> <li>lignes 16-17\u00a0: ouverture d'une connexion vers le serveur web. La fonction [socket.create_connection] admet trois param\u00e8tres\u00a0:</li> <li>[param1]\u00a0: est le nom de la machine de l'internet qu'on veut atteindre\u00a0;</li> <li>[param2]\u00a0: est le n\u00b0 du port du service auquel on veut se connecter\u00a0;</li> <li>[param3]\u00a0: [socket.create_connection] rend un socket et [param3], s'il est pr\u00e9sent, d\u00e9signe le timeout du socket cr\u00e9\u00e9. Le timeout est le d\u00e9lai maximal d'attente du socket lorsqu'il attend une r\u00e9ponse de la machine distante\u00a0;</li> <li>lignes 27-28\u00a0: cr\u00e9ation du fichier [site.html] dans lequel on stockera le document HTML re\u00e7u\u00a0;</li> <li>lignes 34-43\u00a0: la premi\u00e8re commande du client doit \u00eatre la commande [GET URL HTTP/1.1]\u00a0;</li> <li>ligne 43\u00a0: la fonction [sock.send] permet au client d'envoyer des donn\u00e9es au serveur. Ici la ligne de texte envoy\u00e9e a la signification suivante\u00a0: \"Je veux (GET) la page [URL] du site web auquel je suis connect\u00e9. Je travaille avec le protocole HTTP version 1.1\"\u00a0;</li> <li>ligne 43\u00a0: l'instruction [sock.send(bytearray(commande, 'utf-8'))] envoie un tableau d'octets octets (bytearray). Ce tableau est obtenu par conversion de la cha\u00eene [commande] en une suite d'octets\u00a0cod\u00e9s en UTF-8\u00a0;</li> <li>lignes 44-52\u00a0: on envoie les autres lignes du protocole HTTP [Host, User-Agent, Accept, Accept-Language\u2026]. Leur ordre n\u2019importe pas\u00a0;</li> <li>lignes 53-55\u00a0: on envoie l'ent\u00eate HTTP [Connection: close] pour demander au serveur de fermer sa connexion lorsqu'il aura envoy\u00e9 le document demand\u00e9. Par d\u00e9faut il ne le fait pas. Il faut donc le lui demander explicitement. L'int\u00e9r\u00eat est que cette fermeture va \u00eatre d\u00e9tect\u00e9e c\u00f4t\u00e9 client et c'est comme cela que celui-ci saura qu'il aura re\u00e7u tout le document demand\u00e9\u00a0;</li> <li>lignes 56-57\u00a0: on envoie une ligne vide au serveur pour signifier que le client a termin\u00e9 d\u2019envoyer ses ent\u00eates HTTP et qu\u2019il attend d\u00e9sormais le document demand\u00e9\u00a0;</li> <li>lignes 68-86\u00a0: le serveur va tout d\u2019abord envoyer une s\u00e9rie d\u2019ent\u00eates HTTP qui vont donner diverses informations sur le document demand\u00e9. Ces ent\u00eates se terminent par une ligne vide\u00a0;</li> <li>lignes 69-73\u00a0: pour pouvoir lire la r\u00e9ponse du serveur, ligne par ligne, on utilise la m\u00e9thode [sock.makefile(encoding=encoding)]. Le param\u00e8tre facultatif [encoding] pr\u00e9cise l'encodage du texte attendu. Apr\u00e8s cette op\u00e9ration, le flux de lignes envoy\u00e9es par le serveur va pouvoir \u00eatre lu comme un fichiet texte classique\u00a0;</li> <li>ligne 78\u00a0: on lit une ligne envoy\u00e9e par le serveur avec la m\u00e9thode [readline]. On la d\u00e9barrasse de ses espaces (blancs, marque de fin de ligne) de d\u00e9but et fin de ligne\u00a0;</li> <li>lignes 81-83\u00a0: si la ligne n'est pas vide et que le suivi a \u00e9t\u00e9 demand\u00e9, la ligne re\u00e7ue est affich\u00e9e sur la console\u00a0;</li> <li>lignes 84-86\u00a0: si on a r\u00e9cup\u00e9r\u00e9 la ligne vide qui marque la fin des ent\u00eates HTTP envoy\u00e9s par le serveur alors on arr\u00eate la boucle\u00a0de la ligne 76\u00a0;</li> <li>lignes 90-95\u00a0: les lignes de texte de la r\u00e9ponse du serveur peuvent \u00eatre lues ligne par ligne avec une boucle while et enregistr\u00e9es dans le fichier texte [html]. Lorsque le serveur web a envoy\u00e9 la totalit\u00e9 de la page qu'on lui a demand\u00e9e, il ferme sa connexion avec le client. C\u00f4t\u00e9 client, cela sera d\u00e9tect\u00e9 comme une fin de fichier et on sortira de la boucle des lignes 90-95\u00a0;</li> <li>lignes 96-102\u00a0: erreur ou pas, on lib\u00e8re toutes les ressources utilis\u00e9es par le code\u00a0; R\u00e9sultats\u00a0:</li> </ul> <p>La console affiche les logs suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/inet/http/01/main.py\n-------------------------\nlocalhost\n-------------------------\nClient : d\u00e9but de la communication avec le serveur [localhost]\n--&gt; GET / HTTP/1.1\n--&gt; Host: localhost:80\n--&gt; User-Agent: client Python\n--&gt; Accept: text/HTML\n--&gt; Accept-Language: fr\nR\u00e9ponse du serveur [localhost]\n&lt;-- HTTP/1.1 200 OK\n&lt;-- Date: Sun, 05 Jul 2020 16:27:46 GMT\n&lt;-- Server: Apache/2.4.35 (Win64) OpenSSL/1.1.1b PHP/7.2.19\n&lt;-- X-Powered-By: PHP/7.2.19\n&lt;-- Content-Length: 1776\n&lt;-- Connection: close\n&lt;-- Content-Type: text/html; charset=UTF-8\n-------------------------\nsergetahe.com\n-------------------------\nClient : d\u00e9but de la communication avec le serveur [sergetahe.com]\n--&gt; GET / HTTP/1.1\n--&gt; Host: sergetahe.com:80\n--&gt; User-Agent: client Python\n--&gt; Accept: text/HTML\n--&gt; Accept-Language: fr\nR\u00e9ponse du serveur [sergetahe.com]\n&lt;-- HTTP/1.1 302 Found\n&lt;-- Date: Sun, 05 Jul 2020 16:27:45 GMT\n&lt;-- Content-Type: text/html; charset=UTF-8\n&lt;-- Transfer-Encoding: chunked\n&lt;-- Connection: close\n&lt;-- Server: Apache\n&lt;-- X-Powered-By: PHP/7.3\n&lt;-- Location: http://sergetahe.com:80/cours-tutoriels-de-programmation\n&lt;-- Set-Cookie: SERVERID68971=2620178|XwH/h|XwH/h; path=/\n&lt;-- X-IPLB-Instance: 17106\n-------------------------\ntahe.developpez.com\n-------------------------\nClient : d\u00e9but de la communication avec le serveur [tahe.developpez.com]\n--&gt; GET / HTTP/1.1\n--&gt; Host: tahe.developpez.com:443\n--&gt; User-Agent: client Python\n--&gt; Accept: text/HTML\n--&gt; Accept-Language: fr\nR\u00e9ponse du serveur [tahe.developpez.com]\n&lt;-- HTTP/1.1 400 Bad Request\n&lt;-- Date: Sun, 05 Jul 2020 16:27:45 GMT\n&lt;-- Server: Apache/2.4.38 (Debian)\n&lt;-- Content-Length: 453\n&lt;-- Connection: close\n&lt;-- Content-Type: text/html; charset=iso-8859-1\n-------------------------\nwww.sergetahe.com\n-------------------------\nClient : d\u00e9but de la communication avec le serveur [www.sergetahe.com]\n--&gt; GET /cours-tutoriels-de-programmation/ HTTP/1.1\n--&gt; Host: sergetahe.com:80\n--&gt; User-Agent: client Python\n--&gt; Accept: text/HTML\n--&gt; Accept-Language: fr\nR\u00e9ponse du serveur [www.sergetahe.com]\n&lt;-- HTTP/1.1 301 Moved Permanently\n&lt;-- Date: Sun, 05 Jul 2020 16:27:45 GMT\n&lt;-- Content-Type: text/html; charset=iso-8859-1\n&lt;-- Content-Length: 263\n&lt;-- Connection: close\n&lt;-- Server: Apache\n&lt;-- Location: https://sergetahe.com/cours-tutoriels-de-programmation/\n&lt;-- Set-Cookie: SERVERID68971=2620178|XwH/h|XwH/h; path=/\n&lt;-- X-IPLB-Instance: 17095\nTermin\u00e9...\n\nProcess finished with exit code 0\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 12\u00a0: l'URL [http://localhost/] a \u00e9t\u00e9 trouv\u00e9e (code 200)\u00a0;</li> <li>ligne 29\u00a0: l'URL [http://sergetahe.com/] n'a pas \u00e9t\u00e9 trouv\u00e9e (code 302). Le code 302 signifie que la page demand\u00e9e a chang\u00e9 d'URL. La nouvelle URL est indiqu\u00e9e par l'ent\u00eate HTTP [Location] de la ligne 36\u00a0;</li> <li>ligne 49\u00a0: la requ\u00eate qui a \u00e9t\u00e9 faite au serveur [http://tahe.developpez.com] est incorrecte (code 400)\u00a0;</li> <li>ligne 65\u00a0: l'URL [http://www.sergetahe.com/] n'a pas \u00e9t\u00e9 trouv\u00e9e (code 301). Le code 301 signifie que la page demand\u00e9e a chang\u00e9 d'URL et ce de fa\u00e7on d\u00e9finitive. La nouvelle URL est indiqu\u00e9e par l'ent\u00eate HTTP [Location] de la ligne 71\u00a0; De fa\u00e7on g\u00e9n\u00e9rale les codes 3xx, 4xx et 5xx d\u2019un serveur HTTP sont des codes d\u2019erreur.</li> </ul> <p>L'ex\u00e9cution a produit fichiers\u00a0:</p> <p></p> <p>Le fichier [output/localhost.HTML] re\u00e7u est le suivant\u00a0:</p> <pre><code>&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n    &lt;head&gt;\n        &lt;title&gt;Laragon&lt;/title&gt;\n\n        &lt;link href=\"https://fonts.googleapis.com/css?family=Karla:400\" rel=\"stylesheet\" type=\"text/css\"&gt;\n\n        &lt;style&gt;\n            html, body {\n                height: 100%;\n            }\n\n            body {\n                margin: 0;\n                padding: 0;\n                width: 100%;\n                display: table;\n                font-weight: 100;\n                font-family: 'Karla';\n            }\n\n            .container {\n                text-align: center;\n                display: table-cell;\n                vertical-align: middle;\n            }\n\n            .content {\n                text-align: center;\n                display: inline-block;\n            }\n\n            .title {\n                font-size: 96px;\n            }\n\n            .opt {\n                margin-top: 30px;\n            }\n\n            .opt a {\n              text-decoration: none;\n              font-size: 150%;\n            }\n\n            a:hover {\n              color: red;\n            }\n        &lt;/style&gt;\n    &lt;/head&gt;\n    &lt;body&gt;\n        &lt;div class=\"container\"&gt;\n            &lt;div class=\"content\"&gt;\n                &lt;div class=\"title\" title=\"Laragon\"&gt;Laragon&lt;/div&gt;\n\n                &lt;div class=\"info\"&gt;&lt;br /&gt;\n                      Apache/2.4.35 (Win64) OpenSSL/1.1.1b PHP/7.2.19&lt;br /&gt;\n                      PHP version: 7.2.19   &lt;span&gt;&lt;a title=\"phpinfo()\" href=\"/?q=info\"&gt;info&lt;/a&gt;&lt;/span&gt;&lt;br /&gt;\n                      Document Root: C:/MyPrograms/laragon/www&lt;br /&gt;\n\n                &lt;/div&gt;\n                &lt;div class=\"opt\"&gt;\n                  &lt;div&gt;&lt;a title=\"Getting Started\" href=\"https://laragon.org/docs\"&gt;Getting Started&lt;/a&gt;&lt;/div&gt;\n                &lt;/div&gt;\n            &lt;/div&gt;\n\n        &lt;/div&gt;\n    &lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>Nous avons bien obtenu le m\u00eame document qu\u2019avec le navigateur Firefox.</p> <p>Le document [output/sergetahe_com.html] re\u00e7u est le suivant\u00a0:</p> <p></p> <p>La plupart des serveurs http envoient par morceaux leurs r\u00e9ponses aux requ\u00eates qui leur sont faites. Chaque morceau envoy\u00e9 est pr\u00e9c\u00e9d\u00e9 d'une ligne indiquant le nombre d'octets du morceau qui suit. Cela permet au client de lire ce nombre exact d'octets pour avoir le morceau. Ici le 0 indique que le morceau qui suit a z\u00e9ro octet. On rappelle que le serveur avait indiqu\u00e9 le document [http://sergetahe.com/] avait chang\u00e9 d'URL. Il n'a donc pas envoy\u00e9 de document.</p> <p>Le document [output/tahe_developpez_com.html] est le suivant\u00a0:</p> <pre><code>&lt;!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\"&gt;\n&lt;html&gt;&lt;head&gt;\n&lt;title&gt;400 Bad Request&lt;/title&gt;\n&lt;/head&gt;&lt;body&gt;\n&lt;h1&gt;Bad Request&lt;/h1&gt;\n&lt;p&gt;Your browser sent a request that this server could not understand.&lt;br /&gt;\nReason: You're speaking plain HTTP to an SSL-enabled server port.&lt;br /&gt;\n Instead use the HTTPS scheme to access this URL, please.&lt;br /&gt;\n&lt;/p&gt;\n&lt;hr&gt;\n&lt;address&gt;Apache/2.4.38 (Debian) Server at 2eurocents.developpez.com Port 80&lt;/address&gt;\n&lt;/body&gt;&lt;/html&gt;\n</code></pre> <ul> <li>lignes 1-12\u00a0: le serveur a envoy\u00e9 un document HTML malgr\u00e9 le fait que la requ\u00eate \u00e9tait incorrecte (ligne 49 des r\u00e9sultats). Le document HTML permet au serveur de pr\u00e9ciser la cause de l\u2019erreur. Celle-ci est indiqu\u00e9e aux lignes 6 et 7\u00a0:</li> <li>ligne 7\u00a0: notre client a utilis\u00e9 le protocole HTTP\u00a0;</li> <li>ligne 8\u00a0: le serveur travaille avec le protocole HTTPS (S=s\u00e9curis\u00e9) et n\u2019accepte pas le protocole HTTP\u00a0; Le document [output/www_sergetahe_com.html] est le suivant\u00a0:</li> </ul> <pre><code>&lt;!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\"&gt;\n&lt;html&gt;&lt;head&gt;\n&lt;title&gt;301 Moved Permanently&lt;/title&gt;\n&lt;/head&gt;&lt;body&gt;\n&lt;h1&gt;Moved Permanently&lt;/h1&gt;\n&lt;p&gt;The document has moved &lt;a href=\"https://sergetahe.com/cours-tutoriels-de-programmation/\"&gt;here&lt;/a&gt;.&lt;/p&gt;\n&lt;/body&gt;&lt;/html&gt;\n</code></pre> <p>L\u00e0 \u00e9galement, il s\u2019est produit une erreur (ligne 3). N\u00e9anmoins, le serveur prend soin d\u2019envoyer un document HTML d\u00e9taillant celle-ci (lignes 1-7).</p>"},{"location":"fonctions-internet.html#2144-exemple-4","title":"21.4.4. Exemple 4","text":"<p>Les exemples pr\u00e9c\u00e9dents nous ont montr\u00e9 que notre client HTTP \u00e9tait insuffisant. Nous allons maintenant pr\u00e9senter un outil appel\u00e9 [curl] qui permet de r\u00e9cup\u00e9rer des documents web en g\u00e9rant les difficult\u00e9s mentionn\u00e9es\u00a0: protocole HTTPS, document envoy\u00e9 par morceaux, redirections\u2026 L\u2019outil [curl] a \u00e9t\u00e9 install\u00e9 avec Laragon\u00a0:</p> <p></p> <p>Ouvrons un terminal PyCharm [1]\u00a0:</p> <p></p> <ul> <li>en [1], l\u2019acc\u00e8s aux terminaux de PyCharm\u00a0;</li> <li>en [2-3], les terminaux d\u00e9j\u00e0 actifs\u00a0;</li> <li>en [4], le dossier dans lequel vous \u00eates. Dans ce qui suit il n\u2019importe pas\u00a0; Dans le terminal nous tapons la commande suivante\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;curl --help\nUsage: curl [options...] &lt;url&gt;\n     --abstract-unix-socket &lt;path&gt; Connect via abstract Unix domain socket\n     --anyauth       Pick any authentication method\n -a, --append        Append to target file when uploading\n     --basic         Use HTTP Basic Authentication\n     --cacert &lt;CA certificate&gt; CA certificate to verify peer against\n\u2026\n</code></pre> <p>Le fait que la commande [curl \u2013help] ait produit des r\u00e9sultats montre que la commande [curl] est dans le PATH du terminal. Sous Windows, le PATH est l\u2019ensemble des dossiers explor\u00e9s lorsque l\u2019utilisateur tape une commande ex\u00e9cutable, ici [curl]. La valeur du PATH peut \u00eatre connue\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;echo %PATH%\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts;C:\\Program Files (x86)\\Common Files\\Oracle\\Java\\javapath;C:\\Program Files\\Python38\\Scripts\\;C:\\Program Files\\Python38\\;C:\\windows\\system32;C:\\windows;C:\\windows\\System32\\Wbem;C:\\windows\\System32\\WindowsPowerShell\\v1.0\\;C:\\windows\\System32\\OpenSSH\\;C:\\Program Files\\Git\\cmd;C:\\Users\\serge\\AppData\\Local\\Microsoft\\WindowsApps;;C:\\Program Files\\JetBrains\\PyCharm Community Edition 2020.1.2\\bin;\n</code></pre> <p>Ligne 2, les dossiers du PATH s\u00e9par\u00e9s par des points-virgules. Dans cette liste n\u2019appara\u00eet pas de dossier li\u00e9 \u00e0 Laragon. Si on enqu\u00eate un peu, on trouve qu\u2019il y a un [curl] dans le dossier [c:\\windows\\system32]. C\u2019est celui-ci qui a r\u00e9pondu auparavant.</p> <p>Si on veut utiliser l\u2019outil [curl] livr\u00e9 avec Laragon, on pourra proc\u00e9der comme suit\u00a0:</p> <p></p> <p></p> <ul> <li>en [2], le terminal Laragon\u00a0;</li> <li>en [3], ce bouton permet de cr\u00e9er de nouveaux terminaux, chacun s\u2019installant dans un onglet de la fen\u00eatre ci-dessus\u00a0;</li> <li>en [4], on demande le PATH du terminal Laragon\u00a0;</li> <li>on obtient quelque chose de tr\u00e8s diff\u00e9rent de ce qui avait \u00e9t\u00e9 obtenu dans un terminal PyCharm. Ce PATH contient de nombreux dossiers cr\u00e9\u00e9s lors de l\u2019installation de Laragon. Le dossier contenant l\u2019outil [curl] en fait partie\u00a0:</li> </ul> <p></p> <p>Par la suite, utilisez le terminal de votre choix. Sachez simplement que lorsque vous voulez utiliser un outil amen\u00e9 par Laragon, le terminal Laragon est \u00e0 pr\u00e9f\u00e9rer.</p> <p>La commande [curl --help] fait afficher toutes les options de configuration de [curl]. Il y en a plusieurs dizaines. Nous en utiliserons tr\u00e8s peu. Pour demander une URL il suffit de taper la commande [curl URL]. Cette commande affichera sur la console le document demand\u00e9. Si on veut de plus les \u00e9changes HTTP entre le client et le serveur on \u00e9crira [curl --verbose URL]. Enfin pour enregistrer le document HTML demand\u00e9 dans un fichier on \u00e9crira [curl --verbose --output fichier URL].</p> <p>Pour \u00e9viter de polluer le syst\u00e8me de fichiers de notre machine, d\u00e9pla\u00e7ons-nous \u00e0 un autre endroit\u00a0(j\u2019utilise ici un terminal Laragon)\u00a0:</p> <pre><code>\u03bb cd \\Temp\\\n\nC:\\Temp\n\u03bb mkdir curl\n\nC:\\Temp\n\u03bb cd curl\\\n\nC:\\Temp\\curl\n\u03bb dir\n Le volume dans le lecteur C s\u2019appelle Local Disk\n Le num\u00e9ro de s\u00e9rie du volume est B84C-D958\n\n R\u00e9pertoire de C:\\Temp\\curl\n\n05/07/2020  19:31    &lt;DIR&gt;          .\n05/07/2020  19:31    &lt;DIR&gt;          ..\n               0 fichier(s)                0 octets\n               2 R\u00e9p(s)  892\u00a0388\u00a0098\u00a0048 octets libres                                          \n</code></pre> <ul> <li>ligne 3, on se d\u00e9place dans le dossier [c:\\temp]. Si ce dossier n\u2019existe pas, vous pouvez le cr\u00e9er ou en choisir un autre\u00a0;</li> <li>ligne 6, on cr\u00e9e un dossier appel\u00e9 [curl]\u00a0;</li> <li>ligne 9, on se positionne dessus\u00a0;</li> <li>ligne 12, on liste son contenu. Il est vide\u00a0(ligne 20); Assurez-vous que le serveur Apache de Laragon est lanc\u00e9 et avec [curl] demandez l\u2019URL [http://localhost/] avec la commande [curl \u2013verbose \u2013output localhost.html http://localhost/]. On obtient les r\u00e9sultats suivants\u00a0:</li> </ul> <pre><code>\u03bb curl --verbose --output localhost.html http://localhost/\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0*   Trying ::1...\n* TCP_NODELAY set\n*   Trying 127.0.0.1...\n* TCP_NODELAY set\n  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0* Connected to localhost (::1) port 80 (#0)\n  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0&gt; GET / HTTP/1.1\n&gt; Host: localhost\n&gt; User-Agent: curl/7.63.0\n&gt; Accept: */*\n&gt;\n&lt; HTTP/1.1 200 OK\n&lt; Date: Sun, 05 Jul 2020 17:35:43 GMT\n&lt; Server: Apache/2.4.35 (Win64) OpenSSL/1.1.1b PHP/7.2.19\n&lt; X-Powered-By: PHP/7.2.19\n&lt; Content-Length: 1776\n&lt; Content-Type: text/html; charset=UTF-8\n&lt;\n{ [1776 bytes data]\n100  1776  100  1776    0     0   1062      0  0:00:01  0:00:01 --:--:--  1062\n* Connection #0 to host localhost left intact\n</code></pre> <ul> <li>lignes 10-13\u00a0: lignes envoy\u00e9es par [curl] au serveur [localhost]. On reconna\u00eet le protocole HTTP\u00a0;</li> <li>lignes 14-20\u00a0: lignes envoy\u00e9es en r\u00e9ponse par le serveur\u00a0;</li> <li>ligne 14\u00a0: indique qu\u2019on a bien eu le document demand\u00e9\u00a0; Le fichier [localhost.html] contient le document demand\u00e9. Vous pouvez le v\u00e9rifier en chargeant le fichier dans un \u00e9diteur de texte.</li> </ul> <p>Maintenant demandons l\u2019URL [https://tahe.developpez.com:443/]. Pour avoir cette URL, le client HTTP doit savoir parler HTTPS. C\u2019est le cas du client [curl].</p> <p>Les r\u00e9sultats console sont les suivants\u00a0:</p> <pre><code>C:\\Temp\\curl\n\u03bb curl --verbose --output tahe.developpez.com.html https://tahe.developpez.com:443/\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0*   Trying 87.98.130.52...\n* TCP_NODELAY set\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0* Connected to tahe.developpez.com (87.98.130.52) port 443 (#0)\n* ALPN, offering h2\n* ALPN, offering http/1.1\n* successfully set certificate verify locations:\n*   CAfile: C:\\MyPrograms\\laragon\\bin\\laragon\\utils\\curl-ca-bundle.crt\n  CApath: none\n} [5 bytes data]\n* TLSv1.3 (OUT), TLS handshake, Client hello (1):\n} [512 bytes data]\n* TLSv1.3 (IN), TLS handshake, Server hello (2):\n{ [122 bytes data]\n* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):\n{ [25 bytes data]\n* TLSv1.3 (IN), TLS handshake, Certificate (11):\n{ [2563 bytes data]\n* TLSv1.3 (IN), TLS handshake, CERT verify (15):\n{ [264 bytes data]\n* TLSv1.3 (IN), TLS handshake, Finished (20):\n{ [52 bytes data]\n* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):\n} [1 bytes data]\n* TLSv1.3 (OUT), TLS handshake, Finished (20):\n} [52 bytes data]\n* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384\n* ALPN, server accepted to use http/1.1\n* Server certificate:\n*  subject: CN=*.developpez.com\n*  start date: Jul  1 15:38:30 2020 GMT\n*  expire date: Sep 29 15:38:30 2020 GMT\n*  subjectAltName: host \"tahe.developpez.com\" matched cert's \"*.developpez.com\"\n*  issuer: C=US; O=Let's Encrypt; CN=Let's Encrypt Authority X3\n*  SSL certificate verify ok.\n} [5 bytes data]\n&gt; GET / HTTP/1.1\n&gt; Host: tahe.developpez.com\n&gt; User-Agent: curl/7.63.0\n&gt; Accept: */*\n&gt;\n{ [5 bytes data]\n* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):\n{ [281 bytes data]\n* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):\n{ [297 bytes data]\n* old SSL session ID is stale, removing\n{ [5 bytes data]\n&lt; HTTP/1.1 200 OK\n&lt; Date: Sun, 05 Jul 2020 17:39:53 GMT\n&lt; Server: Apache/2.4.38 (Debian)\n&lt; X-Powered-By: PHP/5.3.29\n&lt; Vary: Accept-Encoding\n&lt; Transfer-Encoding: chunked\n&lt; Content-Type: text/html\n&lt;\n{ [6 bytes data]\n100   99k    0   99k    0     0  79343      0 --:--:--  0:00:01 --:--:-- 79343\n* Connection #0 to host tahe.developpez.com left intact\n</code></pre> <ul> <li>lignes 10-39\u00a0: les \u00e9changes client / serveur pour s\u00e9curiser la connexion\u00a0: celle-ci sera chiffr\u00e9e\u00a0;</li> <li>lignes 41-44\u00a0: les ent\u00eates HTTP envoy\u00e9s par le client [curl] au serveur\u00a0;</li> <li>ligne 52\u00a0: le document demand\u00e9 a bien \u00e9t\u00e9 trouv\u00e9\u00a0;</li> <li>ligne 57\u00a0: le document est envoy\u00e9 par morceaux\u00a0; [curl] g\u00e8re correctement \u00e0 la fois le protocole s\u00e9curis\u00e9 HTTPS et le fait que le document soit envoy\u00e9 par morceaux. Le document envoy\u00e9 sera trouv\u00e9 ici dans le fichier [tahe.developpez.com.html].</li> </ul> <p>Demandons maintenant l\u2019URL [http://sergetahe.com/cours-tutoriels-de-programmation]. Nous avions vu que pour cette URL, il y avait une redirection vers l\u2019URL [http://sergetahe.com/cours-tutoriels-de-programmation/] (avec un / \u00e0 la fin).</p> <p>Les r\u00e9sultats console sont alors les suivants\u00a0:</p> <pre><code>C:\\Temp\\curl\n\u03bb curl --verbose --output sergetahe.com.html --location http://sergetahe.com/cours-tutoriels-de-programmation\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0*   Trying 87.98.154.146...\n* TCP_NODELAY set\n* Connected to sergetahe.com (87.98.154.146) port 80 (#0)\n&gt; GET /cours-tutoriels-de-programmation HTTP/1.1\n&gt; Host: sergetahe.com\n&gt; User-Agent: curl/7.63.0\n&gt; Accept: */*\n&gt;\n&lt; HTTP/1.1 301 Moved Permanently\n&lt; Date: Sun, 05 Jul 2020 17:44:17 GMT\n&lt; Content-Type: text/html; charset=iso-8859-1\n&lt; Content-Length: 262\n&lt; Server: Apache\n&lt; Location: http://sergetahe.com/cours-tutoriels-de-programmation/\n&lt; Set-Cookie: SERVERID68971=2620178|XwIRd|XwIRd; path=/\n&lt; X-IPLB-Instance: 17095\n&lt;\n* Ignoring the response-body\n{ [262 bytes data]\n100   262  100   262    0     0   1858      0 --:--:-- --:--:-- --:--:--  1858\n* Connection #0 to host sergetahe.com left intact\n* Issue another request to this URL: 'http://sergetahe.com/cours-tutoriels-de-programmation/'\n* Found bundle for host sergetahe.com: 0x14385f8 [can pipeline]\n* Could pipeline, but not asked to!\n* Re-using existing connection! (#0) with host sergetahe.com\n* Connected to sergetahe.com (87.98.154.146) port 80 (#0)\n&gt; GET /cours-tutoriels-de-programmation/ HTTP/1.1\n&gt; Host: sergetahe.com\n&gt; User-Agent: curl/7.63.0\n&gt; Accept: */*\n&gt;\n&lt; HTTP/1.1 301 Moved Permanently\n&lt; Date: Sun, 05 Jul 2020 17:44:17 GMT\n&lt; Content-Type: text/html; charset=iso-8859-1\n&lt; Content-Length: 263\n&lt; Server: Apache\n&lt; Location: https://sergetahe.com/cours-tutoriels-de-programmation/\n&lt; Set-Cookie: SERVERID68971=2620178|XwIRd|XwIRd; path=/\n&lt; X-IPLB-Instance: 17095\n&lt;\n* Ignoring the response-body\n{ [263 bytes data]\n100   263  100   263    0     0    764      0 --:--:-- --:--:-- --:--:--   764\n* Connection #0 to host sergetahe.com left intact\n* Issue another request to this URL: 'https://sergetahe.com/cours-tutoriels-de-programmation/'\n*   Trying 87.98.154.146...\n* TCP_NODELAY set\n* Connected to sergetahe.com (87.98.154.146) port 443 (#1)\n* ALPN, offering h2\n* ALPN, offering http/1.1\n* successfully set certificate verify locations:\n*   CAfile: C:\\MyPrograms\\laragon\\bin\\laragon\\utils\\curl-ca-bundle.crt\n  CApath: none\n} [5 bytes data]\n* TLSv1.3 (OUT), TLS handshake, Client hello (1):\n} [512 bytes data]\n* TLSv1.3 (IN), TLS handshake, Server hello (2):\n{ [102 bytes data]\n* TLSv1.2 (IN), TLS handshake, Certificate (11):\n{ [2572 bytes data]\n* TLSv1.2 (IN), TLS handshake, Server key exchange (12):\n{ [333 bytes data]\n* TLSv1.2 (IN), TLS handshake, Server finished (14):\n{ [4 bytes data]\n* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):\n} [70 bytes data]\n* TLSv1.2 (OUT), TLS change cipher, Change cipher spec (1):\n} [1 bytes data]\n* TLSv1.2 (OUT), TLS handshake, Finished (20):\n} [16 bytes data]\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0* TLSv1.2 (IN), TLS handshake, Finished (20):\n{ [16 bytes data]\n* SSL connection using TLSv1.2 / ECDHE-RSA-AES128-GCM-SHA256\n* ALPN, server accepted to use h2\n* Server certificate:\n*  subject: CN=sergetahe.com\n*  start date: May 10 01:41:15 2020 GMT\n*  expire date: Aug  8 01:41:15 2020 GMT\n*  subjectAltName: host \"sergetahe.com\" matched cert's \"sergetahe.com\"\n*  issuer: C=US; O=Let's Encrypt; CN=Let's Encrypt Authority X3\n*  SSL certificate verify ok.\n* Using HTTP2, server supports multi-use\n* Connection state changed (HTTP/2 confirmed)\n* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0\n} [5 bytes data]\n* Using Stream ID: 1 (easy handle 0x2bee870)\n} [5 bytes data]\n&gt; GET /cours-tutoriels-de-programmation/ HTTP/2\n&gt; Host: sergetahe.com\n&gt; User-Agent: curl/7.63.0\n&gt; Accept: */*\n&gt;\n{ [5 bytes data]\n* Connection state changed (MAX_CONCURRENT_STREAMS == 128)!\n} [5 bytes data]\n  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0&lt; HTTP/2 200\n&lt; date: Sun, 05 Jul 2020 17:44:19 GMT\n&lt; content-type: text/html; charset=UTF-8\n&lt; server: Apache\n&lt; x-powered-by: PHP/7.3\n&lt; link: &lt;https://sergetahe.com/cours-tutoriels-de-programmation/wp-json/&gt;; rel=\"https://api.w.org/\"\n&lt; link: &lt;https://sergetahe.com/cours-tutoriels-de-programmation/&gt;; rel=shortlink\n&lt; vary: Accept-Encoding\n&lt; x-iplb-instance: 17080\n&lt; set-cookie: SERVERID68971=2620178|XwIRd|XwIRd; path=/\n&lt;\n{ [5 bytes data]\n100 49634    0 49634    0     0  26040      0 --:--:--  0:00:01 --:--:-- 37830\n* Connection #1 to host sergetahe.com left intact\n</code></pre> <ul> <li>ligne 2\u00a0: on utilise l\u2019option [--location] pour indiquer qu\u2019on veut suivre les redirections envoy\u00e9es par le serveur\u00a0;</li> <li>ligne 13\u00a0: le serveur indique que le document demand\u00e9 a chang\u00e9 d\u2019URL\u00a0;</li> <li>ligne 18\u00a0: il indique la nouvelle URL du document demand\u00e9\u00a0;</li> <li>ligne 31\u00a0: [curl] \u00e9met une nouvelle requ\u00eate vers cette fois la nouvelle URL\u00a0;</li> <li>ligne 36\u00a0: le serveur r\u00e9pond de nouveau que l\u2019URL a chang\u00e9\u00a0;</li> <li>ligne 41\u00a0: la nouvelle URL est exactement la m\u00eame que celle qui a \u00e9t\u00e9 redirig\u00e9e \u00e0 un d\u00e9tail pr\u00e8s\u00a0: le procole a chang\u00e9. Il est devenu HTTPS (ligne 41) alors qu\u2019il \u00e9tait http auparavant (ligne 31)\u00a0;</li> <li>ligne 49\u00a0: une nouvelle requ\u00eate st \u00e9mise vers la nouvelle URL. Celle-ci est chiffr\u00e9e. Aussi tout un dialogue de mise en place de la s\u00e9curit\u00e9 se met en place, lignes 53-91\u00a0;</li> <li>ligne 92\u00a0: la nouvelle URL est demand\u00e9e avec cette fois le protocole HTTP/2\u00a0;</li> <li>ligne 100\u00a0: le document a \u00e9t\u00e9 trouv\u00e9\u00a0; Le document demand\u00e9 sera trouv\u00e9 dans le fichier [sergetahe.com.html].</li> </ul> <pre><code>C:\\Temp\\curl\n\u03bb dir\n Le volume dans le lecteur C s\u2019appelle Local Disk\n Le num\u00e9ro de s\u00e9rie du volume est B84C-D958\n\n R\u00e9pertoire de C:\\Temp\\curl\n\n05/07/2020  19:44    &lt;DIR&gt;          .\n05/07/2020  19:44    &lt;DIR&gt;          ..\n05/07/2020  19:35             1\u00a0776 localhost.html\n05/07/2020  19:44            49\u00a0634 sergetahe.com.html\n05/07/2020  19:39           101\u00a0639 tahe.developpez.com.html\n               3 fichier(s)          153\u00a0049 octets\n               2 R\u00e9p(s)  892\u00a0385\u00a0628\u00a0160 octets libres\n</code></pre>"},{"location":"fonctions-internet.html#2145-exemple-5","title":"21.4.5. Exemple 5","text":"<p>Python poss\u00e8de un module appel\u00e9 [pyccurl] qui permet d\u2019utiliser les capacit\u00e9s de l\u2019outil [curl] dans un programme Python. Nous installons ce module\u00a0:</p> <p></p> <p>Nous allons \u00e9crire un nouveau script [http/02/main.py]\u00a0:</p> <p></p> <p>Le fichier [http/02/config] est le suivant\u00a0:</p> <pre><code>def configure():\n    # liste des URL \u00e0 interroger\n    urls = [\n        # site : serveur auquel se connecter\n        # timeout : d\u00e9lai maximal d'attente d'une r\u00e9ponse du serveur\n        # target : url \u00e0 demander\n        # encoding : encodage de la r\u00e9ponse du serveur\n        {\n            \"site\": \"sergetahe.com\",\n            \"timeout\": 2000,\n            \"target\": \"http://sergetahe.com\",\n            \"encoding\": \"utf-8\"\n        },\n        {\n            \"site\": \"tahe.developpez.com\",\n            \"timeout\": 500,\n            \"target\": \"https://tahe.developpez.com\",\n            \"encoding\": \"iso-8859-1\"\n        },\n        {\n            \"site\": \"www.polytech-angers.fr\",\n            \"timeout\": 500,\n            \"target\": \"http://www.polytech-angers.fr\",\n            \"encoding\": \"utf-8\"\n        },\n        {\n            \"site\": \"localhost\",\n            \"timeout\": 500,\n            \"target\": \"http://localhost\",\n            \"encoding\": \"utf-8\"\n        }\n    ]\n    # on rend la configuration\n    return {\n        'urls': urls\n    }\n</code></pre> <p>Le fichier contient une liste de dictionnaires o\u00f9 chacun d'eux a la structure suivante\u00a0:</p> <ul> <li>site\u00a0: le nom d\u2019un serveur web\u00a0;</li> <li>encoding\u00a0: le type d'encodage du document attendu\u00a0;</li> <li>timeout\u00a0: dur\u00e9e maximale d\u2019attente de la r\u00e9ponse du serveur exprim\u00e9e en millisecondes. Au-del\u00e0, le client se d\u00e9connectera\u00a0;</li> <li>url\u00a0: URL du document demand\u00e9\u00a0; Le code du script [http/02/main.py] est le suivant\u00a0:</li> </ul> <pre><code># imports\nimport codecs\nfrom io import BytesIO\n\nimport pycurl\n\n\n# -----------------------------------------------------------------------\ndef get_url(url: dict, suivi=True):\n    # lit l'URL url[url] et la stocke dans le fichier output/url['site'].html\n    # si [suivi=True] alors il y a un suivi console de l'\u00e9change client / serveur\n    # url[timeout] est le timeout des appels client;\n    # url [encoding] est l'encodage du document demand\u00e9\n\n    # on r\u00e9cup\u00e8re les donn\u00e9es de configuration\n    server = url['site']\n    timeout = url['timeout']\n    target = url['target']\n    encoding = url['encoding']\n    # suivi\n    print(f\"Client : d\u00e9but de la communication avec le serveur [{server}]\")\n\n    # on laisse remonter les exceptions\n    html = None\n    curl = None\n    try:\n        # Initialisation d'une session cURL\n        curl = pycurl.Curl()\n        # flux binaire\n        flux = BytesIO()\n        # options de curl\n        options = {\n            # URL\n            curl.URL: target,\n            # WRITEDATA : l\u00e0 o\u00f9 les donn\u00e9es re\u00e7ues seront stock\u00e9es\n            curl.WRITEDATA: flux,\n            # mode verbose\n            curl.VERBOSE: suivi,\n            # nouvelle connexion - pas de cache\n            curl.FRESH_CONNECT: True,\n            # timeout de la requ\u00eate (en secondes)\n            curl.TIMEOUT: timeout,\n            curl.CONNECTTIMEOUT: timeout,\n            # ne pas v\u00e9rifier la validit\u00e9 des certificats SSL\n            curl.SSL_VERIFYPEER: False,\n            # suivre les redirections\n            curl.FOLLOWLOCATION: True\n        }\n        # param\u00e9trage de curl\n        for option, value in options.items():\n            curl.setopt(option, value)\n        # Execution de la requ\u00eate CURL ainsi param\u00e9tr\u00e9e\n        curl.perform()\n        # cr\u00e9ation du fichier server.html - on change les caract\u00e8res g\u00eanants pour un nom de fichier\n        server2 = server.replace(\"/\", \"_\")\n        server2 = server2.replace(\".\", \"_\")\n        html_filename = f'{server2}.html'\n        html = codecs.open(f\"output/{html_filename}\", \"w\", encoding)\n        # enregistrement du document re\u00e7u dans le fichier HTML\n        html.write(flux.getvalue().decode(encoding))\n    finally:\n        # lib\u00e9ration des ressources\n        if curl:\n            curl.close()\n        if html:\n            html.close()\n\n\n# -------------------main\n# on configure l'application\nimport config\nconfig = config.configure()\n\n# obtenir les URL du fichier de configuration\nfor url in config['urls']:\n    print(\"-------------------------\")\n    print(url['site'])\n    print(\"-------------------------\")\n    try:\n        # lecture URL du site [site]\n        get_url(url)\n    # except BaseException as erreur:\n    #     print(f\"L'erreur suivante s'est produite : {erreur}\")\n    finally:\n        pass\n# fin\nprint(\"Termin\u00e9...\")\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 5\u00a0: on importe le module [pycurl]\u00a0;</li> <li>ligne 3\u00a0: on importe la classe [BytesIO] qui va nous permettre de stocker les donn\u00e9es re\u00e7ues du serveur dans un flux binaire\u00a0;</li> <li>lignes 70-72\u00a0: on r\u00e9cup\u00e8re la configuration de l\u2019application\u00a0;</li> <li>lignes 75-85\u00a0: on boucle sur la liste des URL trouv\u00e9es dans la configuration\u00a0;</li> <li>ligne 81\u00a0: pour chacune des URL, on appelle la fonction [get_url] qui va t\u00e9l\u00e9charger l\u2019URL url[\u2018target\u2019] avec un timeout url['timeout']\u00a0;</li> <li>ligne 9\u00a0: la fonction [get_url] re\u00e7oit la configuration de l\u2019URL \u00e0 interroger\u00a0;</li> <li>lignes 16-19\u00a0: on r\u00e9cup\u00e8re la configuration de l\u2019URL dans des variables s\u00e9par\u00e9es\u00a0;</li> <li>lignes 26, 61\u00a0: on fait toutes les op\u00e9rations au sein d'un try / finally. On n'arr\u00eate pas les exceptions qui remonteront alors au code appelant qui lui les arr\u00eate\u00a0;</li> <li>ligne 28\u00a0: on pr\u00e9pare une session [curl]. [pycurl.Curl()] rend une ressource [curl] qui va op\u00e9rer la transaction avec un serveur\u00a0;</li> <li>ligne 30\u00a0: instanciation du flux binaire qui va stocker les donn\u00e9es re\u00e7ues\u00a0;</li> <li>lignes 32-48\u00a0: le dictionnaire [options] va param\u00e9trer la connexion [curl] au serveur. leur r\u00f4le est indiqu\u00e9 dans les commentaires\u00a0;</li> <li>lignes 49-51\u00a0: les options de la connexion sont transmises \u00e0 la ressource [curl]\u00a0;</li> <li>ligne 53\u00a0: connexion \u00e0 l\u2019URL demand\u00e9e avec les options d\u00e9finies. A cause de l\u2019option [curl.WRITEDATA: flux] (ligne 36), la fonction [curl.perform()] va stocker les donn\u00e9es re\u00e7ues dans [flux]\u00a0;</li> <li>lignes 54-60\u00a0: on cr\u00e9e le fichier HTML qui va stocker le document HTML re\u00e7u\u00a0;</li> <li>ligne 60\u00a0: le flux binaire [flux.getvalue()] va \u00eatre stock\u00e9 comme une cha\u00eene de caract\u00e8res dans le fichier HTML. L'encodage de cette cha\u00eene est pr\u00e9cis\u00e9 dans la m\u00e9thode [decode(encoding)]. Il faut donc conna\u00eetre l'encodage du document envoy\u00e9 par le serveur. Si on se trompe, l'op\u00e9ration de d\u00e9codage du flux binaire va \u00e9chouer. L'encodage est pr\u00e9cis\u00e9 dans le fichier de configuration de l\u2019URL (ligne 12 par exemple). On aurait pu g\u00e9rer dynamiquement cette information car le serveur l'envoie dans ces ent\u00eates HTTP. Cela aurait \u00e9t\u00e9 pr\u00e9f\u00e9rable. Pour garder un code simple, nous ne l'avons pas fait. Pour conna\u00eetre le type d'encodage du document, il suffit de demander l'URL d\u00e9sir\u00e9e avec un navigateur et regarder les ent\u00eates HTTP envoy\u00e9s par celui-ci en mode d\u00e9bogage du navigateur (F12) ou bien le document lui-m\u00eame car celui-ci pr\u00e9cise \u00e9galement l'encodage\u00a0:</li> </ul> <p></p> <p></p> <ul> <li>ligne 61-66\u00a0: les ressources allou\u00e9es sont lib\u00e9r\u00e9es\u00a0; Lorsqu\u2019on ex\u00e9cute le script [main.py] on obtient les r\u00e9sultats console suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/inet/http/02/main.py\n-------------------------\nsergetahe.com\n-------------------------\nClient : d\u00e9but de la communication avec le serveur [sergetahe.com]\n*   Trying 87.98.154.146:80...\n* TCP_NODELAY set\n* Connected to sergetahe.com (87.98.154.146) port 80 (#0)\n&gt; GET / HTTP/1.1\nHost: sergetahe.com\nUser-Agent: PycURL/7.43.0.5 libcurl/7.68.0 OpenSSL/1.1.1d zlib/1.2.11 c-ares/1.15.0 WinIDN libssh2/1.9.0 nghttp2/1.40.0\nAccept: */*\n\n* Mark bundle as not supporting multiuse\n&lt; HTTP/1.1 302 Found\n&lt; Date: Mon, 06 Jul 2020 06:45:52 GMT\n&lt; Content-Type: text/html; charset=UTF-8\n&lt; Transfer-Encoding: chunked\n&lt; Server: Apache\n&lt; X-Powered-By: PHP/7.3\n&lt; Location: http://sergetahe.com/cours-tutoriels-de-programmation\n&lt; Set-Cookie: SERVERID68971=26218|XwLIo|XwLIo; path=/\n&lt; X-IPLB-Instance: 17102\n&lt; \n* Ignoring the response-body\n* Connection #0 to host sergetahe.com left intact\n* Issue another request to this URL: 'http://sergetahe.com/cours-tutoriels-de-programmation'\n* Found bundle for host sergetahe.com: 0x25eacafb5d0 [serially]\n* Can not multiplex, even if we wanted to!\n* Re-using existing connection! (#0) with host sergetahe.com\n* Connected to sergetahe.com (87.98.154.146) port 80 (#0)\n&gt; GET /cours-tutoriels-de-programmation HTTP/1.1\nHost: sergetahe.com\nUser-Agent: PycURL/7.43.0.5 libcurl/7.68.0 OpenSSL/1.1.1d zlib/1.2.11 c-ares/1.15.0 WinIDN libssh2/1.9.0 nghttp2/1.40.0\nAccept: */*\n\n* Mark bundle as not supporting multiuse\n&lt; HTTP/1.1 301 Moved Permanently\n&lt; Date: Mon, 06 Jul 2020 06:45:52 GMT\n&lt; Content-Type: text/html; charset=iso-8859-1\n&lt; Content-Length: 262\n&lt; Server: Apache\n&lt; Location: http://sergetahe.com/cours-tutoriels-de-programmation/\n&lt; Set-Cookie: SERVERID68971=26218|XwLIo|XwLIo; path=/\n&lt; X-IPLB-Instance: 17102\n&lt; \n* Ignoring the response-body\n* Connection #0 to host sergetahe.com left intact\n* Issue another request to this URL: 'http://sergetahe.com/cours-tutoriels-de-programmation/'\n* Found bundle for host sergetahe.com: 0x25eacafb5d0 [serially]\n* Can not multiplex, even if we wanted to!\n* Re-using existing connection! (#0) with host sergetahe.com\n* Connected to sergetahe.com (87.98.154.146) port 80 (#0)\n&gt; GET /cours-tutoriels-de-programmation/ HTTP/1.1\nHost: sergetahe.com\nUser-Agent: PycURL/7.43.0.5 libcurl/7.68.0 OpenSSL/1.1.1d zlib/1.2.11 c-ares/1.15.0 WinIDN libssh2/1.9.0 nghttp2/1.40.0\nAccept: */*\n\n* Mark bundle as not supporting multiuse\n&lt; HTTP/1.1 301 Moved Permanently\n&lt; Date: Mon, 06 Jul 2020 06:45:52 GMT\n&lt; Content-Type: text/html; charset=iso-8859-1\n&lt; Content-Length: 263\n&lt; Server: Apache\n&lt; Location: https://sergetahe.com/cours-tutoriels-de-programmation/\n&lt; Set-Cookie: SERVERID68971=26218|XwLIo|XwLIo; path=/\n&lt; X-IPLB-Instance: 17102\n&lt; \n* Ignoring the response-body\n* Connection #0 to host sergetahe.com left intact\n* Issue another request to this URL: 'https://sergetahe.com/cours-tutoriels-de-programmation/'\n*   Trying 87.98.154.146:443...\n* TCP_NODELAY set\n* \u2026.\n* Using Stream ID: 1 (easy handle 0x25eaec77010)\n&gt; GET /cours-tutoriels-de-programmation/ HTTP/2\nHost: sergetahe.com\nuser-agent: PycURL/7.43.0.5 libcurl/7.68.0 OpenSSL/1.1.1d zlib/1.2.11 c-ares/1.15.0 WinIDN libssh2/1.9.0 nghttp2/1.40.0\naccept: */*\n\n* Connection state changed (MAX_CONCURRENT_STREAMS == 128)!\n&lt; HTTP/2 200 \n&lt; date: Mon, 06 Jul 2020 06:45:53 GMT\n&lt; content-type: text/html; charset=UTF-8\n&lt; server: Apache\n&lt; x-powered-by: PHP/7.3\n&lt; link: &lt;https://sergetahe.com/cours-tutoriels-de-programmation/wp-json/&gt;; rel=\"https://api.w.org/\"\n&lt; link: &lt;https://sergetahe.com/cours-tutoriels-de-programmation/&gt;; rel=shortlink\n&lt; vary: Accept-Encoding\n&lt; x-iplb-instance: 17080\n&lt; set-cookie: SERVERID68971=26218|XwLIp|XwLIp; path=/\n&lt; \n* Connection #1 to host sergetahe.com left intact\n-------------------------\ntahe.developpez.com\n-------------------------\nClient : d\u00e9but de la communication avec le serveur [tahe.developpez.com]\n*   Trying 87.98.130.52:443...\n* TCP_NODELAY set\n* Connected to tahe.developpez.com (87.98.130.52) port 443 (#0)\n* ALPN, offering h2\n* ALPN, offering http/1.1\n* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384\n* ALPN, server accepted to use http/1.1\n* Server certificate:\n*  subject: CN=*.developpez.com\n*  start date: Jul  1 15:38:30 2020 GMT\n*  expire date: Sep 29 15:38:30 2020 GMT\n*  subjectAltName: host \"tahe.developpez.com\" matched cert's \"*.developpez.com\"\n*  issuer: C=US; O=Let's Encrypt; CN=Let's Encrypt Authority X3\n*  SSL certificate verify result: unable to get local issuer certificate (20), continuing anyway.\n&gt; GET / HTTP/1.1\nHost: tahe.developpez.com\nUser-Agent: PycURL/7.43.0.5 libcurl/7.68.0 OpenSSL/1.1.1d zlib/1.2.11 c-ares/1.15.0 WinIDN libssh2/1.9.0 nghttp2/1.40.0\nAccept: */*\n\n* old SSL session ID is stale, removing\n* Mark bundle as not supporting multiuse\n&lt; HTTP/1.1 200 OK\n&lt; Date: Mon, 06 Jul 2020 06:45:53 GMT\n&lt; Server: Apache/2.4.38 (Debian)\n&lt; X-Powered-By: PHP/5.3.29\n&lt; Vary: Accept-Encoding\n&lt; Transfer-Encoding: chunked\n&lt; Content-Type: text/html\n&lt; \n* Connection #0 to host tahe.developpez.com left intact\n-------------------------\nwww.polytech-angers.fr\n-------------------------\nClient : d\u00e9but de la communication avec le serveur [www.polytech-angers.fr]\n*   Trying 193.49.144.41:80...\n* TCP_NODELAY set\n* Connected to www.polytech-angers.fr (193.49.144.41) port 80 (#0)\n&gt; GET / HTTP/1.1\nHost: www.polytech-angers.fr\nUser-Agent: PycURL/7.43.0.5 libcurl/7.68.0 OpenSSL/1.1.1d zlib/1.2.11 c-ares/1.15.0 WinIDN libssh2/1.9.0 nghttp2/1.40.0\nAccept: */*\n\n* Mark bundle as not supporting multiuse\n&lt; HTTP/1.1 301 Moved Permanently\n&lt; Date: Mon, 06 Jul 2020 06:45:54 GMT\n&lt; Server: Apache/2.4.29 (Ubuntu)\n&lt; Location: http://www.polytech-angers.fr/fr/index.html\n&lt; Cache-Control: max-age=1\n&lt; Expires: Mon, 06 Jul 2020 06:45:55 GMT\n&lt; Content-Length: 339\n&lt; Content-Type: text/html; charset=iso-8859-1\n&lt; \n* Ignoring the response-body\n* Connection #0 to host www.polytech-angers.fr left intact\n* Issue another request to this URL: 'http://www.polytech-angers.fr/fr/index.html'\n* Found bundle for host www.polytech-angers.fr: 0x25eacafb490 [serially]\n* Can not multiplex, even if we wanted to!\n* Re-using existing connection! (#0) with host www.polytech-angers.fr\n* Connected to www.polytech-angers.fr (193.49.144.41) port 80 (#0)\n&gt; GET /fr/index.html HTTP/1.1\nHost: www.polytech-angers.fr\nUser-Agent: PycURL/7.43.0.5 libcurl/7.68.0 OpenSSL/1.1.1d zlib/1.2.11 c-ares/1.15.0 WinIDN libssh2/1.9.0 nghttp2/1.40.0\nAccept: */*\n\n* Mark bundle as not supporting multiuse\n&lt; HTTP/1.1 200 OK\n&lt; Date: Mon, 06 Jul 2020 06:45:54 GMT\n&lt; Server: Apache/2.4.29 (Ubuntu)\n&lt; Last-Modified: Mon, 06 Jul 2020 04:50:09 GMT\n&lt; ETag: \"85be-5a9be9bfcf228\"\n&lt; Accept-Ranges: bytes\n&lt; Content-Length: 34238\n&lt; Cache-Control: max-age=1\n&lt; Expires: Mon, 06 Jul 2020 06:45:55 GMT\n&lt; Vary: Accept-Encoding\n&lt; Content-Type: text/html; charset=UTF-8\n&lt; Content-Language: fr\n&lt; \n* Connection #0 to host www.polytech-angers.fr left intact\n-------------------------\nlocalhost\n-------------------------\nClient : d\u00e9but de la communication avec le serveur [localhost]\n*   Trying ::1:80...\n* TCP_NODELAY set\n* Connected to localhost (::1) port 80 (#0)\n&gt; GET / HTTP/1.1\nHost: localhost\nUser-Agent: PycURL/7.43.0.5 libcurl/7.68.0 OpenSSL/1.1.1d zlib/1.2.11 c-ares/1.15.0 WinIDN libssh2/1.9.0 nghttp2/1.40.0\nAccept: */*\n\n* Mark bundle as not supporting multiuse\n&lt; HTTP/1.1 200 OK\n&lt; Date: Mon, 06 Jul 2020 06:45:54 GMT\n&lt; Server: Apache/2.4.35 (Win64) OpenSSL/1.1.1b PHP/7.2.19\n&lt; X-Powered-By: PHP/7.2.19\n&lt; Content-Length: 1776\n&lt; Content-Type: text/html; charset=UTF-8\n&lt; \n* Connection #0 to host localhost left intact\nTermin\u00e9...\n\nProcess finished with exit code 0\n</code></pre> <p>Commentaires</p> <ul> <li>en bleu, les commandes http envoy\u00e9es au serveur\u00a0;</li> <li>en vert, les donn\u00e9es re\u00e7ues en r\u00e9ponse par le client\u00a0;</li> <li>on obtient les m\u00eames \u00e9changes qu\u2019avec l\u2019outil [curl]\u00a0;</li> <li>ligne 9\u00a0: l'URL [http://sergetahe.com/] est demand\u00e9e\u00a0;</li> <li>ligne 15\u00a0: le serveur r\u00e9pond que la page a boug\u00e9. Ligne 21, la nouvelle URL\u00a0;</li> <li>ligne 32\u00a0: l'URL [http://sergetahe.com/cours-tutoriels-de-programmation] est demand\u00e9e\u00a0;</li> <li>ligne 38\u00a0: le serveur r\u00e9pond que la page a boug\u00e9. Ligne 43, la nouvelle URL\u00a0;</li> <li>ligne 54\u00a0: l'URL [http://sergetahe.com/cours-tutoriels-de-programmation/] est demand\u00e9e\u00a0;</li> <li>ligne 60\u00a0: le serveur r\u00e9pond que la page a boug\u00e9. Ligne 65, la nouvelle URL. Elle utilise le protocole s\u00e9curis\u00e9 [HTTPS]\u00a0;</li> <li>lignes 71-75\u00a0: le protocole s\u00e9curis\u00e9 est mis en place avec le serveur\u00a0;</li> <li>ligne 76\u00a0: l'URL [https://sergetahe.com/cours-tutoriels-de-programmation/] est demand\u00e9e\u00a0;</li> <li>ligne 82\u00a0: le document demand\u00e9 a \u00e9t\u00e9 trouv\u00e9\u00a0;</li> </ul>"},{"location":"fonctions-internet.html#2146-conclusion","title":"21.4.6. Conclusion","text":"<p>Nous avons, dans cette section, d\u00e9couvert le protocole HTTP et avons \u00e9crit un script [http/02/main.py] capable de t\u00e9l\u00e9charger une URL du web.</p>"},{"location":"fonctions-internet.html#215-le-protocole-smtp-simple-mail-transfer-protocol","title":"21.5. Le protocole SMTP (Simple Mail Transfer Protocol)","text":""},{"location":"fonctions-internet.html#2151-introduction","title":"21.5.1. Introduction","text":"<p>Dans ce chapitre\u00a0:</p> <ul> <li>[Serveur B] sera un serveur SMTP local que nous installerons\u00a0;</li> <li>[Client A] sera un client SMTP de diverses formes\u00a0:</li> <li>le client [RawTcpClient] pour d\u00e9couvrir le protocole SMTP\u00a0;</li> <li>un script Python rejouant le protocole SMTP du client [RawTcpClient]\u00a0;</li> <li>un script Python utilisant le moduke [smtplib] permettant d\u2019envoyer toutes sortes de mails\u00a0;</li> </ul>"},{"location":"fonctions-internet.html#2152-creation-dune-adresse-gmail","title":"21.5.2. Cr\u00e9ation d\u2019une adresse [gmail]","text":"<p>Pour faire nos tests SMTP, nous aurons besoin d\u2019une adresse mail \u00e0 qui \u00e9crire. Nous allons cr\u00e9er pour cela une adresse Gmail\u00a0[https://www.google.com/intl/fr/gmail/about/] :</p> <p></p> <p>Note\u00a0: Envoyez quelques mails \u00e0 l'adresse que vous avez cr\u00e9\u00e9e. Ne passez \u00e0 la suite que lorsque vous \u00eates s\u00fbr que le compte cr\u00e9\u00e9 est capable de recevoir des mails.</p>"},{"location":"fonctions-internet.html#2153-installation-dun-serveur-smtp","title":"21.5.3. Installation d\u2019un serveur SMTP","text":"<p>Pour nos tests, nous installerons le serveur de mail [hMailServer] qui est \u00e0 la fois un serveur SMTP permettant d\u2019envoyer des mails, un serveur POP3 (Post Office Protocol) permettant de lire les mails stock\u00e9s sur le serveur, un serveur IMAP (Internet Message Access Protocol) qui lui aussi permet de  lire les mails stock\u00e9s sur le serveur mais va au-del\u00e0. Il permet notamment de g\u00e9rer le stockage des mails sur le serveur.</p> <p>Le serveur de mail [hMailServer] est disponible \u00e0 l\u2019URL [https://www.hmailserver.com/] (mai 2019).</p> <p></p> <p>Au cours de l\u2019installation, certains renseignements vous seront demand\u00e9s\u00a0:</p> <p></p> <ul> <li>en [1-2], s\u00e9lectionnez \u00e0 la fois le serveur de mails et les outils pour l\u2019administrer\u00a0;</li> <li> <p>durant l\u2019installation le mot de l\u2019administrateur vous sera demand\u00e9\u00a0: notez le, car il vous sera n\u00e9cessaire\u00a0; [hMailServer] s\u2019installe comme un service Windows lanc\u00e9 automatiquement au d\u00e9marrage de la machine. Il est pr\u00e9f\u00e9rable de choisir un d\u00e9marrage manuel\u00a0:</p> </li> <li> <p>en [3], on tape [services] dans la zone de saisie de la barre d\u2019\u00e9tat\u00a0;</p> </li> </ul> <p></p> <ul> <li>en [4-8], on met le service en mode [manuel] (6), on le lance (7)\u00a0; Une fois d\u00e9marr\u00e9, le serveur [hMailServer] doit \u00eatre configur\u00e9. Le serveur a \u00e9t\u00e9 install\u00e9 avec un programme d\u2019administration [hMailServer Administrator]\u00a0:</li> </ul> <p></p> <ul> <li>en [2], dans la zone de saisie de la barre d\u2019\u00e9tat, taper [hmailserver]\u00a0;</li> <li>en [3], lancer l\u2019administrateur\u00a0;</li> <li>en [4], connecter l\u2019administrateur au serveur [hMailServer]\u00a0;</li> <li> <p>en [5], taper le mot de passe saisi lors de l\u2019installation de [hMailServer]\u00a0; Si vous avez oubli\u00e9 le mot de passe, proc\u00e9dez comme suit\u00a0:</p> </li> <li> <p>arr\u00eatez le serveur [hMailServer]\u00a0;</p> </li> <li>ouvrez le fichier [&lt;hmailserver&gt;/bin/hmailserver.ini] o\u00f9 &lt;hmailserver&gt; est le dossier d'installation du serveur\u00a0:</li> </ul> <p></p> <ul> <li>en [100], enlevez le mot de passe de la ligne [AdministratorPassword]. Cela aura pour effet que l'administrateur n'aura plus de mot de passe. Tapez simplement [Entr\u00e9e] lorsque celui-ci vous sera demand\u00e9\u00a0; <pre><code>ValidLanguages=english,swedish\n[Security]\nAdministratorPassword=\n[Database]\n</code></pre></li> </ul> <p>Continuons la configuration du serveur\u00a0:</p> <p></p> <ul> <li>en [1-2], ajoutez un domaine (s\u2019il n\u2019existe pas d\u00e9j\u00e0)\u00a0;</li> </ul> <p></p> <ul> <li>en [3], on peut mettre \u00e0 peu pr\u00e8s n\u2019importe quoi pour les tests que nous allons op\u00e9rer. Dans la r\u00e9alit\u00e9, il faudrait mettre le nom d\u2019un domaine existant\u00a0;</li> </ul> <p></p> <p>Nous allons cr\u00e9er un compte utilisateur\u00a0:</p> <ul> <li>cliquer droit sur [Accounts] (7) puis (8) pour ajouter un nouvel utilisateur\u00a0;</li> <li>dans l\u2019onglet [General] (9), nous d\u00e9finissons un utilisateur [guest] (10) avec le mot de passe [guest] (11). Il aura l\u2019adresse mail [guest@localhost] (10)\u00a0;</li> <li>en [12], l\u2019utilisateur [guest] est activ\u00e9\u00a0;</li> </ul> <p></p> <ul> <li>en [13-14], l\u2019utilisateur cr\u00e9\u00e9\u00a0;</li> </ul> <p></p> <ul> <li>en [27] le port du service SMTP\u00a0;</li> <li>en [28], ce service ne n\u00e9cessite pas d\u2019authentification\u00a0;</li> <li>en [30], mettez le message de bienvenue que le serveur SMTP enverra \u00e0 ses clients\u00a0;</li> </ul> <p></p> <p>On fait de m\u00eame avec le serveur POP3\u00a0:</p> <p></p> <p>On refait la m\u00eame chose pour le serveur IMAP\u00a0:</p> <p></p> <p>Nous indiquons le domaine par d\u00e9faut du serveur [hMailServer]\u00a0(il peut y en avoir plusieurs)\u00a0:</p> <p></p> <ul> <li>en [37], indiquez que le domaine par d\u00e9faut du serveur SMTP est celui que vous avez cr\u00e9\u00e9 en [38]\u00a0; Apr\u00e8s avoir sauvegard\u00e9 cette configuration, vous pouvez la tester de la fa\u00e7on suivante. Ouvrez un terminal PyCharm dans le dossier des utilitaires\u00a0:</li> </ul> <p></p> <p>Puis tapez la commande suivante\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpClient.exe localhost 25\nClient [DESKTOP-30FF5FB:50170] connect\u00e9 au serveur [localhost-25]\nTapez vos commandes (quit pour arr\u00eater) :\n&lt;-- [220 Bienvenue sur le serveur SMTP localhost.com]\n</code></pre> <ul> <li>ligne 1\u00a0: on se connecte au port 25 de la machine [localhost]. C\u2019est l\u00e0 qu\u2019officie un serveur SMTP non s\u00e9curis\u00e9 du serveur [hMailServer]\u00a0;</li> <li>ligne 4\u00a0: on re\u00e7oit le message de bienvenue que nous avons configur\u00e9 \u00e0 l\u2019\u00e9tape 30 pr\u00e9c\u00e9dente\u00a0; Le serveur SMTP est donc bien en place. Tapez la commande [quit] pour terminer le dialogue avec le serveur SMTP 25.</li> </ul> <p>Maintenant faisons la m\u00eame chose avec le port 587 qui est le port par d\u00e9faut du service SMTP s\u00e9curis\u00e9 de rel\u00e8ve du courrier\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpClient.exe localhost 587\nClient [DESKTOP-30FF5FB:50217] connect\u00e9 au serveur [localhost-587]\nTapez vos commandes (quit pour arr\u00eater) :\n&lt;-- [220 Bienvenue sur le serveur SMTP localhost.com]\n</code></pre> <ul> <li>ligne 4, la r\u00e9ponse du serveur SMTP officiant sur le port 587\u00a0; Maintenant faisons la m\u00eame chose avec le port 110 qui est le port par d\u00e9faut du service POP3 de rel\u00e8ve du courrier\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpClient.exe localhost 110\nClient [DESKTOP-30FF5FB:50210] connect\u00e9 au serveur [localhost-110]\nTapez vos commandes (quit pour arr\u00eater) :\n&lt;-- [+OK Bienvenue sur le serveur POP3 localhost.com]\n</code></pre> <ul> <li>ligne 4, on a re\u00e7u le message de bienvenue du serveur POP3\u00a0; Maintenant faisons la m\u00eame chose avec le port 143 qui est le port par d\u00e9faut du service IMAP de rel\u00e8ve du courrier\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpClient.exe localhost 143\nClient [DESKTOP-30FF5FB:50212] connect\u00e9 au serveur [localhost-143]\nTapez vos commandes (quit pour arr\u00eater) :\n&lt;-- [* OK Bienvenue sur le serveur IMAP localhost.com]\n</code></pre> <ul> <li>ligne 4, on a re\u00e7u le message de bienvenue du serveur IMAP\u00a0;</li> </ul>"},{"location":"fonctions-internet.html#2154-installation-dun-lecteur-de-courrier","title":"21.5.4. Installation d'un lecteur de courrier","text":"<p>Pour lire le courrier que nous allons envoyer, il nous faut un lecteur de courrier. Pour ceux qui n'en ont pas, nous montrons l'installation et la configuration du lecteur [Thunderbird]\u00a0:</p> <ul> <li>en [1]\u00a0: t\u00e9l\u00e9chargez [thunderbird] puis installez-le\u00a0;</li> </ul> <p></p> <ul> <li>lancez le serveur de mail [hMailServer] s'il ne l'est pas d\u00e9j\u00e0\u00a0;</li> <li>en [2-3]\u00a0: une fois Thunderbird lanc\u00e9,  nous allons cr\u00e9er un compte de messagerie pour l'utilisateur [guest@localhost] du serveur de mail [hMailServer]\u00a0;</li> </ul> <p></p> <p></p> <p></p> <ul> <li>en [7-11]\u00a0: le serveur POP3 qui va nous permettre de lire le courrier du serveur de mail [hMailServer] est \u00e0 l'adresse [localhost]\u00a0et officie sur le port 110\u00a0;</li> <li>en [12-16]\u00a0: le serveur SMTP qui va nous permettre d'envoyer du courrier de la part des utilisateurs du serveur de mail [hMailServer] est \u00e0 l'adresse [localhost]\u00a0et officie sur le port 25\u00a0;</li> <li>[18]\u00a0: on peut tester la validation de cette configuration\u00a0;</li> </ul> <p></p> <p></p> <ul> <li>en [26]\u00a0: parce qu'on n'a pas de chiffrement SSL, Thunderbird nous avertit que notre configuration comporte des risques\u00a0;</li> <li> <p>en [28]\u00a0: le compte a \u00e9t\u00e9 cr\u00e9\u00e9\u00a0; Pour tester le compte cr\u00e9\u00e9, nous allons avec Thunderbird\u00a0:</p> </li> <li> <p>envoyer un mail \u00e0 l'utilisateur [guest@localhost.com] (protocole SMTP)\u00a0;</p> </li> <li>lire le courrier re\u00e7u par cet utilisateur (protocole POP3)\u00a0;</li> </ul> <p></p> <ul> <li>en [3]\u00a0: l'exp\u00e9diteur\u00a0;</li> <li>en [4]\u00a0: le destinataire\u00a0;</li> <li>en [5]\u00a0: le sujet du mail\u00a0;</li> <li>en [6]\u00a0: le contenu du mail\u00a0;</li> <li>en [7]\u00a0: pour envoyer le mail\u00a0;</li> </ul> <p></p> <ul> <li>en [8-9]\u00a0: on rel\u00e8ve le courrier de l'utilisateur [guest@localhost]\u00a0;</li> <li>en [10-15]\u00a0: le message re\u00e7u\u00a0; Nous allons envoyer \u00e9galement du courrier \u00e0 l'utilisateur [pymailparlexemple@gmail.com]. Cr\u00e9ons-lui un compte dans Thunderbird pour lire le courrier qu'il recevra\u00a0:</li> </ul> <p></p> <p></p> <ul> <li>en [4]\u00a0: mettez ce que vous voulez\u00a0;</li> <li>en [5]\u00a0: l'adresse est [pymailparlexemple@gmail.com]\u00a0;</li> <li>en [6]\u00a0: tapez le mot de passe que vous avez donn\u00e9 \u00e0 cet utilisateur lorsque vous l'avez cr\u00e9\u00e9\u00a0;</li> <li>en [7]\u00a0: validez cette configuration\u00a0;</li> </ul> <p></p> <ul> <li>en [8]\u00a0: Thunderbird a r\u00e9cup\u00e9r\u00e9 les informations suivantes dans sa base de donn\u00e9es\u00a0;</li> <li>en [9]\u00a0: le protocole de lecture du courrier n'est plus POP3 mais IMAP. La principale diff\u00e9rence entre les deux est que [POP3] ram\u00e8ne le courrier lu sur la machine locale o\u00f9 se trouve le lecteur de courrier et le supprime du serveur distant, alors que [IMAP] conserve le courrier sur le serveur distant\u00a0;</li> <li>en [10]\u00a0: identification du serveur SMTP\u00a0;</li> <li>en [13]\u00a0: pour avoir davantage d'informations sur les serveurs IMAP et SMTP, on passe en configuration manuelle\u00a0;</li> </ul> <p></p> <ul> <li>en [14-17]\u00a0: les caract\u00e9ristiques du serveur IMAP\u00a0;</li> <li>en [18-21]\u00a0: les caract\u00e9ristiques du serveur SMTP\u00a0;</li> <li>en [22]\u00a0: on termine la configuration\u00a0;</li> </ul> <p></p> <ul> <li>en [23-24]\u00a0: le nouveau compte Thunderbird\u00a0;</li> <li>en [26]\u00a0: on \u00e9crit un nouveau message\u00a0;</li> </ul> <p></p> <ul> <li>en [27]\u00a0: l'exp\u00e9diteur est [pymailparlexemple@gmail.com]\u00a0;</li> <li>en [28]\u00a0: le destinataire est [pymailparlexemple@gmail.com]\u00a0;</li> <li>en [29-30]\u00a0: le message\u00a0;</li> <li>en [31]\u00a0: pour l'envoyer\u00a0;</li> </ul> <p></p> <ul> <li>en [32]\u00a0: on rel\u00e8ve le courrier des diff\u00e9rents comptes\u00a0;</li> </ul> <p></p> <ul> <li> <p>en [33-36]\u00a0: le courrier re\u00e7u par l'utilisateur [pymailparlexemple@gmail.com] Nous cr\u00e9ons de m\u00eame\u00a0:</p> </li> <li> <p>un nouveau compte Gmail [pymail2parlexemple@gmail.com]\u00a0;</p> </li> <li>un nouverau compte Thunderbird [pymail2parlexemple@gmail.com] pour relever les messages de l\u2019utilisateur de m\u00eame nom\u00a0:</li> </ul> <p></p> <p></p> <p>Nous avons d\u00e9sormais les outils pour explorer les protocoles SMTP, POP3 et IMAP. Nous commen\u00e7ons par le protocole SMTP.</p>"},{"location":"fonctions-internet.html#2155-le-protocole-smtp","title":"21.5.5. Le protocole SMTP","text":"<p>Nous allons d\u00e9couvrir le protocole SMTP en examinant les logs du serveur [hMailServer]. Pour cela, nous les activons avec l\u2019outl [hmailServerAdministrator]\u00a0:</p> <p></p> <p></p> <ul> <li>en [2], les logs sont activ\u00e9s\u00a0;</li> <li>en [3-5]\u00a0: on les active pour les protocoles SMTP, POP3, IMAP\u00a0;</li> <li>en [7], on demande \u00e0 les voir\u00a0;</li> <li>en [8], ouvre le fichier de logs avec un \u00e9diteur de texte quelconque\u00a0;</li> </ul> <p></p> <p>Dans l\u2019exemple qui suit, le client sera [Thunderbird] et le serveur sera [hMailServer]. Avec Thunderbird, faites en sorte que l\u2019utilisateur [guest@localhost.com] s\u2019envoie un message \u00e0 lui-m\u00eame\u00a0:</p> <p></p> <p>Les logs sont alors les suivants\u00a0:</p> <pre><code>\"SMTPD\"    5828    22    \"2020-07-07 10:02:54.263\"    \"127.0.0.1\"    \"SENT: 220 Bienvenue sur le serveur SMTP localhost.com\"\n\"SMTPD\"    21956    22    \"2020-07-07 10:02:54.360\"    \"127.0.0.1\"    \"RECEIVED: EHLO [127.0.0.1]\"\n\"SMTPD\"    21956    22    \"2020-07-07 10:02:54.362\"    \"127.0.0.1\"    \"SENT: 250-DESKTOP-30FF5FB[nl]250-SIZE 20480000[nl]250-AUTH LOGIN[nl]250 HELP\"\n\"SMTPD\"    5828    22    \"2020-07-07 10:02:54.381\"    \"127.0.0.1\"    \"RECEIVED: MAIL FROM:&lt;guest@localhost.com&gt; SIZE=433\"\n\"SMTPD\"    5828    22    \"2020-07-07 10:02:54.386\"    \"127.0.0.1\"    \"SENT: 250 OK\"\n\"SMTPD\"    21956    22    \"2020-07-07 10:02:54.470\"    \"127.0.0.1\"    \"RECEIVED: RCPT TO:&lt;guest@localhost.com&gt;\"\n\"SMTPD\"    21956    22    \"2020-07-07 10:02:54.473\"    \"127.0.0.1\"    \"SENT: 250 OK\"\n\"SMTPD\"    21956    22    \"2020-07-07 10:02:54.478\"    \"127.0.0.1\"    \"RECEIVED: DATA\"\n\"SMTPD\"    21956    22    \"2020-07-07 10:02:54.479\"    \"127.0.0.1\"    \"SENT: 354 OK, send.\"\n\"SMTPD\"    21860    22    \"2020-07-07 10:02:54.496\"    \"127.0.0.1\"    \"SENT: 250 Queued (0.016 seconds)\"\n\"SMTPD\"    21568    22    \"2020-07-07 10:02:54.505\"    \"127.0.0.1\"    \"RECEIVED: QUIT\"\n\"SMTPD\"    21568    22    \"2020-07-07 10:02:54.506\"    \"127.0.0.1\"    \"SENT: 221 goodbye\"\n</code></pre> <p>Les lignes ci-dessus d\u00e9crivent le dialogue qui a eu lieu entre le client SMTP (le gestionnaire de courrier Thunderbird) et le serveur SMTP (hMailServer). Les lignes [SENT] indiquent ce que le serveur SMTP a envoy\u00e9 \u00e0 son client. Les lignes [RECEIVED] indiquent ce que le serveur SMTP a re\u00e7u de son client.</p> <ul> <li>ligne 1\u00a0: juste apr\u00e8s la connexion du client au serveur SMTP, celui-ci envoie le message de bienvenue \u00e0 son client\u00a0;</li> <li>ligne 2\u00a0: le client envoie la commande [EHLO] pour d\u2019identifier. Ici, il donne son adresse IP [127.0.0.1] qui d\u00e9signe la machine [localhost], \u00e7-\u00e0-d la machine qui ex\u00e9cute le client SMTP\u00a0;</li> <li>ligne 3\u00a0: le serveur envoie une s\u00e9rie de r\u00e9ponses [250]. [nl] signifie [newline] \u00e7-\u00e0-d le caract\u00e8re \\n. Les r\u00e9ponses ont la forme [250-] sauf la derni\u00e8re qui a la forme [250 ]. C\u2019est ainsi que le client SMTP sait que la r\u00e9ponse du serveur SMTP est termin\u00e9e et qu\u2019il peut envoyer une commande. La s\u00e9rie de commandes [250] avait pour but d\u2019indiquer au client SMTP une s\u00e9rie de commandes qu\u2019il pouvait utiliser\u00a0;</li> <li>ligne 4\u00a0: le client SMTP envoie la commande [MAIL FROM\u00a0: adresse_mail_exp\u00e9diteur] qui indique qui envoie le message\u00a0;</li> <li>ligne 5\u00a0: le serveur SMTP r\u00e9pond par [250 OK] indiquant qu\u2019il a compris la commande\u00a0;</li> <li>ligne 6\u00a0: le client SMTP envoie la commande [RCPT TO\u00a0: adresse_mail_destinataire] pour indiquer l\u2019adresse du destinataire\u00a0;</li> <li>ligne 7\u00a0: de nouveau le serveur SMTP indique qu\u2019il a compris la commande\u00a0;</li> <li>ligne 8\u00a0: le serveur SMTP envoie la commande [DATA]. Cela veut dire qu\u2019il va envoyer le contenu du message\u00a0;</li> <li>ligne 9\u00a0: le serveur SMTP indique par la r\u00e9ponse [354 OK] qu\u2019il est pr\u00eat \u00e0 recevoir le message. Le texte [send .] indique que le client SMTP doit terminer son message par une ligne ne contenant qu\u2019un unique point\u00a0;</li> <li>ce qu\u2019on ne vois pas ensuite, c\u2019est que le client SMTP envoie son message. Les logs ne l\u2019affichent pas\u00a0;</li> <li>ligne 10\u00a0: le client SMTP a envoy\u00e9 le point qui indique la fin du message. Le serveur SMTP lui r\u00e9pond qu\u2019il a mis le message en file d\u2019attente (queued)\u00a0;</li> <li>le client SMTP lui envoie la comande [QUIT] pour indiquer qu\u2019il va fermer la connexion\u00a0;</li> <li>ligne 12\u00a0: le serveur lui r\u00e9pond\u00a0; Maintenant que nous connaissons le dialogue client / serveur du protocole SMTP, essayons de le reproduire avec notre client [RawTcpClient]. Nous utilisons un terminal PyCharm\u00a0:</li> </ul> <p></p> <p>Etudions un nouvel exemple\u00a0:</p> <p></p> <ul> <li>le client A sera le client TCP g\u00e9n\u00e9rique [RawTcpClient]\u00a0;</li> <li>le serveur B sera le serveur de mails [hMailServer]\u00a0;</li> <li>le client A demandera au serveur B de distribuer un courrier envoy\u00e9 par l\u2019utilisateur [guest@localhost.com]\u00a0pour lui-m\u00eame\u00a0;</li> <li>nous v\u00e9rifierons que le destinataire a bien re\u00e7u le mail envoy\u00e9\u00a0; Nous lan\u00e7ons le client de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpClient.exe localhost 25 --quit bye\nClient [DESKTOP-30FF5FB:53122] connect\u00e9 au serveur [localhost-25]\nTapez vos commandes (quit pour arr\u00eater) :\n&lt;-- [220 Bienvenue sur le serveur SMTP localhost.com]\n</code></pre> <ul> <li>ligne [1], on se connecte sur le port 25 de la machine locale, l\u00e0 o\u00f9 op\u00e8re le service SMTP de [hMailServer]. l\u2019argument [--quit bye] indique que l\u2019utilisateur quittera le programme en tapant la commande [bye]. Sans cet argument, la commande de fin du programme est [quit]. Or [quit] est \u00e9galement une commande du protocole SMTP. Il nous faut donc \u00e9viter cette ambigu\u00eft\u00e9\u00a0;</li> <li>ligne [2], le client est bien connect\u00e9\u00a0;</li> <li>ligne [3], le client attend des commandes tap\u00e9es au clavier\u00a0;</li> <li>ligne [4], le serveur lui envoie son message de bienvenue\u00a0; Nous continuons le dialogue de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpClient.exe localhost 25\nClient [DESKTOP-30FF5FB:53155] connect\u00e9 au serveur [localhost-25]\nTapez vos commandes (quit pour arr\u00eater) :\n&lt;-- [220 Bienvenue sur le serveur SMTP localhost.com]\nEHLO localhost\n&lt;-- [250-DESKTOP-30FF5FB]\n&lt;-- [250-SIZE 20480000]\n&lt;-- [250-AUTH LOGIN]\n&lt;-- [250 HELP]\nMAIL FROM: guest@localhost.com\n&lt;-- [250 OK]\nRCPT TO: guest@localhost.com\n&lt;-- [250 OK]\nDATA\n&lt;-- [354 OK, send.]\nfrom: guest@localhost.com\nto: guest@localhost.com\nsubject: ceci est un test\n\nligne1\nligne2\n.\n&lt;-- [250 Queued (37.824 seconds)]\nQUIT\nFin de la connexion avec le serveur\n</code></pre> <ul> <li>en [5], le client envoie la commande [EHLO nom-de-la-machine-client]. Le serveur lui r\u00e9pond par une suite de messages de la forme [250-xx] (6). Le code [250] indique le succ\u00e8s de la commande envoy\u00e9e par le client\u00a0;</li> <li>en [10], le client indique l\u2019exp\u00e9diteur du message, ici [guest@localhost.com]\u00a0;</li> <li>en [11], la r\u00e9ponse du serveur\u00a0;</li> <li>en [12], on indique le destinataire du message, ici l\u2019utilisateur [guest@localhost.com]\u00a0;</li> <li>en [13], la r\u00e9ponse du serveur\u00a0;</li> <li>en [14], la commande [DATA] indique au serveur que le client va envoyer le contenu du message\u00a0;</li> <li>en [15], la r\u00e9ponse du serveur\u00a0;</li> <li>en [16-22], le client doit envoyer une liste de lignes de texte termin\u00e9e par une ligne ne contenant qu\u2019un unique point. Le message peut contenir des lignes [Subject:, From:, To:] (16-18) pour d\u00e9finir respectivement le sujet du message, l\u2019exp\u00e9diteur, le destinataire\u00a0;</li> <li>en [19], les ent\u00eates pr\u00e9c\u00e9dents doivent \u00eatre suivis d\u2019une ligne vide\u00a0;</li> <li>en [20-21], le texte du message\u00a0;</li> <li>en [22],  la ligne ne contenant qu\u2019un unique point qui indique la fin du message\u00a0;</li> <li>en [23], une fois que le serveur a re\u00e7u la ligne ne contenant qu\u2019un unique point, il met le message en file d\u2019attente\u00a0;</li> <li>en [24], le client indique au serveur qu\u2019il a fini\u00a0;</li> <li>en [25], on constate que le serveur a ferm\u00e9 la connexion qui le liait au client\u00a0; Maintenant v\u00e9rifions avec Thunderbird que l\u2019utilisateur [guest@localhost.com] a bien re\u00e7u le message\u00a0:</li> </ul> <p></p> <ul> <li>en [1-6], on voit  que l\u2019utilisateur [guest@localhost.com] a bien re\u00e7u le message\u00a0; Finalement, notre client [RawTcpClient] a r\u00e9ussi \u00e0 envoyer un message via le serveur SMTP [localhost]. Maintenant, utilisons la m\u00eame m\u00e9thode pour envoyer un message \u00e0 [pymailparlexemple@gmail.com]\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpClient.exe smtp.gmail.com 587\nClient [DESKTOP-30FF5FB:53210] connect\u00e9 au serveur [smtp.gmail.com-587]\nTapez vos commandes (quit pour arr\u00eater) :\n&lt;-- [220 smtp.gmail.com ESMTP w13sm643278wrr.67 - gsmtp]\nEHLO localhost\n&lt;-- [250-smtp.gmail.com at your service, [2a01:cb05:80e8:b500:3c4b:2203:91fa:9b00]]\n&lt;-- [250-SIZE 35882577]\n&lt;-- [250-8BITMIME]\n&lt;-- [250-STARTTLS]\n&lt;-- [250-ENHANCEDSTATUSCODES]\n&lt;-- [250-PIPELINING]\n&lt;-- [250-CHUNKING]\n&lt;-- [250 SMTPUTF8]\nMAIL FROM: pymailparlexemple@gmail.com\n&lt;-- [530 5.7.0 Must issue a STARTTLS command first. w13sm643278wrr.67 - gsmtp]\nQUIT\nFin de la connexion avec le serveur\n</code></pre> <ul> <li>ligne 1\u00a0: on utilise le serveur SMTP de Gmail\u00a0qui op\u00e8re sur le port 587\u00a0;</li> <li>ligne 15\u00a0: on est bloqu\u00e9s parce que le serveur SMTP nous demande de d\u00e9marrer une connexion s\u00e9curis\u00e9e ce qu\u2019on ne sait pas faire. Contrairement \u00e0 l\u2019exemple pr\u00e9c\u00e9dent, le serveur [smtp.gmail.com] (ligne 1) demande une authentification. Il n\u2019accepte comme clients que les utilisateurs enregistr\u00e9s dans le domaine [gmail.com]. Cette authentification est s\u00e9curis\u00e9e et a lieu au sein d\u2019une connexion crypt\u00e9e. Le premier exemple nous a donn\u00e9 les bases pour construire un client SMTP basique en Python. Le deuxi\u00e8me nous a montr\u00e9 que certains serveurs SMTP (la plupart en fait) n\u00e9cessitent une authentification faite avec une connexion chiffr\u00e9e.</li> </ul>"},{"location":"fonctions-internet.html#2156-scripts-smtp01-un-client-smtp-basique","title":"21.5.6. scripts [smtp/01]\u00a0: un client SMTP basique","text":"<p>Nous allons reproduire en Python ce que nous avons appris pr\u00e9c\u00e9demment du protocole SMTP.</p> <p></p> <p>Le fichier [smtp/01/config] configure l\u2019application de la fa\u00e7on suivante\u00a0:</p> <pre><code>def configure() -&gt; dict:\n    return {\n        # description : description du mail envoy\u00e9\n        # smtp-server : serveur SMTP\n        # smtp-port : port du serveur SMTP\n        # from : exp\u00e9diteur\n        # to : destinataire\n        # subject : sujet du mail\n        # message : message du mail\n        \"mails\": [\n            {\n                \"description\": \"mail to localhost via localhost\",\n                \"smtp-server\": \"localhost\",\n                \"smtp-port\": \"25\",\n                \"from\": \"guest@localhost.com\",\n                \"to\": \"guest@localhost.com\",\n                \"subject\": \"to localhost via localhost\",\n                # on envoie de l'UTF-8\n                \"content-type\": 'text/plain; charset=\"utf-8\"',\n                # on teste les caract\u00e8res accentu\u00e9s\n                \"message\": \"agla\u00eb s\u00e9l\u00e9n\u00e9\\nva au march\u00e9\\nacheter des fleurs\"\n            },\n            {\n                \"description\": \"mail to gmail via gmail\",\n                \"smtp-server\": \"smtp.gmail.com\",\n                \"smtp-port\": \"587\",\n                \"from\": \"pymailparlexemple@gmail.com\",\n                \"to\": \"pymailparlexemple@gmail.com\",\n                \"subject\": \"to gmail via gmail\",\n                # on envoie de l'UTF-8\n                \"Content-type\": 'text/plain; charset=\"utf-8\"',\n                # on teste les caract\u00e8res accentu\u00e9s\n                \"message\": \"agla\u00eb s\u00e9l\u00e9n\u00e9\\nva au march\u00e9\\nacheter des fleurs\"\n            }\n        ]\n    }\n</code></pre> <ul> <li>lignes 10-35\u00a0: une liste de mails \u00e0 envoyer. Pour chacun d\u2019eux on pr\u00e9cise\u00a0les informations suivantes\u00a0:</li> <li>[description]\u00a0: un texte d\u00e9crivant le mail\u00a0;</li> <li>[smtp-server]\u00a0: le serveur SMTP \u00e0 utiliser\u00a0;</li> <li>[smtp-port]\u00a0: son port de service\u00a0;</li> <li>[from]\u00a0: l\u2019exp\u00e9diteur du mail\u00a0;</li> <li>[to]\u00a0: le destinataire du mail\u00a0;</li> <li>[subject]\u00a0: le sujet du mail\u00a0;</li> <li>[content-type]\u00a0: l\u2019encodage du mail\u00a0;</li> <li>[message]\u00a0: le message du mail\u00a0; Le code [01/main] du client SMTP est le suivant\u00a0:</li> </ul> <pre><code># imports\nimport socket\n\n\n# -----------------------------------------------------------------------\ndef sendmail(mail: dict, verbose: bool):\n    # envoie message au serveur smtp smtpserver de la part de exp\u00e9diteur\n    # pour destinataire. Si verbose=True, fait un suivi des \u00e9changes client-serveur\n\n    # on laisse remonter les erreurs syst\u00e8me\n    connexion = None\n    try:\n        # nom de la machine locale (n\u00e9cessaire au protocole SMTP)\n        client = socket.gethostbyaddr(socket.gethostbyname(\"localhost\"))[0]\n        # ouverture d'une connexion sur le port 25 de smtpServer\n        connexion = socket.create_connection((mail[\"smtp-server\"], 25))\n\n        # connexion repr\u00e9sente un flux de communication bidirectionnel\n        # entre le client (ce programme) et le serveur smtp contact\u00e9\n        # ce canal est utilis\u00e9 pour les \u00e9changes de commandes et d'informations\n\n        # apr\u00e8s la connexion le serveur envoie un message de bienvenue qu'on lit\n        send_command(connexion, \"\", verbose, True)\n        # cmde ehlo:\n        send_command(connexion, f\"EHLO {client}\", verbose, True)\n        # cmde mail from:\n        send_command(connexion, f\"MAIL FROM: &lt;{mail['from']}&gt;\", verbose, True)\n        # cmde rcpt to:\n        send_command(connexion, f\"RCPT TO: &lt;{mail['to']}&gt;\", verbose, True)\n        # cmde data\n        send_command(connexion, \"DATA\", verbose, True)\n        # pr\u00e9paration message \u00e0 envoyer\n        # il doit contenir les lignes\n        # From: exp\u00e9diteur\n        # To: destinataire\n        # ligne vide\n        # Message\n        # .\n        data = f\"{mail['message']}\"\n        # envoi message\n        send_command(connexion, data, verbose, False)\n        # envoi .\n        send_command(connexion, \"\\r\\n.\\r\\n\", verbose, False)\n        # cmde quit\n        send_command(connexion, \"QUIT\", verbose, True)\n        # fin\n    finally:\n        # fermeture connexion\n        if connexion:\n            connexion.close()\n\n\n# --------------------------------------------------------------------------\ndef send_command(connexion: socket, commande: str, verbose: bool, with_rclf: bool):\n    # envoie commande dans le canal connexion\n    # mode verbeux si verbose=True\n    # si with_rclf=True, ajoute la s\u00e9quence rclf \u00e0 commande\n\n    # donn\u00e9es\n    rclf = \"\\r\\n\" if with_rclf else \"\"\n    # envoi cmde si commande non vide\n    if commande:\n        # on laisse remonter les erreurs syst\u00e8me\n        #\n        # envoi commande\n        connexion.send(bytearray(f\"{commande}{rclf}\", 'utf-8'))\n        # \u00e9cho \u00e9ventuel\n        if verbose:\n            affiche(commande, 1)\n        # lecture r\u00e9ponse de moins de 1000 caract\u00e8res\n        reponse = str(connexion.recv(1000), 'utf-8')\n        # \u00e9cho \u00e9ventuel\n        if verbose:\n            affiche(reponse, 2)\n        # r\u00e9cup\u00e9ration code erreur\n        codeErreur = int(reponse[0:3])\n        # erreur renvoy\u00e9e par le serveur ?\n        if codeErreur &gt;= 500:\n            # on lance une exception avec l'erreur\n            raise BaseException(reponse[4:])\n        # retour sans erreur\n\n\n# --------------------------------------------------------------------------\ndef affiche(echange: str, sens: int):\n    # affiche \u00e9change ? l'\u00e9cran\n    # si sens=1 affiche --&gt;echange\n    # si sens=2 affiche &lt;-- \u00e9change sans les 2 derniers caract\u00e8res rclf\n    if sens == 1:\n        print(f\"--&gt; [{echange}]\")\n        return\n    elif sens == 2:\n        l = len(echange)\n        print(f\"&lt;-- [{echange[0:l - 2]}]\")\n        return\n\n\n# main ----------------------------------------------------------------\n\n# client SMTP (SendMail Transfer Protocol) permettant d'envoyer un message\n# les infos sont prises dans un fichier config contenant les informations suivantes pour chaque serveur\n\n# description : description du mail envoy\u00e9\n# smtp-server : serveur SMTP\n# smtp-port : port du serveur SMTP\n# from : exp\u00e9diteur\n# to : destinataire\n# subject : sujet du mail\n# message : message du mail\n\n\n# protocole de communication SMTP client-serveur\n# -&gt; client se connecte sur le port 25 du serveur smtp\n# &lt;- serveur lui envoie un message de bienvenue\n# -&gt; client envoie la commande EHLO: nom de sa machine\n# &lt;- serveur r\u00e9pond OK ou non\n# -&gt; client envoie la commande mail from: &lt;exp?diteur&gt;\n# &lt;- serveur r\u00e9pond OK ou non\n# -&gt; client envoie la commande rcpt to: &lt;destinataire&gt;\n# &lt;- serveur r\u00e9pond OK ou non\n# -&gt; client envoie la commande data\n# &lt;- serveur r\u00e9pond OK ou non\n# -&gt; client envoie ttes les lignes de son message et termine avec une ligne contenant le seul caract\u00e8re .\n# &lt;- serveur r\u00e9pond OK ou non\n# -&gt; client envoie la commande quit\n# &lt;- serveur r\u00e9pond OK ou non\n\n# les r\u00e9ponses du serveur ont la forme xxx texte o\u00f9 xxx est un nombre \u00e0 3 chiffres. Tout nombre xxx &gt;=500\n# signale une erreur. La r\u00e9ponse peut comporter plusieurs lignes commen\u00e7ant toutes par xxx- sauf la derni\u00e8re\n# de la forme xxx(espace)\n\n# les lignes de texte \u00e9chang\u00e9es doivent se terminer par les caract\u00e9res RC(#13) et LF(#10)\n\n# configuration de l'application\nimport config\nconfig = config.configure()\n\n# on traite les mails un par un\nfor mail in config['mails']:\n    try:\n        # logs\n        print(\"----------------------------------\")\n        print(f\"Envoi du message [{mail['description']}]\")\n        # pr\u00e9paration du message \u00e0 envoyer\n        mail[\n            \"message\"] = f\"From: {mail['from']}\\nTo: {mail['to']}\\n\" \\\n                         f\"Subject: {mail['subject']}\\n\" \\\n                         f\"Content-type: {mail['content-type']}\" \\\n                         f\"\\n\\n{mail['message']}\"\n        # envoi du message en mode verbeux\n        sendmail(mail, True)\n        # fin\n        print(\"Message envoy\u00e9...\")\n    except BaseException as erreur:\n        # on affiche l'erreur\n        print(f\"L'erreur suivante s'est produite : {erreur}\")\n    finally:\n        pass\n    # mail suivant\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 134-136\u00a0: on configure l\u2019application\u00a0;</li> <li>lignes 139-151\u00a0: on tarite tous les mails trouv\u00e9s dans la configuration\u00a0;</li> <li>lignes 141-143\u00a0: on affiche ce qu'on va faire\u00a0;</li> <li>lignes 144-149\u00a0: on d\u00e9finit le message \u00e0 envoyer. Le message [message] est pr\u00e9c\u00e9d\u00e9 des ent\u00eates [From, To, Subject, Content-type]\u00a0;</li> <li>ligne 151\u00a0: l\u2019envoi du mail est assur\u00e9 par la fonction [sendmail] qui admet deux param\u00e8tres\u00a0:</li> <li>[mail]\u00a0:  le dictionnaire contenant les informations n\u00e9cessaires \u00e0 l\u2019envoi\u00a0du mail\u00a0;</li> <li>[verbose]\u00a0: un bool\u00e9en indiquant si les \u00e9changes client / serveur doivent \u00eatre ou non logu\u00e9s sur la console\u00a0;</li> <li>lignes 154-156\u00a0: on arr\u00eate toutes les exceptions qui sortent de la fonction [sendmail]. Elles sont affich\u00e9es\u00a0;</li> <li>ligne 6\u00a0: [mail] est le dictionnaire d\u00e9crivant le mail \u00e0 envoyer\u00a0;</li> <li>ligne 14\u00a0: dans le protocole SMTP, le client doit envoyer son non. On r\u00e9cup\u00e8re ici le nom de la machine locale qui va servir de client\u00a0;</li> <li>ligne 16\u00a0: connexion au serveur SMTP \u00e0 qui le message va \u00eatre envoy\u00e9\u00a0;</li> <li>lignes 22-23\u00a0: si la connexion s'est faite avec le serveur SMTP, celui-ci va envoyer un message de bienvenue qu'on lit ici\u00a0;</li> <li>la fonction [sendmail] envoie ensuite les diff\u00e9rentes commandes que doit envoyer un client SMTP\u00a0:</li> <li>lignes 24-25\u00a0: la commande EHLO\u00a0;</li> <li>lignes 26-27\u00a0: la commande MAIL FROM:\u00a0;</li> <li>lignes 28-29\u00a0: la commande RCPT TO:\u00a0;</li> <li>lignes 30-31\u00a0: la commande DATA\u00a0;</li> <li>lignes 32-41\u00a0: envoi du message (From, To, Subject, Content-type, texte)\u00a0;</li> <li>lignes 42-43\u00a0: envoi du point final\u00a0;</li> <li>lignes 44-457\u00a0: la commande QUIT qui termine le dialogue du client avec le serveur SMTP\u00a0;</li> <li>l'ex\u00e9cution de [sendmail] s'ex\u00e9cute dans un [try / finally] qui laisse remonter toutes les exceptions au code appelant. On sait que celui-ci les arr\u00eate toutes pour les afficher\u00a0;</li> <li>lignes 48-50\u00a0: lib\u00e9ration des ressources\u00a0;</li> <li>ligne 54\u00a0: la fonction [send_command] est charg\u00e9e d\u2019envoyer les commandes du client au serveur SMTP. Elle admet quatre param\u00e8tres\u00a0:</li> <li>[connexion]\u00a0: la connexion qui relie le client au serveur\u00a0;</li> <li>[commande]\u00a0: la commande \u00e0 envoyer\u00a0;</li> <li>[verbose]\u00a0: si TRUE alors les \u00e9changes client / serveur sont logu\u00e9s sur la console\u00a0;</li> <li>[with_rclf]\u00a0: si TRUE, envoie la commande termin\u00e9e par la s\u00e9quence \\r\\n. C\u2019est n\u00e9cessaire pour toutes les commandes du protocole SMTP, mais [send_command] sert aussi \u00e0 envoyer le message. L\u00e0 on n\u2019ajoute pas  la s\u00e9quence \\r\\n\u00a0;</li> <li>ligne 62\u00a0: la commande n'est envoy\u00e9e que si elle est non vide\u00a0;</li> <li>lignes 65-66\u00a0: la commande est envoy\u00e9e au serveur\u00a0sous la forme d\u2019une cha\u00eene d\u2019octets UTF-8\u00a0;</li> <li>lignes 70-71\u00a0: lecture de de l\u2019ensemble des lignes de la r\u00e9ponse. On suppose qu\u2019elle fait moins de 1000 caract\u00e8res. La r\u00e9ponse peut comporter plusieurs lignes. Chaque ligne a la forme XXX-YYY o\u00f9 XXX est un code num\u00e9rique sauf la derni\u00e8re ligne de la r\u00e9ponse qui a la forme XXX YYY (absence du caract\u00e8re -)\u00a0;</li> <li>lignes 76\u00a0: lecture du code d'erreur XXX de la 1re ligne\u00a0;</li> <li>lignes 78-80\u00a0: si le code num\u00e9rique XXX est sup\u00e9rieur \u00e0 500, alors le serveur a renvoy\u00e9 une erreur. On lance alors une exception\u00a0; R\u00e9sultats</li> </ul> <p>L\u2019ex\u00e9cution du script donne les r\u00e9sultats console suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/inet/smtp/01/main.py\n----------------------------------\nEnvoi du message [mail to localhost via localhost]\n--&gt; [EHLO DESKTOP-30FF5FB]\n&lt;-- [220 Bienvenue sur le serveur SMTP localhost.com]\n--&gt; [MAIL FROM: &lt;guest@localhost.com&gt;]\n&lt;-- [250-DESKTOP-30FF5FB\n250-SIZE 20480000\n250-AUTH LOGIN\n250 HELP]\n--&gt; [RCPT TO: &lt;guest@localhost.com&gt;]\n&lt;-- [250 OK]\n--&gt; [DATA]\n&lt;-- [250 OK]\n--&gt; [From: guest@localhost.com\nTo: guest@localhost.com\nSubject: to localhost via localhost\nContent-type: text/plain; charset=\"utf-8\"\n\nagla\u00eb s\u00e9l\u00e9n\u00e9\nva au march\u00e9\nacheter des fleurs]\n&lt;-- [354 OK, send.]\n--&gt; [\n.\n]\n&lt;-- [250 Queued (0.000 seconds)]\n--&gt; [QUIT]\n&lt;-- [221 goodbye]\nMessage envoy\u00e9...\n----------------------------------\nEnvoi du message [mail to gmail via gmail]\n--&gt; [EHLO DESKTOP-30FF5FB]\n&lt;-- [220 smtp.gmail.com ESMTP u1sm1364433wrb.78 - gsmtp]\n--&gt; [MAIL FROM: &lt;pymailparlexemple@gmail.com&gt;]\n&lt;-- [250-smtp.gmail.com at your service, [2a01:cb05:80e8:b500:3c4b:2203:91fa:9b00]\n250-SIZE 35882577\n250-8BITMIME\n250-STARTTLS\n250-ENHANCEDSTATUSCODES\n250-PIPELINING\n250-CHUNKING\n250 SMTPUTF8]\n--&gt; [RCPT TO: &lt;pymailparlexemple@gmail.com&gt;]\n&lt;-- [530 5.7.0 Must issue a STARTTLS command first. u1sm1364433wrb.78 - gsmtp]\nL'erreur suivante s'est produite : 5.7.0 Must issue a STARTTLS command first. u1sm1364433wrb.78 - gsmtp\n\n\nProcess finished with exit code 0\n</code></pre> <ul> <li>lignes 3-30\u00a0: l\u2019utilisation du serveur SMTP [hMailServer] pour envoyer un mail \u00e0 [guest@localhost] se passe bien\u00a0;</li> <li>lignes 32-46\u00a0: l\u2019utilisation du serveur SMTP [smtp.gmail.com] pour envoyer un mail \u00e0 [pymailparlexemple@gmail.com] ne se passe pas bien\u00a0: en ligne 45, le serveur SMTP envoie un code d\u2019erreur 530 avec un message d\u2019erreur. Celui-ci indique que le client SMTP doit au pr\u00e9alable s\u2019authentifier via une connexion s\u00e9curis\u00e9e. Notre client ne l\u2019a pas fait et est donc refus\u00e9\u00a0; Les r\u00e9sultats dans Thunderbird sont les suivants\u00a0:</li> </ul> <p></p>"},{"location":"fonctions-internet.html#2157-scripts-smtp02-un-lient-smtp-ecrit-avec-la-bibliotheque-smtplib","title":"21.5.7. scripts [smtp/02]\u00a0: un lient SMTP \u00e9crit avec la biblioth\u00e8que [smtplib]","text":"<p>Le client pr\u00e9c\u00e9dent souffre d'au moins deux insuffisances\u00a0:</p> <ul> <li>il ne sait pas utiliser une connexion s\u00e9curis\u00e9e si le serveur la r\u00e9clame\u00a0;</li> <li>il ne sait pas joindre des attachements au message\u00a0; Nous allons traiter la premi\u00e8re insuffisance dans le script [smtp/02]. Dans notre nouveau script nous allons utiliser le module Python [smtplib].</li> </ul> <p>Le script [smtp/02/main] utilisera le fichier de configuration jSON [smtp/02/config] suivant\u00a0:</p> <pre><code>def configure() -&gt; dict:\n    return {\n        # description : description du mail envoy\u00e9\n        # smtp-server : serveur SMTP\n        # smtp-port : port du serveur SMTP\n        # from : exp\u00e9diteur\n        # to : destinataire\n        # subject : sujet du mail\n        # message : message du mail\n        \"mails\": [\n            {\n                \"description\": \"mail to localhost via localhost avec smtplib\",\n                \"smtp-server\": \"localhost\",\n                \"smtp-port\": \"25\",\n                \"from\": \"guest@localhost.com\",\n                \"to\": \"guest@localhost.com\",\n                \"subject\": \"to localhost via localhost avec smtplib\",\n                # on teste les caract\u00e8res accentu\u00e9s\n                \"message\": \"agla\u00eb s\u00e9l\u00e9n\u00e9\\nva au march\u00e9\\nacheter des fleurs\",\n            },\n            {\n                \"description\": \"mail to gmail via gmail avec smtplib\",\n                \"smtp-server\": \"smtp.gmail.com\",\n                \"smtp-port\": \"587\",\n                \"from\": \"pymail2parlexemple@gmail.com\",\n                \"to\": \"pymail2parlexemple@gmail.com\",\n                \"subject\": \"to gmail via gmail avec smtplib\",\n                # on teste les caract\u00e8res accentu\u00e9s\n                \"message\": \"agla\u00eb s\u00e9l\u00e9n\u00e9\\nva au march\u00e9\\nacheter des fleurs\",\n                # smtp avec authentification\n                \"user\": \"pymail2parlexemple@gmail.com\",\n                \"password\": \"#6prIlh@1QZ3TG\",\n            }\n        ]\n    }\n</code></pre> <p>On retrouve les m\u00eames rubriques que dans le fichier [smtp/01/config] avec deux rubriques suppl\u00e9mentaires\u00a0lorsque el serveur SMTP demande une authentification\u00a0:</p> <ul> <li>ligne 31, [user]\u00a0: le nom de l\u2019utilisateur qui authentifie la connexion\u00a0;</li> <li>ligne 32, [password]\u00a0: son mot de passe\u00a0; Ces deux rubriques ne sont pr\u00e9sentes que si le serveur SMTP contact\u00e9 exige une authentification. Celle-ci se fait alors au-travers d'une connexion s\u00e9curis\u00e9e.</li> </ul> <p>Le code du script [smtp/02/main.py] est le suivant\u00a0:</p> <pre><code># imports\nimport smtplib\nfrom email.mime.text import MIMEText\nfrom email.utils import formatdate\n\n\n# -----------------------------------------------------------------------\ndef sendmail(mail: dict, verbose: True):\n    # envoie message au serveur smtp smtpserver de la part de exp\u00e9diteur\n    # pour destinataire. Si verbose=True, fait un suivi des \u00e9changes client-serveur\n\n    # on utilise la biblioth\u00e9que smtplib\n    # on laisse remonter les exceptions\n    #\n    # le serveur SMTP\n    server = smtplib.SMTP(mail[\"smtp-server\"])\n    # mode verbose\n    server.set_debuglevel(verbose)\n    # connexion s\u00e9curis\u00e9e ?\n    if \"user\" in mail:\n        # connexion s\u00e9curis\u00e9e\n        server.starttls()\n        # EHLO commande + authentification\n        server.login(mail[\"user\"], mail[\"password\"])\n\n   # construction d'un message Multipart - c'est ce message qui Multipart sera envoy\u00e9\n    msg = MIMEText(mail[\"message\"])\n    msg['from'] = mail[\"from\"]\n    msg['to'] = mail[\"to\"]\n    msg['date'] = formatdate(localtime=True)\n    msg['subject'] = mail[\"subject\"]\n    # on envoie le message\n    server.send_message(msg)\n    # on quitte\n    server.quit()\n\n\n# main ----------------------------------------------------------------\n\n# les infos sont prises dans un fichier config contenant les informations suivantes pour chaque serveur\n\n# description : description du mail envoy\u00e9\n# smtp-server : serveur SMTP\n# smtp-port : port du serveur SMTP\n# from : exp\u00e9diteur\n# to : destinataire\n# subject : sujet du mail\n# content-type : encodage du mail\n# message : message du mail\n\n\n# configurationn de l'application\nimport config\nconfig = config.configure()\n\n# on traite les mails un par un\nfor mail in config['mails']:\n    try:\n        # logs\n        print(\"----------------------------------\")\n        print(f\"Envoi du message [{mail['description']}]\")\n        # envoi du message en mode verbeux\n        sendmail(mail, True)\n        # fin\n        print(\"Message envoy\u00e9...\")\n    except BaseException as erreur:\n        # on affiche l'erreur\n        print(f\"L'erreur suivante s'est produite : {erreur}\")\n    finally:\n        pass\n    # mail suivant\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 8-35\u00a0: seule la fonction [sendmail] est utilis\u00e9e. Elle va d\u00e9sormais utiliser le module [smtplib] (ligne 2)\u00a0;</li> <li>ligne 16\u00a0: connexion au serveur SMTP\u00a0;</li> <li>ligne 18\u00a0: si [verbose=True], les \u00e9changes client / serveur seront affich\u00e9s sur la console\u00a0;</li> <li>lignes 20-24\u00a0: on fait l'\u00e9ventuelle authentification si le serveur SMTP l'exige\u00a0;</li> <li>ligne 22\u00a0: l'authentification se fait au travers d'une connexion s\u00e9curis\u00e9e\u00a0;</li> <li>ligne 24\u00a0: authentification\u00a0;</li> <li>lignes 26-33\u00a0: envoi du message. Le dialogue vu avec le script [smtp/01/main] va alors se d\u00e9rouler. S'il y a eu authentification, il se d\u00e9roulera au sein d'une connexion s\u00e9curis\u00e9e\u00a0;</li> <li> <p>ligne 35\u00a0: on termine le dialogue client / serveur\u00a0; Avant d\u2019ex\u00e9cuter le script [smtp/02/main], vous devez modifier la configuration du compte Gmail [pymailparlexemple@gmail.com]\u00a0:</p> </li> <li> <p>connectez-vous au compte Gmail [pymailparlexemple@gmail.com]\u00a0;</p> </li> <li>modifiez la configuration suivante\u00a0:</li> </ul> <p></p> <ul> <li>en [2], autorisez les applications moins s\u00e9curis\u00e9es \u00e0 acc\u00e9der au compte\u00a0; Faites la m\u00eame chose avec le second compte Gmail [pymail2parlexemple@gmail.com].</li> </ul> <p>R\u00e9sultats</p> <p>Lorsqu\u2019on ex\u00e9cute le script [smtp/02/main] on obtient les r\u00e9sultats console suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/inet/smtp/02/main.py\n----------------------------------\nEnvoi du message [mail to localhost via localhost avec smtplib]\nsend: 'ehlo [192.168.43.163]\\r\\n'\nreply: b'250-DESKTOP-30FF5FB\\r\\n'\nreply: b'250-SIZE 20480000\\r\\n'\nreply: b'250-AUTH LOGIN\\r\\n'\nreply: b'250 HELP\\r\\n'\nreply: retcode (250); Msg: b'DESKTOP-30FF5FB\\nSIZE 20480000\\nAUTH LOGIN\\nHELP'\nsend: 'mail FROM:&lt;guest@localhost.com&gt; size=310\\r\\n'\nreply: b'250 OK\\r\\n'\nreply: retcode (250); Msg: b'OK'\nsend: 'rcpt TO:&lt;guest@localhost.com&gt;\\r\\n'\nreply: b'250 OK\\r\\n'\nreply: retcode (250); Msg: b'OK'\nsend: 'data\\r\\n'\nreply: b'354 OK, send.\\r\\n'\nreply: retcode (354); Msg: b'OK, send.'\ndata: (354, b'OK, send.')\nsend: b'Content-Type: text/plain; charset=\"utf-8\"\\r\\nMIME-Version: 1.0\\r\\nContent-Transfer-Encoding: base64\\r\\nfrom: guest@localhost.com\\r\\nto: guest@localhost.com\\r\\ndate: Wed, 08 Jul 2020 08:35:39 +0200\\r\\nsubject: to localhost via localhost avec smtplib\\r\\n\\r\\nYWdsYcOrIHPDqWzDqW7DqQp2YSBhdSBtYXJjaMOpCmFjaGV0ZXIgZGVzIGZsZXVycw==\\r\\n.\\r\\n'\nreply: b'250 Queued (0.000 seconds)\\r\\n'\nreply: retcode (250); Msg: b'Queued (0.000 seconds)'\ndata: (250, b'Queued (0.000 seconds)')\nsend: 'quit\\r\\n'\nreply: b'221 goodbye\\r\\n'\nreply: retcode (221); Msg: b'goodbye'\nMessage envoy\u00e9...\n----------------------------------\nEnvoi du message [mail to gmail via gmail avec smtplib]\nsend: 'ehlo [192.168.43.163]\\r\\n'\nreply: b'250-smtp.gmail.com at your service, [37.172.118.130]\\r\\n'\nreply: b'250-SIZE 35882577\\r\\n'\nreply: b'250-8BITMIME\\r\\n'\nreply: b'250-STARTTLS\\r\\n'\nreply: b'250-ENHANCEDSTATUSCODES\\r\\n'\nreply: b'250-PIPELINING\\r\\n'\nreply: b'250-CHUNKING\\r\\n'\nreply: b'250 SMTPUTF8\\r\\n'\nreply: retcode (250); Msg: b'smtp.gmail.com at your service, [37.172.118.130]\\nSIZE 35882577\\n8BITMIME\\nSTARTTLS\\nENHANCEDSTATUSCODES\\nPIPELINING\\nCHUNKING\\nSMTPUTF8'\nsend: 'STARTTLS\\r\\n'\nreply: b'220 2.0.0 Ready to start TLS\\r\\n'\nreply: retcode (220); Msg: b'2.0.0 Ready to start TLS'\nsend: 'ehlo [192.168.43.163]\\r\\n'\nreply: b'250-smtp.gmail.com at your service, [37.172.118.130]\\r\\n'\nreply: b'250-SIZE 35882577\\r\\n'\nreply: b'250-8BITMIME\\r\\n'\nreply: b'250-AUTH LOGIN PLAIN XOAUTH2 PLAIN-CLIENTTOKEN OAUTHBEARER XOAUTH\\r\\n'\nreply: b'250-ENHANCEDSTATUSCODES\\r\\n'\nreply: b'250-PIPELINING\\r\\n'\nreply: b'250-CHUNKING\\r\\n'\nreply: b'250 SMTPUTF8\\r\\n'\nreply: retcode (250); Msg: b'smtp.gmail.com at your service, [37.172.118.130]\\nSIZE 35882577\\n8BITMIME\\nAUTH LOGIN PLAIN XOAUTH2 PLAIN-CLIENTTOKEN OAUTHBEARER XOAUTH\\nENHANCEDSTATUSCODES\\nPIPELINING\\nCHUNKING\\nSMTPUTF8'\nsend: 'AUTH PLAIN AHB5bWFpbDJwYXJsZXhlbXBsZUBnbWFpbC5jb20AIzZwcklsaEQmQDFRWjNURw==\\r\\n'\nreply: b'235 2.7.0 Accepted\\r\\n'\nreply: retcode (235); Msg: b'2.7.0 Accepted'\nsend: 'mail FROM:&lt;pymail2parlexemple@gmail.com&gt; size=320\\r\\n'\nreply: b'250 2.1.0 OK e5sm4132618wrs.33 - gsmtp\\r\\n'\nreply: retcode (250); Msg: b'2.1.0 OK e5sm4132618wrs.33 - gsmtp'\nsend: 'rcpt TO:&lt;pymail2parlexemple@gmail.com&gt;\\r\\n'\nreply: b'250 2.1.5 OK e5sm4132618wrs.33 - gsmtp\\r\\n'\nreply: retcode (250); Msg: b'2.1.5 OK e5sm4132618wrs.33 - gsmtp'\nsend: 'data\\r\\n'\nreply: b'354  Go ahead e5sm4132618wrs.33 - gsmtp\\r\\n'\nreply: retcode (354); Msg: b'Go ahead e5sm4132618wrs.33 - gsmtp'\ndata: (354, b'Go ahead e5sm4132618wrs.33 - gsmtp')\nsend: b'Content-Type: text/plain; charset=\"utf-8\"\\r\\nMIME-Version: 1.0\\r\\nContent-Transfer-Encoding: base64\\r\\nfrom: pymail2parlexemple@gmail.com\\r\\nto: pymail2parlexemple@gmail.com\\r\\ndate: Wed, 08 Jul 2020 08:35:40 +0200\\r\\nsubject: to gmail via gmail avec smtplib\\r\\n\\r\\nYWdsYcOrIHPDqWzDqW7DqQp2YSBhdSBtYXJjaMOpCmFjaGV0ZXIgZGVzIGZsZXVycw==\\r\\n.\\r\\n'\nreply: b'250 2.0.0 OK  1594190139 e5sm4132618wrs.33 - gsmtp\\r\\n'\nreply: retcode (250); Msg: b'2.0.0 OK  1594190139 e5sm4132618wrs.33 - gsmtp'\ndata: (250, b'2.0.0 OK  1594190139 e5sm4132618wrs.33 - gsmtp')\nsend: 'quit\\r\\n'\nMessage envoy\u00e9...\nreply: b'221 2.0.0 closing connection e5sm4132618wrs.33 - gsmtp\\r\\n'\nreply: retcode (221); Msg: b'2.0.0 closing connection e5sm4132618wrs.33 - gsmtp'\n\nProcess finished with exit code 0\n</code></pre> <ul> <li>ligne 40\u00a0: le client [smtplib] commence le dialogue pour \u00e9tablir une liaison crypt\u00e9e avec le serveur SMTP, ce qu\u2019on n\u2019avait pas su faire dans le script [smtp/main/01]\u00a0;</li> <li>sinon on retouve les commandes connues du protocole SMTP\u00a0; Si on consulte le compte Gmail de l\u2019utilisateur [pymail2parlexemple] on a la chose suivante\u00a0:</li> </ul> <p></p>"},{"location":"fonctions-internet.html#2158-scripts-smtp03-gestion-des-fichiers-attaches","title":"21.5.8. scripts [smtp/03]\u00a0: gestion des fichiers attach\u00e9s","text":"<p>Nous compl\u00e9tons le script [smtp/02/main] afin que le mail envoy\u00e9 puisse avoir des fichiers attach\u00e9s.</p> <p></p> <p>Le script [smtp/03/main] est configur\u00e9 par le script [smtp/03/config] suivant\u00a0:</p> <pre><code>import os\n\n\ndef configure() -&gt; dict:\n    # configuration de l'application\n    script_dir = os.path.dirname(os.path.abspath(__file__))\n\n    return {\n        # description : description du mail envoy\u00e9\n        # smtp-server : serveur SMTP\n        # smtp-port : port du serveur SMTP\n        # from : exp\u00e9diteur\n        # to : destinataire\n        # subject : sujet du mail\n        # message : message du mail\n        \"mails\": [\n            {\n                \"description\": \"mail to gmail via gmail avec smtplib\",\n                \"smtp-server\": \"smtp.gmail.com\",\n                \"smtp-port\": \"587\",\n                \"from\": \"pymail2parlexemple@gmail.com\",\n                \"to\": \"pymail2parlexemple@gmail.com\",\n                \"subject\": \"to gmail via gmail avec smtplib\",\n                # on teste les caract\u00e8res accentu\u00e9s\n                \"message\": \"agla\u00eb s\u00e9l\u00e9n\u00e9\\nva au march\u00e9\\nacheter des fleurs\",\n                # smtp avec authentification\n                \"user\": \"pymail2parlexemple@gmail.com\",\n                \"password\": \"#6prIlhD&amp;@1QZ3TG\",\n                # ici, il faut mettre des chemins absolus pour les fichiers attach\u00e9s\n                \"attachments\": [\n                    f\"{script_dir}/attachments/fichier attach\u00e9.docx\",\n                    f\"{script_dir}/attachments/fichier attach\u00e9.pdf\",\n                ]\n            }\n        ]\n    }\n</code></pre> <p>Le fichier [smtp/03/config] ne diff\u00e8re du fichier [smtp/02/config] utilis\u00e9 pr\u00e9c\u00e9demment que par la pr\u00e9sence facultative d'une liste [attachments] (lignes 30-32) qui d\u00e9signe la liste des fichiers \u00e0 attacher au message \u00e0 envoyer.</p> <p>Le script [smtp/03/main] est le suivant\u00a0:</p> <pre><code># imports\nimport email\nimport mimetypes\nimport os\nimport smtplib\nfrom email import encoders\nfrom email.mime.audio import MIMEAudio\nfrom email.mime.base import MIMEBase\nfrom email.mime.image import MIMEImage\nfrom email.mime.message import MIMEMessage\nfrom email.mime.multipart import MIMEMultipart\nfrom email.mime.text import MIMEText\nfrom email.utils import formatdate\n\n\n\n# -----------------------------------------------------------------------\ndef sendmail(mail: dict, verbose: True):\n    # envoie mail[message] au serveur smtp mail[smtp-server] de la part de mail[from]\n    # pour mail[to]. Si verbose=True, fait un suivi des \u00e9changes client-serveur\n\n    # on utilise la biblioth\u00e9que smtplib\n    # on laisse remonter les exceptions\n    #\n    # le serveur SMTP\n    server = smtplib.SMTP(mail[\"smtp-server\"])\n    # mode verbose\n    server.set_debuglevel(verbose)\n    # connexion s\u00e9curis\u00e9e ?\n    if \"user\" in mail:\n        server.starttls()\n        server.login(mail[\"user\"], mail[\"password\"])\n\n    # construction d'un message Multipart - c'est le message qui sera envoy\u00e9\n    # credit : https://docs.python.org/3.4/library/email-examples.html\n    msg = MIMEMultipart()\n    msg['From'] = mail[\"from\"]\n    msg['To'] = mail[\"to\"]\n    msg['Date'] = formatdate(localtime=True)\n    msg['Subject'] = mail[\"subject\"]\n    # on attache le message texte au format MIMEText\n    msg.attach(MIMEText(mail[\"message\"]))\n    # on parcourt les attachements\n    for path in mail[\"attachments\"]:\n        # path doit \u00eatre un chemin absolu\n        # on devine le type du fichier attach\u00e9\n        ctype, encoding = mimetypes.guess_type(path)\n        # si on n'a pas devin\u00e9\n        if ctype is None or encoding is not None:\n            # No guess could be made, or the file is encoded (compressed), so\n            # use a generic bag-of-bits type.\n            ctype = 'application/octet-stream'\n        # on d\u00e9compose le type en maintype/subtype\n        maintype, subtype = ctype.split('/', 1)\n        # on traite les diff\u00e9rents cas\n        if maintype == 'text':\n            with open(path) as fp:\n                # Note: we should handle calculating the charset\n                part = MIMEText(fp.read(), _subtype=subtype)\n        elif maintype == 'image':\n            with open(path, 'rb') as fp:\n                part = MIMEImage(fp.read(), _subtype=subtype)\n        elif maintype == 'audio':\n            with open(path, 'rb') as fp:\n                part = MIMEAudio(fp.read(), _subtype=subtype)\n        # cas du type message / rfc822\n        elif maintype == 'message':\n            with open(path, 'rb') as fp:\n                part = MIMEMessage(email.message_from_bytes(fp.read()))\n        else:\n            # autres cas\n            with open(path, 'rb') as fp:\n                part = MIMEBase(maintype, subtype)\n                part.set_payload(fp.read())\n            # Encode the payload using Base64\n            encoders.encode_base64(part)\n        # Set the filename parameter\n        basename = os.path.basename(path)\n        part.add_header('Content-Disposition', 'attachment', filename=basename)\n        # on attache le fichier au message \u00e0 envoyer\n        msg.attach(part)\n    # tous les attachements ont \u00e9t\u00e9 faits - on envoie le message en tant que cha\u00eene de caract\u00e8res\n    server.send_message(msg)\n\n\n# main ----------------------------------------------------------------\n\n..\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 18-32\u00a0: la fonction [sendmail] reste ce qu'elle \u00e9tait lorsqu'il n'y avait pas d'attachements\u00a0;</li> <li>ligne 35\u00a0: le code qui suit est tir\u00e9 d'une documentation officielle de Python\u00a0;</li> <li>ligne 36\u00a0: le message qui va \u00eatre envoy\u00e9 va comprendre plusieurs parties\u00a0: du texte et des fichiers attach\u00e9s. On appelle cela un message [Multipart]\u00a0;</li> <li>lignes 37-40\u00a0: on trouve dans le message [Multipart] les champs habituels de tout mail\u00a0;</li> <li>ligne 42\u00a0: les diff\u00e9rentes parties du message [Multipart] [msg] sont attach\u00e9es au message par la m\u00e9thode [msg.attach] (ligne 81). Les parties attach\u00e9es peuvent \u00eatre de toute nature. Celles-ci sont caract\u00e9ris\u00e9es par un type MIME. Le type MIME d'un texte ordinaire est le type [MIMEText]\u00a0;</li> <li>lignes 44-81\u00a0: on va attacher au message [msg Multipart] tous les attachements du message \u00e0 envoyer (ligne 81)\u00a0;</li> <li>ligne 44\u00a0: [path] repr\u00e9sente le chemin absolu du fichier \u00e0 attacher\u00a0;</li> <li>ligne 47\u00a0: pour trouver le type MIME \u00e0 utiliser pour la partie \u00e0 attacher, on va utiliser le suffixe (.docx, .php\u2026) du fichier \u00e0 attacher. La m\u00e9thode [mimetypes.guess_type] fait ce travail. Elle rend deux informations\u00a0:</li> <li>[ctype]\u00a0: le type MIME du fichier\u00a0;</li> <li>[encoding]\u00a0: une information sur son encodage\u00a0;</li> <li>lignes 49-52\u00a0: au cas o\u00f9 on ne peut pas d\u00e9terminer le type MIME du fichier, on dit que c'est un fichier binaire (ligne 52)\u00a0;</li> <li>ligne 54\u00a0: le type MIME d\u2019un fichier se d\u00e9compose en type principal / type secondaire, par exemple [application/pdf]. On s\u00e9pare ces deux \u00e9l\u00e9ments\u00a0;</li> <li>lignes 56-76\u00a0: on traite diff\u00e9rents cas selon la valeur du type MIME principal. Par exemple, dans le cas [application/pdf] d'un fichier PDF, on va ex\u00e9cuter les lignes 70-76\u00a0:</li> <li>lignes 56-59\u00a0: le cas o\u00f9 le fichier attach\u00e9 est un fichier texte. Dans ce cas on cr\u00e9e un \u00e9l\u00e9ment de  type [MIMEText] de contenu [fp.read]\u00a0;</li> <li>lignes 60-62\u00a0: le cas o\u00f9 le fichier contient une image. Dans ce cas on cr\u00e9e un \u00e9l\u00e9ment de  type [MIMEImage] de contenu [fp.read]\u00a0;</li> <li>lignes 63-65\u00a0: le cas o\u00f9 le fichier est un fichier audio. Dans ce cas on cr\u00e9e un \u00e9l\u00e9ment de  type [MIMEAudio] de contenu [fp.read]\u00a0;</li> <li>lignes 66-69\u00a0: le cas o\u00f9 le fichier est un mail. Dans ce cas on cr\u00e9e un \u00e9l\u00e9ment de  type [MIMEMessage] (ligne 69) de contenu [email.message_from_bytes(fp.read())]. Contrairement aux cas pr\u00e9c\u00e9dents o\u00f9 le contenu de l\u2019\u00e9l\u00e9ment MIME \u00e9tait le contenu binaire du fichier associ\u00e9, ici le contenu de l\u2019\u00e9l\u00e9ment MIMEMessage est de type [email.message.Message]\u00a0;</li> <li>lignes 70-76\u00a0: les autres cas. Cela comprend par exemple les fichiers Word et PDF de notre exemple\u00a0;</li> <li>ligne 72\u00a0: le fichier \u00e0 attacher est ouvert en mode binaire (rb=read binary)\u00a0;</li> <li>ligne 74\u00a0: [fp.read] lit la totalit\u00e9 du fichier binaire\u00a0;</li> <li>lignes 72-74\u00a0: la structure [with open(\u2026) as file] fait deux choses\u00a0:</li> <li>elle ouvre le fichier et lui donne le descripteur [file]\u00a0;</li> <li>elle assure qu'\u00e0 la sortie du [with], erreur ou pas, le descripteur [file] sera ferm\u00e9. C'est donc une alternative \u00e0 la structure [try file=open(\u2026)/ finally]\u00a0;</li> <li>ligne 73\u00a0: on cr\u00e9e un nouvel \u00e9l\u00e9ment [part] \u00e0 incorporer au message Multipart. On utilise ici la classe [MIMEBase] et on passe au constructeur les \u00e9l\u00e9ments [maintype, subtype] d\u00e9termin\u00e9s ligne 54\u00a0;</li> <li>ligne 74\u00a0: l\u2019\u00e9lement \u00e0 incorporer dans le message Multipart doit avoir un contenu. Celui-ci peut \u00eatre initialis\u00e9 avec la m\u00e9thode [set_payload]\u00a0;</li> <li>lignes 75-76\u00a0: les fichiers attach\u00e9s doivent subir un encodage 7 bits. En effet, historiquement certains serveurs SMTP ne supportaient que des caract\u00e8res cod\u00e9s sur 7 bits. Ici c\u2019est le codage appel\u00e9 \u2018Base64\u2019 qui est utilis\u00e9\u00a0;</li> <li>ligne 77\u00a0: \u00e0 partir de cette ligne, le traitement est comment \u00e0 tous les types MIME que nous avons cr\u00e9\u00e9s aux lignes 56-76 [MIMEMessage, MIMEImage, MIMEAudio, MIMEBase, MIMEText]\u00a0; </li> <li>ligne 79\u00a0: l\u2019\u00e9l\u00e9ment \u00e0 ajouter dans le message Multipart a un ent\u00eate le d\u00e9crivant. On indique ici que l\u2019\u00e9l\u00e9ment ajout\u00e9 correspond \u00e0 un fichier attach\u00e9. Le nom de ce fichier est le troisi\u00e8me param\u00e8tre pass\u00e9 \u00e0 la m\u00e9thode [add_header]. Le nom de ce fichier est souvent utilis\u00e9 par les lecteurs de courrier pour enregistrer, sous ce nom, le fichier attach\u00e9 dans le syst\u00e8me de fichiers du lecteur. On a pour l\u2019instant travaill\u00e9 avec le nom absolu du fichie attach\u00e9. Ici on passe simplement son nom sans son chemin (ligne 78)\u00a0;</li> <li>ligne 81\u00a0: le binaire du fichier est incorpor\u00e9 dans le message [msg Multipart]\u00a0;</li> <li>ligne 83\u00a0: lorsque tous les parties du message ont \u00e9t\u00e9 attach\u00e9es au [msg Multipart], celui-ci est envoy\u00e9\u00a0; R\u00e9sultats</li> </ul> <p>Si on ex\u00e9cute le script [smtp/03/main] avec le fichier [smtp/02/config] d\u00e9j\u00e0 pr\u00e9sent\u00e9, le compte [pymail2parlexemple@gmail.com] re\u00e7oit ceci\u00a0:</p> <p></p> <p>On voit les fichiers attach\u00e9s en [4, 9-11].</p> <p>Montrons un exemple maintenant avec un mail attach\u00e9. Nous allons sauvegarder le mail re\u00e7u en [3] ci-dessus\u00a0:</p> <p></p> <p>Nous sauvegardons le mail sous le nom [mail attach\u00e9 1.eml] dans le dossier [smtp/03/attachments].</p> <p>Nous modifions maintenant le fichier [smtp/03/config] de la fa\u00e7on suivante\u00a0:</p> <pre><code>import os\n\n\ndef configure() -&gt; dict:\n    # configuration de l'application\n    script_dir = os.path.dirname(os.path.abspath(__file__))\n\n    return {\n        # description : description du mail envoy\u00e9\n        # smtp-server : serveur SMTP\n        # smtp-port : port du serveur SMTP\n        # from : exp\u00e9diteur\n        # to : destinataire\n        # subject : sujet du mail\n        # message : message du mail\n        \"mails\": [\n            {\n                \"description\": \"mail to gmail via gmail avec smtplib\",\n                \"smtp-server\": \"smtp.gmail.com\",\n                \"smtp-port\": \"587\",\n                \"from\": \"pymail2parlexemple@gmail.com\",\n                \"to\": \"pymail2parlexemple@gmail.com\",\n                \"subject\": \"to gmail via gmail avec smtplib\",\n                # on teste les caract\u00e8res accentu\u00e9s\n                \"message\": \"agla\u00eb s\u00e9l\u00e9n\u00e9\\nva au march\u00e9\\nacheter des fleurs\",\n                # smtp avec authentification\n                \"user\": \"pymail2parlexemple@gmail.com\",\n                \"password\": \"#6prIlhD&amp;@1QZ3TG\",\n                # ici, il faut mettre des chemins absolus pour les fichiers attach\u00e9s\n                \"attachments\": [\n                    f\"{script_dir}/attachments/fichier attach\u00e9.docx\",\n                    f\"{script_dir}/attachments/fichier attach\u00e9.pdf\",\n                    f\"{script_dir}/attachments/mail attach\u00e9 1.eml\",\n                ]\n            }\n        ]\n    }\n</code></pre> <ul> <li>ligne 33, nous avons ajout\u00e9 un attachement\u00a0; Maintenant nous ex\u00e9cutons de nouveau le script [smtp/03/main]. Cela donne le r\u00e9sultat suivant dans la bo\u00eete \u00e0 lettres de l\u2019utilisateur [pymail2parlexemple@gmail.com]\u00a0:</li> </ul> <p></p> <ul> <li>en [1], le mail re\u00e7u\u00a0;</li> <li>en [2]\u00a0: le texte du message\u00a0;</li> <li>en [3]\u00a0: le texte du mail attach\u00e9\u00a0;</li> <li>en [4]\u00a0: Thunderbird a trouv\u00e9 5 pi\u00e8ces jointes\u00a0:</li> <li>[fichier attach\u00e9.docx]\u00a0;</li> <li>[fichier attach\u00e9.pdf]\u00a0;</li> <li>[mail attach\u00e9 1.eml]. Cette pi\u00e8ce jointe est elle-m\u00eame un mail contenant deux pi\u00e8ces jointes\u00a0:</li> <li>[fichier attach\u00e9.docx]\u00a0;</li> <li>[fichier attach\u00e9.pdf]\u00a0;</li> </ul>"},{"location":"fonctions-internet.html#216-le-protocole-pop3","title":"21.6. Le protocole POP3","text":""},{"location":"fonctions-internet.html#2161-introduction","title":"21.6.1. Introduction","text":"<p>Pour lire les mails entrepos\u00e9s dans un serveur de mails, deux protocoles existent\u00a0:</p> <ul> <li>le protocole POP3 (Post Office Protocol) historiquement le 1er protocole mais peu utilis\u00e9 maintenant\u00a0;</li> <li>le protocole IMAP (Internet Message Access Protocol) protocole plus r\u00e9cent que POP3 et le plus utilis\u00e9 actuellement\u00a0; Pour d\u00e9couvrir le protocole POP3, nous allons utiliser l\u2019architecture suivante\u00a0:</li> </ul> <p></p> <ul> <li>[Serveur B] sera selon les cas\u00a0:</li> <li>un serveur POP3 local, impl\u00e9ment\u00e9 par le serveur de mail [hMailServer]\u00a0;</li> <li>le serveur [pop.gmail.com] qui est le serveur POP3 du gestionnaire de mails [gmail.com]\u00a0;</li> <li>[Client A] sera un client POP3 de diverses formes\u00a0:</li> <li>le client [RawTcpClient] pour d\u00e9couvrir le protocole POP3\u00a0;</li> <li>un script Python rejouant le protocole POP3 du client [RawTcpClient]\u00a0;</li> <li>un script Python utilisant des modules Python permettant de g\u00e9rer les pi\u00e8ces attach\u00e9es ainsi que l'utilisation d\u2019une connexion chiffr\u00e9e et authentifi\u00e9e lorsque le serveur POP3 l'exige\u00a0;</li> </ul>"},{"location":"fonctions-internet.html#2162-decouverte-du-protocole-pop3","title":"21.6.2. D\u00e9couverte du protocole POP3","text":"<p>Comme nous l\u2019avons fait avec le protocole SMTP, nous allons d\u00e9couvrir le protocole POP3 \u00e0 l\u2019aide des logs du serveur de mails [hMailServer]. Il faut ici lancer ce serveur.</p> <p>Avec Thunderbird, nous allons\u00a0:</p> <ul> <li>envoyer un mail \u00e0 l\u2019utilisateur [guest@localhost.com]\u00a0;</li> <li>lire la bo\u00eete \u00e0 lettre de cet utilisateur\u00a0;</li> </ul> <p></p> <p></p> <p>En [3-6] ci-dessus, le message re\u00e7u par l\u2019utilisateur [guest@localhost.com].</p> <p>Nous examinons maintenant les logs du serveur [hMailServer]. Pour cela nous utilisons l\u2019outil d\u2019administration [hMailServer Administrator]\u00a0:</p> <p></p> <p>Les logs POP3 sont les suivants (les derni\u00e8res lignes dans le fichier de logs du jour)\u00a0:</p> <pre><code>\"POP3D\"    35084    5    \"2020-07-08 14:19:46.392\"    \"127.0.0.1\"    \"SENT: +OK Bienvenue sur le serveur POP3 localhost.com\"\n\"POP3D\"    34968    5    \"2020-07-08 14:19:46.405\"    \"127.0.0.1\"    \"RECEIVED: CAPA\"\n\"POP3D\"    34968    5    \"2020-07-08 14:19:46.407\"    \"127.0.0.1\"    \"SENT: +OK CAPA list follows[nl]USER[nl]UIDL[nl]TOP[nl].\"\n\"POP3D\"    35076    5    \"2020-07-08 14:19:46.410\"    \"127.0.0.1\"    \"RECEIVED: USER guest\"\n\"POP3D\"    35076    5    \"2020-07-08 14:19:46.411\"    \"127.0.0.1\"    \"SENT: +OK Send your password\"\n\"POP3D\"    34968    5    \"2020-07-08 14:19:46.418\"    \"127.0.0.1\"    \"RECEIVED: PASS ***\"\n\"POP3D\"    34968    5    \"2020-07-08 14:19:46.421\"    \"127.0.0.1\"    \"SENT: +OK Mailbox locked and ready\"\n\"POP3D\"    34968    5    \"2020-07-08 14:19:46.423\"    \"127.0.0.1\"    \"RECEIVED: STAT\"\n\"POP3D\"    34968    5    \"2020-07-08 14:19:46.423\"    \"127.0.0.1\"    \"SENT: +OK 1 612\"\n\"POP3D\"    34968    5    \"2020-07-08 14:19:46.426\"    \"127.0.0.1\"    \"RECEIVED: LIST\"\n\"POP3D\"    34968    5    \"2020-07-08 14:19:46.426\"    \"127.0.0.1\"    \"SENT: +OK 1 messages (612 octets)\"\n\"POP3D\"    34968    5    \"2020-07-08 14:19:46.426\"    \"127.0.0.1\"    \"SENT: 1 612[nl].\"\n\"POP3D\"    35076    5    \"2020-07-08 14:19:46.427\"    \"127.0.0.1\"    \"RECEIVED: UIDL\"\n\"POP3D\"    35076    5    \"2020-07-08 14:19:46.428\"    \"127.0.0.1\"    \"SENT: +OK 1 messages (612 octets)[nl]1 42[nl].\"\n\"POP3D\"    34968    5    \"2020-07-08 14:19:46.435\"    \"127.0.0.1\"    \"RECEIVED: RETR 1\"\n\"POP3D\"    34968    5    \"2020-07-08 14:19:46.436\"    \"127.0.0.1\"    \"SENT: .\"\n\"POP3D\"    34924    5    \"2020-07-08 14:19:46.459\"    \"127.0.0.1\"    \"RECEIVED: QUIT\"\n\"POP3D\"    34924    5    \"2020-07-08 14:19:46.459\"    \"127.0.0.1\"    \"SENT: +OK POP3 server saying goodbye...\"\n</code></pre> <ul> <li>ligne 1\u00a0: le serveur POP3 envoie un message de bienvenue au client (Thunderbird) qui vient de se connecter\u00a0;</li> <li>ligne 2\u00a0: le client envoie la commande [CAPA] (capabilities) pour demander la listes des commandes qu\u2019il peut utiliser\u00a0;</li> <li>ligne 3\u00a0: le serveur lui r\u00e9pond qu\u2019il peut utiliser les commandes [USER, UIDL, TOP]. Le serveur POP commence ses r\u00e9ponses par [+OK] ou [-ERR] pour indiquer qu\u2019il a r\u00e9ussi ou \u00e9chou\u00e9 \u00e0 ex\u00e9cuter la commande du client\u00a0;</li> <li>ligne 4\u00a0: le client envoie la commande [USER guest] pour indiquer qu\u2019il veut consulter la bo\u00eete \u00e0 lettres de l\u2019utilisateur [guest]\u00a0;</li> <li>ligne 5\u00a0: le serveur lui r\u00e9pond [+OK] et demande le mote de passe de [guest]\u00a0;</li> <li>ligne 6\u00a0: le client envoie la commande [PASS password] pour envoyer le mot de passe de l\u2019utilisateur [guest]. Ici le mot de passe est en clair car le serveur POP3 n\u2019a pas impos\u00e9 de connexion s\u00e9curis\u00e9e. Nous verrons que ce sera diff\u00e9rent avec le serveur POP3 de Gmail\u00a0;</li> <li>ligne 7\u00a0: le serveur a valid\u00e9 l\u2019ensemble login / mot de passe. Il indique qu\u2019il bloque la bo\u00eete \u00e0 lettres de l\u2019utilisateur [guest]\u00a0;</li> <li>ligne 8\u00a0: le client lui envoie la commande [STAT] qui demande des informations sur la bo\u00eete \u00e0 lettres\u00a0;</li> <li>ligne 9\u00a0: le serveur lui r\u00e9pond qu\u2019il y a un message de 612 octets. De fa\u00e7on g\u00e9n\u00e9rale, il r\u00e9pond qu\u2019il y a N messages et donne la taille totale de ces messages\u00a0;</li> <li>ligne 10\u00a0: le client envoie la commande [LIST]. Cette commande demande la liste des messages\u00a0;</li> <li>ligne 11\u00a0: le serveur lui envoie la liste des messages sous la forme suivante\u00a0:</li> <li>une ligne r\u00e9capitulative avec le nombre de messages et leur taille totale\u00a0;</li> <li>une ligne par message indiquant le n\u00b0 du message et sa taille\u00a0;</li> <li>ligne 13\u00a0: le client envoie la commande [UIDL] qui demande la liste des messages avec leurs identifiants. En effet, chaque message est rep\u00e9r\u00e9 par un n\u00b0 unique au sein du service de mails\u00a0;</li> <li>ligne 14\u00a0: la r\u00e9ponse du serveur. On voit ainsi que le message n\u00b0 1 dans la liste a l\u2019identifiant 42\u00a0;</li> <li>ligne 15\u00a0: le client envoie la commande [RETR 1] qui demande \u00e0 ce qu\u2019on lui transf\u00e8re le message n\u00b0 1 de la liste\u00a0;</li> <li>ligne 16\u00a0: le serveur POP3 le fait\u00a0;</li> <li>ligne 17\u00a0: le client envoie la commande [QUIT] pour indiquer qu\u2019il va se d\u00e9connecter du serveur POP3\u00a0;</li> <li>ligne 18\u00a0: le serveur va lui \u00e9galement fermer sa connexion avec le client mais auparavant il lui envoie un message d\u2019au-revoir\u00a0; Nous allons reproduire maintenant des \u00e9l\u00e9ments du dialogue ci-dessus en utilisant le client [RawTcpClient] ex\u00e9cut\u00e9 dans une fen\u00eatre PyCharm\u00a0:</li> </ul> <p></p> <p>Le dialogue est le suivant\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;RawTcpClient.exe localhost 110\nClient [DESKTOP-30FF5FB:63762] connect\u00e9 au serveur [localhost-110]\nTapez vos commandes (quit pour arr\u00eater) :\n&lt;-- [+OK Bienvenue sur le serveur POP3 localhost.com]\nUSER guest\n&lt;-- [+OK Send your password]\nPASS guest\n&lt;-- [+OK Mailbox locked and ready]\nLIST\n&lt;-- [+OK 1 messages (612 octets)]\n&lt;-- [1 612]\n&lt;-- [.]\nRETR 1\n&lt;-- [+OK 612 octets]\n&lt;-- [Return-Path: guest@localhost.com]\n&lt;-- [Received: from [127.0.0.1] (DESKTOP-30FF5FB [127.0.0.1])]\n&lt;-- [   by DESKTOP-30FF5FB with ESMTP]\n&lt;-- [   ; Wed, 8 Jul 2020 14:19:36 +0200]\n&lt;-- [To: guest@localhost.com]\n&lt;-- [From: \"guest@localhost.com\" &lt;guest@localhost.com&gt;]\n&lt;-- [Subject: protocole POP3]\n&lt;-- [Message-ID: &lt;ca895136-25c5-411e-373a-a68cbd0eca51@localhost.com&gt;]\n&lt;-- [Date: Wed, 8 Jul 2020 14:19:33 +0200]\n&lt;-- [User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:68.0) Gecko/20100101]\n&lt;-- [ Thunderbird/68.10.0]\n&lt;-- [MIME-Version: 1.0]\n&lt;-- [Content-Type: text/plain; charset=utf-8; format=flowed]\n&lt;-- [Content-Transfer-Encoding: 8bit]\n&lt;-- [Content-Language: fr]\n&lt;-- []\n&lt;-- [ceci est un test pour d\u00e9couvrir le protocole POP3]\n&lt;-- []\n&lt;-- [.]\nQUIT\nFin de la connexion avec le serveur\n</code></pre> <ul> <li>ligne 1\u00a0: on ouvre une connexion avec le port 110 de la machine [localhost]. C\u2019est l\u00e0 qu\u2019op\u00e8re le service POP3 de [hMailServer]\u00a0;</li> <li>aux lignes 5, 7, 9, 13, 34, nous utilisons les commandes [USER, PASS, LIST, RETR, QUIT]\u00a0;</li> <li>ligne 4\u00a0: le message de bienvenue du serveur POP3\u00a0;</li> <li>ligne 5\u00a0: on indique qu\u2019on veut acc\u00e9der \u00e0 la bo\u00eete \u00e0 lettres de l\u2019utilisateur [guest]\u00a0;</li> <li>ligne 7\u00a0: on envoie le mot de passe de l\u2019utilisateur [guest] en clair\u00a0;</li> <li>ligne 9\u00a0: on demande la liste des messages de la bo\u00eete \u00e0 lettres\u00a0;</li> <li>ligne 13\u00a0: on demande le message n\u00b0 1\u00a0;</li> <li>lignes 14-33\u00a0: le serveur POP3 envoie le message n\u00b0 1\u00a0;</li> <li> <p>ligne 34\u00a0: on termine la session\u00a0; Voici un r\u00e9sum\u00e9 de quelques commandes courantes accept\u00e9es par un serveur POP3\u00a0:</p> </li> <li> <p>la commande [USER] sert \u00e0 d\u00e9finir l\u2019utilisateur dont on veut lire la bo\u00eete mail\u00a0;</p> </li> <li>la commande [PASS] sert \u00e0 d\u00e9finir son mot de passe\u00a0;</li> <li>la commande [LIST] demande la liste des messages pr\u00e9sents dans la bo\u00eete \u00e0 lettres de l\u2019utilisateur\u00a0;</li> <li>la commande [RETR] demande \u00e0 voir le message dont on passe le n\u00b0\u00a0;</li> <li>la commande [DELE] demande la suppression du message dont on passe le n\u00b0\u00a0;</li> <li> <p>la commande [QUIT] indique au serveur qu\u2019on a termin\u00e9\u00a0; La r\u00e9ponse du serveur peut prendre plusieurs formes\u00a0:</p> </li> <li> <p>une ligne unique commen\u00e7ant par [+OK] pour indiquer que la commande pr\u00e9c\u00e9dente du client a r\u00e9ussi\u00a0;</p> </li> <li>une ligne unique commen\u00e7ant par [-ERR] pour indiquer que la commande pr\u00e9c\u00e9dente du client a \u00e9chou\u00e9\u00a0;</li> <li>plusieurs lignes o\u00f9\u00a0:</li> <li>la 1re ligne commence par [+OK]\u00a0;</li> <li>la derni\u00e8re ligne est constitu\u00e9e d\u2019un unique point\u00a0;</li> </ul>"},{"location":"fonctions-internet.html#2163-scripts-pop301-un-client-pop3-basique","title":"21.6.3. scripts [pop3/01]\u00a0: un client POP3 basique","text":"<p>Comme le procole POP3 a la m\u00eame structure que le protocole SMTP, le script [pop3/01/main.py] est un portage du script [smtp/01/main.py]. Il aura le fichier de configuration [pop3/01/config.py] suivant\u00a0:</p> <pre><code>def configure() -&gt; dict:\n    # les bo\u00eetes \u00e0 lettres dont on rel\u00e8ve les mails\n    mailboxes = [\n        # server : serveur POP3\n        # port : port du serveur POP3\n        # user : utilisateur dont on veut lire les messages\n        # password : son mot de passe\n        # maxmails : le nombre maximum de mails \u00e0 t\u00e9l\u00e9charger\n        # timeout : d\u00e9lai d'attente maximal d'une r\u00e9ponse du serveur\n        # encoding : encodage des mails re\u00e7us\n        # delete : si True, alors les mails sont supprim\u00e9s de la bo\u00eete \u00e0 lettres\n        # une fois qu'ils ont \u00e9t\u00e9 t\u00e9l\u00e9charg\u00e9s localement\n\n        {\n            \"server\": \"localhost\",\n            \"port\": \"110\",\n            \"user\": \"guest\",\n            \"password\": \"guest\",\n            \"maxmails\": 10,\n            \"timeout\": 1.0,\n            \"encoding\": \"utf-8\",\n            \"delete\": False\n        }\n    ]\n    # on rend la configuration\n    return {\n        \"mailboxes\": mailboxes\n    }\n</code></pre> <ul> <li>lignes 3-24\u00a0: la liste des bo\u00eetes \u00e0 lettres \u00e0 consulter. Ici il n\u2019y en a qu\u2019une\u00a0;</li> <li>lignes 4-12\u00a0: significations des \u00e9l\u00e9ments du dictionnaire d\u00e9finissant chacune des bo\u00eetes \u00e0 lettres\u00a0;</li> <li>ligne 15\u00a0: le serveur POP3 interrog\u00e9 est le serveur local [hMailServer]\u00a0;</li> <li>lignes 17-18\u00a0: on veut lire la bo\u00eete \u00e0 lettres de l\u2019utilisateur [guest@localhost]\u00a0;</li> <li>ligne 19\u00a0: on lira au plus 10 mails\u00a0;</li> <li>ligne 20\u00a0: le client aura un d\u00e9lai d'attente d'une r\u00e9ponse du serveur d\u2019au plus 1 seconde\u00a0;</li> <li>ligne 21\u00a0: le type d'encodage des messages lus\u00a0\u00a0;</li> <li>ligne 22\u00a0: on ne supprimera pas les messages t\u00e9l\u00e9charg\u00e9s\u00a0; Le script [pop3/01/main.py] est le suivant\u00a0:</li> </ul> <pre><code># imports\nimport re\nimport socket\n\n\n# -----------------------------------------------------------------------\ndef readmails(mailbox: dict, verbose: bool):\n    # lit la bo\u00eete mail d\u00e9crite par le dictionnaire [mailbox]\n    # si verbose=True, fait un suivi des \u00e9changes client-serveur\n\u2026\n\n\n# --------------------------------------------------------------------------\ndef send_command(mailbox: dict, connexion: socket, commande: str, verbose: bool, with_rclf: bool) -&gt; str:\n    # envoie commande dans le canal connexion\n    # mode verbeux si verbose=True\n    # si with_rclf=True, ajoute la s\u00e9quence rclf \u00e0 \u00e9change\n    # rend la 1\u00e8re ligne de la r\u00e9ponse\n\u2026\n\n\n# --------------------------------------------------------------------------\ndef affiche(echange: str, sens: int):\n    \u2026\n\n\n# main ----------------------------------------------------------------\n\n# client POP3 (Post Office Protocol) permettant de lire des messages d'une bo\u00eete \u00e0 lettres\n# protocole de communication POP3 client-serveur\n# -&gt; client se connecte sur le port 110 du serveur smtp\n# &lt;- serveur lui envoie un message de bienvenue\n# -&gt; client envoie la commande USER utilisateur\n# &lt;- serveur r\u00e9pond OK ou non\n# -&gt; client envoie la commande PASS mot_de_passe\n# &lt;- serveur r\u00e9pond OK ou non\n# -&gt; client envoie la commande LIST\n# &lt;- serveur r\u00e9pond OK ou non\n# -&gt; client envoie la commande RETR n\u00b0 pour chacun des mails\n# &lt;- serveur r\u00e9pond OK ou non. Si OK envoie le contenu du mail demand\u00e9\n# -&gt; serveur envoie ttes les lignes du mail et termine avec une ligne contenant le\n# seul caract\u00e8re .\n# -&gt; client envoie la commande DELE n\u00b0 pour supprimer un mail\n# &lt;- serveur r\u00e9pond OK ou non\n# # -&gt; client envoie la commande QUIT pour terminer le dialogue avec le serveur\n# &lt;- serveur r\u00e9pond OK ou non\n# les r\u00e9ponses du serveur ont la forme +OK texte o\u00f9 -ERR texte\n# La r\u00e9ponse peut comporter plusieurs lignes. Alors la derni\u00e8re est constitu\u00e9e d'un unique point\n# les lignes de texte \u00e9chang\u00e9es doivent se terminer par les caract\u00e8res RC(#13) et LF(#10)\n# \n\n# on r\u00e9cup\u00e8re la configuration de l'application\nimport config\nconfig = config.configure()\n\n# on traite les bo\u00eetes mail une par une\nfor mailbox in config['mailboxes']:\n    try:\n        # affichage console\n        print(\"----------------------------------\")\n        print(\n            f\"Lecture de la bo\u00eete mail POP3 {mailbox['user']}@{mailbox['server']}:{mailbox['port']}\")\n        # lecture de la bo\u00eete mail en mode verbeux\n        readmails(mailbox, True)\n        # fin\n        print(\"Lecture termin\u00e9e...\")\n    except BaseException as erreur:\n        # on affiche l'erreur\n        print(f\"L'erreur suivante s'est produite : {erreur}\")\n    finally:\n        pass\n</code></pre> <p>Commentaires</p> <p>Comme nous l\u2019avons dit, [pop3/01/main.py] est un portage du script [smtp/01/main.py] que nous avons d\u00e9j\u00e0 comment\u00e9. Nous ne commenterons que les principales diff\u00e9rences\u00a0:</p> <ul> <li>ligne 64\u00a0: la fonction [readmails] est charg\u00e9e de lire les mails d'une bo\u00eete aux lettres. Les informations pour se connecter \u00e0 cette bo\u00eete \u00e0 lettres sont dans le dictionnaire [mailbox]. Le second param\u00e8tre [True] est le param\u00e8tre [Verbose] qui demande ici un suivi des \u00e9changes client / serveur\u00a0; La fonction [readmails] est la suivante\u00a0:</li> </ul> <pre><code># -----------------------------------------------------------------------\ndef readmails(mailbox: dict, verbose: bool):\n    # lit les mails de la bo\u00eete mail d\u00e9crite par le dictionnaire [mailbox]\n    # si verbose=True, fait un suivi des \u00e9changes client-serveur\n\n    # on isole les param\u00e8tres de la bo\u00eete mail\n    # on suppose que le dictionnaire [mailbox] est valide\n    server = mailbox['server']\n    port = int(mailbox['port'])\n    user = mailbox['user']\n    password = mailbox['password']\n    maxmails = mailbox['maxmails']\n    delete = mailbox['delete']\n    timeout = mailbox['timeout']\n\n    # on laisse remonter les erreurs syst\u00e8me\n    connexion = None\n    try:\n        # ouverture d'une connexion sur le port [port] de [server] avec un timeout d'une seconde\n        connexion = socket.create_connection((server, port), timeout=timeout)\n\n        # connexion repr\u00e9sente un flux de communication bidirectionnel\n        # entre le client (ce programme) et le serveur pop3 contact\u00e9\n        # ce canal est utilis\u00e9 pour les \u00e9changes de commandes et d'informations\n\n        # lecture msg de bienvenue\n        send_command(mailbox, connexion, \"\", verbose, True)\n        # cmde USER\n        send_command(mailbox, connexion, f\"USER {user}\", verbose, True)\n        # cmde PASS\n        send_command(mailbox, connexion, f\"PASS {password}\", verbose, True)\n        # cmde LIST\n        premi\u00e8re_ligne = send_command(mailbox, connexion, \"LIST\", verbose, True)\n        # analyse de la 1\u00e8re ligne pour conna\u00eetre le nbre de messages\n        match = re.match(r\"^\\+OK (\\d+)\", premi\u00e8re_ligne)\n        nbmessages = int(match.groups()[0])\n        # on boucle sur les messages\n        imessage = 0\n        while imessage &lt; nbmessages and imessage &lt; maxmails:\n            # cmde RETR\n            send_command(mailbox, connexion, f\"RETR {imessage + 1}\", verbose, True)\n            # cmde DELE\n            if delete:\n                send_command(mailbox, connexion, f\"DELE {imessage + 1}\", verbose, True)\n            # msg suivant\n            imessage += 1\n        # cmde QUIT\n        send_command(mailbox, connexion, \"QUIT\", verbose, True)\n        # fin\n    finally:\n        # fermeture connexion\n        if connexion:\n            connexion.close()\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 8-14\u00a0: on r\u00e9cup\u00e8re les informations de configuration de la bo\u00eete \u00e0 lettres \u00e0 consulter\u00a0;</li> <li>lignes 19-20\u00a0: ouverture d\u2019une connexion avec le serveur POP3\u00a0;</li> <li>lignes 26-27\u00a0: lecture du message de bienvenue envoy\u00e9 par le serveur\u00a0;</li> <li>lignes 28-29\u00a0: on envoie la commande [USER] pour identifier l\u2019utilisateur dont on veut les mails\u00a0;</li> <li>lignes 30-31\u00a0: on envoie la commande [PASS] pour donner le mot de passe de cet utilisateur\u00a0;</li> <li>lignes 32-33\u00a0: on envoie la commande [LIST] pour savoir combien il y a de mails dans la bo\u00eete \u00e0 lettres de cet utilisateur. La fonction [sendCommand] renvoie la premi\u00e8re ligne de la r\u00e9ponse du serveur. Dans celle-ci le serveur indique combien il y a de messages dans la bo\u00eete \u00e0 lettres\u00a0;</li> <li>lignes 34-36\u00a0: on r\u00e9cup\u00e8re le nombre de messages dans la 1re ligne de la r\u00e9ponse\u00a0;</li> <li>lignes 39-46\u00a0: on boucle sur chacun des messages. Pour chacun d\u2019eux on \u00e9met deux commandes\u00a0:</li> <li>RETR i\u00a0: pour r\u00e9cup\u00e9rer le message n\u00b0 i (lignes 40-41)\u00a0;</li> <li>DELE i\u00a0: pour le supprimer si la configuration demande que les messages lus soient supprim\u00e9s du serveur (lignes 43-44)\u00a0;</li> <li>lignes 47-48\u00a0: on envoie la commande [QUIT] pour dire au serveur qu\u2019on a termin\u00e9\u00a0; La fonction [send_command] est la suivante\u00a0:</li> </ul> <pre><code># --------------------------------------------------------------------------\ndef send_command(mailbox: dict, connexion: socket, commande: str, verbose: bool, with_rclf: bool) -&gt; str:\n    # envoie commande dans le canal connexion\n    # mode verbeux si verbose=True\n    # si with_rclf=True, ajoute la s\u00e9quence rclf \u00e0 \u00e9change\n    # rend la 1\u00e8re ligne de la r\u00e9ponse\n\n    # marque de fin de ligne\n    if with_rclf:\n        rclf = \"\\r\\n\"\n    else:\n        rclf = \"\"\n    # envoi commande si non vide\n    if commande:\n        connexion.send(bytearray(f\"{commande}{rclf}\", 'utf-8'))\n        # \u00e9cho \u00e9ventuel\n        if verbose:\n            affiche(commande, 1)\n    # lecture de la socket comme si elle \u00e9tait un fichier texte\n    encoding = f\"{mailbox['encoding']}\" if mailbox['encoding'] else None\n    file = connexion.makefile(encoding=encoding)\n    # on exploite ce fichier ligne par ligne\n    # lecture 1\u00e8re ligne\n    premi\u00e8re_ligne = r\u00e9ponse = file.readline().strip()\n    # mode verbeux ?\n    if verbose:\n        affiche(premi\u00e8re_ligne, 2)\n    # r\u00e9cup\u00e9ration code erreur\n    code_erreur = r\u00e9ponse[0]\n    if code_erreur == \"-\":\n        # il y a eu une erreur\n        raise BaseException(r\u00e9ponse[5:])\n    # cas particulier des r\u00e9ponses \u00e0 plusieurs lignes LIST, RETR\n    cmd = commande.lower()[0:4]\n    if cmd == \"list\" or cmd == \"retr\":\n        # derni\u00e8re ligne de la r\u00e9ponse ?\n        derni\u00e8re_ligne = False\n        while not derni\u00e8re_ligne:\n            # lecture ligne suivante\n            ligne_suivante = file.readline().strip()\n            # mode verbeux ?\n            if verbose:\n                affiche(ligne_suivante, 2)\n            # derni\u00e8re ligne ?\n            derni\u00e8re_ligne = ligne_suivante == \".\"\n    # fini - on rend la 1\u00e8re ligne\n    return premi\u00e8re_ligne\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 13-18\u00a0: la commande [command] n'est envoy\u00e9e au serveur POP3 que si elle est non vide. Ce cas est n\u00e9cessaire pour lire le message de bienvenue du serveur POP3 qu'il envoie alors m\u00eame que le client n'a pas encore envoy\u00e9 de commandes\u00a0;</li> <li>lignes 19-21\u00a0: on lit la socket comme si elle \u00e9tait un fichier texte. Cela va nous permettre d'utiliser la m\u00e9thode [readline] (ligne 24) et de lire ainsi le message ligne par ligne. On utilise la cl\u00e9 [encoding] du dictionnaire [mailbox] pour indiquer le codage des lignes qui vont \u00eatre lues\u00a0;</li> <li>ligne 24\u00a0: on lit la 1re ligne de la r\u00e9ponse\u00a0;</li> <li>lignes 28-32\u00a0: on g\u00e8re le cas d'une \u00e9ventuelle erreur. Celles-ci sont du type [-ERR invalid password, -ERR mailbox unknown, -ERR unable to lock mailbox\u2026]\u00a0;</li> <li>ligne 32\u00a0: on lance une exception avec le message de l'erreur\u00a0;</li> <li>ligne 35\u00a0: seules les commandes [list, retr] peuvent avoir des r\u00e9ponses \u00e0 plusieurs lignes\u00a0;</li> <li>lignes 36-45\u00a0: dans le cas d'une r\u00e9ponse \u00e0 plusieurs lignes, on affiche toutes les lignes re\u00e7ues (lignes 42-43) jusqu'\u00e0 recevoir la derni\u00e8re ligne (ligne 45)\u00a0;</li> <li>ligne 46\u00a0: on rend la 1re ligne lue car dans le cas de la commande [LIST], elle comporte le nombre de messages pr\u00e9sents dans la bo\u00eete \u00e0 lettres\u00a0; R\u00e9sultats</li> </ul> <p>Prenons l'exemple pr\u00e9c\u00e9dent. Avec Thunderbird, nous avions envoy\u00e9 le message suivant \u00e0 l'utilisateur [guest@localhost] (il faut que le serveur hMailServer soit lanc\u00e9)\u00a0:</p> <p></p> <p>A l\u2019ex\u00e9cution, on obtient les r\u00e9sultats suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/inet/pop3/01/main.py\n----------------------------------\nLecture de la bo\u00eete mail POP3 guest@localhost:110\n&lt;-- [+OK Bienvenue sur le serveur POP3 localhost.com]\n--&gt; [USER guest]\n&lt;-- [+OK Send your password]\n--&gt; [PASS guest]\n&lt;-- [+OK Mailbox locked and ready]\n--&gt; [LIST]\n&lt;-- [+OK 1 messages (612 octets)]\n&lt;-- [1 612]\n&lt;-- [.]\n--&gt; [RETR 1]\n&lt;-- [+OK 612 octets]\n&lt;-- [Return-Path: guest@localhost.com]\n&lt;-- [Received: from [127.0.0.1] (DESKTOP-30FF5FB [127.0.0.1])]\n&lt;-- [by DESKTOP-30FF5FB with ESMTP]\n&lt;-- [; Wed, 8 Jul 2020 14:19:36 +0200]\n&lt;-- [To: guest@localhost.com]\n&lt;-- [From: \"guest@localhost.com\" &lt;guest@localhost.com&gt;]\n&lt;-- [Subject: protocole POP3]\n&lt;-- [Message-ID: &lt;ca895136-25c5-411e-373a-a68cbd0eca51@localhost.com&gt;]\n&lt;-- [Date: Wed, 8 Jul 2020 14:19:33 +0200]\n&lt;-- [User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:68.0) Gecko/20100101]\n&lt;-- [Thunderbird/68.10.0]\n&lt;-- [MIME-Version: 1.0]\n&lt;-- [Content-Type: text/plain; charset=utf-8; format=flowed]\n&lt;-- [Content-Transfer-Encoding: 8bit]\n&lt;-- [Content-Language: fr]\n&lt;-- []\n&lt;-- [ceci est un test pour d\u00e9couvrir le protocole POP3]\n&lt;-- []\n&lt;-- [.]\n--&gt; [QUIT]\n&lt;-- [+OK POP3 server saying goodbye...]\nLecture termin\u00e9e...\n\nProcess finished with exit code 0\n</code></pre> <ul> <li> <p>lignes 15-31\u00a0: on r\u00e9cup\u00e8re correctement le message envoy\u00e9 \u00e0 [guest@localhost]. Nous avons l\u00e0 un client POP3 basique auquel il manque certaines capacit\u00e9s\u00a0:</p> </li> <li> <p>la possibilit\u00e9 de dialoguer avec un serveur POP3 s\u00e9curis\u00e9\u00a0;</p> </li> <li>la possibilit\u00e9 de lire les pi\u00e8ces attach\u00e9es \u00e0 un message\u00a0; Nous allons impl\u00e9menter ces deux possibilit\u00e9s avec un nouveau script qui sera cette fois plus complexe.</li> </ul>"},{"location":"fonctions-internet.html#2164-scripts-pop302-client-pop3-avec-les-modules-poplib-et-email","title":"21.6.4. scripts [pop3/02]\u00a0: client POP3 avec les modules [poplib] et [email]","text":"<p>Nous allons \u00e9crire un client POP3 permettant de g\u00e9rer les pi\u00e8ces attach\u00e9es ainsi que la communication avec des serveurs s\u00e9curis\u00e9s. Par ailleurs, nous sauvegarderons dans des fichiers, les messages et leurs pi\u00e8ces attach\u00e9es.</p> <p>Nous allons utiliser deux modules Python\u00a0:</p> <ul> <li>[poplib]\u00a0: qui va assurer le protocole POP3\u00a0;</li> <li>[email]\u00a0: qui regroupe de nombreux sous-modules qui vont nous permettre d'analyser les messages re\u00e7us. Chaque message est une cha\u00eene de caract\u00e8res structur\u00e9e dans laquelle on peut retrouver\u00a0:</li> <li>les ent\u00eates du message [From, To, Subject, Return-Path\u2026]\u00a0;</li> <li>le message dans ses versions texte et \u00e9ventuellement HTML\u00a0;</li> <li>les pi\u00e8ces attach\u00e9es\u00a0;</li> </ul> <p></p> <p>Le script [inet/pop3/02/main] [1] est configur\u00e9 par le fichier [inet/pop3/02/config] [2] et utilise le module [inet/shared/mail_parser] [3].</p> <p>Le fichier [pop3/02/config] est le suivant\u00a0:</p> <pre><code>import os\n\n\ndef configure() -&gt; dict:\n    # configuration de l'appli\n    config = {\n        # liste des bo\u00eetes \u00e0 lettres \u00e0 g\u00e9rer\n        \"mailboxes\": [\n            # server : serveur POP3\n            # port : port du serveur POP3\n            # user : utilisateur dont on veut lire les messages\n            # password : son mot de passe\n            # maxmails : le nombre maximum de mail \u00e0 t\u00e9l\u00e9charger\n            # timeout : d\u00e9lai d'attente maximal d'une r\u00e9ponse du serveur\n            # delete : \u00e0 vrai s'il faut supprimer du serveur les messages t\u00e9l\u00e9charg\u00e9s\n            # ssl : \u00e0 vrai si la lecture des mails se fait au travers d'une liaison s\u00e9curis\u00e9e\n            # output : le dossier de rangement des messages t\u00e9l\u00e9charg\u00e9s\n\n            {\n                \"server\": \"pop.gmail.com\",\n                \"port\": \"995\",\n                \"user\": \"pymail2parlexemple@gmail.com\",\n                \"password\": \"#6prIlhD&amp;@1QZ3TG\",\n                \"maxmails\": 10,\n                \"delete\": False,\n                \"ssl\": True,\n                \"timeout\": 2.0,\n                \"output\": \"output\"\n            }\n        ]\n    }\n    # chemin absolu du dossier du script\n    script_dir = os.path.dirname(os.path.abspath(__file__))\n\n    # chemins absolus des dossiers \u00e0 inclure dans le syspath\n    absolute_dependencies = [\n        # dossier local\n        f\"{script_dir}/../../shared\",\n   ]\n\n    # configuration du syspath\n    from myutils import set_syspath\n    set_syspath(absolute_dependencies)\n\n    # on rend la configuration\n    return config\n</code></pre> <p>Le fichier d\u00e9finit la liste des bo\u00eetes \u00e0 lettres \u00e0 consulter et fixe le Python Path de l\u2019application.</p> <p>Il n\u2019y a ici qu\u2019une unique bo\u00eete \u00e0 lettres\u00a0:</p> <ul> <li>lignes 22-23\u00a0: l'utilisateur dont on veut lire les mails\u00a0;</li> <li>lignes 20-21\u00a0: le nom et le port du serveur POP3 qui stocke les mails de cet utilisateur\u00a0;</li> <li>ligne 24\u00a0: le nombre maximum de mails \u00e0 r\u00e9cup\u00e9rer. En effet, si vous essayez ce script sur votre propre bo\u00eete mail, vous ne voudrez sans doute pas r\u00e9cup\u00e9rer les centaines de mails qui s'y trouvent\u00a0;</li> <li>ligne 25\u00a0: bool\u00e9en qui indique si apr\u00e8s la lecture d'un mail, on doit supprimer celui-ci (delete=True)\u00a0;</li> <li>ligne 26\u00a0: l\u2019attribut [ssl] \u00e0 True signifie que le serveur POP3 d\u00e9fini aux lignes 20-21 utilise une connexion crypt\u00e9e\u00a0;</li> <li>ligne 27\u00a0: le temps d'attente maximal des r\u00e9ponses du serveur exprim\u00e9 en secondes\u00a0;</li> <li>ligne 28\u00a0: le dossier dans lequel ranger les mails lus. Il sera cr\u00e9\u00e9 s'il n'existe pas. On a ici un nom relatif. A l'ex\u00e9cution, il sera relatif au dossier \u00e0 partir duquel vous lancez le script. Avec [Pycharm], ce dossier sera celui du script [pop3/02]\u00a0; Le script [pop3/02/main] est le suivant\u00a0:</li> </ul> <pre><code># imports\nimport email\nimport os\nimport poplib\nimport shutil\n\n\n# lecture d'une bo\u00eete mail\ndef readmails(mailbox: dict, verbose: bool):\n    # lit la bo\u00eete mail d\u00e9crite par le dictionnaire [mailbox]\n    # si verbose=True, fait un suivi des \u00e9changes client-serveur\n\u2026\n\n# main ----------------------------------------------------------------\n#  client POP3 (Post Office Protocol) permettant de lire des mails\n\n# on r\u00e9cup\u00e8re la configuration de l'application\nimport config\nconfig = config.configure()\n\n# on traite les bo\u00eetes mail une par une\nfor mailbox in config['mailboxes']:\n    try:\n        # affichage console\n        print(\"----------------------------------\")\n        print(\n            f\"Lecture de la bo\u00eete mail POP3 {mailbox['user']}@{mailbox['server']}:{mailbox['port']}\")\n        # lecture de la bo\u00eete mail en mode verbeux\n        readmails(mailbox, True)\n        # fin\n        print(\"Lecture termin\u00e9e...\")\n    except BaseException as erreur:\n        # on affiche l'erreur\n        print(f\"L'erreur suivante s'est produite : {erreur}\")\n    finally:\n        pass\n</code></pre> <ul> <li>lignes 17-36\u00a0: la partie [main] du script est analogue \u00e0 celle du script [pop3/01]\u00a0; La fonction [readmails] est la suivante\u00a0:</li> </ul> <pre><code># lecture d'une bo\u00eete mail\ndef readmails(mailbox: dict, verbose: bool):\n    # lit la bo\u00eete mail d\u00e9crite par le dictionnaire [mailbox]\n    # si verbose=True, fait un suivi des \u00e9changes client-serveur\n\n    # import de mail_parser\n    from mail_parser import save_message\n\n    # on isole les param\u00e8tres de la bo\u00eete mail\n    # on suppose que le dictionnaire [mailbox] est valide\n    server = mailbox['server']\n    port = int(mailbox['port'])\n    user = mailbox['user']\n    password = mailbox['password']\n    maxmails = mailbox['maxmails']\n    ssl = mailbox['ssl']\n    timeout = mailbox['timeout']\n    output = mailbox['output']\n\n    # on laisse remonter les erreurs syst\u00e8me\n    pop3 = None\n    try:\n        # on cr\u00e9e les dossiers de stockage s'ils n'existent pas\n        if not os.path.isdir(output):\n            os.mkdir(output)\n        # user\n        dir2 = f\"{output}/{user}\"\n        # on supprime le dossier [dir2] s'il existe puis on le recr\u00e9e\n        if os.path.isdir(dir2):\n            # suppression\n            shutil.rmtree(dir2)\n        # cr\u00e9ation\n        os.mkdir(dir2)\n        # ouverture d'une connexion sur le port [port] de [server]\n        if ssl:\n            pop3 = poplib.POP3_SSL(server, port, timeout=timeout)\n        else:\n            pop3 = poplib.POP3(server, port, timeout=timeout)\n\n        # connexion repr\u00e9sente un flux de communication bidirectionnel\n        # entre le client (ce programme) et le serveur pop3 contact\u00e9\n        # ce canal est utilis\u00e9 pour les \u00e9changes de commandes et d'informations\n\n        # mode verbose\n        pop3.set_debuglevel(2 if verbose else 0)\n        # lecture msg de bienvenue\n        pop3.getwelcome(    )\n        # cmde USER\n        r\u00e9ponse = pop3.user(user)\n        # cmde PASS\n        r\u00e9ponse = pop3.pass_(password)\n        # cmde LIST\n        liste = pop3.list()\n        # les mails sont dans liste[1]\n        imail = 0\n        nb_mails = len(liste[1])\n        fini = imail == maxmails or imail == nb_mails\n        \u00e9l\u00e9ments = liste[1]\n        while not fini:\n            # \u00e9l\u00e9ment courant\n            \u00e9l\u00e9ment = \u00e9l\u00e9ments[imail]\n            # \u00e9l\u00e9ment est une liste d'octets qu'on d\u00e9code en string\n            desc = \u00e9l\u00e9ment.decode()\n            # on a une cha\u00eene s\u00e9par\u00e9e par des blancs\n            # le 1er \u00e9l\u00e9ment est le n\u00b0 du message\n            num = desc.split()[0]\n            # on r\u00e9cup\u00e8re le message\n            message = pop3.retr(int(num))\n            # les lignes du message sont dans message [1]\n            str_message = \"\"\n            for ligne in message[1]:\n                # ligne est une suite d'octets qu'on d\u00e9code en string\n                str_message += f\"{ligne.decode()}\\r\\n\"\n            # dossier du message\n            dir3 = f\"{dir2}/message_{num}\"\n            # si le dossier n'existe pas, on le cr\u00e9e\n            if not os.path.isdir(dir3):\n                os.mkdir(dir3)\n            # objet email.message.Message\n            save_message(dir3, email.message_from_string(str_message), 0)\n            # un mail de +\n            imail += 1\n            # a-t-on atteint le max ?\n            fini = imail == maxmails or imail == nb_mails\n\n        # cmde QUIT\n        pop3.quit()\n    finally:\n        # fermeture connexion\n        if pop3:\n            pop3.close()\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 6-7\u00a0: on importe la fonction [mail_parser.save_message] utilis\u00e9e ligne 80\u00a0; </li> <li>le code de la fonction est encapsul\u00e9e dans un try (ligne 22)/ finally (ligne 88). Ainsi toutes les exceptions remontent au code principal qui les arr\u00eatent et les affichent\u00a0;</li> <li>lignes 11-18\u00a0: on r\u00e9cup\u00e8re les informations de configuration\u00a0de la bo\u00eete \u00e0 lettres\u00a0;</li> <li>lignes 23-33\u00a0: tous les messages seront stock\u00e9s dans le dossier [output/user] o\u00f9 [output] et [user] sont d\u00e9finis dans la configuration. On cr\u00e9e donc successivement les dossiers [output] puis [output/user]. Pour cr\u00e9er ce dernier, on le supprime d'abord ligne 31. [shutil] est un module qu'il faut importer. [shutil.rmtree(dir)] supprime le dossier [dir] et tout ce qu'il contient\u00a0;</li> <li>pour toutes les op\u00e9rations sur les fichiers syst\u00e8me on utilise le module [os] qu'il faut \u00e9galement importer\u00a0;</li> <li>lignes 34-38\u00a0: on ouvre une connexion avec le serveur POP3. Si le serveur est s\u00e9curis\u00e9, on utilise la classe [poplib.POP3_SSL] sinon la classe [poplib.POP3]. L'attribut [ssl] utilis\u00e9 ligne 35 provient de la configuration de la bo\u00eete \u00e0 lettres\u00a0;</li> <li>ligne 45\u00a0: on fixe un niveau de logs\u00a0:</li> <li>0\u00a0: pas de logs\u00a0;</li> <li>1\u00a0: les commandes \u00e9mises par le client POP3 sont logu\u00e9es\u00a0;</li> <li>2\u00a0: logs d\u00e9taill\u00e9s. On voit \u00e9galement ce que re\u00e7oit le client POP3\u00a0;</li> <li>ligne 47\u00a0: apr\u00e8s la connexion, leserveur POP3 envoie un message de bienvenue. On lit celui-ci\u00a0;</li> <li>lignes 48-49\u00a0: commande USER du protocole POP3\u00a0;</li> <li>lignes 50-51\u00a0: commande PASS du protocole POP3\u00a0;</li> <li>lignes 52-53\u00a0: commande LIST du protocole POP3. La r\u00e9ponse est un tuple (response, ['mesg_num octets'\u2026], octets), par exemple liste=(b'+OK 3 messages (3859 octets)', [b'1 584', b'2 550', b'3 2725'], 22). On voit que les deux premiers \u00e9l\u00e9ments du tuple sont des bytes (pr\u00e9fixe b). liste[1] est un tableau o\u00f9 chaque \u00e9l\u00e9ment est une suite d'octets contenant deux informations\u00a0: le n\u00b0 du message et sa taille en octets\u00a0;</li> <li>ligne 56\u00a0: de ce qui pr\u00e9c\u00e8de on d\u00e9duit que le nombre de messages dans la bo\u00eete \u00e0 lettres peut \u00eatre obtenu par [len[liste1]]\u00a0;</li> <li>lignes 59-84\u00a0: on boucle sur chacun des messages. On s'arr\u00eate lorsque tous ont \u00e9t\u00e9 lus ou qu'on a atteint le nombre maximal de mails fix\u00e9 par configuration\u00a0;</li> <li>ligne 61\u00a0: \u00e9l\u00e9ment courant du tableau liste[1], donc quelque chose comme b'1 584', une suite d'octets\u00a0;</li> <li>ligne 63\u00a0: on passe de la suite d'octets \u00e0 une cha\u00eene de caract\u00e8res. On a maintenant la cha\u00eene '1 584'\u00a0;</li> <li>ligne 66\u00a0: on r\u00e9cup\u00e8re le n\u00b0 du message, ici la cha\u00eene '1'\u00a0;</li> <li> <p>ligne 68\u00a0: on \u00e9met la commande POP3 RETR num. On r\u00e9cup\u00e8re une r\u00e9ponse du genre\u00a0: <pre><code>[message=(b'+OK 584 octets', [b'Return-Path: guest@localhost', b'Received: from [127.0.0.1] (localhost [127.0.0.1])', b'\\tby DESKTOP-528I5CU with ESMTPA', b'\\t; Tue, 17 Mar 2020 09:41:50 +0100', b'To: guest@localhost', b'From: \"guest@localhost\" &lt;guest@localhost&gt;', b'Subject: test', b'Message-ID: &lt;2572d0f0-5b7c-2c31-5a70-c628293d5709@localhost&gt;', b'Date: Tue, 17 Mar 2020 09:41:48 +0100', b'User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:68.0) Gecko/20100101', b' Thunderbird/68.6.0', b'MIME-Version: 1.0', b'Content-Type: text/plain; charset=utf-8; format=flowed', b'Content-Transfer-Encoding: 8bit', b'Content-Language: fr', b'', b'h\\xc3\\xa9l\\xc3\\xa8ne est all\\xc3\\xa9e au march\\xc3\\xa9 acheter des l\\xc3\\xa9gumes.', b''], 614)]\n</code></pre></p> </li> <li> <p>message est un tuple de trois \u00e9l\u00e9ments\u00a0;</p> </li> <li>message[1] est un tableau de lignes. Chaque ligne est une suite d'octets (pr\u00e9fixe b). Le message complet est form\u00e9 par cet ensemble de lignes\u00a0;</li> <li>[Return-Path, Received, To, Subject, Message-ID, Content-Type, Content-Transfer-Encoding, Content-Language] sont les ent\u00eates du message. Chacun donne une information sur le message re\u00e7u. Ces informations vont permettre de r\u00e9cup\u00e9rer le corps du message (avant-dernier \u00e9l\u00e9ment du tableau message[1])\u00a0;</li> <li>lignes 71-73\u00a0: on cr\u00e9e la cha\u00eene [strMessage] form\u00e9e de toutes les lignes du message. On a maintenant le message sous forme d'une cha\u00eene de caract\u00e8res. Ce message peut contenir d'autres messages ainsi que des pi\u00e8ces attach\u00e9es. Car les pi\u00e8ces attach\u00e9es le sont sous la forme d'une cha\u00eene de caract\u00e8res. Donc un point \u00e0 retenir, c'est qu'un mail est au d\u00e9part une cha\u00eene de caract\u00e8res et c'est cette cha\u00eene de caract\u00e8res qu'il faut analyser pour en extraire les pi\u00e8ces attach\u00e9es, les \u00e9ventuels autres messages encapsul\u00e9s et bien s\u00fbr le corps du message, ce qu'a \u00e9crit l'exp\u00e9diteur\u00a0;</li> <li>lignes 74-78\u00a0: on va ranger le corps du message et les pi\u00e8ces attach\u00e9es message dans le dossier [dir3]\u00a0;</li> <li>lignes 79-80\u00a0: on va d\u00e9l\u00e9guer l'analyse du message \u00e0 une fonction [save_message]\u00a0:</li> <li>le 1er param\u00e8tre est [dir3], le dossier dans lequel le contenu du message doit \u00eatre rang\u00e9\u00a0;</li> <li>le second param\u00e8tre est un type [email.message.Message]. Cet objet a les m\u00e9thodes pour r\u00e9cup\u00e9rer les diff\u00e9rentes parties du message (corps, pi\u00e8ces attach\u00e9es) ainsi que tous ses ent\u00eates. Il faut importer le module [email] pour disposer de cet objet. La fonction [email.message_from_string] permet de construire un objet [email.message.Message] \u00e0 partir de la cha\u00eene de caract\u00e8res du message\u00a0; La fonction [save_message] fait partie du module [mail_parser]\u00a0:</li> </ul> <p></p> <p>Le module [mail_parser] a \u00e9t\u00e9 import\u00e9 aux lignes 6-7 de la fonction [readmails]\u00a0;</p> <p>Dans [mail_parser.py] la fonction [save_message] est la suivante\u00a0:</p> <pre><code># imports\nimport codecs\nimport email.contentmanager\nimport email.header\nimport email.iterators\nimport email.message\nimport os\n\n\n# sauvegarde d'un message de type email.message.Message\n# cette fonction peut \u00eatre appel\u00e9e de fa\u00e7on r\u00e9cursive\ndef save_message(output: str, email_message: email.message.Message, irfc822=0) -&gt; int:\n    # output : dossier de sauvegarde des messages\n    # email_message : le message \u00e0 sauvegarder\n    # irfc822 : n\u00b0 courant de la num\u00e9rotation des mails attach\u00e9s\n    #\n    # partie du message\n    part = email_message\n    # les ent\u00eates [From, To, Subject] sont trouv\u00e9s dans une des parties multipart\n    # ou bien dans une partie [text/*] lorsqu'il n'y a pas de partie [multipart]\n    keys = part.keys()\n    # From doit faire partie des ent\u00eates, sinon la partie n'a pas les ent\u00eates qu'on cherche\n    if \"From\" in keys:\n        # on r\u00e9cup\u00e8re certains ent\u00eates\n        headers = [f\"From: {decode_header(part.get('From'))}\",\n                   f\"To: {decode_header(part.get('To'))}\",\n                   f\"Subject: {decode_header(part.get('Subject'))}\",\n                   f\"Return-Path: {decode_header(part.get('Return-Path'))}\",\n                   f\"User-Agent: {decode_header(part.get('User-Agent'))}\",\n                   f\"Date: {decode_header(part.get('Date'))}\"]\n        # sauvegarde des ent\u00eates dans un fichier texte\n        with codecs.open(f\"{output}/headers.txt\", \"w\", \"utf-8\") as file:\n            # \u00e9criture dans fichier\n            string = '\\r\\n'.join(headers)\n            file.write(f\"{string}\\r\\n\")\n\n    # type de la partie [part]\n    main_type = part.get_content_maintype()\n   \u2026\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 12\u00a0: la fonction re\u00e7oit au plus trois param\u00e8tres\u00a0:</li> <li>[output]\u00a0: le dossier o\u00f9 enregistrer le message (2i\u00e8me param\u00e8tre)\u00a0;</li> <li>[email_message]\u00a0: un message de type [email.message.Message]. Ce type est un type structur\u00e9. Il contient le texte du mail ainsi que tous les fichiers attach\u00e9s et offre des m\u00e9thodes pour r\u00e9cup\u00e9rer ses diff\u00e9rents \u00e9l\u00e9ments\u00a0;</li> <li>[irfc822]\u00a0: ce param\u00e8tre est utilis\u00e9 pour num\u00e9roter les mails encapsul\u00e9s dans [email_message]\u00a0;</li> <li>ligne 18\u00a0: l'objet [email_message] est mis dans [part]. Le type [email.message.Message] contient des parties [part] (corps du message, pi\u00e8ces attach\u00e9es, mails encapsul\u00e9s) qui ont \u00e9galement le type [email.message.Message]. Chaque partie [part] peut avoir des sous-parties. Ainsi le type [email.message.Message] est un arbre d'\u00e9l\u00e9ments de type [email.message.Message]\u00a0:</li> <li>[part.ismultipart()] vaut [True] si la partie [part] contient des sous-parties. Celles-ci sont alors disponibles via [part.get_payload()]\u00a0;</li> <li>lorsque [part.ismultipart()] vaut [False], c'est qu'on est arriv\u00e9 \u00e0 une feuille de l'arbre du message initial\u00a0: il peut s'agir\u00a0:</li> <li>du corps du message sous la forme d'un texte normal\u00a0;</li> <li>du corps du message sous la forme d'un texte HTML\u00a0;</li> <li>d'une pi\u00e8ce attach\u00e9e (\u00e0 l'exception d'un message encapsul\u00e9 pour lequel [part.ismultipart()] vaut [True])\u00a0;</li> <li>de par la nature en arbre du param\u00e8tre [email.message.Message], la fonction [save_message] sera appel\u00e9e de fa\u00e7on r\u00e9cursive. La r\u00e9cursivit\u00e9 cesse lorsqu'on atteint les feuilles de l'arbre, \u00e7-\u00e0-d une partie [part] pour laquelle [part.ismultipart()] vaut [False]\u00a0;</li> <li>ligne 21\u00a0: nous demandons \u00e0 voir les cl\u00e9s (ou ent\u00eates) du message couramment analys\u00e9 (qui de par la r\u00e9cursivit\u00e9 peut \u00eatre une sous-partie du message initial)\u00a0;</li> <li>lignes 23-35\u00a0: on veut enregistrer les ent\u00eates\u00a0:</li> <li>[From]\u00a0: l'exp\u00e9diteur du message\u00a0;</li> <li>[To]\u00a0: le destinataire du message\u00a0;</li> <li>[Subject]\u00a0: le sujet du message\u00a0;</li> <li>[Return-Path]\u00a0: le destinataire \u00e0 qui on doit r\u00e9pondre si on veut r\u00e9pondre. En effet, cette information n'est pas toujours dans le [From]\u00a0;</li> <li>[User-Agent]\u00a0: le client POP3 qui dialogue avec le serveur POP3\u00a0;</li> <li>[Date]\u00a0: date d'envoi du mail\u00a0;</li> <li>ligne 23\u00a0: seule l'une des parties d'un message contient ces ent\u00eates. Pour les autres parties, le code des lignes 23-35 sera ignor\u00e9\u00a0;</li> <li>lignes 25-30\u00a0: on cr\u00e9e une liste avec les six ent\u00eates\u00a0;</li> <li>ligne 25\u00a0: analysons le 1er ent\u00eate\u00a0:</li> <li>[part.get(key)] permet d'avoir l'ent\u00eate associ\u00e9 \u00e0 la cl\u00e9 [key]\u00a0;</li> <li>cet ent\u00eate peut \u00eatre encod\u00e9. Si cet encodage n'est pas utf-8, on d\u00e9code l'ent\u00eate pour le r\u00e9encoder en utf-8\u00a0\u00e0 l\u2019aide de la fonction [decode_header]\u00a0;</li> <li>le 1er ent\u00eate sera de la forme [From: pymail2lexemple@gmail.com]\u00a0;</li> <li>lignes 31-35\u00a0: on sauve les ent\u00eates dans le fichier [output/headers.txt]\u00a0; La fonction [decode_header] est la suivante (toujours dans [mail_parser.py])\u00a0:</li> </ul> <pre><code># d\u00e9codage de headers\ndef decode_header(header: object) -&gt; str:\n    # on d\u00e9code l'ent\u00eate\n    header = email.header.decode_header(f\"{header}\")\n    # le r\u00e9sultat est un tableau - ici il n'aura qu'un \u00e9l\u00e9ment de type (header, encoding)\n    # si encoding==None, alors header est une cha\u00eene de caract\u00e8res\n    # sinon c'est une liste d'octets cod\u00e9s par encoding\n    header, encoding = header[0]\n    if not encoding:\n        # si pas d'encodage\n        return header\n    else:\n        # si encodage, on d\u00e9code\n        return header.decode(encoding)\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 4\u00a0: on d\u00e9code l'ent\u00eate\u00a0:</li> <li>il faut importer le module [email.header]\u00a0;</li> <li>on obtient une liste de tuples [(header1,encoding1) , (header2, encoding2)\u2026]\u00a0;</li> <li>pour les ent\u00eates [From, To, Subject, Return-Path, Date] la liste n'aura qu'un \u00e9l\u00e9ment\u00a0;</li> <li>ligne 8\u00a0: on r\u00e9cup\u00e8re l'ent\u00eate unique et son encodage\u00a0:</li> <li>si [encoding==None] alors [header] est l'ent\u00eate sous la forme d'une cha\u00eene de caract\u00e8res\u00a0;</li> <li>sinon, [header] est une suite d'octets repr\u00e9sentant l'ent\u00eate encod\u00e9\u00a0;</li> <li>lignes 10-11\u00a0: s'il n'y avait pas d'encodage, alors on rend l'ent\u00eate\u00a0;</li> <li>lignes 12-14\u00a0: s'il y avait un encodage, alors on d\u00e9code,  dans une cha\u00eene de caract\u00e8res, la suite d'octets qu'on a r\u00e9cup\u00e9r\u00e9e et on rend celle-ci\u00a0; Revenons \u00e0 la fonction [save_message]\u00a0:</li> </ul> <pre><code># sauvegarde d'un message de type email.message.Message\n# cette fonction peut \u00eatre appel\u00e9e de fa\u00e7on r\u00e9cursive\ndef save_message(output: str, email_message: email.message.Message, irfc822=0) -&gt; int:\n    # output : dossier de sauvegarde des messages\n    # email_message : le message \u00e0 sauvegarder\n    # irfc822 : n\u00b0 courant de la num\u00e9rotation des mails attach\u00e9s\n    #\n    # partie du message\n    part = email_message\n    # les ent\u00eates [From, To, Subject] sont trouv\u00e9s dans une des parties multipart\n    # ou bien dans une partie [text/*] lorsqu'il n'y a pas de partie [multipart]\n    keys = part.keys()\n    # From doit faire partie des ent\u00eates, sinon la partie n'a pas les ent\u00eates qu'on cherche\n    if \"From\" in keys:\n        # on r\u00e9cup\u00e8re certains ent\u00eates\n        headers = [f\"From: {decode_header(part.get('From'))}\",\n                   f\"To: {decode_header(part.get('To'))}\",\n                   f\"Subject: {decode_header(part.get('Subject'))}\",\n                   f\"Return-Path: {decode_header(part.get('Return-Path'))}\",\n                   f\"User-Agent: {decode_header(part.get('User-Agent'))}\",\n                   f\"Date: {decode_header(part.get('Date'))}\"]\n        # sauvegarde des ent\u00eates dans un fichier texte\n        with codecs.open(f\"{output}/headers.txt\", \"w\", \"utf-8\") as file:\n            # \u00e9criture dans fichier\n            string = '\\r\\n'.join(headers)\n            file.write(f\"{string}\\r\\n\")\n\n    # type de la partie [part]\n    main_type = part.get_content_maintype()\n    sub_type = part.get_content_subtype()\n    type_of_part = f\"{main_type}/{sub_type}\"\n    # si le message est de type text/plain\n    if type_of_part == \"text/plain\":\n        # message texte\n        save_textmessage(output, part, 0)\n\n    # si le message est de type text/html\n    elif type_of_part == \"text/html\":\n        # message HTML\n        save_textmessage(output, part, 1)\n\n    # si le message est un conteneur de parties\n    elif part.is_multipart():\n        \u2026\n    else:\n        \u2026\n    # on ignore les autres parties (pas text/plain, pas text/html, pas attachment)\n    # on rend la valeur actuelle de irfc822 (num\u00e9rotation des mails attach\u00e9s rang\u00e9s dans le dossier output)\n    return irfc822\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 1-26\u00a0: on a trait\u00e9 les ent\u00eates du message initial\u00a0;</li> <li>lignes 28-31\u00a0: les parties d'un message de type [email.message.Message] ont un type principal et un sous-type. On les r\u00e9cup\u00e8re\u00a0;</li> <li>lignes 32-35\u00a0: si la partie trait\u00e9e a le type [text/plain] alors on est arriv\u00e9s \u00e0 une feuille de l'arbre du message initial. C'est le texte qu'a \u00e9crit l'exp\u00e9diteur dans son message\u00a0;</li> <li>ligne 35\u00a0: ce texte est \u00e9crit dans un fichier\u00a0:</li> <li>le 1er param\u00e8tre [output] est le dossier dans lequel le texte doit \u00eatre sauvegard\u00e9\u00a0;</li> <li>le second param\u00e8tre est la partie du message qui contient le texte \u00e0 sauvegarder\u00a0;</li> <li>le troisi\u00e8me param\u00e8tre vaut 0 pour sauvegarder un texte normal, 1 pour un texte HTML\u00a0;</li> <li>lignes 37-40\u00a0: si la partie a le type [text/html] alors on est \u00e9galement arriv\u00e9s \u00e0 une feuille de l'arbre du message initial. C'est le texte qu'a \u00e9crit l'exp\u00e9diteur dans son message, cette fois-ci au format HTML. Les gestionnaires de courrier ne proposent pas tous ce format\u00a0; La fonction [save_textmessage] est la suivante\u00a0:</li> </ul> <pre><code># sauvegarde d'un message texte\ndef save_textmessage(output: str, part: email.message.Message, type_of_text: int):\n    # ent\u00eates\n    headers = []\n    # charset du message\n    charset = part.get_content_charset()\n    if charset is not None:\n        charset = part.get_content_charset().lower()\n        headers.append(f\"Charset: {charset}\")\n    # mode de codage du contenu\n    content_transfer_encoding = part.get(\"Content-Transfer-Encoding\")\n    if content_transfer_encoding is not None:\n        headers.append(f\"Transfer-Content-Encoding: {content_transfer_encoding}\")\n    # le mode 8bit a pos\u00e9 probl\u00e8me\n    if content_transfer_encoding == \"8bit\":\n        # on r\u00e9cup\u00e8re le message du mail\n        msg = part.get_payload()\n    else:\n        # on r\u00e9cup\u00e8re le message du mail\n        msg = email.contentmanager.raw_data_manager.get_content(part)\n    # selon les types de texte\n    filename = None\n    if type_of_text == 0:\n        # sauvegarde des ent\u00eates\n        with codecs.open(f\"{output}/headers.txt\", \"a\", \"utf-8\") as file:\n            # \u00e9criture dans fichier\n            string = '\\r\\n'.join(headers)\n            file.write(f\"{string}\\r\\n\")\n        # fichier texte pour le contenu\n        filename = f\"{output}/mail.txt\"\n    elif type_of_text == 1:\n        # fichier html pour le contenu\n        filename = f\"{output}/mail.html\"\n    # sauvegarde du message\n    with codecs.open(filename, \"w\", \"utf-8\") as file:\n        # \u00e9criture dans fichier\n        file.write(msg)\n</code></pre> <p>Commentaires</p> <ul> <li>comme les ent\u00eates, le texte du message peut \u00eatre encod\u00e9. Il peut y avoir deux encodages\u00a0:</li> <li>l'encodage initial du texte (utf-8, iso-8859-1\u2026). C'est l'encodage utilis\u00e9 par le gestionnaire de courrier qui a envoy\u00e9 le message. Il est connu avec l'ent\u00eate [Content-Type] du message re\u00e7u\u00a0;</li> <li>un second encodage qu'a pu subir le texte pr\u00e9c\u00e9dent pour \u00eatre envoy\u00e9. Il est connu avec l'ent\u00eate [Transfer-Content-Encoding] du message re\u00e7u\u00a0;</li> <li>ligne 6\u00a0: l'encodage initial du texte\u00a0;</li> <li>ligne 11\u00a0: le second encodage que le texte a subi pour son transfert vers le destinataire\u00a0;</li> <li>lignes 9, 13\u00a0: ces deux informations sont mises dans la liste [headers]. Elles seront rajout\u00e9es aux informations du fichier [headers.txt] qui enregistre certains ent\u00eates du message\u00a0;</li> <li>ligne 20\u00a0: [email.contentmanager.raw_data_manager.get_content] permet d'avoir le message avec son encodage initial 1. On s'est d\u00e9barrass\u00e9 de l'encodage 2. Seulement l'objet [email.contentmanager.raw_data_manager] ne g\u00e8re que deux types de [Transfer-Content-Encoding]\u00a0:</li> <li>[quoted-printable]\u00a0;</li> <li> <p>[base64]\u00a0; Il ignore les autres. Or Thunderbird par exemple utilise le [Transfer-Content-Encoding] nomm\u00e9 \"8bit\". Cet encodage est  ignor\u00e9 et les messages avec des caract\u00e8res accentu\u00e9s sont d\u00e9natur\u00e9s. Le message peut alors \u00eatre obtenu par la m\u00e9thode [part.get_payload()]\u00a0(lignes 15-17)\u00a0;</p> </li> <li> <p>ligne 21\u00a0: lorsqu'on est l\u00e0, on a le message d\u00e9barrass\u00e9 de son encodage de transfert, donc le message tel qu'il a \u00e9t\u00e9 \u00e9crit par l'exp\u00e9diteur\u00a0;</p> </li> <li>lignes 22-37\u00a0: on est dans le cas o\u00f9 on doit sauvegarder un message texte\u00a0;</li> <li>lignes 24-28\u00a0: on sauvegarde les deux ent\u00eates construits lignes 9, 13 dans le fichier [headers.txt]. Celui-ci existe d\u00e9j\u00e0 et contient des ent\u00eates. Aussi utilise-t-on le mode \"a\" (ligne 25) pour ouvrir ce fichier. \"a\" signifie \"append\" et les nouveaux ent\u00eates sont ajout\u00e9s (en fin de fichier) au contenu existant du fichier [headers.txt]\u00a0;</li> <li>ligne 30\u00a0: le nom du fichier dans lequel sauvegarder le message texte\u00a0;</li> <li>ligne 33\u00a0: le nom du fichier dans lequel sauvegarder le message HTML\u00a0;</li> <li>lignes 34-37\u00a0: on sauvegarde le texte utf-8 dans un fichier\u00a0; Revenons \u00e0 la fonction [save_message]\u00a0:</li> </ul> <pre><code># sauvegarde d'un message de type email.message.Message\n# cette fonction peut \u00eatre appel\u00e9e de fa\u00e7on r\u00e9cursive\ndef save_message(output: str, email_message: email.message.Message, irfc822=0) -&gt; int:\n    # output : dossier de sauvegarde des messages\n    # email_message : le message \u00e0 sauvegarder\n    # irfc822 : n\u00b0 courant de la num\u00e9rotation des mails attach\u00e9s\n    #\n    # partie du message\n    part = email_message\n    # les ent\u00eates [From, To, Subject] sont trouv\u00e9s dans une des parties multipart\n    # ou bien dans une partie [text/*] lorsqu'il n'y a pas de partie [multipart]\n    keys = part.keys()\n    # From doit faire partie des ent\u00eates, sinon la partie n'a pas les ent\u00eates qu'on cherche\n    if \"From\" in keys:\n        # on r\u00e9cup\u00e8re certains ent\u00eates\n        headers = [f\"From: {decode_header(part.get('From'))}\",\n                   f\"To: {decode_header(part.get('To'))}\",\n                   f\"Subject: {decode_header(part.get('Subject'))}\",\n                   f\"Return-Path: {decode_header(part.get('Return-Path'))}\",\n                   f\"User-Agent: {decode_header(part.get('User-Agent'))}\",\n                   f\"Date: {decode_header(part.get('Date'))}\"]\n        # sauvegarde des ent\u00eates dans un fichier texte\n        with codecs.open(f\"{output}/headers.txt\", \"w\", \"utf-8\") as file:\n            # \u00e9criture dans fichier\n            string = '\\r\\n'.join(headers)\n            file.write(f\"{string}\\r\\n\")\n\n    # type de la partie [part]\n    main_type = part.get_content_maintype()\n    sub_type = part.get_content_subtype()\n    type_of_part = f\"{main_type}/{sub_type}\"\n    # si le message est de type text/plain\n    if type_of_part == \"text/plain\":\n        # message texte\n        save_textmessage(output, part, 0)\n\n    # si le message est de type text/html\n    elif type_of_part == \"text/html\":\n        # message HTML\n        save_textmessage(output, part, 1)\n\n    # si le message est un conteneur de parties\n    elif part.is_multipart():\n        # cas particulier du mail attach\u00e9\n        if type_of_part == \"message/rfc822\":\n            # cr\u00e9ation d'un nouveau dossier output2 pour le mail attach\u00e9\n            irfc822 += 1\n            output2 = f\"{output}/rfc822_{irfc822}\"\n            os.mkdir(output2)\n            # sauvegarde des sous-parties du message irfc822 dans output2\n            for subpart in part.get_payload():\n                # dans le nouveau dossier irfc822 red\u00e9marre \u00e0 0\n                save_message(output2, subpart, 0)\n\n        else:\n            # on n'a pas affaire \u00e0 un mail attach\u00e9\n            # sauvegarde des sous-parties dans le dossier courant output\n            # irfc822 doit alors \u00eatre incr\u00e9ment\u00e9 pour chaque sous-partie message/rfc822\n            for subpart in part.get_payload():\n                # save_message rend la derni\u00e8re valeur de irfc822\n                # incr\u00e9ment\u00e9e de 1 si subpart=\"message/rfc822\", pas incr\u00e9ment\u00e9e sinon\n                irfc822 = save_message(output, subpart, irfc822)\n    else:\n        # autres cas (pas text/plain, pas text/html, pas multipart)\n        # attachement ?\n        disposition = part.get('Content-Disposition')\n        if disposition and disposition.startswith('attachment'):\n            save_attachment(output, part)\n    # on ignore les autres parties (pas text/plain, pas text/html, pas attachment)\n    # on rend la valeur actuelle de irfc822 (num\u00e9rotation des mails attach\u00e9s rang\u00e9s dans le dossier output)\n    return irfc822\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 33-40\u00a0: nous avons trait\u00e9 deux cas possibles d'un message \u00e0 une extr\u00e9mit\u00e9 de l'arbre du message initial (pas de sous-parties). Il nous reste encore deux cas \u00e0 traiter\u00a0:</li> <li>lignes 43-62\u00a0: le cas o\u00f9 la partie analys\u00e9e contient elle-m\u00eame des sous-parties (part.ismultipart()==True)\u00a0;</li> <li> <p>lignes 63-68\u00a0: pour les cas restants, on ne traite que le cas o\u00f9 la partie analys\u00e9e est un attachement\u00a0; Nous traitons ce dernier cas. Nous sommes l\u00e0 encore \u00e0 une extr\u00e9mit\u00e9 du message initial (pas de sous-parties). Nous avons d\u00e9j\u00e0 rencontr\u00e9 deux cas de cette esp\u00e8ce\u00a0: les types text/plain et text/html. Nous traitons maintenant le cas du fichier attach\u00e9.</p> </li> <li> <p>ligne 66\u00a0: l'attachement est rep\u00e9r\u00e9 par la cl\u00e9 [Content-Disposition]\u00a0;</p> </li> <li>ligne 67\u00a0: si cette cl\u00e9 existe et que celle-ci commence par la cha\u00eene [attachment], alors on a affaire \u00e0 une pi\u00e8ce attach\u00e9e au message\u00a0;</li> <li>ligne 68\u00a0: l'attachement est sauvegard\u00e9 dans le dossier [output]\u00a0; La fonction [save_attachment] est la suivante\u00a0:</li> </ul> <pre><code># sauvegarde d'un attachement\ndef save_attachment(output: str, part: email.message.Message):\n    # nom du fichier attach\u00e9\n    filename = os.path.basename(part.get_filename())\n\n    # le nom du fichier peut \u00eatre encod\u00e9\n    # par exemple =?utf-8?Q?Cours-Tutoriels-Serge-Tah=C3=A9-1568x268=2Ep\n    filename = decode_header(filename)\n    # on sauvegarde le fichier attach\u00e9\n    with open(f\"{output}/{filename}\", \"wb\") as file:\n        file.write(part.get_payload(decode=True))\n</code></pre> <ul> <li>ligne 4\u00a0: si [part] est un attachement, alors le nom du fichier attach\u00e9 est obtenu par [part.get_filename]. On ne garde que le nom du fichier pas son chemin\u00a0;</li> <li>ligne 8\u00a0: les noms des fichiers sont g\u00e9n\u00e9ralement encod\u00e9s et ce de la m\u00eame fa\u00e7on que les ent\u00eates du message. Aussi utilise-t-on la fonction [decode_header] pour le d\u00e9coder\u00a0;</li> <li>ligne 11\u00a0: le contenu du fichier attach\u00e9 est pour l'instant une cha\u00eene de caract\u00e8res produite par l'encodage (souvent base64) en texte du contenu initial du fichier. Pour obtenir ce contenu initial on utilise la fonction [part.get_payload(decode=True)]. Le param\u00e8tre [decode=True] indique que le contenu de la pi\u00e8ce attach\u00e9e doit \u00eatre d\u00e9cod\u00e9. On obtient alors une suite d'octets\u00a0;</li> <li>ligne 10\u00a0: cette suite d'octets est sauvegard\u00e9e dans le fichier [output/filename]. Le mode \"wb\" d'ouverture du fichier signifie write binary\u00a0; Revenons au code de la fonction [save_message]\u00a0:</li> </ul> <pre><code>def save_message(output: str, email_message: email.message.Message, irfc822=0) -&gt; int:\n    # output : dossier de sauvegarde des messages\n    # email_message : le message \u00e0 sauvegarder\n    # irfc822 : n\u00b0 courant de la num\u00e9rotation des mails attach\u00e9s\n    #\n    # partie du message\n    part = email_message\n    # les ent\u00eates [From, To, Subject] sont trouv\u00e9s dans une des parties multipart\n    # ou bien dans une partie [text/*] lorsqu'il n'y a pas de partie [multipart]\n    keys = part.keys()\n    # From doit faire partie des ent\u00eates, sinon la partie n'a pas les ent\u00eates qu'on cherche\n    if \"From\" in keys:\n        # on r\u00e9cup\u00e8re certains ent\u00eates\n        headers = [f\"From: {decode_header(part.get('From'))}\",\n                   f\"To: {decode_header(part.get('To'))}\",\n                   f\"Subject: {decode_header(part.get('Subject'))}\",\n                   f\"Return-Path: {decode_header(part.get('Return-Path'))}\",\n                   f\"User-Agent: {decode_header(part.get('User-Agent'))}\",\n                   f\"Date: {decode_header(part.get('Date'))}\"]\n        # sauvegarde des ent\u00eates dans un fichier texte\n        with codecs.open(f\"{output}/headers.txt\", \"w\", \"utf-8\") as file:\n            # \u00e9criture dans fichier\n            string = '\\r\\n'.join(headers)\n            file.write(f\"{string}\\r\\n\")\n\n    # type de la partie [part]\n    main_type = part.get_content_maintype()\n    sub_type = part.get_content_subtype()\n    type_of_part = f\"{main_type}/{sub_type}\"\n    # si le message est de type text/plain\n    if type_of_part == \"text/plain\":\n        # message texte\n        save_textmessage(output, part, 0)\n\n    # si le message est de type text/html\n    elif type_of_part == \"text/html\":\n        # message HTML\n        save_textmessage(output, part, 1)\n\n    # si le message est un conteneur de parties\n    elif part.is_multipart():\n        # cas particulier du mail attach\u00e9\n        if type_of_part == \"message/rfc822\":\n            # cr\u00e9ation d'un nouveau dossier output2 pour le mail attach\u00e9\n            irfc822 += 1\n            output2 = f\"{output}/rfc822_{irfc822}\"\n            os.mkdir(output2)\n            # sauvegarde des sous-parties du message irfc822 dans output2\n            for subpart in part.get_payload():\n                # dans le nouveau dossier irfc822 red\u00e9marre \u00e0 0\n                save_message(output2, subpart, 0)\n\n        else:\n            # on n'a pas affaire \u00e0 un mail attach\u00e9\n            # sauvegarde des sous-parties dans le dossier courant output\n            # irfc822 doit alors \u00eatre incr\u00e9ment\u00e9 pour chaque sous-partie message/rfc822\n            for subpart in part.get_payload():\n                # save_message rend la derni\u00e8re valeur de irfc822\n                # incr\u00e9ment\u00e9e de 1 si subpart=\"message/rfc822\", pas incr\u00e9ment\u00e9e sinon\n                irfc822 = save_message(output, subpart, irfc822)\n    else:\n        # autres cas (pas text/plain, pas text/html, pas multipart)\n        # attachement ?\n        disposition = part.get('Content-Disposition')\n        if disposition and disposition.startswith('attachment'):\n            save_attachment(output, part)\n    # on ignore les autres parties (pas text/plain, pas text/html, pas attachment)\n    # on rend la valeur actuelle de irfc822 (num\u00e9rotation des mails attach\u00e9s rang\u00e9s dans le dossier output)\n    return irfc822\n</code></pre> <p>Commentaires</p> <ul> <li>nous avons trait\u00e9 les cas des terminaisons de l'arbre du message initial\u00a0: les parties [text/plain, text/html et Content-Disposition=attachment;\u2026]\u00a0Il nous reste \u00e0 traiter le cas o\u00f9 la partie analys\u00e9e est un conteneur de parties, \u00e7-\u00e0-d qu'elle contient des sous-parties [part.is_multipart()==True], ligne 41. Pour arriver aux terminaisons de l'arbre du message, il faut donc analyser ces sous-parties\u00a0;</li> <li>ligne 43\u00a0: on traite de fa\u00e7on particuli\u00e8re le cas o\u00f9 la partie analys\u00e9e a un type [message/rfc822]. C'est le type d'un mail. C'est donc le cas o\u00f9 un mail a comme pi\u00e8ce attach\u00e9e un autre mail\u00a0; Le code est le suivant\u00a0:</li> </ul> <pre><code>    # si le message est un conteneur de parties\n    elif part.is_multipart():\n        # cas particulier du mail attach\u00e9\n        if type_of_part == \"message/rfc822\":\n            # cr\u00e9ation d'un nouveau dossier output2 pour le mail attach\u00e9\n            irfc822 += 1\n            output2 = f\"{output}/rfc822_{irfc822}\"\n            os.mkdir(output2)\n            # sauvegarde des sous-parties du message irfc822 dans output2\n            for subpart in part.get_payload():\n                # dans le nouveau dossier irfc822 red\u00e9marre \u00e0 0\n                save_message(output2, subpart, 0)\n\n        else:\n            # on n'a pas affaire \u00e0 un mail attach\u00e9\n            # sauvegarde des sous-parties dans le dossier courant output\n            # irfc822 doit alors \u00eatre incr\u00e9ment\u00e9 pour chaque sous-partie message/rfc822\n            for subpart in part.get_payload():\n                # save_message rend la derni\u00e8re valeur de irfc822\n                # incr\u00e9ment\u00e9e de 1 si subpart=\"message/rfc822\", pas incr\u00e9ment\u00e9e sinon\n                irfc822 = save_message(output, subpart, irfc822)\n\u2026\n    return irfc822\n</code></pre> <ul> <li>la diff\u00e9rence entre une partie [message/rfc822] et les autres parties multipart est que le dossier de sauvegarde change\u00a0;</li> <li>lignes 6-8\u00a0: pour la partie [message/rfc822], le dossier de sauvegarde devient celui de la ligne 7 [output/rfc822_x] o\u00f9 x est le n\u00b0 du mail attach\u00e9, 1 pour le premier, 2 pour le deuxi\u00e8me\u2026\u00a0;</li> <li>ligne 21\u00a0: pour les autres parties multipart, le dossier de sauvegarde continue \u00e0 \u00eatre le dossier [output] du message initial. On ne change pas de dossier\u00a0;</li> <li>lignes 10-12\u00a0: chaque sous-partie est sauvegard\u00e9e par un appel r\u00e9cursif \u00e0 [save_message]. Le 3e param\u00e8tre est l'indice de num\u00e9rotation des mails encapsul\u00e9s dans [subpart]. Au d\u00e9part cet indice vaut 0\u00a0;</li> <li> <p>ligne 21\u00a0: m\u00eame explication que pour la ligne 12, mais la valeur du 3e param\u00e8tre [irfc822] change. Si dans la boucle des lignes 18-21, il y a plusieurs mails encapsul\u00e9s, ils doivent \u00eatre rang\u00e9s dans des dossiers [\u2026/rfc822-1\u2026/rfc822_2\u2026]. Donc le 3e param\u00e8tre de la fonction [save_message] doit avoir successivement les valeurs, 1, 2, 3\u2026 Pour ce faire, [save_message] rend la valeur de [irfc822] (ligne 21). Prenons un exemple et supposons que la liste des sous-parties de la ligne 18 soit [subpart1, subpart2, subpart3, subpart4, subpart5] et que [subpart1, subpart3, subpart5] soient des mails attach\u00e9s, [subpart2] une partie text/plain et [subpart4] un attachement, et qu'on n'a pas encore rencontr\u00e9 de mail attach\u00e9 dans le message [irfc822=0]. Dans ce cas\u00a0:</p> </li> <li> <p>[subpart1] est sauvegard\u00e9 par la ligne 21\u00a0: la fonction [saveMessage] est ex\u00e9cut\u00e9e avec irfc822=0\u00a0;</p> </li> <li>[subpart1] est un mail attach\u00e9, donc irfc822 passe \u00e0 1 (ligne 6 du code). Un dossier [output/irfc822_1] est cr\u00e9\u00e9. La valeur rendue par [saveMessage(ouput,subpart1,0)] est donc 1 (ligne 23)\u00a0;</li> <li>[subpart2] est sauvegard\u00e9 par la ligne 21\u00a0: la fonction [saveMessage] est ex\u00e9cut\u00e9e avec irfc822=1\u00a0;</li> <li>[subpart2] n'est pas un mail attach\u00e9. Donc irfc822 reste \u00e0 1. C'est la valeur r\u00e9cup\u00e9r\u00e9e ligne 21\u00a0;</li> <li>[subpart3] est sauvegard\u00e9 par la ligne 21\u00a0: la fonction [save_message] est ex\u00e9cut\u00e9e avec irfc822=1\u00a0;</li> <li>[subpart3] est un mail attach\u00e9, donc irfc822 passe \u00e0 2 (ligne 6 du code).  Un dossier [output/irfc822_2] est cr\u00e9\u00e9. La valeur rendue par [save_message(ouput,subpart1,1)] est donc 2 (ligne 21)\u00a0;</li> <li>[subpart4] est sauvegard\u00e9 par la ligne 21\u00a0: la fonction [save_message] est ex\u00e9cut\u00e9e avec irfc822=2\u00a0;</li> <li>[subpart4] n'est pas un mail attach\u00e9. Donc irfc822 reste \u00e0 2. C'est la valeur r\u00e9cup\u00e9r\u00e9e ligne 21\u00a0;</li> <li>[subpart5] est sauvegard\u00e9 par la ligne 21\u00a0: la fonction [save_message] est ex\u00e9cut\u00e9e avec irfc822=2\u00a0;</li> <li>[subpart5] est un mail attach\u00e9, donc irfc822 passe \u00e0 3 (ligne 6 du code). Un dossier [output/irfc822_3] est cr\u00e9\u00e9.  La valeur rendue par [save_message(ouput,subpart1,2)] est donc 3 (ligne 21)\u00a0;  Exemples d'ex\u00e9cution</li> </ul> <p>Nous envoyons 4 mails \u00e0 [pymail2parlexemple@gmail.com] \u00e0 partir de\u00a0: [Gmail, Outlook, em Client, Thunderbird]</p> <ul> <li>[Gmail]\u00a0: [https://mail.google.com/]\u00a0;</li> <li>[Outlook]\u00a0: [https://outlook.live.com/owa/]\u00a0;</li> <li>[em Client]\u00a0: [https://www.emclient.com/]\u00a0;</li> <li>[Mozilla Thunderbird]\u00a0: [https://www.thunderbird.net/fr/]\u00a0; Tous les mails auront le sujet [h\u00e9l\u00e8ne va au march\u00e9] et comme texte [acheter des l\u00e9gumes]. On veut tester comment sont r\u00e9cup\u00e9r\u00e9s les caract\u00e8res accentu\u00e9s.</li> </ul> <p>Nous les lisons avec le script [pop3/02/main] configur\u00e9 avec le fichier [pop3/02/config] suivant\u00a0:</p> <pre><code>import os\n\n\ndef configure() -&gt; dict:\n    # configuration de l'appli\n    config = {\n        # liste des bo\u00eetes \u00e0 lettres \u00e0 g\u00e9rer\n        \"mailboxes\": [\n            # server : serveur POP3\n            # port : port du serveur POP3\n            # user : utilisateur dont on veut lire les messages\n            # password : son mot de passe\n            # maxmails : le nombre maximum de mail \u00e0 t\u00e9l\u00e9charger\n            # timeout : d\u00e9lai d'attente maximal d'une r\u00e9ponse du serveur\n            # delete : \u00e0 vrai s'il faut supprimer du serveur les messages t\u00e9l\u00e9charg\u00e9s\n            # ssl : \u00e0 vrai si la lecture des mails se fait au travers d'une liaison s\u00e9curis\u00e9e\n            # output : le dossier de rangement des messages t\u00e9l\u00e9charg\u00e9s\n\n            {\n                \"server\": \"pop.gmail.com\",\n                \"port\": \"995\",\n                \"user\": \"pymail2parlexemple@gmail.com\",\n                \"password\": \"#6prD&amp;@1QZ3TG\",\n                \"maxmails\": 10,\n                \"delete\": False,\n                \"ssl\": True,\n                \"timeout\": 2.0,\n                \"output\": \"output\"\n            }\n        ]\n    }\n    # chemin absolu du dossier du script\n    script_dir = os.path.dirname(os.path.abspath(__file__))\n\n    # chemins absolus des dossiers \u00e0 inclure dans le syspath\n    absolute_dependencies = [\n        # dossier local\n        f\"{script_dir}/../../shared\",\n    ]\n\n    # configuration du syspath\n    from myutils import set_syspath\n    set_syspath(absolute_dependencies)\n\n    # on rend la configuration\n    return config\n</code></pre> <p>Le r\u00e9sultat est le suivant\u00a0:</p> <p></p> <p>Le message 1 est celui envoy\u00e9 par Thunderbird\u00a0:</p> <p></p> <ul> <li>en [5], Thunderbird [3] utilise un [Transfer-Content-Encoding] de type [8bit]\u00a0;</li> <li>en [4]\u00a0: le message est cod\u00e9 en UTF-8\u00a0; Le message 2 est celui envoy\u00e9 par em Client\u00a0:</li> </ul> <p></p> <p></p> <p>On remarquera que [em Client] code les textes en utf-8 [4] et qu'il les transf\u00e8re en [quoted-printable] [5]. Il a \u00e9galement envoy\u00e9 une copie du message en HTML [7-8]. Tous les gestionnaires de mail test\u00e9s ici peuvent faire cela. Il s\u2019agit d\u2019un param\u00e8tre de configuration.</p> <p>Le message 3 est celui envoy\u00e9 par Gmail\u00a0:</p> <p></p> <p>On remarquera que Gmail code les textes en utf-8 [3] et qu'il les transf\u00e8re en [quoted-printable] [4]. En [6], la version HTML du message.</p> <p>Le message 4 est celui envoy\u00e9 par Outlook\u00a0:</p> <p></p> <p>On remarquera que Outlook code les textes en iso-8859-1 [3] et qu'il les transf\u00e8re en [quoted-printable] [4].</p> <p>Les exemples pr\u00e9c\u00e9dents montrent deux choses\u00a0:</p> <ul> <li>notre client [pop3/02] a \u00e9t\u00e9 fonctionnel\u00a0;</li> <li>les gestionnaires de courriers ont des fa\u00e7ons diff\u00e9rentes d'envoyer un mail\u00a0; Voyons maintenant les fichiers attach\u00e9s. Avec Thunderbird, nous vidons la bo\u00eete mail de l'utilisateur [pymail2parlexemple@gmail.com]. Puis nous utilisons le script [smtp/03/main] pour envoyer un mail avec la configuration [smtp/03/config] suivante\u00a0:</li> </ul> <pre><code>import os\n\n\ndef configure() -&gt; dict:\n    # configuration de l'application\n    script_dir = os.path.dirname(os.path.abspath(__file__))\n\n    return {\n        # description : description du mail envoy\u00e9\n        # smtp-server : serveur SMTP\n        # smtp-port : port du serveur SMTP\n        # from : exp\u00e9diteur\n        # to : destinataire\n        # subject : sujet du mail\n        # message : message du mail\n        \"mails\": [\n            {\n                \"description\": \"mail to gmail via gmail avec smtplib\",\n                \"smtp-server\": \"smtp.gmail.com\",\n                \"smtp-port\": \"587\",\n                \"from\": \"pymail2parlexemple@gmail.com\",\n                \"to\": \"pymail2parlexemple@gmail.com\",\n                \"subject\": \"to gmail via gmail avec smtplib\",\n                # on teste les caract\u00e8res accentu\u00e9s\n                \"message\": \"agla\u00eb s\u00e9l\u00e9n\u00e9\\nva au march\u00e9\\nacheter des fleurs\",\n                # smtp avec authentification\n                \"user\": \"pymail2parlexemple@gmail.com\",\n                \"password\": \"#6prIlhD&amp;@1QZ3TG\",\n                # ici, il faut mettre des chemins absolus pour les fichiers attach\u00e9s\n                \"attachments\": [\n                    f\"{script_dir}/attachments/fichier attach\u00e9.docx\",\n                    f\"{script_dir}/attachments/fichier attach\u00e9.pdf\",\n                    f\"{script_dir}/attachments/mail attach\u00e9 1.eml\",\n                ]\n            }\n        ]\n    }\n</code></pre> <ul> <li>lignes 31-33\u00a0: nous attachons au mail\u00a0:</li> <li>un fichier Word\u00a0;</li> <li>un fichier PDF\u00a0;</li> <li>un mail contenant les m\u00eames deux fichiers attach\u00e9s\u00a0; Une fois le mail envoy\u00e9, nous ex\u00e9cutons le script [pop3/02] pour lire la bo\u00eete mail de l\u2019utilisateur [pymail2parlexemple@gmail.com]. Les r\u00e9sultats sont les suivants\u00a0:</li> </ul> <p></p> <ul> <li>en [1]\u00a0: le message avec ses deux fichiers attach\u00e9s\u00a0;</li> <li>en [2]\u00a0: le mail attach\u00e9 lui-m\u00eame avec ses deux fichiers attach\u00e9s\u00a0; Conclusion</li> </ul> <p>Le module [mail_parser.py] est particuli\u00e8rement complexe. Cela est d\u00fb \u00e0 la complexit\u00e9 des mails eux-m\u00eames. Nous allons r\u00e9utiliser ce module pour le protocole IMAP.</p>"},{"location":"fonctions-internet.html#217-le-protocole-imap","title":"21.7. Le protocole IMAP","text":""},{"location":"fonctions-internet.html#2171-introduction","title":"21.7.1. Introduction","text":"<p>Pour lire les mails entrepos\u00e9s dans un serveur de mails, deux protocoles existent\u00a0:</p> <ul> <li>le protocole POP3 (Post Office Protocol) historiquement le 1er protocole mais peu utilis\u00e9 maintenant\u00a0;</li> <li>le protocole IMAP (Internet Message Access Protocol) protocole plus r\u00e9cent que POP3 et le plus utilis\u00e9 actuellement\u00a0; Pour d\u00e9couvrir le protocole IMAP, nous allons utiliser l\u2019architecture suivante\u00a0:</li> </ul> <p></p> <ul> <li>[Serveur B] sera selon les cas\u00a0:</li> <li>un serveur IMAP local, impl\u00e9ment\u00e9 par le serveur de mail [hMailServer]\u00a0;</li> <li>le serveur [imap.gmail.com:993] qui est le serveur IMAP du gestionnaire de mails [Gmail]\u00a0;</li> <li> <p>[Client A] sera un script Python utilisant des modules Python permettant de g\u00e9rer les pi\u00e8ces attach\u00e9es ainsi que l'utilisation d\u2019une connexion chiffr\u00e9e et authentifi\u00e9e lorsque le serveur IMAP l'exige\u00a0; Le protocole IMAP va au-del\u00e0 du protocole POP3\u00a0:</p> </li> <li> <p>les mails sont conserv\u00e9s sur le serveur IMAP et peuvent \u00eatre organis\u00e9s en dossiers\u00a0;</p> </li> <li>le client IMAP peut envoyer des commandes de cr\u00e9ation / modification / suppression de ces dossiers\u00a0; Voyons un exemple avec Thunderbird. Dans l'architecture suivante\u00a0:</li> </ul> <p></p> <ul> <li>Thunderbird est le client A\u00a0;</li> <li>[imap.gmail.com] est le serveur B (Gmail)\u00a0; Cr\u00e9ons un dossier dans les mails de l'utilisateur [pymail2parlexemple@gmail.com] avec Thunderbird\u00a0:</li> </ul> <p></p> <ul> <li>en [1-6], nous cr\u00e9ons le dossier [dossier1]\u00a0;</li> </ul> <p></p> <ul> <li>en [7-8], nous d\u00e9pla\u00e7ons (avec la souris) tous les fichiers du dossier [Courrier entrant] dans le dossier [dossier1]\u00a0; Maintenant connectons-nous au site web de Gmail et identifions-nous comme l'utilisateur [pymail2parlexemple@gmail.com]\u00a0:</li> </ul> <p></p> <ul> <li>en [2-3], la bo\u00eete de r\u00e9ception est vide\u00a0;</li> <li>en [1], le dossier [dossier1] qui a \u00e9t\u00e9 cr\u00e9\u00e9\u00a0;</li> </ul> <p></p> <ul> <li>en [4-6]\u00a0: les mails qui ont \u00e9t\u00e9 d\u00e9plac\u00e9s dans le dossier [dossier1]\u00a0; Nous sommes l\u00e0 devant l'architecture suivante\u00a0:</li> </ul> <p></p> <ul> <li>Client A est l'application Thunderbird\u00a0;</li> <li>Client C est l'application web de Gmail\u00a0;</li> <li> <p>Serveur B est le serveur IMAP de Gmail\u00a0; L'arbre des dossiers de l'utilisateur est maintenu par le serveur IMAP. Ensuite tous les clients IMAP se synchronisent sur lui pour pr\u00e9senter \u00e0 l'utilisateur les dossiers de son compte. Ici Thunderbird a envoy\u00e9 plusieurs commandes pour \u00a0:</p> </li> <li> <p>cr\u00e9er le dossier [dossier1]\u00a0;</p> </li> <li>transf\u00e9rer des messages dans ce dossier\u00a0;</li> </ul>"},{"location":"fonctions-internet.html#2172-script-imapmain-client-imap-avec-le-module-imaplib","title":"21.7.2. script [imap/main]\u00a0: client IMAP avec le module [imaplib]","text":"<p>Le script [imap/main] est configur\u00e9 par le script [imap/config] suivant\u00a0:</p> <pre><code>import os\n\n\ndef configure() -&gt; dict:\n    # configuration de l'appli\n    config = {\n        # liste des bo\u00eetes \u00e0 lettres \u00e0 g\u00e9rer\n        \"mailboxes\": [\n            # server : serveur IMAP\n            # port : port du serveur IMAP\n            # user : utilisateur dont on veut lire les messages\n            # password : son mot de passe\n            # maxmails : le nombre maximum de mail \u00e0 t\u00e9l\u00e9charger\n            # timeout : d\u00e9lai d'attente maximal d'une r\u00e9ponse du serveur\n            # delete : \u00e0 vrai s'il faut supprimer du serveur les messages t\u00e9l\u00e9charg\u00e9s\n            # ssl : \u00e0 vrai si la lecture des mails se fait au travers d'une liaison s\u00e9curis\u00e9e\n            # output : le dossier de rangement des messages t\u00e9l\u00e9charg\u00e9s\n\n            {\n                \"server\": \"imap.gmail.com\",\n                \"port\": \"993\",\n                \"user\": \"pymail2parlexemple@gmail.com\",\n                \"password\": \"#6prIlhD&amp;@1QZ3TG\",\n                \"maxmails\": 10,\n                \"ssl\": True,\n                \"timeout\": 2.0,\n                \"output\": \"output\"\n            }\n        ]\n    }\n    # chemin absolu du dossier du script\n    script_dir = os.path.dirname(os.path.abspath(__file__))\n\n    # chemins absolus des dossiers \u00e0 inclure dans le syspath\n    absolute_dependencies = [\n        # dossier local\n        f\"{script_dir}/../shared\",\n    ]\n\n    # configuration du syspath\n    from myutils import set_syspath\n    set_syspath(absolute_dependencies)\n\n    # on rend la configuration\n    return config\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 8-29\u00a0:  la cl\u00e9 [mailboxes] est associ\u00e9e \u00e0 la liste des bo\u00eetes \u00e0 lettres \u00e0 consulter\u00a0;</li> <li>ligne 20\u00a0: le serveur IMAP\u00a0;</li> <li>ligne 21\u00a0: son port de service\u00a0;</li> <li>lignes 22-23\u00a0: l'utilisateur dont on veut lire les mails\u00a0;</li> <li>ligne 24\u00a0: le nombre maximum de mails qu'on veut lire\u00a0;</li> <li>ligne 25\u00a0: indique s\u2019il faut \u00e9tablir une liaison s\u00e9curis\u00e9e avec le serveur IMAP (True) ou pas (False)\u00a0;</li> <li>ligne 26\u00a0: le d\u00e9lai d'attente maximum d'attente d'une r\u00e9ponse du serveur\u00a0;</li> <li>ligne 27\u00a0: dossier de sauvegarde des mails lus\u00a0; Le script [imap/main] est le suivant\u00a0:</li> </ul> <pre><code># imports\nimport email\nimport imaplib\nimport os\nimport shutil\n\n\n# -----------------------------------------------------------------------\n\ndef readmails(mailbox: dict):\n    \u2026\n\n\n# main ----------------------------------------------------------------\n#  client IMAP permettant de lire des mails\n\n# on r\u00e9cup\u00e8re la configuration de l'application\nimport config\nconfig = config.configure()\n\n# on traite les bo\u00eetes mail une par une\nfor mailbox in config['mailboxes']:\n    try:\n        # affichage console\n        print(\"----------------------------------\")\n        print(\n            f\"Lecture de la bo\u00eete mail POP3 {mailbox['user']} / {mailbox['server']}:{mailbox['port']}\")\n        # lecture de la bo\u00eete mail\n        readmails(mailbox)\n        # fin\n        print(\"Lecture termin\u00e9e...\")\n    # except BaseException as erreur:\n    #     # on affiche l'erreur\n    #     print(f\"L'erreur suivante s'est produite : {erreur}\")\n    finally:\n        pass\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 14-36\u00a0: nous retrouvons la d\u00e9marche d\u00e9j\u00e0 rencontr\u00e9e dans le script |pop3/02/main|\u00a0; La fonction [readmails] est la suivante\u00a0:</li> </ul> <pre><code>def readmails(mailbox: dict):\n    # on laisse remonter les exceptions\n    #\n    # module du parseur de mail\n    from mail_parser import save_message\n\n    # on r\u00e9cup\u00e8re des informations de configuration\n    output = mailbox['output']\n    user = mailbox['user']\n    password = mailbox['password']\n    timeout = mailbox['timeout']\n    server = mailbox['server']\n    port = int(mailbox['port'])\n    maxmails = mailbox['maxmails']\n    ssl = mailbox['ssl']\n    #\n    # c'est parti\n    imap_resource = None\n    try:\n        # on cr\u00e9e les dossiers de stockage s'ils n'existent pas\n        if not os.path.isdir(output):\n            os.mkdir(output)\n        # user\n        dir2 = f\"{output}/{user}\"\n        # on supprime le dossier [dir2] s'il existe puis on le recr\u00e9e\n        if os.path.isdir(dir2):\n            # suppression\n            shutil.rmtree(dir2)\n        # cr\u00e9ation\n        os.mkdir(dir2)\n        # connexion au serveur IMAP\n        if ssl:\n            imap_resource = imaplib.IMAP4_SSL(server, port)\n        else:\n            imap_resource = imaplib.IMAP4(server, port)\n        # timeout des communications du client\n        sock = imap_resource.socket()\n        sock.settimeout(timeout)\n        # authentification\n        imap_resource.login(user, password)\n        # on s\u00e9lectionne le dossier INBOX (courrier entrant)\n        imap_resource.select('INBOX')\n        # on r\u00e9cup\u00e8re tous les messages de ce dossier : crit\u00e8re ALL\n        # pas d'encoding particulier : None\n        typ1, data1 = imap_resource.search(None, 'ALL')\n        # print(f\"typ={typ1}, data={data1}\")\n\n        # data1[0] est un tableau d'octets r\u00e9unissant les n\u00b0s de tous les messages s\u00e9par\u00e9s par un espace\n        nums = data1[0].split()\n        imail = 0\n        fini = imail &gt;= maxmails or imail &gt;= len(nums)\n        # on lit les mails un \u00e0 un\n        while not fini:\n            # num est un n\u00b0 de message en binaire\n            num = nums[imail]\n            # print(f\"message n\u00b0 {num}\")\n\n            # on r\u00e9cup\u00e8re le msg n\u00b0 num\n            typ2, data2 = imap_resource.fetch(num, '(RFC822)')\n            # print(f\"type={typ2}, data={data2}\")\n\n            # data est une liste qui contient des tuples, ici un seul\n            # data[0] est le tuple, data[0][1] est le deuxi\u00e8me \u00e9l\u00e9ment du tuple\n            # data[0][1] contient une suite d'octets repr\u00e9sentant toutes les lignes du message\n            # par message il faut entendre texte du message + tous les fichiers attach\u00e9s\n\n            # on r\u00e9cup\u00e8re le message comme type email.message.Message\n            message = email.message_from_bytes(data2[0][1])\n            # dossier du message\n            dir3 = f\"{dir2}/message_{int(num)}\"\n            # si le dossier n'existe pas, on le cr\u00e9e\n            if not os.path.isdir(dir3):\n                os.mkdir(dir3)\n            # on le sauvegarde\n            save_message(dir3, message)\n            # message suivant\n            imail += 1\n            fini = imail &gt;= maxmails or imail &gt;= len(nums)\n    finally:\n        if imap_resource:\n            # on ferme la connexion avec la mailbox\n            imap_resource.close()\n            # on se d\u00e9connecte du serveur IMAP\n            imap_resource.logout()\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 7-15\u00a0: on r\u00e9cup\u00e8re les \u00e9l\u00e9ments de la configuration\u00a0;</li> <li>lignes 19, 79\u00a0: le code est contr\u00f4l\u00e9 par un try / finally. On n'intercepte donc pas les exceptions (absence de la clause except) qui vont alors remonter au code appelant qui les arr\u00eate et les affiche\u00a0;</li> <li>lignes 23-30\u00a0: on cr\u00e9e le dossier de sauvegarde des mails\u00a0;</li> <li>lignes 31-35\u00a0: on se connecte au serveur IMAP. La classe utilis\u00e9e est diff\u00e9rente selon qu'on a affaire \u00e0 un serveur IMAP s\u00e9curis\u00e9 (IMAP4_SSL) ou pas (IMAP4)\u00a0;</li> <li>lignes 36-38\u00a0: on fixe le timeout des communications client / serveur\u00a0;</li> <li>lignes 39-40\u00a0: on s'authentifie aupr\u00e8s du serveur IMAP\u00a0;</li> <li>lignes 41-42\u00a0: on a vu que la bo\u00eete mail d'un utilisateur IMAP pouvait \u00eatre organis\u00e9e en dossiers. Le dossier [INBOX] est celle du courrier entrant. Pour s\u00e9lectionner le dossier [dossier1] on \u00e9crirait [imapResource.select('dossier1')]\u00a0;</li> <li>lignes 43-45\u00a0: on demande la liste de tous les messages trouv\u00e9s dans [INBOX]\u00a0:</li> <li>le 1er param\u00e8tre de [imapResource.search] est un type d'encodage. [None] signifie \"pas de filtre sur l'encodage\"\u00a0;</li> <li>le 2e param\u00e8tre est un crit\u00e8re. Il y a diff\u00e9rentes fa\u00e7ons d'exprimer celui-ci. Le crit\u00e8re [ALL] signifie qu'on veut tous les messages du dossier\u00a0; Le r\u00e9sultat de [imapResource.search] ressemble \u00e0 ceci\u00a0:</li> </ul> <p>typ=OK, data=[b'1 2']</p> <p>[data] est une liste qui contient les n\u00b0s des messages obtenus. Ceux-ci sont en binaire. Ci-dessus, deux messages ont \u00e9t\u00e9 trouv\u00e9s dans le dossier [INBOX]\u00a0;</p> <ul> <li>ligne 49\u00a0: on r\u00e9cup\u00e8re les n\u00b0s des messages. Ci-dessus on aura la liste [b'1' b'2'], une liste de num\u00e9ros cod\u00e9s en binaire\u00a0;</li> <li>lignes 53-78\u00a0: on va boucler pour lire les messages du dossier [INBOX]\u00a0;</li> <li>lignes 54-55\u00a0: n\u00b0 du message\u00a0;</li> <li>lignes 58-59\u00a0: le message n\u00b0 [num] est demand\u00e9 au serveur IMAP\u00a0;</li> <li>le 1er param\u00e8tre est le n\u00b0 du message d\u00e9sir\u00e9\u00a0;</li> <li>le second param\u00e8tre est une cha\u00eene \"(part1)(part2)\u2026\" o\u00f9 [parti] est le nom d'une partie du message. Je n'ai pas approfondi ce point. Le nom (RFC822) d\u00e9signe la totalit\u00e9 du mail\u00a0; On re\u00e7oit quelque chose de la forme suivante\u00a0:</li> </ul> <pre><code>type=OK, data=[(b'1 (RFC822 {614}', b'Return-Path: guest@localhost\\r\\nReceived: from [127.0.0.1] (localhost [127.0.0.1])\\r\\n\\tby DESKTOP-528I5CU with ESMTPA\\r\\n\\t; Tue, 17 Mar 2020 09:41:50 +0100\\r\\nTo: guest@localhost\\r\\nFrom: \"guest@localhost\" &lt;guest@localhost&gt;\\r\\nSubject: test\\r\\nMessage-ID: &lt;2572d0f0-5b7c-2c31-5a70-c628293d5709@localhost&gt;\\r\\nDate: Tue, 17 Mar 2020 09:41:48 +0100\\r\\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:68.0) Gecko/20100101\\r\\n Thunderbird/68.6.0\\r\\nMIME-Version: 1.0\\r\\nContent-Type: text/plain; charset=utf-8; format=flowed\\r\\nContent-Transfer-Encoding: 8bit\\r\\nContent-Language: fr\\r\\n\\r\\nh\\xc3\\xa9l\\xc3\\xa8ne est all\\xc3\\xa9e au march\\xc3\\xa9 acheter des l\\xc3\\xa9gumes.\\r\\n\\r\\n'), b')']\n</code></pre> <p>L'\u00e9l\u00e9ment [data] est ici une liste \u00e0 1 \u00e9l\u00e9ment et cet unique \u00e9l\u00e9ment est un tuple de trois \u00e9l\u00e9ments\u00a0:</p> <pre><code>data = [\n    (b'1 (RFC822 {614}',\n     b'Return-Path: guest@localhost\\r\\nReceived: from [127.0.0.1] (localhost [127.0.0.1])\\r\\n\\tby DESKTOP-528I5CU with ESMTPA\\r\\n\\t; Tue, 17 Mar 2020 09:41:50 +0100\\r\\nTo: guest@localhost\\r\\nFrom: \"guest@localhost\" &lt;guest@localhost&gt;\\r\\nSubject: test\\r\\nMessage-ID: &lt;2572d0f0-5b7c-2c31-5a70-c628293d5709@localhost&gt;\\r\\nDate: Tue, 17 Mar 2020 09:41:48 +0100\\r\\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:68.0) Gecko/20100101\\r\\n Thunderbird/68.6.0\\r\\nMIME-Version: 1.0\\r\\nContent-Type: text/plain; charset=utf-8; format=flowed\\r\\nContent-Transfer-Encoding: 8bit\\r\\nContent-Language: fr\\r\\n\\r\\nh\\xc3\\xa9l\\xc3\\xa8ne est all\\xc3\\xa9e au march\\xc3\\xa9 acheter des l\\xc3\\xa9gumes.\\r\\n\\r\\n'),\n    b')'\n]\n</code></pre> <p>Le second \u00e9l\u00e9ment de ce tuple est une cha\u00eene binaire repr\u00e9sentant la totalit\u00e9 du message demand\u00e9. On reconna\u00eet ci-dessus, des \u00e9l\u00e9ments d\u00e9j\u00e0 pr\u00e9sent\u00e9s lors de l'\u00e9tude du module [mail_parser].</p> <p>data[0] repr\u00e9sente un tuple \u00e0 deux \u00e9l\u00e9ments. data[0][1] repr\u00e9sente les lignes du message sous une forme binaire.</p> <ul> <li>ligne 68\u00a0: la fonction [email.message_from_bytes(data2[0][1])] construit un objet de type [email.message.Message] \u00e0 partir des lignes du message. Le type [email.message.Message] est le type du param\u00e8tre du module [mail_parser] que nous avons \u00e9crit pr\u00e9c\u00e9demment\u00a0;</li> <li>lignes 69-73\u00a0: nous cr\u00e9ons le dossier de sauvegarde du message n\u00b0 [num]\u00a0;</li> <li>ligne 75\u00a0: nous faisons appel \u00e0 la fonction [save_message] du module [mail_parser] de la ligne 5. Cette fonction a \u00e9t\u00e9 d\u00e9crite au paragraphe |pop3/02/main|\u00a0;</li> <li>lignes 76-78\u00a0: on reboucle pour traiter le message suivant\u00a0;</li> <li>lignes 79-84\u00a0: qu'il y ait eu erreur ou pas\u00a0:</li> <li>ligne 82\u00a0: on cl\u00f4t la connexion avec le dossier interrog\u00e9\u00a0;</li> <li>ligne 84\u00a0: on se d\u00e9connecte du serveur IMAP\u00a0; Les r\u00e9sultats obtenus sont identiques \u00e0 ceux obtenus avec le script [pop3/02/main]. C'est normal puisque c'est le m\u00eame parseur de mail [mail_parser] qui est utilis\u00e9.</li> </ul>"},{"location":"installation-dx27un-environnement-de-travail.html","title":"2. Installation d'un environnement de travail","text":""},{"location":"installation-dx27un-environnement-de-travail.html#21-python-381","title":"2.1. Python 3.8.1","text":"<p>Les exemples de ce document ont \u00e9t\u00e9 test\u00e9s avec l'interpr\u00e9teur Python 3.8.1 disponible \u00e0 l'URL |https://www.python.org/downloads/| (f\u00e9v 2020) sur une machine Windows 10\u00a0:</p> <p></p> <p>L'installation de Python donne naissance \u00e0 l'arborescence de fichiers [1] et au menu [2] dans la liste des programmes\u00a0:</p> <p></p> <ul> <li>[3-4] : deux interpr\u00e9teurs Python interactifs ;</li> <li>[5] : la documentation Python ;</li> <li>[6] : la documentation des modules Python\u00a0; Nous n'utiliserons pas l'interpr\u00e9teur Python interactif. Il faut simplement savoir que les scripts de ce document pourraient \u00eatre ex\u00e9cut\u00e9s avec cet interpr\u00e9teur. Pratique pour tester le fonctionnement d'une fonctionnalit\u00e9 Python, il l'est peu pour des scripts devant \u00eatre r\u00e9utilis\u00e9s. Voici un exemple avec l'option [4] ci-dessus\u00a0:</li> </ul> <p></p> <p>Le prompt &gt;&gt;&gt; permet d'\u00e9mettre une instruction Python qui est imm\u00e9diatement ex\u00e9cut\u00e9e. Le code tap\u00e9 ci-dessus a la signification suivante\u00a0:</p> <pre><code>&gt;&gt;&gt; nom=\"tintin\"\n&gt;&gt;&gt; print(\"nom=%s\" % nom)\nnom=tintin\n&gt;&gt;&gt; print(\"type=%s\" % type(nom))\ntype=&lt;class 'str'&gt;\n&gt;&gt;&gt;\n</code></pre> <p>Lignes\u00a0:</p> <ul> <li>1\u00a0: initialisation d'une variable. En Python, on ne d\u00e9clare pas le type des variables. Celles-ci ont automatiquement le type de la valeur qu'on leur affecte. Ce type peut changer au cours du temps\u00a0;</li> <li>2\u00a0: affichage du nom. 'nom=%s' est un format d'affichage o\u00f9 %s est un param\u00e8tre formel d\u00e9signant une cha\u00eene de caract\u00e8res. nom est le param\u00e8tre effectif qui sera affich\u00e9 \u00e0 la place de %s\u00a0;</li> <li>3\u00a0: le r\u00e9sultat de l'affichage\u00a0;</li> <li>4\u00a0: l'affichage du type de la variable nom\u00a0;</li> <li>5\u00a0: la variable nom est ici de type class. Avec Python 2.7 elle aurait la valeur &lt;type 'str'&gt;\u00a0; Maintenant, ouvrons une console Windows\u00a0:</li> </ul> <p></p> <p>Le fait qu'on ait pu taper [python] en [1] et que l'ex\u00e9cutable [python.exe] ait \u00e9t\u00e9 trouv\u00e9 montre que celui-ci est dans le PATH de la machine Windows. C'est important car cela signifie que les outils de d\u00e9veloppement Python sauront trouver l'interpr\u00e9teur Python. On peut le v\u00e9rifier ainsi\u00a0:</p> <p></p> <ul> <li>en [2], on quitte l'interpr\u00e9teur Python\u00a0;</li> <li>en [3], la commande qui affiche le PATH des ex\u00e9cutables de la machine Windows\u00a0;</li> <li>en [4], on voit que le dossier de l'interpr\u00e9teur Python 3.8 fait partie du PATH\u00a0;</li> </ul>"},{"location":"installation-dx27un-environnement-de-travail.html#22-lide-pycharm-community","title":"2.2. L'IDE PyCharm Community","text":""},{"location":"installation-dx27un-environnement-de-travail.html#221-introduction","title":"2.2.1. Introduction","text":"<p>Pour construire et ex\u00e9cuter les scripts de ce document, nous avons utilis\u00e9 l'\u00e9diteur [PyCharm] \u00e9dition Community disponible (f\u00e9v 2020) \u00e0 l'URL |https://www.jetbrains.com/fr-fr/pycharm/download/#section=windows|\u00a0:</p> <p></p> <p>T\u00e9l\u00e9chargez l'IDE PyCharm Community [1-3] et installez-le.</p> <p>Lan\u00e7ons l'IDE PyCharm puis cr\u00e9ons un premier projet Python\u00a0:</p> <p></p> <p></p> <ul> <li>en [2-4], cr\u00e9ez un nouveau projet\u00a0; L'IDE PyCharm pr\u00e9sente le projet cr\u00e9\u00e9 sous la forme suivante\u00a0:</li> </ul> <p></p> <ul> <li>en [2-3], examinons les propri\u00e9t\u00e9s de l'IDE\u00a0;</li> </ul> <p></p> <ul> <li>en [4], l'interpr\u00e9teur Python qui sera utilis\u00e9 pour le projet\u00a0;</li> <li>en [5], une liste d\u00e9roulante des interpr\u00e9teurs disponibles\u00a0;</li> <li>en [6], on choisit l'interpr\u00e9teur t\u00e9l\u00e9charg\u00e9 au paragraphe |Python 3.8.1|\u00a0;</li> </ul> <p></p> <ul> <li>en [7], l'interpr\u00e9teur choisi\u00a0;</li> <li>en [8], la liste des packages disponibles avec cet interpr\u00e9teur. Les packages contiennent des modules que les scripts Python peuvent utiliser. Il existe des centaines de modules disponibles\u00a0; Commen\u00e7ons par cr\u00e9er un dossier dans lequel nous mettrons notre premier script Python\u00a0:</li> </ul> <p></p> <ul> <li>cliquer droit sur le projet, puis [1-2] pour cr\u00e9er un dossier\u00a0;</li> <li>en [3], tapez le nom du dossier\u00a0: il sera cr\u00e9\u00e9 dans le dossier du projet\u00a0; Puis cr\u00e9ons un script Python\u00a0:</li> </ul> <p></p> <ul> <li>cliquer droit sur le dossier [bases], puis [1-3]\u00a0;</li> <li>en [4-5], indiquez le nom du script\u00a0; \u00c9crivons notre premier script\u00a0:</li> </ul> <p></p> <ul> <li>en [3], nous \u00e9crivons le script suivant\u00a0:</li> <li>lignes 1, 3\u00a0: les commentaires commencent avec le signe #\u00a0;</li> <li>ligne 2\u00a0: initialisation d'une variable. Python ne d\u00e9clare pas le type de ses variables\u00a0;</li> <li>ligne 4\u00a0: affichage \u00e9cran. La syntaxe utilis\u00e9e ici est [format % donn\u00e9es] avec\u00a0:</li> <li>format\u00a0: nom=%s o\u00f9 %s d\u00e9signe l'emplacement d'une cha\u00eene de caract\u00e8res. Celle-ci sera trouv\u00e9e dans la partie [donn\u00e9es] de l'expression\u00a0;</li> <li>donn\u00e9es\u00a0: la valeur de la variable [nom] viendra remplacer le format %s dans la cha\u00eene de format\u00a0;</li> <li>avec [4-5], on reformate le code selon les recommandations de l'organisme g\u00e9rant Python\u00a0; Le script est ex\u00e9cut\u00e9 avec un clic droit sur le code [6]\u00a0:</li> </ul> <p></p> <ul> <li>en [7], la commande ex\u00e9cut\u00e9e\u00a0;</li> <li>en [8], le r\u00e9sultat de l'ex\u00e9cution\u00a0; Pour ex\u00e9cuter le script du document, t\u00e9l\u00e9chargez le code \u00e0 l'URL |https://tahe.developpez.com/tutoriels-cours/python-flask-2020/documents/python-flask-2020.rar| puis dans PyCharm proc\u00e9dez comme suit\u00a0:</li> </ul> <p></p> <ul> <li>en [1-2], ouverture d'un projet existant\u00a0: d\u00e9signer le dossier du code t\u00e9l\u00e9charg\u00e9\u00a0;</li> <li>en [3], le projet ouvert\u00a0;</li> <li>en [4-5], ex\u00e9cution de l'un des scripts du projet\u00a0;</li> </ul> <p></p> <ul> <li>en [7-8], les r\u00e9sultats de l'ex\u00e9cution\u00a0;</li> </ul>"},{"location":"installation-dx27un-environnement-de-travail.html#222-environnement-virtuel-dexecution","title":"2.2.2. Environnement virtuel d\u2019ex\u00e9cution","text":"<p>Notre environnement de travail est d\u00e9sormais op\u00e9rationnel. Nous allons cependant le modifier pour \u00e9crire les scripts de ce cours. Tout d\u2019abord, modifions la configuration de Pycharm\u00a0:</p> <p></p> <p>Dans la fen\u00eatre de droite\u00a0:</p> <ul> <li>par d\u00e9faut, la case [1] est coch\u00e9e. On la d\u00e9coche pour que Pycharm n\u2019ouvre pas par d\u00e9faut le dernier projet ouvert mais nous laisse choisir celui qu\u2019il faut ouvrir\u00a0;</li> <li>en [2], on ne confirme pas la sortie de Pycharm\u00a0lorsqu\u2019on ferme la fen\u00eatre de l\u2019application\u00a0;</li> <li>en [3], on ouvre les nouveaux projets dans une autre fen\u00eatre\u00a0;</li> <li>en [4], si on ferme Pycharm et qu\u2019un programme est en cours d\u2019ex\u00e9cution, celui-ci est arr\u00eat\u00e9\u00a0; Fermons maintenant Pycharm puis rouvrons-le\u00a0:</li> </ul> <p></p> <ul> <li>en [1], on cr\u00e9e un nouveau projet\u00a0;</li> <li>en [2], indiquer le dossier du projet\u00a0;</li> <li>en [3], prendre un environnement virtuel. Un environnement virtuel est propre au projet que l\u2019on cr\u00e9e. Il ne se m\u00e9lange pas avec les environnements virtuels d\u2019autres projets. Un projet Python / Flask utilise de nombreuses biblioth\u00e8ques externes qu\u2019il faut installer. Un projet P1 peut utiliser une biblioth\u00e8que B dans sa version v1 et un projet P2 utiliser la m\u00eame biblioth\u00e8que B mais dans sa version v2. Ces deux versions peuvent \u00eatre plus ou moins comptatibles. Or lorsqu\u2019on installe une biblioth\u00e8que dans sa version v2 et qu\u2019une version v1 est d\u00e9j\u00e0 install\u00e9e, celle-ci est \u00e9cras\u00e9e par la version v2. Cela peut \u00eatre probl\u00e9matique pour le projet qui utilisait la version v1 si la nouvelle version v2 n\u2019est pas totalement compatible avec la version v1. Pour \u00e9viter ces probl\u00e8mes, on isole chaque projet dans un environnement virtuel\u00a0;</li> <li>en [4], d\u00e9signer le dossier o\u00f9 seront rang\u00e9es les biblioth\u00e8ques python qui seront t\u00e9l\u00e9charg\u00e9es au cours du projet. Nous avons choisi ici un dossier [venv] (virtual environment) \u00e0 l\u2019int\u00e9rieur du dossier du projet. Rien n\u2019oblige \u00e0 faire cela\u00a0;</li> <li>en [5], l\u2019interpr\u00e9teur Python du projet. C\u2019est celui que nous avons install\u00e9 dans l\u2019\u00e9tape pr\u00e9c\u00e9dente\u00a0;</li> <li>en [6], cr\u00e9er le projet\u00a0;</li> </ul> <p></p> <ul> <li>en [7-8], le projet cr\u00e9\u00e9\u00a0;</li> <li>en [9], l\u2019environnement d\u2019ex\u00e9cution du projet, appel\u00e9 environnement virtuel\u00a0;</li> <li>en [10], le dossier [site-packages] est le dossier dans lequel seront rang\u00e9es les biblioth\u00e8ques t\u00e9l\u00e9charg\u00e9es ult\u00e9rieurement\u00a0;</li> </ul>"},{"location":"installation-dx27un-environnement-de-travail.html#223-git","title":"2.2.3. Git","text":"<p>Ensuite, on active un logiciel de contr\u00f4le du code source. Ce sera ici Git\u00a0[1-4] :</p> <p></p> <p>Un logiciel de contr\u00f4le du code source (VCS\u00a0: Version Control System) permet de suivre les \u00e9volutions d\u2019un projet. On peut prendre des photos, par une op\u00e9ration appel\u00e9e commit, du projet \u00e0 diff\u00e9rents moments de sa vie. Si on fait deux commit aux temps T et T+1, le VCS permet de conna\u00eetre ce qui a chang\u00e9 entre les deux versions commit\u00e9es. Normalement le VCS est utilis\u00e9 par une \u00e9quipe de d\u00e9veloppeurs. Ceux-ci font des commit de leur code lorsque celui-ci a \u00e9t\u00e9 d\u00fbment test\u00e9. A partir du VCS, les autres d\u00e9veloppeurs peuvent r\u00e9cup\u00e9rer ce code valid\u00e9 et l\u2019utiliser.</p> <p>Ici, il n\u2019y a qu\u2019un d\u00e9veloppeur. L\u2019exp\u00e9rience montre qu\u2019on peut avoir une application qui marche au temps T et ne marche plus au temps T+1. On voudrait bien alors revenir en arri\u00e8re au temps T pour repartir de z\u00e9ro. Le VCS permet cela et c\u2019est pour cette raison que l\u2019on va l\u2019utiliser ici.</p> <p>Nous montrons comment proc\u00e9der avec Git.</p> <p></p> <ul> <li>en [1], s\u00e9lectionner l\u2019onglet [Git] (en bas \u00e0 gauche)\u00a0;</li> <li>en [2], on voit qu\u2019il y a 495 fichiers du projet qui ne sont pas versionn\u00e9s par Git. Cela veut dire qu\u2019ils ne feront pas partie des photos du projet, lors des commit\u00a0;</li> <li> <p>en [3], le bouton du [commit] ou bouton de validation du projet. Comme il a \u00e9t\u00e9 dit, Git prend alors une photo du projet et la stocke dans un dossier [.git] \u00e0 la racine du projet (non affich\u00e9 par Pycharm mais visible dans l\u2019explorateur windows)\u00a0; Validons [3] le projet dans son \u00e9tat actuel.</p> </li> <li> <p>en [4], la liste des fichiers non versionn\u00e9s\u00a0;</p> </li> <li>en [5], la totalit\u00e9 de ces fichiers non versionn\u00e9s sont ceux de l\u2019environnement virtuel [venv]\u00a0;</li> <li> <p>en [6], tout commit doit s\u2019accompagner d\u2019un message. Le d\u00e9veloppeur met ici les modifications amen\u00e9es par la version qui va \u00eatre commit\u00e9e vis-\u00e0-vis de la derni\u00e8re version commit\u00e9e\u00a0; Certains dossiers ou fichiers peuvent \u00eatre ignor\u00e9s par Git. Ils ne font alors jamais partie de la photo. En [5] ci-dessus, cliquons droit sur le dossier [venv].</p> </li> <li> <p>en [1-3], on indique que le dossier [venv] ne doit pas faire partie des photos de Git. La liste des dossiers et fichiers ignor\u00e9s par Git sont mis dans un fichier appel\u00e9 [.gitignore] [4]\u00a0;</p> </li> </ul> <p></p> <p></p> <ul> <li>apr\u00e8s l\u2019op\u00e9ration pr\u00e9c\u00e9dente, tous les fichiers du dossier [venv] disparaissent de la liste des fichiers non versionn\u00e9s. Ne reste plus que le fichier [.gitignore] qui vient d\u2019\u00eatre cr\u00e9\u00e9\u00a0;</li> <li>en [5], nous le s\u00e9lectionnons pour qu\u2019il soit sauvegard\u00e9\u00a0;</li> <li>en [6], on cr\u00e9e un message de commit\u00a0:</li> <li>en [7], on valide. La photo du projet est alors prise\u00a0;</li> </ul> <p></p> <ul> <li>en [8-9], le contenu du fichier [.gitignore]\u00a0: une seule ligne avec le nom du dossier [/venv] qui indique que son contenu doit \u00eatre ignor\u00e9 dans les photos\u00a0; Montrons maintenant \u00e0 quoi peut nous servir Git. Tout d\u2019abord, nous cr\u00e9ons un dossier [git] (vous pouvez utiliser tout autre nom \u2013 il pourra \u00eatre d\u00e9truit \u00e0 la fin de la d\u00e9monstration)\u00a0:</li> </ul> <p></p> <ul> <li>en [1-5], on cr\u00e9e un dossier [git]\u00a0;</li> </ul> <p></p> <ul> <li>en [6-10], on cr\u00e9e un script Python [git_01]\u00a0;</li> </ul> <p></p> <ul> <li>en [11-12], le script ne contient qu\u2019un commentaire\u00a0;</li> <li>en [13-14], on cr\u00e9e une copie de [git_01]. Pour cela, s\u00e9lectionner [git_01] et faire Ctrl-C (Copier) puis (Ctrl-V) (Coller) et indiquer [git_02] comme nom de fichier\u00a0;</li> </ul> <p></p> <p>Maintenant, committons notre projet. Une photo va \u00eatre prise avec les deux fichiers [git_01, git_02]\u00a0;</p> <p></p> <ul> <li>en [1-3], on committe le projet\u00a0;</li> <li>en [4], on s\u00e9lectionne les fichiers non versionn\u00e9s qu\u2019on veut committer, ici tous\u00a0;</li> <li>en [5], on met le message identifiant le commit\u00a0;</li> <li>en [6], on valide\u00a0;</li> </ul> <p></p> <ul> <li>en [1-2], confirmation du commit\u00a0;</li> <li>en [3], on s\u00e9lectionne l\u2019onglet [Log]\u00a0;</li> <li>en [4], une vue des branches du projet. Ici, une seule branche appel\u00e9e [master]\u00a0;</li> <li>en [5-6], le commit qui vient d\u2019\u00eatre effectu\u00e9\u00a0; Maintenant cr\u00e9ons de la m\u00eame fa\u00e7on un script [git_03]\u00a0:</li> </ul> <p></p> <p>Modifions le script [git_02] et supprimons le script [git_01]\u00a0:</p> <p></p> <p>Puis committons la nouvelle version\u00a0:</p> <p></p> <p>Maintenant nous avons deux commits dans les logs\u00a0:</p> <p></p> <p>Lorsqu\u2019on s\u00e9lectionne un commit particulier, appara\u00eet sur sa droite l\u2019arbre des fichiers du projet\u00a0:</p> <p></p> <p>Maintenant supposons que le dernier commit nous ait amen\u00e9s \u00e0 une impasse et que l\u2019on voudrait revenir \u00e0 une situation correspondant \u00e0 l\u2019un des commit pr\u00e9c\u00e9dents\u00a0:</p> <p></p> <ul> <li>en [1-2], on s\u00e9lectionne le commit dans l\u2019\u00e9tat duquel on veut revenir\u00a0;</li> <li>en [3-5], existent plusieurs modes de reset. Nous choisissons le mode [hard] qui revient \u00e0 l\u2019\u00e9tat s\u00e9lectionn\u00e9 en perdant les changements qui ont \u00e9t\u00e9 faits depuis\u00a0;</li> </ul> <p></p> <ul> <li>en [6], on a r\u00e9cup\u00e9r\u00e9 [git_01] qui avait \u00e9t\u00e9 supprim\u00e9\u00a0;</li> <li>en [7-8], on retrouve [git_02] dans son \u00e9tat original sans la modification qui avait \u00e9t\u00e9 faite\u00a0;  Maintenant, modifions [git_02] et ajoutons [git_03] [1-4] :</li> </ul> <p></p> <p>Maintenant, refaisons l\u2019op\u00e9ration de revenir au commit initial\u00a0:</p> <p></p> <ul> <li>en [1-4], on revient \u00e0 la photo du commit n\u00b0 1\u00a0;</li> <li>en [5-6], on prend l\u2019option [Keep] au lieu de [Hard]. Ces options ne sont pas simples \u00e0 comprendre. Aussi faut-il les essayer\u00a0:</li> </ul> <ul> <li>en [1], le fichier [git_03] est toujours l\u00e0\u00a0;</li> <li>en [2-3], le fichier [git_02] a gard\u00e9 ses modifications\u00a0; Difficile de dire ce qu\u2019a fait ce [Revert Commit]. Maintenant committons la situation actuelle\u00a0:</li> </ul> <p></p> <ul> <li>en [1-6], le commit\u00a0;</li> </ul> <p></p> <ul> <li>en [9], on voit le nouveau commit\u00a0; Maintenant, essayons de revenir au commit 1 comme il a d\u00e9j\u00e0 \u00e9t\u00e9 fait\u00a0:</li> </ul> <ul> <li>en [1-6], on revient au commit n\u00b0 1 en mode [Hard]\u00a0;</li> </ul> <p></p> <ul> <li> <p>en [7-8], on a cette fois bien perdu toutes les modifications faites depuis le 1er commit\u00a0; Dans la suite, nous ne reviendrons plus sur [Git]. Le lecteur pourra travailler de la fa\u00e7on suivante\u00a0:</p> </li> <li> <p>il pourra suivre les exemples qui sont donn\u00e9s soit en les tapant lui-m\u00eame, soit en les r\u00e9cup\u00e9rant sur le site du cours\u00a0;</p> </li> <li>\u00e0 chaque fois qu\u2019un exemple fonctionne, il pourra committer son projet\u00a0;</li> <li>lorsqu\u2019il d\u00e9veloppe ses propres codes et qu\u2019il est dans une impasse, il sait qu\u2019il peut revenir \u00e0 une situation stable, en revenant \u00e0 un commit pr\u00e9c\u00e9dent\u00a0;</li> </ul>"},{"location":"installation-dx27un-environnement-de-travail.html#23-conventions-decriture-du-code-python","title":"2.3. Conventions d\u2019\u00e9criture du code Python","text":"<p>On peut \u00e9crire du code Python sans conventions d\u2019\u00e9criture et \u00e7a ne l\u2019emp\u00eachera pas de fonctionner. Mais il pourrait ne pas \u00eatre appr\u00e9ci\u00e9 de la communaut\u00e9 Python qui a \u00e9dict\u00e9 des conventions d\u2019\u00e9criture. Celles-ci sont r\u00e9sum\u00e9es dans un Post \u00e0 l\u2019adresse |https://stackoverflow.com/questions/159720/what-is-the-naming-convention-in-python-for-variable-and-function-names|\u00a0:</p> <p></p> <ul> <li>le nom d\u2019un module (module_name) suit une convention appel\u00e9e parfois [snake_case]\u00a0: tout en minuscules comportant \u00e9ventuellement des mots s\u00e9par\u00e9s par le caract\u00e8re soulign\u00e9. Cette convention [snake_case] s\u2019applique aux noms de m\u00e9thodes, de packages, de variables, de fonctions\u00a0;</li> <li>le nom d\u2019une classe (ClassName) suit une convention appel\u00e9e parfois [PascalCase]\u00a0: une suite de mots coll\u00e9s avec chaque lettre de d\u00e9but de mot en majuscule\u00a0;</li> <li>les noms de constantes suivent la convention [SNAKE_CASE]\u00a0: suite de mots en majuscules s\u00e9par\u00e9s par le caract\u00e8re soulign\u00e9\u00a0; Ces conventions ont \u00e9t\u00e9 globalement suivies dans ce document. N\u00e9anmoins pour les modules d\u00e9finissant une classe, j\u2019ai donn\u00e9 au module le m\u00eame nom que la classe qu\u2019il contient. Il suit donc la convention [PascalCase] au lieu de [snake_case]. Je voulais pouvoir rep\u00e9rer rapidement les modules de classes.</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html","title":"32. Le mode HTML de la version 12","text":"<p>Nous avions indiqu\u00e9 au d\u00e9but de la version 12 que nous allions d\u00e9velopper l\u2019application en plusieurs temps. Nous avions \u00e9crit\u00a0:</p> <ul> <li>\u00e0 partir des vues de l\u2019application HTML, nous allons d\u00e9finir les actions que doit impl\u00e9menter l\u2019application web. Nous allons ici utiliser les vues r\u00e9elles mais ce pourrait \u00eatre simplement des vues sur papier\u00a0;</li> <li>\u00e0 partir de ces actions, nous allons d\u00e9finir les URL de service de l\u2019application HTML\u00a0;</li> <li>nous allons impl\u00e9menter ces URL de service avec un serveur d\u00e9livrant du jSON. Cela permet de d\u00e9finir l\u2019ossature du serveur web sans se pr\u00e9occuper des pages HTML \u00e0 d\u00e9livrer. Nous testerons ces URL de service avec Postman\u00a0;</li> <li>nous testerons ensuite notre serveur jSON avec un client console\u00a0;</li> <li>une fois que le serveur jSON aura \u00e9t\u00e9 valid\u00e9, nous passerons \u00e0 l\u2019\u00e9riture de l\u2019application HTML\u00a0; Nous avons un serveur jSON et XML op\u00e9rationnel. On peut maintenant passer au serveur HTML. Nous allons voir que celui-ci reprend toute l\u2019architecture d\u00e9velopp\u00e9e pour le serveur jSON / XML et leur ajoute une gestion de vues HTML.</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#321-architecture-mvc","title":"32.1. Architecture MVC","text":"<p>Nous allons impl\u00e9menter le mod\u00e8le d'architecture dit MVC (Mod\u00e8le \u2013 Vue \u2013 Contr\u00f4leur) de la fa\u00e7on suivante\u00a0:</p> <p></p> <p>Le traitement d'une demande d'un client se d\u00e9roulera de la fa\u00e7on suivante\u00a0:</p> <ul> <li> <p>1 - demande Les URL demand\u00e9es seront de la forme http://machine:port/action/param1/param2/\u2026 Le [Contr\u00f4leur principal] utilisera un fichier de configuration pour \"\u00a0router\u00a0\" la demande vers le bon contr\u00f4leur. Pour cela, il utilisera le champ [action] de l'URL. Le reste de l'URL [param1/param2/\u2026] est form\u00e9 de param\u00e8tres facultatifs qui seront transmis \u00e0 l'action. Le C de MVC est ici la cha\u00eene [Contr\u00f4leur principal, Contr\u00f4leur / Action]. Si aucun contr\u00f4leur ne peut traiter l'action demand\u00e9e, le serveur web r\u00e9pondra que l'URL demand\u00e9e n'a pas \u00e9t\u00e9 trouv\u00e9e.</p> </li> <li> <p>2 - traitement</p> </li> <li>l'action choisie [2a] peut exploiter les param\u00e8tres parami que le [Contr\u00f4leur principal] lui a transmis. Ceux-ci pourront provenir de deux sources\u00a0:</li> <li>du chemin [/param1/param2/\u2026] de l'URL,</li> <li>de param\u00e8tres post\u00e9s dans le corps de la requ\u00eate du client\u00a0;</li> <li>dans le traitement de la demande de l'utilisateur, l'action peut avoir besoin de la couche [m\u00e9tier] [2b]. Une fois la demande du client trait\u00e9e, celle-ci peut appeler diverses r\u00e9ponses. Un exemple classique est\u00a0:</li> <li>une r\u00e9ponse d'erreur si la demande n'a pu \u00eatre trait\u00e9e correctement\u00a0;</li> <li>une r\u00e9ponse de confirmation sinon\u00a0;</li> <li>le [Contr\u00f4leur / Action] rendra sa r\u00e9ponse [2c] au contr\u00f4leur principal ainsi qu\u2019un code d\u2019\u00e9tat. Ces codes d\u2019\u00e9tat repr\u00e9senteront de fa\u00e7on unique l\u2019\u00e9tat dans lequel se trouve l\u2019application. Ce sera soit un code de r\u00e9ussite, soit un code d\u2019erreur\u00a0;</li> <li>3 - r\u00e9ponse</li> <li>selon que le client a demand\u00e9 une r\u00e9ponse jSON, XML ou HTML, le [Contr\u00f4leur principal] instanciera [3a] le type de r\u00e9ponse appropri\u00e9e et demandera \u00e0 celle-ci d\u2019envoyer la r\u00e9ponse au client. Le [Contr\u00f4leur principal] lui transmettra et la r\u00e9ponse et le code d\u2019\u00e9tat fournis par le [Contr\u00f4leur / Action] qui a \u00e9t\u00e9 ex\u00e9cut\u00e9\u00a0;</li> <li>si la r\u00e9ponse souhait\u00e9e est de type jSON ou XML, la r\u00e9ponse s\u00e9lectionn\u00e9e mettra en forme la r\u00e9ponse du [Contr\u00f4leur / Action] qu\u2019on lui a donn\u00e9e et l\u2019enverra [3c]. Le client capable d\u2019exploiter cette r\u00e9ponse peut \u00eatre un script console Python ou un script Javascript log\u00e9 dans une page HTML\u00a0;</li> <li>si la r\u00e9ponse souhait\u00e9e est de type HTML, la r\u00e9ponse s\u00e9lectionn\u00e9e s\u00e9lectionnera [3b] une des vues HTML [Vuei] \u00e0 l\u2019aide du code d\u2019\u00e9tat qu\u2019on lui a donn\u00e9. C\u2019est le V de MVC. A un code d\u2019\u00e9tat correspond une unique vue. Cette vue V va afficher la r\u00e9ponse du  [Contr\u00f4leur / Action] qui a \u00e9t\u00e9 ex\u00e9cut\u00e9. Elle habille avec du HTML, CSS, Javascript les donn\u00e9es de cette r\u00e9ponse. On appelle ces donn\u00e9es le mod\u00e8le de la vue. C'est le M de MVC. Le client est alors le plus souvent un navigateur\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#322-larborescence-des-scripts-du-serveur-html","title":"32.2. L\u2019arborescence des scripts du serveur HTML","text":"<ul> <li>en [1], les \u00e9l\u00e9ments statiques du serveur HTML\u00a0;</li> <li>en [2-3], les vues V du serveur HTML. Les fragments [2] sont des \u00e9l\u00e9ments r\u00e9utilisables dans les vues [3]\u00a0;</li> <li>en [4], un dossier qui servira aux tests des vues de fa\u00e7on statique\u00a0;</li> <li>en [5], le dossier des mod\u00e8les M des vues V, le M de MVC\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#323-presentation-des-vues","title":"32.3. Pr\u00e9sentation des vues","text":"<p>L\u2019application web HTML utilise quatre vues. La 1\u00e8re vue est la vue d\u2019authentification\u00a0:</p> <ul> <li>l\u2019action qui m\u00e8ne \u00e0 cette 1\u00e8re vue est l\u2019action [/init-session] [1]\u00a0;</li> </ul> <p></p> <ul> <li>le clic sur le bouton [Valider] d\u00e9clenche l\u2019action [/authentifier-utilisateur] avec deux param\u00e8tres post\u00e9s [2-3]\u00a0; La vue du calcul de l\u2019imp\u00f4t\u00a0:</li> </ul> <p></p> <ul> <li>en [1], l\u2019action [/authentifier-utilisateur] qui am\u00e8ne cette vue\u00a0;</li> <li>en [2], le clic sur le bouton [Valider] d\u00e9clenche l\u2019ex\u00e9cution de l\u2019action [/calculer-impot] avec trois param\u00e8tres post\u00e9s [2-5]\u00a0;</li> <li>le clic sur le lien [6] d\u00e9clenche l\u2019action [/lister-simulations] sans param\u00e8tres\u00a0;</li> <li>le clic sur le lien [7] d\u00e9clenche l\u2019action [/fin-session] sans param\u00e8tres\u00a0; La 3i\u00e8me vue est celle des simulations faites par l\u2019utilisateur authentifi\u00e9\u00a0:</li> </ul> <p></p> <ul> <li>en [1], l\u2019action [/lister-simulations] qui am\u00e8ne cette vue\u00a0;</li> <li>en [2], un clic sur le lien [Supprimer] d\u00e9clenche l\u2019action [/supprimer-simulation]\u00a0avec un param\u00e8tre, le n\u00b0 de la simulation \u00e0 supprimer dans la liste\u00a0;</li> <li>un clic sur le lien [3] d\u00e9clenche l\u2019action [/afficher-calcul-impot] sans param\u00e8tres qui r\u00e9affiche la vue du calcul de l\u2019imp\u00f4t\u00a0;</li> <li> <p>un clic sur le lien [4] d\u00e9clenche l\u2019action [/fin-session]\u00a0sans param\u00e8tres\u00a0; La 4i\u00e8me vue sera appel\u00e9e la vue des erreurs inattendues\u00a0:</p> </li> <li> <p>en [1]\u00a0: l\u2019utilisateur a tap\u00e9 lui-m\u00eame l\u2019URL. Or dans cet exemple il n\u2019y avait pas de simulations. On re\u00e7oit donc le message d\u2019erreur [2]. On conna\u00eet ce message. On l\u2019avait en jSON / XML. On appellera ce type d\u2019erreur, erreur inattendue, car elle ne peut pas se produire en utilisation normale de l\u2019application. C\u2019est lorsque l\u2019utilisateur tape lui-m\u00eame les URL qu\u2019elles peuvent de produire\u00a0;</p> </li> </ul> <p></p> <ul> <li>en cas d\u2019erreur inattendue, les liens [3-5] permettent de revenir \u00e0 l\u2019une des trois autres vues\u00a0; Rappelons les diff\u00e9rentes URL de service du serveur\u00a0jSON / XML\u00a0:</li> </ul> <p>Action</p><p>R\u00f4le</p><p>Contexte d\u2019ex\u00e9cution</p><p>/init-session</p><p>Sert \u00e0 fixer le type (json, xml, html) des r\u00e9ponses souhait\u00e9es</p><p>Requ\u00eate GET</p><p>Peut \u00eatre \u00e9mise \u00e0 tout moment</p><p>/authentifier-utilisateur</p><p>Autorise ou non un utilisateur \u00e0 se connecter</p><p>Requ\u00eate POST.</p><p>La requ\u00eate doit avoir deux param\u00e8tres post\u00e9s [user, password]</p><p>Ne peut \u00eatre \u00e9mise que si le type de la session (json, xml, html) est connu</p><p>/calculer-impot</p><p>Fait une simulation de calcul d\u2019imp\u00f4t</p><p>Requ\u00eate POST.</p><p>La requ\u00eate doit avoir trois param\u00e8tres post\u00e9s [mari\u00e9, enfants, salaire]</p><p>Ne peut \u00eatre \u00e9mise que si le type de la session (json, xml, html) est connu et l\u2019utilisateur authentifi\u00e9</p><p>/lister-simulations</p><p>Demande \u00e0 voir la liste des simulations op\u00e9r\u00e9es depuis le d\u00e9but de la session</p><p>Requ\u00eate GET.</p><p>Ne peut \u00eatre \u00e9mise que si le type de la session (json, xml, html) est connu et l\u2019utilisateur authentifi\u00e9</p><p>/supprimer-simulation/num\u00e9ro</p><p>Supprime une simulation de la liste des simulations</p><p>Requ\u00eate GET.</p><p>Ne peut \u00eatre \u00e9mise que si le type de la session (json, xml, html) est connu et l\u2019utilisateur authentifi\u00e9</p><p>/afficher-calcul-impot</p><p>Affiche la page HTML du calul de l\u2019imp\u00f4t</p><p>Requ\u00eate GET.</p><p>Ne peut \u00eatre \u00e9mise que si le type de la session (json, xml, html) est connu et l\u2019utilisateur authentifi\u00e9</p><p>/fin-session</p><p>Termine la session de simulations.</p><p>Techniquement l\u2019ancienne session web est supprim\u00e9e et une nouvelle session est cr\u00e9\u00e9e</p><p>Ne peut \u00eatre \u00e9mise que si le type de la session (json, xml, html) est connu et l\u2019utilisateur authentifi\u00e9</p> <p>Ces diff\u00e9rentes URL de service seront \u00e9galement utilis\u00e9es pour le serveur HTML.</p>"},{"location":"le-mode-html-de-la-version-12.html#324-configuration-des-vues","title":"32.4. Configuration des vues","text":"<p>Une action est trait\u00e9e par un contr\u00f4leur. Ce contr\u00f4leur rend un tuple (r\u00e9sultat, status_code) o\u00f9\u00a0:</p> <ul> <li>[r\u00e9sultat] est un dictionnaire de cl\u00e9s [action, \u00e9tat, r\u00e9ponse]\u00a0;</li> <li>[status_code] est le code de statut de la r\u00e9ponse HTTP qui sera faite au client\u00a0; Dans une session HTML, la page affich\u00e9e suite \u00e0 une action, d\u00e9pend du code d\u2019\u00e9tat rendu par le cntr\u00f4leur. Cette d\u00e9pendance est mat\u00e9rialis\u00e9e dans la configuration [config] de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0vues\u00a0HTML\u00a0et\u00a0leurs\u00a0mod\u00e8les\u00a0d\u00e9pendent\u00a0de\u00a0l'\u00e9tat\u00a0rendu\u00a0par\u00a0le\u00a0contr\u00f4leur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"views\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0d'authentification\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/init-session\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0700,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/authentifier-utilisateur\u00a0\u00e9chec\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0201\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-authentification.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForAuthentificationView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/authentifier-utilisateur\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0200,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/calculer-impot\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0300,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/calculer-impot\u00a0\u00e9chec\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0301,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/afficher-calcul-impot\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0800\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-calcul-impot.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForCalculImpotView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0de\u00a0la\u00a0liste\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/lister-simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0500,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/supprimer-simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0600\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-liste-simulations.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForListeSimulationsView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0des\u00a0erreurs\u00a0inattendues\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view-erreurs\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-erreurs.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForErreursView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0redirections\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"redirections\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0400,\u00a0\u00a0#\u00a0/fin-session\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"to\":\u00a0\"/init-session/html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0}\n</code></pre> <ul> <li>ligne 2-40\u00a0: [views] est une liste de vues. Raisonnons sur la vue des lignes 3-13\u00a0:</li> <li>ligne 11\u00a0: la vue V affich\u00e9e\u00a0;</li> <li>ligne 12\u00a0: l\u2019instance de classe charg\u00e9e de g\u00e9n\u00e9rer le mod\u00e8le M de cette vue\u00a0;</li> <li>lignes 5-10\u00a0: les \u00e9tats qui m\u00e8nent \u00e0 cette vue\u00a0;</li> <li>lignes 3-13\u00a0: la vue d\u2019authentification\u00a0;</li> <li>lignes 14-28\u00a0: la vue du calcul de l\u2019imp\u00f4t\u00a0;</li> <li>lignes 29-39\u00a0: la vue de la liste des simulations\u00a0;</li> <li>lignes 42-46\u00a0: la vue des erreurs inattendues\u00a0;</li> <li>lignes 49-57\u00a0: certains \u00e9tats m\u00e8nent \u00e0 une vue via une redirection. C\u2019est le cas de l\u2019\u00e9tat 400 qui est celui de l\u2019action [/fin-session] r\u00e9ussie. Il faut alors rediriger le client vers l\u2019action [http://machine:port/chemin/init-session/html]\u00a0; Nous pr\u00e9sentons maintenant les diff\u00e9rentes vues.</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#325-la-vue-dauthentification","title":"32.5. La vue d\u2019authentification","text":""},{"location":"le-mode-html-de-la-version-12.html#3251-presentation-de-la-vue","title":"32.5.1. Pr\u00e9sentation de la vue","text":"<p>La vue d\u2019authentification est la suivante\u00a0:</p> <p></p> <p>La vue est compos\u00e9e de deux \u00e9l\u00e9ments qu\u2019on appellera des fragments\u00a0:</p> <ul> <li>le fragment [1] est g\u00e9n\u00e9r\u00e9 par le fragment [v-bandeau.html]\u00a0;</li> <li>le fragment [2] est g\u00e9n\u00e9r\u00e9 par le fragment [v-authentification.html]\u00a0; La vue d\u2019authentification est g\u00e9n\u00e9r\u00e9e par la page [vue-authentification.html] suivante\u00a0:</li> </ul> <pre><code>&lt;!--\u00a0document\u00a0HTML\u00a0--&gt;\n&lt;!doctype\u00a0html&gt;\n&lt;html\u00a0lang=\"fr\"&gt;\n&lt;head&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0Required\u00a0meta\u00a0tags\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;meta\u00a0charset=\"utf-8\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;meta\u00a0name=\"viewport\"\u00a0content=\"width=device-width,\u00a0initial-scale=1,\u00a0shrink-to-fit=no\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0Bootstrap\u00a0CSS\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;link\u00a0rel=\"stylesheet\"\u00a0href=\"https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;title&gt;Application\u00a0imp\u00f4ts&lt;/title&gt;\n&lt;/head&gt;\n\n&lt;body&gt;\n&lt;div\u00a0class=\"container\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0bandeau\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0include\u00a0\"fragments/v-bandeau.html\"\u00a0%}\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0ligne\u00a0\u00e0\u00a0deux\u00a0colonnes\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"row\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-9\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{%\u00a0include\u00a0\"fragments/v-authentification.html\"\u00a0%}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0si\u00a0erreur\u00a0-\u00a0on\u00a0affiche\u00a0une\u00a0alerte\u00a0d'erreur\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0if\u00a0mod\u00e8le.error\u00a0%}\n\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"row\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-9\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"alert\u00a0alert-danger\"\u00a0role=\"alert\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Les\u00a0erreurs\u00a0suivantes\u00a0se\u00a0sont\u00a0produites\u00a0:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;ul&gt;{{mod\u00e8le.erreurs|safe}}&lt;/ul&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0endif\u00a0%}\n&lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 2\u00a0: un document HTML commence avec cette ligne\u00a0;</li> <li>lignes 3-36\u00a0: la page HTML est encapsul\u00e9e dans les balises &lt;html&gt; &lt;/html&gt;\u00a0;</li> <li>lignes 4-11\u00a0: ent\u00eate (head) du document HTML\u00a0;</li> <li>ligne 6\u00a0: la balise &lt;meta charset&gt; indique ici que le document est cod\u00e9 en UTF-8\u00a0;</li> <li>ligne 7\u00a0: la balise &lt;meta name=\u2019viewport\u2019&gt; fixe l\u2019affichage initial de la vue\u00a0: sur toute la largeur de l\u2019\u00e9cran qui l\u2019affiche (width) \u00e0 sa taille initiale (initial-scale) sans redimensionnement pour s\u2019adapter \u00e0 une taille plus petite d\u2019\u00e9cran (shrink-to-fit)\u00a0;</li> <li>ligne 9\u00a0: la balise &lt;link rel=\u2019stylesheet\u2019&gt; fixe le fichier CSS qui gouverne l\u2019apparence de la vue. Nous utilisons ici le framework CSS Bootstrap 4.4.1 [https://getbootstrap.com/docs/4.0/getting-started/introduction/]    ;</li> <li>ligne 10\u00a0: la balise &lt;title&gt; fixe le titre de la page\u00a0:</li> </ul> <p></p> <ul> <li>lignes 13-35\u00a0: le corps de la page web est encapsul\u00e9 dans les balises &lt;body&gt;&lt;/body&gt;\u00a0;</li> <li>lignes 14-34\u00a0: la balise &lt;div&gt; d\u00e9limite une section de la page affich\u00e9e. Les attributs [class] utilis\u00e9s dans la vue se r\u00e9f\u00e8rent tous au framework CSS Bootstrap. La balise &lt;div class=\u2019container\u2019&gt; (ligne 14) d\u00e9limite un conteneur Bootstrap\u00a0;</li> <li>ligne 26\u00a0: on inclut le fragment [v-bandeau.html]. Ce fragment g\u00e9n\u00e8re le bandeau [1] de la page. Nous le d\u00e9crirons bient\u00f4t\u00a0;</li> <li>lignes 18-22\u00a0: la balise &lt;div class=\u2019row\u2019&gt; d\u00e9limite une ligne Bootstrap. Ces lignes sont constitu\u00e9es de 12 colonnes\u00a0;</li> <li>ligne 19\u00a0: la balise &lt;div class=\u2019col-md-9\u2019&gt; d\u00e9limite une section de 9 colonnes\u00a0;</li> <li>ligne 20\u00a0: on inclut le fragment [v-authentification.html] qui affiche le formulaire d\u2019authentification [2] de la page. Nous le d\u00e9crirons bient\u00f4t\u00a0;</li> <li>lignes 24-33\u00a0: le code HTML de ces lignes n\u2019est utilis\u00e9 que si [mod\u00e8le.error] vaut True. Nous proc\u00e8derons toujours ainsi\u00a0: le mod\u00e8le d\u2019une vue HTML sera encapsul\u00e9 dans un dictionnaire [mod\u00e8le]\u00a0;</li> <li>lignes 24-33\u00a0: l\u2019authentification \u00e9choue si l\u2019utilisateur entre des identifiants incorrects. Dans ce cas, la vue d\u2019authentification est r\u00e9affich\u00e9e avec un message d\u2019erreur. L\u2019attribut [mod\u00e8le.error] indique s\u2019il faut afficher ce message d\u2019erreur\u00a0;</li> <li>lignes 27-30\u00a0: d\u00e9limitent une zone \u00e0 fond rose (class=\"alert alert-danger\") (ligne 27)\u00a0;</li> </ul> <p></p> <ul> <li>ligne 28\u00a0: un texte\u00a0;</li> <li> <p>ligne 29\u00a0: la balise HTML &lt;ul&gt; (unordered list) affiche une liste \u00e0 puces. Chaque \u00e9l\u00e9ment de la liste doit avoir la syntaxe &lt;li&gt;\u00e9l\u00e9ment&lt;/li&gt;. On affiche ici la valeur de [mod\u00e8le.erreurs]. Cette valeur est filtr\u00e9e (pr\u00e9sence de |) par le filtre [safe]. Par d\u00e9faut, lorsqu\u2019une cha\u00eene de caract\u00e8res doit \u00eatre envoy\u00e9e au navigateur, Flask \u2018neutralise\u2019 toutes les balises HTML qui pourraient s\u2019y trouver afin que le navigateur ne les interpr\u00e8te pas. Mais parfois on veut les interpr\u00e9ter. Ce sera ici le cas o\u00f9 la cha\u00eene [mod\u00e8le.erreurs] contiendra des balises HTML &lt;li&gt; et &lt;/li&gt; qui servent \u00e0 d\u00e9limiter un \u00e9l\u00e9ment de la liste. Dans ce cas, on utilise le filtre [safe] qui dit \u00e0 Flask que la cha\u00eene \u00e0 afficher est s\u00fbre (safe) et que donc il ne doit pas neutraliser les balises HTML qu\u2019il y trouvera\u00a0; Retenons de ce code les \u00e9l\u00e9ments dynamiques \u00e0 d\u00e9finir\u00a0:</p> </li> <li> <p>[mod\u00e8le.error]\u00a0: pour afficher un message d\u2019erreur\u00a0;</p> </li> <li>[mod\u00e8le.erreurs]\u00a0: une liste (au sens HTML du terme) de messages d\u2019erreur\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#3252-le-fragment-v-bandeauhtml","title":"32.5.2. Le fragment [v-bandeau.html]","text":"<p>Le fragment [v-bandeau.html] affiche le bandeau sup\u00e9rieur de toutes les vues de l\u2019application web\u00a0:</p> <p></p> <p>Le code du fragment [v-bandeau.html] est le suivant\u00a0:</p> <pre><code>&lt;!--\u00a0Bootstrap\u00a0Jumbotron\u00a0--&gt;\n&lt;div\u00a0class=\"jumbotron\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"row\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-4\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;img\u00a0src=\"{{\u00a0url_for('static',\u00a0filename='images/logo.jpg')\u00a0}}\"\u00a0alt=\"Cerisier\u00a0en\u00a0fleurs\"/&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-8\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;h1&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Calculez\u00a0votre\u00a0imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/h1&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n&lt;/div&gt;\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 2-13\u00a0: le bandeau est encapsul\u00e9 dans une section Bootstrap de type Jumbotron [&lt;div class=\"jumbotron\"&gt;]. Cette classe Bootstrap stylise d\u2019une fa\u00e7on particuli\u00e8re le contenu affich\u00e9 pour le faire ressortir\u00a0;</li> <li>lignes 3-12\u00a0: une ligne Bootstrap\u00a0;</li> <li>lignes 4-6\u00a0: une image [img] est plac\u00e9e dans les quatre premi\u00e8res colonnes de la ligne\u00a0;</li> <li>ligne 5\u00a0: la syntaxe\u00a0: <pre><code>{{\u00a0url_for('static',\u00a0filename='images/logo.jpg')\u00a0}}\n</code></pre></li> </ul> <p>utilise la fonction [url_for] de Flask. Ici, sa valeur sera l\u2019URL du fichier [images/logo.pg] du dossier [static]\u00a0;</p> <ul> <li>lignes 7-11\u00a0: les 8 autres colonnes de la ligne (on rappelle qu\u2019il y en a 12 au total) serviront \u00e0 placer un texte (ligne 9) en gros caract\u00e8res (&lt;h1&gt;, lignes 8-10)\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#3253-le-fragment-v-authentificationhtml","title":"32.5.3. Le fragment [v-authentification.html]","text":"<p>Le fragment [v-authentification.html] affiche le formulaire d\u2019authentification de l\u2019application web\u00a0:</p> <p></p> <p>Le code du fragment [v-authentification.html] est le suivant\u00a0:</p> <pre><code>&lt;!--\u00a0formulaire\u00a0HTML\u00a0-\u00a0on\u00a0poste\u00a0ses\u00a0valeurs\u00a0avec\u00a0l'action\u00a0[authentifier-utilisateur]\u00a0--&gt;\n&lt;form\u00a0method=\"post\"\u00a0action=\"/authentifier-utilisateur\"&gt;\n\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0titre\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"alert\u00a0alert-primary\"\u00a0role=\"alert\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;h4&gt;Veuillez\u00a0vous\u00a0authentifier&lt;/h4&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0formulaire\u00a0Bootstrap\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;fieldset\u00a0class=\"form-group\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a01\u00e8re\u00a0ligne\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"form-group\u00a0row\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0libell\u00e9\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;label\u00a0for=\"user\"\u00a0class=\"col-md-3\u00a0col-form-label\"&gt;Nom\u00a0d'utilisateur&lt;/label&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-4\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0zone\u00a0de\u00a0saisie\u00a0texte\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;input\u00a0type=\"text\"\u00a0class=\"form-control\"\u00a0id=\"user\"\u00a0name=\"user\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0placeholder=\"Nom\u00a0d'utilisateur\"\u00a0value=\"{{\u00a0mod\u00e8le.login\u00a0}}\" required&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a02i\u00e8me\u00a0ligne\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"form-group\u00a0row\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0libell\u00e9\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;label\u00a0for=\"password\"\u00a0class=\"col-md-3\u00a0col-form-label\"&gt;Mot\u00a0de\u00a0passe&lt;/label&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0zone\u00a0de\u00a0saisie\u00a0texte\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-4\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;input\u00a0type=\"password\"\u00a0class=\"form-control\"\u00a0id=\"password\"\u00a0name=\"password\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0placeholder=\"Mot\u00a0de\u00a0passe\" required&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0bouton\u00a0de\u00a0type\u00a0[submit]\u00a0sur\u00a0une\u00a03i\u00e8me\u00a0ligne\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"form-group\u00a0row\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-2\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;button\u00a0type=\"submit\"\u00a0class=\"btn\u00a0btn-primary\"&gt;Valider&lt;/button&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/fieldset&gt;\n\n&lt;/form&gt;\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 2-39\u00a0: la balise &lt;form&gt; d\u00e9limite un formulaire HTML. Celui-ci a en g\u00e9n\u00e9ral les caract\u00e9ristiques suivantes\u00a0:</li> <li>il d\u00e9finit des zones de saisies (balises &lt;input&gt; des lignes 17 et 27\u00a0;</li> <li>il a un bouton de type [submit] (ligne 34) qui envoie les valeurs saisies \u00e0 l\u2019URL indiqu\u00e9e dans l\u2019attribut [action] de la balise [form] (ligne 2). La m\u00e9thode HTTP utilis\u00e9e pour requ\u00eater cette URL est pr\u00e9cis\u00e9e dans l\u2019attribut [method] de la balise [form] (ligne 2)\u00a0;</li> <li>ici, lorsque l\u2019utilisateur va cliquer sur le bouton [Valider] (ligne 34), le navigateur va poster (ligne 2) les valeurs saisies dans le formulaire \u00e0 l\u2019URL [/authentifier-utilisateur] (ligne 2)\u00a0;</li> <li>les valeurs post\u00e9es sont les valeurs saisies par l\u2019utilisateur dans les zones de saisie des lignes 17 et 27. Elles seront post\u00e9es dans le corps de la requ\u00eate HTTP que fera le navigateur sous la forme [x-www-forl-urlencoded]. Les noms des param\u00e8tres [user, password] sont ceux des attributs [name] des zones de saisie des lignes 17 et 27\u00a0;</li> <li>ligne 5-7\u00a0: une section Bootstrap pour afficher un titre dans un fond bleu\u00a0:</li> <li>lignes 10-37\u00a0: un formulaire Bootstrap. Tous les \u00e9l\u00e9ments du formulaire vont alors \u00eatre stylis\u00e9s d\u2019une certaine fa\u00e7on\u00a0;</li> </ul> <p></p> <ul> <li>lignes 12-20\u00a0: d\u00e9finissent la 1re ligne Bootstrap du formulaire\u00a0:</li> </ul> <p></p> <ul> <li>la ligne 14 d\u00e9finit le libell\u00e9 [1] sur trois colonnes. L\u2019attribut [for] de la balise [label] relie le libell\u00e9 \u00e0 l\u2019attribut [id] de la zone de saisie de la ligne 17\u00a0;</li> <li>lignes 15-19\u00a0: met la zone de saisie dans un ensemble de quatre colonnes\u00a0;</li> <li>lignes 17-18\u00a0: la balise HTML [input] d\u00e9crit une zone de saisie. Elle a plusieurs param\u00e8tres\u00a0:</li> <li>[type=\u2019text\u2019]\u00a0: c\u2019est une zone de saisie texte. On peut y taper n\u2019importe quoi\u00a0;</li> <li>[class=\u2019form-control\u2019]\u00a0: style Bootstrap pour la zone de saisie\u00a0;</li> <li>[id=\u2019user\u2019]\u00a0: identifiant de la zone de saisie. Cet identifiant est en g\u00e9n\u00e9ral utilis\u00e9 par le CSS et le code Javascript\u00a0;</li> <li>[name=\u2019user\u2019]\u00a0: nom de la zone de saisie. C\u2019est sous ce nom que la valeur saisie par l\u2019utilisateur sera post\u00e9e par le navigateur [user=xx]\u00a0;</li> <li>[placeholder=\u2019invite\u2019]\u00a0: le texte affich\u00e9 dans la zone de saisie lorsque l\u2019utilisateur n\u2019a encore rien tap\u00e9\u00a0;</li> </ul> <p></p> <ul> <li>[value=\u2019valeur\u2019]\u00a0: le texte \u2018valeur\u2019 sera affich\u00e9 dans la zone de saisie d\u00e8s que celle-ci sera affich\u00e9e, avant donc que l\u2019utilisateur ne saisisse autre chose. Ce m\u00e9canisme est utilis\u00e9 en cas d\u2019erreur pour afficher la saisie qui a provoqu\u00e9 l\u2019erreur. Ici cette valeur sera la valeur de la variable [mod\u00e8le.login]\u00a0;</li> <li>[required]\u00a0: exige que l\u2019utilisateur mette une valeur pour que le formulaire puisse \u00eatre envoy\u00e9 au serveur\u00a0:</li> <li>lignes 21-30\u00a0: un code analogue pour la saisie du mot de passe\u00a0;</li> <li>ligne 27\u00a0: [type=\u2019password\u2019] fait qu\u2019on a une zone de saisie texte (on peut taper n\u2019importe quoi) mais les caract\u00e8tres tap\u00e9s sont cach\u00e9s\u00a0:</li> </ul> <p></p> <ul> <li>lignes 32-36\u00a0: une 3e ligne Bootstrap pour le bouton [Valider]\u00a0;</li> <li>ligne 34\u00a0: parce qu\u2019il a l\u2019attribut [type=submit], un clic sur ce bouton d\u00e9clenche l\u2019envoi au serveur par le navigateur des valeurs saisies comme il a \u00e9t\u00e9 expliqu\u00e9 pr\u00e9c\u00e9demment. L\u2019attribut CSS [class=\"btn btn-primary\"] affiche un bouton bleu\u00a0:</li> </ul> <p></p> <p>Il nous reste \u00e0 expliquer une derni\u00e8re chose. Ligne 2, l\u2019attribut [action=\"/authentifier-utilisateur\"] d\u00e9finit une URL incompl\u00e8te (elle ne commence pas par http://machine:port/chemin). Dans notre exemple, toutes les URL de l\u2019application sont de la forme [http://machine:port/chemin/action/param1/param2/..] o\u00f9 [http://machine:port/chemin] est la racine des URL de service. Dans [action=\"/authentifier-utilisateur\"] nous avons une URL absolue \u00e7-\u00e0-d mesur\u00e9e \u00e0 partir de la racine des URL. L\u2019URL compl\u00e8te du POST est donc [http://machine:port/chemin/authentifier-utilisateur] et c\u2019est ce qu\u2019utilisera le navigateur.</p> <p>On retiendra que ce fragment utilise le mod\u00e8le [mod\u00e8le.login].</p>"},{"location":"le-mode-html-de-la-version-12.html#3254-tests-visuels","title":"32.5.4. Tests visuels","text":"<p>On peut proc\u00e9der aux tests des vues bien avant leur int\u00e9gration dans l\u2019application. Il s\u2019agit ici de tester leur aspect visuel. Nous rassemblerons toutes les vues de test dans le dossier [tests_views] du projet\u00a0:</p> <p></p> <p>Pour tester la vue V [vue-authentification.html], il nous faut cr\u00e9er le mod\u00e8le M de donn\u00e9es qu\u2019elle va afficher. On le fait avec le script [test_vue_authentification.py]\u00a0:</p> <pre><code>from\u00a0flask\u00a0import\u00a0Flask,\u00a0render_template,\u00a0make_response\n\n#\u00a0application\u00a0Flask\napp\u00a0=\u00a0Flask(__name__,\u00a0template_folder=\"../templates\",\u00a0static_folder=\"../static\")\n\n#\u00a0Home\u00a0URL\n@app.route('/')\ndef\u00a0index():\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0encapsule\u00a0les\u00a0donn\u00e9es\u00a0de\u00a0la\u00a0pag\u00e9\u00a0dans\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le\u00a0=\u00a0{}\n\u00a0\u00a0\u00a0\u00a0#\u00a0identifiant\u00a0utilisateur\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"login\"]\u00a0=\u00a0\"albert\"\n\u00a0\u00a0\u00a0\u00a0#\u00a0liste\u00a0d'erreurs\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"error\"]\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0erreurs\u00a0=\u00a0[\"erreur1\",\u00a0\"erreur2\"]\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0construit\u00a0une\u00a0liste\u00a0HTML\u00a0des\u00a0erreurs\n\u00a0\u00a0\u00a0\u00a0content\u00a0=\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0for\u00a0erreur\u00a0in\u00a0erreurs:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0content\u00a0+=\u00a0f\"&lt;li&gt;{erreur}&lt;/li&gt;\"\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"erreurs\"]\u00a0=\u00a0content\n\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0de\u00a0la\u00a0page\n\u00a0\u00a0\u00a0\u00a0return\u00a0make_response(render_template(\"views/vue-authentification.html\",\u00a0mod\u00e8le=mod\u00e8le))\n\n#\u00a0main\nif\u00a0__name__\u00a0==\u00a0'__main__':\n\u00a0\u00a0\u00a0\u00a0app.config.update(ENV=\"development\",\u00a0DEBUG=True)\n\u00a0\u00a0\u00a0\u00a0app.run()\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 1-3\u00a0: on cr\u00e9e une application Flask dont le seul but est d\u2019afficher la vue [vue-authentification.html] (ligne 22)\u00a0;</li> <li>ligne 7\u00a0: l\u2019application n\u2019a qu\u2019une unique URL de service\u00a0;</li> <li>lignes 9-20\u00a0: la vue d\u2019authentification a des parties dynamiques contr\u00f4l\u00e9es par l\u2019objet [mod\u00e8le]. On appelle cet objet le mod\u00e8le de la vue. Selon l\u2019une des deux d\u00e9finitions donn\u00e9es pour le sigle MVC, on a l\u00e0 le M du MVC. Lors de la d\u00e9finition de la vue [vue-authentification.html], nous avions identifi\u00e9 trois valeurs dynamiques\u00a0:</li> <li>[mod\u00e8le.error]\u00a0: bool\u00e9en indiquant s\u2019il faut afficher un message d\u2019erreur\u00a0;</li> <li>[mod\u00e8le.erreurs]\u00a0: une liste HTML de messages d\u2019erreur\u00a0;</li> <li> <p>[mod\u00e8le.login]\u00a0: le login d\u2019un utilisateur\u00a0; Il nous faut donc d\u00e9finir ces trois valeurs dynamiques.</p> </li> <li> <p>lignes 9-20\u00a0: on d\u00e9finit les trois \u00e9l\u00e9ments dynamiques de la vue d\u2019authentification\u00a0; Pour faire le test, on lance le script [tests_views/test_vue_authentification.py] et on demande l\u2019URL [/localhost:5000/]\u00a0:</p> </li> </ul> <p>On poursuit ces tests visuels jusqu\u2019\u00e0 \u00eatre satisfait du r\u00e9sultat.</p> <p></p>"},{"location":"le-mode-html-de-la-version-12.html#3255-calcul-du-modele-de-la-vue","title":"32.5.5. Calcul du mod\u00e8le de la vue","text":"<p>Une fois l\u2019aspect visuel de la vue d\u00e9termin\u00e9, on peut proc\u00e9der au calcul du mod\u00e8le de la vue en conditions r\u00e9elles. Les mod\u00e8les des vues seront g\u00e9n\u00e9r\u00e9es par des classes rassembl\u00e9es dans le dossier [models_for_views]\u00a0:</p> <p></p> <p>Chaque classe g\u00e9n\u00e9rant un mod\u00e8le de vue respectera l\u2019interface [InterfaceModelForView] suivante\u00a0:</p> <pre><code>from\u00a0abc\u00a0import\u00a0ABC,\u00a0abstractmethod\n\nfrom\u00a0flask\u00a0import\u00a0Request\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nclass\u00a0InterfaceModelForView(ABC):\n\n\u00a0\u00a0\u00a0\u00a0@abstractmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0get_model_for_view(self,\u00a0request:\u00a0Request,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0pass\n</code></pre> <ul> <li>lignes 8-10\u00a0: la m\u00e9thode [get_model_for_view] est charg\u00e9e de produire un mod\u00e8le de vue encapsul\u00e9 dans un dictionnaire. Elle re\u00e7oit pour cela les informations suivantes\u00a0:</li> <li>[request, session, config] sont les m\u00eames param\u00e8tres utilis\u00e9s par le contr\u00f4leur de l\u2019action. Ils sont donc \u00e9galement transmis au mod\u00e8le\u00a0;</li> <li>le contr\u00f4leur a produit un r\u00e9sultat [r\u00e9sultat] qui est \u00e9galement transmis au mod\u00e8le. Ce r\u00e9sultat contient un \u00e9l\u00e9ment important [\u00e9tat] qui indique comme s\u2019est pass\u00e9e l\u2019ex\u00e9cution de l\u2019action en cours. Le mod\u00e8le va utiliser cette information\u00a0; Nous avons vu que dans la configuration [config] de l\u2019application, les codes d\u2019\u00e9tat rendus par les contr\u00f4leurs sont utilis\u00e9s pour d\u00e9signer la vue HTML \u00e0 afficher\u00a0:</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0vues\u00a0HTML\u00a0et\u00a0leurs\u00a0mod\u00e8les\u00a0d\u00e9pendent\u00a0de\u00a0l'\u00e9tat\u00a0rendu\u00a0par\u00a0le\u00a0contr\u00f4leur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"views\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0d'authentification\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/init-session\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0700,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/authentifier-utilisateur\u00a0\u00e9chec\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0201\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-authentification.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForAuthentificationView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/authentifier-utilisateur\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0200,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/calculer-impot\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0300,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/calculer-impot\u00a0\u00e9chec\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0301,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/afficher-calcul-impot\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0800\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-calcul-impot.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForCalculImpotView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0de\u00a0la\u00a0liste\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/lister-simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0500,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/supprimer-simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0600\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-liste-simulations.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForListeSimulationsView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0des\u00a0erreurs\u00a0inattendues\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view-erreurs\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-erreurs.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForErreursView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0redirections\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"redirections\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0400,\u00a0\u00a0#\u00a0/fin-session\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"to\":\u00a0\"/init-session/html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0}\n</code></pre> <p>Ce sont donc les codes d\u2019\u00e9tat [700, 201] (lignes 7 et 9) qui font afficher la vue d\u2019authentification. Pour retrouver la signification de ces codes, on peut s\u2019aider des tests [Postman] r\u00e9alis\u00e9s sur l\u2019application jSON\u00a0:</p> <ul> <li>[init-session-json-700]\u00a0: 700 est le code d\u2019\u00e9tat \u00e0 l\u2019issue d\u2019une action [init-session] r\u00e9ussie\u00a0: on pr\u00e9sente alors le formulaire d\u2019authentification vide\u00a0;</li> <li>[authentifier-utilisateur-201]\u00a0: 201 est le code d\u2019\u00e9tat \u00e0 l\u2019issue d\u2019une action [authentifier-utilisateur] ayant \u00e9chou\u00e9 (identifiants non reconnus)\u00a0: on pr\u00e9sente alors le formulaire d\u2019authentification pour qu\u2019il soit corrig\u00e9\u00a0; Maintenant que nous savons \u00e0 quels moments doit \u00eatre affich\u00e9 le formulaire d\u2019authentification, on peut calculer son mod\u00e8le dans [ModelForAuthentificationView]\u00a0(ligne 12) :</li> </ul> <pre><code>from\u00a0flask\u00a0import\u00a0Request\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceModelForView\u00a0import\u00a0InterfaceModelForView\n\nclass\u00a0ModelForAuthentificationView(InterfaceModelForView):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0get_model_for_view(self,\u00a0request:\u00a0Request,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0encapsule\u00a0les\u00a0donn\u00e9es\u00a0de\u00a0la\u00a0pag\u00e9\u00a0dans\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le\u00a0=\u00a0{}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tat\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00e9tat\u00a0=\u00a0r\u00e9sultat[\"\u00e9tat\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0mod\u00e8le\u00a0d\u00e9pend\u00a0de\u00a0l'\u00e9tat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0\u00e9tat\u00a0==\u00a0700:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0cas\u00a0de\u00a0l'affichage\u00a0du\u00a0formulaire\u00a0vide\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"login\"]\u00a0=\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0il\u00a0n'y\u00a0pas\u00a0d'erreur\u00a0\u00e0\u00a0afficher\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"error\"]\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0elif\u00a0\u00e9tat\u00a0==\u00a0201:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0authentification\u00a0erron\u00e9e\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9affiche\u00a0l'utilisateur\u00a0initialement\u00a0saisi\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"login\"]\u00a0=\u00a0request.form.get(\"user\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0il\u00a0y\u00a0a\u00a0une\u00a0erreur\u00a0\u00e0\u00a0afficher\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"error\"]\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0liste\u00a0HTML\u00a0de\u00a0msg\u00a0d'erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreurs\u00a0=\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for\u00a0erreur\u00a0in\u00a0r\u00e9sultat[\"r\u00e9ponse\"]:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0erreurs\u00a0+=\u00a0f\"&lt;li&gt;{erreur}&lt;/li&gt;\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"erreurs\"]\u00a0=\u00a0erreurs\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0mod\u00e8le\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 8\u00a0: la m\u00e9thode [get_model_for_view] de la vue d\u2019authentification doit fournir un dictionnaire avec trois cl\u00e9s [error, erreurs, login]. Ce calcul se fait \u00e0 partir du code d\u2019\u00e9tat rendu par le contr\u00f4leur de l\u2019action\u00a0;</li> <li>ligne 12\u00a0: on r\u00e9cup\u00e8re le code d\u2019\u00e9tat rendu par le contr\u00f4leur qui a trait\u00e9 l\u2019action en cours\u00a0;</li> <li>lignes 14-29\u00a0: le mod\u00e8le d\u00e9pend de ce code d\u2019\u00e9tat\u00a0;</li> <li>lignes 15-18\u00a0: cas o\u00f9 on doit afficher un formulaire d\u2019authentification vierge\u00a0;</li> <li>lignes 20-29\u00a0: cas de l\u2019authentification erron\u00e9e\u00a0: on raffiche l\u2019identifiant saisi pour l\u2019utilisateur et on affiche un message d\u2019erreur. L\u2019utilisateur au clavier peut alors r\u00e9essayer une autre authentification\u00a0;</li> <li>ligne 22\u00a0: l\u2019identifiant initialement saisi par l\u2019utilisateur peut \u00eatre retrouv\u00e9 dans la requ\u00eate du client\u00a0;</li> <li>ligne 24\u00a0: on signale qu\u2019il y a des erreurs \u00e0 afficher\u00a0;</li> <li>lignes 26-29\u00a0: en cas d\u2019erreur, r\u00e9sultat[\u2018r\u00e9ponse\u2019] contient une liste d\u2019erreurs\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#3256-generation-des-reponses-html","title":"32.5.6. G\u00e9n\u00e9ration des r\u00e9ponses HTML","text":"<p>Revenons au mod\u00e8le MVC de l\u2019application HTML\u00a0:</p> <ul> <li>en 2 (2a, 2b)\u00a0: le contr\u00f4leur ex\u00e9cute une action\u00a0;</li> </ul> <p></p> <ul> <li>en 3 (3a, 3b, 3c)\u00a0: une vue est choisie et envoy\u00e9e au client\u00a0; En [3a], un type de r\u00e9ponse (jSON, XML, HTML) est choisi. Nous avons vu comment les r\u00e9ponses jSON et XML \u00e9taient g\u00e9n\u00e9r\u00e9es mais pas encore les r\u00e9ponses HTML. Celles-ci sont g\u00e9n\u00e9r\u00e9es par la classe [HtmlResponse]\u00a0:</li> </ul> <p></p> <p>Rappelons comment dans le script principal [main] le type de r\u00e9ponse \u00e0 faire \u00e0 l\u2019utilisateur est d\u00e9termin\u00e9\u00a0:</p> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026.\n        #\u00a0on\u00a0construit\u00a0la\u00a0r\u00e9ponse\u00a0\u00e0\u00a0envoyer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response_builder\u00a0=\u00a0config[\"responses\"][type_response]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response,\u00a0status_code\u00a0=\u00a0response_builder\u00a0\\\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0.build_http_response(request,\u00a0session,\u00a0config,\u00a0status_code,\u00a0r\u00e9sultat)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0envoie\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0response,\u00a0status_code\n</code></pre> <p>o\u00f9, ligne 3, config[\u2018responses\u2019] est le dictionnaire suivant\u00a0:</p> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0diff\u00e9rents\u00a0types\u00a0de\u00a0r\u00e9ponse\u00a0(json,\u00a0xml,\u00a0html)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"responses\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"json\":\u00a0JsonResponse(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"html\":\u00a0HtmlResponse(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"xml\":\u00a0XmlResponse()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n</code></pre> <p>C\u2019est donc la classe [HtmlResponse] qui g\u00e9n\u00e8re la r\u00e9ponse HTML. Son code est le suivant\u00a0:</p> <pre><code>#\u00a0dictionnaire\u00a0des\u00a0r\u00e9ponses\u00a0HTML\u00a0selon\u00a0l'\u00e9tat\u00a0contenu\u00a0dans\u00a0le\u00a0r\u00e9sultat\n\nfrom\u00a0flask\u00a0import\u00a0make_response,\u00a0render_template\nfrom\u00a0flask.wrappers\u00a0import\u00a0Response\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceResponse\u00a0import\u00a0InterfaceResponse\n\nclass\u00a0HtmlResponse(InterfaceResponse):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0build_http_response(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0status_code:\u00a0int,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0(Response,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0r\u00e9ponse\u00a0HTML\u00a0d\u00e9pend\u00a0du\u00a0code\u00a0d'\u00e9tat\u00a0rendu\u00a0par\u00a0le\u00a0contr\u00f4leur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00e9tat\u00a0=\u00a0r\u00e9sultat[\"\u00e9tat\"]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0faut-il\u00a0faire\u00a0une\u00a0redirection\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for\u00a0redirection\u00a0in\u00a0config[\"redirections\"]:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tats\u00a0n\u00e9cessitant\u00a0une\u00a0redirection\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00e9tats\u00a0=\u00a0redirection[\"\u00e9tats\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0\u00e9tat\u00a0in\u00a0\u00e9tats:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0il\u00a0faut\u00a0faire\u00a0une\u00a0redirection\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(f\"/{redirection['to']}\"),\u00a0status.HTTP_302_FOUND\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e0\u00a0un\u00a0\u00e9tat,\u00a0correspond\u00a0une\u00a0vue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0cherche\u00a0celle-ci\u00a0dans\u00a0la\u00a0liste\u00a0des\u00a0vues\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0views_configs\u00a0=\u00a0config[\"views\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0trouv\u00e9\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0i\u00a0=\u00a00\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0parcourt\u00a0la\u00a0liste\u00a0des\u00a0vues\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0nb_views\u00a0=\u00a0len(views_configs)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0while\u00a0not\u00a0trouv\u00e9\u00a0and\u00a0i\u00a0&lt;\u00a0nb_views:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0n\u00b0\u00a0i\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_config\u00a0=\u00a0views_configs[i]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tats\u00a0associ\u00e9s\u00a0\u00e0\u00a0la\u00a0vue\u00a0n\u00b0\u00a0i\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00e9tats\u00a0=\u00a0view_config[\"\u00e9tats\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0est-ce\u00a0que\u00a0l'\u00e9tat\u00a0cherch\u00e9\u00a0se\u00a0trouve\u00a0dans\u00a0les\u00a0\u00e9tats\u00a0associ\u00e9s\u00a0\u00e0\u00a0la\u00a0vue\u00a0n\u00b0\u00a0i\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0\u00e9tat\u00a0in\u00a0\u00e9tats:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0trouv\u00e9\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0suivante\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0i\u00a0+=\u00a01\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0trouv\u00e9\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0trouv\u00e9:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0si\u00a0aucune\u00a0vue\u00a0n'existe\u00a0pour\u00a0l'\u00e9tat\u00a0actuel\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0vue\u00a0d'erreurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0view_config\u00a0=\u00a0config[\"view-erreurs\"]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0calcule\u00a0le\u00a0mod\u00e8le\u00a0de\u00a0la\u00a0vue\u00a0\u00e0\u00a0afficher\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0model_for_view\u00a0=\u00a0view_config[\"model_for_view\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le\u00a0=\u00a0model_for_view.get_model_for_view(request,\u00a0session,\u00a0config,\u00a0r\u00e9sultat)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0g\u00e9n\u00e8re\u00a0le\u00a0code\u00a0HTML\u00a0de\u00a0la\u00a0r\u00e9ponse\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0html\u00a0=\u00a0render_template(view_config[\"view_name\"],\u00a0mod\u00e8le=mod\u00e8le)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0construit\u00a0la\u00a0r\u00e9ponse\u00a0HTTP\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response\u00a0=\u00a0make_response(html)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0response.headers['Content-Type']\u00a0=\u00a0'text/html;\u00a0charset=utf-8'\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0response,\u00a0status_code\n</code></pre> <ul> <li>line 11\u00a0: la m\u00e9thode [build_http_response] charg\u00e9e de g\u00e9n\u00e9rer la r\u00e9ponse HTML re\u00e7oit les param\u00e8tres suivants\u00a0:</li> <li>[request, session, dict]\u00a0: ce sont les param\u00e8tres utilis\u00e9s par le contr\u00f4leur pour traiter l\u2019action en cours\u00a0;</li> <li>[status_code, r\u00e9sultat] sont les deux r\u00e9sultats produits par ce m\u00eame contr\u00f4leur\u00a0;</li> <li>ligne 14\u00a0: comme nous l\u2019avons dit, la r\u00e9ponse HTML du serveur d\u00e9pend du code d\u2019\u00e9tat contenu dans le dictionnaire [r\u00e9sultat]\u00a0;</li> <li>lignes 16-22\u00a0: on g\u00e8re d\u2019abord les redirections. Pour l\u2019instant nous allons ignorer ce cas jusqu\u2019au moment o\u00f9 on rencontrera un exemple de redirection. On notera que les redirections sont typiquement un cas d\u2019usage du serveur HTML. On ne rencontre pas ce cas avec les serveurs jSON ouXML\u00a0;</li> <li>lignes 24-41\u00a0: on cherche parmi les vues celle dont la liste [\u00e9tats] contient l\u2019\u00e9tat recherch\u00e9\u00a0;</li> <li> <p>lignes 42-46\u00a0: si aucune vue n\u2019a \u00e9t\u00e9 trouv\u00e9e, il s\u2019agit d\u2019une erreur inattendue. Prenons un exemple. Dans le fonctionnement normal de l\u2019application, l\u2019action [/supprimer-simulation] ne doit jamais boguer. En effet, nous allons voir que cette suppression de simulations se fait \u00e0 partir de liens g\u00e9n\u00e9r\u00e9s par le code. Ces liens sont corrects et ne peuvent mener \u00e0 une erreur. Cependant, nous l\u2019avons vu, l\u2019utilisateur peut taper directement l\u2019URL [/supprimer-simulation/id] et provoquer ainsi une erreur. Dans ce cas, le contr\u00f4leur [SupprimerSimulationController] rend un code d\u2019\u00e9tat 601. Or ce code d\u2019\u00e9tat ne se trouve pas dans la liste des codes d\u2019\u00e9tat menant \u00e0 l\u2019affichage d\u2019une page HTML. Ce sera donc la vue d\u2019erreur qui sera affich\u00e9e. Elle est d\u00e9finie ainsi dans la configuration\u00a0: <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0des\u00a0erreurs\u00a0inattendues\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view-erreurs\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-erreurs.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForErreursView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n</code></pre></p> </li> <li> <p>ligne 49\u00a0: une fois qu\u2019on conna\u00eet la vue \u00e0 afficher, on r\u00e9cup\u00e8re la classe g\u00e9n\u00e9rant son mod\u00e8le. Elle aussi se trouve dans la configuration [config]\u00a0;</p> </li> <li>ligne 50\u00a0: une fois cette classe trouv\u00e9e, on g\u00e9n\u00e8re le mod\u00e8le de la vue\u00a0;</li> <li>ligne 52\u00a0: une fois le mod\u00e8le M de la vue V calcul\u00e9, on peut g\u00e9n\u00e9rer le code HTML de la vue\u00a0;</li> <li>lignes 54-55\u00a0: on construit la r\u00e9ponse HTTP de la r\u00e9ponse avec un corps HTML\u00a0;</li> <li>lignes 56-57\u00a0: on rend la r\u00e9ponse HTTP avec son code de statut\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#3257-tests-postman","title":"32.5.7. Tests [Postman]","text":"<p>Nous allons ex\u00e9cuter des requ\u00eates produidant les codes [700, 201] qui affichent la vue d\u2019authentification\u00a0:</p> <ul> <li>[init-session-html-700]\u00a0: 700 est le code d\u2019\u00e9tat \u00e0 l\u2019issue d\u2019une action [init-session] r\u00e9ussie\u00a0: on pr\u00e9sente alors le formulaire d\u2019authentification vide\u00a0;</li> <li>[authentifier-utilisateur-201]\u00a0: 201 est le code d\u2019\u00e9tat \u00e0 l\u2019issue d\u2019une action [authentifier-utilisateur] ayant \u00e9chou\u00e9 (identifiants non reconnus)\u00a0: on pr\u00e9sente alors le formulaire d\u2019authentification pour qu\u2019il soit corrig\u00e9\u00a0; Il suffit de les r\u00e9utiliser et de voir s\u2019ils affichent bien la vue d\u2019authentification. On montre ici deux cas\u00a0:</li> </ul> <p>Cas 1\u00a0: [init-session-html-700], d\u00e9but d\u2019une session HTML\u00a0;</p> <p></p> <p>La r\u00e9ponse est la suivante\u00a0:</p> <p></p> <ul> <li>en [5], le mode [Preview] permet de visualiser la page HTML re\u00e7ue\u00a0;</li> <li>en [6], on a bien le formulaire vide attendu\u00a0;</li> <li>en [7], Postman n\u2019a pas suivi le lien de l\u2019image de la page\u00a0;</li> <li>en [8], le mode [Raw] donne acc\u00e8s au HTML re\u00e7u\u00a0;</li> </ul> <p></p> <ul> <li>en [3], le lien que Postman n\u2019a pas charg\u00e9. Il a affich\u00e9 la valeur de l\u2019attribut [alt=alternative] qui est affich\u00e9e lorsque l\u2019image ne peut \u00eatre charg\u00e9e. Ici c\u2019est plut\u00f4t que Postman n\u2019a pas voulu la charger. On peut le v\u00e9rifier en demandant l\u2019URL [http://localhost\u00a0:5000/static/images.logo.jpg] avec Postman\u00a0: Cas 2\u00a0: [authentifier-utilisateur-201], authentification erron\u00e9e</li> </ul> <p></p> <p>Maintenant, faisons une authentification erron\u00e9e, apr\u00e8s avoit fait une initialisation de session HTML r\u00e9ussie\u00a0:</p> <p></p> <p>Ci-dessus\u00a0:</p> <ul> <li>en [4,7]\u00a0: la requ\u00eate poste la cha\u00eene [user=bernard&amp;password=thibault]\u00a0; La r\u00e9ponse est la suivante\u00a0:</li> </ul> <p></p> <ul> <li>en [4], un message d\u2019erreur est affich\u00e9\u00a0;</li> <li>en [3], l\u2019utilisateur erron\u00e9 a \u00e9t\u00e9 r\u00e9affich\u00e9\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#3258-conclusion","title":"32.5.8. Conclusion","text":"<p>Nous avons pu tester la vue [vue-authentification.html] sans avoir \u00e9crit les autres vues. Cela a \u00e9t\u00e9 possible parce que\u00a0:</p> <ul> <li>tous les contr\u00f4leurs sont \u00e9crits\u00a0;</li> <li>[Postman] nous permet d\u2019\u00e9mettre des requ\u00eates vers le serveur sans avoir besoin de toutes les vues. Lorsqu\u2019on \u00e9crit les contr\u00f4leurs, il faut \u00eatre pr\u00eat \u00e0 traiter des requ\u00eates qu\u2019aucune vue ne permettrait. On ne doit jamais se dire a priori \u00ab\u00a0cette requ\u00eate est impossible\u00a0\u00bb\u00a0. Il faut v\u00e9rifier\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#326-la-vue-de-calcul-de-limpot","title":"32.6. La vue de calcul de l\u2019imp\u00f4t","text":""},{"location":"le-mode-html-de-la-version-12.html#3261-presentation-de-la-vue","title":"32.6.1. Pr\u00e9sentation de la vue","text":"<p>La vue de calcul de l\u2019imp\u00f4t est la suivante\u00a0:</p> <p></p> <p>La vue a trois parties\u00a0:</p> <ul> <li>1\u00a0: le bandeau sup\u00e9rieur est g\u00e9n\u00e9r\u00e9 par le fragment [v-bandeau.html] d\u00e9j\u00e0 pr\u00e9sent\u00e9\u00a0;</li> <li>2\u00a0: le formulaire de calcul de l\u2019imp\u00f4t g\u00e9n\u00e9r\u00e9 par le fragment [v-calcul-impot.html]\u00a0;</li> <li>3\u00a0: un menu pr\u00e9sentant deux liens, g\u00e9n\u00e9r\u00e9 par le fragment [v-menu.html]\u00a0; La vue de calcul de l\u2019imp\u00f4t est g\u00e9n\u00e9r\u00e9e par le code [vue-calcul-impot.html] suivant\u00a0:</li> </ul> <pre><code>&lt;!--\u00a0document\u00a0HTML\u00a0--&gt;\n&lt;!doctype\u00a0html&gt;\n&lt;html\u00a0lang=\"fr\"&gt;\n&lt;head&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0Required\u00a0meta\u00a0tags\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;meta\u00a0charset=\"utf-8\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;meta\u00a0name=\"viewport\"\u00a0content=\"width=device-width,\u00a0initial-scale=1,\u00a0shrink-to-fit=no\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0Bootstrap\u00a0CSS\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;link\u00a0rel=\"stylesheet\"\u00a0href=\"https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;title&gt;Application\u00a0imp\u00f4ts&lt;/title&gt;\n&lt;/head&gt;\n\n&lt;body&gt;\n&lt;div\u00a0class=\"container\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0bandeau\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0include\u00a0\"fragments/v-bandeau.html\"\u00a0%}\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0ligne\u00a0\u00e0\u00a0deux\u00a0colonnes\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"row\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0le\u00a0menu\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-3\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{%\u00a0include\u00a0\"fragments/v-menu.html\"\u00a0%}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0le\u00a0formulaire\u00a0de\u00a0calcul\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-9\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{%\u00a0include\u00a0\"fragments/v-calcul-impot.html\"\u00a0%}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0cas\u00a0du\u00a0succ\u00e8s\u00a0--&gt;\n\n\u00a0\u00a0\u00a0\u00a0{%\u00a0if\u00a0mod\u00e8le.success\u00a0%}\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0on\u00a0affiche\u00a0une\u00a0alerte\u00a0de\u00a0r\u00e9ussite\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"row\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-3\"&gt;\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-9\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"alert\u00a0alert-success\"\u00a0role=\"alert\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{{mod\u00e8le.imp\u00f4t}}&lt;/br&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{{mod\u00e8le.d\u00e9c\u00f4te}}&lt;/br&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{{mod\u00e8le.r\u00e9duction}}&lt;/br&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{{mod\u00e8le.surc\u00f4te}}&lt;/br&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{{mod\u00e8le.taux}}&lt;/br&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0endif\u00a0%}\n\n\u00a0\u00a0\u00a0\u00a0{%\u00a0if\u00a0mod\u00e8le.error\u00a0%}\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0liste\u00a0des\u00a0erreurs\u00a0sur\u00a09\u00a0colonnes\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"row\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-3\"&gt;\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-9\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"alert\u00a0alert-danger\"\u00a0role=\"alert\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Les\u00a0erreurs\u00a0suivantes\u00a0se\u00a0sont\u00a0produites\u00a0:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;ul&gt;{{mod\u00e8le.erreurs\u00a0|\u00a0safe}}&lt;/ul&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0endif\u00a0%}\n&lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>Commentaires</p> <ul> <li>nous ne commentons que des nouveaut\u00e9s encore non rencontr\u00e9es\u00a0;</li> <li>ligne 16\u00a0: inclusion du bandeau sup\u00e9rieur de la vue dans la premi\u00e8re ligne Bootstrap de la vue\u00a0;</li> <li>ligne 21\u00a0: inclusion du menu qui occupera trois colonnes de la seconde ligne Bootstrap de la vue\u00a0(lignes 18, 20)\u00a0;</li> <li>ligne 25\u00a0: inclusion du formulaire de calcul d\u2019imp\u00f4t qui occupera neuf colonnes (ligne 24) de la seconde ligne Bootstrap de la vue (ligne 18)\u00a0;</li> <li>lignes 30-46\u00a0: si le calcul de l\u2019imp\u00f4t r\u00e9ussit [mod\u00e8le.success=True], alors le r\u00e9sultat du calcul de l\u2019imp\u00f4t est affich\u00e9 dans un cadre vert (lignes 37-43). Ce cadre est dans la troisi\u00e8me ligne Bootstrap de la vue (ligne 32) et occupe neuf colonnes (ligne 36) \u00e0 droite de trois colonnes vides (lignes 33-35). Ce cadre sera donc sous le formulaire de calcul de l\u2019imp\u00f4t\u00a0;</li> <li>lignes 48-61\u00a0: si le calcul de l\u2019imp\u00f4t \u00e9choue [mod\u00e8le.error=True], alors un message d\u2019erreur est affich\u00e9 dans un cadre rose (lignes 55-58). Ce cadre est dans la troisi\u00e8me ligne Bootstrap de la vue (ligne 50) et occupe neuf colonnes (ligne 54) \u00e0 droite de trois colonnes vides (lignes 51-53). Ce cadre sera donc lui aussi sous le formulaire de calcul de l\u2019imp\u00f4t\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#3262-le-fragment-v-calcul-impothtml","title":"32.6.2. Le fragment [v-calcul-impot.html]","text":"<p>Le fragment [v-calcul-impot.html] affiche le formulaire de calcul de l\u2019imp\u00f4t de l\u2019application web\u00a0:</p> <p>Le code du fragment [v-calcul-impot.html] est le suivant\u00a0:</p> <p></p> <pre><code>&lt;!--\u00a0formulaire\u00a0HTML\u00a0post\u00e9\u00a0--&gt;\n&lt;form\u00a0method=\"post\"\u00a0action=\"/calculer-impot\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0message\u00a0sur\u00a012\u00a0colonnes\u00a0sur\u00a0fond\u00a0bleu\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-12\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"alert\u00a0alert-primary\"\u00a0role=\"alert\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;h4&gt;Remplissez\u00a0le\u00a0formulaire\u00a0ci-dessous\u00a0puis\u00a0validez-le&lt;/h4&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0\u00e9l\u00e9ments\u00a0du\u00a0formulaire\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;fieldset\u00a0class=\"form-group\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0premi\u00e8re\u00a0ligne\u00a0sur\u00a09\u00a0colonnes\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"row\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0libell\u00e9\u00a0sur\u00a04\u00a0colonnes\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;legend\u00a0class=\"col-form-label\u00a0col-md-4\u00a0pt-0\"&gt;Etes-vous\u00a0mari\u00e9(e)\u00a0ou\u00a0pacs\u00e9(e)?&lt;/legend&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0boutons\u00a0radio\u00a0sur\u00a05\u00a0colonnes--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-5\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"form-check\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;input\u00a0class=\"form-check-input\"\u00a0type=\"radio\"\u00a0name=\"mari\u00e9\"\u00a0id=\"gridRadios1\"\u00a0value=\"oui\"\u00a0{{mod\u00e8le.checkedOui}}&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;label\u00a0class=\"form-check-label\"\u00a0for=\"gridRadios1\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Oui\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/label&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"form-check\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;input\u00a0class=\"form-check-input\"\u00a0type=\"radio\"\u00a0name=\"mari\u00e9\"\u00a0id=\"gridRadios2\"\u00a0value=\"non\"\u00a0{{mod\u00e8le.checkedNon}}&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;label\u00a0class=\"form-check-label\"\u00a0for=\"gridRadios2\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Non\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/label&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0deuxi\u00e8me\u00a0ligne\u00a0sur\u00a09\u00a0colonnes\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"form-group\u00a0row\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0libell\u00e9\u00a0sur\u00a04\u00a0colonnes\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;label\u00a0for=\"enfants\"\u00a0class=\"col-md-4\u00a0col-form-label\"&gt;Nombre\u00a0d'enfants\u00a0\u00e0\u00a0charge&lt;/label&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0zone\u00a0de\u00a0saisie\u00a0num\u00e9rique\u00a0du\u00a0nombre\u00a0d'enfants\u00a0sur\u00a05\u00a0colonnes\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-5\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;input\u00a0type=\"number\"\u00a0min=\"0\"\u00a0step=\"1\"\u00a0class=\"form-control\"\u00a0id=\"enfants\"\u00a0name=\"enfants\"\u00a0placeholder=\"Nombre\u00a0d'enfants\u00a0\u00e0\u00a0charge\"\u00a0value=\"{{mod\u00e8le.enfants}}\" required&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0trois\u00e8me\u00a0ligne\u00a0sur\u00a09\u00a0colonnes\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"form-group\u00a0row\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0libell\u00e9\u00a0sur\u00a04\u00a0colonnes\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;label\u00a0for=\"salaire\"\u00a0class=\"col-md-4\u00a0col-form-label\"&gt;Salaire\u00a0annuel\u00a0net\u00a0imposable&lt;/label&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0zone\u00a0de\u00a0saisie\u00a0num\u00e9rique\u00a0pour\u00a0le\u00a0salaire\u00a0sur\u00a05\u00a0colonnes\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-5\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;input\u00a0type=\"number\"\u00a0min=\"0\"\u00a0step=\"1\"\u00a0class=\"form-control\"\u00a0id=\"salaire\"\u00a0name=\"salaire\"\u00a0placeholder=\"Salaire\u00a0annuel\u00a0net\u00a0imposable\"\u00a0aria-describedby=\"salaireHelp\"\u00a0value=\"{{mod\u00e8le.salaire}}\" required&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;small\u00a0id=\"salaireHelp\"\u00a0class=\"form-text\u00a0text-muted\"&gt;Arrondissez\u00a0\u00e0\u00a0l'euro\u00a0inf\u00e9rieur&lt;/small&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0quatri\u00e8me\u00a0ligne,\u00a0bouton\u00a0[submit]\u00a0sur\u00a05\u00a0colonnes\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"form-group\u00a0row\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-5\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;button\u00a0type=\"submit\"\u00a0class=\"btn\u00a0btn-primary\"&gt;Valider&lt;/button&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/fieldset&gt;\n\n&lt;/form&gt;\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 2\u00a0: le formulaire HTML sera post\u00e9 (attribut [method]) \u00e0 l\u2019URL [/calculer-impot] (attribut [action]). Les valeurs post\u00e9es seront les valeurs des zones de saisie\u00a0:</li> <li>la valeur du bouton radio coch\u00e9 sous la forme\u00a0:</li> <li>[mari\u00e9=oui] si le bouton radio [Oui] est coch\u00e9 (lignes 17-22). [mari\u00e9] est la valeur de l\u2019attribut [name] de la ligne 18, [oui] la valeur de l\u2019attribut [value] de la ligne 18\u00a0;</li> <li>[mari\u00e9=non] si le bouton radio [Non] est coch\u00e9 (lignes 23-28). [mari\u00e9] est la valeur de l\u2019attribut [name] de la ligne 24, [non] la valeur de l\u2019attribut [value] de la ligne 24\u00a0;</li> <li>la valeur de la zone de saisie num\u00e9rique de la ligne 37 sous la forme [enfants=xx] o\u00f9 [enfants] est la valeur de l\u2019attribut [name] de la ligne 37, et [xx] la valeur saisie par l\u2019utilisateur au clavier\u00a0;</li> <li> <p>la valeur de la zone de saisie num\u00e9rique de la ligne 46 sous la forme [salaire=xx] o\u00f9 [salaire] est la valeur de l\u2019attribut [name] de la ligne 46, et [xx] la valeur saisie par l\u2019utilisateur au clavier\u00a0; Finalement, la valeur post\u00e9e aura la forme [mari\u00e9=xx&amp;enfants=yy&amp;salaire=zz].</p> </li> <li> <p>les valeurs saisies seront post\u00e9es lorsque l\u2019utilisateur cliquera sur le bouton de type [submit] de la ligne 53\u00a0;</p> </li> <li>lignes 16-30\u00a0: les deux boutons radio\u00a0:</li> </ul> <p></p> <p>Les deux boutons radio font partie du m\u00eame groupe de boutons radio car ils ont le m\u00eame attribut [name] (lignes 18, 24). Le navigateur s\u2019assure que dans un groupe de boutons radio, un seul est coch\u00e9 \u00e0 un moment donn\u00e9. Donc cliquer sur l\u2019un d\u00e9sactive celui qui \u00e9tait coch\u00e9 auparavant\u00a0;</p> <ul> <li>ce sont des boutons radio \u00e0 cause de l\u2019attribut [type=\"radio\"] (lignes 18, 24)\u00a0;</li> <li>\u00e0 l\u2019affichage du formulaire (avant saisie), l\u2019un des boutons radio devra \u00eatre coch\u00e9\u00a0: il suffit pour cela d\u2019ajouter l\u2019attribut [checked=\u2019checked\u2019] \u00e0 la balise &lt;input type=\"radio\"&gt; concern\u00e9e. Cela est r\u00e9alis\u00e9 avec des variables dynamiques\u00a0:</li> <li>[mod\u00e8le.checkedOui] \u00e0 la ligne 18\u00a0;</li> <li> <p>[mod\u00e8le-&gt;checkedNon] \u00e0 la ligne 24\u00a0; Ces variables feront partie du mod\u00e8le de la vue.</p> </li> <li> <p>ligne 37\u00a0: une zone de saisie num\u00e9rique [type=\"number\"] avec une valeur minimale de 0 [min=\"0\"]. Dans les navigateurs r\u00e9cents, cela signifie que l\u2019utilisateur ne pourra saisir qu\u2019un nombre &gt;=0. Sur ces m\u00eames navigateurs r\u00e9cents, la saisie peut \u00eatre faite avec un variateur qu\u2019on peut cliquer \u00e0 la hausse ou \u00e0 la baisse. L\u2019attribut [step=\"1\"] de la ligne 37 indique que le variateur op\u00e8rera avec des sauts de 1 unit\u00e9. Cela a pour cons\u00e9quence que le variateur ne prendra pour valeur que des entiers progressant de 0 \u00e0 n avec un pas de 1. Pour la saisie manuelle, cela signifie que les nombres avec virgule ne seront pas accept\u00e9s\u00a0;</p> </li> <li>ligne 37\u00a0: lors de certains affichages, la zone de saisie des enfants devra \u00eatre pr\u00e9remplie avec la derni\u00e8re saisie faite dans cette zone. On utilise pour cela l\u2019attribut [value] qui fixe la valeur \u00e0 afficher dans la zone de saisie. Cette valeur sera dynamique et g\u00e9n\u00e9r\u00e9e par la variable [mod\u00e8le.enfants]\u00a0;</li> </ul> <p></p> <ul> <li>ligne 37\u00a0: l\u2019attribut [required] force l\u2019utilisateur \u00e0 saisir une donn\u00e9e pour que le formulaire soit valid\u00e9\u00a0;</li> <li>ligne 46\u00a0: m\u00eames explications pour la saisie du salaire que pour celle des enfants\u00a0;</li> <li>ligne 53\u00a0: le bouton de type [submit] qui d\u00e9clenche le POST des valeurs saisies \u00e0 l\u2019URL [/calculer-impot]\u00a0(ligne 2)\u00a0;</li> </ul> <p></p>"},{"location":"le-mode-html-de-la-version-12.html#3263-le-fragment-v-menuhtml","title":"32.6.3. Le fragment [v-menu.html]","text":"<p>Ce fragment affiche un menu \u00e0 gauche du formulaire de calcul de l\u2019imp\u00f4t\u00a0:</p> <p></p> <p>Le code de ce fragment est le suivant\u00a0:</p> <pre><code>&lt;!--\u00a0menu\u00a0Bootstrap\u00a0--&gt;\n&lt;nav\u00a0class=\"nav\u00a0flex-column\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0affichage\u00a0d'une\u00a0liste\u00a0de\u00a0liens\u00a0HTML\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0for\u00a0optionMenu\u00a0in\u00a0mod\u00e8le.optionsMenu\u00a0%}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;a\u00a0class=\"nav-link\"\u00a0href=\"{{optionMenu.url}}\"&gt;{{optionMenu.text}}&lt;/a&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0endfor\u00a0%}\n&lt;/nav&gt;\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 2-7\u00a0: la balise HTML [nav] encadre une portion de document HTML pr\u00e9sentant des liens de navigation vers d\u2019autres documents\u00a0;</li> <li>ligne 5\u00a0: la balise HTML [a] introduit un lien de navigation\u00a0:</li> <li> <p>[optionMenu.url]\u00a0: est l\u2019URL vers laquelle on navigue lorsqu\u2019on clique sur le lien [optionMenu.text]. C\u2019est alors une op\u00e9ration [GET optionMenu.url] qui est faite par le navigateur. [optionMenu.url] sera une URL absolue mesur\u00e9e \u00e0 partir de la racine [http://machine\u00a0:port/chemin] de l\u2019application. Ainsi en [1], on cr\u00e9era le lien\u00a0: <pre><code>&lt;a href=\u2019/lister-simulations\u2019&gt;Liste des simulations&lt;/a&gt;\n</code></pre></p> </li> <li> <p>ligne 5\u00a0: le mod\u00e8le [mod\u00e8le.optionsMenu] du fragment sera une liste de la forme\u00a0: <pre><code>[\u2018Liste des simulations\u2019:\u2019/liste-simulations\u2019,\n\u2018Fin de session\u2019:\u2019/fin-session\u2019]\n</code></pre></p> </li> <li> <p>lignes 2, 7\u00a0: les classes CSS [nav, flex-column, nav-link] sont des classes Bootstrap qui donnent son apparence au menu\u00a0;</p> </li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#3264-test-visuel","title":"32.6.4. Test visuel","text":"<p>Nous rassemblons ces diff\u00e9rents \u00e9l\u00e9ments dans le dossier [Tests] et nous cr\u00e9ons un mod\u00e8le de test pour la vue [vue-calcul-impot.html]\u00a0:</p> <p></p> <p>Le script de test [test_vue_calcul_impot] sera le suivant\u00a0:</p> <pre><code>from\u00a0flask\u00a0import\u00a0Flask,\u00a0render_template,\u00a0make_response\n\n#\u00a0application\u00a0Flask\napp\u00a0=\u00a0Flask(__name__,\u00a0template_folder=\"../templates\",\u00a0static_folder=\"../static\")\n\n#\u00a0Home\u00a0URL\n@app.route('/')\ndef\u00a0index():\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0encapsule\u00a0les\u00a0donn\u00e9es\u00a0de\u00a0la\u00a0pag\u00e9\u00a0dans\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le\u00a0=\u00a0{}\n\u00a0\u00a0\u00a0\u00a0#\u00a0formulaire\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"checkedOui\"]\u00a0=\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"checkedNon\"]\u00a0=\u00a0'checked=\"checked\"'\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"enfants\"]\u00a0=\u00a02\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"salaire\"]\u00a0=\u00a0300000\n\u00a0\u00a0\u00a0\u00a0#\u00a0message\u00a0de\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"success\"]\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"imp\u00f4t\"]\u00a0=\u00a0\"Montant\u00a0de\u00a0l'imp\u00f4t\u00a0:\u00a01000\u00a0euros\"\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"d\u00e9c\u00f4te\"]\u00a0=\u00a0\"D\u00e9c\u00f4te\u00a0:\u00a015\u00a0euros\"\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"r\u00e9duction\"]\u00a0=\u00a0\"R\u00e9duction\u00a0:\u00a020\u00a0euros\"\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"surc\u00f4te\"]\u00a0=\u00a0\"Surc\u00f4te\u00a0:\u00a00\u00a0euros\"\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"taux\"]\u00a0=\u00a0\"Taux\u00a0d'imposition\u00a0:\u00a014\u00a0%\"\n\u00a0\u00a0\u00a0\u00a0#\u00a0message\u00a0d'erreur\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"error\"]\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0erreurs\u00a0=\u00a0[\"erreur1\",\u00a0\"erreur2\"]\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0construit\u00a0une\u00a0liste\u00a0HTML\u00a0des\u00a0erreurs\n\u00a0\u00a0\u00a0\u00a0content\u00a0=\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0for\u00a0erreur\u00a0in\u00a0erreurs:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0content\u00a0+=\u00a0f\"&lt;li&gt;{erreur}&lt;/li&gt;\"\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"erreurs\"]\u00a0=\u00a0content\n\u00a0\u00a0\u00a0\u00a0#\u00a0menu\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"optionsMenu\"]\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\"text\":\u00a0'Liste\u00a0des\u00a0simulations',\u00a0\"url\":\u00a0'/lister-simulations'},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\"text\":\u00a0'Fin\u00a0de\u00a0session',\u00a0\"url\":\u00a0'/fin-session'}]\n\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0de\u00a0la\u00a0page\n\u00a0\u00a0\u00a0\u00a0return\u00a0make_response(render_template(\"views/vue-calcul-impot.html\",\u00a0mod\u00e8le=mod\u00e8le))\n\n#\u00a0main\nif\u00a0__name__\u00a0==\u00a0'__main__':\n\u00a0\u00a0\u00a0\u00a0app.config.update(ENV=\"development\",\u00a0DEBUG=True)\n\u00a0\u00a0\u00a0\u00a0app.run()\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 9-34\u00a0: on initialise toutes les parties dynamiques de la vue [vue-calcul-impot.html] et des fragments [v-calcul-impot.html] et [v-menu.html]\u00a0;</li> <li>ligne 36\u00a0: on affiche la vue [vue-calcul-impot.html]\u00a0; Lorsqu\u2019on ex\u00e9cute le script de test [test_vue_calcul_impot], on obtient le r\u00e9sultat suivant\u00a0:</li> </ul> <p>On travaille sur cette vue jusqu\u2019\u00e0 ce que le r\u00e9sultat obtenu visuellement nous convienne. On peut ensuite passer \u00e0 l\u2019int\u00e9gration de la vue dans l\u2019application web en cours d\u2019\u00e9criture.</p> <p></p>"},{"location":"le-mode-html-de-la-version-12.html#3265-calcul-du-modele-de-la-vue","title":"32.6.5. Calcul du mod\u00e8le de la vue","text":"<p>Une fois l\u2019aspect visuel de la vue d\u00e9termin\u00e9, on peut proc\u00e9der au calcul du mod\u00e8le de la vue en conditions r\u00e9elles. Rappelons les codes d\u2019\u00e9tat qui m\u00e8nent \u00e0 cette vue. On les trouve dans le fichier de configuration\u00a0:</p> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/authentifier-utilisateur\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0200,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/calculer-impot\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0300,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/calculer-impot\u00a0\u00e9chec\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0301,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/afficher-calcul-impot\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0800\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-calcul-impot.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForCalculImpotView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n</code></pre> <p>Ce sont donc les codes d\u2019\u00e9tat [200, 300, 301, 800] qui font afficher la vue de calcul de l\u2019imp\u00f4t. Pour retrouver la signification de ces codes, on peut s\u2019aider des tests [Postman] r\u00e9alis\u00e9s sur l\u2019application jSON\u00a0:</p> <ul> <li>[authentifier-utilisateur-200]\u00a0: 200 est le code d\u2019\u00e9tat \u00e0 l\u2019issue d\u2019une action [authentifier-utilisateur] r\u00e9ussie\u00a0: on pr\u00e9sente alors le formulaire de calcul d\u2019imp\u00f4t vide\u00a0;</li> <li>[calculer-impot-300]\u00a0: 300 est le code d\u2019\u00e9tat \u00e0 l\u2019issue d\u2019une action [calculer-impot] r\u00e9ussie. On affiche alors le formulaire de calcul avec les donn\u00e9es qui y ont \u00e9t\u00e9 saisies et le montant de l\u2019imp\u00f4t. L\u2019utilisateur peut alors refaire un autre calcul\u00a0;</li> <li>le code d\u2019\u00e9tat [301] est celui obtenu pour un calcul d\u2019imp\u00f4t erron\u00e9\u00a0;</li> <li>le code d\u2019\u00e9tat [800] sera pr\u00e9sent\u00e9 ult\u00e9rieurement. Nous ne l\u2019avons pas encore rencontr\u00e9\u00a0; Maintenant que nous savons \u00e0 quels moments doit \u00eatre affich\u00e9 le formulaire de calcul de l\u2019imp\u00f4t, on peut calculer son mod\u00e8le dans la classe [ModelForCalculImpotView]\u00a0:</li> </ul> <p></p> <pre><code>from\u00a0flask\u00a0import\u00a0Request\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceModelForView\u00a0import\u00a0InterfaceModelForView\n\nclass\u00a0ModelForCalculImpotView(InterfaceModelForView):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0get_model_for_view(self,\u00a0request:\u00a0Request,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0encapsule\u00a0les\u00a0donn\u00e9es\u00a0de\u00a0la\u00a0vue\u00a0dans\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le\u00a0=\u00a0{}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tat\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00e9tat\u00a0=\u00a0r\u00e9sultat[\"\u00e9tat\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0mod\u00e8le\u00a0d\u00e9pend\u00a0de\u00a0l'\u00e9tat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0\u00e9tat\u00a0in\u00a0[200,\u00a0800]:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0initial\u00a0d'un\u00a0formulaire\u00a0vide\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"success\"]\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"error\"]\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"checkedNon\"]\u00a0=\u00a0'checked=\"checked\"'\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"checkedOui\"]\u00a0=\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"enfants\"]\u00a0=\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"salaire\"]\u00a0=\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0elif\u00a0\u00e9tat\u00a0==\u00a0300:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0r\u00e9ussite\u00a0du\u00a0calcul\u00a0-\u00a0affichage\u00a0du\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"success\"]\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"error\"]\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"imp\u00f4t\"]\u00a0=\u00a0f\"Montant\u00a0de\u00a0l'imp\u00f4t\u00a0:\u00a0{r\u00e9sultat['r\u00e9ponse']['imp\u00f4t']}\u00a0euros\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"d\u00e9c\u00f4te\"]\u00a0=\u00a0f'D\u00e9c\u00f4te\u00a0:\u00a0{r\u00e9sultat[\"r\u00e9ponse\"][\"d\u00e9c\u00f4te\"]}\u00a0euros'\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"r\u00e9duction\"]\u00a0=\u00a0f\"R\u00e9duction\u00a0:\u00a0{r\u00e9sultat['r\u00e9ponse']['r\u00e9duction']}\u00a0euros\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"surc\u00f4te\"]\u00a0=\u00a0f'Surc\u00f4te\u00a0:\u00a0{r\u00e9sultat[\"r\u00e9ponse\"][\"surc\u00f4te\"]}\u00a0euros'\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"taux\"]\u00a0=\u00a0f\"Taux\u00a0d'imposition\u00a0:\u00a0\u00a0{r\u00e9sultat['r\u00e9ponse']['taux']\u00a0*\u00a0100}\u00a0%\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0formulaire\u00a0r\u00e9tabli\u00a0avec\u00a0les\u00a0valeurs\u00a0saisies\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"checkedOui\"]\u00a0=\u00a0'checked=\"checked\"'\u00a0if\u00a0request.form.get(\"mari\u00e9\")\u00a0==\u00a0\"oui\"\u00a0else\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"checkedNon\"]\u00a0=\u00a0'checked=\"checked\"'\u00a0if\u00a0request.form.get(\"mari\u00e9\")\u00a0==\u00a0\"non\"\u00a0else\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"enfants\"]\u00a0=\u00a0request.form.get(\"enfants\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"salaire\"]\u00a0=\u00a0request.form.get(\"salaire\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0elif\u00a0\u00e9tat\u00a0==\u00a0301:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0erreur\u00a0rencontr\u00e9e\u00a0-\u00a0formulaire\u00a0r\u00e9tabli\u00a0avec\u00a0les\u00a0valeurs\u00a0saisies\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"checkedOui\"]\u00a0=\u00a0'checked=\"checked\"'\u00a0if\u00a0request.form.get(\"mari\u00e9\")\u00a0==\u00a0\"oui\"\u00a0else\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"checkedNon\"]\u00a0=\u00a0'checked=\"checked\"'\u00a0if\u00a0request.form.get(\"mari\u00e9\")\u00a0==\u00a0\"non\"\u00a0else\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"enfants\"]\u00a0=\u00a0request.form.get(\"enfants\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"salaire\"]\u00a0=\u00a0request.form.get(\"salaire\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0erreur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"success\"]\u00a0=\u00a0False\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"error\"]\u00a0=\u00a0True\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"erreurs\"]\u00a0=\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for\u00a0erreur\u00a0in\u00a0r\u00e9sultat['r\u00e9ponse']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le['erreurs']\u00a0+=\u00a0f\"&lt;li&gt;{erreur}&lt;/li&gt;\"\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0options\u00a0du\u00a0menu\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"optionsMenu\"]\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\"text\":\u00a0'Liste\u00a0des\u00a0simulations',\u00a0\"url\":\u00a0'/lister-simulations'},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\"text\":\u00a0'Fin\u00a0de\u00a0session',\u00a0\"url\":\u00a0'/fin-session'}]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0mod\u00e8le\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 12\u00a0: la vue \u00e0 afficher d\u00e9pend du code d\u2019\u00e9tat rendu par le contr\u00f4leur\u00a0;</li> <li>lignes 14-21\u00a0: affichage d\u2019un formulaire vide\u00a0;</li> <li>lignes 22-35\u00a0: cas du calcul d\u2019imp\u00f4t r\u00e9ussi. On r\u00e9affiche les valeurs saisies ainsi que le montant de l\u2019imp\u00f4t\u00a0;</li> <li>lignes 36-47\u00a0: cas de l\u2019\u00e9chec du calcul d\u2019imp\u00f4t\u00a0;</li> <li>lignes 49-52\u00a0: calcul des deux options du menu\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#3266-tests-postman","title":"32.6.6. Tests [Postman]","text":"<p>On initialise une session HTML avec la requ\u00eate [init-session-html-700] puis on s\u2019authentifie avec la requ\u00eate [authentifier-utilisateur-200]. Puis nous utilisons la requ\u00eate [calculer-impot-300] suivante\u00a0:</p> <p>La r\u00e9ponse du serveur est la suivante\u00a0:</p> <p></p> <p></p> <p>Maintenant essayons la requ\u00eate [calculer-impot-301] suivante\u00a0:</p> <p>La r\u00e9ponse du serveur est la suivante\u00a0:</p> <p></p> <p>Maintenant essayons un cas inattendu, celui o\u00f9 il manque des param\u00e8tres au POST. Ce cas n\u2019est pas possible dans le fonctionneent normal de l\u2019application. Mais n\u2019importe qui peut \u2018bricoler\u2019 une requ\u00eate HTTP comme nous le faisons maintenant\u00a0:</p> <p></p> <p></p> <ul> <li> <p>en [6], nous avons d\u00e9coch\u00e9 le param\u00e8tre post\u00e9 [mari\u00e9]\u00a0; La r\u00e9ponse du serveur est la suivante\u00a0:</p> </li> <li> <p>en [3], le message d\u2019erreur du serveur\u00a0;</p> </li> </ul> <p></p> <p>Dans cette application, nous avions le choix. Nous pouvions donner \u00e0 ce cas d\u2019erreur un code d\u2019\u00e9tat qui envoie la page des erreurs inattendues. Nous avons dans cette application choisi pour chaque contr\u00f4leur deux codes d\u2019\u00e9tat\u00a0:</p> <ul> <li>[xx0]\u00a0: pour une r\u00e9ussite\u00a0;</li> <li> <p>[xx1]\u00a0: pour un \u00e9chec\u00a0; Pour les cas d\u2019\u00e9chec on peut diversifier les codes d\u2019\u00e9tat pour avoir une gestion plus fine des erreurs. Nous aurions pu avoir par exemple\u00a0:</p> </li> <li> <p>[xx1]\u00a0: pour des erreurs \u00e0 afficher sur la page qui a provoqu\u00e9 l\u2019erreur\u00a0;</p> </li> <li>[xx2]\u00a0: pour des erreurs inattendues dans le cadre d\u2019une utilisation normale de l\u2019application\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#327-la-vue-de-la-liste-des-simulations","title":"32.7. La vue de la liste des simulations","text":""},{"location":"le-mode-html-de-la-version-12.html#3271-presentation-de-la-vue","title":"32.7.1. Pr\u00e9sentation de la vue","text":"<p>La vue qui pr\u00e9sente la liste des simulations est la suivante\u00a0:</p> <p></p> <p>La vue g\u00e9n\u00e9r\u00e9e par le code [vue-liste-simulations.html] a trois parties\u00a0:</p> <ul> <li>1\u00a0: le bandeau sup\u00e9rieur est g\u00e9n\u00e9r\u00e9 par le fragment [v-bandeau.html] d\u00e9j\u00e0 pr\u00e9sent\u00e9\u00a0;</li> <li>3\u00a0: le tableau des simulations g\u00e9n\u00e9r\u00e9 par le fragment [v-liste-simulations.html]\u00a0;</li> <li>2\u00a0: un menu pr\u00e9sentant deux liens, g\u00e9n\u00e9r\u00e9 par le fragment [v-menu.html]\u00a0d\u00e9j\u00e0 pr\u00e9sent\u00e9\u00a0; La vue des simulations est g\u00e9n\u00e9r\u00e9e par le code [vue-liste-simulations.html] suivant\u00a0:</li> </ul> <pre><code>&lt;!--\u00a0document\u00a0HTML\u00a0--&gt;\n&lt;!doctype\u00a0html&gt;\n&lt;html\u00a0lang=\"fr\"&gt;\n&lt;head&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0Required\u00a0meta\u00a0tags\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;meta\u00a0charset=\"utf-8\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;meta\u00a0name=\"viewport\"\u00a0content=\"width=device-width,\u00a0initial-scale=1,\u00a0shrink-to-fit=no\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0Bootstrap\u00a0CSS\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;link\u00a0rel=\"stylesheet\"\u00a0href=\"https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;title&gt;Application\u00a0imp\u00f4ts&lt;/title&gt;\n&lt;/head&gt;\n\n&lt;body&gt;\n&lt;div\u00a0class=\"container\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0bandeau\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0include\u00a0\"fragments/v-bandeau.html\"\u00a0%}\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0ligne\u00a0\u00e0\u00a0deux\u00a0colonnes\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"row\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0menu\u00a0sur\u00a0trois\u00a0colonnes--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-3\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{%\u00a0include\u00a0\"fragments/v-menu.html\"\u00a0%}\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0liste\u00a0des\u00a0simulations\u00a0sur\u00a09\u00a0colonnes--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-9\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{%\u00a0include\u00a0\"fragments/v-liste-simulations.html\"\u00a0%}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n&lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 16\u00a0: inclusion du bandeau de l\u2019application [1]\u00a0;</li> <li>ligne 21\u00a0: inclusion du menu [2]. Il sera affich\u00e9 sur trois colonnes sous le bandeau\u00a0;</li> <li> <p>ligne 26\u00a0: inclusion du tableau des simulations [3]. Il sera affich\u00e9 sur neuf colonnes sous le bandeau et \u00e0 droite du menu\u00a0; Nous avons d\u00e9j\u00e0 comment\u00e9 deux des trois fragments de cette vue\u00a0:</p> </li> <li> <p>[v-bandeau.html]\u00a0: au paragraphe lien ;</p> </li> <li>[v-menu.html]\u00a0: au paragraphe lien ; Le fragment [v-liste-simulations.html] est le suivant\u00a0:</li> </ul> <pre><code>{%\u00a0if\u00a0mod\u00e8le.simulations\u00a0is\u00a0undefined\u00a0or\u00a0mod\u00e8le.simulations|length==0\u00a0%}\n&lt;!--\u00a0message\u00a0sur\u00a0fond\u00a0bleu\u00a0--&gt;\n&lt;div\u00a0class=\"alert\u00a0alert-primary\"\u00a0role=\"alert\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;h4&gt;Votre\u00a0liste\u00a0de\u00a0simulations\u00a0est\u00a0vide&lt;/h4&gt;\n&lt;/div&gt;\n{%\u00a0endif\u00a0%}\n\n{%\u00a0if\u00a0mod\u00e8le.simulations\u00a0is\u00a0defined\u00a0and\u00a0mod\u00e8le.simulations|length!=0\u00a0%}\n&lt;!--\u00a0message\u00a0sur\u00a0fond\u00a0bleu\u00a0--&gt;\n&lt;div\u00a0class=\"alert\u00a0alert-primary\"\u00a0role=\"alert\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;h4&gt;Liste\u00a0de\u00a0vos\u00a0simulations&lt;/h4&gt;\n&lt;/div&gt;\n\n&lt;!--\u00a0tableau\u00a0des\u00a0simulations\u00a0--&gt;\n&lt;table\u00a0class=\"table\u00a0table-sm\u00a0table-hover\u00a0table-striped\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0ent\u00eates\u00a0des\u00a0six\u00a0colonnes\u00a0du\u00a0tableau\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;thead&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;tr&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;th\u00a0scope=\"col\"&gt;#&lt;/th&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;th\u00a0scope=\"col\"&gt;Mari\u00e9&lt;/th&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;th\u00a0scope=\"col\"&gt;Nombre\u00a0d'enfants&lt;/th&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;th\u00a0scope=\"col\"&gt;Salaire\u00a0annuel&lt;/th&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;th\u00a0scope=\"col\"&gt;Montant\u00a0imp\u00f4t&lt;/th&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;th\u00a0scope=\"col\"&gt;Surc\u00f4te&lt;/th&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;th\u00a0scope=\"col\"&gt;D\u00e9c\u00f4te&lt;/th&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;th\u00a0scope=\"col\"&gt;R\u00e9duction&lt;/th&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;th\u00a0scope=\"col\"&gt;Taux&lt;/th&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;th\u00a0scope=\"col\"&gt;&lt;/th&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/tr&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/thead&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0corps\u00a0du\u00a0tableau\u00a0(donn\u00e9es\u00a0affich\u00e9es)\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;tbody&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0on\u00a0affiche\u00a0chaque\u00a0simulation\u00a0en\u00a0parcourant\u00a0le\u00a0tableau\u00a0des\u00a0simulations\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0for\u00a0simulation\u00a0in\u00a0mod\u00e8le.simulations\u00a0%}\n\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0affichage\u00a0d'une\u00a0ligne\u00a0du\u00a0tableau\u00a0avec\u00a06\u00a0colonnes\u00a0-\u00a0balise\u00a0&lt;tr&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a01\u00a0:\u00a0ent\u00eate\u00a0ligne\u00a0(n\u00b0\u00a0simulation)\u00a0-\u00a0balise\u00a0&lt;th\u00a0scope='row'\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a02\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[mari\u00e9]\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a03\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[enfants]\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a04\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[salaire]\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a05\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[imp\u00f4t]\u00a0(de\u00a0l'imp\u00f4t)\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a06\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[surc\u00f4te]\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a07\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[d\u00e9c\u00f4te]\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a08\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[r\u00e9duction]\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a09\u00a0:\u00a0valeur\u00a0param\u00e8tre\u00a0[taux]\u00a0(de\u00a0l'imp\u00f4t)\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0colonne\u00a010\u00a0:\u00a0lien\u00a0de\u00a0suppression\u00a0de\u00a0la\u00a0simulation\u00a0-\u00a0balise\u00a0&lt;td&gt;\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;tr&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;th\u00a0scope=\"row\"&gt;{{simulation.id}}&lt;/th&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.mari\u00e9}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.enfants}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.salaire}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.imp\u00f4t}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.surc\u00f4te}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.d\u00e9c\u00f4te}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.r\u00e9duction}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;{{simulation.taux}}&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;td&gt;&lt;a\u00a0href=\"/supprimer-simulation/{{simulation.id}}\"&gt;Supprimer&lt;/a&gt;&lt;/td&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/tr&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0endfor\u00a0%}\n\u00a0\u00a0\u00a0\u00a0&lt;/tr&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/tbody&gt;\n&lt;/table&gt;\n{%\u00a0endif\u00a0%}\n</code></pre> <p>Commentaires</p> <ul> <li>un tableau HTML est r\u00e9alis\u00e9 avec la balise &lt;table&gt; (lignes 15 et 62)\u00a0;</li> <li>les ent\u00eates des colonnes du tableau se font \u00e0 l\u2019int\u00e9rieur d\u2019une balise &lt;thead&gt; (table head, lignes 17, 30). La balise &lt;tr&gt; (table row, lignes 18 et 29) d\u00e9limitent une ligne. Lignes 19-28, la balise &lt;th&gt; (table header) d\u00e9finit un ent\u00eate de colonne. Il y en a donc dix. [scope=\"col\"] indique que l\u2019ent\u00eate s\u2019applique \u00e0 la colonne. [scope=\"row\"] indique que l\u2019ent\u00eate s\u2019applique \u00e0 la ligne\u00a0;</li> <li>lignes 32-61\u00a0: la balise &lt;tbody&gt; encadre les donn\u00e9es affich\u00e9es par le tableau\u00a0;</li> <li>lignes 47-58\u00a0: la balise &lt;tr&gt; encadre une ligne du tableau\u00a0;</li> <li>ligne 48\u00a0: la balise &lt;th scope=\u2019row\u2019&gt; d\u00e9finit l\u2019ent\u00eate de la ligne. le navigateur fait ressortir cet ent\u00eate\u00a0;</li> <li>lignes 49-57\u00a0: chaque balise &lt;td&gt; (table data) d\u00e9finit une colonne de la ligne\u00a0;</li> <li>ligne 34\u00a0: la liste des simulations sera trouv\u00e9e dans le mod\u00e8le [mod\u00e8le.simulations] qui est une liste de dictionnaires\u00a0;</li> <li>ligne 57\u00a0: un lien pour supprimer la simulation. L\u2019URL utilise le n\u00b0 de la simulation affich\u00e9e dans la ligne\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#3272-test-visuel","title":"32.7.2. Test visuel","text":"<p>Nous cr\u00e9ons un script de test pour la vue [vue-liste-simulations.html]\u00a0:</p> <p>Le script [test_vue_liste_simulations] est le suivant\u00a0:</p> <p></p> <pre><code>from\u00a0flask\u00a0import\u00a0Flask,\u00a0make_response,\u00a0render_template\n\n#\u00a0application\u00a0Flask\napp\u00a0=\u00a0Flask(__name__,\u00a0template_folder=\"../templates\",\u00a0static_folder=\"../static\")\n\n#\u00a0Home\u00a0URL\n@app.route('/')\ndef\u00a0index():\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0encapsule\u00a0les\u00a0donn\u00e9es\u00a0de\u00a0la\u00a0pag\u00e9\u00a0dans\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le\u00a0=\u00a0{}\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0met\u00a0les\u00a0simulations\u00a0au\u00a0format\u00a0attendu\u00a0par\u00a0la\u00a0page\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"simulations\"]\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"id\":\u00a07,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"mari\u00e9\":\u00a0\"oui\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"enfants\":\u00a02,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"salaire\":\u00a060000,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"imp\u00f4t\":\u00a0448,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"d\u00e9c\u00f4te\":\u00a0100,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"r\u00e9duction\":\u00a020,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"surc\u00f4te\":\u00a00,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"taux\":\u00a00.14\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"id\":\u00a019,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"mari\u00e9\":\u00a0\"non\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"enfants\":\u00a02,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"salaire\":\u00a0200000,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"imp\u00f4t\":\u00a025600,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"d\u00e9c\u00f4te\":\u00a00,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"r\u00e9duction\":\u00a00,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"surc\u00f4te\":\u00a08400,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"taux\":\u00a00.45\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0]\n\u00a0\u00a0\u00a0\u00a0#\u00a0menu\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"optionsMenu\"]\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\"text\":\u00a0\"Calcul\u00a0de\u00a0l'imp\u00f4t\",\u00a0\"url\":\u00a0'/afficher-calcul-impot'},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\"text\":\u00a0'Fin\u00a0de\u00a0session',\u00a0\"url\":\u00a0'/fin-session'}]\n\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0de\u00a0la\u00a0page\n\u00a0\u00a0\u00a0\u00a0return\u00a0make_response(render_template(\"views/vue-liste-simulations.html\",\u00a0mod\u00e8le=mod\u00e8le))\n\n#\u00a0main\nif\u00a0__name__\u00a0==\u00a0'__main__':\n\u00a0\u00a0\u00a0\u00a0app.config.update(ENV=\"development\",\u00a0DEBUG=True)\n\u00a0\u00a0\u00a0\u00a0app.run()\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 12-35\u00a0: on met deux simulations dans le mod\u00e8le</li> <li>lignes 37-39\u00a0: le tableau des options de menu\u00a0; Affichons cette vue\u00a0en ex\u00e9cutant ce script. On obtient le r\u00e9sultat suivant\u00a0:</li> </ul> <p></p> <p>On travaille sur cette vue jusqu\u2019\u00e0 ce que le r\u00e9sultat obtenu visuellement nous convienne. On peut ensuite passer \u00e0 l\u2019int\u00e9gration de la vue dans l\u2019application web en cours d\u2019\u00e9criture.</p>"},{"location":"le-mode-html-de-la-version-12.html#3273-calcul-du-modele-de-la-vue","title":"32.7.3. Calcul du mod\u00e8le de la vue","text":"<p>Une fois l\u2019aspect visuel de la vue d\u00e9termin\u00e9, on peut proc\u00e9der au calcul du mod\u00e8le de la vue en conditions r\u00e9elles. Rappelons les codes d\u2019\u00e9tat qui m\u00e8nent \u00e0 cette vue. On les trouve dans le fichier de configuration\u00a0:</p> <p></p> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0de\u00a0la\u00a0liste\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/lister-simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0500,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/supprimer-simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0600\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-liste-simulations.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForListeSimulationsView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n</code></pre> <p>Ce sont donc les codes d\u2019\u00e9tat [500, 600] qui font afficher la vue des simulations. Pour retrouver la signification de ces codes, on peut s\u2019aider des tests [Postman] r\u00e9alis\u00e9s sur l\u2019application jSON\u00a0:</p> <ul> <li>[lister-simulations-500]\u00a0: 500 est le code d\u2019\u00e9tat \u00e0 l\u2019issue d\u2019une action [lister-simulations] r\u00e9ussie\u00a0: on pr\u00e9sente alors la liste des simulations r\u00e9alis\u00e9es par l\u2019utilisateur\u00a0;</li> <li>[supprimer-simulation-600]\u00a0: 600 est le code d\u2019\u00e9tat \u00e0 l\u2019issue d\u2019une action [supprimer-simulation] r\u00e9ussie. On pr\u00e9sente alors la nouvelle liste des simulations obtenue apr\u00e8s cette suppression\u00a0; Maintenant que nous savons \u00e0 quels moments doit \u00eatre affich\u00e9e la liste des simulations, on peut calculer son mod\u00e8le dans la classe [ModelForListeSimulationsView]\u00a0:</li> </ul> <pre><code>from\u00a0flask\u00a0import\u00a0Request\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceModelForView\u00a0import\u00a0InterfaceModelForView\n\nclass\u00a0ModelForListeSimulationsView(InterfaceModelForView):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0get_model_for_view(self,\u00a0request:\u00a0Request,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0encapsule\u00a0les\u00a0donn\u00e9es\u00a0de\u00a0la\u00a0pag\u00e9\u00a0dans\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le\u00a0=\u00a0{}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0simulations\u00a0sont\u00a0trouv\u00e9es\u00a0dans\u00a0la\u00a0r\u00e9ponse\u00a0du\u00a0contr\u00f4leur\u00a0qui\u00a0a\u00a0ex\u00e9cut\u00e9\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0sous\u00a0la\u00a0forme\u00a0d'un\u00a0tableau\u00a0de\u00a0dictionnaires\u00a0TaxPayer\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"simulations\"]\u00a0=\u00a0r\u00e9sultat[\"r\u00e9ponse\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0menu\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"optionsMenu\"]\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\"text\":\u00a0\"Calcul\u00a0de\u00a0l'imp\u00f4t\",\u00a0\"url\":\u00a0'/afficher-calcul-impot'},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\"text\":\u00a0'Fin\u00a0de\u00a0session',\u00a0\"url\":\u00a0'/fin-session'}]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0mod\u00e8le\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 13\u00a0: les simulations \u00e0 afficher sont trouv\u00e9es dans [r\u00e9sultat[\"r\u00e9ponse\"]]\u00a0;</li> <li>lignes 15-17\u00a0: les options du menu \u00e0 afficher\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#3274-tests-postman","title":"32.7.4. Tests [Postman]","text":"<p>On</p> <ul> <li>initialise une session HTML\u00a0;</li> <li>s\u2019authentifie\u00a0;</li> <li>fait trois calculs d\u2019imp\u00f4t\u00a0; Le test [lister-simulations-500] nous permet d\u2019avoir le code d\u2019\u00e9tat 500. Il correspond \u00e0 une demande pour voir les simulations\u00a0:</li> </ul> <p></p> <p>La r\u00e9ponse du serveur est la suivante\u00a0:</p> <p></p> <p>Le test [supprimer-simulation-600] nous permet d\u2019avoir le code d\u2019\u00e9tat 600. On va ici supprimer la simulation n\u00b0 2.</p> <p>Le r\u00e9sultat renvoy\u00e9 est une liste de simulations avec une simulation en moins\u00a0:</p> <p></p> <p></p>"},{"location":"le-mode-html-de-la-version-12.html#328-la-vue-des-erreurs-inattendues","title":"32.8. La vue des erreurs inattendues","text":"<p>On appelle ici, erreur inattendue, une erreur qui n\u2019aurait pas d\u00fb se produire dans le cadre d\u2019une utilisation normale de l\u2019application web. Par exemple, le fait de demander un calcul d\u2019imp\u00f4t sans \u00eatre authentifi\u00e9. Rien n\u2019emp\u00eache un utilisateur de taper directement l\u2019URL [/calcul-impot] dans son navigateur. Par ailleurs, comme nous l\u2019avons vu, il peut faire un POST sur l\u2019URL [/calcul-impot] en n\u2019envoyant pas les param\u00e8tres attendus. On a vu que notre application web savait r\u00e9pondre correctement \u00e0 cette requ\u00eate. On appellera, erreur inattendue, une erreur qui ne devrait pas se produire dans le cadre de l\u2019application HTML. Si elle se produit, c\u2019est que probablement quelqu\u2019un essaie de \u2018hacker\u2019 l\u2019application. Par souci de p\u00e9dagogie, on a d\u00e9cid\u00e9 d\u2019afficher une vue d\u2019erreurs pour ces cas. Dans la r\u00e9alit\u00e9, on pourrait r\u00e9afficher la derni\u00e8re page envoy\u00e9e au client. Il suffit pour cela d\u2019enregistrer en session, la derni\u00e8re r\u00e9ponse HTML envoy\u00e9e. En cas d\u2019erreur inattendue, on renvoie cette r\u00e9ponse. Ainsi l\u2019utilisateur aura l\u2019impression que le serveur ne r\u00e9pond pas \u00e0 ses erreurs puisque la page affich\u00e9e ne change pas.</p>"},{"location":"le-mode-html-de-la-version-12.html#3281-presentation-de-la-vue","title":"32.8.1. Pr\u00e9sentation de la vue","text":"<p>La vue qui pr\u00e9sente les erreurs inattendues est la suivante\u00a0:</p> <p></p> <p>La vue g\u00e9n\u00e9r\u00e9e par le code [vue-erreurs.html] a trois parties\u00a0:</p> <ul> <li>1\u00a0: le bandeau sup\u00e9rieur est g\u00e9n\u00e9r\u00e9 par le fragment [v-bandeau.html] d\u00e9j\u00e0 pr\u00e9sent\u00e9\u00a0;</li> <li>2\u00a0: la ou les erreurs inattendues\u00a0;</li> <li>3\u00a0: un menu pr\u00e9sentant trois liens, g\u00e9n\u00e9r\u00e9 par le fragment [v-menu.html] d\u00e9j\u00e0 pr\u00e9sent\u00e9\u00a0; La vue des erreurs inattendues est g\u00e9n\u00e9r\u00e9e par le script [vue-erreurs.html] suivant\u00a0:</li> </ul> <pre><code>&lt;!--\u00a0document\u00a0HTML\u00a0--&gt;\n&lt;!doctype\u00a0html&gt;\n&lt;html\u00a0lang=\"fr\"&gt;\n&lt;head&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0Required\u00a0meta\u00a0tags\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;meta\u00a0charset=\"utf-8\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;meta\u00a0name=\"viewport\"\u00a0content=\"width=device-width,\u00a0initial-scale=1,\u00a0shrink-to-fit=no\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0Bootstrap\u00a0CSS\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;link\u00a0rel=\"stylesheet\"\u00a0href=\"https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;title&gt;Application\u00a0imp\u00f4ts&lt;/title&gt;\n&lt;/head&gt;\n\n&lt;body&gt;\n&lt;div\u00a0class=\"container\"&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0bandeau\u00a0sur\u00a012\u00a0colonnes\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0{%\u00a0include\u00a0\"fragments/v-bandeau.html\"\u00a0%}\n\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0ligne\u00a0\u00e0\u00a0deux\u00a0sections\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"row\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0menu\u00a0sur\u00a03\u00a0colonnes--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-3\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{%\u00a0include\u00a0\"fragments/v-menu.html\"\u00a0%}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;!--\u00a0liste\u00a0des\u00a0erreurs\u00a0sur\u00a09\u00a0colonnes\u00a0--&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"col-md-9\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;div\u00a0class=\"alert\u00a0alert-danger\"\u00a0role=\"alert\"&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Les\u00a0erreurs\u00a0inattendues\u00a0suivantes\u00a0se\u00a0sont\u00a0produites\u00a0:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;ul&gt;{{mod\u00e8le.erreurs|safe}}&lt;/ul&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n\u00a0\u00a0\u00a0\u00a0&lt;/div&gt;\n&lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 16\u00a0: inclusion du bandeau de l\u2019application [1]\u00a0;</li> <li>ligne 21\u00a0: inclusion du menu [3]. Il sera affich\u00e9 sur trois colonnes sous le bandeau\u00a0;</li> <li>lignes 24-29\u00a0: affichage de la zone d\u2019erreurs sur neuf colonnes\u00a0;</li> <li>ligne 25\u00a0: cet affichage se fera dans un cadre Bootstrap \u00e0 fond rose\u00a0;</li> <li>ligne 26\u00a0: un texte de pr\u00e9sentation\u00a0;</li> <li> <p>ligne 27\u00a0: la balise &lt;ul&gt; encadre une liste \u00e0 puces. Cette liste \u00e0 puces est fournie par le mod\u00e8le [mod\u00e8le.erreurs]\u00a0; Nous avons d\u00e9j\u00e0 comment\u00e9 les deux fragments de cette vue\u00a0:</p> </li> <li> <p>[v-bandeau.html]\u00a0: au paragraphe lien ;</p> </li> <li>[v-menu.html]\u00a0: au paragraphe lien ;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#3282-test-visuel","title":"32.8.2. Test visuel","text":"<p>Nous cr\u00e9ons un script de test pour la vue [vue-erreurs.html]\u00a0:</p> <p></p> <pre><code>from\u00a0flask\u00a0import\u00a0Flask,\u00a0render_template,\u00a0make_response\n\n#\u00a0application\u00a0Flask\napp\u00a0=\u00a0Flask(__name__,\u00a0template_folder=\"../templates\",\u00a0static_folder=\"../static\")\n\n#\u00a0Home\u00a0URL\n@app.route('/')\ndef\u00a0index():\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0encapsule\u00a0les\u00a0donn\u00e9es\u00a0de\u00a0la\u00a0pag\u00e9\u00a0dans\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le\u00a0=\u00a0{}\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0construit\u00a0une\u00a0liste\u00a0HTML\u00a0des\u00a0erreurs\n\u00a0\u00a0\u00a0\u00a0content\u00a0=\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0for\u00a0erreur\u00a0in\u00a0[\"erreur1\",\u00a0\"erreur2\"]:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0content\u00a0+=\u00a0f\"&lt;li&gt;{erreur}&lt;/li&gt;\"\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"erreurs\"]\u00a0=\u00a0content\n\u00a0\u00a0\u00a0\u00a0#\u00a0options\u00a0du\u00a0menu\n\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"optionsMenu\"]\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\"text\":\u00a0\"Calcul\u00a0de\u00a0l'imp\u00f4t\",\u00a0\"url\":\u00a0'/calculer-impot'},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\"text\":\u00a0'Liste\u00a0des\u00a0simulations',\u00a0\"url\":\u00a0'/lister-simulations'},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\"text\":\u00a0'Fin\u00a0de\u00a0session',\u00a0\"url\":\u00a0'/fin-session'}]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0de\u00a0la\u00a0page\n\u00a0\u00a0\u00a0\u00a0return\u00a0make_response(render_template(\"views/vue-erreurs.html\",\u00a0mod\u00e8le=mod\u00e8le))\n\n#\u00a0main\nif\u00a0__name__\u00a0==\u00a0'__main__':\n\u00a0\u00a0\u00a0\u00a0app.config.update(ENV=\"development\",\u00a0DEBUG=True)\n\u00a0\u00a0\u00a0\u00a0app.run()\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 11-15\u00a0: construction de la liste HTML des erreurs\u00a0;</li> <li>lignes 17-20\u00a0: le tableau des options de menu\u00a0; Ex\u00e9cutons ce script. On obtient le r\u00e9sultat suivant\u00a0:</li> </ul> <p>On travaille sur cette vue jusqu\u2019\u00e0 ce que le r\u00e9sultat obtenu visuellement nous convienne. On peut ensuite passer \u00e0 l\u2019int\u00e9gration de la vue dans l\u2019application web en cours d\u2019\u00e9criture.</p> <p></p>"},{"location":"le-mode-html-de-la-version-12.html#3283-calcul-du-modele-de-la-vue","title":"32.8.3. Calcul du mod\u00e8le de la vue","text":"<p>Une fois l\u2019aspect visuel de la vue d\u00e9termin\u00e9, on peut proc\u00e9der au calcul du mod\u00e8le de la vue en conditions r\u00e9elles. Rappelons les codes d\u2019\u00e9tat qui m\u00e8nent \u00e0 cette vue. On les trouve dans le fichier de configuration\u00a0:</p> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0vues\u00a0HTML\u00a0et\u00a0leurs\u00a0mod\u00e8les\u00a0d\u00e9pendent\u00a0de\u00a0l'\u00e9tat\u00a0rendu\u00a0par\u00a0le\u00a0contr\u00f4leur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"views\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0d'authentification\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/init-session\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0700,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/fin-session\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0400,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/authentifier-utilisateur\u00a0\u00e9chec\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0201\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-authentification.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForAuthentificationView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/authentifier-utilisateur\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0200,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/calculer-impot\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0300,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/calculer-impot\u00a0\u00e9chec\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0301,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/afficher-calcul-impot\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0800\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-calcul-impot.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForCalculImpotView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0de\u00a0la\u00a0liste\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/lister-simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0500,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/supprimer-simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0600\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-liste-simulations.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForListeSimulationsView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0des\u00a0erreurs\u00a0inattendues\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view-erreurs\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-erreurs.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForErreursView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n</code></pre> <p>Ce sont les codes d\u2019\u00e9tat qui ne m\u00e8nent pas \u00e0 une vue HTML des lignes 3-41 qui font afficher la vue des erreurs inattendues.</p> <p>Le calcul du mod\u00e8le de la vue [vue-erreurs.html] est fait par la classe [ModelForErreursView] suivante\u00a0:</p> <pre><code>from\u00a0flask\u00a0import\u00a0Request\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceModelForView\u00a0import\u00a0InterfaceModelForView\n\nclass\u00a0ModelForErreursView(InterfaceModelForView):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0get_model_for_view(self,\u00a0request:\u00a0Request,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le\u00a0=\u00a0{}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0erreurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"erreurs\"]\u00a0=\u00a0\"\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for\u00a0erreur\u00a0in\u00a0r\u00e9sultat['r\u00e9ponse']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le['erreurs']\u00a0+=\u00a0f\"&lt;li&gt;{erreur}&lt;/li&gt;\"\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0menu\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0mod\u00e8le[\"optionsMenu\"]\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\"text\":\u00a0\"Calcul\u00a0de\u00a0l'imp\u00f4t\",\u00a0\"url\":\u00a0'/afficher-calcul-impot'},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\"text\":\u00a0'Liste\u00a0des\u00a0simulations',\u00a0\"url\":\u00a0'/lister-simulations'},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\"text\":\u00a0'Fin\u00a0de\u00a0session',\u00a0\"url\":\u00a0'/fin-session'}]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0mod\u00e8le\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0mod\u00e8le\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 11-14\u00a0: calcul du mod\u00e8le [mod\u00e8le.erreurs] utilis\u00e9 par la vue [vue-erreurs.html]\u00a0;</li> <li>lignes 16-197\u00a0: calcul du mod\u00e8le [mod\u00e8le.optionsMenu] utilis\u00e9 par le fragment [v-menu.html]\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#3284-tests-postman","title":"32.8.4. Tests [Postman]","text":"<p>On\u00a0fait :</p> <ul> <li>l\u2019action [/init-session/html]\u00a0;</li> <li>puis l\u2019action [/init-session/x]\u00a0; La r\u00e9ponse HTML est alors la suivante\u00a0:</li> </ul> <p></p>"},{"location":"le-mode-html-de-la-version-12.html#329-implementation-des-actions-du-menu-de-lapplication","title":"32.9. Impl\u00e9mentation des actions du menu de l\u2019application","text":"<p>Nous allons ici traiter de l\u2019impl\u00e9mentation des actions du menu. Rappelons la signification des liens que nous avons rencontr\u00e9s</p> <p>Vue</p><p>Lien</p><p>Cible</p><p>R\u00f4le</p><p>Calcul de l\u2019imp\u00f4t</p><p>[Liste des simulations]</p><p>[/lister-simulations]</p><p>Demander la liste des simulations</p><p>[Fin de session]</p><p>[/fin-session]</p><p>Demander la fin de la session</p><p>Liste des simulations</p><p>[Calcul de l\u2019imp\u00f4t]</p><p>[/afficher-calcul-impot]</p><p>Afficher la vue du calcul d\u2019imp\u00f4t</p><p>[Fin de session]</p><p>[/fin-session]</p><p>Demander la fin de la session</p><p>Erreurs inattendues</p><p>[Calcul de l\u2019imp\u00f4t]</p><p>[/afficher-calcul-impot]</p><p>Afficher la vue du calcul d\u2019imp\u00f4t</p><p>[Liste des simulations]</p><p>[/lister-simulations]</p><p>Demander la liste des simulations</p><p>[Fin de session]</p><p>[/fin-session]</p><p>Demander la fin de la session</p> <p>Il faut rappeler qu\u2019un clic sur un lien provoque un GET vers la cible du lien. Les actions [/lister-simulations, /fin-session] ont \u00e9t\u00e9 impl\u00e9ment\u00e9es avec une op\u00e9ration GET, ce qui nous permet de les mettre comme cibles de liens. Lorsque l\u2019action se fait par un POST, l\u2019utilisation d\u2019un lien n\u2019est plus possible sauf \u00e0 l\u2019associer avec du Javascript.</p>"},{"location":"le-mode-html-de-la-version-12.html#3291-laction-afficher-calcul-impot","title":"32.9.1. L\u2019action [/afficher-calcul-impot]","text":"<p>Des actions ci-dessus, il appara\u00eet que l\u2019action [/afficher-calcul-impot] n\u2019a pas encore \u00e9t\u00e9 impl\u00e9ment\u00e9e. C\u2019est une op\u00e9ration de navigation entre deux vues\u00a0: le serveur jSON ou XML n\u2019a aucune raison de l\u2019impl\u00e9menter car ils n\u2019ont pas la notion de vue. C\u2019est le serveur HTML qui introduit cette notion.</p> <p>Il nous faut donc impl\u00e9menter l\u2019action [/afficher-calcul-impot]. Cela va nous permettre de r\u00e9viser le mode op\u00e9ratoire de l\u2019impl\u00e9mentation d\u2019une action au sein du serveur.</p> <p>Tout d\u2019abord, il nous faut ajouter un nouveau contr\u00f4leur secondaire. Nous l\u2019appellerons [AfficherCalculImpotController]\u00a0:</p> <p></p> <p>Ce contr\u00f4leur doit \u00eatre ajout\u00e9 dans le fichier de configuration [config]\u00a0:</p> <pre><code>\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0contr\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0from\u00a0AfficherCalculImpotController\u00a0import\u00a0AfficherCalculImpotController\n\u00a0\u00a0\u00a0\u00a0from\u00a0AuthentifierUtilisateurController\u00a0import\u00a0AuthentifierUtilisateurController\n\u00a0\u00a0\u00a0\u00a0from\u00a0CalculerImpotController\u00a0import\u00a0CalculerImpotController\n\u00a0\u00a0\u00a0\u00a0from\u00a0CalculerImpotsController\u00a0import\u00a0CalculerImpotsController\n\u00a0\u00a0\u00a0\u00a0from\u00a0FinSessionController\u00a0import\u00a0FinSessionController\n\u00a0\u00a0\u00a0\u00a0from\u00a0GetAdminDataController\u00a0import\u00a0GetAdminDataController\n\u00a0\u00a0\u00a0\u00a0\u2026\n\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0actions\u00a0autoris\u00e9es\u00a0et\u00a0leurs\u00a0contr\u00f4leurs\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"controllers\":\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0initialisation\u00a0d'une\u00a0session\u00a0de\u00a0calcul\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"init-session\":\u00a0InitSessionController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0authentification\u00a0d'un\u00a0utilisateur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"authentifier-utilisateur\":\u00a0AuthentifierUtilisateurController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0en\u00a0mode\u00a0individuel\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"calculer-impot\":\u00a0CalculerImpotController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\u00a0en\u00a0mode\u00a0lots\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"calculer-impots\":\u00a0CalculerImpotsController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0liste\u00a0des\u00a0simulations\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"lister-simulations\":\u00a0ListerSimulationsController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0suppression\u00a0d'une\u00a0simulation\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"supprimer-simulation\":\u00a0SupprimerSimulationController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0fin\u00a0de\u00a0la\u00a0session\u00a0de\u00a0calcul\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"fin-session\":\u00a0FinSessionController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0affichage\u00a0de\u00a0la\u00a0vue\u00a0de\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"afficher-calcul-impot\":\u00a0AfficherCalculImpotController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0obtention\u00a0des\u00a0donn\u00e9es\u00a0de\u00a0l'administration\u00a0fiscale\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"get-admindata\":\u00a0GetAdminDataController(),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0main\u00a0controller\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"main-controller\":\u00a0MainController()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u2026\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0vues\u00a0HTML\u00a0et\u00a0leurs\u00a0mod\u00e8les\u00a0d\u00e9pendent\u00a0de\u00a0l'\u00e9tat\u00a0rendu\u00a0par\u00a0le\u00a0contr\u00f4leur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"views\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0d'authentification\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u2026\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0vue\u00a0du\u00a0calcul\u00a0de\u00a0l'imp\u00f4t\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/authentifier-utilisateur\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0200,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/calculer-impot\u00a0r\u00e9ussite\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0300,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/calculer-impot\u00a0\u00e9chec\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0301,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0/afficher-calcul-impot\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0800\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"view_name\":\u00a0\"views/vue-calcul-impot.html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"model_for_view\":\u00a0ModelForCalculImpotView()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0},\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\u2026\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n</code></pre> <ul> <li>ligne 2\u00a0: le nouveau contr\u00f4leur\u00a0;</li> <li>ligne 28\u00a0: la nouvelle action et son contr\u00f4leur\u00a0;</li> <li>ligne 51\u00a0: le nouveau contr\u00f4leur rendra le code d\u2019\u00e9tat 800. Sur un changement de vues, il ne peut y avoir d\u2019erreur. La vue affich\u00e9e est la vue [vue-calcul-impot.html] que nous avons \u00e9tudi\u00e9e, expliqu\u00e9e et test\u00e9e\u00a0; Le contr\u00f4leur [AfficherCalculImpotController] sera le suivant\u00a0:</li> </ul> <pre><code>from\u00a0flask_api\u00a0import\u00a0status\nfrom\u00a0werkzeug.local\u00a0import\u00a0LocalProxy\n\nfrom\u00a0InterfaceController\u00a0import\u00a0InterfaceController\n\nclass\u00a0AfficherCalculImpotController(InterfaceController):\n\n\u00a0\u00a0\u00a0\u00a0def\u00a0execute(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict)\u00a0-&gt;\u00a0(dict,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0r\u00e9cup\u00e8re\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0path\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dummy,\u00a0action\u00a0=\u00a0request.path.split('/')\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0changement\u00a0de\u00a0vue\u00a0-\u00a0juste\u00a0un\u00a0code\u00a0d'\u00e9tat\u00a0\u00e0\u00a0positionner\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0{\"action\":\u00a0action,\u00a0\"\u00e9tat\":\u00a0800,\u00a0\"r\u00e9ponse\":\u00a0\"\"},\u00a0status.HTTP_200_OK\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 6\u00a0: comme les autres contr\u00f4leurs secondaires, le nouveau contr\u00f4leur impl\u00e9mente l\u2019interface [InterfaceController]\u00a0;</li> <li>ligne 13\u00a0: les changements de vue sont simples \u00e0 impl\u00e9menter\u00a0: il suffit de rendre un code d\u2019\u00e9tat associ\u00e9 \u00e0 la vue cible, ici le code 800 comme il a \u00e9t\u00e9 vu plus haut\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#3292-laction-fin-session","title":"32.9.2. L\u2019action [/fin-session]","text":"<p>L\u2019action [/fin-session] est particuli\u00e8re. Elle n\u2019am\u00e8ne pas directement \u00e0 une vue mais \u00e0 une redirection. Rappelons que les redirections sont configur\u00e9es dans la configuration [config] de la fa\u00e7on suivante\u00a0:</p> <pre><code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0redirections\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"redirections\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"\u00e9tats\":\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0400,\u00a0\u00a0#\u00a0/fin-session\u00a0r\u00e9ussi\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"to\":\u00a0\"/init-session/html\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0],\n</code></pre> <p>Il n\u2019y a qu\u2019une redirection dans l\u2019application\u00a0:</p> <ul> <li>lorsque le contr\u00f4leur rend le code d\u2019\u00e9tat [400] (ligne 5), il faut rediriger le client vers l\u2019URL [http://machine:port/chemin/init-session/html] (ligne 8)\u00a0; Le code d\u2019\u00e9tat [400] est le code rendu suite \u00e0 une action [/fin-session] r\u00e9ussie. Pourquoi faut-il alors rediriger le client l\u2019URL [/init-session/html]\u00a0? Parce que le code de l\u2019action [/fin-session] supprime le type de la session pr\u00e9sent dans la session web. On ne sait plus alors qu\u2019on est dans une session html. Il faut le redire. On le fait \u00e0 l\u2019aide de l\u2019action [/init-session/html].</li> </ul> <p>Les redirections HTML sont g\u00e9r\u00e9es par la classe [HtmlResponse]\u00a0:</p> <pre><code>\u00a0\u00a0\u00a0def\u00a0build_http_response(self,\u00a0request:\u00a0LocalProxy,\u00a0session:\u00a0LocalProxy,\u00a0config:\u00a0dict,\u00a0status_code:\u00a0int,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0r\u00e9sultat:\u00a0dict)\u00a0-&gt;\u00a0(Response,\u00a0int):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0r\u00e9ponse\u00a0HTML\u00a0d\u00e9pend\u00a0du\u00a0code\u00a0d'\u00e9tat\u00a0rendu\u00a0par\u00a0le\u00a0contr\u00f4leur\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00e9tat\u00a0=\u00a0r\u00e9sultat[\"\u00e9tat\"]\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0faut-il\u00a0faire\u00a0une\u00a0redirection\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for\u00a0redirection\u00a0in\u00a0config[\"redirections\"]:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tats\u00a0n\u00e9cessitant\u00a0une\u00a0redirection\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00e9tats\u00a0=\u00a0redirection[\"\u00e9tats\"]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0\u00e9tat\u00a0in\u00a0\u00e9tats:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0il\u00a0faut\u00a0faire\u00a0une\u00a0redirection\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(f\"{redirection['to']}\"),\u00a0status.HTTP_302_FOUND\n\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e0\u00a0un\u00a0\u00e9tat,\u00a0correspond\u00a0une\u00a0vue\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0cherche\u00a0celle-ci\u00a0dans\u00a0la\u00a0liste\u00a0des\u00a0vues\n\u00a0..\n</code></pre> <ul> <li>les lignes 6-12 traitent les redirections\u00a0;</li> <li>ligne 7\u00a0: config[\u2018redirections\u2019] est une liste de redirections. Chaque redirection est un dictionnaire avec les cl\u00e9s\u00a0:</li> <li>[\u00e9tats]\u00a0: les \u00e9tats rendus par le contr\u00f4leur qui m\u00e8nent \u00e0 une redirection\u00a0;</li> <li>[to]\u00a0: l\u2019adresse de redirection\u00a0;</li> <li>lignes 7-12\u00a0: on parcourt la liste des redirections\u00a0;</li> <li>ligne 9\u00a0: pour chaque redirection, on r\u00e9cup\u00e8re les \u00e9tats qui y m\u00e8nent\u00a0;</li> <li>ligne 10\u00a0: si l\u2019\u00e9tat test\u00e9 est dans cette liste, alors on fait la redirection, ligne 12\u00a0;</li> <li>ligne 12\u00a0: on rappelle que la m\u00e9thode [build_http_response] doit rendre un tuple \u00e0 deux \u00e9l\u00e9ments\u00a0:</li> <li>[response]\u00a0: la r\u00e9ponse HTTP \u00e0 faire. Celle-ci est construite avec la fonction [redirect] dont le param\u00e8tre est l\u2019adresse de redirection\u00a0;</li> <li> <p>[status_code]\u00a0: le code de statut de la r\u00e9ponse HTTP, ici le code [status.HTTP_302_FOUND] qui indique au client qu\u2019il doit se rediriger\u00a0; Faisons un test [Postman]. On\u00a0:</p> </li> <li> <p>initialise une session HTML [init-session/html]\u00a0;</p> </li> <li>s\u2019authentifie [/authentifier-utilisateur]\u00a0;</li> <li>termine la session [/fin-session]\u00a0;</li> </ul> <p></p> <p>La r\u00e9ponse du serveur est la suivante\u00a0:</p> <p></p> <p>On a obtenu la vue d\u2019authentification. C\u2019est bien elle qu\u2019on attendait. Maintenant, voyons comment elle a \u00e9t\u00e9 obtenue. Passons sur la console [Postman] (Ctrl-Alt-C)\u00a0:</p> <p></p> <ul> <li>en [1], l\u2019action [/fin-session]\u00a0;</li> <li>en [2-3], le code 302 de statut HTTP rendu par le serveur indique au client qu\u2019il dit se rediriger\u00a0;</li> <li>en [4], le client [Postman] suit la redirection\u00a0;</li> </ul>"},{"location":"le-mode-html-de-la-version-12.html#3210-tests-de-lapplication-html-en-conditions-reelles","title":"32.10. Tests de l\u2019application HTML en conditions r\u00e9elles","text":"<p>Le code a \u00e9t\u00e9 \u00e9crit et chaque action test\u00e9e avec [Postman]. Il nous reste \u00e0 tester l\u2019encha\u00eenement des vues en situation r\u00e9elle. Il nous faut un moyen d\u2019initialiser la session HTML. On sait qu\u2019il faut envoyer au serveur la requ\u00eate [/init-session/html]. Ce n\u2019est pas une URL tr\u00e8s pratique. On pr\u00e9f\u00e8rerait d\u00e9marrer avec l\u2019URL [/].</p> <p>Nous avons \u00e9crit dans le script principal [main]\u00a0la route suivante\u00a0:</p> <pre><code>from\u00a0flask\u00a0import\u00a0request,\u00a0Flask,\u00a0session,\u00a0url_for, redirect\n\u2026\n\u2026\n@app.route('/',\u00a0methods=['GET'])\ndef\u00a0index()\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0redirection\u00a0vers\u00a0/init-session/html\n\u00a0\u00a0\u00a0\u00a0return\u00a0redirect(url_for(\"init_session\",\u00a0type_response=\"html\"),\u00a0status.HTTP_302_FOUND)\n\u2026\n#\u00a0init-session\n@app.route('/init-session/&lt;string:type_response&gt;',\u00a0methods=['GET'])\ndef\u00a0init_session(type_response:\u00a0str)\u00a0-&gt;\u00a0tuple:\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ex\u00e9cute\u00a0le\u00a0contr\u00f4leur\u00a0associ\u00e9\u00a0\u00e0\u00a0l'action\n\u00a0\u00a0\u00a0\u00a0return\u00a0front_controller()\n</code></pre> <ul> <li>lignes 4-7\u00a0: gestion de la route [/]. Le point d\u2019entr\u00e9e de l\u2019application web sera l\u2019URL[/init-session/html] (ligne 10). Aussi ligne 7, nous redirigeons le client vers cette URL\u00a0:</li> <li>la fonction [url_for] est import\u00e9e ligne 1. Elle a ici deux param\u00e8tres\u00a0(ligne 7)\u00a0:</li> <li>le 1er param\u00e8tre est le nom d\u2019une des fonctions de routage, ici celle de la ligne 11. On voit que cette fonction attend un param\u00e8tre [type_response] qui est le type (json, xml, html) de r\u00e9ponse souhait\u00e9 par le client\u00a0;</li> <li>le 2i\u00e8me param\u00e8tre reprend le nom du param\u00e8tre de la ligne 11, [type_response], et lui donne une valeur. S\u2019il y avait d\u2019autres param\u00e8tres, on r\u00e9p\u00e9terait l\u2019op\u00e9ration pour chacun d\u2019eux\u00a0;</li> <li>elle rend l\u2019URL associ\u00e9e \u00e0 la fonction d\u00e9sign\u00e9e par les deux param\u00e8tres qui lui ont \u00e9t\u00e9 donn\u00e9s. Ici cela donnera l\u2019URL de la ligne 10 o\u00f9 le param\u00e8tre est remplac\u00e9 par sa valeur [/init-session/html]\u00a0;</li> <li>la fonction [redirect] a \u00e9t\u00e9 import\u00e9e ligne 1. Elle a pour r\u00f4le d\u2019envoyer un ent\u00eate HTTP de redirection au client\u00a0:</li> <li>le 1er param\u00e8tre est l\u2019URL vers laquelle le client doit \u00eatre redirig\u00e9\u00a0;</li> <li>le 2i\u00e8me param\u00e8tre est le code de statut de la r\u00e9ponse HTTP faite au client. Le code [status.HTTP_302_FOUND] correspond \u00e0 une redirection HTTP\u00a0; Nous sommes pr\u00eats. Nous pr\u00e9sentons maintenant quelques encha\u00eenements de vues.</li> </ul> <p>Dans notre navigateur, nous activons le suivi des requ\u00eates (F12 sur Chrome, Firefox, Edge) et nous demandons l\u2019URL de d\u00e9marrage [http://localhost:5000/]. La r\u00e9ponse du serveur est la suivante\u00a0:</p> <p></p> <p>Si on regarde les \u00e9changes r\u00e9seau qui ont eu lieu entre le client et le serveur\u00a0:</p> <p></p> <ul> <li>on voit qu\u2019en [4, 5], le navigateur a re\u00e7u une demande de redirection vers l\u2019URL [/init-session/html]\u00a0; Remplissons le formulaire que nous avons re\u00e7u\u00a0;</li> </ul> <p></p> <p>Puis faisons quelques simulations\u00a0:</p> <p></p> <p></p> <p>Demandons la liste des simulations\u00a0:</p> <p></p> <p>Supprimons la 1re simulation\u00a0:</p> <p></p> <p>Terminons la session\u00a0:</p> <p></p> <p>Le lecteur est invit\u00e9 \u00e0 faire d\u2019autres tests.</p>"},{"location":"les-bases-de-python.html","title":"3. Les bases de Python","text":""},{"location":"les-bases-de-python.html#31-script-bases_01-operations-elementaires","title":"3.1. Script [bases_01]\u00a0: op\u00e9rations \u00e9l\u00e9mentaires","text":"<p>Le script [bases_01] pr\u00e9sente les premi\u00e8res caract\u00e9ristiques de Python.</p> <pre><code># ----------------------------------\ndef affiche(chaine):\n    # affiche chaine\n    print(\"chaine=%s\" % chaine)\n\n\n# ----------------------------------\ndef affiche_type(variable):\n    # affiche le type de variable\n    print(\"type[%s]=%s\" % (variable, type(variable)))\n\n\n# ----------------------------------\ndef f1(param):\n    # ajoute 10 \u00e0 param\n    return param + 10\n\n\n# ----------------------------------\ndef f2():\n    # rend un tuple de 3 valeurs\n    return \"un\", 0, 100\n\n\n# -------------------------------- programme principal ------------------------------------\n# ceci est un commentaire\n# variable utilis\u00e9e sans avoir \u00e9t\u00e9 d\u00e9clar\u00e9e\nnom = \"dupont\"\n\n# un affichage \u00e9cran\nprint(\"nom=%s\" % nom)\n\n# une liste avec des \u00e9l\u00e9ments de type diff\u00e9rent\nliste = [\"un\", \"deux\", 3, 4]\n\n# son nombre d'\u00e9l\u00e9ments\nn = len(liste)\n\n# une boucle\nfor i in range(n):\n    print(\"liste[%d]=%s\" % (i, liste[i]))\n\n# initialisation de 2 variables avec un tuple\n(chaine1, chaine2) = (\"chaine1\", \"chaine2\")\n\n# concat\u00e9nation des 2 cha\u00eenes\nchaine3 = chaine1 + chaine2\n\n# affichage r\u00e9sultat\nprint(\"[%s,%s,%s]\" % (chaine1, chaine2, chaine3))\n\n# utilisation fonction\naffiche(chaine1)\n\n# le type d'une variable peut \u00eatre connu\naffiche_type(n)\naffiche_type(chaine1)\naffiche_type(liste)\n\n# le type d'une variable peut changer en cours d'ex\u00e9cution\nn = \"a chang\u00e9\"\naffiche_type(n)\n\n# une fonction peut rendre un r\u00e9sultat\nres1 = f1(4)\nprint(\"res1=%s\" % res1)\n\n# une fonction peut rendre une liste de valeurs\n(res1, res2, res3) = f2()\nprint(\"(res1,res2,res3)=[%s,%s,%s]\" % (res1, res2, res3))\n\n# on aurait pu r\u00e9cup\u00e9rer ces valeurs dans une variable\nliste = f2()\nfor i in range(len(liste)):\n    print(\"liste[%s]=%s\" % (i, liste[i]))\n\n# des tests\nfor i in range(len(liste)):\n    # n'affiche que les cha\u00eenes\n    if type(liste[i]) == \"str\":\n        print(\"liste[%s]=%s\" % (i, liste[i]))\n\n# d'autres tests\nfor i in range(len(liste)):\n    # n'affiche que les entiers &gt;10\n    if type(liste[i]) == \"int\" and liste[i] &gt; 10:\n        print(\"liste[%s]=%s\" % (i, liste[i]))\n\n# une boucle while\nliste = (8, 5, 0, -2, 3, 4)\ni = 0\nsomme = 0\nwhile i &lt; len(liste) and liste[i] &gt; 0:\n    print(\"liste[%s]=%s\" % (i, liste[i]))\n    somme += liste[i]  # somme=somme+liste[i]\n    i += 1  # i=i+1\nprint(\"somme=%s\" % somme)\n# fin programme\n</code></pre> <p>Commentaires </p> <ul> <li>ligne 2\u00a0: le mot cl\u00e9 def d\u00e9finit une fonction\u00a0;</li> <li>ligne 2\u00a0: la fonction re\u00e7oit le param\u00e8tre [chaine]. On n'indique pas le type du param\u00e8tre. Python utilise exclusivement le passage par valeur. Celle-ci diff\u00e8re selon la donn\u00e9e\u00a0:</li> <li>pour un type simple (nombre, bool\u00e9en\u2026), cette valeur est la valeur encapsul\u00e9e par la donn\u00e9e (4, True\u2026)\u00a0;</li> <li>pour un type complexe (liste, classe\u2026), cette valeur est l'adresse de la donn\u00e9e\u00a0;</li> <li>lignes 3-4\u00a0: le contenu de la fonction. Il est d\u00e9cal\u00e9 \u00e0 droite d'une tabulation. C'est cette indentation associ\u00e9e au caract\u00e8re\u00a0: de l'instruction def qui d\u00e9finit le contenu de la fonction. Cela est vrai pour toutes les instructions ayant du contenu\u00a0: if, else, while, for, try, except\u00a0;</li> <li>ligne 4\u00a0: la syntaxe utilis\u00e9e ici est [print('text1%F1text2%F2\u2026' % data1, data2)]\u00a0:</li> <li>les [%Fi] (ici %s) sont des formats d'affichage\u00a0:</li> <li>%s (string)\u00a0: pour une cha\u00eene de caract\u00e8res\u00a0;</li> <li>%d (decimal)\u00a0: pour les nombres entiers d\u00e9cimaux sign\u00e9s\u00a0;</li> <li>%f (float)\u00a0: format d\u00e9cimal pour les nombres r\u00e9els\u00a0;</li> <li>%e (exponentiel)\u00a0: format exponentiel pour un nombre r\u00e9el\u00a0;</li> <li>\u2026</li> <li>[data1, data2\u2026] sont les expressions dont on veut afficher la valeur\u00a0:</li> <li>[data1] sera affich\u00e9e avec le format F1\u00a0;</li> <li>[data2] sera affich\u00e9e avec le format F2\u00a0;</li> <li>\u2026</li> <li>ligne 10\u00a0: Python g\u00e8re en interne le type des variables. On peut conna\u00eetre le type d'une variable avec la fonction type(variable) qui rend une variable de type 'type'. L'expression '%s' % (type(variable)) est une cha\u00eene de caract\u00e8res repr\u00e9sentant le type de la variable\u00a0;</li> <li>ligne 25\u00a0: le programme principal. Celui-ci vient habituellement (mais pas n\u00e9cessairement) apr\u00e8s la d\u00e9finition de toutes les fonctions du script. Son contenu est non indent\u00e9\u00a0;</li> <li>ligne 28\u00a0: en Python, on ne d\u00e9clare pas les variables. Python est sensible \u00e0 la casse. La variable Nom est diff\u00e9rente de la variable nom. Une cha\u00eene de caract\u00e8res peut \u00eatre entour\u00e9e de guillemets \" ou d'apostrophes '. On peut donc \u00e9crire 'dupont' ou \"dupont\"\u00a0;</li> <li>ligne 34\u00a0: il y a une diff\u00e9rence entre un tuple (1,2,3) (notez les parenth\u00e8ses) et une liste [1,2,3] (notez les crochets). Le tuple est non modifiable alors que la liste l'est. Dans les deux cas, l'\u00e9lement n\u00b0 i est not\u00e9 [i]\u00a0;</li> <li>ligne 40\u00a0: range(n) est le tuple (0,1,2,\u2026,n-1)\u00a0;</li> <li>ligne 41\u00a0: le format %d est utilis\u00e9 pour les nombres entiers sign\u00e9s\u00a0;</li> <li>ligne 74\u00a0: len(var) est le nombre d'\u00e9l\u00e9ments de la collection var (tuple, liste, dictionnaire\u2026)\u00a0;</li> <li>ligne 84\u00a0: la structure [for in \u2026] permet d'it\u00e9rer une structure it\u00e9rable. Les listes et les tuples sont des \u00e9l\u00e9ments it\u00e9rables\u00a0;</li> <li>ligne 86\u00a0: les autres op\u00e9rateurs bool\u00e9ens sont or et not\u00a0;</li> <li>ligne 93\u00a0: fait la somme des nombres &gt;0 de la liste\u00a0; Les r\u00e9sultats \u00e9cran sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/bases/bases_01.py\nnom=dupont\nliste[0]=un\nliste[1]=deux\nliste[2]=3\nliste[3]=4\n[chaine1,chaine2,chaine1chaine2]\nchaine=chaine1\ntype[4]=&lt;class 'int'&gt;\ntype[chaine1]=&lt;class 'str'&gt;\ntype[['un', 'deux', 3, 4]]=&lt;class 'list'&gt;\ntype[a chang\u00e9]=&lt;class 'str'&gt;\nres1=14\n(res1,res2,res3)=[un,0,100]\nliste[0]=un\nliste[1]=0\nliste[2]=100\nliste[0]=8\nliste[1]=5\nsomme=13\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-bases-de-python.html#32-script-bases_02-chaines-de-formatage","title":"3.2. Script [bases_02]\u00a0\u00a0: cha\u00eenes de formatage","text":"<p>Python 3 a amen\u00e9 une nouvelle fa\u00e7on de formater les cha\u00eenes de caract\u00e8res\u00a0:</p> <pre><code># cha\u00eenes de formatage\n# les formats sont ceux du langage C\n# entier\nint1 = 10\nprint(f\"[int1={int1}]\")\nprint(f\"[int1={int1:4d}]\")\nprint(f\"[int1={int1:04d}]\")\n# float\nfloat1=8.2\nprint(f\"[float1={float1}]\")\nprint(f\"[float1={float1:8.2f}]\")\nprint(f\"[float1={float1:.3e}]\")\n# string\nstr1=\"abcd\"\nprint(f\"[str1={str1}]\")\nprint(f\"[str1={str1:8s}]\")\nstr2=\"jean de florette\"\nprint(f\"[{str2:20.10s}]\")\n# les cha\u00eenes format\u00e9es peuvent \u00eatre affect\u00e9es \u00e0 des variables\nstr3=f\"[{str2:20.10s}]\"\nprint(str3)\n</code></pre> <p>La syntaxe de la cha\u00eene format\u00e9e est la suivante\u00a0:</p> <pre><code>f'\u2026{expr1:format1} \u2026. {expr2:format2} \u2026.'\n</code></pre> <p>avec\u00a0:</p> <ul> <li>[expri]\u00a0: une expression\u00a0;</li> <li>[formati]\u00a0: le format de l'expression [expri]. Ces formats sont ceux du langage C\u00a0:</li> <li>%d\u00a0: pour les nombres entiers\u00a0;</li> <li>%f\u00a0: notation d\u00e9cimale pour les nombres r\u00e9els\u00a0;</li> <li>%e\u00a0: notation exponentielle pour les nombres r\u00e9els\u00a0;</li> <li>%s\u00a0: pour les cha\u00eenes de caract\u00e8res. C'est le format utilis\u00e9 lorsqu'aucun format n'est utilis\u00e9 pour [expri]\u00a0;</li> <li>%nd, %nf, %ns\u00a0: affiche [expri] sur n caract\u00e8res\u00a0: la cha\u00eene est soit tronqu\u00e9e, soit compl\u00e9t\u00e9e avec des espaces;</li> <li>ligne 7\u00a0: [04d], entier sur 4 caract\u00e8res compl\u00e9t\u00e9s \u00e0 gauche avec des z\u00e9ros;</li> <li>ligne 11\u00a0: [8.2f], r\u00e9el d\u00e9cimal sur 8 caract\u00e8res dont 2 apr\u00e8s la virgule\u00a0;</li> <li>ligne 12\u00a0: [.3e], r\u00e9el sous forme exponentielle avec 3 d\u00e9cimales pour la mantisse\u00a0;</li> <li>ligne 18\u00a0: [20.10s], les 10 premiers caract\u00e8res d'une cha\u00eene compl\u00e9t\u00e9e avec des espaces pour faire 20 caract\u00e8res\u00a0; Les r\u00e9sultats de l'ex\u00e9cution sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/bases/bases_02.py\n[int1=10]\n[int1=  10]\n[int1=0010]\n[float1=8.2]\n[float1=    8.20]\n[float1=8.200e+00]\n[str1=abcd]\n[str1=abcd    ]\n[jean de fl          ]\n[jean de fl          ]\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-bases-de-python.html#33-script-bases_03-changements-de-types","title":"3.3. Script [bases_03]\u00a0: changements de types","text":"<p>On s'int\u00e9resse ici aux changements de types avec des donn\u00e9es de type str (cha\u00eene de caract\u00e8res), int (entier), float (r\u00e9el), bool (bool\u00e9en).</p> <pre><code># changements de type\n# int --&gt; str, float, bool\nx = 4\nprint(x, type(x))\nx = str(4)\nprint(x, type(x))\nx = float(4)\nprint(x, type(x))\nx = bool(4)\nprint(x, type(x))\n\n# bool --&gt; int, float, str\nx = True\nprint(x, type(x))\nx = int(True)\nprint(x, type(x))\nx = float(True)\nprint(x, type(x))\nx = str(True)\nprint(x, type(x))\n\n# str --&gt; int, float, bool\nx = \"4\"\nprint(x, type(x))\nx = int(\"4\")\nprint(x, type(x))\nx = float(\"4\")\nprint(x, type(x))\nx = bool(\"4\")\nprint(x, type(x))\n\n# float --&gt; str, int, bool\nx = 4.32\nprint(x, type(x))\nx = str(4.32)\nprint(x, type(x))\nx = int(4.32)\nprint(x, type(x))\nx = bool(4.32)\nprint(x, type(x))\n\n# gestion des erreurs de changement de type\ntry:\n    x = int(\"abc\")\n    print(x, type(x))\nexcept ValueError as erreur:\n    print(erreur)\n\n# cas divers\nx = bool(\"abc\")\nprint(x, type(x))\nx = bool(\"\")\nprint(x, type(x))\nx = bool(0)\nprint(x, type(x))\nx = None\nprint(x, type(x))\nx = bool(None)\nprint(x, type(x))\nx = bool(0.0)\nprint(x, type(x))\n\n# toutes les donn\u00e9es sont des instances de classe et \u00e0 ce titre ont des m\u00e9thodes\n# cha\u00eene de caract\u00e8res\nstr1 = \"abc\"\nprint(str1.capitalize())\n# nombre entier\nint1 = 4\nprint(int1.bit_length())\n# bool\u00e9en\nbool1=True\nprint(bool1.conjugate())\n# nombre r\u00e9el\nfloat1=8.2\nprint (float1.is_integer())\n</code></pre> <p>De nombreux changements de type sont possibles. Certains peuvent \u00e9chouer, comme celui des lignes 46-47 qui essaient de transformer la cha\u00eene 'abc' en nombre entier. On a g\u00e9r\u00e9 l'erreur avec une structure try / except. Une forme g\u00e9n\u00e9rale de cette structure</p> <p>est la suivante\u00a0:</p> <pre><code>try:\n    actions\nexcept Exception as ex:\n    actions\nfinally:\n    actions\n</code></pre> <p>Si l'une des actions du try lance une exception (signale une erreur), il y a branchement imm\u00e9diat sur la clause except. Si les actions du try ne lancent pas d'exception, la clause except est ignor\u00e9e. Les attributs Exception et ex de l'instruction except sont facultatifs. Lorsqu'ils sont pr\u00e9sents, Exception pr\u00e9cise le type d'exception intercept\u00e9e par l'instruction except et ex contient l\u2019exception qui s\u2019est produite. Il peut y avoir plusieurs instructions except, si on veut g\u00e9rer diff\u00e9rents types d'exceptions dans le m\u00eame try.</p> <p>L'instruction finally est facultative. Si elle est pr\u00e9sente, les actions du finally sont toujours ex\u00e9cut\u00e9es qu'il y ait eu exception ou non.</p> <p>Nous reviendrons sur les exceptions un peu plus loin.</p> <p>Les lignes 49-61 montrent diverses tentatives pour transformer une donn\u00e9e de type str, int, float, NoneType en bool\u00e9en. C'est toujours possible. Les r\u00e8gles sont les suivantes\u00a0:</p> <ul> <li>bool(int i) vaut False si i vaut 0, True dans tous les autres cas\u00a0;</li> <li>bool(float f) vaut False si f vaut 0.0, True dans tous les autres cas\u00a0;</li> <li>bool(str chaine) vaut False si chaine a 0 caract\u00e8re, True dans tous les autres cas\u00a0;</li> <li>bool(None) vaut False. None est une valeur sp\u00e9ciale qui signifie que la variable existe mais n'a pas de valeur. Les r\u00e9sultats \u00e9cran sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/bases/bases_03.py\n4 &lt;class 'int'&gt;\n4 &lt;class 'str'&gt;\n4.0 &lt;class 'float'&gt;\nTrue &lt;class 'bool'&gt;\nTrue &lt;class 'bool'&gt;\n1 &lt;class 'int'&gt;\n1.0 &lt;class 'float'&gt;\nTrue &lt;class 'str'&gt;\n4 &lt;class 'str'&gt;\n4 &lt;class 'int'&gt;\n4.0 &lt;class 'float'&gt;\nTrue &lt;class 'bool'&gt;\n4.32 &lt;class 'float'&gt;\n4.32 &lt;class 'str'&gt;\n4 &lt;class 'int'&gt;\nTrue &lt;class 'bool'&gt;\ninvalid literal for int() with base 10: 'abc'\nTrue &lt;class 'bool'&gt;\nFalse &lt;class 'bool'&gt;\nFalse &lt;class 'bool'&gt;\nNone &lt;class 'NoneType'&gt;\nFalse &lt;class 'bool'&gt;\nFalse &lt;class 'bool'&gt;\nAbc\n3\n1\nFalse\n\nProcess finished with exit code 0\n</code></pre> <p>On notera que toutes les donn\u00e9es sont des objets, c'est-\u00e0-dire des instances de classe. Cela signifie qu'elles peuvent avoir des m\u00e9thodes. C'est ce que montrent les lignes 63-75 du code. Nous ne cherchons pas ici \u00e0 expliquer ce que font les m\u00e9thodes utilis\u00e9es mais simplement \u00e0 montrer qu'elles existent.</p>"},{"location":"les-bases-de-python.html#34-script-bases_04-portee-des-variables","title":"3.4. Script [bases_04]: port\u00e9e des variables","text":"<p>Le script [bases_04] montre que Python n'a pas la notion de variable de port\u00e9e bloc\u00a0:</p> <pre><code># port\u00e9e des variables\ni = 4\nif True:\n    i += 1\n    j = 7\nprint(f\"i={i}, j={j}\")\n</code></pre> <p>R\u00e9sultats</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/bases/bases_04.py\ni=5, j=7\n\nProcess finished with exit code 0\n</code></pre> <p>Commentaires</p> <p>Les r\u00e9sultats montrent deux choses\u00a0:</p> <ul> <li>ligne 4\u00a0: la variable [i] du bloc [if] est la m\u00eame que la variable i utilis\u00e9e ligne 2\u00a0;</li> <li>ligne 6\u00a0: la variable [j] est celle initialis\u00e9e dans le bloc [if]\u00a0; Dans certains langages, o\u00f9 on d\u00e9clare les variables, une variable d\u00e9finie dans un bloc (comme celui des lignes 3-5) n'est pas connue \u00e0 l'ext\u00e9rieur de celui-ci. En Python, rien de tel.</li> </ul>"},{"location":"les-bases-de-python.html#35-script-bases_05-listes-1","title":"3.5. Script [bases_05]\u00a0: listes - 1","text":"<p>Le script [bases_05] est le suivant\u00a0:</p> <pre><code># listes \u00e0 1 dimension\n# initialisation\nlist1 = [0, 1, 2, 3, 4, 5]\n\n# parcours - 1\nprint(f\"list1 a {len(list1)} \u00e9l\u00e9ments\")\nfor i in range(len(list1)):\n    print(f\"list1[{i}]={list1[i]}\")\n\nlist1[1] = 10\n# parcours - 2\nprint(f\"list1 a {len(list1)} \u00e9l\u00e9ments\")\nfor element in list1:\n    print(element)\n\n# ajout de deux \u00e9l\u00e9ments\nlist1[len(list1):] = [10, 11]\n# le format %s permet d'afficher la liste sur une ligne\nprint(\"%s\" % list1)\n\n# suppression des deux derniers \u00e9l\u00e9ments\nlist1[len(list1) - 2:] = []\n# le format par d\u00e9faut permet d'afficher la liste sur une ligne\nprint(f\"{list1}\")\n\n# ajout en d\u00e9but de liste d'une liste\nlist1[:0] = [-10, -11, -12]\nprint(f\"{list1}\")\n\n# insertion en milieu de liste de deux \u00e9l\u00e9ments\nlist1[3:3] = [100, 101]\nprint(f\"{list1}\")\n\n# suppression de deux \u00e9l\u00e9ments en milieu de liste\nlist1[3:4] = []\nprint(f\"{list1}\")\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>la notation tableau[i:j] d\u00e9signe les \u00e9l\u00e9ments i \u00e0 j-1 du tableau\u00a0;</li> <li>la notation [i:] d\u00e9signe les \u00e9l\u00e9ments i et suivants du tableau\u00a0;</li> <li>la notation [:i] d\u00e9signe les \u00e9l\u00e9ments 0 \u00e0 i-1 du tableau\u00a0;</li> <li>ligne 19\u00a0: print (%s) % (list1) affiche la cha\u00eene de caract\u00e8res\u00a0: \"[ list1[0], list1[2]\u2026, list1[n-1]]\"\u00a0;</li> <li>ligne 24\u00a0: la notation print ('f{list1}') fait la m\u00eame chose\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/bases/bases_05.py\nlist1 a 6 \u00e9l\u00e9ments\nlist1[0]=0\nlist1[1]=1\nlist1[2]=2\nlist1[3]=3\nlist1[4]=4\nlist1[5]=5\nlist1 a 6 \u00e9l\u00e9ments\n0\n10\n2\n3\n4\n5\n[0, 10, 2, 3, 4, 5, 10, 11]\n[0, 10, 2, 3, 4, 5]\n[-10, -11, -12, 0, 10, 2, 3, 4, 5]\n[-10, -11, -12, 100, 101, 0, 10, 2, 3, 4, 5]\n[-10, -11, -12, 101, 0, 10, 2, 3, 4, 5]\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-bases-de-python.html#36-script-bases_06-listes-2","title":"3.6. Script [bases_06]\u00a0: listes - 2","text":"<p>Le code pr\u00e9c\u00e9dent peut \u00eatre \u00e9crit diff\u00e9remment (bases_06) en utilisant certaines m\u00e9thodes des listes\u00a0:</p> <pre><code># listes \u00e0 1 dimension\n\n# initialisation\nlist1 = [0, 1, 2, 3, 4, 5]\n\n# parcours - 1\nprint(f\"list1 a {len(list1)} \u00e9l\u00e9ments\")\nfor i in range(len(list1)):\n    print(f\"list1[{i}]={list1[i]}\")\n\n# modification d'un \u00e9l\u00e9ment\nlist1[1] = 10\n\n# parcours - 2\nprint(f\"list1 a {len(list1)} \u00e9l\u00e9ments\")\nfor element in list1:\n    print(element)\n\n# ajout de deux \u00e9l\u00e9ments\nlist1.extend([10, 11])\nprint(f\"{list1}\")\n\n# suppression des deux derniers \u00e9l\u00e9ments\ndel list1[len(list1) - 2:]\nprint(f\"{list1}\")\n\n# ajout en d\u00e9but de liste d'un tuple\nfor i in (-12, -11, -10):\n    list1.insert(0, i)\nprint(f\"{list1}\")\n\n# insertion en milieu de liste\nfor i in (101, 100):\n    list1.insert(3, i)\nprint(f\"{list1}\")\n\n# suppression en milieu de liste\ndel list1[3:4]\nprint(f\"{list1}\")\n</code></pre> <p>Les r\u00e9sultats obtenus sont les m\u00eames qu'avec la version pr\u00e9c\u00e9dente.</p>"},{"location":"les-bases-de-python.html#37-script-bases_07-le-dictionnaire","title":"3.7. script [bases_07]\u00a0: le dictionnaire","text":"<p>Le script [bases_07] montre comment d\u00e9finir et exploiter un dictionnaire, parfois appel\u00e9 tableau associatif.</p> <pre><code># une fonction qui v\u00e9rifie si la cl\u00e9 mari existe dans le dictionnaire conjoints\ndef existe(conjoints, mari):\n    if mari in conjoints:\n        print(f\"La cl\u00e9 [{mari}] existe associ\u00e9e \u00e0 la valeur [{conjoints[mari]}]\")\n    else:\n        print(f\"La cl\u00e9 [{mari}] n'existe pas\")\n\n\n# ----------------------------- Main\n# un dictionnaire\nconjoints = {\"Pierre\": \"Gis\u00e8le\", \"Paul\": \"Virginie\", \"Jacques\": \"Lucette\", \"Jean\": \"\"}\n\n# parcours - 1\nprint(f\"Nombre d'\u00e9l\u00e9ments du dictionnaire : {len(conjoints)}\")\nfor (cl\u00e9, valeur) in conjoints.items():\n    print(f\"conjoints[{cl\u00e9}]={valeur}\")\n\n# liste des cl\u00e9s du dictionnaire\nprint(\"liste des cl\u00e9s-------------\")\ncl\u00e9s = conjoints.keys()\nprint(f\"{cl\u00e9s}\")\n\n# liste des valeurs du dictionnaire\nprint(\"liste des valeurs------------\")\nvaleurs = conjoints.values()\nprint(f\"{valeurs}\")\n\n# recherche d'une cl\u00e9\nexiste(conjoints, \"Jacques\")\nexiste(conjoints, \"Lucette\")\nexiste(conjoints, \"Jean\")\n\n# suppression d'une cl\u00e9-valeur\ndel (conjoints[\"Jean\"])\nprint(f\"Nombre d'\u00e9l\u00e9ments du dictionnaire : {len(conjoints)}\")\nprint(f\"{conjoints}\")\n\n# les cl\u00e9s et valeurs d'un dictionnaire ne sont pas des listes\nprint(f\"type des cl\u00e9s : {type(cl\u00e9s)}\")\nprint(f\"type des valeurs : {type(valeurs)}\")\n\n# on peut les transformer en listes\nlcl\u00e9s = list(cl\u00e9s)\nprint(f\"cl\u00e9s : {type(lcl\u00e9s)}, {lcl\u00e9s}\")\nlvaleurs = list(valeurs)\nprint(f\"valeurs : {type(lvaleurs)}, {lvaleurs}\")\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>ligne 11\u00a0: la d\u00e9finition en dur d'un dictionnaire\u00a0;</li> <li>ligne 15\u00a0: conjoints.items() rend la liste des couples (cl\u00e9,valeur) du dictionnaire conjoints\u00a0;</li> <li>ligne 20\u00a0: conjoints.keys() rend les cl\u00e9s du dictionnaire conjoints\u00a0;</li> <li>ligne 25\u00a0: conjoints.values() rend les valeurs du dictionnaire conjoints\u00a0;</li> <li>ligne 3\u00a0: mari in conjoints rend True si la cl\u00e9 mari existe dans le dictionnaire conjoints, False sinon\u00a0;</li> <li>ligne 36\u00a0: un dictionnaire peut \u00eatre affich\u00e9 en une seule ligne. R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/bases/bases_07.py\nNombre d'\u00e9l\u00e9ments du dictionnaire : 4\nconjoints[Pierre]=Gis\u00e8le\nconjoints[Paul]=Virginie\nconjoints[Jacques]=Lucette\nconjoints[Jean]=\nliste des cl\u00e9s-------------\ndict_keys(['Pierre', 'Paul', 'Jacques', 'Jean'])\nliste des valeurs------------\ndict_values(['Gis\u00e8le', 'Virginie', 'Lucette', ''])\nLa cl\u00e9 [Jacques] existe associ\u00e9e \u00e0 la valeur [Lucette]\nLa cl\u00e9 [Lucette] n'existe pas\nLa cl\u00e9 [Jean] existe associ\u00e9e \u00e0 la valeur []\nNombre d'\u00e9l\u00e9ments du dictionnaire : 3\n{'Pierre': 'Gis\u00e8le', 'Paul': 'Virginie', 'Jacques': 'Lucette'}\ntype des cl\u00e9s : &lt;class 'dict_keys'&gt;\ntype des valeurs : &lt;class 'dict_values'&gt;\ncl\u00e9s : &lt;class 'list'&gt;, ['Pierre', 'Paul', 'Jacques']\nvaleurs : &lt;class 'list'&gt;, ['Gis\u00e8le', 'Virginie', 'Lucette']\n\nProcess finished with exit code 0\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>on notera aux lignes 16-17 des r\u00e9sultats que les cl\u00e9s et valeurs d'un dictionnaire ne forment pas une liste mais un type 'dict_keys'\u00a0;</li> <li>lignes 18-19\u00a0: un simple changement de type permet de les convertir en un type [list]\u00a0;</li> </ul>"},{"location":"les-bases-de-python.html#38-script-bases_08-les-tuples","title":"3.8. script [bases_08]\u00a0: les tuples","text":"<p>Le tuple a des similitudes avec la liste mais est non modifiable\u00a0:</p> <pre><code># tuples\n# initialisation\ntuple1 = (0, 1, 2, 3, 4, 5)\n\n# parcours - 1\nprint(f\"tuple1 a {len(tuple1)} elements\")\nfor i in range(len(tuple1)):\n    print(f\"tuple1[{i}]={tuple1[i]}\")\n\n# parcours - 2\nprint(f\"tuple1 a {len(tuple1)} elements\")\nfor element in tuple1:\n    print(element)\n\n# un tuble peut \u00eatre affich\u00e9 en une ligne\nprint(f\"tuple1={tuple1}\")\n\n# un tuple ne peut \u00eatre modifi\u00e9\ntuple1[0] = 10\n</code></pre> <p>R\u00e9sultats</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/bases/bases_08.py\ntuple1 a 6 elements\ntuple1[0]=0\ntuple1[1]=1\ntuple1[2]=2\ntuple1[3]=3\ntuple1[4]=4\ntuple1[5]=5\ntuple1 a 6 elements\n0\n1\n2\n3\n4\n5\ntuple1=(0, 1, 2, 3, 4, 5)\nTraceback (most recent call last):\n  File \"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/bases/bases_08.py\", line 19, in &lt;module&gt;\n    tuple1[0] = 10\nTypeError: 'tuple' object does not support item assignment\n\nProcess finished with exit code 1\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>lignes 17-20 des r\u00e9sultats\u00a0: montrent qu'un tuple ne peut pas \u00eatre modifi\u00e9.</li> </ul>"},{"location":"les-bases-de-python.html#39-script-bases_09-les-listes-et-dictionnaires-a-plusieurs-dimensions","title":"3.9. Script [bases_09]\u00a0: les listes et dictionnaires \u00e0 plusieurs dimensions","text":"<p>Le script [bases_09] montre comment d\u00e9finir et exploiter une liste ou un dictionnaire multidimensionnel\u00a0:</p> <pre><code># listes multidimensionnelles\n# initialisation\nmulti = [[0, 1, 2], [10, 11, 12, 13], [20, 21, 22, 23, 24]]\n\n# parcours\nfor i1 in range(len(multi)):\n    for i2 in range(len(multi[i1])):\n        print(f\"multi[{i1}][{i2}]={multi[i1][i2]}\")\n\n# affichage en une ligne\nprint(f\"multi={multi}\")\n\n# dictionnaires multidimensionnels\n# initialisation\nmulti = {\"z\u00e9ro\": [0, 1], \"un\": [10, 11, 12, 13], \"deux\": [20, 21, 22, 23, 24]}\n\n# parcours\nfor (cl\u00e9, valeur) in multi.items():\n    for i2 in range(len(valeur)):\n        print(f\"multi[{cl\u00e9}][{i2}]={multi[cl\u00e9][i2]}\")\n\n# affichage en une ligne\nprint(f\"multi={multi}\")\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 7\u00a0: multi[i1] est une liste\u00a0;</li> <li>ligne 18\u00a0: valeur est une liste\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/bases/bases_09.py\nmulti[0][0]=0\nmulti[0][1]=1\nmulti[0][2]=2\nmulti[1][0]=10\nmulti[1][1]=11\nmulti[1][2]=12\nmulti[1][3]=13\nmulti[2][0]=20\nmulti[2][1]=21\nmulti[2][2]=22\nmulti[2][3]=23\nmulti[2][4]=24\nmulti=[[0, 1, 2], [10, 11, 12, 13], [20, 21, 22, 23, 24]]\nmulti[z\u00e9ro][0]=0\nmulti[z\u00e9ro][1]=1\nmulti[un][0]=10\nmulti[un][1]=11\nmulti[un][2]=12\nmulti[un][3]=13\nmulti[deux][0]=20\nmulti[deux][1]=21\nmulti[deux][2]=22\nmulti[deux][3]=23\nmulti[deux][4]=24\nmulti={'z\u00e9ro': [0, 1], 'un': [10, 11, 12, 13], 'deux': [20, 21, 22, 23, 24]}\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-bases-de-python.html#310-script-bases_10-liens-entre-chaines-et-listes","title":"3.10. Script [bases_10]\u00a0: liens entre cha\u00eenes et listes","text":"<p>Le script [bases_10] montrent comment r\u00e9cup\u00e9rer dans une liste les \u00e9l\u00e9ments d'une cha\u00eene s\u00e9par\u00e9s par un m\u00eame s\u00e9parateur.</p> <pre><code># cha\u00eene vers liste\nchaine = '1:2:3:4'\nliste = chaine.split(':')\nprint(type(liste))\n\n# affichage liste\nprint(f\"liste a {len(liste)} \u00e9l\u00e9ments\")\nprint(f\"liste={liste}\")\n\n# liste vers cha\u00eene\nchaine2 = \":\".join(liste)\nprint(f\"chaine2={chaine2}\")\n\n# ajoutons un champ vide\nchaine += \":\"\nprint(f\"chaine={chaine}\")\nliste = chaine.split(\":\")\n\n# affichage liste\nprint(f\"liste a {len(liste)} \u00e9l\u00e9ments\")\nprint(f\"liste={liste}\")\n\n# ajoutons de nouveau un champ vide\nchaine += \":\"\nprint(f\"chaine={chaine}\")\nliste = chaine.split(\":\")\n\n# affichage liste\nprint(f\"liste a {len(liste)} \u00e9l\u00e9ments\")\nprint(f\"liste={liste}\")\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>ligne 3\u00a0: la m\u00e9thode chaine.split(s\u00e9parateur) d\u00e9coupe la cha\u00eene de caract\u00e8res chaine en \u00e9l\u00e9ments s\u00e9par\u00e9s par s\u00e9parateur et les rend sous forme de liste. Ainsi l'expression '1:2:3:4'.split(\":\") a pour valeur la liste ('1','2','3','4')\u00a0;</li> <li>ligne 11\u00a0: 'separateur'.join(liste) a pour valeur la cha\u00eene de caract\u00e8res 'liste[0]+separateur+liste[1]+separateur+\u2026'. R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/bases/bases_10.py\n&lt;class 'list'&gt;\nliste a 4 \u00e9l\u00e9ments\nliste=['1', '2', '3', '4']\nchaine2=1:2:3:4\nchaine=1:2:3:4:\nliste a 5 \u00e9l\u00e9ments\nliste=['1', '2', '3', '4', '']\nchaine=1:2:3:4::\nliste a 6 \u00e9l\u00e9ments\nliste=['1', '2', '3', '4', '', '']\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-bases-de-python.html#311-script-bases_11-les-expressions-regulieres","title":"3.11. Script [bases_11]\u00a0: les expressions r\u00e9guli\u00e8res","text":"<p>Le script [bases_11] montre comment utiliser des expressions r\u00e9guli\u00e8res\u00a0:</p> <pre><code># on importe le module des expressions r\u00e9guli\u00e8res\nimport re\n\n\n# --------------------------------------------------------------------------\ndef compare(mod\u00e8le, chaine):\n    # compare la cha\u00eene [cha\u00eene] au mod\u00e8le [mod\u00e8le]\n    # affichage r\u00e9sultats\n    print(f\"\\nR\u00e9sultats({chaine},{mod\u00e8le})\")\n    match = re.match(mod\u00e8le, chaine)\n    if match:\n        print(match.groups())\n    else:\n        print(f\"La cha\u00eene [{chaine}] ne correspond pas au mod\u00e8le [{mod\u00e8le}]\")\n\n\n# expression r\u00e9guli\u00e8res en python\n# r\u00e9cup\u00e9rer les diff\u00e9rents champs d'une cha\u00eene\n# le mod\u00e8le : une suite de chiffres entour\u00e9e de caract\u00e8res quelconques\n# on ne veut r\u00e9cup\u00e9rer que la suite de chiffres\nmod\u00e8le = r\"^.*?(\\d+).*?$\"\n\n# on confronte la cha\u00eene au mod\u00e8le\ncompare(mod\u00e8le, \"xyz1234abcd\")\ncompare(mod\u00e8le, \"12 34\")\ncompare(mod\u00e8le, \"abcd\")\n\n# le mod\u00e8le : une suite de chiffres entour\u00e9e de caract\u00e8res quelconques\n# on veut la suite de chiffres ainsi que les champs qui suivent et pr\u00e9c\u00e8dent\nmod\u00e8le = r\"^(.*?)(\\d+)(.*?)$\"\n\n# on confronte la cha\u00eene au mod\u00e8le\ncompare(mod\u00e8le, \"xyz1234abcd\")\ncompare(mod\u00e8le, \"12 34\")\ncompare(mod\u00e8le, \"abcd\")\n\n# le mod\u00e8le - une date au format jj/mm/aa\nmod\u00e8le = r\"^\\s*(\\d\\d)\\/(\\d\\d)\\/(\\d\\d)\\s*$\"\ncompare(mod\u00e8le, \"10/05/97\")\ncompare(mod\u00e8le, \" 04/04/01 \")\ncompare(mod\u00e8le, \"5/1/01\")\n\n# le mod\u00e8le - un nombre d\u00e9cimal\nmod\u00e8le = r\"^\\s*([+-]?)\\s*(\\d+\\.\\d*|\\.\\d+|\\d+)\\s*$\"\ncompare(mod\u00e8le, \"187.8\")\ncompare(mod\u00e8le, \"-0.6\")\ncompare(mod\u00e8le, \"4\")\ncompare(mod\u00e8le, \".6\")\ncompare(mod\u00e8le, \"4.\")\ncompare(mod\u00e8le, \" + 4\")\n# fin\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>noter le module [re] import\u00e9 en ligne 2. C'est lui qui contient les fonctions de gestion des expressions r\u00e9guli\u00e8res\u00a0;</li> <li>ligne 10\u00a0: la comparaison d'une cha\u00eene \u00e0 une expression r\u00e9guli\u00e8re (mod\u00e8le) rend le bool\u00e9en True si la cha\u00eene correspond au mod\u00e8le, False sinon\u00a0;</li> <li>ligne 12\u00a0: match.groups() est un tuple dont les \u00e9l\u00e9ments sont les parties de la cha\u00eene qui correspondent aux \u00e9l\u00e9ments de l'expression r\u00e9guli\u00e8re entour\u00e9s de parenth\u00e8ses. Dans le mod\u00e8le\u00a0:</li> <li>^.*?(\\d+).*?, match.groups() sera un tuple d'un \u00e9l\u00e9ment parce qu'il y a une parenth\u00e8se\u00a0;</li> <li>^(.*?)(\\d+)(.*?)$,  match.groups() sera un tuple de 3 \u00e9l\u00e9ments parce qu'il y a trois parenth\u00e8ses\u00a0;</li> <li>ligne 21\u00a0: une expression r\u00e9guli\u00e8re litt\u00e9rale est not\u00e9e r\"xxx\". C'est le symbole r qui fait de la cha\u00eene une expression r\u00e9guli\u00e8re\u00a0; Les expressions r\u00e9guli\u00e8res nous permettent de tester le format d'une cha\u00eene de caract\u00e8res. Ainsi on peut v\u00e9rifier qu'une cha\u00eene repr\u00e9sentant une date est au format jj/mm/aa. On utilise pour cela un mod\u00e8le et on compare la cha\u00eene \u00e0 ce mod\u00e8le. Ainsi dans cet exemple, j m et a doivent \u00eatre des chiffres. Le mod\u00e8le d'un format de date valide est alors \"\\d\\d/\\d\\d/\\d\\d\" o\u00f9 le symbole \\d d\u00e9signe un chiffre. Les symboles utilisables dans un mod\u00e8le sont les suivants\u00a0:</li> </ul> <p>Caract\u00e8re</p><p>Description</p><p>\\</p><p>Marque le caract\u00e8re suivant comme caract\u00e8re sp\u00e9cial ou litt\u00e9ral. Par exemple, \"n\" correspond au caract\u00e8re \"n\" alors que \"\\n\" correspond \u00e0 un caract\u00e8re de nouvelle ligne. La s\u00e9quence \"\\\\\" correspond \u00e0 \"\\\", tandis que \"\\(\" correspond \u00e0 \"(\".</p><p>^</p><p>Correspond au d\u00e9but de la cha\u00eene.</p><p>$</p><p>Correspond \u00e0 la fin de la cha\u00eene.</p><p>*</p><p>Correspond au caract\u00e8re pr\u00e9c\u00e9dent, z\u00e9ro fois ou plusieurs fois. Ainsi, \"zo*\" correspond \u00e0 \"z\" ou \u00e0 \"zoo\".</p><p>+</p><p>Correspond au caract\u00e8re pr\u00e9c\u00e9dent, une ou plusieurs fois. Ainsi, \"zo+\" correspond \u00e0 \"zoo\", mais pas \u00e0 \"z\".</p><p>?</p><p>Correspond au caract\u00e8re pr\u00e9c\u00e9dent, z\u00e9ro ou une fois. Par exemple, \"a?ve?\" correspond \u00e0 \"ve\" dans \"lever\".</p><p>.</p><p>Correspond \u00e0 tout caract\u00e8re unique, sauf le caract\u00e8re de nouvelle ligne.</p><p>(mod\u00e8le)</p><p>Recherche le mod\u00e8le et m\u00e9morise la correspondance. La sous-cha\u00eene correspondante peut \u00eatre extraite de la collection match.groups(). Pour trouver des correspondances avec des caract\u00e8res entre parenth\u00e8ses ( ), utilisez \"\\(\" ou \"\\)\".</p><p>x|y</p><p>Correspond soit \u00e0 x soit \u00e0 y. Par exemple, \"z|foot\" correspond \u00e0 \"z\" ou \u00e0 \"foot\". \"(z|f)oo\" correspond \u00e0 \"zoo\" ou \u00e0 \"foo\".</p><p>{n}</p><p>n est un nombre entier non n\u00e9gatif. Correspond exactement \u00e0 n fois le caract\u00e8re. Par exemple, \"o{2}\" ne correspond pas \u00e0 \"o\" dans \"Bob,\" mais aux deux premiers \"o\" dans \"fooooot\".</p><p>{n,}</p><p>n est un entier non n\u00e9gatif. Correspond \u00e0 au moins n fois le caract\u00e8re. Par exemple, \"o{2,}\" ne correspond pas \u00e0 \"o\" dans \"Bob\", mais \u00e0 tous les \"o\" dans \"fooooot\". \"o{1,}\" \u00e9quivaut \u00e0 \"o+\" et \"o{0,}\" \u00e9quivaut \u00e0 \"o*\".</p><p>{n,m}</p><p>m et n sont des entiers non n\u00e9gatifs. Correspond \u00e0 au moins n et \u00e0 au plus m fois le caract\u00e8re. Par exemple, \"o{1,3}\" correspond aux trois premiers \"o\" dans \"foooooot\" et \"o{0,1}\" \u00e9quivaut \u00e0 \"o?\".</p><p>[xyz]</p><p>Jeu de caract\u00e8res. Correspond \u00e0 l'un des caract\u00e8res indiqu\u00e9s. Par exemple, \"[abc]\" correspond \u00e0 \"a\" dans \"plat\".</p><p>[^xyz]</p><p>Jeu de caract\u00e8res n\u00e9gatif. Correspond \u00e0 tout caract\u00e8re non indiqu\u00e9. Par exemple, \"[^abc]\" correspond \u00e0 \"p\" dans \"plat\".</p><p>[a-z]</p><p>Plage de caract\u00e8res. Correspond \u00e0 tout caract\u00e8re dans la s\u00e9rie sp\u00e9cifi\u00e9e. Par exemple, \"[a-z]\" correspond \u00e0 tout caract\u00e8re alphab\u00e9tique minuscule compris entre \"a\" et \"z\".</p><p>[^m-z]</p><p>Plage de caract\u00e8res n\u00e9gative. Correspond \u00e0 tout caract\u00e8re ne se trouvant pas dans la s\u00e9rie sp\u00e9cifi\u00e9e. Par exemple, \"[^m-z]\" correspond \u00e0 tout caract\u00e8re ne se trouvant pas entre \"m\" et \"z\".</p><p>\\b</p><p>Correspond \u00e0 une limite repr\u00e9sentant un mot, autrement dit, \u00e0 la position entre un mot et un espace. Par exemple, \"er\\b\" correspond \u00e0 \"er\" dans \"lever\", mais pas \u00e0 \"er\" dans \"verbe\".</p><p>\\B</p><p>Correspond \u00e0 une limite ne repr\u00e9sentant pas un mot. \"en*t\\B\" correspond \u00e0 \"ent\" dans \"bien entendu\".</p><p>\\d</p><p>Correspond \u00e0 un caract\u00e8re repr\u00e9sentant un chiffre. \u00c9quivaut \u00e0 [0-9].</p><p>\\D</p><p>Correspond \u00e0 un caract\u00e8re ne repr\u00e9sentant pas un chiffre. \u00c9quivaut \u00e0 [^0-9].</p><p>\\f</p><p>Correspond \u00e0 un caract\u00e8re de saut de page.</p><p>\\n</p><p>Correspond \u00e0 un caract\u00e8re de nouvelle ligne.</p><p>\\r</p><p>Correspond \u00e0 un caract\u00e8re de retour chariot.</p><p>\\s</p><p>Correspond \u00e0 tout espace blanc, y compris l'espace, la tabulation, le saut de page, etc. \u00c9quivaut \u00e0 \"[\u00a0\\f\\n\\r\\t\\v]\".</p><p>\\S</p><p>Correspond \u00e0 tout caract\u00e8re d'espace non blanc. \u00c9quivaut \u00e0 \"[^\u00a0\\f\\n\\r\\t\\v]\".</p><p>\\t</p><p>Correspond \u00e0 un caract\u00e8re de tabulation.</p><p>\\v</p><p>Correspond \u00e0 un caract\u00e8re de tabulation verticale.</p><p>\\w</p><p>Correspond \u00e0 tout caract\u00e8re repr\u00e9sentant un mot et incluant un trait de soulignement. \u00c9quivaut \u00e0 \"[A-Za-z0-9_]\".</p><p>\\W</p><p>Correspond \u00e0 tout caract\u00e8re ne repr\u00e9sentant pas un mot. \u00c9quivaut \u00e0 \"[^A-Za-z0-9_]\".</p><p>\\num</p><p>Correspond \u00e0 num, o\u00f9 num est un entier positif. Fait r\u00e9f\u00e9rence aux correspondances m\u00e9moris\u00e9es. Par exemple, \"(.)\\1\" correspond \u00e0 deux caract\u00e8res identiques cons\u00e9cutifs.</p><p>\\n</p><p>Correspond \u00e0 n, o\u00f9 n est une valeur d'\u00e9chappement octale. Les valeurs d'\u00e9chappement octales doivent comprendre 1, 2 ou 3 chiffres. Par exemple, \"\\11\" et \"\\011\" correspondent tous les deux \u00e0 un caract\u00e8re de tabulation. \"\\0011\" \u00e9quivaut \u00e0 \"\\001\" &amp; \"1\". Les valeurs d'\u00e9chappement octales ne doivent pas exc\u00e9der 256. Si c'\u00e9tait le cas, seuls les deux premiers chiffres seraient pris en compte dans l'expression. Permet d'utiliser les codes ASCII dans des expressions r\u00e9guli\u00e8res.</p><p>\\xn</p><p>Correspond \u00e0 n, o\u00f9 n est une valeur d'\u00e9chappement hexad\u00e9cimale. Les valeurs d'\u00e9chappement hexad\u00e9cimales doivent comprendre deux chiffres obligatoirement. Par exemple, \"\\x41\" correspond \u00e0 \"A\". \"\\x041\" \u00e9quivaut \u00e0 \"\\x04\" &amp; \"1\". Permet d'utiliser les codes ASCII dans des expressions r\u00e9guli\u00e8res.</p> <p>Un \u00e9l\u00e9ment dans un mod\u00e8le peut \u00eatre pr\u00e9sent en 1 ou plusieurs exemplaires. Consid\u00e9rons quelques exemples autour du symbole \\d qui repr\u00e9sente 1 chiffre\u00a0:</p> <p>mod\u00e8le</p><p>signification</p><p>\\d</p><p>un chiffre</p><p>\\d?</p><p>0 ou 1 chiffre</p><p>\\d*</p><p>0 ou davantage de chiffres</p><p>\\d+</p><p>1 ou davantage de chiffres</p><p>\\d{2}</p><p>2 chiffres</p><p>\\d{3,}</p><p>au moins 3 chiffres</p><p>\\d{5,7}</p><p>entre 5 et 7 chiffres</p> <p>Imaginons maintenant le mod\u00e8le capable de d\u00e9crire le format attendu pour une cha\u00eene de caract\u00e8res\u00a0:</p> <p>cha\u00eene recherch\u00e9e</p><p>mod\u00e8le</p><p>une date au format jj/mm/aa</p><p>\\d{2}/\\d{2}/\\d{2}</p><p>une heure au format hh:mm:ss</p><p>\\d{2}:\\d{2}:\\d{2}</p><p>un nombre entier non sign\u00e9</p><p>\\d+</p><p>un suite d'espaces \u00e9ventuellement vide</p><p>\\s*</p><p>un nombre entier non sign\u00e9 qui peut \u00eatre pr\u00e9c\u00e9d\u00e9 ou suivi d'espaces</p><p>\\s*\\d+\\s*</p><p>un nombre entier qui peut \u00eatre sign\u00e9 et pr\u00e9c\u00e9d\u00e9 ou suivi d'espaces</p><p>\\s*[+|-]?\\s*\\d+\\s*</p><p>un nombre r\u00e9el non sign\u00e9 qui peut \u00eatre pr\u00e9c\u00e9d\u00e9 ou suivi d'espaces</p><p>\\s*\\d+(.\\d*)?\\s*</p><p>un nombre r\u00e9el qui peut \u00eatre sign\u00e9 et pr\u00e9c\u00e9d\u00e9 ou suivi d'espaces</p><p>\\s*[+-]?\\s*\\d+(.\\d*)?\\s*</p><p>une cha\u00eene contenant le mot juste</p><p>\\bjuste\\b</p> <p>On peut pr\u00e9ciser o\u00f9 on recherche le mod\u00e8le dans la cha\u00eene\u00a0:</p> <p>mod\u00e8le</p><p>signification</p><p>^mod\u00e8le</p><p>le mod\u00e8le commence la cha\u00eene</p><p>mod\u00e8le$</p><p>le mod\u00e8le finit la cha\u00eene</p><p>^mod\u00e8le$</p><p>le mod\u00e8le commence et finit la cha\u00eene</p><p>mod\u00e8le</p><p>le mod\u00e8le est cherch\u00e9 partout dans la cha\u00eene en commen\u00e7ant par le d\u00e9but de celle-ci.</p> <p>cha\u00eene recherch\u00e9e</p><p>mod\u00e8le</p><p>une cha\u00eene se terminant par un point d'exclamation</p><p>!$</p><p>une cha\u00eene se terminant par un point</p><p>\\.$</p><p>une cha\u00eene commen\u00e7ant par la s\u00e9quence //</p><p>^//</p><p>une cha\u00eene ne comportant qu'un mot \u00e9ventuellement suivi ou pr\u00e9c\u00e9d\u00e9 d'espaces</p><p>^\\s*\\w+\\s*$</p><p>une cha\u00eene ne comportant deux mot \u00e9ventuellement suivis ou pr\u00e9c\u00e9d\u00e9s d'espaces</p><p>^\\s*\\w+\\s*\\w+\\s*$</p><p>une cha\u00eene contenant le mot secret</p><p>\\bsecret\\b</p> <p>Les sous-ensembles d'un mod\u00e8le peuvent \u00eatre \"r\u00e9cup\u00e9r\u00e9s\". Ainsi non seulement, on peut v\u00e9rifier qu'une cha\u00eene correspond \u00e0 un mod\u00e8le particulier mais on peut r\u00e9cup\u00e9rer dans cette cha\u00eene les \u00e9l\u00e9ments correspondant aux sous-ensembles du mod\u00e8le qui ont \u00e9t\u00e9 entour\u00e9s de parenth\u00e8ses. Ainsi si on analyse une cha\u00eene contenant une date jj/mm/aa et si on veut de plus r\u00e9cup\u00e9rer les \u00e9l\u00e9ments jj, mm, aa de cette date on utilisera le mod\u00e8le (\\d\\d)/(\\d\\d)/(\\d\\d).</p> <p>R\u00e9sultats du script</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/bases/bases_11.py\n\nR\u00e9sultats(xyz1234abcd,^.*?(\\d+).*?$)\n('1234',)\n\nR\u00e9sultats(12 34,^.*?(\\d+).*?$)\n('12',)\n\nR\u00e9sultats(abcd,^.*?(\\d+).*?$)\nLa cha\u00eene [abcd] ne correspond pas au mod\u00e8le [^.*?(\\d+).*?$]\n\nR\u00e9sultats(xyz1234abcd,^(.*?)(\\d+)(.*?)$)\n('xyz', '1234', 'abcd')\n\nR\u00e9sultats(12 34,^(.*?)(\\d+)(.*?)$)\n('', '12', ' 34')\n\nR\u00e9sultats(abcd,^(.*?)(\\d+)(.*?)$)\nLa cha\u00eene [abcd] ne correspond pas au mod\u00e8le [^(.*?)(\\d+)(.*?)$]\n\nR\u00e9sultats(10/05/97,^\\s*(\\d\\d)\\/(\\d\\d)\\/(\\d\\d)\\s*$)\n('10', '05', '97')\n\nR\u00e9sultats( 04/04/01 ,^\\s*(\\d\\d)\\/(\\d\\d)\\/(\\d\\d)\\s*$)\n('04', '04', '01')\n\nR\u00e9sultats(5/1/01,^\\s*(\\d\\d)\\/(\\d\\d)\\/(\\d\\d)\\s*$)\nLa cha\u00eene [5/1/01] ne correspond pas au mod\u00e8le [^\\s*(\\d\\d)\\/(\\d\\d)\\/(\\d\\d)\\s*$]\n\nR\u00e9sultats(187.8,^\\s*([+-]?)\\s*(\\d+\\.\\d*|\\.\\d+|\\d+)\\s*$)\n('', '187.8')\n\nR\u00e9sultats(-0.6,^\\s*([+-]?)\\s*(\\d+\\.\\d*|\\.\\d+|\\d+)\\s*$)\n('-', '0.6')\n\nR\u00e9sultats(4,^\\s*([+-]?)\\s*(\\d+\\.\\d*|\\.\\d+|\\d+)\\s*$)\n('', '4')\n\nR\u00e9sultats(.6,^\\s*([+-]?)\\s*(\\d+\\.\\d*|\\.\\d+|\\d+)\\s*$)\n('', '.6')\n\nR\u00e9sultats(4.,^\\s*([+-]?)\\s*(\\d+\\.\\d*|\\.\\d+|\\d+)\\s*$)\n('', '4.')\n\nR\u00e9sultats( + 4,^\\s*([+-]?)\\s*(\\d+\\.\\d*|\\.\\d+|\\d+)\\s*$)\n('+', '4')\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-chaines-de-caracteres.html","title":"4. Les cha\u00eenes de caract\u00e8res","text":""},{"location":"les-chaines-de-caracteres.html#41-script-str_01-notation-des-chaines-de-caracteres","title":"4.1. Script [str_01]\u00a0: notation des cha\u00eenes de caract\u00e8res","text":"<p>Le script [str_01] est le suivant\u00a0:</p> <pre><code># cha\u00eenes de caract\u00e8res\n# trois notations possibles\nchaine1 = \"un\"\nchaine2 = 'deux'\nchaine3 = \"\"\"h\u00e9l\u00e8ne va au\n march\u00e9 acheter des l\u00e9gumes\"\"\"\n# affichage\nprint(f\"chaine1=[{chaine1}], chaine2=[{chaine2}], chaine3=[{chaine3}]\")\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 3 \u00a0: une cha\u00eene d\u00e9limit\u00e9e par des guillemets \"\u00a0;</li> <li>ligne 4 \u00a0: une cha\u00eene d\u00e9limit\u00e9e par des apostrophes '\u00a0;</li> <li>ligne 5 \u00a0: une cha\u00eene d\u00e9limit\u00e9e par des triples guillemets \"\"\". Dans ce cas, la cha\u00eene peut s'\u00e9taler sur plusieurs lignes\u00a0; Les r\u00e9sultats sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/strings/str_01.py\nchaine1=[un], chaine2=[deux], chaine3=[h\u00e9l\u00e8ne va au\n march\u00e9 acheter des l\u00e9gumes]\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-chaines-de-caracteres.html#42-script-str_02-les-methodes-de-la-classe-str","title":"4.2. Script [str_02]\u00a0: les m\u00e9thodes de la classe &lt;str&gt;","text":"<p>Le script [str_02] pr\u00e9sente quelques-unes des m\u00e9thodes de la classe &lt;str&gt; qui est la classe des cha\u00eenes de caract\u00e8res\u00a0:</p> <pre><code># fonctions sur cha\u00eenes de caract\u00e8res\n# cha\u00eene en minuscules\nprint(f\"'ABCD'.lower()={'ABCD'.lower()}\")\n# cha\u00eene en majuscules\nprint(f\"'abcd'.upper()={'abcd'.upper()}\")\n# caract\u00e8re n\u00b0 2\nprint(f\"'cheval[2]={'cheval'[2]}\")\n# sous-cha\u00eene avec les caract\u00e8res 5 et 6\nprint(f\"'caract\u00e8res accentu\u00e9s'[5:7]={'caract\u00e8res accentu\u00e9s'[5:7]}\")\n# sous-cha\u00eene \u00e0 partir du caract\u00e8re 4 inclus\nprint(f\"'caract\u00e8res accentu\u00e9s'[4:]={'caract\u00e8res accentu\u00e9s'[4:]}\")\n# sous-cha\u00eene jusqu'au caract\u00e8re 6 exclus\nprint(f\"'caract\u00e8res accentu\u00e9s'[:5]={'caract\u00e8res accentu\u00e9s'[:5]}\")\n# longueur de la cha\u00eene\nprint(f\"len('123')={len('123')}\")\n# \u00e9limination des blancs qui pr\u00e9c\u00e8dent et suivent la cha\u00eene\nprint(f\"'  abcd '.strip()=[{'  abcd '.strip()}]\")\n# \u00e9limination des blancs qui suivent la cha\u00eene\nprint(f\"'  abcd '.rstrip()=[{'  abcd '.rstrip()}]\")\n# \u00e9limination des blancs qui pr\u00e9c\u00e8dent la cha\u00eene\nprint(f\"'  abcd '.lstrip()=[{'  abcd '.lstrip()}]\")\n# le terme blanc recouvre en fait diff\u00e9rents caract\u00e8res\nstr = '  \\r\\nabcd \\t\\f'\nprint(f\"str.strip()=[{str.strip()}]\")\n# remplacement d'une sous-cha\u00eene par une autre\nprint(f\"'abcd'.replace('a','x')={'abcd'.replace('a', 'x')}\")\nprint(f\"'abcd'.replace('ab','xy')={'abcd'.replace('ab', 'xy')}\")\n# recherche d'une sous-cha\u00eene : rend la position ou -1 si sous-cha\u00eene pas trouv\u00e9e\nprint(f\"'abcd'.find('bc')={'abcd'.find('bc')}\")\nprint(f\"'abcd'.find('bc')={'abcd'.find('Bc')}\")\n# d\u00e9but d'une cha\u00eene\nprint(f\"'abcd'.startswith('ab')={'abcd'.startswith('ab')}\")\nprint(f\"'abcd'.startswith('x')={'abcd'.startswith('x')}\")\n# fin d'une cha\u00eene\nprint(f\"'abcd'.endswith('cd')={'abcd'.endswith('cd')}\")\nprint(f\"'abcd'.endswith('x')={'abcd'.endswith('x')}\")\n# passage d'une liste de cha\u00eenes \u00e0 une cha\u00eene\nprint(f\"'[X]'.join(['abcd', '123', '\u00e8\u00e9\u00e0'])={'[X]'.join(['abcd', '123', '\u00e8\u00e9\u00e0'])}\")\nprint(f\"''.join(['abcd', '123', '\u00e8\u00e9\u00e0'])={''.join(['abcd', '123', '\u00e8\u00e9\u00e0'])}\")\n# passage d'une cha\u00eene \u00e0 une liste de cha\u00eenes\nprint(f\"'abcd 123 cdXY'.split('cd')={'abcd 123 cdXY'.split('cd')}\")\n# r\u00e9cup\u00e9rer les mots d'une cha\u00eene\nprint(f\"'abcd 123 cdXY'.split(None)={'abcd 123 cdXY'.split(None)}\")\n</code></pre> <p>Les commentaires alli\u00e9s aux r\u00e9sultats obtenus suffisent pour la compr\u00e9hension du script. Les r\u00e9sultats sont les suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/strings/str_02.py\n'ABCD'.lower()=abcd\n'abcd'.upper()=ABCD\n'cheval[2]=e\n'caract\u00e8res accentu\u00e9s'[5:7]=t\u00e8\n'caract\u00e8res accentu\u00e9s'[4:]=ct\u00e8res accentu\u00e9s\n'caract\u00e8res accentu\u00e9s'[:5]=carac\nlen('123')=3\n'  abcd '.strip()=[abcd]\n'  abcd '.rstrip()=[  abcd]\n'  abcd '.lstrip()=[abcd ]\nstr.strip()=[abcd]\n'abcd'.replace('a','x')=xbcd\n'abcd'.replace('ab','xy')=xycd\n'abcd'.find('bc')=1\n'abcd'.find('bc')=-1\n'abcd'.startswith('ab')=True\n'abcd'.startswith('x')=False\n'abcd'.endswith('cd')=True\n'abcd'.endswith('x')=False\n'[X]'.join(['abcd', '123', '\u00e8\u00e9\u00e0'])=abcd[X]123[X]\u00e8\u00e9\u00e0\n''.join(['abcd', '123', '\u00e8\u00e9\u00e0'])=abcd123\u00e8\u00e9\u00e0\n'abcd 123 cdXY'.split('cd')=['ab', ' 123 ', 'XY']\n'abcd 123 cdXY'.split(None)=['abcd', '123', 'cdXY']\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-chaines-de-caracteres.html#43-script-str_03-codage-des-chaines-de-caracteres-1","title":"4.3. Script [str_03]\u00a0: codage des cha\u00eenes de caract\u00e8res (1)","text":"<p>Le script [str_03] pr\u00e9sente des notions sur le codage des cha\u00eenes de caract\u00e8res\u00a0:</p> <pre><code># codage des caract\u00e8res\n\n# cha\u00eene de type str\nstr = \"h\u00e9l\u00e8ne va au march\u00e9 acheter des l\u00e9gumes\"\nprint(f\"str=[{str}, type={type(str)}]\")\n# encodage utf-8\nprint(\"--- utf-8\")\nbytes1 = str.encode('utf-8')\nprint(f\"bytes1={bytes1}, type={type(bytes1)}\")\nbytes2 = bytes(str, 'utf-8')\nprint(f\"bytes2={bytes2}, type={type(bytes2)}\")\n# encodage iso-8859-1\nprint(\"--- iso-8859-1\")\nbytes1 = str.encode('iso-8859-1')\nprint(f\"bytes1={bytes1}, type={type(bytes1)}\")\nbytes2 = bytes(str, 'iso-8859-1')\nprint(f\"bytes2={bytes2}, type={type(bytes2)}\")\n# encodage latin1=iso-8859-1\nprint(\"--- latin1\")\nbytes1 = str.encode('latin1')\nprint(f\"bytes1={bytes1}, type={type(bytes1)}\")\nbytes2 = bytes(str, 'latin1')\nprint(f\"bytes2={bytes2}, type={type(bytes2)}\")\n</code></pre> <p>L'encodage d'une cha\u00eene de caract\u00e8re de type &lt;str&gt; produit une cha\u00eene binaire o\u00f9 chaque caract\u00e8re de la cha\u00eene a \u00e9t\u00e9 repr\u00e9sent\u00e9 par un ou plusieurs octets. Il existe diff\u00e9rents types d'encodage. Le script ci-dessus pr\u00e9sente les deux plus courants en occident \"utf-8\" et \"iso-8859-1\" dit aussi \"latin1.</p> <p>Le principe de l'encodage / d\u00e9codage est illustr\u00e9 ci-dessous (ref. |https://realpython.com/python-encodings-guide/ |)\u00a0:</p> <p></p> <p>Commentaires</p> <ul> <li>lignes 4-5\u00a0: la cha\u00eene de caract\u00e8res initiale qui va \u00eatre encod\u00e9e. Les instances du type &lt;str&gt; sont des cha\u00eenes unicode |https://docs.python.org/3/howto/unicode.html|, |https://realpython.com/python-encodings-guide/ |\u00a0;</li> <li>lignes 6-11\u00a0: deux fa\u00e7ons pour encoder en UTF68 une cha\u00eene de caract\u00e8res\u00a0:</li> <li>ligne 8\u00a0: str.encode('utf-8)\u00a0;</li> <li>ligne 10\u00a0: bytes(str, 'utf-8');</li> <li>lignes 12-17\u00a0: on refait la m\u00eame chose avec l'encodage 'iso-8859-1'\u00a0;</li> <li>lignes 18-23\u00a0: 'latin1' est un autre nom de l'encodage 'iso-8859-1'\u00a0; Les r\u00e9sultats sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/strings/str_03.py\nstr=[h\u00e9l\u00e8ne va au march\u00e9 acheter des l\u00e9gumes, type=&lt;class 'str'&gt;\n--- utf-8\nbytes1=b'h\\xc3\\xa9l\\xc3\\xa8ne va au march\\xc3\\xa9 acheter des l\\xc3\\xa9gumes', type=&lt;class 'bytes'&gt;\nbytes2=b'h\\xc3\\xa9l\\xc3\\xa8ne va au march\\xc3\\xa9 acheter des l\\xc3\\xa9gumes', type=&lt;class 'bytes'&gt;\n--- iso-8859-1\nbytes1=b'h\\xe9l\\xe8ne va au march\\xe9 acheter des l\\xe9gumes', type=&lt;class 'bytes'&gt;\nbytes2=b'h\\xe9l\\xe8ne va au march\\xe9 acheter des l\\xe9gumes', type=&lt;class 'bytes'&gt;\n--- latin1\nbytes1=b'h\\xe9l\\xe8ne va au march\\xe9 acheter des l\\xe9gumes', type=&lt;class 'bytes'&gt;\nbytes2=b'h\\xe9l\\xe8ne va au march\\xe9 acheter des l\\xe9gumes', type=&lt;class 'bytes'&gt;\n\nProcess finished with exit code 0\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 4\u00a0: on voit que les caract\u00e8res accentu\u00e9s ont \u00e9t\u00e9 cod\u00e9s sur deux octets\u00a0:</li> <li>\u00e9\u00a0: [\\xc3\\xa9] qui est la suite binaire 11000011 10101001\u00a0;</li> <li>\u00e8\u00a0: [\\xc3\\xa8] qui est la suite binaire 11000011 10101000\u00a0;</li> <li>lignes 7\u00a0: avec le codage iso-8859-1, ces deux caract\u00e8res accentu\u00e9s sont cod\u00e9s diff\u00e9remment\u00a0:</li> <li>\u00e9\u00a0: [\\xe9] qui est la suite binaire 11101001\u00a0;</li> <li>\u00e8\u00a0: [\\xe8] qui est la suite binaire 11101000\u00a0;</li> </ul>"},{"location":"les-chaines-de-caracteres.html#44-script-str_04-encodage-des-chaines-de-caracteres-2","title":"4.4. Script [str_04]\u00a0: encodage des cha\u00eenes de caract\u00e8res (2)","text":"<p>Le script [str_04] pr\u00e9sente deux autres types d'encodage\u00a0: 'base64' et 'quoted-printable'. Ces deux encodages n'encodent pas des cha\u00eenes de caract\u00e8res Unicode mais des objets binaires. Par exemple, lorsqu'on attache un document Word \u00e0 un mail, celui-ci va subir l'un des deux encodages selon le gestionnaire de courrier utilis\u00e9. Ce sera le cas pour la plupart des fichiers attach\u00e9s.</p> <p>Le script est le suivant\u00a0:</p> <pre><code># encodage / d\u00e9codage\nimport codecs\n\n# cha\u00eene\nprint(\"---- cha\u00eene unicode\")\nstr1 = \"h\u00e9l\u00e8ne va au march\u00e9 acheter des l\u00e9gumes\"\nprint(f\"str1=[{str1}], type(str1)={type(str1)}\")\n\n# encodage utf-8\nprint(\"---- cha\u00eene unicode -&gt; binaire utf-8\")\nbytes1 = bytes(str1, \"utf-8\")\nprint(f\"bytes1=[{bytes1}], type(bytes1)={type(bytes1)}\")\n\n# d\u00e9codage utf-8\nprint(\"---- binaire utf-8 -&gt; cha\u00eene unicode\")\nstr2 = bytes1.decode(\"utf-8\")\nprint(f\"str2=[{str2}], type(str2)={type(str2)}\")\nprint(f\"str2==str1={str2 == str1}\")\n\n# encodage iso-8859-1\nprint(\"---- cha\u00eene unicode -&gt; binaire iso-8859-1\")\nbytes2 = bytes(str1, \"iso-8859-1\")\nprint(f\"bytes2=[{bytes2}], type(bytes2)={type(bytes2)}\")\n\n# d\u00e9codage iso-8859-1\nprint(\"---- binaire iso-8859-1 -&gt; cha\u00eene unicode\")\nstr3 = bytes2.decode(\"iso-8859-1\")\nprint(f\"str3=[{str3}], type(str3)={type(str3)}\")\nprint(f\"str3==str1={str3 == str1}\")\n\n# erreur de d\u00e9codage - bytes1 est en utf-8 - on le d\u00e9code en iso-8859-1\nprint(\"--- binaire utf-8 (d\u00e9codage iso-8859-1) --&gt; cha\u00eene unicode\")\nstr4 = bytes1.decode(\"iso-8859-1\")\nprint(f\"str4=[{str4}], type(str4)={type(str4)}\")\n\n# encodage utf-8 d\u2019une cha\u00eene Unicode\nprint(\"---- cha\u00eene unicode -&gt; binaire utf-8\")\nbytes3 = codecs.encode(str1, \"utf-8\")\nprint(f\"bytes3=[{bytes3}], type(bytes3)={type(bytes3)}\")\n\n# encodage d'une cha\u00eene binaire UTF-8 en base64\nprint(\"---- binaire utf-8 -&gt; binaire base64\")\nbytes4 = codecs.encode(bytes1, \"base64\")\nprint(f\"bytes4=[{bytes4}], type(bytes4)={type(bytes4)}\")\n\n# retour \u00e0 la cha\u00eene unicode d'origine\nprint(\"---- binaire base64 -&gt; binaire utf-8 -&gt; cha\u00eene unicode\")\nstr6 = codecs.decode(bytes4, \"base64\").decode(\"utf-8\")\nprint(f\"str6=[{str6}], type(str6)={type(str6)}\")\n\n# encodage d'une cha\u00eene binaire en quoted-printable\nprint(\"---- binaire utf-8 -&gt; binaire quoted-printable\")\nstr7 = codecs.encode(bytes1, \"quoted-printable\")\nprint(f\"str7=[{str7}], type(str7)={type(str7)}\")\n\n# retour \u00e0 la cha\u00eene unicode d'origine\nprint(\"---- binaire quoted-printable -&gt; binaire utf-8 -&gt; cha\u00eene unicode\")\nstr8 = codecs.decode(str7, \"quoted-printable\").decode(\"utf-8\")\nprint(f\"str8=[{str8}], type(str8)={type(str8)}\")\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 2\u00a0: le module [codecs] permet de faire les codages 'base64' et 'quoted-printable'. Il peut en faire beuacoup d'autres\u00a0;</li> <li>lignes 4-7\u00a0: la cha\u00eene Unicode qui va subir divers encodages\u00a0;</li> <li>lignes 9-12\u00a0: encodage utf-8. on obtient un binaire\u00a0;</li> <li>lignes 14-18\u00a0: d\u00e9codage utf-8 pour revenir \u00e0 la cha\u00eene Unicode d'origine\u00a0;</li> <li>lignes 20-29\u00a0: on r\u00e9p\u00e8te le m\u00eame processus avec l'encodage 'iso-8859-1'\u00a0;</li> <li>lignes 31-34\u00a0: on montre une erreur de d\u00e9codage\u00a0:</li> <li>ligne 33\u00a0: bytes1 est une cha\u00eene binaire encod\u00e9e en 'utf-8'. On la d\u00e9code en 'iso-8859-1'\u00a0;</li> <li>lignes 36-39\u00a0: autre fa\u00e7on d'encoder une cha\u00eene de caract\u00e8res en utf-8 avec le module [codecs]\u00a0;</li> <li>lignes 41-44\u00a0: une cha\u00eene binaire 'utf-8' est encod\u00e9e en 'base64'\u00a0;</li> <li>lignes 46-49\u00a0: montrent comment passer de la cha\u00eene binaire 'base64' \u00e0 la cha\u00eene unicode d'origine\u00a0;</li> <li>lignes 51-59\u00a0: on r\u00e9p\u00e8te ce processus avec un encodage 'quoted-printable' au lieu de 'base64'\u00a0; Les r\u00e9sultats sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/strings/str_04.py\n---- cha\u00eene unicode\nstr1=[h\u00e9l\u00e8ne va au march\u00e9 acheter des l\u00e9gumes], type(str1)=&lt;class 'str'&gt;\n---- cha\u00eene unicode -&gt; binaire utf-8\nbytes1=[b'h\\xc3\\xa9l\\xc3\\xa8ne va au march\\xc3\\xa9 acheter des l\\xc3\\xa9gumes'], type(bytes1)=&lt;class 'bytes'&gt;\n---- binaire utf-8 -&gt; cha\u00eene unicode\nstr2=[h\u00e9l\u00e8ne va au march\u00e9 acheter des l\u00e9gumes], type(str2)=&lt;class 'str'&gt;\nstr2==str1=True\n---- cha\u00eene unicode -&gt; binaire iso-8859-1\nbytes2=[b'h\\xe9l\\xe8ne va au march\\xe9 acheter des l\\xe9gumes'], type(bytes2)=&lt;class 'bytes'&gt;\n---- binaire iso-8859-1 -&gt; cha\u00eene unicode\nstr3=[h\u00e9l\u00e8ne va au march\u00e9 acheter des l\u00e9gumes], type(str3)=&lt;class 'str'&gt;\nstr3==str1=True\n--- binaire utf-8 (d\u00e9codage iso-8859-1) --&gt; cha\u00eene unicode\nstr4=[h\u00c3\u00a9l\u00c3\u00a8ne va au march\u00c3\u00a9 acheter des l\u00c3\u00a9gumes], type(str4)=&lt;class 'str'&gt;\n---- cha\u00eene unicode -&gt; binaire utf-8\nbytes3=[b'h\\xc3\\xa9l\\xc3\\xa8ne va au march\\xc3\\xa9 acheter des l\\xc3\\xa9gumes'], type(bytes3)=&lt;class 'bytes'&gt;\n---- binaire utf-8 -&gt; binaire base64\nbytes4=[b'aMOpbMOobmUgdmEgYXUgbWFyY2jDqSBhY2hldGVyIGRlcyBsw6lndW1lcw==\\n'], type(bytes4)=&lt;class 'bytes'&gt;\n---- binaire base64 -&gt; binaire utf-8 -&gt; cha\u00eene unicode\nstr6=[h\u00e9l\u00e8ne va au march\u00e9 acheter des l\u00e9gumes], type(str6)=&lt;class 'str'&gt;\n---- binaire utf-8 -&gt; binaire quoted-printable\nstr7=[b'h=C3=A9l=C3=A8ne=20va=20au=20march=C3=A9=20acheter=20des=20l=C3=A9gumes'], type(str7)=&lt;class 'bytes'&gt;\n---- binaire quoted-printable -&gt; binaire utf-8 -&gt; cha\u00eene unicode\nstr8=[h\u00e9l\u00e8ne va au march\u00e9 acheter des l\u00e9gumes], type(str8)=&lt;class 'str'&gt;\n\nProcess finished with exit code 0\n</code></pre> <ul> <li>lignes 14-15\u00a0: un binaire utf-8 est d\u00e9cod\u00e9 en cha\u00eene Unicode avec le mauvais d\u00e9codeur 'iso-8859-1'. Aussi certains caract\u00e8res Unicode g\u00e9n\u00e9r\u00e9s sont incorrects, ici les caract\u00e8res accentu\u00e9s\u00a0;</li> <li>lignes 18-19\u00a0: le codage 'base64' consiste \u00e0 utiliser 64 caract\u00e8res ASCII (cod\u00e9s sur 7 bits) pour encoder un binaire quleconque. Cela augmente, comme on le voit, la taille du binaire de la cha\u00eene\u00a0;</li> <li>lignes 22-23\u00a0: le codage 'quoted-printable' consiste lui aussi \u00e0 utiliser des caract\u00e8res ASCII (cod\u00e9s sur 7 bits) pour encoder un binaire quelconque\u00a0; On se souviendra que lorsqu'on re\u00e7oit un binaire, du r\u00e9seau internet par exemple, qui repr\u00e9sente un texte, pour retrouver celui-ci il faut conna\u00eetre les encodages qu'il a subis.</li> </ul>"},{"location":"les-classes-et-objets.html","title":"12. Les classes et objets","text":"<p>La classe est le moule \u00e0 partir duquel sont fabriqu\u00e9s des objets. On dit de l'objet que c'est l'instance d'une classe.</p> <p></p> <p>Note\u00a0: le dossier [shared] a \u00e9t\u00e9 plac\u00e9 dans les [Sources Root] du projet.</p>"},{"location":"les-classes-et-objets.html#121-script-classes_01-une-classe-objet","title":"12.1. script [classes_01]\u00a0: une classe Objet","text":"<p>Le script [classes_01] montre une utilisation obsol\u00e8te des classes\u00a0:</p> <pre><code># une classe\nclass Objet(object):\n    \"\"\"une classe Objet vide\"\"\"\n\n\n# toute variable de type [Objet] peut avoir des attributs par construction\nobj1 = Objet()\nobj1.attr1 = \"un\"\nobj1.attr2 = 100\n# affiche l'objet\nprint(f\"objet1=[{obj1}, {type(obj1)},{id(obj1)},{obj1.attr1},{obj1.attr2}]\")\n# modifie l'objet\nobj1.attr2 += 100\n# affiche l'objet\nprint(f\"objet1=[{obj1.attr1},{obj1.attr2}]\")\n# affecte la r\u00e9f\u00e9rence obj1 \u00e0 obj2\nobj2 = obj1\n# modifie l'objet point\u00e9 par obj2\nobj2.attr2 = 0\n# affiche les deux objets - obj1 pointe maintenant sur un objet modifi\u00e9\nprint(f\"objet1=[{obj1.attr1},{obj1.attr2}]\")\nprint(f\"objet2=[{obj2.attr1},{obj2.attr2}]\")\n# obj1 et obj2 pointent sur le m\u00eame objet\nprint(f\"objet1=[{obj1}, {id(obj1)},{obj1.attr1},{obj1.attr2}]\")\nprint(f\"objet2=[{obj2}, {id(obj2)},{obj2.attr1},{obj2.attr2}]\")\nprint(obj1 == obj2)\n# type de l'instance obj1\nprint(f\"type(obj1)={type(obj1)}\")\nprint(f\"isinstance(obj1,Objet)={isinstance(obj1, Objet)}, isinstance(obj1,object)={isinstance(obj1, object)}\")\n# tout type est un objet en Python\nprint(f\"type(4)={type(4)}\")\nprint(f\"isinstance(4, int)={isinstance(4, int)}, isinstance(4, object)={isinstance(4, object)}\")\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>lignes 2-3\u00a0: une classe [Objet] vide\u00a0;</li> <li>ligne 2\u00a0: la classe peut \u00eatre d\u00e9clar\u00e9e sous trois formes\u00a0:</li> <li>class Objet\u00a0;</li> <li>class Objet()\u00a0;</li> <li>class Objet(object)\u00a0;</li> <li>ligne 3\u00a0: une autre forme de commentaire. Celui-ci pr\u00e9c\u00e9d\u00e9 de trois \" peut s'\u00e9taler sur plusieurs lignes\u00a0;</li> <li>ligne 7\u00a0: instanciation de la classe Objet. Le r\u00e9sultat est une adresse comme le montreront les lignes 24-26\u00a0;</li> <li>lignes 8-9\u00a0: initialisation directe de deux attributs de l'objet\u00a0;</li> <li>ligne 17\u00a0: copie de r\u00e9f\u00e9rences. Les variables obj1 et obj2 sont deux pointeurs (r\u00e9f\u00e9rences) sur un m\u00eame objet\u00a0;</li> <li>ligne 19\u00a0: on modifie l'objet point\u00e9 par [obj2]. Comme [obj1] et [obj2] pointent sur le m\u00eame objet, les affichages des objets [obj1, obj2] des lignes 21 et 22 vont montrer que l'objet point\u00e9 par [obj1] a chang\u00e9\u00a0;</li> <li>lignes 24-26\u00a0: ces lignes visent \u00e0 montrer l'\u00e9galit\u00e9 des variables [obj1] et [obj2]. L'affichage de la ligne 26 va le montrer. Dans cette comparaison, ce sont les adresses [obj1] et [obj2] qui sont \u00e9gales\u00a0;</li> <li>chaque objet Python est identifi\u00e9 par un n\u00b0 unique qu'on obtient avec l'expression [id(objet)]. Les lignes 24 et 25 vont montrer que les n\u00b0s des objets point\u00e9s par [obj1] et [obj2] sont identiques, montrant par l\u00e0 que ces deux r\u00e9f\u00e9rences pointent sur le m\u00eame objet\u00a0;</li> <li>lignes 27-29\u00a0: la fonction [isinstance(expr,Type)] rend le bool\u00e9en True si l'expression [expr] est de type [Type]. Ici, on va voir que [obj1] est de type [Objet], ce qui semble naturel, mais \u00e9galement de type [object]. La classe [object] est la classe parent de toutes les classes Python. Par propri\u00e9t\u00e9 de l'h\u00e9ritage de classes, une classe fille F a toutes les propri\u00e9t\u00e9s de sa classe parent P et la fonction [isinstance(instance de F, P)] rend True\u00a0;</li> <li>lignes 30-32\u00a0: montrent que type [int] est lui aussi un type [object]. Tous les types de Python d\u00e9rivent de la classe [object]\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/01/classes_01.py\nobjet1=[&lt;__main__.Objet object at 0x0000025C3F469BB0&gt;, &lt;class '__main__.Objet'&gt;,2595221838768,un,100]\nobjet1=[un,200]\nobjet1=[un,0]\nobjet2=[un,0]\nobjet1=[&lt;__main__.Objet object at 0x0000025C3F469BB0&gt;, 2595221838768,un,0]\nobjet2=[&lt;__main__.Objet object at 0x0000025C3F469BB0&gt;, 2595221838768,un,0]\nTrue\ntype(obj1)=&lt;class '__main__.Objet'&gt;\nisinstance(obj1,Objet)=True, isinstance(obj1,object)=True\ntype(4)=&lt;class 'int'&gt;\nisinstance(4, int)=True, isinstance(4, object)=True\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-classes-et-objets.html#122-script-classes_02-une-classe-personne","title":"12.2. Script [classes_02]\u00a0: une classe Personne","text":"<p>Le script [classes_02] montre que les attributs d'une classe sont publics\u00a0: ils sont accessibles directement de l'ext\u00e9rieur de la classe. On a l\u00e0 encore une utilisation des classes d\u00e9conseill\u00e9e. On la donne n\u00e9anmoins parce qu'on peut parfois trouver ce type de code (Python l'accepte) et il faut alors \u00eatre capable de le comprendre.</p> <pre><code># classe Personne\nclass Personne:\n    # attributs de la classe\n    # non d\u00e9clar\u00e9s - peuvent \u00eatre cr\u00e9\u00e9s dynamiquement\n\n    # m\u00e9thode\n    def identit\u00e9(self: object) -&gt; str:\n        # a priori, utilise des attributs inexistants\n        return f\"[{self.pr\u00e9nom},{self.nom},{self.\u00e2ge}]\"\n\n\n# ---------------------------------- main\n# les attributs sont publics et peuvent \u00eatre cr\u00e9\u00e9s dynamiquement\n# instanciation classe\np = Personne()\n# initialisation directe d'attributs de la classe\np.pr\u00e9nom = \"Paul\"\np.nom = \"de la H\u00fbche\"\np.\u00e2ge = 48\n# appel d'une m\u00e9thode de la classe\nprint(f\"personne={p.identit\u00e9()}\")\n# type de l'instance p\nprint(f\"type(p)={type(p)}\")\nprint(f\"isinstance(Personne)={isinstance(p, Personne)}, isinstance(object)={isinstance(p, object)}\")\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>lignes 2-9\u00a0: une classe avec une m\u00e9thode\u00a0;</li> <li>ligne 7\u00a0: toute m\u00e9thode d'une classe doit avoir pour premier param\u00e8tre, l'objet self qui d\u00e9signe l'objet courant. La m\u00e9thode [identit\u00e9] rend une cha\u00eene de caract\u00e8res\u00a0;</li> <li>ligne 15\u00a0: instanciation d'un objet [Personne]\u00a0;</li> <li>lignes 16-19\u00a0: montrent que les attributs de l'objet peuvent \u00eatre cr\u00e9\u00e9s dynamiquement (ils n'existent pas dans la d\u00e9finition de la classe)\u00a0;</li> <li>ligne 9\u00a0: les attributs de la classe sont d\u00e9sign\u00e9s par la notation [self.attribut]\u00a0;</li> <li>les lignes 23-24 vont montrer que l'objet [p] est \u00e0 la fois une instance de la classe [Personne] et de la classe [object]\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/01/classes_02.py\npersonne=[Paul,de la H\u00fbche,48]\ntype(p)=&lt;class '__main__.Personne'&gt;\nisinstance(Personne)=True, isinstance(object)=True\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-classes-et-objets.html#123-script-classes_03-la-classe-personne-avec-un-constructeur","title":"12.3. Script [classes_03]\u00a0: la classe Personne avec un constructeur","text":"<p>Le script [classes_03] montre l'utilisation normale d'une classe\u00a0:</p> <pre><code># classe Personne\nclass Personne:\n    # constructeur - initialise trois attributs\n    def __init__(self: object, pr\u00e9nom: str, nom: str, \u00e2ge: int):\n        # pr\u00e9nom : pr\u00e9nom de la personne\n        # nom : nom de la personne\n        # \u00e2ge : \u00e2ge de la personne\n\n        self.pr\u00e9nom = pr\u00e9nom\n        self.nom = nom\n        self.\u00e2ge = \u00e2ge\n\n    # rend les attributs de la classe sous la forme d'une cha\u00eene de caract\u00e8res\n    def identit\u00e9(self: object) -&gt; str:\n        return f\"[{self.pr\u00e9nom},{self.nom},{self.\u00e2ge}]\"\n\n\n# ---------------------------------- main\n# un objet Personne\np = Personne(\"Paul\", \"de la H\u00fbche\", 48)\n# appel d'une m\u00e9thode\nprint(f\"personne={p.identit\u00e9()}\")\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>ligne 4\u00a0: le constructeur d'une classe s'appelle init. Comme pour les autres m\u00e9thodes, son premier param\u00e8tre est self\u00a0;</li> <li>ligne 20\u00a0: un objet Personne est construit avec le constructeur de la classe\u00a0;</li> <li>lignes 13-15\u00a0: la m\u00e9thode [identit\u00e9] rend une cha\u00eene de caract\u00e8res repr\u00e9sentant le contenu de l'objet\u00a0;</li> <li>ligne 22\u00a0: affichage de l'identit\u00e9 de la personne\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/01/classes_03.py\npersonne=[Paul,de la H\u00fbche,48]\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-classes-et-objets.html#124-script-classes_04-methode-statiques","title":"12.4. Script [classes_04]\u00a0: m\u00e9thode statiques","text":"<p>Nous d\u00e9finissons dans le dossier [modules], la classe [Utils] suivante (utils.py)\u00a0:</p> <p></p> <pre><code>class Utils:\n    # m\u00e9thode statique\n    @staticmethod\n    def is_string_ok(string: str) -&gt; bool:\n        # string est-elle une cha\u00eene\n        erreur = not isinstance(string, str)\n        if not erreur:\n            # la cha\u00eene est-elle vide ?\n            erreur = string.strip() == ''\n        # r\u00e9sultat\n        return not erreur\n</code></pre> <p>Notes</p> <ul> <li>ligne 3\u00a0: l'annotation [@staticmethod] indique que la m\u00e9thode ainsi annot\u00e9e est une m\u00e9thode de classe et non une m\u00e9thode d'instance. Cela se voit au fait que le premier param\u00e8tre de la m\u00e9thode ainsi annot\u00e9e n'est pas le mot cl\u00e9 [self]. Ainsi la m\u00e9thode statique n'a pas acc\u00e8s aux attributs de l'objet. Au lieu d'\u00e9crire\u00a0: <pre><code>u=Utils()\nprint(u.is_string_ok(\"abcd\")\n</code></pre></li> </ul> <p>on \u00e9crit</p> <pre><code>print(Utils.is_string_ok(\"abcd\")\n</code></pre> <p>Parce que ci-dessus on a \u00e9crit [Utils.is_string_ok], la m\u00e9thode [is_string_ok] est dite une m\u00e9thode de classe (la classe Utils ici). Pour cela, la m\u00e9thode [Utils.is_string_ok] doit \u00eatre annot\u00e9e avec le mot cl\u00e9 [@staticmethod].</p> <p>La m\u00e9thode statique [Utils.is_string_ok] permet ici de v\u00e9rifier qu'une donn\u00e9e est une cha\u00eene de caract\u00e8res non vide.</p> <p>Le script [classes_04] utilise la classe [Utils] de la fa\u00e7on suivante\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom utilitaires import Utils\n\nprint(Utils.is_string_ok(\"  \"))\nprint(Utils.is_string_ok(47))\nprint(Utils.is_string_ok(\" q \"))\n</code></pre> <ul> <li>lignes 1-4\u00a0: on utilise un script de configuration\u00a0; Le script de configuration [config.py] est le suivant\u00a0:</li> </ul> <pre><code>def configure():\n    import os\n\n    # dossier du fichier de configuration\n    script_dir = os.path.dirname(os.path.abspath(__file__))\n\n    # chemins absolus des dossiers \u00e0 mettre dans le syspath\n    absolute_dependencies = [\n        f\"{script_dir}/shared\",\n        \"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/venv/lib/site-packages\",\n        \"C:/myprograms/Python38/lib\",\n        \"C:/myprograms/Python38/DLLs\"\n    ]\n\n    # mise \u00e0 jour du syspath\n    from myutils import set_syspath\n    set_syspath(absolute_dependencies)\n\n    # on retourne la config\n    return {}\n</code></pre> <ul> <li>ligne 9\u00a0: le dossier [shared] va \u00eatre plac\u00e9 dans le Python Path\u00a0; Le r\u00e9sultat de l'ex\u00e9cution est le suivant\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/01/classes_04.py\nFalse\nFalse\nTrue\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-classes-et-objets.html#125-script-classes_05-controles-de-validite-des-attributs","title":"12.5. Script [classes_05]\u00a0: contr\u00f4les de validit\u00e9 des attributs","text":"<p>Le script [classes_05] introduit de nouvelles notions\u00a0:</p> <ul> <li>d\u00e9finition d'un type d'exception propri\u00e9taire\u00a0;</li> <li>d\u00e9finition de la m\u00e9thode [str] qui est la m\u00e9thode d'identit\u00e9 par d\u00e9faut des classes\u00a0;</li> <li>d\u00e9finition de propri\u00e9t\u00e9s\u00a0; <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom utilitaires import Utils\n\n\n# une classe d'exception propri\u00e9taire d\u00e9rivant de [BaseException]\nclass MyException(BaseException):\n    # on ne fait rien : classe vide\n    pass\n\n\n# classe Personne\nclass Personne:\n    # constructeur\n    def __init__(self: object, pr\u00e9nom: str = \"x\", nom: str = \"y\", \u00e2ge: int = 0):\n        # pr\u00e9nom : pr\u00e9nom de la personne\n        # nom : nom de la personne\n        # \u00e2ge : \u00e2ge de la personne\n\n        # m\u00e9morisation des param\u00e8tres\n        # les initialisations seront faites via les setters\n        self.pr\u00e9nom = pr\u00e9nom\n        self.nom = nom\n        self.\u00e2ge = \u00e2ge\n\n    # m\u00e9thode toString de la classe\n    def __str__(self: object) -&gt; str:\n        return f\"[{self.__pr\u00e9nom},{self.__nom},{self.__\u00e2ge}]\"\n\n    # getters\n    @property\n    def pr\u00e9nom(self) -&gt; str:\n        return self.__pr\u00e9nom\n\n    @property\n    def nom(self) -&gt; str:\n        return self.__nom\n\n    @property\n    def \u00e2ge(self) -&gt; int:\n        return self.__\u00e2ge\n\n    # setters\n    @pr\u00e9nom.setter\n    def pr\u00e9nom(self, pr\u00e9nom: str):\n        # le pr\u00e9nom doit \u00eatre non vide\n        if Utils.is_string_ok(pr\u00e9nom):\n            self.__pr\u00e9nom = pr\u00e9nom.strip()\n        else:\n            raise MyException(\"Le pr\u00e9nom doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\n\n    @nom.setter\n    def nom(self, nom: str):\n        # le pr\u00e9nom doit \u00eatre non vide\n        if Utils.is_string_ok(nom):\n            self.__nom = nom.strip()\n        else:\n            raise MyException(\"Le nom doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\n\n    @\u00e2ge.setter\n    def \u00e2ge(self, \u00e2ge: int):\n        # l'\u00e2ge doit \u00eatre un entier &gt;=0\n        erreur = False\n        if isinstance(\u00e2ge, int):\n            if \u00e2ge &gt;= 0:\n                self.__\u00e2ge = \u00e2ge\n            else:\n                erreur = True\n        else:\n            erreur = True\n        # erreur ?\n        if erreur:\n            raise MyException(\"L'\u00e2ge doit \u00eatre un entier &gt;=0\")\n\n\n# ---------------------------------- main\n# un objet Personne\ntry:\n    # instanciation classe Personne\n    p = Personne(\"Paul\", \"de la H\u00fbche\", 48)\n    # affichage objet p\n    print(f\"personne={p}\")\nexcept MyException as erreur:\n    # affichage erreur\n    print(erreur)\n\n# un autre objet Personne\ntry:\n    # instanciation classe Personne\n    p = Personne(\"xx\", \"yy\", \"zz\")\n    # affichage objet p\n    print(f\"personne={p}\")\nexcept MyException as erreur:\n    # affichage erreur\n    print(erreur)\n\n# une autre personne sans param\u00e8tres cette fois\ntry:\n    # instanciation classe Personne\n    p = Personne()\n    # affichage objet p\n    print(f\"personne={p}\")\nexcept MyException as erreur:\n    # affichage msg d'erreur\n    print(erreur)\n\n# on ne peut pas acc\u00e9der aux attributs priv\u00e9s __attr de la classe\np.__pr\u00e9nom = \"Ga\u00eblle\"\nprint(f\"p.pr\u00e9nom={p.pr\u00e9nom}\")\nprint(f\"p.__pr\u00e9nom={p.__pr\u00e9nom}\")\np.pr\u00e9nom = \"S\u00e9bastien\"\nprint(f\"p.pr\u00e9nom={p.pr\u00e9nom}\")\nprint(f\"p.__pr\u00e9nom={p.__pr\u00e9nom}\")\n</code></pre></li> </ul> <p>Notes\u00a0:</p> <ul> <li>lignes 10-13\u00a0: une classe MyException d\u00e9riv\u00e9e de la classe BaseException (nous verrons ce point un peu plus loin). Elle n'ajoute aucune fonctionnalit\u00e9 \u00e0 cette derni\u00e8re. Elle n'est l\u00e0 que pour avoir une exception propri\u00e9taire\u00a0;</li> <li>ligne 19\u00a0: le constructeur a des valeurs par d\u00e9faut pour ses param\u00e8tres. Ainsi l'op\u00e9ration p=Personne() est \u00e9quivalente \u00e0 p=Personne(\"x\",\"y\",0)\u00a0;</li> <li>lignes 34-45\u00a0: les propri\u00e9t\u00e9s de la classe. Ce sont des m\u00e9thodes annot\u00e9es avec le mot cl\u00e9 [@property]. Elles sont utilis\u00e9es pour rendre la valeur des attributs\u00a0;</li> <li>lignes 47-77\u00a0: les setters de la classe. Ce sont des m\u00e9thodes annot\u00e9es avec le mot cl\u00e9 [@attributsetter]. Elles sont utilis\u00e9es pour fixer la valeur des attributs\u00a0;</li> <li>lignes 48-54\u00a0: le setter de l'attribut [pr\u00e9nom]. Cette m\u00e9thode sera appel\u00e9e chaque fois qu'on affectera une valeur \u00e0 l'attribut [pr\u00e9nom]\u00a0: <pre><code>p=Personne(\u2026)\np.pr\u00e9nom=valeur\n</code></pre></li> </ul> <p>La ligne 2 provoquera l'appel [p.pr\u00e9nom(valeur)]. L'int\u00e9r\u00eat de passer par un setter pour affecter une valeur \u00e0 un attribut est que le setter \u00e9tant une fonction, on peut v\u00e9rifier la validit\u00e9 de la valeur affect\u00e9e \u00e0 l'attribut\u00a0;</p> <ul> <li>ligne 51\u00a0: on v\u00e9rifie que la valeur affect\u00e9e \u00e0 l'attribut [pr\u00e9nom] est une cha\u00eene de caract\u00e8res non vide. On utilise pour cela la m\u00e9thode statique [Utils.isStringOk] vue pr\u00e9c\u00e9demment\u00a0;</li> <li>ligne 52\u00a0: la valeur affect\u00e9e \u00e0 l'attribut [pr\u00e9nom] est d\u00e9barrass\u00e9e de ces \"blancs\" de d\u00e9but / fin de cha\u00eene et affect\u00e9e \u00e0 l'attribut [self.__pr\u00e9nom]. Ce n'est donc pas l'attribut [pr\u00e9nom] qui est utilis\u00e9 ici. On ne pouvait pas sinon on aurait eu un appel r\u00e9cursif infini. On pouvait utiliser n'importe quel nom d'attribut. Le fait d'avoir utilis\u00e9 l'attribut [__pr\u00e9nom] avec deux underscores en d\u00e9but de l'identificateur a une signification sp\u00e9ciale\u00a0: les attributs pr\u00e9c\u00e9d\u00e9s de deux underscores sont priv\u00e9s \u00e0 la classe. Cela signifie qu'ils ne sont pas visibles de l'ext\u00e9rieur de celle-ci. On ne peut donc \u00e9crire\u00a0: <pre><code>p=Personne(\u2026)\np.__pr\u00e9nom=valeur\n</code></pre></li> </ul> <p>En fait on verra bient\u00f4t qu'on peut l'\u00e9crire mais que \u00e7a ne modifie pas le pr\u00e9nom. \u00c7a fait autre chose\u00a0;</p> <ul> <li>lignes 53-54\u00a0: si la valeur affect\u00e9e au pr\u00e9nom n'est pas correct, on lance une exception. Ainsi le code appelant saura que son appel est incorrect\u00a0;</li> <li>lignes 35-37\u00a0: la propri\u00e9t\u00e9 [pr\u00e9nom]. Elle sera appel\u00e9e \u00e0 chaque fois qu'on \u00e9crira [p.pr\u00e9nom] dans une expression. C'est alors la m\u00e9thode [p.pr\u00e9nom()] qui sera appel\u00e9e. Ligne 37, on rend la valeur de l'attribut [__pr\u00e9nom] puisqu'on a vu que le setter de l'attribut [pr\u00e9nom] affectait sa valeur \u00e0 l'attribut priv\u00e9 [__pr\u00e9nom]\u00a0;</li> <li>lignes 56-62\u00a0: le setter de l'attribut [nom] est construit de fa\u00e7on analogue \u00e0 celui de l'attribut [pr\u00e9nom]. Il en est de m\u00eame pour celui de l'attribut [\u00e2ge] aux lignes 64-77\u00a0;</li> <li>bien que les propri\u00e9t\u00e9s [pr\u00e9nom, nom, valeur] ne soient pas les v\u00e9ritables attributs qui sont en r\u00e9alit\u00e9 [__pr\u00e9nom, __nom, __\u00e2ge], on continuera \u00e0 les appeler les attributs de la classe, car elles s'utilisent comme tels\u00a0;</li> <li>lignes 19-28\u00a0: le constructeur de la classe utilise de fa\u00e7on implicite les setters des attributs [pr\u00e9nom, nom, \u00e2ge]. En effet, en \u00e9crivant, ligne 26, [self.pr\u00e9nom = pr\u00e9nom], c'est implicitement la m\u00e9thode [pr\u00e9nom(self, pr\u00e9nom)] qui va \u00eatre appel\u00e9e. La validit\u00e9 du param\u00e8tre [pr\u00e9nom] va alors \u00eatre v\u00e9rifi\u00e9e. Il va en \u00eatre de m\u00eame pour les deux autres attributs [nom, \u00e2ge]\u00a0;</li> <li>avec ce mod\u00e8le, on ne peut attribuer de valeurs incorrectes aux attributs [pr\u00e9nom, nom, \u00e2ge] de la classe\u00a0;</li> <li>lignes 30-32\u00a0: la fonction str remplace la m\u00e9thode qui s'appelait identit\u00e9 pr\u00e9c\u00e9demment. Le nom [str] (2 underscores devant et derri\u00e8re) n'est pas anodin. On va le voir par la suite\u00a0;</li> <li>lignes 83-86\u00a0: instanciation d'une personne puis affichage de son identit\u00e9\u00a0;</li> <li>ligne 84\u00a0: instanciation\u00a0;</li> <li>ligne 86\u00a0: affichage. L'op\u00e9ration demande d'afficher la personne p sous la forme d'une cha\u00eene de caract\u00e8res. L'interpr\u00e9teur Python appelle alors automatiquement la m\u00e9thode p.str() si elle existe. Cette m\u00e9thode joue le m\u00eame r\u00f4le que la m\u00e9thode toString() en Java ou dans les langages .NET\u00a0;</li> <li>lignes 87-89\u00a0: gestion d'une \u00e9ventuelle exception de type MyException. Affiche alors l'erreur\u00a0;</li> <li>lignes 91-99\u00a0: idem pour une deuxi\u00e8me personne instanci\u00e9e avec des param\u00e8tres erron\u00e9s\u00a0;</li> <li>lignes 102-109\u00a0: idem pour une troisi\u00e8me personne instanci\u00e9e avec les param\u00e8tres par d\u00e9faut\u00a0: on ne passe aucun param\u00e8tre. Ce sont alors les valeurs par d\u00e9faut de ces param\u00e8tres dans le constructeur qui sont ici utilis\u00e9es\u00a0;</li> <li>lignes 112-117\u00a0: on a dit que l'attribut [__pr\u00e9nom] \u00e9tait priv\u00e9 donc normalement non accessible de l'ext\u00e9rieur de la classe. On veut le v\u00e9rifier\u00a0;</li> <li>lignes 112-114\u00a0: on affecte une valeur \u00e0 l'attribut [__pr\u00e9nom] puis on v\u00e9rifie la valeur des attributs [__pr\u00e9nom] et [pr\u00e9nom] qui normalement sont les m\u00eames\u00a0;</li> <li>lignes 115-117\u00a0: on recommence l'op\u00e9ration en initialisant cette fois l'attribut [pr\u00e9nom]\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/01/classes_05.py\npersonne=[Paul,de la H\u00fbche,48]\nL'\u00e2ge doit \u00eatre un entier &gt;=0\npersonne=[x,y,0]\np.pr\u00e9nom=x\np.__pr\u00e9nom=Ga\u00eblle\np.pr\u00e9nom=S\u00e9bastien\np.__pr\u00e9nom=Ga\u00eblle\n\nProcess finished with exit code 0\n</code></pre> <p>Notes</p> <ul> <li>lignes 5-6\u00a0: on voit que l'affectation [p.__pr\u00e9nom = \"Ga\u00eblle\"] n'a pas chang\u00e9 la valeur de l'attribut [pr\u00e9nom], ligne 5\u00a0;</li> <li>lignes 7-8\u00a0: on voit que l'affectation [p.pr\u00e9nom = \"S\u00e9bastien\"] n'a pas chang\u00e9 la valeur de l'attribut [__pr\u00e9nom], ligne 8\u00a0; Que faut-il en d\u00e9duire\u00a0? Que probablement, l'op\u00e9ration [p.__pr\u00e9nom = \"Ga\u00eblle\"] a cr\u00e9\u00e9 un attribut public [__pr\u00e9nom] \u00e0 la classe mais que celui-ci est diff\u00e9rent de l'attribut priv\u00e9 [__pr\u00e9nom] manipul\u00e9 au sein de celle-ci\u00a0;</li> </ul>"},{"location":"les-classes-et-objets.html#126-script-classes_06-ajout-dune-methode-dinitialisation-de-lobjet","title":"12.6. Script [classes_06]\u00a0: ajout d'une m\u00e9thode d'initialisation de l'objet","text":"<p>Le script [classes_06] ajoute une m\u00e9thode \u00e0 la classe [Personne]\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom utilitaires import Utils\n\n\n# une classe d'exception propri\u00e9taire d\u00e9rivant de [BaseException]\nclass MyException(BaseException):\n    # on ne fait rien : classe vide\n    pass\n\n\n# classe Personne\nclass Personne:\n    # constructeur\n    def __init__(self: object, pr\u00e9nom: str = \"x\", nom: str = \"y\", \u00e2ge: int = 0):\n        # pr\u00e9nom : pr\u00e9nom de la personne\n        # nom : nom de la personne\n        # \u00e2ge : \u00e2ge de la personne\n\n        # m\u00e9morisation des param\u00e8tres\n        # les initialisations seront faites via les setters\n        self.pr\u00e9nom = pr\u00e9nom\n        self.nom = nom\n        self.\u00e2ge = \u00e2ge\n\n    # autre m\u00e9thode d'initialisation\n    def init_with_personne(self: object, p: object):\n        # initialise l'objet courant avec une personne p\n        self.__init__(p.pr\u00e9nom, p.nom, p.\u00e2ge)\n\n    # m\u00e9thode toString de la classe\n    def __str__(self: object) -&gt; str:\n        return f\"[{self.__pr\u00e9nom},{self.__nom},{self.__\u00e2ge}]\"\n\n    # getters\n    \u2026\n\n    # setters\n    \u2026\n\n\n# ---------------------------------- main\n# un objet Personne\ntry:\n    # instanciation classe Personne\n    p = Personne(\"Paul\", \"de la H\u00fbche\", 48)\n    # affichage objet p\n    print(f\"personne={p}\")\nexcept MyException as erreur:\n    # affichage msg d'erreur\n    print(erreur)\n\n# un autre objet Personne\ntry:\n    # instanciation classe Personne\n    p = Personne(\"xx\", \"yy\", \"zz\")\n    # affichage objet p\n    print(f\"p={p}\")\nexcept MyException as erreur:\n    # affichage msg d'erreur\n    print(erreur)\n\n# une autre personne sans param\u00e8tres cette fois\ntry:\n    # instanciation classe Personne\n    p = Personne()\n    # affichage objet p\n    print(f\"p={p}\")\nexcept MyException as erreur:\n    # affichage msg d'erreur\n    print(erreur)\n\n# une autre Personne obtenue par recopie\ntry:\n    # instanciation classe Personne\n    p2 = Personne()\n    p2.init_with_personne(p)\n    # affichage objet p2\n    print(f\"p2={p2}\")\nexcept MyException as erreur:\n    # affichage msg d'erreur\n    print(erreur)\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>la diff\u00e9rence avec le script pr\u00e9c\u00e9dent est en lignes 30-33. On a rajout\u00e9 la m\u00e9thode initWithPersonne. Celle-ci fait appel au constructeur init. Il n'y a pas possibilit\u00e9 d'avoir, comme dans les langages typ\u00e9s, des m\u00e9thodes de m\u00eame nom diff\u00e9renci\u00e9es par la nature de leurs param\u00e8tres ou de leur r\u00e9sultat. Il n'y a donc pas possibilit\u00e9 d'avoir plusieurs constructeurs qui construiraient l'objet \u00e0 partir de param\u00e8tres diff\u00e9rents, ici un objet de type Personne\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/01/classes_06.py\npersonne=[Paul,de la H\u00fbche,48]\nL'\u00e2ge doit \u00eatre un entier &gt;=0\np=[x,y,0]\np2=[x,y,0]\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-classes-et-objets.html#127-script-classes_07-une-liste-dobjets-personne","title":"12.7. Script [classes_07]\u00a0: une liste d'objets Personne","text":"<p>Nous mettons d\u00e9sormais les classes [MyException] et [Personne] dans un module pour pouvoir les utiliser sans avoir \u00e0 recopier leur code\u00a0:</p> <p></p> <p>Les deux classes seront dans le module [myclasses.py] ci-dessus.</p> <p>Le script [classes_07] montre qu'on peut avoir une liste d'objets\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom myclasses import Personne\n\n# ---------------------------------- main\n# cr\u00e9ation d'une liste d'objets personne\ngroupe = [Personne(\"Paul\", \"Langevin\", 48), Personne(\"Sylvie\", \"Lefur\", 70)]\n# identit\u00e9 de ces personnes\nfor i in range(len(groupe)):\n    print(f\"groupe[{i}]={groupe[i]}\")\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>ligne 7\u00a0: on importe la classes [Personne]\u00a0;</li> <li>ligne 11\u00a0: un liste d'objets de type [Personne]\u00a0;</li> <li>lignes 13-14\u00a0: on parcourt cette liste pour afficher chacun de ses \u00e9l\u00e9ments\u00a0;</li> <li>ligne 14\u00a0: la fonction [print] va afficher la cha\u00eene repr\u00e9sentant l'objet [groupe[i]]. Par d\u00e9faut, c'est la m\u00e9thode [str] de ceux-ci qui sera appel\u00e9e\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Users\\serge\\.virtualenvs\\cours-python-v02\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/v-02/classes/01/classes_07.py\ngroupe[0]=[Paul,Langevin,48]\ngroupe[1]=[Sylvie,Lefur,70]\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-classes-et-objets.html#128-script-classes_08-creation-dune-classe-derivee-de-la-classe-personne","title":"12.8. Script [classes_08]\u00a0: cr\u00e9ation d'une classe d\u00e9riv\u00e9e de la classe Personne","text":"<p>Nous d\u00e9finissons dans le module [myclasses], la classe [Enseignant]\u00a0suivante :</p> <pre><code># classe Enseignant\nclass Enseignant(Personne):\n    # constructeur\n    def __init__(self, pr\u00e9nom: str = \"x\", nom: str = \"x\", \u00e2ge: int = 0, discipline: str = \"x\"):\n        # pr\u00e9nom : pr\u00e9nom de la personne\n        # nom : nom de la personne\n        # \u00e2ge : \u00e2ge de la personne\n        # discipline : discpline enseign\u00e9e\n\n        # initialisation du parent\n        Personne.__init__(self, pr\u00e9nom, nom, \u00e2ge)\n        # autres initialisations\n        self.discipline = discipline\n\n    # toString\n    def __str__(self) -&gt; str:\n        return f\"enseignant[{super().__str__()},{self.discipline}]\"\n\n    # propri\u00e9t\u00e9s\n    @property\n    def discipline(self) -&gt; str:\n        return self.__discipline\n\n    @discipline.setter\n    def discipline(self, discipline: str):\n        # la discipline doit \u00eatre une cha\u00eene non vide\n        if Utils.is_string_ok(discipline):\n            self.__discipline = discipline\n        else:\n            raise MyException(\"La discipline doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\n</code></pre> <ul> <li>ligne 2\u00a0: d\u00e9clare la classe Enseignant comme \u00e9tant une classe d\u00e9riv\u00e9e de la classe Personne. Une classe d\u00e9riv\u00e9e a toutes les propri\u00e9t\u00e9s (attributs et m\u00e9thodes) de sa classe parent plus celles qui lui sont propres\u00a0;</li> <li>ligne 13\u00a0: la classe [Enseignant] d\u00e9finit un nouvel attribut [discipline]\u00a0;</li> <li>ligne 11\u00a0: le constructeur de la classe d\u00e9riv\u00e9e Enseignant doit appeler le constructeur de la classe parent Personne en lui transmettant les param\u00e8tres qu'il attend\u00a0;</li> <li>ligne 17\u00a0: la fonction [super()] rend la classe parent. Ici on appelle la fonction [str] de la classe parent\u00a0;</li> <li>lignes 19-30\u00a0: on d\u00e9finit le getter et setter du nouvel attribut [discipline]\u00a0; Le script [classes_08] utilise la classe [Enseignant] de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom myclasses import Personne, Enseignant\n\n# ---------------------------------- main\n# cr\u00e9ation d'un tableau d'objets Personne et d\u00e9riv\u00e9s\ngroupe = [Enseignant(\"Paul\", \"Langevin\", 48, \"anglais\"), Personne(\"Sylvie\", \"Lefur\", 70)]\n# identit\u00e9 de ces personnes\nfor i in range(len(groupe)):\n    print(f\"groupe[{i}]={groupe[i]}\")\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>ligne 7\u00a0: on importe les classes [Personne] et [Enseignant] d\u00e9finies dans le fichier [myclasses.py]\u00a0;</li> <li>lignes 11-14\u00a0: on d\u00e9finit un groupe de personnes dont on affiche ensuite l'identit\u00e9\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/01/classes_08.py\ngroupe[0]=enseignant[[Paul,Langevin,48],anglais]\ngroupe[1]=[Sylvie,Lefur,70]\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-classes-et-objets.html#129-script-classes_09-seconde-classe-derivee-de-la-classe-personne","title":"12.9. Script [classes_09]\u00a0: seconde classe d\u00e9riv\u00e9e de la classe Personne","text":"<p>Le script [classes_09] introduit la classe [Etudiant] d\u00e9riv\u00e9e de la classe [Personne]. Celle-ci est d\u00e9finie de la fa\u00e7on suivante dans le module [myclasses]\u00a0:</p> <pre><code># classe Etudiant\nclass Etudiant(Personne):\n    # constructeur\n    def __init__(self: object, pr\u00e9nom: str = \"x\", nom: str = \"y\", \u00e2ge: int = 0, formation: str = \"x\"):\n        Personne.__init__(self, pr\u00e9nom, nom, \u00e2ge)\n        self.formation = formation\n\n    # toString\n    def __str__(self: object) -&gt; str:\n        return f\"\u00e9tudiant[{super().__str__()},{self.formation}]\"\n\n    # propri\u00e9t\u00e9s\n    @property\n    def formation(self) -&gt; str:\n        return self.__formation\n\n    @formation.setter\n    def formation(self, formation: str):\n        # la formation doit \u00eatre une cha\u00eene non vide\n        if Utils.is_string_ok(formation):\n            self.__formation = formation\n        else:\n            raise MyException(\"La formation doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\n</code></pre> <p>Le script [classes_09] utilise la classe [Etudiant] de la fa\u00e7on suivante\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom myclasses import Personne, Enseignant, Etudiant\n\n# ---------------------------------- main\n# cr\u00e9ation d'un tableau d'objets Personne et d\u00e9riv\u00e9s\ngroupe = [Enseignant(\"Paul\", \"Langevin\", 48, \"anglais\"), Personne(\"Sylvie\", \"Lefur\", 70),\n          Etudiant(\"Steve\", \"Boer\", 22, \"iup2 qualit\u00e9\")]\n# identit\u00e9 de ces personnes\nfor personne in groupe:\n    # affichage personne\n    print(personne)\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>ce script est analogue au pr\u00e9c\u00e9dent. R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/01/classes_09.py\nenseignant[[Paul,Langevin,48],anglais]\n[Sylvie,Lefur,70]\n\u00e9tudiant[[Steve,Boer,22],iup2 qualit\u00e9]\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-classes-et-objets.html#1210-script-classes_10-la-propriete-dict","title":"12.10. Script [classes_10]\u00a0: la propri\u00e9t\u00e9 [dict]","text":"<p>Le script [classes_10] pr\u00e9sente la propri\u00e9t\u00e9 [dict] que nous allons souvent utiliser par la suite\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom myclasses import Etudiant\n\n# ---------------------------------- main\n# cr\u00e9ation d'un \u00e9tudiant\n\u00e9tudiant=Etudiant(\"Steve\", \"Boer\", 22, \"iup2 qualit\u00e9\")\n# dictionnaire des propri\u00e9t\u00e9s\nprint(\u00e9tudiant.__dict__)\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 1-4\u00a0: l\u2019application est configur\u00e9e\u00a0;</li> <li>ligne 7\u00a0: la classe [Etudiant] est import\u00e9e\u00a0;</li> <li>ligne 11\u00a0: instanciation d\u2019un \u00e9tudiant\u00a0;</li> <li>ligne 13\u00a0: utilisation de la m\u00e9thode pr\u00e9d\u00e9finie [dict] (2 caract\u00e8res soulign\u00e9s avant et apr\u00e8s l\u2019identifiant)\u00a0; Les r\u00e9sultats sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/01/classes_10.py\n{'_Personne__pr\u00e9nom': 'Steve', '_Personne__nom': 'Boer', '_Personne__\u00e2ge': 22, '_Etudiant__formation': 'iup2 qualit\u00e9'}\n\nProcess finished with exit code 0\n</code></pre> <ul> <li>ligne 2, on obtient un dictionnaire dont les cl\u00e9s sont les propri\u00e9t\u00e9s de l\u2019objet pr\u00e9fix\u00e9es par le nom de la classe \u00e0 laquelle elles appartiennent. Nous utiliserons ce dictionnaire pour faire une passerelle entre objet et dictionnaire\u00a0;</li> </ul>"},{"location":"les-classes-generiques-baseentity-et-myexception.html","title":"13. Les classes g\u00e9n\u00e9riques [BaseEntity] et [MyException]","text":"<p>Nous d\u00e9finissons maintenant deux classes que nous utiliserons r\u00e9guli\u00e8rement par la suite.</p> <p></p>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#131-la-classe-myexception","title":"13.1. La classe MyException","text":"<p>La classe [MyException] (MyException.py) fournit une classe d'exceptions propri\u00e9taire\u00a0:</p> <pre><code># une classe d'exception propri\u00e9taire d\u00e9rivant de [BaseException]\nclass MyException(BaseException):\n    # constructeur\n    def __init__(self: object, code: int, message: str):\n        # parent\n        BaseException.__init__(self, message)\n        # code erreur\n        self.code = code\n\n    # toString\n    def __str__(self):\n        return f\"MyException[{self.code}, {super().__str__()}]\"\n\n    # getter\n    @property\n    def code(self) -&gt; int:\n        return self.__code\n\n    # setter\n    @code.setter\n    def code(self, code: int):\n        # le code d'erreur doit \u00eatre un entier positif\n        if isinstance(code, int) and code &gt; 0:\n            self.__code = code\n        else:\n            # exception\n            raise BaseException(f\"code erreur {code} incorrect\")\n</code></pre> <p>Notes</p> <ul> <li>ligne 2\u00a0: la classe [MyException] d\u00e9rive de la classe pr\u00e9d\u00e9finie [BaseException]\u00a0;</li> <li>ligne 4\u00a0: le constructeur accepte deux param\u00e8tres\u00a0:</li> <li>[code]\u00a0: un code d'erreur entier\u00a0;</li> <li>[message]\u00a0: un message d'erreur\u00a0;</li> <li>ligne 6\u00a0: on passe le message d\u2019erreur \u00e0 la classe parent\u00a0;</li> <li>lignes 14-27\u00a0: l'attribut [code] est manipul\u00e9 via un getter / setter\u00a0;</li> <li>lignes 23-24\u00a0: la validit\u00e9 de l'attribut [code] est v\u00e9rifi\u00e9e\u00a0: il faut que ce soit un entier &gt;0\u00a0;</li> </ul>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#132-la-classe-baseentity","title":"13.2. La classe [BaseEntity]","text":"<p>La classe [BaseEntity] sera la classe parent de la plupart des classes que nous cr\u00e9erons pour encapsuler des informations sur un objet. Dans la suite nous utiliserons principalement deux types de classes\u00a0:</p> <ul> <li>des classes qui n\u2019ont pour but que d\u2019encapsuler au m\u00eame endroit des informations sur un m\u00eame objet. Celles-ci n\u2019auront pas de comportements (m\u00e9thodes) autres que des getters / setters et une fonction d\u2019affichage (str). S\u2019il y a N objets \u00e0 g\u00e9rer, ces classes sont instanci\u00e9es N fois. [BaseEntity] sera la classe parent de ce type de classes\u00a0;</li> <li>des classes dont le r\u00f4le principal est d\u2019encapsuler des m\u00e9thodes et tr\u00e8s peu d\u2019informations. Ces classes ne seront instanci\u00e9es qu\u2019une fois (singleton). Leur r\u00f4le est d\u2019impl\u00e9menter les algorithmes d\u2019une application\u00a0; La classe [BaseEntity] est la suivante\u00a0:</li> </ul> <pre><code># imports\nimport json\nimport re\n\nfrom MyException import MyException\n\n\nclass BaseEntity(object):\n    # propri\u00e9t\u00e9s exclues de l'\u00e9tat de la classe\n    excluded_keys = []\n\n    # propri\u00e9t\u00e9s de la classe\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        # id : identifiant de l'objet\n        return [\"id\"]\n\n    # toString\n    def __str__(self) -&gt; str:\n        return self.asjson()\n\n    # getter\n    @property\n    def id(self) -&gt; int:\n        return self.__id\n\n    #  setter\n    @id.setter\n    def id(self, id):\n        # l'id doit \u00eatre un entier &gt;=0\n        try:\n            id = int(id)\n            erreur = id &lt; 0\n        except:\n            erreur = True\n        # erreur ?\n        if erreur:\n            raise MyException(1, f\"L'identifiant d'une entit\u00e9 {self.__class__} doit \u00eatre un entier &gt;=0\")\n        else:\n            self.__id = id\n\n    def fromdict(self, state: dict, silent=False):\n        \u2026\n\n    def set_value(self, key: str, value, new_attributes) -&gt; dict:\n        \u2026\n\n    def asdict(self, included_keys: list = None, excluded_keys: list = []) -&gt; dict:\n        \u2026\n\n    def asjson(self, excluded_keys: list = []) -&gt; str:\n        \u2026\n\n    def fromjson(self, json_state: str):\n        \u2026\n</code></pre> <p>Commentaires</p> <ul> <li>l\u2019objectif de la classe [BaseEntity] est de faciliter les conversions Objet / Dictionnaire et Objet / jSON. On offre ainsi les m\u00e9thodes suivantes\u00a0:</li> <li>[asdict]\u00a0: rend le dictionnaire des propri\u00e9t\u00e9s de l\u2019objet\u00a0;</li> <li>[fromdict]\u00a0: construit un objet \u00e0 partir d\u2019un dictionnaire\u00a0;</li> <li>[asjson]\u00a0: rend la cha\u00eene jSON de l\u2019objet comme le fait la fonction [str]\u00a0;</li> <li>[fromjson]\u00a0: construit un objet \u00e0 partir de sa cha\u00eene jSON\u00a0;</li> <li>la classe [BaseEntity] est destin\u00e9e \u00e0 \u00eatre d\u00e9riv\u00e9e et non \u00e0 \u00eatre utilis\u00e9e telle quelle\u00a0;</li> <li>lignes 22-25\u00a0: la classe [BaseEntity] n\u2019a qu\u2019une propi\u00e9t\u00e9, l\u2019entier [id]. Cette propri\u00e9t\u00e9 est l\u2019identifiant de l\u2019objet. Dans la pratique, il est souvent utile de pouvoir diff\u00e9rentier les instances d\u2019une m\u00eame classe. Nous le ferons avec cette propri\u00e9t\u00e9, unique pour une instance. Par ailleurs, les objets proviennent souvent de bases de donn\u00e9es o\u00f9 ils sont identifi\u00e9s par une cl\u00e9 primaire, un entier g\u00e9n\u00e9ralement. Dans ces cas, [id] sera la cl\u00e9 primaire\u00a0;</li> <li>lignes 27-40\u00a0: le setter de la propri\u00e9t\u00e9 [id]. On v\u00e9rifie que c\u2019est un entier &gt;=0. Si ce n\u2019est pas le cas, une exception de type [MyException] est lanc\u00e9e (ligne 39)\u00a0;</li> <li>ligne 10\u00a0: [excluded_keys] est un attribut de classe et non d\u2019instance. Ainsi on \u00e9crira [BaseEntity.excluded_keys]. Cet attribut de classe est une liste contenant les propri\u00e9t\u00e9s de classe qui ne participent pas aux conversions Objet / Dictionnaire et Objet / jSON\u00a0;</li> <li>lignes 12-16\u00a0: [get_allowed_keys] rend la liste des propri\u00e9t\u00e9s de la classe. Dans une conversion Dictionnaire -&gt; Objet ou jSON -&gt; Objet, on n\u2019acceptera que les cl\u00e9s pr\u00e9sentes dans cette liste. Chaque classe d\u00e9rivant la classe [BaseEntity] aura \u00e0 red\u00e9finir cette liste\u00a0; Il faut comprendre ici que les propri\u00e9t\u00e9s et fonctions de la classe [BaseEntity] sont accessibles aux classes d\u00e9riv\u00e9es de [BaseEntity]. C\u2019est le point important \u00e0 comprendre.</li> </ul> <p>Nous allons d\u00e9tailler le code de la classe [BaseEntity]. Il est assez avanc\u00e9. Le lecteur d\u00e9butant pourra se contenter de lire le r\u00f4le de chaque fonction sans s\u2019apesantir sur son code.</p>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#1321-la-methode-baseentityfromdict","title":"13.2.1. La m\u00e9thode [BaseEntity.fromdict]","text":""},{"location":"les-classes-generiques-baseentity-et-myexception.html#13211-definition","title":"13.2.1.1. D\u00e9finition","text":"<p>La m\u00e9thode [fromdict] permet d\u2019initialiser un objet [BaseEntity] ou d\u00e9riv\u00e9 \u00e0 partir d\u2019un dictionnaire\u00a0:</p> <pre><code>def fromdict(self, state: dict, silent=False):\n        # on met \u00e0 jour l'objet\n        # cl\u00e9s autoris\u00e9es\n        allowed_keys = self.__class__.get_allowed_keys()\n        # parcourt des cl\u00e9s de state\n        for key, value in state.items():\n            # la cl\u00e9 est-elle autoris\u00e9e ?\n            if key not in allowed_keys:\n                if not silent:\n                    raise MyException(2, f\"la cl\u00e9 {key} n'est pas autoris\u00e9e\")\n            else:\n                # on essaie d'affecter la valeur \u00e0 la cl\u00e9\n                # on laisse remonter l'\u00e9ventuelle exception\n                setattr(self, key, value)\n        # on rend l'objet\n        return self\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 1\u00a0: la fonction re\u00e7oit en param\u00e8tre le dictionnaire [state] \u00e0 partir duquel l\u2019objet courant va \u00eatre initialis\u00e9\u00a0;</li> <li>ligne 4\u00a0: on fait appel \u00e0 la fonction statique [get_allowed_keys] de la classe qui a appel\u00e9 la fonction [fromdict]. Si on a affaire \u00e0 une classe d\u00e9riv\u00e9e de [BaseEntity] et que cette classe d\u00e9riv\u00e9e a red\u00e9fini la fonction statique [get_allowed_keys] alors c\u2019est la fonction [get_allowed_keys] qui est appel\u00e9e. Chaque classe d\u00e9riv\u00e9e red\u00e9finit cette fonction statique pour y d\u00e9clarer ses propri\u00e9t\u00e9s\u00a0;</li> <li>ligne 6\u00a0: on parcourt les cl\u00e9s et valeurs du dictionnaire [state]\u00a0;</li> <li>ligne 8\u00a0: si la cl\u00e9 [key] ne fait pas partie des propri\u00e9t\u00e9s de la classe, alors soit\u00a0:</li> <li>on l\u2019ignore\u00a0;</li> <li>on lance une exception (ligne 10). Le d\u00e9veloppeur indique ce qu\u2019il souhaite en passant le bon param\u00e8tre [silent] (ligne 1). La valeur par d\u00e9faut de [silent] fait qu\u2019une exception est lanc\u00e9e si on tente d\u2019initialiser l\u2019objet avec une propri\u00e9t\u00e9 qu\u2019il n\u2019a pas\u00a0;</li> <li>ligne 14\u00a0: si la cl\u00e9 fait partie des propri\u00e9t\u00e9s de l\u2019objet, alors on l\u2019affecte \u00e0 l\u2019objet [self] \u00e0 l\u2019aide de la fonction pr\u00e9d\u00e9finie [setattr]\u00a0;</li> <li>ligne 16\u00a0: la fonction rend l\u2019objet initialis\u00e9\u00a0;</li> </ul>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#13212-exemples","title":"13.2.1.2. Exemples","text":""},{"location":"les-classes-generiques-baseentity-et-myexception.html#132121-la-classe-utils","title":"13.2.1.2.1. La classe [Utils]","text":"<p>La classe [Utils] (Utils.py) est la suivante\u00a0:</p> <pre><code>class Utils:\n    # m\u00e9thode statique\n    @staticmethod\n    def is_string_ok(string: str) -&gt; bool:\n        # string est-elle une cha\u00eene\n        erreur = not isinstance(string, str)\n        if not erreur:\n            # la cha\u00eene est-elle vide ?\n            erreur = string.strip() == ''\n        # r\u00e9sultat\n        return not erreur\n</code></pre> <p>Elle d\u00e9finit aux lignes 3-11, une m\u00e9thode statique qui rend un bool\u00e9en vrai si son param\u00e8tre [str] est une cha\u00eene de caract\u00e8res non vide\u00a0;</p>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#132122-la-classe-personne","title":"13.2.1.2.2. La classe [Personne]","text":"<p>La classe [Personne] (Personne.py) d\u00e9rive de la classe [BaseEntity]\u00a0:</p> <pre><code># imports\nfrom BaseEntity import BaseEntity\nfrom MyException import MyException\nfrom Utils import Utils\n\n\n# classe Personne\nclass Personne(BaseEntity):\n    # propri\u00e9t\u00e9s exclues de l'\u00e9tat de la classe\n    excluded_keys = []\n\n    # propri\u00e9t\u00e9s de la classe\n    # id : identifiant de la personne\n    # pr\u00e9nom : pr\u00e9nom de la personne\n    # nom : nom de la personne\n    # \u00e2ge : \u00e2ge de la personne\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        # id : identifiant de l'objet\n        return BaseEntity.get_allowed_keys() + [\"nom\", \"pr\u00e9nom\", \"\u00e2ge\"]\n\n    # getters\n    @property\n    def pr\u00e9nom(self) -&gt; str:\n        return self.__pr\u00e9nom\n\n    @property\n    def nom(self) -&gt; str:\n        return self.__nom\n\n    @property\n    def \u00e2ge(self) -&gt; int:\n        return self.__\u00e2ge\n\n    # setters\n    @pr\u00e9nom.setter\n    def pr\u00e9nom(self, pr\u00e9nom: str):\n        # le pr\u00e9nom doit \u00eatre non vide\n        if Utils.is_string_ok(pr\u00e9nom):\n            self.__pr\u00e9nom = pr\u00e9nom.strip()\n        else:\n            raise MyException(11, \"Le pr\u00e9nom doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\n\n    @nom.setter\n    def nom(self, nom: str):\n        # le pr\u00e9nom doit \u00eatre non vide\n        if Utils.is_string_ok(nom):\n            self.__nom = nom.strip()\n        else:\n            raise MyException(12, \"Le nom doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\n\n    @\u00e2ge.setter\n    def \u00e2ge(self, \u00e2ge: int):\n        # l'\u00e2ge doit \u00eatre un entier &gt;=0\n        erreur = False\n        if isinstance(\u00e2ge, int):\n            if \u00e2ge &gt;= 0:\n                self.__\u00e2ge = \u00e2ge\n            else:\n                erreur = True\n        else:\n            erreur = True\n        # erreur ?\n        if erreur:\n            raise MyException(13, \"L'\u00e2ge doit \u00eatre un entier &gt;=0\")\n</code></pre> <ul> <li>ligne 8\u00a0: la classe [Personne] d\u00e9rive de la classe [BaseEntity]\u00a0;</li> <li>lignes 8-65\u00a0: on a gard\u00e9 l\u2019essentiel de la classe [Personne] d\u00e9j\u00e0 rencontr\u00e9e. Les diff\u00e9rences sont les suivantes\u00a0:</li> <li>la classe n\u2019a plus de constructeur\u00a0;</li> <li>la classe utilise l\u2019exception [MyException], exemple ligne 65\u00a0;</li> <li>elle a une m\u00e9thode statique, [get_allowed_keys], lignes 17-20, qui d\u00e9finit la liste de ses propri\u00e9t\u00e9s. Les propri\u00e9t\u00e9s propres \u00e0 la classe [Personne] sont ajout\u00e9es \u00e0 celles de la classe parent [BaseEntity]\u00a0;</li> <li>elle a une liste statique [excluded_keys] sur laquelle on reviendra\u00a0;</li> </ul>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#132123-la-classe-enseignant","title":"13.2.1.2.3. La classe [Enseignant]","text":"<p>La classe [Enseignant] (Enseignant.py) d\u00e9rive de la classe [Personne]\u00a0:</p> <pre><code># imports\nfrom MyException import MyException\nfrom Personne import Personne\nfrom Utils import Utils\n\n\n# classe Enseignant\nclass Enseignant(Personne):\n    # propri\u00e9t\u00e9s exclues de l'\u00e9tat de la classe\n    excluded_keys = []\n\n    # propri\u00e9t\u00e9s de la classe\n    # id : identifiant de la personne\n    # pr\u00e9nom : pr\u00e9nom de la personne\n    # nom : nom de la personne\n    # \u00e2ge : \u00e2ge de la personne\n    # discipline : discpline enseign\u00e9e\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        # id : identifiant de l'objet\n        return Personne.get_allowed_keys() + [\"discipline\"]\n\n    # propri\u00e9t\u00e9s\n    @property\n    def discipline(self) -&gt; str:\n        return self.__discipline\n\n    @discipline.setter\n    def discipline(self, discipline: str):\n        # la discipline doit \u00eatre une cha\u00eene non vide\n        if Utils.is_string_ok(discipline):\n            self.__discipline = discipline\n        else:\n            raise MyException(21, \"La discipline doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\n\n    # m\u00e9thode show\n    def show(self):\n        print(f\"Enseignant[{self.id}, {self.pr\u00e9nom}, {self.nom}, {self.\u00e2ge}]\")\n</code></pre> <ul> <li>ligne 8\u00a0: la classe [Enseignant] \u00e9tend (ou d\u00e9rive) la classe [Personne]\u00a0;</li> <li>lignes 18-21\u00a0: d\u00e9finissent la liste des propri\u00e9t\u00e9s de la classe\u00a0;</li> <li>lignes 37-38\u00a0: la m\u00e9thode [show] affiche l\u2019identit\u00e9 de l\u2019enseignant\u00a0;</li> </ul>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#132124-la-configuration-config","title":"13.2.1.2.4. La configuration [config]","text":"<p>Les scripts d\u2019exemples utilisent la configuration [config] suivante\u00a0:</p> <pre><code>def\u00a0configure():\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0dossier\u00a0du\u00a0fichier\u00a0de\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemins\u00a0absolus\u00a0des\u00a0dossiers\u00a0\u00e0\u00a0mettre\u00a0dans\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0classe\u00a0BaseEntity\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/entities\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0mise\u00a0\u00e0\u00a0jour\u00a0du\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0return\u00a0{}\n</code></pre> <ul> <li>lignes 8-10\u00a0: les dossiers contenant les d\u00e9pendances du projet\u00a0;</li> <li>lignes 14-15\u00a0: le Python Path est construit\u00a0;</li> <li>ligne 18\u00a0: on rend un dictionnaire vide (il n\u2019y a pas d\u2019autres configuration que celle du syspath)\u00a0;</li> </ul>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#132125-le-script-fromdict_01","title":"13.2.1.2.5. Le script [fromdict_01]","text":"<p>Le script [fromdict_01] est le suivant\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom Enseignant import Enseignant\n\n# un enseignant\nenseignant1 = Enseignant().fromdict({\"id\": 1, \"nom\": \"lourou\", \"pr\u00e9nom\": \"paul\", \"\u00e2ge\": 56})\nenseignant1.show()\n</code></pre> <ul> <li>ligne 10\u00a0: on cr\u00e9e un objet [Enseignant] \u00e0 partir d\u2019un dictionnaire. Pour cela, on utilise le constructeur par d\u00e9faut de la classe pour cr\u00e9er un objet [Enseignant] \u00e0 laquel on applique la m\u00e9thode [fromdict]. Il faut comprendre qu\u2019ici la m\u00e9thode [fromdict] ex\u00e9cut\u00e9e est celle de la classe parent [BaseEntity]. En effet\u00a0:</li> <li>la m\u00e9thode [fromdict] est d\u2019abord cherch\u00e9e dans la classe [Enseignant]. Elle n\u2019existe pas\u00a0;</li> <li>elle est ensuite cherch\u00e9e dans la classe parent [Personne]. Elle n\u2019existe pas\u00a0;</li> <li>elle est ensuite cherch\u00e9e dans la classe parent [BaseEntity]. Elle existe\u00a0;</li> <li>ligne 11\u00a0: on affiche\u00a0l\u2019objet [Enseignant]\u00a0; Les r\u00e9sultats sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/02/fromdict_01.py\nEnseignant[1, paul, lourou, 56]\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#132126-le-script-fromdict_02","title":"13.2.1.2.6. Le script [fromdict_02]","text":"<p>Le script [fromdict_02] est le suivant\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom Enseignant import Enseignant\n\n# un enseignant\nenseignant1 = Enseignant().fromdict({\"id\": 1, \"nom\": \"lourou\", \"pr\u00e9nom\": \"\", \"\u00e2ge\": 56})\nenseignant1.show()\n</code></pre> <ul> <li>ligne 10\u00a0: on cr\u00e9e un enseignant avec un pr\u00e9nom vide. Cela doit cr\u00e9er une exception car la classe [Personne] n\u2019accepte pas des pr\u00e9noms vides. Cet exemple montre la diff\u00e9rence entre un dictionnaire et un objet. Ce dernier peut v\u00e9rifier la validit\u00e9 de ses propri\u00e9t\u00e9s, pas le dictionnaire\u00a0; Les r\u00e9sultats sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/02/fromdict_02.py\nTraceback (most recent call last):\n  File \"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/02/fromdict_02.py\", line 10, in &lt;module&gt;\n    enseignant1 = Enseignant().fromdict({\"id\": 1, \"nom\": \"lourou\", \"pr\u00e9nom\": \"\", \"\u00e2ge\": 56})\n  File \"C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\classes\\02/entities\\BaseEntity.py\", line 55, in fromdict\n    setattr(self, key, value)\n  File \"C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\classes\\02/entities\\Personne.py\", line 42, in pr\u00e9nom\n    raise MyException(11, \"Le pr\u00e9nom doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\nMyException.MyException: MyException[11, Le pr\u00e9nom doit \u00eatre une cha\u00eene de caract\u00e8res non vide]\n\nProcess finished with exit code 1\n</code></pre>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#132127-le-script-fromdict_03","title":"13.2.1.2.7. Le script [fromdict_03]","text":"<p>Le script [fromdict_03] est le suivant\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom Enseignant import Enseignant\n\n# un enseignant\nenseignant1 = Enseignant().fromdict({\"id\": 1, \"nom\": \"lourou\", \"pr\u00e9nom\": \"albert\", \"\u00e2ge\": 56, \"sexe\": \"M\"})\nenseignant1.show()\n</code></pre> <ul> <li>ligne 10\u00a0: on cr\u00e9e un enseignant \u00e0 partir d\u2019un dictionnaire contenant une cl\u00e9 (sexe) qui n\u2019appartient pas \u00e0 la classe [Enseignant]. Une exception devrait alors \u00eatre lev\u00e9e\u00a0; Les r\u00e9sultats sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/02/fromdict_03.py\nTraceback (most recent call last):\n  File \"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/02/fromdict_03.py\", line 10, in &lt;module&gt;\n    enseignant1 = Enseignant().fromdict({\"id\": 1, \"nom\": \"lourou\", \"pr\u00e9nom\": \"albert\", \"\u00e2ge\": 56, \"sexe\": \"M\"})\n  File \"C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\classes\\02/entities\\BaseEntity.py\", line 51, in fromdict\n    raise MyException(2, f\"la cl\u00e9 [{key}] n'est pas autoris\u00e9e\")\nMyException.MyException: MyException[2, la cl\u00e9 [sexe] n'est pas autoris\u00e9e]\n\nProcess finished with exit code 1\n</code></pre>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#132128-le-script-fromdict_04","title":"13.2.1.2.8. Le script [fromdict_04]","text":"<p>Le script [fromdict_04] est une copie de [fromdict_03] \u00e0 un d\u00e9tail pr\u00e8s\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom Enseignant import Enseignant\n\n# un enseignant\nenseignant1 = Enseignant().fromdict({\"id\": 1, \"nom\": \"lourou\", \"pr\u00e9nom\": \"albert\", \"\u00e2ge\": 56, \"sexe\": \"M\"}, silent=True)\nenseignant1.show()\n</code></pre> <ul> <li>ligne 10\u00a0: on a utilis\u00e9 le param\u00e8tre [silent=True] pour indiquer que si une cl\u00e9 du dictionnaire n\u2019est pas une propri\u00e9t\u00e9 de la classe [Enseignant], elle doit simplement \u00eatre ignor\u00e9e. Dans ce cas, aucune exception ne sera lanc\u00e9e\u00a0; Les r\u00e9sultats sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/02/fromdict_04.py\nEnseignant[1, albert, lourou, 56]\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#1322-la-methode-baseentityasdict","title":"13.2.2. La m\u00e9thode [BaseEntity.asdict]","text":""},{"location":"les-classes-generiques-baseentity-et-myexception.html#13221-definition","title":"13.2.2.1. D\u00e9finition","text":"<p>La m\u00e9thode [BaseEntity.asdict] rend un dictionnaire dont les cl\u00e9s sont les propri\u00e9t\u00e9s de l\u2019objet\u00a0:</p> <pre><code>    def asdict(self, included_keys: list = None, excluded_keys: list =[]) -&gt; dict:\n        # attributs de l'objet\n        attributes = self.__dict__\n        # les nouveaux attributs\n        new_attributes = {}\n        # on parcourt les attributs\n        for key, value in attributes.items():\n            # si la cl\u00e9 est explicitement demand\u00e9e\n            if included_keys and key in included_keys:\n                self.set_value(key, value, new_attributes)\n            # sinon, si la cl\u00e9 n'est pas exclue\n            elif not included_keys and key not in self.__class__.excluded_keys and key not in excluded_keys:\n                self.set_value(key, value, new_attributes)\n        # on rend le dictionnaire des attributs\n        return new_attributes\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 1\u00a0: la fonction [asdict] rend le dictionnaire des propri\u00e9t\u00e9s de l\u2019objet\u00a0;</li> <li>ligne 1\u00a0: [included_keys]\u00a0: la liste des cl\u00e9s \u00e0 inclure dans le dictionnaire\u00a0;</li> <li>ligne 1\u00a0: [excluded_keys]\u00a0: la liste des cl\u00e9s \u00e0 exclure du dictionnaire\u00a0;</li> <li>ligne 3\u00a0: la propri\u00e9t\u00e9 [self.dict] rend le dictionnaire des propri\u00e9t\u00e9s de l\u2019objet. Les noms des propri\u00e9t\u00e9s sont les cl\u00e9s et leurs valeurs les valeurs du dictionnaire. Un objet peut contenir des r\u00e9f\u00e9rences d\u2019autres objets. Les noms des propri\u00e9t\u00e9s sont alors pr\u00e9fix\u00e9es par le nom de la classe \u00e0 laquelle elles appartiennent. C\u2019est quelque chose qu\u2019on ne veut pas. On veut les propri\u00e9t\u00e9s sans leur pr\u00e9fixe\u00a0;</li> <li>ligne 3\u00a0: il faut comprendre ici que si la fonction [asdict] s\u2019ex\u00e9cute \u00e0 l\u2019int\u00e9rieur d\u2019une classe d\u00e9riv\u00e9e de [BaseEntity], la propri\u00e9t\u00e9 [self.dict] rend le dictionnaire des propri\u00e9t\u00e9s de l\u2019objet d\u00e9riv\u00e9\u00a0;</li> <li>ligne 5\u00a0: le dictionnaire que l\u2019on va construire\u00a0;</li> <li>ligne 7\u00a0: on parcourt les valeurs de [self.dict]\u00a0sous la forme (cl\u00e9, valeur)\u00a0;</li> <li>ligne 9\u00a0: si la cl\u00e9 courante appartient \u00e0 la liste des cl\u00e9s \u00e0 inclure, alors elle est ajout\u00e9e au dictionnaire [new_attributes] par la fonction [set_value] que nous allons prochainement d\u00e9crire\u00a0;</li> <li>ligne 12\u00a0: si le param\u00e8tre [included_keys] n\u2019est pas pr\u00e9sent, alors le param\u00e8tre [excluded_keys] est exploit\u00e9. Si la propri\u00e9t\u00e9 ne fait pas partie des propri\u00e9t\u00e9s \u00e0 exclure, alors elle est ajout\u00e9e au dictionnaire [new_attributes]\u00a0;</li> <li>ligne 12\u00a0: il y a plusieurs fa\u00e7ons d\u2019exclure une propri\u00e9t\u00e9 du dictionnaire\u00a0:</li> <li>elle a \u00e9t\u00e9 d\u00e9finie au niveau de l\u2019attribut de classe [excluded_keys]\u00a0;</li> <li>elle a \u00e9t\u00e9 d\u00e9finie dans la liste [excluded_keys] pass\u00e9e \u00e0 la fonction [asdict]\u00a0;</li> <li>le param\u00e8tre [included_keys] est pr\u00e9sent et ne comprend pas la propri\u00e9t\u00e9\u00a0;</li> <li>ligne 15\u00a0: on rend le dictionnaire [new_attributes] La fonction [set_value] des lignes 10 et 13 est la suivante\u00a0:</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0@staticmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0set_value(key:\u00a0str,\u00a0value,\u00a0new_attributes:\u00a0dict):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0les\u00a0cl\u00e9s\u00a0peuvent\u00a0\u00eatre\u00a0de\u00a0la\u00a0forme\u00a0__Class__key\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0match\u00a0=\u00a0re.match(\"^.*?__(.*?)$\",\u00a0key)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0match:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0note\u00a0la\u00a0nouvelle\u00a0cl\u00e9\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0newkey\u00a0=\u00a0match.groups()[0]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0cl\u00e9\u00a0reste\u00a0inchang\u00e9e\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0newkey\u00a0=\u00a0key\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ins\u00e8re\u00a0la\u00a0nouvelle\u00a0cl\u00e9\u00a0dans\u00a0le\u00a0dictionnaire\u00a0[new_attributes]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0en\u00a0transformant\u00a0si\u00a0besoin\u00a0est\u00a0la\u00a0valeur\u00a0associ\u00e9e\u00a0en\u00a0l'un\u00a0des\u00a0types\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dict,\u00a0list,\u00a0type\u00a0simple\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0new_attributes[newkey]\u00a0=\u00a0BaseEntity.check_value(value)\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 4\u00a0: on regarde si la cl\u00e9 est de la forme __Class_key. C\u2019est la forme qu\u2019elle a si elle appartient \u00e0 un objet inclus dans l\u2019objet principal. Dans ce cas, on ne veut garder que la cha\u00eene [key]\u00a0;</li> <li>ligne 7\u00a0: on ne garde que la cha\u00eene qui suit les deux derniers caract\u00e8res soulign\u00e9s de la cha\u00eene\u00a0;</li> <li>ligne 8-10\u00a0: si la cl\u00e9 n\u2019est pas de la forme __Class_key alors on la garde telle quelle\u00a0; </li> <li>lignes 11-14\u00a0: la valeur associ\u00e9e \u00e0 la cl\u00e9 [newkey] est calcul\u00e9e par la m\u00e9thode statique [BaseEntity.check_value]\u00a0; La m\u00e9thode statique [BaseEntity.check_value] est la suivante\u00a0:</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0@staticmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0check_value(value):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0valeur\u00a0peut\u00a0\u00eatre\u00a0de\u00a0type\u00a0BaseEntity,\u00a0list,\u00a0dict\u00a0ou\u00a0un\u00a0type\u00a0simple\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0value\u00a0est-elle\u00a0une\u00a0instance\u00a0de\u00a0BaseEntity\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0isinstance(value,\u00a0BaseEntity):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0value2\u00a0=\u00a0value.asdict()\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0value\u00a0est-elle\u00a0de\u00a0type\u00a0list\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0elif\u00a0isinstance(value,\u00a0list):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0value2\u00a0=\u00a0BaseEntity.list2list(value)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0value\u00a0est-elle\u00a0de\u00a0type\u00a0dict\u00a0?\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0elif\u00a0isinstance(value,\u00a0dict):\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0value2\u00a0=\u00a0BaseEntity.dict2dict(value)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0value\u00a0est\u00a0un\u00a0type\u00a0simple\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0value2\u00a0=\u00a0value\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0r\u00e9sultat\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0value2\n</code></pre> <ul> <li>ligne 1\u00a0: la m\u00e9thode [check_value] est statique (m\u00e9thode de classe et non d\u2019instance). Elle re\u00e7oit en param\u00e8tre la valeur \u00e0 associer \u00e0 une cl\u00e9 du dictionnaire\u00a0: </li> <li>ligne 17\u00a0: si cette valeur est un type simple, elle reste inchang\u00e9e\u00a0;</li> <li>lignes 5-6\u00a0: si cette valeur est de type BaseEntity, la valeur est remplac\u00e9e par son dictionnaire. On a alors un appel r\u00e9cursif\u00a0;</li> <li>lignes 8-9\u00a0: si cette valeur est une liste, alors elle est remplac\u00e9e par la valeur [BaseEntity.list2list]\u00a0;</li> <li>lignes 11-12\u00a0: si cette valeur est un dictionnaire, alors elle est remplac\u00e9e par la valeur [BaseEntity.dict2dict]\u00a0; La m\u00e9thode statique [BaseEntity.list2list] est la suivante\u00a0:</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0@staticmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0list2list(liste:\u00a0list)\u00a0-&gt;\u00a0list:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0inspecte\u00a0les\u00a0\u00e9l\u00e9ments\u00a0de\u00a0la\u00a0liste\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0newlist\u00a0=\u00a0[]\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for\u00a0value\u00a0in\u00a0liste:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0newlist.append(BaseEntity.check_value(value))\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0nouvelle\u00a0liste\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0newlist\n</code></pre> <ul> <li>ligne 2\u00a0: la m\u00e9thode re\u00e7oit une liste et rend une liste\u00a0;</li> <li>lignes 5-6\u00a0: on remplace chaque valeur de la liste re\u00e7ue en param\u00e8tre par la valeur rendue par la m\u00e9thode statique [BaseEntity.check_value]. On a donc l\u00e0 un appel r\u00e9cursif. La m\u00e9thode statique [BaseEntity.check_value] est appel\u00e9e jusqu\u2019\u00e0 ce que son param\u00e8tre [value] soit un type simple (pas un type BaseEntity ou list ou dict)\u00a0; La m\u00e9thode statique [BaseEntity.dict2dict] est la suivante\u00a0:</li> </ul> <pre><code>\u00a0\u00a0\u00a0\u00a0@staticmethod\n\u00a0\u00a0\u00a0\u00a0def\u00a0dict2dict(dictionary:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0inspecte\u00a0les\u00a0\u00e9l\u00e9ments\u00a0du\u00a0dictionnaire\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0newdict\u00a0=\u00a0{}\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for\u00a0key,\u00a0value\u00a0in\u00a0dictionary.items():\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0newdict[key]\u00a0=\u00a0BaseEntity.check_value(value)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0nouveau\u00a0dictionnaire\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0newdict\n</code></pre> <ul> <li>ligne 2\u00a0: la m\u00e9thode re\u00e7oit un dictionnaire et rend un dictionnaire\u00a0;</li> <li>lignes 5-6\u00a0: on remplace chaque valeur du dictionnaire re\u00e7u en param\u00e8tre par la valeur rendue par la m\u00e9thode statique [BaseEntity.check_value]. On a donc l\u00e0 un appel r\u00e9cursif. La m\u00e9thode statique [BaseEntity.check_value] est appel\u00e9e jusqu\u2019\u00e0 ce que son param\u00e8tre [value] soit un type simple (pas un type BaseEntity ou list ou dict)\u00a0;</li> </ul>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#13222-exemples","title":"13.2.2.2. Exemples","text":"<p>Le script [asdict_01] montre diverses utilisations de la m\u00e9thode [asdict]\u00a0:</p> <pre><code>#\u00a0on\u00a0configure\u00a0l'application\nimport\u00a0config\nconfig\u00a0=\u00a0config.configure()\n\n#\u00a0le\u00a0syspath\u00a0est\u00a0configur\u00e9\u00a0-\u00a0on\u00a0peut\u00a0faire\u00a0les\u00a0imports\nfrom\u00a0Enseignant\u00a0import\u00a0Enseignant\nfrom\u00a0BaseEntity\u00a0import\u00a0BaseEntity\n\n#\u00a0un\u00a0enseignant\nenseignant1\u00a0=\u00a0Enseignant().fromdict({\"id\":\u00a01,\u00a0\"nom\":\u00a0\"lourou\",\u00a0\"pr\u00e9nom\":\u00a0\"paul\",\u00a0\"\u00e2ge\":\u00a056})\ndict1\u00a0=\u00a0enseignant1.asdict()\nprint(type(dict1))\nprint(enseignant1.__dict__)\nprint(dict1)\nprint(enseignant1.asdict(excluded_keys=[\"_Personne__\u00e2ge\"]))\nEnseignant.excluded_keys\u00a0=\u00a0[\"_Personne__pr\u00e9nom\"]\nprint(enseignant1)\n#\u00a0un\u00a0autre\u00a0enseignant\nenseignant2\u00a0=\u00a0Enseignant().fromdict({\"id\":\u00a02,\u00a0\"nom\":\u00a0\"ab\u00e9lard\",\u00a0\"pr\u00e9nom\":\u00a0\"b\u00e9atrice\",\u00a0\"\u00e2ge\":\u00a057})\nprint(enseignant2.asdict())\nprint(enseignant2.asdict(included_keys=[\"_Personne__nom\"]))\n#\u00a0une\u00a0liste\u00a0d'entit\u00e9s\u00a0dans\u00a0une\u00a0entit\u00e9\nEnseignant.excluded_keys\u00a0=\u00a0[]\nentity1\u00a0=\u00a0BaseEntity()\nenseignants\u00a0=\u00a0[enseignant1,\u00a0enseignant2]\nsetattr(entity1,\u00a0\"enseignants\",\u00a0enseignants)\nprint(entity1.asdict())\n#\u00a0un\u00a0dictionnaire\u00a0d'entit\u00e9s\u00a0dans\u00a0une\u00a0entit\u00e9\nmati\u00e8res\u00a0=\u00a0{\"maths\":\u00a0enseignant1,\u00a0\"fran\u00e7ais\":\u00a0enseignant2}\nsetattr(entity1,\u00a0\"mati\u00e8res\",\u00a0mati\u00e8res)\nprint(entity1.asdict())\n</code></pre> <p>Les r\u00e9sultats de l\u2019ex\u00e9cution sont les suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/02/asdict_01.py\n&lt;class 'dict'&gt;\n{'_BaseEntity__id': 1, '_Personne__nom': 'lourou', '_Personne__pr\u00e9nom': 'paul', '_Personne__\u00e2ge': 56}\n{'id': 1, 'nom': 'lourou', 'pr\u00e9nom': 'paul', '\u00e2ge': 56}\n{'id': 1, 'nom': 'lourou', 'pr\u00e9nom': 'paul'}\n{\"id\": 1, \"nom\": \"lourou\", \"\u00e2ge\": 56}\n{'id': 2, 'nom': 'ab\u00e9lard', '\u00e2ge': 57}\n{'nom': 'ab\u00e9lard'}\n{'enseignants': [{'id': 1, 'nom': 'lourou', 'pr\u00e9nom': 'paul', '\u00e2ge': 56}, {'id': 2, 'nom': 'ab\u00e9lard', 'pr\u00e9nom': 'b\u00e9atrice', '\u00e2ge': 57}]}\n{'enseignants': [{'id': 1, 'nom': 'lourou', 'pr\u00e9nom': 'paul', '\u00e2ge': 56}, {'id': 2, 'nom': 'ab\u00e9lard', 'pr\u00e9nom': 'b\u00e9atrice', '\u00e2ge': 57}], 'mati\u00e8res': {'maths': {'id': 1, 'nom': 'lourou', 'pr\u00e9nom': 'paul', '\u00e2ge': 56}, 'fran\u00e7ais': {'id': 2, 'nom': 'ab\u00e9lard', 'pr\u00e9nom': 'b\u00e9atrice', '\u00e2ge': 57}}}\n\nProcess finished with exit code 0\n</code></pre> <ul> <li>la ligne 4 montre l\u2019int\u00e9r\u00eat de la m\u00e9thode [asdict] vis-\u00e0-vis de l\u2019utilisation de la propri\u00e9t\u00e9 [dict]. Les propri\u00e9t\u00e9s sont d\u00e9barrass\u00e9es du pr\u00e9fixe de leur classe. Cela se pr\u00eate mieux \u00e0 un affichage\u00a0;</li> <li>il y a plusieurs fa\u00e7ons d\u2019utiliser la m\u00e9thode [asdict]\u00a0:</li> <li>on veut toutes les propri\u00e9t\u00e9s\u00a0: on utilise la m\u00e9thode [asdict] sans param\u00e8tres\u00a0;</li> <li>on ne veut que certaines propri\u00e9t\u00e9s\u00a0:</li> <li>il y a plus de propri\u00e9t\u00e9s \u00e0 inclure qu\u2019\u00e0 exclure\u00a0: on utilisera le seul param\u00e8tre [excluded_keys]\u00a0;</li> <li>il y a moins de propri\u00e9t\u00e9s \u00e0 inclure qu\u2019\u00e0 exclure\u00a0: on utilisera le seul param\u00e8tre [included_keys]\u00a0;</li> </ul>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#1323-la-methode-baseentityasjson","title":"13.2.3. La m\u00e9thode [BaseEntity.asjson]","text":"<p>Cette m\u00e9thode permet d\u2019obtenir la cha\u00eene jSON d\u2019un objet [BaseEntity] ou d\u00e9riv\u00e9. Elle affiche la cha\u00eene jSON du dictionnaire rendu par la m\u00e9thode [asdict]. Son code est le suivant\u00a0:</p> <pre><code>def asjson(self, included_keys: list = None, excluded_keys: list = []) -&gt; str:\n        # la cha\u00eene json\n        return json.dumps(self.asdict(included_keys=included_keys, excluded_keys=excluded_keys), ensure_ascii=False)\n</code></pre> <ul> <li>ligne 1\u00a0: les param\u00e8tres de la m\u00e9thode [asjson] sont ceux de la m\u00e9thode [asdict]\u00a0; Voici un exemple (asjson_01) utilisant cette m\u00e9thode\u00a0:</li> </ul> <pre><code>#\u00a0on\u00a0configure\u00a0l'application\nimport\u00a0config\nconfig\u00a0=\u00a0config.configure()\n\n#\u00a0le\u00a0syspath\u00a0est\u00a0configur\u00e9\u00a0-\u00a0on\u00a0peut\u00a0faire\u00a0les\u00a0imports\nfrom\u00a0Enseignant\u00a0import\u00a0Enseignant\nfrom\u00a0BaseEntity\u00a0import\u00a0BaseEntity\n\n#\u00a0un\u00a0enseignant\nenseignant1\u00a0=\u00a0Enseignant().fromdict({\"id\":\u00a01,\u00a0\"nom\":\u00a0\"lourou\",\u00a0\"pr\u00e9nom\":\u00a0\"paul\",\u00a0\"\u00e2ge\":\u00a056})\nprint(type(enseignant1.asjson()))\nprint(enseignant1.asjson(excluded_keys=[\"_Personne__\u00e2ge\"]))\nEnseignant.excluded_keys\u00a0=\u00a0[\"_Personne__pr\u00e9nom\"]\nprint(enseignant1.asjson())\n#\u00a0un\u00a0autre\u00a0enseignant\nenseignant2\u00a0=\u00a0Enseignant().fromdict({\"id\":\u00a02,\u00a0\"nom\":\u00a0\"ab\u00e9lard\",\u00a0\"pr\u00e9nom\":\u00a0\"b\u00e9atrice\",\u00a0\"\u00e2ge\":\u00a057})\nprint(enseignant2.asjson())\nprint(enseignant2.asjson(included_keys=[\"_Personne__nom\"]))\n#\u00a0une\u00a0liste\u00a0d'entit\u00e9s\u00a0dans\u00a0une\u00a0entit\u00e9\nEnseignant.excluded_keys\u00a0=\u00a0[]\nentity1\u00a0=\u00a0BaseEntity()\nenseignants\u00a0=\u00a0[enseignant1,\u00a0enseignant2]\nsetattr(entity1,\u00a0\"enseignants\",\u00a0enseignants)\nprint(entity1.asjson())\n#\u00a0un\u00a0dictionnaire\u00a0d'entit\u00e9s\u00a0dans\u00a0une\u00a0entit\u00e9\nmati\u00e8res\u00a0=\u00a0{\"maths\":\u00a0enseignant1,\u00a0\"fran\u00e7ais\":\u00a0enseignant2}\nsetattr(entity1,\u00a0\"mati\u00e8res\",\u00a0mati\u00e8res)\nprint(entity1.asjson())\n</code></pre> <p>Les r\u00e9sultats sont les suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/02/asjson_01.py\n&lt;class 'str'&gt;\n{\"id\": 1, \"nom\": \"lourou\", \"pr\u00e9nom\": \"paul\"}\n{\"id\": 1, \"nom\": \"lourou\", \"\u00e2ge\": 56}\n{\"id\": 2, \"nom\": \"ab\u00e9lard\", \"\u00e2ge\": 57}\n{\"nom\": \"ab\u00e9lard\"}\n{\"enseignants\": [{\"id\": 1, \"nom\": \"lourou\", \"pr\u00e9nom\": \"paul\", \"\u00e2ge\": 56}, {\"id\": 2, \"nom\": \"ab\u00e9lard\", \"pr\u00e9nom\": \"b\u00e9atrice\", \"\u00e2ge\": 57}]}\n{\"enseignants\": [{\"id\": 1, \"nom\": \"lourou\", \"pr\u00e9nom\": \"paul\", \"\u00e2ge\": 56}, {\"id\": 2, \"nom\": \"ab\u00e9lard\", \"pr\u00e9nom\": \"b\u00e9atrice\", \"\u00e2ge\": 57}], \"mati\u00e8res\": {\"maths\": {\"id\": 1, \"nom\": \"lourou\", \"pr\u00e9nom\": \"paul\", \"\u00e2ge\": 56}, \"fran\u00e7ais\": {\"id\": 2, \"nom\": \"ab\u00e9lard\", \"pr\u00e9nom\": \"b\u00e9atrice\", \"\u00e2ge\": 57}}}\n\nProcess finished with exit code 0\n</code></pre> <p>La m\u00e9thode [BaseEntity.str] utilise la m\u00e9thode [asjson] pour afficher l\u2019identit\u00e9 de l\u2019objet [BaseEntity] ou d\u00e9riv\u00e9\u00a0:</p> <pre><code># toString\n    def __str__(self) -&gt; str:\n        return self.asjson()\n</code></pre>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#1324-la-methode-baseentityfromjson","title":"13.2.4. La m\u00e9thode [BaseEntity.fromjson]","text":"<p>La m\u00e9thode [BaseEntity.fromjson] permet d\u2019initialiser un objet de type [BaseEntity] ou d\u00e9riv\u00e9 \u00e0 partir d\u2019un dictionnaire jSON. Son code est le suivant\u00a0:</p> <pre><code>def fromjson(self, json_state: str, silent: bool = False):\n        # on met \u00e0 jour l'\u00e9tat de l'objet \u00e0 partir de la cha\u00eene jSON\n        return self.fromdict(json.loads(json_state), silent=silent)\n</code></pre> <ul> <li>ligne 1\u00a0: la m\u00e9thode admet deux param\u00e8tres\u00a0:</li> <li>[json_state]\u00a0: le dictionnaire jSON qui va servir \u00e0 initialiser l\u2019objet [BaseEntity]\u00a0;</li> <li>[silent]\u00a0: pour indiquer si la pr\u00e9sence dans le dictionnaire jSON d\u2019une cl\u00e9 qui ne peut \u00eatre accept\u00e9e comme propri\u00e9t\u00e9 de l\u2019objet [BaseEntity] provoque une exception (silent=False) ou est simplement ignor\u00e9e (silent=True)\u00a0;</li> <li>ligne 3\u00a0: on commence par construire le dictionnaire Python image du dictionnaire jSON, puis on utilise la m\u00e9thode [fromdict] pour initialiser l\u2019objet [BaseEntity] \u00e0 partir de ce dictionnaire Python\u00a0; Voici un exemple (fromjson_01)\u00a0:</li> </ul> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom Enseignant import Enseignant\nimport json\n\n# un enseignant\njson1 = json.dumps({\"id\": 1, \"nom\": \"lourou\", \"pr\u00e9nom\": \"paul\", \"\u00e2ge\": 56})\nenseignant1 = Enseignant().fromjson(json1)\nenseignant1.show()\n</code></pre> <ul> <li>ligne 11\u00a0: on cr\u00e9e la cha\u00eene jSON d\u2019un dictionnaire\u00a0;</li> <li>ligne 12\u00a0: un objet [Enseignant] est initialis\u00e9 avec cette cha\u00eene\u00a0;</li> <li>ligne 13\u00a0: l\u2019enseignant est affich\u00e9\u00a0; Les r\u00e9sultats sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/02/fromjson_01.py\nEnseignant[1, paul, lourou, 56]\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-classes-generiques-baseentity-et-myexception.html#1325-le-script-main","title":"13.2.5. Le script [main]","text":"<p>Le script [main] r\u00e9capitule les diff\u00e9rentes m\u00e9thodes rencontr\u00e9es\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom BaseEntity import BaseEntity\nfrom MyException import MyException\n\n\n# une classe\nclass ChildEntity(BaseEntity):\n    # attributs exclus de l'\u00e9tat de la classe\n    excluded_keys = []\n\n    @staticmethod\n    def get_allowed_keys():\n        return [\"att1\", \"att2\", \"att3\", \"att4\"]\n\n    @property\n    def att1(self) -&gt; int:\n        return self.__att1\n\n    @att1.setter\n    def att1(self, value: int):\n        if 10 &gt;= value &gt;= 1:\n            self.__att1 = value\n        else:\n            raise MyException(1, f\"L'attribut [att1] attend une valeur dans l'intervalle [1,10] ({value})\")\n\n\n# configuration ChildEntity\nChildEntity.excluded_keys = []\n# instance ChildEntity\nchild = ChildEntity().fromdict({\"att1\": 1, \"att2\": 2})\n# attention aux noms des propri\u00e9t\u00e9s\n# ce sont ces noms qui sont utilis\u00e9s dans [excluded_keys] et [included_keys]\nprint(child.__dict__)\n# propri\u00e9t\u00e9s non pr\u00e9fix\u00e9es par leur classe\nprint(child)\n\n# instance ChildEntity\ntry:\n    child = ChildEntity().fromdict({\"att1\": 1, \"att5\": 5})\n    print(child)\nexcept MyException as erreur:\n    print(erreur)\n\n# instance ChildEntity\nchild = ChildEntity().fromdict({\"att1\": 1, \"att2\": 2, \"att3\": 3, \"att4\": 4})\nprint(child)\n\n# exclusions de certaines cl\u00e9s de l'\u00e9tat des instances\nChildEntity.excluded_keys = ['att3']\nprint(child)\n\n# on exclut une cl\u00e9 explicitement de l'affichage\n# elle se rajoute \u00e0 celles exclues globalement au niveau de la classe\nprint(child.asdict(excluded_keys=[\"_ChildEntity__att1\"]))\nprint(child.asjson(excluded_keys=[\"att2\"]))\n\n# int\u00e9r\u00eat de la classe vis \u00e0 vis du dictionnaire\n# elle peut v\u00e9rifier la validit\u00e9 de son contenu\ntry:\n    child = ChildEntity().fromdict({\"att1\": 20})\nexcept MyException as erreur:\n    print(erreur)\n\n# instance ChildEntity\nchild1 = ChildEntity().fromdict({\"att1\": 1, \"att2\": 2, \"att3\": 3, \"att4\": 4})\n# instanche ChildEntity contenant une autre instance ChildEntity\nchild2 = ChildEntity().fromdict({\"att1\": 10, \"att2\": 20, \"att3\": 30, \"att4\": child1})\nprint(child2)\n\n# included_keys a priorit\u00e9 sur excluded_keys qui sont alors ignor\u00e9es\nChildEntity.excluded_keys = ['_ChildEntity__att1', 'att2']\nprint(child.asdict(included_keys=[\"_ChildEntity__att1\", \"att3\"], excluded_keys=[\"att3\", \"att4\"]))\n</code></pre> <p>Les r\u00e9sultats de l\u2019ex\u00e9cution sont les suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/classes/02/main.py\n{'_ChildEntity__att1': 1, 'att2': 2}\n{\"att1\": 1, \"att2\": 2}\nMyException[2, la cl\u00e9 [att5] n'est pas autoris\u00e9e]\n{\"att1\": 1, \"att2\": 2, \"att3\": 3, \"att4\": 4}\n{\"att1\": 1, \"att2\": 2, \"att4\": 4}\n{'att2': 2, 'att4': 4}\n{\"att1\": 1, \"att4\": 4}\nMyException[1, L'attribut [att1] attend une valeur dans l'intervalle [1,10] (20)]\n{\"att1\": 10, \"att2\": 20, \"att4\": {\"att1\": 1, \"att2\": 2, \"att4\": 4}}\n{'att1': 1, 'att3': 3}\n\nProcess finished with exit code 0\n</code></pre> <p>On pr\u00eatera attention \u00e0 la ligne 2\u00a0des r\u00e9sultats : c\u2019est la propri\u00e9t\u00e9 [ChildEntity.dict] (ligne 38 du code) qui nous permet de conna\u00eetre les noms des propri\u00e9t\u00e9s \u00e0 mettre dans les listes [included_keys] et [excluded_keys]. On notera, toujours ligne 2 des r\u00e9sultats, que selon que la propri\u00e9t\u00e9 est d\u00e9finie \u00e0 l\u2019int\u00e9rieur de la classe par un getter / setter ou qu\u2019elle a \u00e9t\u00e9 cr\u00e9\u00e9e comme on cr\u00e9erait la cl\u00e9 d\u2019un dictionnaire, elle est ou pas pr\u00e9fix\u00e9e par le nom de la classe [ChildEntity].</p>"},{"location":"les-exceptions.html","title":"5. Les exceptions","text":"<p>Nous nous int\u00e9ressons maintenant aux exceptions.</p> <p></p>"},{"location":"les-exceptions.html#51-script-exceptions_01","title":"5.1. script [exceptions_01]","text":"<p>Le premier script illustre la n\u00e9cessit\u00e9 de g\u00e9rer les exceptions.</p> <pre><code># on provoque volontairement une erreur\nx = 4 / 0\n</code></pre> <p>On provoque volontairement une erreur pour voir ce qui se passe (exceptions-01.py)\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/exceptions/exceptions_01.py\nTraceback (most recent call last):\n  File \"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/exceptions/exceptions_01.py\", line 2, in &lt;module&gt;\n    x = 4 / 0\nZeroDivisionError: division by zero\n\nProcess finished with exit code 1\n</code></pre> <p>La ligne 4 nous donne\u00a0:</p> <ul> <li>le type de l'exception\u00a0: ZeroDivisionError\u00a0;</li> <li>le message d'erreur associ\u00e9\u00a0: division by zero. Il est en anglais. C'est quelque chose qu'on peut vouloir changer. Une r\u00e8gle essentielle est qu'on doit tout faire pour \u00e9viter les exceptions produites par l'interpr\u00e9teur Python. Il nous faut g\u00e9rer les erreurs nous-m\u00eames.</li> </ul> <p>La syntaxe d'une gestion d'exceptions est la suivante\u00a0:</p> <pre><code>try:\n    actions susceptibles de lancer une exception\nexcept (Ex1, Ex2\u2026) as ex:\n    actions de gestion de l'exception [ex]\nexcept (Ex11, Ex12\u2026) as ex:\n    actions de gestion de l'exception [ex]\nfinally:\n   actions toujours ex\u00e9cut\u00e9es qu'il y ait exception ou non\n</code></pre> <p>Dans le try, l'ex\u00e9cution des actions s'arr\u00eate d\u00e8s qu'une exception (erreur) survient. Dans ce cas, l'ex\u00e9cution se poursuit avec les actions de l'une des clauses except\u00a0:</p> <ul> <li>ligne 3\u00a0: si l'exception [ex] qui s'est produite est d'un type appartenant au tuple (Ex1, Ex2\u2026) ou d\u00e9riv\u00e9 de l'un d'eux, alors les actions de la ligne 4 sont ex\u00e9cut\u00e9es\u00a0;</li> <li>ligne 5\u00a0: si l'exception n'a pas \u00e9t\u00e9 intercept\u00e9e par la ligne 3, et qu'une autre clause [except] existe, alors le m\u00eame processus se d\u00e9roule. Etc\u2026\u00a0;</li> <li>il peut y avoir autant de clauses [except] que n\u00e9cessaires pour g\u00e9rer les diff\u00e9rents types d'exception qui peuvent de produire dans le [try]\u00a0;</li> <li>si l'exception n'a \u00e9t\u00e9 trait\u00e9e par aucune des clauses [except] alors elle remontera au code appelant. Si celui-ci est lui-m\u00eame dans une structure try / except, l'exception est de nouveau g\u00e9r\u00e9e sinon elle continue \u00e0 remonter la cha\u00eene des m\u00e9thodes appel\u00e9es. En dernier ressort, elle arrive \u00e0 l'interpr\u00e9teur Python. Celui-ci arr\u00eate alors le programme exc\u00e9cut\u00e9 et affiche un message d'erreur du type montr\u00e9 dans l'exemple pr\u00e9c\u00e9dent. La r\u00e8gle est donc que le programme principal doit arr\u00eater toutes les exceptions qui peuvent remonter des m\u00e9thodes appel\u00e9es\u00a0;</li> <li>ligne 7\u00a0: la clause [finally] est toujours ex\u00e9cut\u00e9e qu'il y ait eu exception (suite du except) ou pas (suite du try). Ceci est vrai m\u00eame si une exception a eu lieu et qu'elle n'a pas \u00e9t\u00e9 intercept\u00e9e. Dans ce cas, la clause [finally] sera ex\u00e9cut\u00e9e avant que l'exception ne remonte au code appelant\u00a0; Une exception transporte avec elle des informations sur l'erreur qui s'est produite. On peut les obtenir avec la syntaxe suivante\u00a0:</li> </ul> <pre><code>except MyException as exception:\n</code></pre> <p>[exception] est l'exception qui s'est produite. [exception.args] repr\u00e9sente le tuple des param\u00e8tres de l'exception.</p> <p>Pour lancer une exception, on utilise la syntaxe</p> <pre><code>raise MyException(param1, param2\u2026)\n</code></pre> <p>o\u00f9 le plus souvent MyException est une classe d\u00e9riv\u00e9e de la classe BaseException. Les param\u00e8tres pass\u00e9s au constructeur de la classe seront disponibles \u00e0 la clause except des structures d'interception des exceptions avec la syntaxe [ex.args] si [ex] est l'exception intercept\u00e9e par la clause [except].</p> <p>Ces concepts sont illustr\u00e9s par le script suivant.</p>"},{"location":"les-exceptions.html#52-script-exceptions_02","title":"5.2. script [exceptions_02]","text":"<p>Le script suivant g\u00e8re explicitement les erreurs\u00a0:</p> <pre><code># gestion des exceptions\nessai = 0\n\n# on provoque une erreur et on la g\u00e8re\nx = 2\ntry:\n    x = 4 / 0\nexcept ZeroDivisionError as erreur:\n    # erreur est l'exception intercept\u00e9e\n    print(f\"essai n\u00b0 {essai} : {erreur}\")\n# la valeur de x n'a pas chang\u00e9\nprint(f\"x={x}\")\n\n# on recommence\nessai += 1\ntry:\n    x = 4 / 0\nexcept BaseException as erreur:\n    # on intercepte l'exception la plus g\u00e9n\u00e9rale\n    # erreur est l'exception intercept\u00e9e\n    print(f\"essai n\u00b0 {essai} : {erreur}\")\n\n# on peut intercepter diff\u00e9rents types d'exceptions\n# l'ex\u00e9cution s'arr\u00eate sur le 1er [except] capable de traiter l'exception\nessai += 1\ntry:\n    x = 4 / 0\nexcept ValueError as erreur:\n    # cette exception ne se produit pas ici\n    print(f\"essai n\u00b0 {essai} : {erreur}\")\nexcept BaseException as erreur:\n    # on intercepte l'exception la plus g\u00e9n\u00e9rale\n    print(f\"essai n\u00b0 {essai} : (Exception) {erreur}\")\nexcept ZeroDivisionError as erreur:\n    # on intercepte un type pr\u00e9cis\n    print(f\"essai n\u00b0 {essai} : (ZeroDivisionError) {erreur}\")\n\n# on recommence en changeant l'ordre \nessai += 1\ntry:\n    x = 4 / 0\nexcept ValueError as erreur:\n    # cette exception ne se produit pas ici\n    print(f\"essai n\u00b0 {essai} : {erreur}\")\nexcept ZeroDivisionError as erreur:\n    # on intercepte un type pr\u00e9cis\n    print(f\"essai n\u00b0 {essai} : (ZeroDivisionError) {erreur}\")\nexcept BaseException as erreur:\n    # on intercepte l'exception la plus g\u00e9n\u00e9rale\n    print(f\"essai n\u00b0 {essai} : (Exception) {erreur}\")\n\n# une clause except sans arguments\nessai += 1\ntry:\n    x = 4 / 0\nexcept:\n    # on ne s'int\u00e9resse pas \u00e0 la nature de l'exception\n    print(f\"essai n\u00b0 {essai} : il y a eu un probl\u00e8me\")\n\n# un autre type d'exception\nessai += 1\ntry:\n    # x ne peut \u00eatre converti en nombre entier\n    x = int(\"x\")\nexcept ValueError as erreur:\n    # erreur est l'exception intercept\u00e9e\n    print(f\"essai n\u00b0 {essai} : {erreur}\")\n\n# une exception transporte des informations dans un tuple accessible au programme\nessai += 1\ntry:\n    x = int(\"x\")\nexcept ValueError as erreur:\n    # erreur est l'exception intercept\u00e9e\n    print(f\"essai n\u00b0 {essai} : {erreur}, param\u00e8tres={erreur.args}\")\n\n# on peut lancer des exceptions\nessai += 1\ntry:\n    raise ValueError(\"param1\", \"param2\", \"param3\")\nexcept ValueError as erreur:\n    # erreur est l'exception intercept\u00e9e\n    print(f\"essai n\u00b0 {essai} : {erreur}, param\u00e8tres={erreur.args}\")\n\n\n# on peut cr\u00e9er ses propres exceptions\n# elles doivent d\u00e9river de la classe [BaseException]\nclass MyError(BaseException):\n    pass\n\n\n# on lance l'exception MyError\nessai += 1\ntry:\n    raise MyError(\"info1\", \"info2\", \"info3\")\nexcept MyError as erreur:\n    # erreur est l'exception intercept\u00e9e\n    print(f\"essai n\u00b0 {essai} : {erreur}, param\u00e8tres={erreur.args}\")\n\n# on lance l'exception MyError avec un msg d'erreur\nessai += 1\ntry:\n    raise MyError(\"mon msg d'erreur\")\nexcept MyError as erreur:\n    # erreur est l'exception intercept\u00e9e\n    print(f\"essai n\u00b0 {essai} : {erreur.args[0]}\")\n\n# la clause finally est toujours ex\u00e9cut\u00e9e\n# qu'il y ait exception ou non\nessai += 1\nx = None\ntry:\n    x = 1\nexcept:\n    # exception\n    print(f\"essai n\u00b0 {essai} : exception\")\nfinally:\n    # ex\u00e9cut\u00e9 dans tous les cas\n    print(f\"essai n\u00b0 {essai} : finally x={x}\")\n\nessai += 1\nx = None\ntry:\n    x = 2 / 0\nexcept:\n    # exception\n    print(f\"essai n\u00b0 {essai} : exception\")\nfinally:\n    # ex\u00e9cut\u00e9 dans tous les cas\n    print(f\"essai n\u00b0 {essai} : finally x={x}\")\n\n# on n'est pas oblig\u00e9s de mettre une clause [except]\nessai += 1\ntry:\n    # on provoque une erreur\n    x = 4 / 0\nfinally:\n    # ex\u00e9cut\u00e9 dans tous les cas\n    print(f\"essai n\u00b0 {essai} : finally x={x}\")\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>lignes 4-12\u00a0: on g\u00e8re une division par z\u00e9ro\u00a0;</li> <li>ligne 8\u00a0: on intercepte l'exception exacte qui se produit et on l'affiche\u00a0;</li> <li>ligne 12\u00a0: \u00e0 cause de l'exception qui s'est produite, x n'a pas re\u00e7u de valeur ligne 7 et n'a donc pas chang\u00e9 de valeur\u00a0;</li> <li>lignes 14-21\u00a0: on refait la m\u00eame chose mais en interceptant une exception de plus haut niveau de type BaseException. Comme l'exception ZeroDivisionError d\u00e9rive de la classe BaseException, la clause except l'arr\u00eatera\u00a0;</li> <li>lignes 23-36\u00a0: on met plusieurs clauses except pour g\u00e9rer plusieurs types d'exception. Une seule clause except sera ex\u00e9cut\u00e9e ou aucune si l'exception ne v\u00e9rifie aucune clause except\u00a0;</li> <li>lignes 38-50\u00a0: on refait la m\u00eame chose en changeant l'ordre des clauses [except] pour montrer le r\u00f4le de celui-ci\u00a0;</li> <li>lignes 52-58\u00a0: la clause except peut n'avoir aucun argument. Dans ce cas, elle arr\u00eate toutes les exceptions\u00a0;</li> <li>lignes 60-67\u00a0: introduisent l'exception ValueError\u00a0;</li> <li>lignes 69-75\u00a0: on r\u00e9cup\u00e8re les informations transport\u00e9es par l'exception\u00a0;</li> <li>lignes 77-83\u00a0: introduisent la fa\u00e7on de lancer (raise) une exception\u00a0;</li> <li>lignes 86-106\u00a0: illustrent l'utilisation d'une classe d'exception propri\u00e9taire MyError. La classe MyError se contente de d\u00e9river la classe de base BaseException. Elle n'ajoute rien \u00e0 sa classe de base. Mais maintenant, elle peut \u00eatre nomm\u00e9e explicitement dans les clauses except\u00a0;</li> <li>lignes 108-130\u00a0: illustrent l'utilisation de la clause finally\u00a0;</li> <li>lignes 132-139\u00a0: ces lignes montrent que la clause [except] n\u2019est pas obligatoire\u00a0; Les r\u00e9sultats \u00e9cran sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/exceptions/exceptions_02.py\nTraceback (most recent call last):\n  File \"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/exceptions/exceptions_02.py\", line 136, in &lt;module&gt;\n    x = 4 / 0\nZeroDivisionError: division by zero\nessai n\u00b0 0 : division by zero\nx=2\nessai n\u00b0 1 : division by zero\nessai n\u00b0 2 : (Exception) division by zero\nessai n\u00b0 3 : (ZeroDivisionError) division by zero\nessai n\u00b0 4 : il y a eu un probl\u00e8me\nessai n\u00b0 5 : invalid literal for int() with base 10: 'x'\nessai n\u00b0 6 : invalid literal for int() with base 10: 'x', param\u00e8tres=(\"invalid literal for int() with base 10: 'x'\",)\nessai n\u00b0 7 : ('param1', 'param2', 'param3'), param\u00e8tres=('param1', 'param2', 'param3')\nessai n\u00b0 8 : ('info1', 'info2', 'info3'), param\u00e8tres=('info1', 'info2', 'info3')\nessai n\u00b0 9 : mon msg d'erreur\nessai n\u00b0 10 : finally x=1\nessai n\u00b0 11 : exception\nessai n\u00b0 11 : finally x=None\nessai n\u00b0 12 : finally x=None\n\nProcess finished with exit code 1\n</code></pre>"},{"location":"les-exceptions.html#53-script-exceptions_03","title":"5.3. script [exceptions_03]","text":"<p>Ce nouveau script illustre la remont\u00e9e des exceptions dans la cha\u00eene des fonctions appelantes\u00a0:</p> <pre><code># une exception propri\u00e9taire\nclass MyError(BaseException):\n    pass\n\n\n# trois fonctions\ndef f1(x: int) -&gt; int:\n    # on ne g\u00e8re pas les exceptions - elles remontent automatiquement\n    return f2(x)\n\n\ndef f2(y: int) -&gt; int:\n    # on ne g\u00e8re pas les exceptions - elles remontent automatiquement\n    return f3(y)\n\n\ndef f3(z: int) -&gt; int:\n    if (z % 2) == 0:\n        # si z est pair, on lance une exception\n        raise MyError(\"exception dans f3\")\n    else:\n        return 2 * z\n\n\n# ---------- main\n\n# les exceptions remontent la cha\u00eene des m\u00e9thodes appel\u00e9es\n# jusqu'\u00e0 ce qu'une m\u00e9thode l'intercepte. Ici ce sera main\ntry:\n    print(f1(4))\nexcept MyError as erreur:\n    print(f\"type : {type(erreur)}, arguments : {erreur.args}\")\n\n\n# trois autres fonctions qui enrichissent les exceptions qu'elle remonte\ndef f4(x: int) -&gt; int:\n    try:\n        return f5(x)\n    except MyError as erreur:\n        # on enrichit l'exception puis on la relance\n        raise MyError(\"exception dans f4\", erreur)\n\n\ndef f5(y: int) -&gt; int:\n    try:\n        return f6(y)\n    except MyError as erreur:\n        # on enrichit l'exception puis on la relance\n        raise MyError(\"exception dans f5\", erreur)\n\n\ndef f6(z: int) -&gt; int:\n    if (z % 2) == 0:\n        # on lance une exception si z est pair\n        raise MyError(\"exception dans f6\")\n    else:\n        return 2 * z\n\n\n# ---------- main\ntry:\n    print(f4(4))\nexcept MyError as erreur:\n    # affichage de l'exception\n    print(f\"type : {type(erreur)}, arguments : {erreur.args}\")\n    # on peut remonter la pile des exceptions\n    err = erreur\n    # on affiche le msg d'erreur\n    print(err.args[0])\n    # une exception est-elle encapsul\u00e9e ?\n    while len(err.args) == 2 and isinstance(err.args[1], BaseException):\n        # changement d'exception\n        err = err.args[1]\n        # le 1er argument est le msg d'erreur\n        print(err.args[0])\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>lignes 25-32, dans l'appel main --&gt; f1 --&gt; f2 --&gt; f3 (ligne 30), l'exception MyError lanc\u00e9e par f3 va remonter jusqu'\u00e0 main. Elle sera alors trait\u00e9e par la clause except de la ligne 31\u00a0;</li> <li>lignes 61-75\u00a0: dans l'appel main --&gt; f4 --&gt; f5 --&gt; f6 (ligne 62), l'exception lanc\u00e9e MyError par f6 va remonter jusqu'\u00e0 main. Elle sera alors trait\u00e9e par la clause except de la ligne 63. Cette fois-ci, dans sa remont\u00e9e de la cha\u00eene des fonctions appelantes, l'exception MyError qui remonte, est elle-m\u00eame encapsul\u00e9e dans une autre exception\u00a0;</li> <li>lignes 66-75\u00a0: montrent comment remonter la pile des exceptions\u00a0;</li> <li>ligne 71\u00a0: la fonction [isinstance(instance, Classe)] rend True si l'objet [instance] est de type [Classe] ou d\u00e9riv\u00e9. Ici, nous avons utilis\u00e9 l'exception de niveau le plus haut [BaseException], ce qui nous assure de r\u00e9cup\u00e9rer toutes les exceptions\u00a0; Les r\u00e9sultats \u00e9cran sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/exceptions/exceptions_03.py\ntype : &lt;class '__main__.MyError'&gt;, arguments : ('exception dans f3',)\ntype : &lt;class '__main__.MyError'&gt;, arguments : ('exception dans f4', MyError('exception dans f5', MyError('exception dans f6')))\nexception dans f4\nexception dans f5\nexception dans f6\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-fichiers-texte.html","title":"7. Les fichiers texte","text":""},{"location":"les-fichiers-texte.html#71-script-fic_01-lecture-ecriture-dun-fichier-texte","title":"7.1. Script [fic_01]\u00a0: lecture / \u00e9criture d'un fichier texte","text":"<p>Le script suivant illustre un exemple d'exploitation de fichiers texte\u00a0:</p> <pre><code># imports\nimport sys\n\n\n# cr\u00e9ation puis exploitation s\u00e9quentielle d'un fichier texte\n# celui-ci est un ensemble de lignes de la forme login:pwd:uid:gid:infos:dir:shell\n# chaque ligne est mis dans un dictionnaire sous la forme login =&gt; uid:gid:infos:dir:shell\n\n# --------------------------------------------------------------------------\ndef affiche_infos(dico: dict, cl\u00e9: str):\n    # affiche la valeur associ\u00e9e \u00e0 cl\u00e9 dans le dictionnaire dico si elle existe\n    if cl\u00e9 in dico.keys():\n        # on affiche la valeur associ\u00e9e \u00e0 la cl\u00e9\n        print(f\"{cl\u00e9} : {dico[cl\u00e9]}\")\n    else:\n        # cl\u00e9 n'est pas une cl\u00e9 du dictionnaire dico\n        print(f\"la cl\u00e9 [{cl\u00e9}] n'existe pas\")\n\n\n# main -----------------------------------------------\n# on fixe le nom du fichier\nFILE_NAME = \"./data/infos.txt\"\n\n# cr\u00e9ation et remplissage du fichier texte\nfic = None\ntry:\n    # ouverture du fichier en \u00e9criture (w=write)\n    fic = open(FILE_NAME, \"w\")\n    # on g\u00e9n\u00e8re un contenu arbitraire\n    for i in range(1, 101):\n        # une ligne\n        ligne = f\"login{i}:pwd{i}:uid{i}:gid{i}:infos{i}:dir{i}:shell{i}\"\n        # est \u00e9crite dans le fichier texte\n        fic.write(f\"{ligne}\\n\")\nexcept IOError as erreur:\n    print(f\"Erreur d'exploitation du fichier {FILE_NAME} : {erreur}\")\n    sys.exit()\nfinally:\n    # on ferme le fichier s'il a \u00e9t\u00e9 ouvert\n    if fic:\n        fic.close()\n\n# on l'ouvre en lecture\nfic = None\ntry:\n    # ouverture du fichier en lecture\n    fic = open(FILE_NAME, \"r\")\n    # dictionnaire vide au d\u00e9part\n    dico = {}\n    # chaque ligne est mis dans le dictionnaire [dico] sous la forme login =&gt; uid:gid:infos:dir:shell\n    # lecture 1\u00e8re ligne en enlevant espaces de d\u00e9but et fin de ligne\n    ligne = fic.readline().strip()\n    # tant que la ligne n'est pas vide\n    while ligne != '':\n        # on met la ligne dans un tableau\n        infos = ligne.split(\":\")\n        # on r\u00e9cup\u00e8re le login\n        login = infos[0]\n        # on n\u00e9glige le pwd\n        infos[0:2] = []\n        # on cr\u00e9e une entr\u00e9e dans le dictionnaire\n        dico[login] = infos\n        # lecture ligne suivante\n        ligne = fic.readline().strip()\nexcept IOError as erreur:\n    print(f\"Erreur d'exploitation du fichier {FILE_NAME} : {erreur}\")\n    sys.exit()\nfinally:\n    # on ferme le fichier s'il a \u00e9t\u00e9 ouvert\n    if fic:\n        fic.close()\n\n# exploitation du dictionnaire dico\naffiche_infos(dico, \"login10\")\naffiche_infos(dico, \"X\")\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>ligne 28\u00a0: ouverture du fichier en \u00e9criture (w=write). Si le fichier existe d\u00e9j\u00e0, il sera \u00e9cras\u00e9\u00a0;</li> <li>lignes 30-34\u00a0: on g\u00e9n\u00e8re 100 lignes dans le fichier texte\u00a0;</li> <li>ligne 34\u00a0: pour \u00e9crire une ligne dans le fichier texte. La m\u00e9thode [write] ne rajoute pas la marque de fin de ligne. Il faut donc pr\u00e9voir celle-ci dans le texte \u00e9crit\u00a0;</li> <li>lignes 35-37\u00a0: gestion de l'\u00e9ventuelle exception\u00a0;</li> <li>ligne 37\u00a0: abandon de l'ex\u00e9cution du script (n\u00e9anmoins apr\u00e8s l'ex\u00e9cution de la clause finally)\u00a0;</li> <li>lignes 38-41\u00a0: dans tous les cas, erreur ou pas, on fermet le fichier s'il est ouvert\u00a0;</li> <li>ligne 47\u00a0: ouverture du fichier en lecture (r=read)\u00a0;</li> <li>ligne 49\u00a0: d\u00e9finition d'un dictionnaire vide\u00a0;</li> <li>ligne 52\u00a0: la m\u00e9thode [readline] lit une ligne de texte, marque de fin de ligne incluse. La m\u00e9thode [strip] supprime les \"espaces\" de d\u00e9but et fin de cha\u00eene. Par \"espace\", il faut entendre caract\u00e8re blanc, marque de fin de ligne, saut de page, tabulation, et quelques autres. Donc ici, [ligne] n'aura pas les caract\u00e8res de fin de ligne [\\r\\n] (windows) ou [\\n] (unix)\u00a0;</li> <li>ligne 54\u00a0: on exploite le fichier tant qu'on n'a pas r\u00e9cup\u00e9r\u00e9 une ligne vide\u00a0;</li> <li>lignes 54-64\u00a0: le fichier texte est transf\u00e9r\u00e9 dans le dictionnaire [dico]. La cl\u00e9 est le champ [login], la valeur les champs [uid:gid:infos:dir:shell]\u00a0;</li> <li>lignes 65-67\u00a0: gestion de l'\u00e9ventuelle exception\u00a0;</li> <li>lignes 68-71\u00a0: fermeture du fichier dans tous les cas, erreur ou pas\u00a0;</li> <li>lignes 74-75\u00a0: exploitation du dictionnaire [dico]\u00a0; Le fichier [data/infos.txt]\u00a0:</li> </ul> <pre><code>login0:pwd0:uid0:gid0:infos0:dir0:shell0\nlogin1:pwd1:uid1:gid1:infos1:dir1:shell1\nlogin2:pwd2:uid2:gid2:infos2:dir2:shell2\n\u2026\nlogin98:pwd98:uid98:gid98:infos98:dir98:shell98\nlogin99:pwd99:uid99:gid99:infos99:dir99:shell99\n</code></pre> <p>Les r\u00e9sultats \u00e9cran\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fichiers/fic_01.py\nlogin10 : ['uid10', 'gid10', 'infos10', 'dir10', 'shell10']\nla cl\u00e9 [X] n'existe pas\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-fichiers-texte.html#72-script-fic_02-gerer-des-fichiers-texte-encodes-en-utf-8","title":"7.2. Script [fic_02]\u00a0: g\u00e9rer des fichiers texte encod\u00e9s en UTF-8","text":"<p>Dans la suite du document, nous allons g\u00e9rer des fichiers texte cod\u00e9s uniquement en UTF-8. Nous allons tout d'abord configurer PyCharm\u00a0:</p> <p></p> <ul> <li>en [5-6]\u00a0: choisir l'encodage UTF-8 pour les fichiers du projet\u00a0; Pour cr\u00e9er un fichier encod\u00e9 en UTF-8, on pourra proc\u00e9der comme suit (fic-02)\u00a0:</li> </ul> <pre><code># imports\nimport codecs\n\n# \u00e9criture utf8 dans un fichier texte\n# on ne g\u00e8re pas les exceptions\nfile=codecs.open(\"./data/utf8.txt\",\"w\",\"utf8\")\nfile.write(\"H\u00e9l\u00e8ne est partie \u00e0 B\u00e2le pendant l'\u00e9t\u00e9 chez sa grand-m\u00e8re\")\nfile.close()\n</code></pre> <p>Notes</p> <ul> <li>ligne 2\u00a0: pour g\u00e9rer l'encodage des fichiers, on importe le module [codecs]\u00a0;</li> <li>ligne 6\u00a0: la m\u00e9thode [codecs.open] s'utilise comme la classique fonction [open]. On peut cependant pr\u00e9ciser l'encodage souhait\u00e9 (cr\u00e9ation) ou existant (lecture). Apr\u00e8s l'ouverture, l'objet [file] obtenu ligne 6, s'utilise comme un fichier classique\u00a0;</li> <li>ligne 7\u00a0: on a utilis\u00e9 des caract\u00e8res accentu\u00e9s qui ont la plupart du temps des repr\u00e9sentations diff\u00e9rentes selon le code de caract\u00e8res utilis\u00e9\u00a0; R\u00e9sultats</li> </ul> <p>Lorsqu'on ouvre le fichier [data/utf8.txt] obtenu (cf. ligne 6), on obtient le r\u00e9sultat suivant\u00a0:</p> <p></p>"},{"location":"les-fichiers-texte.html#73-script-fic_03-gerer-des-fichiers-texte-encodes-en-iso-8859-1","title":"7.3. Script [fic_03]\u00a0: g\u00e9rer des fichiers texte encod\u00e9s en ISO-8859-1","text":"<p>Le script [fic_03] fait la m\u00eame chose que le script [fic_02] mais code le fichier texte en ISO-8859-1. On veut montrer la diff\u00e9rence des fichiers obtenus\u00a0:</p> <pre><code># imports\nimport codecs\n\n# \u00e9criture iso-8859-1 dans un fichier texte\n# on ne g\u00e8re pas les exceptions\nfile=codecs.open(\"./data/iso-8859-1.txt\",\"w\",\"iso-8859-1\")\nfile.write(\"H\u00e9l\u00e8ne est partie \u00e0 B\u00e2le pendant l'\u00e9t\u00e9 chez sa grand-m\u00e8re\")\nfile.close()\n</code></pre> <p>Lorsqu'on ouvre le fichier [data/iso-8859-1] cr\u00e9\u00e9 ligne 6, on obtient le r\u00e9sultat suivant\u00a0:</p> <p></p> <p>Parce que nous avons configur\u00e9 le projet pour fonctionner avec des fichiers UTF-8, PyCharm a essay\u00e9 d'ouvrir le fichier [iso-8859-1.txt] en UTF-8. Il est capable de voir [1] que le fichier n'est pas du UTF-8. Il propose alors [2] de recharger le fichier dans un autre encodage\u00a0:</p> <p></p> <ul> <li>en [3-5]\u00a0: on recharge le fichier en utilisant un codage ISO-8859-1\u00a0;</li> </ul> <p></p> <ul> <li>en [6], le m\u00eame fichier mais affich\u00e9 avec un encodage diff\u00e9rent\u00a0; Si on retourne dans les param\u00e9trages du projet\u00a0:</li> </ul> <p></p> <ul> <li>on voit qu'en [6-7], Pycharm a not\u00e9 le fait que le fichier [iso-8859-1.txt] devait \u00eatre ouvert avec un encodage ISO-8859-1. C'est donc une exception \u00e0 la r\u00e8gle [5]\u00a0;</li> </ul>"},{"location":"les-fichiers-texte.html#74-script-json_01-gestion-dun-fichier-json","title":"7.4. Script [json_01]\u00a0: gestion d'un fichier jSON","text":"<p>JSON signifie JavaScript Object Notation. Comme son nom l'indique c'est un mode de repr\u00e9sentation texte des objets du langage Javascript. Nous l'utiliserons ici avec des objets Python.</p> <p>Le fichier jSON g\u00e9r\u00e9 [data/in.json] sera le suivant\u00a0:</p> <p></p> <ul> <li>en [2], on voit que le contenu texte du fichier [in.json] pourrait repr\u00e9senter un dictionnaire Python. PyCharm a mis en forme (Ctrl-Alt-L) ce texte mais il serait sur une ligne que \u00e7a ne changerait rien. La forme du texte n'a aucune importance tant qu'il repr\u00e9sente syntaxiquement un objet Python\u00a0; Le script [json-01] montre comment exploiter ce fichier\u00a0:</li> </ul> <pre><code># imports\nimport codecs\nimport json\nimport sys\n\n# lecture / \u00e9criture d'un fichier jSON\ninFile=None\noutFile=None\ntry:\n    # ouverture du fichier jSON en lecture\n    inFile = codecs.open(\"./data/in.json\", \"r\", \"utf8\")\n    # transfert du contenu dans un dictionnaire\n    data = json.load(inFile)\n    # affichage des donn\u00e9es lues\n    print(f\"data={data}, type(data)={type(data)}\")\n    limites = data['limites']\n    print(f\"limites={limites}, type(limites)={type(limites)}\")\n    print(f\"limites[1]={limites[1]}, type(limites[1])={type(limites[1])}\")\n    # transfert du dictionnaire [data] dans un fichier json\n    outFile = codecs.open(\"./data/out.json\", \"w\", \"utf8\")\n    json.dump(data, outFile)\nexcept BaseException as erreur:\n    # on affiche l'erreur et on quitte\n    print(f\"L'erreur suivante s'est produite\u00a0: {erreur}\")\n    sys.exit()\nfinally:\n    # fermeture des fichiers s'ils sont ouverts\n    if inFile:\n        inFile.close()\n    if outFile:\n        outFile.close()\n</code></pre> <p>Notes</p> <ul> <li>ligne 3\u00a0: pour g\u00e9rer du JSON, on importe le module [json]\u00a0;</li> <li>ligne 11\u00a0: nous allons g\u00e9rer des fichiers jSON cod\u00e9s en UTF-8. Ici on ouvre le fichier [data/in.json] avec le module [codecs]\u00a0;</li> <li>ligne 13\u00a0: la m\u00e9thode [json.load] lit le contenu du fichier jSON et le met dans la variable [data]. Le type de cette variable sera ici un dictionnaire\u00a0;</li> <li>lignes 15-18\u00a0: pour montrer qu'on a bien obtenu un dictionnaire Python, on fait quelques affichages d'\u00e9l\u00e9ments de celui-ci\u00a0;</li> <li>lignes 20-21\u00a0: on fait l'op\u00e9ration inverse\u00a0: le dictionnaire [data] est mis dans un fichier cod\u00e9 en UTF-8 gr\u00e2ce \u00e0 la m\u00e9thode [json.dump]\u00a0;</li> <li>lignes 22-25\u00a0: gestion de l'\u00e9ventuelle exception\u00a0;</li> <li>lignes 26-31\u00a0: dans tous les cas, erreur ou pas, on ferme les fichiers qui ont pu \u00eatre ouverts\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fichiers/json_01.py\ndata={'limites': [9964, 27519, 73779, 156244, 0], 'coeffR': [0, 0.14, 0.3, 0.41, 0.45], 'coeffN': [0, 1394.96, 5798, 13913.69, 20163.45], 'PLAFOND_QF_DEMI_PART': 1551, 'PLAFOND_REVENUS_CELIBATAIRE_POUR_REDUCTION': 21037, 'PLAFOND_REVENUS_COUPLE_POUR_REDUCTION': 42074, 'VALEUR_REDUC_DEMI_PART': 3797, 'PLAFOND_DECOTE_CELIBATAIRE': 1196, 'PLAFOND_DECOTE_COUPLE': 1970, 'PLAFOND_IMPOT_COUPLE_POUR_DECOTE': 2627, 'PLAFOND_IMPOT_CELIBATAIRE_POUR_DECOTE': 1595, 'ABATTEMENT_DIXPOURCENT_MAX': 12502, 'ABATTEMENT_DIXPOURCENT_MIN': 437}, type(data)=&lt;class 'dict'&gt;\nlimites=[9964, 27519, 73779, 156244, 0], type(limites)=&lt;class 'list'&gt;\nlimites[1]=27519, type(limites[1])=&lt;class 'int'&gt;\n\nProcess finished with exit code 0\n</code></pre> <ul> <li>les lignes 2-4 montrent qu'on a correctement r\u00e9cup\u00e9r\u00e9 le dictionnaire pr\u00e9sent dans le fichier jSON\u00a0; Maintenant, regardons le contenu du fichier [data/out.json]\u00a0:</li> </ul> <p></p> <p>Le texte du fichier est sur une ligne. Cependant PyCharm reconna\u00eet les fichiers jSON et on peut les formater, comme les fichiers Python et d'autres par Ctrl-Alt-L. On obtient alors la chose suivante\u00a0:</p> <p></p>"},{"location":"les-fichiers-texte.html#75-script-json_02-gestion-des-fichiers-json-codes-en-utf-8","title":"7.5. Script [json_02]\u00a0: gestion des fichiers jSON cod\u00e9s en UTF-8","text":"<p>Un fichier jSON cod\u00e9 en UTF-8 peut avoir deux formes\u00a0:</p> <pre><code># imports\nimport codecs\nimport json\nimport sys\n\n# dictionnaire\ndata = {'mari\u00e9': 'oui', 'imp\u00f4t': 1340}\n\n# \u00e9criture d'un fichier jSON\nout_file1 = None\nout_file2 = None\ntry:\n    # transfert du dictionnaire [data] dans un fichier json\n    out_file1 = codecs.open(\"./data/out1.json\", \"w\", \"utf8\")\n    json.dump(data, out_file1, ensure_ascii=True)\n    # transfert du dictionnaire [data] dans un fichier json\n    out_file2 = codecs.open(\"./data/out2.json\", \"w\", \"utf8\")\n    json.dump(data, out_file2, ensure_ascii=False)\nexcept BaseException as erreur:\n    # on affiche l'erreur et on quitte\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\n    sys.exit()\nfinally:\n    # fermeture des fichiers s'ils sont ouverts\n    if out_file1:\n        out_file1.close()\n    if out_file2:\n        out_file2.close()\n\u2026\n</code></pre> <ul> <li>dans ce script, on \u00e9crit le dictionnaire [data] (ligne 7) dans deux fichiers jSON (lignes 14, 17)\u00a0;</li> <li>lignes 14, 17\u00a0: dans les deux cas, on cr\u00e9e un fichier texte UTF-8\u00a0;</li> <li>lignes 15\u00a0: lors de l'\u00e9criture du dictionnaire, on utilise le param\u00e8tre nomm\u00e9 [ensure_ascii=True]\u00a0;</li> <li>lignes 18\u00a0: lors de l'\u00e9criture du dictionnaire, on utilise le param\u00e8tre nomm\u00e9 [ensure_ascii=False]\u00a0; Voici les deux fichiers obtenus\u00a0:</li> </ul> <p></p> <ul> <li>dans le fichier [out1.json], les caract\u00e8res accentu\u00e9s ont \u00e9t\u00e9 remplac\u00e9s par une s\u00e9rie de caract\u00e8res repr\u00e9sentant leur code UTF-8. On dit parfois qu'ils ont \u00e9t\u00e9 '\u00e9chapp\u00e9s'. Techniquement, dans le binaire de [out1.json], on trouve pour le caract\u00e8re \u00e9 de [mari\u00e9] successivement les codes binaires UTF-8 des 6 caract\u00e8res [\\u00e9]\u00a0;</li> <li>dans le fichier [out2.json], les caract\u00e8res accentu\u00e9s ont \u00e9t\u00e9 laiss\u00e9s tels quels. Cela signifie que dans le binaire de [out2.json] ces caract\u00e8res sont repr\u00e9sent\u00e9s par leur code binaire UTF-8 (1 seul code UTF-8 donc au lieu de 6 pour out1). Pour le caract\u00e8re \u00e9 de [mari\u00e9], on trouvera ainsi le code binaire [00e9] sur 4 octets\u00a0;</li> <li>c'est la valeur du param\u00e8tre [ensure_ascii] de la m\u00e9thode [json.dump] qui d\u00e9cide du format utilis\u00e9\u00a0; Certaines applications utilisent de l'UTF-8 '\u00e9chapp\u00e9' pour leurs fichiers jSON. C'est la valeur [ensure_ascii=True] qui doit \u00eatre alors utilis\u00e9e. Cette valeur est en fait la valeur par d\u00e9faut. Si donc on n'utilise pas le param\u00e8tre [ensure_ascii] on travaillera avec des fichiers jSON UTF-8 \u00e9chapp\u00e9s.</li> </ul> <p>Le script se poursuit de la fa\u00e7on suivante\u00a0:</p> <pre><code># imports\nimport codecs\nimport json\nimport sys\n\n# dictionnaire\ndata = {'mari\u00e9': 'oui', 'imp\u00f4t': 1340}\n\n\u2026\n\n# relecture des fichiers jSON\nin_file1 = None\nin_file2 = None\ntry:\n    # transfert du fichier jSON 1 dans un dictionnaire\n    in_file1 = codecs.open(\"./data/out1.json\", \"r\", \"utf8\")\n    dico1 = json.load(in_file1)\n    # affichage\n    print(f\"dico1={dico1}\")\n    # transfert du fichier jSON 2 dans un dictionnaire\n    in_file2 = codecs.open(\"./data/out2.json\", \"r\", \"utf8\")\n    dico2 = json.load(in_file2)\n    # affichage\n    print(f\"dico2={dico2}\")\nexcept BaseException as erreur:\n    # on affiche l'erreur et on quitte\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\n    sys.exit()\nfinally:\n    # fermeture des fichiers s'ils sont ouverts\n    if in_file1:\n        in_file1.close()\n    if in_file2:\n        in_file2.close()\n</code></pre> <p>Notes</p> <ul> <li>lignes 11-34\u00a0: relecture des deux fichiers [out1.json, out2.json] et affichage du dictionnaire lu dans chacun des cas\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fichiers/json_02.py\ndico1={'mari\u00e9': 'oui', 'imp\u00f4t': 1340}\ndico2={'mari\u00e9': 'oui', 'imp\u00f4t': 1340}\n\nProcess finished with exit code 0\n</code></pre> <p>De fa\u00e7on surprenante, on constate qu'on n'a pas eu besoin de pr\u00e9ciser \u00e0 la fonction [json.load] (lignes 17, 22) le type d'encodage (\u00e9chapp\u00e9 ou non) de la cha\u00eene jSON \u00e0 lire. On r\u00e9cup\u00e8re dans les deux cas le bon dictionnaire.</p>"},{"location":"les-fonctions.html","title":"6. Les fonctions","text":""},{"location":"les-fonctions.html#61-script-fonc_01-portee-des-variables","title":"6.1. Script [fonc_01]\u00a0: port\u00e9e des variables","text":"<p>Le script [fonc_01] montre des exemples de port\u00e9e de variables entre fonctions\u00a0:</p> <pre><code># port\u00e9e des variables\ndef f1():\n    # l'utilisation de variables globales est \u00e0 \u00e9viter\n    # variable globale i\n    global i\n    i += 1\n    # variable locale j\n    j = 10\n    print(f\"f1[i,j]=[{i},{j}]\")\n\n\ndef f2():\n    # l'utilisation de variables globales est \u00e0 \u00e9viter\n    # variable globale i\n    global i\n    i += 1\n    # variable locale j\n    j = 20\n    print(f\"f2[i,j]=[{i},{j}]\")\n\n\ndef f3():\n    # variable locale i\n    i = 1\n    # variable locale j\n    j = 30\n    print(f\"f3[i,j]=[{i},{j}]\")\n\n\n# programme principal\ni = 0\nj = 0\n# ces deux variables ne seront connues d'une fonction f\n# que si celle-ci d\u00e9clare explicitement par l'instruction global qu'elle veut les utiliser\n# ou que la fonction n\u2019utilise la variable globale qu\u2019en lecture\nf1()\nf2()\nf3()\n# j n'a pas chang\u00e9 mais i a chang\u00e9\nprint(f\"[i,j]=[{i},{j}]\")\n</code></pre> <p>R\u00e9sultats</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fonctions/fonc_01.py\nf1[i,j]=[1,10]\nf2[i,j]=[2,20]\nf3[i,j]=[1,30]\n[i,j]=[2,0]\n\nProcess finished with exit code 0\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>le script montre l'utilisation de la variable i, d\u00e9clar\u00e9e globale dans les fonctions f1 et f2. Dans ce cas, le programme principal et les fonctions f1 et f2 partagent la m\u00eame variable i.</li> </ul>"},{"location":"les-fonctions.html#62-script-fonc_02-portee-des-variables","title":"6.2. Script [fonc_02]\u00a0: port\u00e9e des variables","text":"<p>Le script [fonc_03] reprend le script [fonc_02] et montre comment \u00e9viter l'usage de variables globales\u00a0:</p> <pre><code># port\u00e9e des variables\ndef f1(i):\n    # variable locale i\n    i += 1\n    # variable locale j\n    j = 10\n    print(f\"f1[i,j]=[{i},{j}]\")\n    # on rend la valeur modifi\u00e9e\n    return i\n\n\ndef f2(i):\n    # variable locale i\n    i += 1\n    # variable locale j\n    j = 20\n    print(f\"f2[i,j]=[{i},{j}]\")\n    # on rend la valeur modifi\u00e9e\n    return i\n\n\ndef f3():\n    # variable locale i\n    i = 1\n    # variable locale j\n    j = 30\n    print(f\"f3[i,j]=[{i},{j}]\")\n\n\n# programme principal\ni = 0\nj = 0\n# ces deux variables ne seront connues d'une fonction f\n# que si celle-ci d\u00e9clare explicitement par l'instruction global qu'elle veut les utiliser\n# ou si la fonction n\u2019utilise la variable globale qu\u2019en lecture\ni = f1(i)\ni = f2(i)\nf3()\n# j n'a pas chang\u00e9 mais i a chang\u00e9\nprint(f\"[i,j]=[{i},{j}]\")\n</code></pre> <p>Commentaires\u00a0:</p> <ul> <li>lignes 2, 12\u00a0: au lieu d'\u00eatre d\u00e9clar\u00e9e globale, la variable [i] est pass\u00e9e en param\u00e8tre aux fonctions f1 et f2\u00a0;</li> <li>lignes 9, 19\u00a0: les fonctions f1 et f2 rendent la variable [i] modifi\u00e9e au programme principal. Celui-ci la r\u00e9cup\u00e8re aux lignes 36 et 37\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fonctions/fonc_02.py\nf1[i,j]=[1,10]\nf2[i,j]=[2,20]\nf3[i,j]=[1,30]\n[i,j]=[2,0]\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-fonctions.html#63-script-fonc_03-portee-des-variables","title":"6.3. Script [fonc_03]\u00a0: port\u00e9e des variables","text":"<p>Le script [fonc_03] montre une particularit\u00e9 des variables utilis\u00e9es \u00e0 la fois dans une fonction et dans le code appelant celle-ci, selon que dans la fonction cette variable est utilis\u00e9e uniquement en lecture ou non.</p> <pre><code>def f1():\n    # ici la variable globale i est connue\n    print(f\"[f1] i={i}\")\n    # ici la variable globale j est connue\n    print(f\"[f1] j={j}\")\n\n\ndef f2():\n    # ici la variable globale i n'est pas connue\n    # car la fonction f2 d\u00e9finit une variable locale de m\u00eame nom\n    # c'est alors elle qui a priorit\u00e9\n    try:\n        # essai d'affichage de la variable locale i d\u00e9finie plus loin\n        print(f\"[f2] i={i}\")\n        # l'instruction qui suit fait de i une variable locale de la fonction f2\n        i = 7\n    except BaseException as erreur:\n        print(f\"[f2] erreur={erreur}\")\n\n\ndef f3():\n    # ici la variable globale i n'est pas connue\n    # car la fonction f3 d\u00e9finit une variable locale de m\u00eame nom\n    # c'est alors elle qui a priorit\u00e9\n\n    # l'instruction qui suit fait de i une variable locale\n    i = 7\n    # affichage - ici i est connue\n    print(f\"[f3] i={i}\")\n\n\n# main -----------\n# variables globales aux fonctions\ni = 10\nj = 20\n# appel de f1\nf1()\nprint(f\"[main] i={i}, j={j}\")\n# appel de f2\nf2()\nprint(f\"[main] i={i}\")\n# appel de f3\nf3()\nprint(f\"[main] i={i}\")\n</code></pre> <p>Notes</p> <ul> <li>ligne 34\u00a0: le code principal d\u00e9finit une variable [i]\u00a0;</li> <li>lignes 1-5\u00a0: la fonction f1 utilise \u00e9galement une variable [i] sans lui donner de valeur. C'est une lecture de la variable [i]. Dans ce cas, la variable [i] utilis\u00e9e est celle du code appelant, ligne 34\u00a0;</li> <li>lignes 8-18\u00a0: la fonction f2 utilise \u00e9galement une variable [i] mais lui donne une valeur ligne 16. Le fait de donner une valeur \u00e0 la variable [i] dans f2 fait automatiquement de [i] une variable locale \u00e0 la fonction [f2]. Celle-ci 'cache' donc la variable [i] du code appelant\u00a0;</li> <li>ligne 14\u00a0: l'op\u00e9ration d'\u00e9criture de la variable locale [i] va \u00e9chouer car celle-ci n'a pas de valeur lorsqu'on arrive \u00e0 la ligne 14. Elle obtient sa valeur ligne 16.  Il va se produire une exception. Pour cette raison, on a ins\u00e9r\u00e9 la ligne 14 dans un try / catch\u00a0;</li> <li>lignes 21-29\u00a0: la fonction f3 fait la m\u00eame chose que la fonction f2 mais d\u00e9finit plus t\u00f4t sa variable locale [i]\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fonctions/fonc_03.py\n[f1] i=10\n[f1] j=20\n[main] i=10, j=20\n[f2] erreur=local variable 'i' referenced before assignment\n[main] i=10\n[f3] i=7\n[main] i=10\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-fonctions.html#64-script-fonc_04-mode-de-passage-des-parametres","title":"6.4. Script [fonc_04]\u00a0: mode de passage des param\u00e8tres","text":"<p>Le script est le suivant\u00a0:</p> <pre><code># fonction f1\ndef f1(a):\n    a = 2\n\n\n# fonction f2\ndef f2(a, b):\n    a = 2\n    b = 3\n    return a, b\n\n\n# ------------------------ main\nx = 1\nf1(x)\nprint(f\"x={x}\")\n(x, y) = (-1, -1)\n(x, y) = f2(x, y)\nprint(f\"x={x}, y={y}\")\n</code></pre> <p>R\u00e9sultats</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fonctions/fonc_04.py\nx=1\nx=2, y=3\n\nProcess finished with exit code 0\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>tout est objet en Python. Certains objets sont dits \"immutable\" (en anglais)\u00a0: on ne peut pas les modifier. C'est le cas des nombres, des cha\u00eenes de caract\u00e8res, des tuples. Lorsque des objets Python sont pass\u00e9s en param\u00e8tres \u00e0 des fonctions, ce sont leur r\u00e9f\u00e9rences qui sont pass\u00e9es sauf si ces objets sont \"immutable\" auquel cas, c'est la valeur de l'objet qui est pass\u00e9e\u00a0;</li> <li>les fonctions f1 (ligne 2), et f2 (ligne 7) veulent illustrer le passage d'un param\u00e8tre de sortie. On veut que le param\u00e8tre effectif d'une fonction soit modifi\u00e9 par la fonction\u00a0;</li> <li>lignes 2-3\u00a0: la fonction f1 modifie son param\u00e8tre formel a. On veut savoir si le param\u00e8tre effectif va lui aussi \u00eatre modifi\u00e9\u00a0;</li> <li>lignes 14-15\u00a0: le param\u00e8tre effectif est x=1. La ligne 2 des r\u00e9sultats, montre que le param\u00e8tre effectif n'est pas modifi\u00e9. Ainsi le param\u00e8tre effectif x et le param\u00e8tre formel a sont deux objets diff\u00e9rents\u00a0;</li> <li>lignes 8-10\u00a0: la fonction f2 modifie ses param\u00e8tres formels a et b, et les rend comme r\u00e9sultats\u00a0;</li> <li>lignes 17-18\u00a0: on passe \u00e0 f2 les param\u00e8tres effectifs (x,y) et le r\u00e9sultat de f2 est remis dans (x,y). La ligne 3 des r\u00e9sultats montre que les param\u00e8tres effectifs (x,y) ont \u00e9t\u00e9 modifi\u00e9s. On en conclut que lorsqu'on des objets \"immutable\" sont des param\u00e8tres de sortie, il faut qu'ils fassent partie des r\u00e9sultats renvoy\u00e9s par la fonction.</li> </ul>"},{"location":"les-fonctions.html#65-script-fonc_05-ordre-decriture-des-fonctions-dans-un-script","title":"6.5. Script [fonc_05]\u00a0: ordre d'\u00e9criture des fonctions dans un script","text":"<p>Le script [fonc_05] montre qu'on ne peut appeler une fonction si elle n'a pas \u00e9t\u00e9 pr\u00e9c\u00e9demment rencontr\u00e9e dans le code\u00a0:</p> <pre><code># ------------------------ main\nprint(f2(100, 200))\n\n# fonction f1\ndef f1(a):\n    return a + 10\n\n\n# fonction f2\ndef f2(a, b):\n    return f1(a + b)\n</code></pre> <p>Notes</p> <ul> <li>la ligne 2 va provoquer une erreur parce qu'elle utilise la fonction f2 qui n'a pas encore \u00e9t\u00e9 d\u00e9finie dans le script\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fonctions/fonc_05.py\nTraceback (most recent call last):\n  File \"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fonctions/fonc_05.py\", line 2, in &lt;module&gt;\n    print(f2(100, 200))\nNameError: name 'f2' is not defined\n\nProcess finished with exit code 1\n</code></pre>"},{"location":"les-fonctions.html#66-script-fonc_06-ordre-decriture-des-fonctions-dans-un-script","title":"6.6. Script [fonc_06]\u00a0: ordre d'\u00e9criture des fonctions dans un script","text":"<p>Le script [fonc_06] montre que ce qui vaut pour le code appelant ne vaut pas pour les fonctions\u00a0:</p> <pre><code># fonction f2\ndef f2(a, b):\n    return f1(a + b)\n\n\n# fonction f1\ndef f1(a):\n    return a + 10\n\n\n# ------------------------ main\nprint(f2(100, 200))\n</code></pre> <p>Notes</p> <ul> <li>ligne 3\u00a0: la fonction [f2] utilise la fonction [f1] d\u00e9finie plus loin dans le script. Cela ne provoque cependant pas d'erreur. On peut donc en conclure que l'ordre de d\u00e9finition des fonctions dans un script Python n'a pas d'importance\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fonctions/fonc_06.py\n310\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-fonctions.html#67-script-fonc_07-utilisation-de-modules","title":"6.7. Script [fonc_07]\u00a0: utilisation de modules","text":"<p>Le script [fonc_07] montre comment isoler les fonctions dans un module.</p> <p></p> <p>Nous isolons dans un module des fonctions r\u00e9utilisables. Plut\u00f4t que de les transporter d'un script \u00e0 l'autre\u00a0:</p> <ul> <li>on les place dans un fichier \u00e0 part que l'on d\u00e9clare d'une fa\u00e7on particuli\u00e8re\u00a0;</li> <li>les scripts ayant besoin de ces fonctions 'importe' le module qui les contient\u00a0; Le script [fonctions_module_01] est le suivant\u00a0:</li> </ul> <pre><code>#\u00a0fonction\u00a0f2\ndef\u00a0f2(a,\u00a0b):\n\u00a0\u00a0\u00a0\u00a0return\u00a0f1(a\u00a0+\u00a0b)\n\n#\u00a0fonction\u00a0f1\ndef\u00a0f1(a):\n\u00a0\u00a0\u00a0\u00a0return\u00a0a\u00a0+\u00a010\n</code></pre> <p>Pour que les fonctions du script [fonctions_module_01] puissent \u00eatre r\u00e9f\u00e9renc\u00e9es par d'autres scripts, il y a diff\u00e9rentes fa\u00e7ons de faire. Elles diff\u00e8rent selon qu'on ex\u00e9cute ou non le script \u00e0 l'int\u00e9rieur de [PyCharm].</p> <p>Sous [PyCharm] les modules import\u00e9s sont cherch\u00e9s dans des dossiers pr\u00e9cis appel\u00e9s [Sources Root]. Il y a deux fa\u00e7ons de faire d'un dossier un [Sources Root]\u00a0:</p> <p></p> <ul> <li>en [4], le dossier a chang\u00e9 de couleur\u00a0; Apr\u00e8s cette op\u00e9ration, le dossier [fonctions/modules] est reconnu comme un dossier source. On peut alors \u00e9crire dans un script\u00a0:</li> </ul> <pre><code>from fonctions_module_01 import f2\n</code></pre> <p>Pour importer / utiliser la fonction f2 d\u00e9finie dans le module [fonctions_module_01.py].</p> <p>Une autre m\u00e9thode est de passer par les propri\u00e9t\u00e9s du projet\u00a0:</p> <p></p> <ul> <li>ci-dessus, la s\u00e9quence [1-6] permet de faire du dossier [shared] un dossier o\u00f9 ranger des modules \u00e0 importer\u00a0; Nous n'allons pour l\u2019instant d\u00e9clarer aucun dossier comme [Sources Root] \u00e0 part la racine du projet\u00a0:</li> </ul> <p></p> <p>Ceci fait, on peut \u00e9crire le script [fonc-07] suivant\u00a0:</p> <pre><code># utilisation de modules\nimport sys\n\n# ------------------------ main\nprint(f\"Python path={sys.path}\")\nfrom fonctions.shared.fonctions_module_01 import f2\n\nprint(f2(100, 200))\n</code></pre> <ul> <li>ligne 2\u00a0: on importe l'objet [sys] pour pouvoir utiliser ligne 5, son attribut [path] qui donne, ce qu'on appelle le [Python Path]\u00a0: une liste de dossiers qui seront explor\u00e9s \u00e0 la recherche de modules import\u00e9s\u00a0;</li> <li>ligne 6\u00a0: on importe la fonction f2 du module [fonctions_module_01]. Pour d\u00e9signer ce module, on utilise le chemin qui m\u00e8ne de la racine du projet au module. Avec Pycharm, la racine du projet fait toujours partie des dossiers explor\u00e9s lorsqu'est cherch\u00e9 un module import\u00e9 dans un script. Ce dossier fait donc partie du [Python Path] du projet. C'est ce que la ligne 5 va nous permettre de v\u00e9rifier\u00a0;</li> <li>ligne 6\u00a0: si on d\u00e9crivait le chemin qui m\u00e8ne de la racine du projet au dossier [fonctions_module_01] on \u00e9crirait [fonctions/shared/fonctions_module_01]. Dans le chemin d'un module, le signe / est remplac\u00e9 par le point. On \u00e9crit donc [fonctions.modules.fonctions_module_01]\u00a0;</li> <li>apr\u00e8s la ligne 6, la fonction f2 est connue. On l'utilise ligne 8\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fonctions/fonc_07.py\nPython path=['C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\fonctions', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\fonctions\\\\shared', 'C:\\\\myprograms\\\\Python38\\\\python38.zip', 'C:\\\\myprograms\\\\Python38\\\\DLLs', 'C:\\\\myprograms\\\\Python38\\\\lib', 'C:\\\\myprograms\\\\Python38', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\venv', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\venv\\\\lib\\\\site-packages']\n310\n\nProcess finished with exit code 0\n</code></pre> <p>Ci-dessus\u00a0:</p> <ul> <li>surlign\u00e9e en vert, on voit que la racine du projet fait partie du [Python Path]\u00a0;</li> <li>surlign\u00e9 en jaune, on voit que le dossier du script ex\u00e9cut\u00e9 fait \u00e9galement partie du [Python Path]\u00a0;</li> <li>les autres \u00e9l\u00e9ments du [Python Path] proviennent directement du dossier d'installation de Python\u00a0; Que se passe-t-il lorsqu'on n'utilise pas PyCharm pour ex\u00e9cuter [fonc-07]\u00a0?</li> </ul> <p></p> <p></p> <ul> <li>en [1], on ex\u00e9cute le script [fonc-07]. On est positionn\u00e9s dans le dossier [fonctions]\u00a0;</li> <li>en [2], on voit que le dossier d'ex\u00e9cution fait partie du [Python Path]. C'est toujours ainsi. On peut voir \u00e9galement que le dossier racine [C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020] ne fait pas partie du [Python Path]\u00a0;</li> <li>en [3], l'interpr\u00e9teur Python d\u00e9clare qu'il ne trouve pas le module [fonctions]\u00a0; Pour chercher le module import\u00e9 [fonctions.shared.fonctions_module_01], l'interpr\u00e9teur Python cherche dans les dossiers du [Python Path] un sous-dossier nomm\u00e9 [fonctions]. Il ne le trouve nulle part. En effet le sous-dossier [fonctions] est sous le dossier [C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020] qui ne fait pas partie du [Python Path].</li> </ul> <p>Le script [fonc-08] donne une solution possible \u00e0 ce probl\u00e8me.</p>"},{"location":"les-fonctions.html#68-script-fonc_08-ajouter-des-dossiers-au-python-path","title":"6.8. Script [fonc_08]\u00a0: ajouter des dossiers au [Python Path]","text":"<p>Il est possible de modifier le [Python Path] par programmation comme le montre le script [fonc-08]\u00a0:</p> <pre><code># utilisation de modules\nimport os\nimport sys\n\n# dossier du script\nscript_dir = os.path.dirname(os.path.abspath(__file__))\n# Python Path avant modification\nprint(f\"Python path avant={sys.path}\")\n# on ajoute le dossier [shared] au Python Path\nsys.path.append(f\"{script_dir}/shared\")\n# Python Path apr\u00e8s modification\nprint(f\"Python path apr\u00e8s={sys.path}\")\n\n# import f2\nfrom fonctions_module_01 import f2\n\n# ------------------------ main\nprint(f2(100, 200))\n</code></pre> <p>Notes</p> <ul> <li>ligne 4\u00a0: la variable sp\u00e9ciale [file] est le nom du script qui s\u2019ex\u00e9cute. Selon le contexte d\u2019ex\u00e9cution, ce nom peut \u00eatre absolu (Pycharm) ou relatif (console). La fonction [os.path.abspath] donne le nom absolu du fichier dont on lui passe le nom. La fonction [os.path.dirname] donne le nom absolu du dossier contenant le fichier dont on lui passe le nom\u00a0;</li> <li>ligne 10\u00a0: [sys.path] est un tableau contenant les noms des dossiers \u00e0 explorer lorsqu'un module est recherch\u00e9. On ajoute \u00e0 ce tableau la racine du projet d\u00e9finie ligne 4\u00a0;</li> <li>on affiche le [Python Path] avant (ligne 8) et apr\u00e8s (ligne 12) modification\u00a0;</li> <li>ligne 15\u00a0: on importe le module [fonctions_module_01] qui contient la fonction f2\u00a0; L'ex\u00e9cution dans PyCharm donne les r\u00e9sultats suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fonctions/fonc_08.py\nPython path avant=['C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\fonctions', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\fonctions\\\\shared', 'C:\\\\myprograms\\\\Python38\\\\python38.zip', 'C:\\\\myprograms\\\\Python38\\\\DLLs', 'C:\\\\myprograms\\\\Python38\\\\lib', 'C:\\\\myprograms\\\\Python38', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\venv', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\venv\\\\lib\\\\site-packages']\nPython path apr\u00e8s=['C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\fonctions', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\fonctions\\\\shared', 'C:\\\\myprograms\\\\Python38\\\\python38.zip', 'C:\\\\myprograms\\\\Python38\\\\DLLs', 'C:\\\\myprograms\\\\Python38\\\\lib', 'C:\\\\myprograms\\\\Python38', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\venv', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\venv\\\\lib\\\\site-packages', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\fonctions/shared']\n310\n\nProcess finished with exit code 0\n</code></pre> <ul> <li>ligne 3\u00a0: on voit que le dossier [shared] est pr\u00e9sent deux fois dans le [Python Path]. On peut \u00e9viter cela mais ici \u00e7a ne g\u00eane pas\u00a0;</li> <li>ligne 4\u00a0: la fonction f2 a bien \u00e9t\u00e9 ex\u00e9cut\u00e9e\u00a0; Maintenant ex\u00e9cutons [fonc-08] dans un terminal\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\fonctions&gt;python fonc_08.py\nPython path avant=['C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\fonctions', 'C:\\\\myprograms\\\\Python38\\\\python38.zip', 'C:\\\\myprograms\\\\Python38\\\\DLLs', 'C:\\\\myprograms\\\\Python38\\\\lib', 'C:\\\\myprograms\\\\Python38', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\venv', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\venv\\\\lib\\\\site-packages']\nPython path apr\u00e8s=['C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\fonctions', 'C:\\\\myprograms\\\\Python38\\\\python38.zip', 'C:\\\\myprograms\\\\Python38\\\\DLLs', 'C:\\\\myprograms\\\\Python38\\\\lib', 'C:\\\\myprograms\\\\Python38', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\venv', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\venv\\\\lib\\\\site-packages', 'C:\\\\Data\\\\st-2020\\\\dev\\\\python\\\\cours-2020\\\\python3-flask-2020\\\\fonctions/shared']\n310\n</code></pre> <ul> <li>ligne 2\u00a0: comme pr\u00e9c\u00e9demment, le dossier [shared] n'est pas dans le [Python Path]\u00a0;</li> <li>ligne 3\u00a0: maintenant il y est\u00a0;</li> <li>ligne 4\u00a0: la fonction f2 a \u00e9t\u00e9 trouv\u00e9e\u00a0;</li> </ul>"},{"location":"les-fonctions.html#69-script-fonc_09-declaration-du-type-des-parametres","title":"6.9. Script [fonc_09]\u00a0: d\u00e9claration du type des param\u00e8tres","text":"<p>Le script [fonc_09] montre qu'on peut d\u00e9clarer le type des param\u00e8tres d'une fonction ainsi que celui du r\u00e9sultat. Cependant cette d\u00e9claration n'est utile que pour la documentation de la fonction. L'interpr\u00e9teur Python ne v\u00e9rifie pas que les param\u00e8tres effectifs de la fonction ont bien le type attendu. Cependant, Pycharm signale les incoh\u00e9rences de types entre param\u00e8tres effectifs et formels. Cette seule raison suffit pour rendre les d\u00e9clarations de type indispensables. </p> <p>Le script est le suivant\u00a0:</p> <pre><code># une fonction avec indication du type des param\u00e8tres\n# cela sert de documentation uniquement car l'interpr\u00e9teur python n'en tient pas compte\n\n\ndef show(param: int) -&gt; int:\n    print(f\"param={param}, type(param)={type(param)}\")\n    return param + 1\n\n\n# main -------------------------\nprint(show(4))\nshow(\"xyz\")\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>ligne 5\u00a0: on d\u00e9clare que le param\u00e8tre formel [param] est de type [int] et que le r\u00e9sultat de la fonction est \u00e9galement de type [int]\u00a0;</li> <li>ligne 11\u00a0: le param\u00e8tre effectif de la fonction [show] a le bon type\u00a0;</li> <li>ligne 12\u00a0: le param\u00e8tre effectif de la fonction [show] n'a pas le bon type\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fonctions/fonc_09.py\nparam=4, type(param)=&lt;class 'int'&gt;\n5\nparam=xyz, type(param)=&lt;class 'str'&gt;\nTraceback (most recent call last):\n  File \"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fonctions/fonc_09.py\", line 11, in &lt;module&gt;\n    show(\"xyz\")\n  File \"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fonctions/fonc_09.py\", line 6, in show\n    return param + 1\nTypeError: can only concatenate str (not \"int\") to str\n\nProcess finished with exit code 1\n</code></pre> <ul> <li>ligne 10\u00a0: le type du param\u00e8tre [param] est de type [str]. Lorsque ce message s'affiche, on est d\u00e9j\u00e0 entr\u00e9s dans le code de la fonction [show]. L'interpr\u00e9teur Python a donc accept\u00e9 que le param\u00e8tre effectif da la fonction [show] soit de type [str]\u00a0;</li> <li>la ligne 7 du code provoque l'exception refl\u00e9t\u00e9e par les lignes 4-10 des r\u00e9sultats\u00a0; PyCharm indique n\u00e9anmoins qu\u2019il y a une anomalie\u00a0:</li> </ul> <p></p> <p>En [1], PyCharm a surlign\u00e9 l\u2019appel erron\u00e9.</p>"},{"location":"les-fonctions.html#610-script-fonc_10-parametres-nommes","title":"6.10. Script [fonc_10]\u00a0: param\u00e8tres nomm\u00e9s","text":"<p>Pour passer des param\u00e8tres \u00e0 une fonction, on peut utiliser les noms des param\u00e8tres formels de celle-ci. Dans ce cas, on n'est pas oblig\u00e9s de respecter l'ordre des param\u00e8tres formels\u00a0:</p> <pre><code># on peut d\u00e9signer les param\u00e8tres effectifs par leurs noms formels\ndef f(x, y):\n    return x + y\n\n\n# main\nprint(f(y=10, x=3))\n</code></pre> <p>Notes</p> <ul> <li>ligne 2\u00a0: la fonction f a deux param\u00e8tres formels x et y\u00a0;</li> <li>ligne 7\u00a0: lors de l'appel \u00e0 la fonction f, on peut utiliser les noms des param\u00e8tres formels. Cette pratique peut \u00eatre utile au moins dans deux cas\u00a0:</li> <li>la fonction a beaucoup de param\u00e8tres dont la plupart ont une valeur par d\u00e9faut. Lors de l'appel, la technique pr\u00e9c\u00e9dente permet d'initialiser les seuls param\u00e8tres dont on ne veut pas utiliser la valeur par d\u00e9faut\u00a0;</li> <li>si les param\u00e8tres formels ont un nom significatif, alors l'utilisation de param\u00e8tres nomm\u00e9s dans l'appel de la fonction am\u00e9liore la lisibilit\u00e9 du code\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fonctions/fonc_10.py\n13\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-fonctions.html#611-script-fonc_11-fonction-recursive","title":"6.11. Script [fonc_11]\u00a0: fonction r\u00e9cursive","text":"<p>Le script [fonc_11] est un exemple de fonction r\u00e9cursive (qui s\u2019appelle elle-m\u00eame)\u00a0:</p> <pre><code># fonction r\u00e9cursive\ndef fact(i: int) -&gt; int:\n    # factorielle(1) est 1\n    # une fonction r\u00e9cursive doit se terminer \u00e0 un certain moment\n    if i == 1:\n        return 1\n    else:\n        # factorielle(i)=i*factorielle(i-1)\n        return i * fact(i - 1)\n\n\n# ---------- main\nprint(f\"fact(8)={fact(8)}\")\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 1-9\u00a0: la fonction factorielle\u00a0;</li> <li>ligne 9\u00a0: la fonction [factorielle] s\u2019appelle elle-m\u00eame\u00a0;</li> <li>lignes 5-6\u00a0: une fonction r\u00e9cursive doit toujours s\u2019arr\u00eater lorsqu\u2019une condition est r\u00e9alis\u00e9e sinon on a une r\u00e9cursion infinie\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fonctions/fonc_11.py\nfact(8)=40320\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"les-fonctions.html#612-script-fonc_12-fonction-recursive","title":"6.12. Script [fonc_12]\u00a0: fonction r\u00e9cursive","text":"<p>La fonction [fonc_12] donne davantage de d\u00e9tails sur le fonctionnement de la r\u00e9cursivit\u00e9\u00a0:</p> <pre><code># fonction r\u00e9cursive\n# comportement du param\u00e8tre j\n\n\ndef fact(i: int, j: int) -&gt; int:\n    # arr\u00eat de la fonction r\u00e9cursive\n    if i == 1:\n        print(f\"j={j}\")\n        return 1\n    else:\n        # on manipule j\n        j += 1\n        print(f\"avant fact j={j}\")\n        # r\u00e9cursivit\u00e9\n        f = fact(i - 1, j)\n        print(f\"apr\u00e8s fact j={j}\")\n        # r\u00e9sultat\n        return i * f\n\n\n# ---------- main\nprint(f\"fact(8)={fact(8, 0)}\")\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 5\u00a0: on s\u2019int\u00e9resse toujours \u00e0 la fonction factorielle. On lui ajoute le param\u00e8tre [j]\u00a0;</li> <li>ligne 12\u00a0: la variable j est r\u00e9guli\u00e8rement incr\u00e9ment\u00e9e \u00e0 chaque factorielle. On affiche sa valeur avant (ligne 12) et apr\u00e8s (ligne 16) la r\u00e9cursivit\u00e9 (ligne 15)\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/fonctions/fonc_12.py\navant fact j=1\navant fact j=2\navant fact j=3\navant fact j=4\navant fact j=5\navant fact j=6\navant fact j=7\nj=7\napr\u00e8s fact j=7\napr\u00e8s fact j=6\napr\u00e8s fact j=5\napr\u00e8s fact j=4\napr\u00e8s fact j=3\napr\u00e8s fact j=2\napr\u00e8s fact j=1\nfact(8)=40320\n\nProcess finished with exit code 0\n</code></pre> <ul> <li>lignes 2-8\u00a0: on voit que la valeur de [j] cro\u00eet tant que la r\u00e9cursivit\u00e9 continue jusqu\u2019\u00e0 rencontrer la condition o\u00f9 la r\u00e9cursivit\u00e9 s\u2019arr\u00eate. A partir de ce moment, le retour des appels \u00e0 la fonction [fact] s\u2019op\u00e8re en sens inverse des appels\u00a0;</li> <li>lignes 10-16\u00a0: ces affichages traduisent les retours successifs de l\u2019appel de la factorielle. La variable [j] retrouve ses valeurs jusqu\u2019\u00e0 sa valeur initiale 1\u00a0;</li> </ul>"},{"location":"les-imports.html","title":"9. Les imports","text":"<p>L\u2019erreur rencontr\u00e9e dans la version 1 de l\u2019exercice d\u2019application nous am\u00e8ne \u00e0 approfondir le r\u00f4le de l\u2019instruction [import].</p> <p></p>"},{"location":"les-imports.html#91-scripts-import_01","title":"9.1. Scripts [import_01]","text":"<p>Le script [imported] va \u00eatre import\u00e9 par diff\u00e9rents scripts (appel\u00e9s aussi modules)\u00a0:</p> <p></p> <pre><code># module import\u00e9\n# cette instruction sera ex\u00e9cut\u00e9e \u00e0 chaque fois que le module sera import\u00e9\nprint(\"2\")\n# variable appartenant au module import\u00e9\nx=4\n</code></pre> <p>Un module est ex\u00e9cut\u00e9 lorsqu\u2019il est import\u00e9. Ainsi lorsque le module [imported] sera import\u00e9\u00a0:</p> <ul> <li>l\u2019affichage de la ligne 3 aura lieu\u00a0;</li> <li>la variable x de la ligne 5 recevra sa valeur\u00a0; Le script [main_01] est le suivant\u00a0:</li> </ul> <pre><code># un module import\u00e9 est ex\u00e9cut\u00e9\nimport imported\n# utilisation de la variable x du module import\u00e9\nprint(imported.x)\n</code></pre> <ul> <li>ligne 2\u00a0: le module [imported] est import\u00e9. Cela va provoquer son ex\u00e9cution\u00a0:</li> <li>la valeur 2 va \u00eatre affich\u00e9e\u00a0;</li> <li>la variable x est cr\u00e9e avec la valeur 4\u00a0;</li> <li>ligne 4\u00a0: on utilise la variable x du module import\u00e9\u00a0; Dans PyCharm, une erreur est signal\u00e9e\u00a0:</li> </ul> <p>En [1], PyCharm indique qu\u2019il ne conna\u00eet pas le module [imported]. En termes techniques, cela signifie que le dossier contenant le module [imported] n\u2019est pas dans le Python Path de PyCharm. Le Python Path est l\u2019ensemble des dossiers dans lesquels les modules import\u00e9s sont cherch\u00e9s. Pour r\u00e9soudre ce probl\u00e8me, il suffit de d\u00e9clarer [Sources root] le dossier dans lequel se trouve le module [imported], ici le dossier [import/01]\u00a0:</p> <p></p> <p></p> <p>Apr\u00e8s cette op\u00e9ration, le dossier [import/01] est mis dans le Python Path de Pycharm et l\u2019erreur dispara\u00eet\u00a0:</p> <p></p> <ul> <li>en [1], le dossier [01] a chang\u00e9 de couleur\u00a0;</li> <li>en [2-3], il n\u2019y a plus d\u2019erreur\u00a0; Les r\u00e9sultats de l\u2019ex\u00e9cution sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/import/01/main_01.py\n2\n4\n\nProcess finished with exit code 0\n</code></pre> <p>Commentaires</p> <ul> <li>la ligne 2 est le r\u00e9sultat de l\u2019ex\u00e9cution du module import\u00e9\u00a0;</li> <li>la ligne 3 affiche la valeur de la variable x du module import\u00e9\u00a0; On retiendra de cet exemple, le concept important qu\u2019un module (ou un script) import\u00e9 est ex\u00e9cut\u00e9.</li> </ul> <p>Le script [main_02] est le suivant\u00a0:</p> <pre><code># on importe la variable x du module import\u00e9\nfrom imported import x\n# on l'affiche\nprint(x)\n</code></pre> <ul> <li>ligne 2, on a une autre syntaxe de l\u2019importation [from module import objet1, objet2, \u2026]. Ici on importe la variable [imported.x]. Avec ectte syntaxe, la variable x devient une variable du script [main_02]. On n\u2019a plus besoin de la pr\u00e9fixer par son module [imported]\u00a0;</li> <li>ligne 4\u00a0: on affiche la variable x de [main_02]\u00a0; Les r\u00e9sultats de l\u2019ex\u00e9cution sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/import/01/main_02.py\n2\n4\n\nProcess finished with exit code 0\n</code></pre> <p>Le script [main_03] est le suivant\u00a0:</p> <pre><code># on importe tout ce qui est visible du module import\u00e9\nfrom imported import *\n# on utilise la variable x du module import\u00e9\nprint(x)\n</code></pre> <p>La notation [import *] de la ligne 2 signifie qu\u2019on importe tous les objets visibles du module import\u00e9 (variables, fonctions).</p> <p>Les r\u00e9sultats sont les suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/import/01/main_03.py\n2\n4\n\nProcess finished with exit code 0\n</code></pre> <p>Le script [main_04] est le suivant\u00a0:</p> <pre><code># on importe la variable x du module import\u00e9\n# et on la renomme y\nfrom imported import x as y\n# on affiche la variable y\nprint(y) \n</code></pre> <p>La ligne 3 montre qu\u2019on peut importer un objet du module import\u00e9 et lui donner un alias. Ici la variable [imported.x] devient la variable [main_04.y]. Les r\u00e9sultats sont les m\u00eames qu\u2019auparavant.</p>"},{"location":"les-imports.html#92-script-import_02","title":"9.2. Script [import_02]","text":"<p>Le module import\u00e9 [module1.py] est ici le suivant\u00a0:</p> <pre><code># une fonction\ndef f1():\n    print(\"f1\")\n</code></pre> <p>Le module import\u00e9 d\u00e9finit une fonction, un cas fr\u00e9quent.</p> <p>Le script [main_01] est le suivant\u00a0:</p> <pre><code># import\nimport module1\n# ex\u00e9cution f1\nmodule1.f1()\n</code></pre> <ul> <li>ligne 2, le module est import\u00e9. Il va \u00eatre ex\u00e9cut\u00e9. Ici, il n\u2019affiche rien\u00a0;</li> <li>ligne 4\u00a0: la fonction [f1] du module import\u00e9 est ex\u00e9cut\u00e9e\u00a0; Les r\u00e9sultats de l\u2019ex\u00e9cution sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/import/02/main_01.py\nf1\n\nProcess finished with exit code 0\n</code></pre> <p>Note\u00a0: Pour \u00e9viter que PyCharm ne signale une erreur sur l\u2019importation de la ligne 2, il mettre le dossier contenant [module1] dans les [Sources Root] de PyCharm\u00a0:</p> <p></p> <p>En [1], le dossier [02] mis dans les [Sources Root] est pass\u00e9 en bleu. On notera que l\u2019erreur signal\u00e9e n\u2019emp\u00eache pas ici une ex\u00e9cution correcte des scripts. En effet, lors de l\u2019ex\u00e9cution du script [main_0x], le dossier du script est automatiquement mis dans le Python Path. Du coup [module1] est trouv\u00e9. Dor\u00e9navant, lorsque sur une copie d\u2019\u00e9cran un dossier est en bleu, c\u2019est qu\u2019il a \u00e9t\u00e9 mis dans les [Sources Root] de PyCharm.</p> <p>Le script [main_02] est le suivant\u00a0:</p> <pre><code># import\nfrom module1 import f1\n# ex\u00e9cution f1\nf1()\n</code></pre> <ul> <li>la ligne 2 importe la fonction [f1] du module [module1]\u00a0;</li> <li>ligne 4, on utilise la fonction f1\u00a0; Les r\u00e9sultats sont identiques \u00e0 ceux du script [main_01].</li> </ul>"},{"location":"les-imports.html#93-scripts-import_03","title":"9.3. Scripts [import_03]","text":"<p>Note\u00a0: [03] est dans les [Sources Root] du projet.</p> <p>Les nouveaux scripts vont importer le module [module2] qui n\u2019est pas dans le m\u00eame dossier qu\u2019eux.</p> <p>Le script [module2] est le suivant\u00a0:</p> <pre><code># une fonction\ndef f2():\n    print(\"f2\")\n</code></pre> <p>Le script d\u00e9finit donc une fonction [f2].</p> <p>Le script [main_01] est le suivant\u00a0:</p> <pre><code># import du module Class2\nimport dir1.module2\n# ex\u00e9cution f2\ndir1.module2.f2()\n</code></pre> <ul> <li>ligne 2\u00a0: on utilise une notation sp\u00e9ciale pour indiquer comment trouver le module [module2]. Il faut lire [dir1.module2] comme le chemin [dir1/module2]\u00a0: pour trouver [module2], on part du dossier du script courant [main_01], puis on passe dans [dir1] et l\u00e0 on trouve [module2]. Il ne faut pas oublier ici que le point de d\u00e9part du chemin est le dossier du script qui importe\u00a0;</li> <li>ligne 4\u00a0: pour ex\u00e9cuter la fonction [f2] de [module2]\u00a0; Les r\u00e9sultats sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/import/03/main_01.py\nf2\n\nProcess finished with exit code 0\n</code></pre> <p>Ligne 2, le r\u00e9sultat de la fonction [f2].</p> <p>Le script [main_02] est le suivant\u00a0:</p> <pre><code># import du module dir1.module2 qu'on renomme\nimport dir1.module2 as module2\n# ex\u00e9cution f2\nmodule2.f2()\n</code></pre> <p>Ligne 2, on renomme le module [dir1.module] pour simplifier l\u2019\u00e9criture de la ligne 4.</p> <p>Le script [main_03] est le suivant\u00a0:</p> <pre><code># importde la fonction f2 du module dir1.module2\nfrom dir1.module2 import f2\n# ex\u00e9cution f2\nf2()\n</code></pre> <p>Cette fois-ci, ligne 2, on n\u2019importe que la fonction [f2] qui devient alors une fonction du script [main_03] (ligne 4).</p> <p>Tous ces scripts fonctionnent aussi bien dans le contexte PyCharm que dans celui d\u2019une console Python. La raison est que dans les deux cas, le dossier du script ex\u00e9cut\u00e9, ici le dossier [03] fait partie du Python Path. Du coup, le dossier [dir1/module2] est trouv\u00e9.</p>"},{"location":"les-imports.html#94-scripts-import_04","title":"9.4. Scripts [import_04]","text":"<p>Ici, les dossiers [dir1] et [dir2] ont \u00e9t\u00e9 mis dans les [Sources Root] du projet PyCharm.</p> <p>Le premier module import\u00e9 est [module3]\u00a0:</p> <pre><code># une fonction\ndef f3():\n    print(\"f3\")\n</code></pre> <p>Le second module import\u00e9 est [module4]\u00a0:</p> <pre><code>from module3 import f3\n\n# une fonction\ndef f4():\n    f3()\n    print(\"f4\")\n</code></pre> <ul> <li>ligne 1, on importe la fonction [f3] de [module3]. Ici, [module3] est visible parce qu\u2019on a mis son dossier [dir1] dans les [Sources Root]\u00a0;</li> <li>lignes 4-6\u00a0: on d\u00e9finit une fonction [f4] qui fait appel \u00e0 la fonction [f3] de [module3]\u00a0; Le script principal [main_01] est le suivant\u00a0:</li> </ul> <pre><code># on importe module4\nfrom module4 import f4\n# ex\u00e9cution f4\nf4()\n</code></pre> <ul> <li>ligne 2, on importe le module [module4]. Celui-ci est visible car on a mis son dossier [dir2] dans les [Sources Root] de PyCharm\u00a0;</li> <li>ligne 4\u00a0: ex\u00e9cution de la fonction [f4] de [module4]\u00a0; Les r\u00e9sultats de l\u2019ex\u00e9cution de [main_01] dans PyCharm sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/import/04/main_01.py\nf3\nf4\n\nProcess finished with exit code 0\n</code></pre> <p>Maintenant, ex\u00e9cutons [main_01] dans un terminal (console) Python\u00a0:</p> <p></p> <p>Les r\u00e9sultats sont les suivants\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\import\\04&gt;python main_01.py\nTraceback (most recent call last):\n  File \"main_01.py\", line 2, in &lt;module&gt;\n    from module4 import f4\nModuleNotFoundError: No module named 'module4'\n</code></pre> <p>Que s\u2019est-il pass\u00e9\u00a0? Le terminal Python n\u2019a aucune connaissance du Python Path et des [Sources Root] de PyCharm. Il a son propre Python Path. Dans celui-ci, on a toujours le dossier du script qui s\u2019ex\u00e9cute, ici le script [main_01]. Il conna\u00eet donc le dossier [import/04]. Dans le script ex\u00e9cut\u00e9, il trouve la ligne\u00a0:</p> <pre><code>from module4 import f4\n</code></pre> <p>L\u2019interpr\u00e9teur Python cherche [module4] dans les dossiers de son Python Path. Or [module4] ne se trouve pas dans [import/04] qui se trouve bien dans le Python Path mais dans [import/04/dir2] qui ne s\u2019y trouve pas. D\u2019o\u00f9 l\u2019erreur.</p> <p>On a donc un probl\u00e8me d\u00e9j\u00e0 rencontr\u00e9\u00a0: un script s\u2019ex\u00e9cutant correctement dans PyCharm peut planter dans le contexte d\u2019un terminal Python. C\u2019est un probl\u00e8me r\u00e9current qu\u2019il va nous falloir r\u00e9soudre.</p>"},{"location":"les-imports.html#95-scripts-import_05","title":"9.5. Scripts [import_05]","text":"<p>Note\u00a0: les dossiers [dir1] et [dir2] sont mis dans le Python Path. Remarquons d\u00e9j\u00e0 qu\u2019il y a l\u00e0 un conflit\u00a0: [module3] et [module4] seront trouv\u00e9s \u00e0 deux endroits du Python Path de PyCharm\u00a0:</p> <ul> <li>dans [import/04/dir1] et [import/05/dir1] pour [module3]\u00a0;</li> <li>dans [import/04/dir2] et [import/05/dir2] pour [module4]\u00a0; On peut alors sortir [import/04/dir1] et [import/04/dir2] des [Sources Root] du projet PyCharm. Il se trouve qu\u2019ici, [import/05/dir1] est une copie de [import/04/dir1] (idem pour [dir2]) et qu\u2019il n\u2019y a donc pas de probl\u00e8me. Mais notons n\u00e9anmoins qu\u2019\u00e0 l\u2019int\u00e9rieur m\u00eame de PyCharm, on doit faire attention \u00e0 la liste des dossiers des [Sources Root] afin d\u2019\u00e9viter les conflits.</li> </ul> <p>Le script [main_01] devient le suivant\u00a0:</p> <pre><code>import sys\n# on modifie le sys.path pour y inclure les dossiers\n# contenant les classes \u00e0 importer\nsys.path.append(\".\")\nsys.path.append(\"./dir1\")\nsys.path.append(\"./dir2\")\n# on importe module4\nfrom module4 import f4\n# ex\u00e9cution f4\nf4()\n</code></pre> <p>On cherche \u00e0 r\u00e9soudre le probl\u00e8me du Python Path. On en veut un qui fonctionne aussi bien sous PyCharm que dans un terminal Python. Pour cela, on va le fixer nous-m\u00eames.</p> <ul> <li>lignes 4-6\u00a0: on ajoute les dossiers [., ./dir1, ./dir2] dans le Python Path. Pour que cela marche, il faut que le dossier courant au moment de l\u2019ex\u00e9cution soit le dossier [import/05]. Ce sera vrai dans PyCharm mais pas forc\u00e9ment vrai dans un terminal Python comme nous le verrons\u00a0;</li> <li>ligne 8\u00a0: on importe [module4]. Suite \u00e0 ce que nous venons de faire, il devrait \u00eatre trouv\u00e9 dans [./dir2]\u00a0; L\u2019ex\u00e9cution dans PyCharm donne les r\u00e9sultats suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/import/05/main_01.py\nf3\nf4\n\nProcess finished with exit code 0\n</code></pre> <p>Maintenant, dans un terminal Python\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\import\\05&gt;python main_01.py\nf3\nf4\n</code></pre> <p>Ligne 1, le dossier d\u2019ex\u00e9cution est [import/05].</p> <p>Maintenant remontons d\u2019un niveau dans l\u2019arborescence de [import/05]\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\import\\05&gt;cd ..\n\n(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\import&gt;python 05/main_01.py\nTraceback (most recent call last):\n  File \"05/main_01.py\", line 8, in &lt;module&gt;\n    from module4 import f4\nModuleNotFoundError: No module named 'module4'\n</code></pre> <ul> <li>ligne 2, lorsque [main_01] est ex\u00e9cut\u00e9 on n\u2019est plus dans le dossier [import/05] mais dans [import]. Or nous avons \u00e9crit\u00a0: <pre><code>sys.path.append(\".\")\nsys.path.append(\"./dir1\")\nsys.path.append(\"./dir2\")\n</code></pre></li> </ul> <p>Cela ajoute au Python Path les dossiers [import, import/dir1, import/dir2], pas du tout ce qu\u2019on veut. Notons qu\u2019ajouter au Python Path des dossiers qui n\u2019existent pas (import/dir1, import/dir2) ne provoque pas d\u2019erreurs.</p> <p>On a progress\u00e9 mais ce n\u2019est pas suffisant. Il faut ajouter au Python Path, non pas des chemins relatifs, mais des chemins absolus.</p> <p>Le script [main_02] est une variante de [main_01] qui utilise un fichier de configuration [config.json]\u00a0:</p> <pre><code>{\n  \"dependencies\": [\n    \"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/import/05/dir1\",\n    \"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/import/05/dir2\"\n  ]\n}\n</code></pre> <p>La valeur de la cl\u00e9 [dependencies] est la liste des dossiers \u00e0 ajouter au Python Path. A noter qu\u2019ici on a mis des noms absolus et non des noms relatifs.</p> <p>Le script [main_02] utilise le fichier [config.json] de la fa\u00e7on suivante\u00a0:</p> <pre><code>import codecs\nimport json\nimport sys\n\n# fichier de configuration\nconfig_filename=\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/import/05/config.json\"\n# lecture du fichier de configuration json\nwith codecs.open(config_filename, \"r\", \"utf-8\") as file:\n    config = json.load(file)\n\n# modification du sys.path\nfor directory in config['dependencies']:\n    sys.path.append(directory)\n\n# on importe module4\nfrom module4 import f4\n# ex\u00e9cution f4\nf4()\n</code></pre> <ul> <li>ligne 6\u00a0:  notez qu\u2019on a utilis\u00e9 le nom absolu du fichier de configuration\u00a0;</li> <li>lignes 8-9\u00a0: le fichier de configuration est lu. Un dictionnaire [config] (ligne 9) est construit avec son contenu\u00a0;</li> <li>lignes 11-13\u00a0: on ajoute les \u00e9l\u00e9ments du tableau [config['dependencies']] au Python Path. Notons que puisqu\u2019on a mis des noms absolus de dossiers dans [config.json], on ajoute dans le Python Path des noms absolus\u00a0;</li> <li>ligne 16\u00a0: [module4] est import\u00e9. On devrait le trouver puisque maintenant [dir2] est dans le Python Path\u00a0; L\u2019ex\u00e9cution donne les m\u00eames r\u00e9sultats que pour [main_02] sauf que le script continue \u00e0 fonctionner lorsque le dossier d\u2019ex\u00e9cution n\u2019est plus [import/05]\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\import&gt;python 05/main_02.py\nf3\nf4\n</code></pre> <p>Ligne 1, le dossier d\u2019ex\u00e9cution est [import].</p> <p>Nous avons progress\u00e9. Nous avons vu\u00a0:</p> <ul> <li>qu\u2019il nous fallait construire le Python Path nous-m\u00eames\u00a0;</li> <li>qu\u2019il fallait y mettre les noms absolus de tous les dossiers contenant les modules import\u00e9s par l\u2019application\u00a0; N\u00e9anmoins, mettre des noms absolus dans des scripts n\u2019est pas une solution. D\u00e8s que le projet est transport\u00e9 sur un autre site, il ne marche plus. Il nous faut trouver autre chose.</li> </ul>"},{"location":"les-imports.html#96-scripts-import_06","title":"9.6. Scripts [import_06]","text":"<p>Note\u00a0: les dossiers [06, dir1, dir2] ont \u00e9t\u00e9 plac\u00e9s dans les [Sources Root] du projet PyCharm. Les dossiers [dir1, dir2] sont identiques \u00e0 ceux des exemples pr\u00e9c\u00e9dents.</p> <p>Le fichier [config.json] est le suivant\u00a0:</p> <pre><code>{\n  \"rootDir\": \"C:/Data/st-2020/dev/python/cours-2020/v-02/imports/06\",\n  \"relativeDependencies\": [\n    \"dir1\",\n    \"dir2\"\n  ],\n  \"absoluteDependencies\": [\n   ]\n}\n</code></pre> <p>Nous introduisons deux types de chemins\u00a0:</p> <ul> <li>des chemins absolus, lignes 7-8\u00a0;</li> <li>des chemins relatifs, lignes 3-6. Ils sont relatifs \u00e0 la racine de la ligne 2. Ainsi lorsque le projet bouge d\u2019emplacement, seule cette ligne doit \u00eatre modifi\u00e9e\u00a0; Le script [utils.py] exploite le fichier [config.json] et construit le Python Path\u00a0:</li> </ul> <pre><code>#\u00a0imports\nimport\u00a0codecs\nimport\u00a0json\nimport\u00a0os\nimport\u00a0sys\n\n#\u00a0configuration\u00a0de\u00a0l'application\ndef\u00a0config_app(config_filename:\u00a0str)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0#\u00a0config_filename\u00a0:\u00a0nom\u00a0du\u00a0fichier\u00a0de\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0laisse\u00a0remonter\u00a0les\u00a0exceptions\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0exploitation\u00a0du\u00a0fichier\u00a0de\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0with\u00a0codecs.open(config_filename,\u00a0\"r\",\u00a0\"utf-8\")\u00a0as\u00a0file:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0json.load(file)\n\u00a0\u00a0\u00a0\u00a0#\u00a0ajout\u00a0des\u00a0d\u00e9pendances\u00a0au\u00a0sys.path\n\u00a0\u00a0\u00a0\u00a0rootDir\u00a0=\u00a0config['rootDir']\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ajoute\u00a0les\u00a0d\u00e9pendances\u00a0relatives\u00a0du\u00a0projet\u00a0au\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0for\u00a0directory\u00a0in\u00a0config['relativeDependencies']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ajoute\u00a0la\u00a0d\u00e9pendance\u00a0au\u00a0d\u00e9but\u00a0du\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0sys.path.insert(0,\u00a0f\"{rootDir}/{directory}\")\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0lui\u00a0ajoute\u00a0les\u00a0d\u00e9pendances\u00a0absolues\u00a0du\u00a0projet\u00a0au\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0for\u00a0directory\u00a0in\u00a0config['absoluteDependencies']:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ajoute\u00a0la\u00a0d\u00e9pendance\u00a0au\u00a0d\u00e9but\u00a0du\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0sys.path.insert(0,\u00a0directory)\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0le\u00a0dictionnaire\u00a0de\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n\n#\u00a0dossier\u00a0du\u00a0sript\u00a0ex\u00e9cut\u00e9\ndef\u00a0get_scriptdir():\n\u00a0\u00a0\u00a0\u00a0return\u00a0os.path.dirname(os.path.abspath(__file__))\n</code></pre> <ul> <li>ligne 8\u00a0: la fonction [config_app] re\u00e7oit en param\u00e8tre le nom du fichier de configuration\u00a0;</li> <li>lignes 12-14\u00a0: le fichier de configuration est exploit\u00e9 pour cr\u00e9er le dictionnaire [config]\u00a0;</li> <li>ligne 20\u00a0: [sys.path] est la liste des dossiers du Python Path\u00a0;</li> <li>lignes 17-20\u00a0: les d\u00e9pendances relatives du fichier de configuration sont ajout\u00e9es au Python Path. Elles sont ajout\u00e9es au d\u00e9but du tableau [sys.path], ligne 20. En effet, lorsque Python cherche un module il explore les dossiers du [sys.path] dans l\u2019ordre. Or dans ce document, des modules de m\u00eames noms vont se trouver dans des dossiers diff\u00e9rents du [sys.path]. En mettant les d\u00e9pendances de l\u2019application au d\u00e9but du tableau [sys.path], on s\u2019assure que celles-ci seront explor\u00e9es avant d\u2019autres dossiers du [sys.path] qui pourraient contenir des modules de m\u00eames noms\u00a0;</li> <li>lignes 21-24\u00a0: les d\u00e9pendances absolues du fichier de configuration sont ajout\u00e9es au Python Path\u00a0;</li> <li>ligne 26\u00a0: on rend la configuration de l\u2019application\u00a0;</li> <li>lignes 29-30\u00a0: la fonction [get_scriptdir] rend le nom absolu du dossier du script en cours d\u2019ex\u00e9cution (celui o\u00f9 se trouve l\u2019appel \u00e0 la fonction)\u00a0; Le script principal [main] est le suivant\u00a0:</li> </ul> <pre><code># imports\nimport sys\n\nfrom utils import config_app\n\n\ndef affiche_path(msg: str):\n    # message\n    print(f\"{msg}------------------------------\")\n    # sys.path\n    for path in sys.path:\n        print(path)\n\n\n# main -------------\ntry:\n    # le sys.path est configur\u00e9\n    affiche_path(\"avant....\")\n    config = config_app(f\"{get_scriptdir()}/config.json\")\n    affiche_path(\"apr\u00e8s....\")\n    # on importe module4\n    from module4 import f4\n    # ex\u00e9cution f4\n    f4()\nexcept BaseException as erreur:\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\nfinally:\n    print(\"done\")\n</code></pre> <ul> <li>ligne 4\u00a0: la fonction [config_app] est import\u00e9e. On notera que puisque [utils] et [main] sont dans le m\u00eame dossier, cet [import] fonctionne tout le temps. En effet, le dossier du script principal est automatiquement ajout\u00e9 au python Path\u00a0;</li> <li>lignes 7-12\u00a0: la fonction [affiche_path] affiche la liste des dossiers du Python Path\u00a0;</li> <li>ligne 19\u00a0: on configure l\u2019application. Noter qu\u2019on passe \u00e0 la fonction [config_app] le nom absolu du fichier de configuration. Apr\u00e8s cette instruction, le Python Path a \u00e9t\u00e9 reconstruit\u00a0;</li> <li>ligne 22\u00a0: on importe [module4]. Gr\u00e2ce \u00e0 la reconstruction du Python Path, ce module va \u00eatre trouv\u00e9\u00a0;</li> <li>ligne 24\u00a0: on ex\u00e9cute la fonction  [f4]\u00a0; Dans le contexte PyCharm, les r\u00e9sultats de l\u2019ex\u00e9cution sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/import/06/main.py\navant....------------------------------\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\import\\06\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\fonctions\\shared\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\impots\\v01\\shared\n\u2026\nC:\\Program Files\\Python38\\python38.zip\nC:\\Program Files\\Python38\\DLLs\nC:\\Program Files\\Python38\\lib\nC:\\Program Files\\Python38\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages\napr\u00e8s....------------------------------\nC:/Data/st-2020/dev/python/cours-2020/v-02/imports/06/dir2\nC:/Data/st-2020/dev/python/cours-2020/v-02/imports/06/dir1\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\import\\06\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\fonctions\\shared\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\impots\\v01\\shared\n\u2026.\nC:\\Program Files\\Python38\\python38.zip\nC:\\Program Files\\Python38\\DLLs\nC:\\Program Files\\Python38\\lib\nC:\\Program Files\\Python38\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages\nf3\nf4\ndone\n\nProcess finished with exit code 0\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 2-13\u00a0: le Python Path de PyCharm. On y retrouve tous les dossiers mis dans les [Sources Root] du projet\u00a0;</li> <li>lignes 14-29\u00a0: le Python Path construit par la fonction [config_app]. On y trouve aux lignes 15-16, les deux d\u00e9pendances que nous avons ajout\u00e9es\u00a0;</li> <li>lignes 22-27\u00a0: les dossiers syst\u00e8me de l\u2019interpr\u00e9teur Python qui a ex\u00e9cut\u00e9 le script\u00a0;</li> <li> <p>lignes 28-29\u00a0: l\u2019ex\u00e9cution se passe normalement\u00a0; Maintenant, pla\u00e7ons-nous dans le contexte qui jusqu\u2019\u00e0 maintenant provoquait une erreur d\u2019ex\u00e9cution\u00a0:</p> </li> <li> <p>on se place dans un terminal Python\u00a0;</p> </li> <li>on se met dans un dossier autre que celui contenant le script ex\u00e9cut\u00e9\u00a0; <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\import&gt;python 06/main.py\navant....------------------------------\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\import\\06\nC:\\Program Files\\Python38\\python38.zip\nC:\\Program Files\\Python38\\DLLs\nC:\\Program Files\\Python38\\lib\nC:\\Program Files\\Python38\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages\napr\u00e8s....------------------------------\nC:/Data/st-2020/dev/python/cours-2020/v-02/imports/06/dir2\nC:/Data/st-2020/dev/python/cours-2020/v-02/imports/06/dir1\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\import\\06\nC:\\Program Files\\Python38\\python38.zip\nC:\\Program Files\\Python38\\DLLs\nC:\\Program Files\\Python38\\lib\nC:\\Program Files\\Python38\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages\nf3\nf4\ndone\n</code></pre></li> </ul> <p>Cette fois-ci c\u2019est bon (lignes 20-21). On notera que le [sys.path] ne contient pas les m\u00eames dossiers que lorsque l\u2019ex\u00e9cution se passe sous PyCharm. </p>"},{"location":"les-imports.html#97-scripts-import_07","title":"9.7. Scripts [import_07]","text":"<p>Nous am\u00e9liorons la solution pr\u00e9c\u00e9dente de deux fa\u00e7ons\u00a0:</p> <ul> <li>nous rempla\u00e7ons le fichier de configuration [config.json] par un script [config.py]. En effet, le fichier jSON pose un probl\u00e8me important\u00a0: il ne peut pas \u00eatre comment\u00e9. Le dictionnaire [config.json] peut \u00eatre remplac\u00e9 par un dictionnaire Python qui a l\u2019avantage de pouvoir \u00eatre comment\u00e9\u00a0;</li> <li>nous utilisons un module visible de tous les projets Python de la machine\u00a0;</li> </ul>"},{"location":"les-imports.html#971-installation-dun-module-de-portee-machine","title":"9.7.1. Installation d\u2019un module de port\u00e9e machine","text":"<p>Ci-dessus, nous cr\u00e9ons un dossier [packages/myutils] dans le projet PyCharm (les noms n\u2019importent pas).</p> <p>Le script [myutils.py] est le suivant\u00a0:</p> <pre><code># imports\nimport sys\nimport os\n\n\ndef\u00a0set_syspath(absolute_dependencies:\u00a0list):\n\u00a0\u00a0\u00a0\u00a0#\u00a0absolute_dependencies\u00a0:\u00a0une\u00a0liste\u00a0de\u00a0noms\u00a0absolus\u00a0de\u00a0dossiers\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0ajoute\u00a0au\u00a0syspath\u00a0les\u00a0d\u00e9pendances\u00a0absolues\u00a0du\u00a0projet\n\u00a0\u00a0\u00a0\u00a0for\u00a0directory\u00a0in\u00a0absolute_dependencies:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0v\u00e9rifie\u00a0l'existence\u00a0du\u00a0dossier\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0existe\u00a0=\u00a0os.path.exists(directory)\u00a0and\u00a0os.path.isdir(directory)\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0if\u00a0not\u00a0existe:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0l\u00e8ve\u00a0une\u00a0exception\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0raise\u00a0BaseException(f\"[set_syspath]\u00a0le\u00a0dossier\u00a0du\u00a0Python\u00a0Path\u00a0[{directory}]\u00a0n'existe\u00a0pas\")\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0else:\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0joute\u00a0le\u00a0dossier\u00a0au\u00a0d\u00e9but\u00a0du\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0sys.path.insert(0,\u00a0directory)\n</code></pre> <ul> <li>lignes 6-18\u00a0: la fonction [set_syspath] cr\u00e9e un Python Path avec la liste des dossiers qu\u2019on lui transmet en param\u00e8tre\u00a0;</li> <li>lignes 12-15\u00a0: on v\u00e9rifie que le dossier \u00e0 mettre dans le Python Path existe\u00a0; Le script [init.py] (deux soulign\u00e9s devant et derri\u00e8re le nom. Celui-ci est impos\u00e9) est le suivant\u00a0:</li> </ul> <pre><code>from .myutils import set_syspath\n</code></pre> <p>On importe la fonction [set_syspath] du script [myutils]. La notation [.myutils] d\u00e9signe le chemin [./myutils], donc le script [myutils] se trouvant dans le m\u00eame dossier que [__init.py]. On aurait pu utiliser la notation [myutils]. Seulement, nous allons cr\u00e9er un module [myutils] de port\u00e9e machine. Si bien que la notation [from myutils import set_syspath] deviendrait alors ambig\u00fce. S\u2019agit-il d\u2019importer le script [myutils] du dossier courant ou le script [myutils] de port\u00e9e machine\u00a0? La notation [.myutils] l\u00e8ve cette ambigu\u00eft\u00e9.</p> <p>Le script [setup.py] (l\u00e0 \u00e9galement le nom est impos\u00e9) est le suivant\u00a0:</p> <pre><code>from setuptools import setup\n\nsetup(name='myutils',\n      version='0.1',\n      description='Utilitaire fixant le Python Path',\n      url='#',\n      author='st',\n      author_email='st@gmail.com',\n      license='MIT',\n      packages=['myutils'],\n      zip_safe=False)\n</code></pre> <p>Dans ce script, on d\u00e9crit le module qu\u2019on va cr\u00e9er. Ici, nous allons le cr\u00e9er localement. Mais le m\u00eame processus est utilis\u00e9 pour cr\u00e9er un module distribu\u00e9 officiellement (cf. |pypi|). Les points importants sont ici les suivants\u00a0:</p> <ul> <li>ligne 3\u00a0: le nom du module cr\u00e9\u00e9\u00a0;</li> <li>ligne 4\u00a0: la version du module\u00a0;</li> <li>ligne 5\u00a0: sa description\u00a0;</li> <li>lignes 7-8\u00a0: l\u2019auteur du module\u00a0; Pour installer ce module avec une port\u00e9e machine, on proc\u00e8de de la fa\u00e7on suivante\u00a0:</li> </ul> <p></p> <p>Puis dans le terminal Python, on tape la commande suivante\u00a0[pip install .] :</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\packages&gt;pip install .\nProcessing c:\\data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\packages\nUsing legacy setup.py install for myutils, since package 'wheel' is not installed.\nInstalling collected packages: myutils\n  Attempting uninstall: myutils\n    Found existing installation: myutils 0.1\n    Uninstalling myutils-0.1:\n      Successfully uninstalled myutils-0.1\n    Running setup.py install for myutils ... done\nSuccessfully installed myutils-0.1\n</code></pre> <p>A partir de maintenant, tout script de la machine peut importer le module [myutils] sans que celui-ci soit dans les codes du projet.</p>"},{"location":"les-imports.html#972-le-script-configpy","title":"9.7.2. Le script [config.py]","text":"<p>Le script [config.py] assure la configuration de l\u2019application\u00a0:</p> <pre><code>def\u00a0configure():\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0nom\u00a0absolu\u00a0du\u00a0dossier\u00a0du\u00a0script\u00a0de\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemins\u00a0absolus\u00a0des\u00a0dossiers\u00a0\u00e0\u00a0mettre\u00a0dans\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossiers\u00a0locaux\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/dir1\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/dir2\",\n\u00a0\u00a0\u00a0\u00a0]\n\u00a0\u00a0\u00a0\u00a0#\u00a0mise\u00a0\u00e0\u00a0jour\u00a0du\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0retourne\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0return\u00a0{}\n</code></pre> <ul> <li>ligne 1\u00a0: la fonction [configure] assure la configuration de l\u2019application\u00a0;</li> <li>lignes 7-10\u00a0: le dictionnaire qui \u00e9tait auparavant dans [config.json]\u00a0;</li> <li>lignes 9-10\u00a0: parce qu\u2019on est dans un script, on peut avoir directement les noms absolus des dossiers [dir1, dir2]\u00a0;</li> <li>lignes 12-14\u00a0: on utilise la fonction [set_syspath] du module [myutils] que nous venons de cr\u00e9er pour d\u00e9finir le Python Path de la configuration\u00a0;</li> <li>ligne 20\u00a0: on rend le dictionnaire de la configuration de l\u2019application. Ici, il est vide\u00a0;</li> </ul>"},{"location":"les-imports.html#973-le-script-mainpy","title":"9.7.3. Le script [main.py]","text":"<p>Le script principal [main] est le suivant\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom module4 import f4\n\n# main -------------\ntry:\n    f4()\nexcept BaseException as erreur:\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\nfinally:\n    print(\"done\")\n</code></pre> <ul> <li>lignes 2-4\u00a0: on configure l\u2019application \u00e0 l\u2019aide du module [config.py]. Celui-ci est accessible car il est dans le m\u00eame dossier que le script principal. Or le dossier du script principal fait toujours partie du Python Path\u00a0;</li> <li>lorsqu\u2019on arrive \u00e0 la ligne 6, le Python Path a \u00e9t\u00e9 construit avec dedans le dossier du module [module4]. On peut donc importer celui-ci ligne 7\u00a0;</li> <li>lignes 10-15\u00a0: il ne reste plus qu\u2019\u00e0 ex\u00e9cuter la fonction [f4]\u00a0; Les r\u00e9sultats de l\u2019ex\u00e9cution dans PyCharm sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/import/07/main.py\nf3\nf4\ndone\n\nProcess finished with exit code 0\n</code></pre> <p>Dans un terminal Python et ailleurs que dans le dossier du script principal, les r\u00e9sultats sont les suivants\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\import&gt;python 07/main.py\nf3\nf4\ndone\n</code></pre> <p>D\u00e9sormais nous proc\u00e8derons toujours de la m\u00eame fa\u00e7on pour configurer une application\u00a0:</p> <ul> <li>pr\u00e9sence d\u2019un script [config.py] dans le dossier du script principal. Ce script contient une fonction [configure] qui a deux objectifs\u00a0:</li> <li>construire le Python Path pour l\u2019application. Pour cela, [config.py] d\u00e9clare tous les dossiers contenant les modules utilis\u00e9s par l\u2019application\u00a0et construit le Python Path avec leurs noms absolus\u00a0;</li> <li>construire le dictionnaire [config] de la configuration de l\u2019application\u00a0; Nous appliquons ce sch\u00e9ma \u00e0 la seconde version de l\u2019exercice d\u2019application. On se souvient en effet que la version 1 fonctionnait dans l\u2019environnement PyCharm mais pas dans un terminal Python. Le probl\u00e8me venait du Python Path.</li> </ul>"},{"location":"services-web-avec-le-framework-flask.html","title":"22. Services web avec le framework Flask","text":"<p>Par service web, on entend ici tout application web d\u00e9livrant des donn\u00e9es brutes consomm\u00e9es par un client, souvent un script console dans les exemples qui vont suivre. On ne s\u2019int\u00e9resse pas \u00e0 une technologie particuli\u00e8re, REST (REpresentational State Transfer) ou SOAP (Simple Object Access Protocol) par exemple, qui d\u00e9livrent des donn\u00e9es plus ou moins brutes dans un format bien d\u00e9fini. REST d\u00e9livre du jSON alors que pour SOAP c\u2019est du XML. Chacune de ces technologies d\u00e9crit pr\u00e9cis\u00e9ment la fa\u00e7on dont le client doit interroger le serveur et la forme que doit prendre la r\u00e9ponse de celui-ci. Dans ce cours, on sera beaucoup plus souple quant \u00e0 la nature de la requ\u00eate du client et celle de la r\u00e9ponse du serveur. Cependant, les scripts \u00e9crits et les outils utilis\u00e9s sont proches de ceux de la technologie REST.</p>"},{"location":"services-web-avec-le-framework-flask.html#221-introduction","title":"22.1. Introduction","text":"<p>Les scripts Python peuvent \u00eatre ex\u00e9cut\u00e9s par un serveur Web. Un tel script devient un programme serveur pouvant servir plusieurs clients. Du point de vue du client, appeler un service web revient \u00e0 demander l'URL de ce service. Le client peut \u00eatre \u00e9crit avec n'importe quel langage, notamment en Python. Dans ce dernier cas, on utilise alors les fonctions internet que nous venons de voir. Il nous faut par ailleurs savoir \"converser\" avec un service web, c'est \u00e0 dire comprendre le protocole HTTP de communication entre un serveur Web et ses clients. C'\u00e9tait le but du paragraphe |le protocole HTTP|. Les clients web d\u00e9crits dans cette partie du cours nous ont permis de d\u00e9couvrir une partie du protocole HTTP.</p> <p></p> <p>Dans leur version la plus simple, les \u00e9changes client / serveur sont les suivants\u00a0:</p> <ul> <li>le client ouvre une connexion avec le port 80 du serveur web\u00a0;</li> <li>il fait une requ\u00eate concernant un document\u00a0;</li> <li>le serveur web envoie le document demand\u00e9 et ferme la connexion\u00a0;</li> <li>le client ferme \u00e0 son tour la connexion\u00a0; Le document peut \u00eatre de nature diverse\u00a0: un texte au format HTML, une image, une vid\u00e9o, ... Ce peut \u00eatre un document existant (document statique) ou bien un document g\u00e9n\u00e9r\u00e9 \u00e0 la vol\u00e9e par un script (document dynamique). Dans ce dernier cas, on parle de programmation web. Le script de g\u00e9n\u00e9ration dynamique de documents peut \u00eatre \u00e9crit dans divers langages\u00a0: PHP, Python, Perl, Java, Ruby, C#, VB.net, ...</li> </ul> <p>Dans la suite, nous allons utiliser des scripts Python pour g\u00e9n\u00e9rer dynamiquement des documents texte.</p> <p></p> <ul> <li>en [1], le client ouvre une connexion avec le serveur, demande un script Python, envoie ou non des param\u00e8tres \u00e0 destination de ce script\u00a0;</li> <li>en [3], le serveur web fait ex\u00e9cuter le script Python par l'interpr\u00e9teur Python. Le script g\u00e9n\u00e8re un document qui est envoy\u00e9 au client [2]\u00a0;</li> <li>le serveur cl\u00f4t la connexion. Le client en fait autant\u00a0; Le serveur web peut traiter plusieurs clients \u00e0 la fois.</li> </ul> <p>Dans la suite, nous utiliserons deux serveurs web\u00a0:</p> <ul> <li>le serveur l\u00e9ger Werkzeug [https://werkzeug.palletsprojects.com/en/1.0.x/]. Ce serveur est utilis\u00e9 par le framework web Flask [https://flask.palletsprojects.com/en/1.1.x/]. Nous l\u2019appellerons plus fr\u00e9quemment serveur Flask\u00a0;</li> <li>le serveur Apache 2 [https://httpd.apache.org/]\u00a0; Le serveur Flask sera utilis\u00e9 dans la totalit\u00e9 des exemples. Le serveur Apache sera utilis\u00e9 pour h\u00e9berger l\u2019application web que nous allons d\u00e9velopper.</li> </ul> <p>Le framework Flask est d\u00e9velopp\u00e9 en Python. C\u2019est un module qu\u2019on installe dans un terminal PyCharm\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;pip install flask\nCollecting flask\n  Downloading Flask-1.1.2-py2.py3-none-any.whl (94 kB)\n     || 94 kB 1.1 MB/s\nCollecting click&gt;=5.1\n  Downloading click-7.1.2-py2.py3-none-any.whl (82 kB)\n     || 82 kB 5.8 MB/s\nCollecting itsdangerous&gt;=0.24\n  Downloading itsdangerous-1.1.0-py2.py3-none-any.whl (16 kB)\nCollecting Jinja2&gt;=2.10.1\n  Downloading Jinja2-2.11.2-py2.py3-none-any.whl (125 kB)\n     || 125 kB 6.4 MB/s\nCollecting Werkzeug&gt;=0.15\n  Downloading Werkzeug-1.0.1-py2.py3-none-any.whl (298 kB)\n     || 298 kB 6.4 MB/s\nCollecting MarkupSafe&gt;=0.23\n  Downloading MarkupSafe-1.1.1-cp38-cp38-win_amd64.whl (16 kB)\nInstalling collected packages: click, itsdangerous, MarkupSafe, Jinja2, Werkzeug, flask\nSuccessfully installed Jinja2-2.11.2 MarkupSafe-1.1.1 Werkzeug-1.0.1 click-7.1.2 flask-1.1.2 itsdangerous-1.1.0\n</code></pre> <ul> <li>ligne 1\u00a0: la commande ex\u00e9cut\u00e9e\u00a0;</li> <li>ligne 19\u00a0: les \u00e9l\u00e9ments qui ont \u00e9t\u00e9 install\u00e9s\u00a0:</li> <li>[flask-1.1.2]\u00a0: est un framework de d\u00e9veloppement web en Python\u00a0;</li> <li>[Werkzeug-1.0.1]\u00a0: est le serveur web qui va r\u00e9pondre aux demandes des clients\u00a0;</li> <li>[Jinja2-2.11.2]\u00a0: est un outil permetant d\u2019ins\u00e9rer des \u00e9l\u00e9ments dynamiques dans des pages qui seraient autrement des pages statiques\u00a0;</li> </ul>"},{"location":"services-web-avec-le-framework-flask.html#222-scripts-flask01-premiers-elements-de-programmation-web","title":"22.2. scripts [flask/01]\u00a0: premiers \u00e9l\u00e9ments de programmation web","text":"<p>Nos exemples seront ex\u00e9cut\u00e9s dans l\u2019architecture suivante\u00a0:</p> <p></p> <ul> <li>en [1], un script Python sera ex\u00e9cut\u00e9 comme l\u2019est un script console classique\u00a0;</li> <li>en [2], de fa\u00e7on transparente, un serveur web est instanci\u00e9 et attend des requ\u00eates. En fait il n\u2019acceptera qu\u2019une unique URL\u00a0;</li> <li>en [3], le navigateur demandera au serveur son unique URL\u00a0;</li> <li>en [4], le serveur fera ex\u00e9cuter le script Python d\u00e9sign\u00e9 par la console [1]\u00a0;</li> <li>en [5], le script rendra ses r\u00e9sultats au serveur web, un document texte\u00a0;</li> <li>en [6], le serveur web enverra au navigateur ce document texte\u00a0;</li> </ul>"},{"location":"services-web-avec-le-framework-flask.html#2221-script-exemple_01-rudiments-du-langage-html","title":"22.2.1. script [exemple_01]\u00a0: rudiments du langage HTML","text":"<p>Un navigateur web peut afficher divers documents, le plus courant \u00e9tant le document HTML (HyperText Markup Language). Celui-ci est un texte format\u00e9 avec des balises de la forme &lt;balise&gt;texte&lt;/balise&gt;. Ainsi le texte &lt;b&gt;important&lt;/b&gt; affichera le texte important en gras. Il existe des balises seules, telles que la balise &lt;hr/&gt; qui affiche une ligne horizontale. Nous ne passerons pas en revue les balises que l'on peut trouver dans un texte HTML. Il existe de nombreux logiciels WYSIWYG permettant de construire une page WEB sans \u00e9crire une ligne de code HTML. Ces outils g\u00e9n\u00e8rent automatiquement le code HTML d'une mise en page faite \u00e0 l'aide de la souris et de contr\u00f4les pr\u00e9d\u00e9finis. On peut ainsi ins\u00e9rer (avec la souris) dans la page un tableau puis consulter le code HTML g\u00e9n\u00e9r\u00e9 par le logiciel pour d\u00e9couvrir les balises \u00e0 utiliser pour d\u00e9finir un tableau dans une page WEB. Ce n'est pas plus compliqu\u00e9 que cela. Par ailleurs, la connaissance du langage HTML est indispensable puisque les applications web dynamiques doivent g\u00e9n\u00e9rer elles-m\u00eames le code HTML \u00e0 envoyer aux clients web. Ce code est g\u00e9n\u00e9r\u00e9 par programme et il faut bien s\u00fbr savoir ce qu'il faut g\u00e9n\u00e9rer pour que le client ait la page web qu'il d\u00e9sire.</p> <p>Pour r\u00e9sumer, il n'est nul besoin de conna\u00eetre la totalit\u00e9 du langage HTML pour d\u00e9marrer la programmation web. Cependant cette connaissance est n\u00e9cessaire et peut \u00eatre acquise au travers de l'utilisation de logiciels WYSIWYG de construction de pages WEB tels que DreamWeaver et des dizaines d'autres. Une autre fa\u00e7on de d\u00e9couvrir les subtilit\u00e9s du langage HTML est de parcourir le web et d'afficher le code source des pages qui pr\u00e9sentent des caract\u00e9ristiques int\u00e9ressantes et encore inconnues pour vous.</p> <p>Consid\u00e9rons l'exemple suivant qui pr\u00e9sente quelques \u00e9l\u00e9ments qu'on peut trouver dans un document web tels que\u00a0:</p> <ul> <li>un tableau\u00a0;</li> <li>une image\u00a0;</li> <li>un lien\u00a0;</li> </ul> <p></p> <p>Un document HTML est encadr\u00e9 par les balises &lt;html&gt;\u2026&lt;/html&gt;. Il est form\u00e9 de deux parties\u00a0:</p> <ul> <li>&lt;head&gt;\u2026&lt;/head&gt;\u00a0: c'est la partie non affichable du document. Elle donne des renseignements au navigateur qui va afficher le document. On y trouve souvent la balise &lt;title&gt;\u2026&lt;/title&gt; qui fixe le texte qui sera affich\u00e9 dans la barre de titre du navigateur. On peut y trouver d'autres balises notamment des balises d\u00e9finissant les mots cl\u00e9s du document, mot cl\u00e9s utilis\u00e9s ensuite par les moteurs de recherche. On peut trouver \u00e9galement dans cette partie des scripts, \u00e9crits le plus souvent en javascript ou vbscript et qui seront ex\u00e9cut\u00e9s par le navigateur\u00a0;</li> <li>&lt;body attributs&gt;\u2026&lt;/body&gt;\u00a0: c'est la partie qui sera affich\u00e9e par le navigateur. Les balises HTML contenues dans cette partie indiquent au navigateur la forme visuelle \"souhait\u00e9e\" pour le document. Chaque navigateur va interpr\u00e9ter ces balises \u00e0 sa fa\u00e7on. Deux navigateurs peuvent alors visualiser diff\u00e9remment un m\u00eame document web. C'est g\u00e9n\u00e9ralement l'un des casse-t\u00eates des concepteurs web\u00a0; Le code HTML de notre document exemple est le suivant\u00a0:</li> </ul> <pre><code>&lt;!DOCTYPE html&gt;\n&lt;html xmlns=\"http://www.w3.org/1999/xhtml\"&gt;\n&lt;head&gt;\n  &lt;meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" /&gt;\n  &lt;title&gt;Quelques balises HTML&lt;/title&gt;\n&lt;/head&gt;\n\n&lt;body style=\"background-image: url(/static/images/standard.jpg)\"&gt;\n  &lt;h1 style=\"text-align: left\"&gt;Quelques balises HTML&lt;/h1&gt;\n  &lt;hr /&gt;\n\n  &lt;table border=\"1\"&gt;\n    &lt;thead&gt;\n      &lt;tr&gt;\n        &lt;th&gt;Colonne 1&lt;/th&gt;\n        &lt;th&gt;Colonne 2&lt;/th&gt;\n        &lt;th&gt;Colonne 3&lt;/th&gt;\n      &lt;/tr&gt;\n    &lt;/thead&gt;\n    &lt;tbody&gt;\n      &lt;tr&gt;\n        &lt;td&gt;cellule(1,1)&lt;/td&gt;\n        &lt;td style=\"text-align: center;\"&gt;cellule(1,2)&lt;/td&gt;\n        &lt;td&gt;cellule(1,3)&lt;/td&gt;\n      &lt;/tr&gt;\n      &lt;tr&gt;\n        &lt;td&gt;cellule(2,1)&lt;/td&gt;\n        &lt;td&gt;cellule(2,2)&lt;/td&gt;\n        &lt;td&gt;cellule(2,3&lt;/td&gt;\n      &lt;/tr&gt;\n    &lt;/tbody&gt;\n  &lt;/table&gt;\n  &lt;br /&gt;&lt;br /&gt;\n  &lt;table border=\"0\"&gt;\n    &lt;tr&gt;\n      &lt;td&gt;Une image&lt;/td&gt;\n      &lt;td&gt;\n        &lt;img border=\"0\" src=\"/static/images/cerisier.jpg\" /&gt;\n      &lt;/td&gt;\n    &lt;/tr&gt;\n    &lt;tr&gt;\n      &lt;td&gt;Le site de Polytech'Angers&lt;/td&gt;\n      &lt;td&gt;&lt;a href=\"http://www.polytech-angers.fr/fr/index.html\"&gt;ici&lt;/a&gt;&lt;/td&gt;\n    &lt;/tr&gt;\n  &lt;/table&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>El\u00e9ment</p><p>balises et exemples HTML</p> <pre><code>titre du document\n</code></pre> <p>&lt;title&gt;Quelques balises HTML&lt;/title&gt; (ligne 5)</p><p>le texte [Quelques balises HTML] appara\u00eetra dans la barre de titre du navigateur qui affichera le document</p> <pre><code>barre horizontale\n</code></pre> <p>&lt;hr /&gt;\u00a0: affiche un trait horizontal (ligne 10)</p> <pre><code>tableau\n</code></pre> <p>&lt;table attributs&gt;\u2026.&lt;/table&gt;\u00a0: pour d\u00e9finir le tableau (lignes 12, 32)</p><p>&lt;thead&gt;\u2026&lt;/thead&gt;\u00a0: pour d\u00e9finir les ent\u00eates des colonnes (lignes 13, 19)</p><p>&lt;tbody&gt;\u2026&lt;/tbody&gt;\u00a0: pour d\u00e9finir le contenu du tableau (ligne 20, 31)</p><p>&lt;tr attributs&gt;\u2026&lt;/tr&gt;\u00a0: pour d\u00e9finir une ligne (lignes 21, 25)</p><p>&lt;td attributs&gt;\u2026&lt;/td&gt;\u00a0: pour d\u00e9finir une cellule (ligne 22)</p><p>exemples\u00a0:</p><p>&lt;table border=\"1\"&gt;\u2026&lt;/table&gt;\u00a0: l'attribut border d\u00e9finit l'\u00e9paisseur de la bordure du tableau</p><p>&lt;td style=\"text-align: center;\"&gt;cellule(1,2)&lt;/td&gt; (ligne 23)\u00a0: d\u00e9finit une cellule dont le contenu sera cellule(1,2). Ce contenu sera centr\u00e9 horizontalement (text-align: center).</p> <pre><code>image\n</code></pre> <p>&lt;img border=\"0\" src=\"/static/images/cerisier.jpg\"/&gt; (ligne 38)\u00a0: d\u00e9finit une image sans bordure (border=0\") dont le fichier source est [/static/images/cerisier.jpg] sur le serveur web (src=\"/static/images/cerisier.jpg\"). Si ce lien se trouve sur un document web obtenu avec l'URL [http://server/chemin/balises.html], alors le navigateur demandera l'URL [http://server/ static/images/cerisier.jpg] pour avoir l'image r\u00e9f\u00e9renc\u00e9e ici.</p> <pre><code>lien\n</code></pre> <p>&lt;a href=\"http://www.polytech-angers.fr/fr/index.html\"&gt;ici&lt;/a&gt; (ligne 43)\u00a0: fait que le texte ici sert de lien vers l'URL http://www.polytech-angers.fr/fr/index.html.</p> <pre><code>fond de page\n</code></pre> <p>&lt;body style=\"background-image: url(/static/images/standard.jpg)\"&gt; (ligne 8)\u00a0: indique que l'image qui doit servir de fond de page se trouve \u00e0 l'URL [/static/images/standard.jpg] du serveur web. Dans le contexte de notre exemple, le navigateur demandera l'URL [http://server/static/images/standard.jpg] pour obtenir cette image de fond.</p> <p>On voit dans ce simple exemple que pour construire l'int\u00e9gralit\u00e9 du document, le navigateur doit faire trois requ\u00eates au serveur\u00a0:</p> <ul> <li>[http://server/chemin/balises.html] pour avoir le source HTML du document\u00a0;</li> <li>[http://server/static/images/cerisier.jpg] pour avoir l'image cerisier.jpg\u00a0;</li> <li>[http://server/static/images/standard.jpg] pour obtenir l'image de fond standard.jpg\u00a0; Le script [exemple_01] va nous permettre d\u2019afficher la page statique [balises.html] pr\u00e9c\u00e9dente\u00a0:</li> </ul> <p></p> <ul> <li>en [1], le script [exemple_01] qui va \u00eatre ex\u00e9cut\u00e9\u00a0;</li> <li>en [3], le document HTML qui va \u00eatre affich\u00e9 par le script\u00a0;</li> <li>en [2], les images du document HTML\u00a0; Le script [exemple_01] est le suivant\u00a0:</li> </ul> <pre><code>import os\n\nfrom flask import Flask, make_response, render_template\n\n# application Flask\nscript_dir = os.path.dirname(os.path.abspath(__file__))\napp = Flask(__name__, template_folder=f\"{script_dir}/../templates\", static_folder=f\"{script_dir}/../static\")\n\n\n# Home URL\n@app.route('/')\ndef index():\n    # affichage de la page\n    return make_response(render_template(\"balises.html\"))\n\n\n# main\nif __name__ == '__main__':\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>ligne 7\u00a0: on instancie une application Flask. Une application Flask est une application web\u00a0;</li> <li>le 1er param\u00e8tre est le nom donn\u00e9 \u00e0 l\u2019application. On peut donner le nom que l\u2019on veut. Ici on a utilis\u00e9 l\u2019attribut pr\u00e9d\u00e9fini [name] qui vaut [main] (ligne 18)\u00a0;</li> <li>le second param\u00e8tre est un param\u00e8tre nomm\u00e9, \u00e7-\u00e0-d que sa position dans l\u2019ordre des param\u00e8tres n\u2019a pas d\u2019importance. Le param\u00e8tre nomm\u00e9 [template_folder] d\u00e9signe le dossier o\u00f9 trouver les pages statiques de l\u2019application web. Les pages statiques sont d\u00e9livr\u00e9es telles quelles au navigateur. Ici, les pages statiques seront trouv\u00e9es dans le dossier [templates] de l\u2019arborescence du projet. Ligne 7, nous avons mis un chemin relatif au dossier [script_dir] contenant le script [exemple_01] ex\u00e9cut\u00e9\u00a0;</li> <li>le troisi\u00e8me param\u00e8tre est \u00e9galement un param\u00e8tre nomm\u00e9. [static_folder] d\u00e9signe le dossier o\u00f9 on va trouver les ressources du document HTML (images, vid\u00e9os, \u2026). La \u00e9galement, nous avons mis un chemin relatif au dossier [script_dir] contenant le script [exemple_01] ex\u00e9cut\u00e9\u00a0;</li> <li>lignes 10-14\u00a0: on d\u00e9finit les URL accept\u00e9es par l\u2019application web. Chaque URL est associ\u00e9e \u00e0 une fonction qui s\u2019ex\u00e9cute lorsque l\u2019URL est demand\u00e9e par un navigateur web\u00a0;</li> <li>ligne 11\u00a0: l\u2019unique URL de l\u2019application est l\u2019URL [/]. Notez que dans [@app.route('/')], [app] est la variable initialis\u00e9e ligne 7. La d\u00e9finition des routes (les diff\u00e9rentes URL g\u00e9r\u00e9es par l\u2019application) vient donc forc\u00e9ment apr\u00e8s la d\u00e9finition de l\u2019application [app]. Ce dernier nom est libre\u00a0;</li> <li>lignes 12-14\u00a0: la fonction qui s\u2019ex\u00e9cute lorsqu\u2019on demande l\u2019URL [/] \u00e0 l\u2019application web [exemple_01]\u00a0;</li> <li>ligne 12\u00a0: la fonction associ\u00e9e \u00e0 une URL peut porter un nom quelconque. Elle peut parfois avoir des param\u00e8tres pour r\u00e9cup\u00e9rer des \u00e9l\u00e9ments de l\u2019URL qui lui est associ\u00e9e. Ici elle n\u2019en a pas\u00a0;</li> <li>ligne 14\u00a0:</li> <li>la fonction [render_template] rend une cha\u00eene de caract\u00e8res qui est le document texte produit par son param\u00e8tre. Celui-ci est ici [balises.html]. A cause du [template_folder] de la ligne 7, ce document sera cherch\u00e9 dans le dossier [f\"{script_dir}/../templates\"]. C\u2019est effectivement l\u00e0 qu\u2019il se trouve\u00a0;</li> <li>la fonction [make_response] g\u00e9n\u00e8re une r\u00e9ponse HTTP pour le navigateur qui lui a demand\u00e9 l\u2019URL [/]. On a vu dans le paragraphe |le protocole HTTP| qu\u2019une r\u00e9ponse HTTP a deux \u00e9l\u00e9ments\u00a0:</li> <li>des ent\u00eates HTTP\u00a0;</li> <li> <p>le document demand\u00e9 par le navigateur, ici un document HTML\u00a0; Ligne 14, on a donn\u00e9 aucun param\u00e8tre \u00e0 la fonction [make_response] pour g\u00e9n\u00e9rer des ent\u00eates HTTP. Elle va alors en g\u00e9n\u00e9rer par d\u00e9faut. On verra ult\u00e9rieurement comment fixer ces ent\u00eates HTTP.</p> </li> <li> <p>finalement, lorsque le navigateur demande l\u2019URL / \u00e0 l\u2019application Flask, il obtient la page [balises.html]\u00a0;</p> </li> <li>lignes 17-20\u00a0: ces lignes servent \u00e0 lancer le serveur web qui va ex\u00e9cuter l\u2019application web [exemple_01]\u00a0;</li> <li>ligne 18\u00a0: cette condition n\u2019est vraie que lorsque le script [exemple_01] est lanc\u00e9 au sein d\u2019une console\u00a0;</li> <li>ligne 19\u00a0: l\u2019application [app] de la ligne 7 est configur\u00e9e\u00a0:</li> <li>le param\u00e8tre nomm\u00e9 [ENV=\"development\"] met le serveur web en mode d\u00e9veloppement\u00a0: d\u00e8s que le d\u00e9veloppeur modifie un \u00e9l\u00e9ment de l\u2019application celle-ci est r\u00e9g\u00e9n\u00e9r\u00e9e et d\u00e9livr\u00e9e au serveur web. Le d\u00e9veloppeur n\u2019a pas besoin de demander une nouvelle ex\u00e9cution\u00a0;</li> <li>le param\u00e8tre nomm\u00e9 [DEBUG=True] va permettre au d\u00e9veloppeur de mettre des points d\u2019arr\u00eat dans le code de l\u2019application\u00a0;</li> <li>ligne 20\u00a0: l\u2019application web est lanc\u00e9e\u00a0: un serveur web est instanci\u00e9 et l\u2019application web est d\u00e9ploy\u00e9e dessus afin de r\u00e9pondre aux requ\u00eates de clients web\u00a0; Voici un exemple d\u2019ex\u00e9cution\u00a0:</li> </ul> <p></p> <p>Les logs suivants apparaissent alors dans la console d\u2019ex\u00e9cution\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/flask/01/main/exemple_01.py\n * Serving Flask app \"exemple_01\" (lazy loading)\n * Environment: development\n * Debug mode: on\n * Restarting with stat\n * Debugger is active!\n * Debugger PIN: 334-263-283\n * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)\n</code></pre> <ul> <li>ligne 2\u00a0: le serveur affiche le script ex\u00e9cut\u00e9\u00a0;</li> <li>ligne 3\u00a0: on est en mode d\u00e9veloppement\u00a0;</li> <li>lignes 4-5\u00a0: le serveur voit qu\u2019on l\u2019a lanc\u00e9 en mode [debug]. Il red\u00e9marre alors (ligne 5). Le mode [debug] ralentit donc un peu le d\u00e9marrage\u00a0;</li> <li>ligne 8\u00a0: l\u2019URL o\u00f9 l\u2019application web d\u00e9ploy\u00e9e [exemple_01] est disponible\u00a0; Avec un navigateur web demandons l\u2019URL [http://127.0.0.1:5000/]\u00a0:</li> </ul> <p></p> <p>On obtient bien le document [balises.html] attendu.</p>"},{"location":"services-web-avec-le-framework-flask.html#2222-script-exemple_02-generer-un-document-html-dynamiquement","title":"22.2.2. script [exemple_02]\u00a0: g\u00e9n\u00e9rer un document HTML dynamiquement","text":"<p>Le script [exemple_02] [1] va g\u00e9n\u00e9rer le document [exemple_02.html] [2] suivant\u00a0:</p> <pre><code>&lt;!DOCTYPE html&gt;\n&lt;html lang=\"fr\"&gt;\n&lt;head&gt;\n    &lt;meta charset=\"UTF-8\"&gt;\n    &lt;title&gt;{{page.title}}&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n    &lt;b&gt;{{page.contents}}&lt;/b&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>Ce document est dynamique parce que son contenu n\u2019est totalement connu qu\u2019au moment o\u00f9 le serveur web le sert. On y trouve en effet aux lignes 5 et 8 deux \u00e9l\u00e9ments non connus au moment de l\u2019\u00e9criture de la page. Ils ne sont connus qu\u2019au moment o\u00f9 la page est envoy\u00e9e \u00e0 un client. Ils sont alors remplac\u00e9s par leurs valeurs, celles-ci \u00e9tant des cha\u00eenes de caract\u00e8res.</p> <ul> <li>lignes 5, 8\u00a0: la syntaxe {{expression}} est une syntaxe du langage de templates Jinja2 [https://jinja.palletsprojects.com/en/2.11.x/]. Avant que la page ne soit envoy\u00e9e \u00e0 un client, les \u00e9l\u00e9ments dynamiques de la page (lignes 5 et 8) sont \u00e9valu\u00e9s et remplac\u00e9s par leurs valeurs\u00a0;</li> <li>ligne 5\u00a0: on a utilis\u00e9 la syntaxe [page.title]. On a donc suppos\u00e9 qu\u2019\u00e0 la g\u00e9n\u00e9ration de la page avant son envoi, une variable [page] est connue, on verra comment. Dans la syntaxe {{expression}} on peut utiliser les noms de variables que l\u2019on veut. Aux lignes 5 et 8, on pourrait ainsi avoir {{title}} et {{contents}}. On pourrait dire alors que [title] et [contents] sont des param\u00e8tres de la page. Dans la suite, nous utiliserons toujours la m\u00eame technique\u00a0:</li> <li>l\u2019unique param\u00e8tre de la page sera un dictionnaire [page]\u00a0;</li> <li>les attributs de ce dictionnaire seront utilis\u00e9s dans la page. Ici [page.title] ligne 5 et [page.contents] ligne 8\u00a0; L\u2019application web [exemple_02.py] est la suivante\u00a0:</li> </ul> <pre><code>from flask import Flask, make_response, render_template\n\n# application Flask\nscript_dir = os.path.dirname(os.path.abspath(__file__))\napp = Flask(__name__, template_folder=f\"{script_dir}/../templates\", static_folder=f\"{script_dir}/../static\")\n\n\n# Home URL\n@app.route('/')\ndef index():\n    # contenu de la page sous la forme d'un dictionnaire\n    page = {\"title\": \"un titre\", \"contents\": \"un contenu\"}\n    # affichage de la page\n    return make_response(render_template(\"exemple_02.html\", page=page))\n\n\n# main\nif __name__ == '__main__':\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>nous avons d\u00e9j\u00e0 expliqu\u00e9 dans l\u2019exemple pr\u00e9c\u00e9dent, les lignes 4-5 et 18-20. Nous utiliserons toujours ce sch\u00e9ma dans nos exemples\u00a0;</li> <li>ligne 9\u00a0: la seule URL servie par l\u2019application web est l\u2019URL /\u00a0;</li> <li>ligne 14\u00a0: le document servi \u00e0 l\u2019URL / est le document [exemple_02.html] que nous venons de commenter. Nous savons qu\u2019il a un param\u00e8tre, un dictionnaire appel\u00e9 [page]\u00a0;</li> <li>ligne 12\u00a0: nous d\u00e9finissons le dictionnaire qui va \u00eatre pass\u00e9 en param\u00e8tre \u00e0 la page [exemple_02.html]. Il peut porter n\u2019importe quel nom. Il doit cependant avoir les attributs [title, contents] utilis\u00e9s dans le document HTML\u00a0;</li> <li>ligne 14\u00a0: la fonction [render_template] a pour r\u00f4le de rendre la cha\u00eene de caract\u00e8res du document [exemple_02.html]. Comme celui-ci est un document param\u00e9tr\u00e9, on transmet \u00e0 la fonction [render_template] le ou les param\u00e8tres attendus. Nous le faisons ici en donnant une valeur au param\u00e8tre nomm\u00e9 [page]. Dans l\u2019op\u00e9ration [page=page]\u00a0:</li> <li>\u00e0 gauche du signe =, on a le param\u00e8tre [page] utilis\u00e9 dans le document [exemple_02.html]\u00a0;</li> <li>\u00e0 droite du signe =, on a la valeur [page] d\u00e9finie ligne 12\u00a0;</li> <li>de fa\u00e7on g\u00e9n\u00e9rale, si un document HTML a les param\u00e8tres [param1, param2, \u2026, paramn], on passera leurs valeurs \u00e0 la fonction [render_template] sous la forme [render_template(document, param1=valeur1, param2=valeur2, \u2026]\u00a0; Avant d\u2019ex\u00e9cuter [exemple_02], nous devons arr\u00eater l\u2019ex\u00e9cution de [exemple_01]\u00a0:</li> </ul> <p></p> <p>Si lors de l\u2019ex\u00e9cution d\u2019un script 1, vous avez l\u2019impression que c\u2019est un script 2 qui s\u2019ex\u00e9cute c\u2019est probablement parce que celui-ci est toujours en ex\u00e9cution. Pour revenir \u00e0 un \u00e9tat connu, vous pouvez arr\u00eater tous les processus en cours d\u2019ex\u00e9cution dans PyCharm\u00a0(en haut et \u00e0 droite dans fen\u00eatre PyCharm)\u00a0:</p> <p></p> <p>Ex\u00e9cutons le script [exemple_02]\u00a0:</p> <p></p> <p>Les logs console sont alors les suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/flask/01/main/exemple_02.py\n * Serving Flask app \"exemple_02\" (lazy loading)\n * Environment: development\n * Debug mode: on\n * Restarting with stat\n * Debugger is active!\n * Debugger PIN: 334-263-283\n * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)\n</code></pre> <p>La ligne 8 indique le port de d\u00e9ploiement (5000) de l\u2019application [exemple_02] (ligne 1) sur la machine [localhost]. Les lignes pr\u00e9c\u00e9dentes \u00e9tant toujours les m\u00eames, nous ne les remontrerons plus.</p> <p>Avec un navigateur, nous demandons l\u2019URL [http://localhost:5000/]\u00a0:</p> <p></p> <ul> <li>l\u2019expression {{page.title}} a produit [1]\u00a0;</li> <li>l\u2019expression {{page.contents}} a produit [2]\u00a0;</li> </ul>"},{"location":"services-web-avec-le-framework-flask.html#2223-script-exemple_03-utiliser-des-fragments-de-page","title":"22.2.3. script [exemple_03]\u00a0: utiliser des fragments de page","text":"<ul> <li>en [1], le script [exemple_03.py] va g\u00e9n\u00e9rer le document dynamique [exemple_03.html] [2]. Celui-ci sera construit \u00e0 partir des fragments de page [fragment_01.html, fragment_02.html] [3]\u00a0; Le document [exemple_03.html] sera le suivant\u00a0:</li> </ul> <pre><code>&lt;!DOCTYPE html&gt;\n&lt;html lang=\"fr\"&gt;\n{% include \"fragments/fragment_01.html\" %}\n&lt;body&gt;\n{% include \"fragments/fragment_02.html\" %}\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <ul> <li>lignes 3 et 5, on utilise la directive [include] de Jinja2 pour inclure dans le document des \u00e9l\u00e9ments externes \u00e0 celui-ci\u00a0;</li> <li>la syntaxe est {% include \u2026 %}. Le param\u00e8tre de la directive [include] est le chemin du document \u00e0 incorporer. Ce chemin est relatif au param\u00e8tre [template_folder] de l\u2019application Flask\u00a0: <pre><code>app = Flask(__name__, template_folder=\"../templates\", static_folder=\"../static\")\n</code></pre></li> </ul> <p>Donc ici, les chemins des documents sont mesur\u00e9s par rapport au dossier [templates].</p> <p>Le fragment [fragment_01.html] (les noms sont bien s\u00fbr libres) est le suivant\u00a0:</p> <pre><code>&lt;meta charset=\"UTF-8\"&gt;\n&lt;title&gt;{{page.title}}&lt;/title&gt;\n</code></pre> <p>Le fragment [fragment_02.html] est le suivant\u00a0:</p> <pre><code>&lt;b&gt;{{page.contents}}&lt;/b&gt;\n</code></pre> <p>Si on reconstitue le document [exemple_03.html] avec ces fragments, on obtient le code suivant\u00a0:</p> <pre><code>&lt;!DOCTYPE html&gt;\n&lt;html lang=\"fr\"&gt;\n&lt;meta charset=\"UTF-8\"&gt;\n&lt;title&gt;{{page.title}}&lt;/title&gt;\n&lt;body&gt;\n&lt;b&gt;{{page.contents}}&lt;/b&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>On a donc un document identique \u00e0 [exemple_02.html] mais construit \u00e0 partir de fragments.</p> <p>Le script web [exemple_03.py] est le suivant\u00a0:</p> <pre><code>import os\n\nfrom flask import Flask, make_response, render_template\n\n# application Flask\nscript_dir = os.path.dirname(os.path.abspath(__file__))\napp = Flask(__name__, template_folder=f\"{script_dir}/../templates\", static_folder=f\"{script_dir}/../static\")\n\n\n# Home URL\n@app.route('/')\ndef index():\n    # contenu de la page\n    page = {\"title\": \"un autre titre\", \"contents\": \"un autre contenu\"}\n    # affichage de la page\n    return make_response(render_template(\"views/exemple_03.html\", page=page))\n\n\n# main\nif __name__ == '__main__':\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <p>Le code est analogue \u00e0 celui de [exemple_02.py]. Ligne 16, on montre comment on peut r\u00e9f\u00e9rencer des documents pr\u00e9sents dans des sous-dossiers de [template_folder] de la ligne 7.</p> <p>L\u2019ex\u00e9cution du script [exemple_03.py] donne les r\u00e9sultats suivants dans le navigateur\u00a0:</p> <p></p>"},{"location":"services-web-avec-le-framework-flask.html#223-scripts-flask02-service-web-de-date-et-heure","title":"22.3. scripts [flask/02]\u00a0: service web de date et heure","text":"<p>Le document [date_time_server.html] est le suivant\u00a0:</p> <p></p> <pre><code>&lt;!DOCTYPE html&gt;\n&lt;html lang=\"fr\"&gt;\n&lt;head&gt;\n    &lt;meta charset=\"UTF-8\"&gt;\n    &lt;title&gt;Date et heure du moment&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n    &lt;b&gt;Date et heure du moment : {{page.date_heure}}&lt;/b&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <ul> <li>ligne 8\u00a0: la page admet le param\u00e8tre [page.date_heure]\u00a0; Le service web [date_time_server.py] est le suivant\u00a0:</li> </ul> <pre><code># imports\nimport os\nimport time\n\nfrom flask import Flask, make_response, render_template\n\n# application Flask\nscript_dir = os.path.dirname(os.path.abspath(__file__))\napp = Flask(__name__, template_folder=f\"{script_dir}\")\n\n\n# Home URL\n@app.route('/')\ndef index():\n    # envoi heure au client\n    # time.localtime : nb de millisecondes depuis 01/01/1970\n    # time.strftime permet de formater l'heure et la date\n    # format affichage date-heure\n    # d: jour sur 2 chiffres\n    # m: mois sur 2 chiffres\n    # y : ann\u00e9e sur 2 chiffres\n    # H : heure 0,23\n    # M : minutes\n    # S: secondes\n\n    # date / heure du moment\n    time_of_day = time.strftime('%d/%m/%y %H:%M:%S', time.localtime())\n    # on g\u00e9n\u00e8re le document \u00e0 envoyer au client\n    page = {\"date_heure\": time_of_day}\n    document = render_template(\"date_time_server.html\", page=page)\n    print(\"document\", type(document), document)\n    # r\u00e9ponse HTTP au client\n    response = make_response(document)\n    print(\"response\", type(response), response)\n    return response\n\n\n# main seulement\nif __name__ == '__main__':\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>ligne 13\u00a0: l\u2019application web ne sert que l\u2019URL /\u00a0;</li> <li>lignes 15-24\u00a0: expliquent comment obtenir date et heure et comment les afficher\u00a0;</li> <li>ligne 27\u00a0: cha\u00eene de caract\u00e8res repr\u00e9sentant la date et l\u2019heure du moment\u00a0;</li> <li>lignes 28-30\u00a0: on g\u00e9n\u00e8re le document dynamique [date_time_server.html] en lui passant le dictionnaire [page] de la ligne 29\u00a0;</li> <li>ligne 31\u00a0: on affiche le type de [document] et le document lui-m\u00eame. On veut montrer que c\u2019est une cha\u00eene de caract\u00e8res\u00a0;</li> <li>ligne 33\u00a0: on g\u00e9n\u00e8re la r\u00e9ponse HTTP qui va \u00eatre envoy\u00e9e au client (elle n\u2019est pas encore envoy\u00e9e)\u00a0;</li> <li>ligne 34\u00a0: on affiche son type et sa valeur\u00a0;</li> <li>ligne 35\u00a0: la r\u00e9ponse HTTP est envoy\u00e9e au client\u00a0; L\u2019ex\u00e9cution du script donne le r\u00e9sultat suivant dans un navigateur\u00a0:</li> </ul> <p></p> <p>Les logs dans la console sont les suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\flask\\02\\date_time_server.py\n * Serving Flask app \"date_time_server\" (lazy loading)\n * Environment: development\n * Debug mode: on\n * Restarting with stat\n * Debugger is active!\n * Debugger PIN: 334-263-283\n * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)\n127.0.0.1 - - [10/Jul/2020 09:32:09] \"GET / HTTP/1.1\" 200 -\ndocument &lt;class 'str'&gt; &lt;!DOCTYPE html&gt;\n&lt;html lang=\"fr\"&gt;\n&lt;head&gt;\n    &lt;meta charset=\"UTF-8\"&gt;\n    &lt;title&gt;Date et heure du moment&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n    &lt;b&gt;Date et heure du moment : 10/07/20 09:42:33&lt;/b&gt;\n&lt;/body&gt;\n&lt;/html&gt;\nresponse &lt;class 'flask.wrappers.Response'&gt; &lt;Response 195 bytes [200 OK]&gt;\n</code></pre> <ul> <li>ligne 10\u00a0: on voit que le type de la valeur rendue par [render_template] est de type [str]. Cette cha\u00eene de caract\u00e8res n\u2019est autre que le document [date_time_server.html] une fois interpr\u00e9t\u00e9 (lignes 10-19)\u00a0;</li> <li>ligne 20\u00a0: on voit que le type de la valeur rendue par [make_response] est de type [flask.wrappers.Response]. La fonction [Response.str] a \u00e9t\u00e9 implicitement appel\u00e9e pour afficher l\u2019objet [Response]. La cha\u00eene rendue par cette fonction donne deux informations sur la r\u00e9ponse HTTP qui va \u00eatre faite\u00a0:</li> <li>le document envoy\u00e9 fait 195 octets\u00a0;</li> <li>le statut de la r\u00e9ponse HTTP est [200 OK]. On verra ult\u00e9rieurement qu\u2019on a acc\u00e8s \u00e0 ce code de statut\u00a0;</li> </ul>"},{"location":"services-web-avec-le-framework-flask.html#224-scripts-flask03-services-web-generant-du-texte-brut","title":"22.4. scripts [flask/03]\u00a0: services web g\u00e9n\u00e9rant du texte brut","text":"<p>Nous avons vu dans un pr\u00e9c\u00e9dent exemple que le service web d\u00e9livrait le document suivant\u00a0:</p> <pre><code>&lt;!DOCTYPE html&gt;\n&lt;html lang=\"fr\"&gt;\n&lt;head&gt;\n    &lt;meta charset=\"UTF-8\"&gt;\n    &lt;title&gt;Date et heure du moment&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n    &lt;b&gt;Date et heure du moment : {{page.date_heure}}&lt;/b&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>Un client web pourrait n\u2019\u00eatre int\u00e9ress\u00e9 que par l\u2019information [page.date_heure] de la ligne 8 et pas par l\u2019habillage HTML qu\u2019il y a autour. Le service web pourrait d\u00e9livrer cette information comme une simple cha\u00eene de caract\u00e8res. Nous allons pr\u00e9senter ici des exemples de ce type de service web.</p>"},{"location":"services-web-avec-le-framework-flask.html#2241-script-main_01","title":"22.4.1. script [main_01]","text":"<ul> <li>[main_01] est le service web\u00a0;</li> <li>[config] est le script de configuration de l\u2019application web\u00a0;</li> <li>le service web utilise certaines des entit\u00e9s d\u00e9finies en [2]\u00a0; Le script [config] est le suivant\u00a0:</li> </ul> <pre><code>def configure():\n    # chemin absolu r\u00e9f\u00e9rence des chemins relatifs de la configuration\n    rootDir = \"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020\"\n\n    # d\u00e9pendances de l'application\n    absolute_dependencies = [\n        # Personne, Utils, MyException\n        f\"{rootDir}/classes/02/entities\",\n\n    ]\n    # on fixe le syspath\n    from myutils import set_syspath\n    set_syspath(absolute_dependencies)\n\n    # on rend la config\n    return {}\n</code></pre> <p>Le r\u00f4le premier de cette configuration est de d\u00e9finir le Python Path du service web. Il faut qu\u2019on puisse trouver les entit\u00e9s [2] (ligne 8).</p> <p>Le script web [main_01] est le suivant\u00a0:</p> <pre><code># on configure l'application\nimport config\nconfig=config.configure()\n\n# imports\nfrom flask import Flask, make_response\nfrom flask_api import status\n\n# d\u00e9pendances\nfrom Personne import Personne\n\n# application Flask (pas de documents statiques ici)\napp = Flask(__name__)\n\n\n# Home URL\n@app.route('/')\ndef index():\n    # une personne\n    personne = Personne().fromdict({\"pr\u00e9nom\": \"Agla\u00eb\", \"nom\": \"de la H\u00fbche\", \"\u00e2ge\": 87})\n    # r\u00e9ponse HTTP\n    response = make_response(str(personne))\n    # headers HTTP\n    response.headers.set(\"Content-type\", \"application/json; charser=utf8\")\n    # on rend la r\u00e9ponse HTTP\n    return response, status.HTTP_200_OK\n\n\n# main uniquement\nif __name__ == '__main__':\n    # on lance le serveur\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>lignes 1-3\u00a0: le Python Path de l\u2019application est fix\u00e9\u00a0;</li> <li>lignes 5-10\u00a0: on importe les \u00e9l\u00e9ments dont a besoin le script\u00a0;</li> <li>ligne 17\u00a0: le service web ne sert que l\u2019URL /\u00a0;</li> <li>ligne 20\u00a0: on cr\u00e9e un objet [Personne]\u00a0;</li> <li>ligne 22\u00a0: on cr\u00e9e une r\u00e9ponse HTTP avec la cha\u00eene de caract\u00e8res repr\u00e9sentant la personne. La fonction [Personne.str] va \u00eatre appel\u00e9e. Celle-ci rend la cha\u00eene jSON du dictionnaire [asdict] de la personne (cf. |classe BaseEntity|). Le param\u00e8tre de la fonction [make_response] est le document texte envoy\u00e9 au client, donc ici la cha\u00eene jSON d\u2019une personne\u00a0;</li> <li>ligne 24\u00a0: on met dans les ent\u00eates HTTP de la r\u00e9ponse, un ent\u00eate [Content-type] qui indique au client quel type de document il va recevoir, ici un document jSON cod\u00e9 en UTF-8\u00a0;</li> <li>ligne  26\u00a0: on rend un tuple de deux \u00e9l\u00e9ments\u00a0:</li> <li>la r\u00e9ponse au client, ent\u00eates HTTP et document\u00a0;</li> <li>le code de statut de la r\u00e9ponse. Ici on veut rendre le code de statut [200 OK]. Les diff\u00e9rents codes de statut sont d\u00e9finis par des constantes dans le module [flask_api] import\u00e9 ligne 7\u00a0; Le module [flask_api] n\u2019est pas disponible nativement. Il faut l\u2019installer. On fait cela dans un terminal PyCharm\u00a0:</li> </ul> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\inet\\utilitaires&gt;pip install flask_api\nCollecting flask_api\n  Downloading Flask_API-2.0-py3-none-any.whl (119 kB)\n     || 119 kB 544 kB/s\nRequirement already satisfied: Flask&gt;=1.1 in c:\\data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages (from flask_api) (1.1.2)\nRequirement already satisfied: Jinja2&gt;=2.10.1 in c:\\data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages (from Flask&gt;=1.1-&gt;flask_api) (2.11.2)\nRequirement already satisfied: Werkzeug&gt;=0.15 in c:\\data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages (from Flask&gt;=1.1-&gt;flask_api) (1.0.1)\nRequirement already satisfied: click&gt;=5.1 in c:\\data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages (from Flask&gt;=1.1-&gt;flask_api) (7.1.2)\nRequirement already satisfied: itsdangerous&gt;=0.24 in c:\\data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages (from Flask&gt;=1.1-&gt;flask_api) (1.1.0)\nRequirement already satisfied: MarkupSafe&gt;=0.23 in c:\\data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\lib\\site-packages (from Jinja2&gt;=2.10.1-&gt;Flask&gt;=1.1-&gt;flask_api) (1.1.1\n)\nInstalling collected packages: flask-api\nSuccessfully installed flask-api-2.0\n</code></pre> <p>Lorsqu\u2019on ex\u00e9cute le script web [main_01], on obtient les r\u00e9sultats suivants dans un navigateur\u00a0:</p> <p></p> <ul> <li>en [2], la cha\u00eene jSON re\u00e7ue\u00a0;</li> <li>en [3-4], on fait afficher le contenu du document re\u00e7u. On voit qu\u2019il n\u2019y a aucun habillage HTML, seulement la cha\u00eene jSON\u00a0; Voyons maintenant le r\u00f4le de l\u2019ent\u00eate [Content-Type] envoy\u00e9 au client par le service web. On met le navigateur en mode d\u00e9veloppeur (F12 en g\u00e9n\u00e9ral) et on redemande la m\u00eame URL. Ci-dessous une copie d\u2019\u00e9cran d\u2019un navigateur Chrome\u00a0:</li> </ul> <p></p> <ul> <li>en [1], s\u00e9lectionner l\u2019onglet [Network]\u00a0;</li> <li>en [2, 4]\u00a0: l\u2019URL demand\u00e9e par le navigateur\u00a0;</li> <li>en [3], s\u00e9lectionner l\u2019onglet [Headers] (ent\u00eates HTTP)\u00a0;</li> <li>en [5], le code de statut de la r\u00e9ponse HTTP re\u00e7ue\u00a0;</li> <li>en [6], l\u2019ent\u00eate indiquant au client qu\u2019il va recevoir un texte jSON. Cela permet au client de s\u2019adapter \u00e0 la r\u00e9ponse. Ainsi la police de caract\u00e8res utilis\u00e9e par Chrome pour afficher une r\u00e9ponse jSON ou une r\u00e9ponse texte basique n\u2019est pas la m\u00eame\u00a0;</li> </ul> <p></p> <ul> <li>en [8], on s\u00e9lectionne l\u2019onglet [Response] pour avoir acc\u00e8s au document envoy\u00e9 par le serveice web, ici une simple cha\u00eene jSON\u00a0;</li> </ul>"},{"location":"services-web-avec-le-framework-flask.html#2242-postman","title":"22.4.2. Postman","text":"<p>[Postman] est l\u2019outil qui va nous permettre d\u2019interroger les diff\u00e9rentes URL d\u2019une application web. Il nous permet\u00a0:</p> <ul> <li>d\u2019utiliser n\u2019importe quelle URL\u00a0: celles-ci sont fabriqu\u00e9es \u00e0 la main\u00a0;</li> <li>de requ\u00eater le serveur web par un GET, POST, PUT, OPTIONS\u2026\u00a0;</li> <li>de pr\u00e9ciser les param\u00e8tres du GET ou du POST\u00a0;</li> <li>de fixer les ent\u00eates HTTP de la requ\u00eate\u00a0;</li> <li>de recevoir une r\u00e9ponse au format jSON, XML, HTML,</li> <li>d\u2019avoir acc\u00e8s aux ent\u00eates HTTP de la r\u00e9ponse. On a donc ainsi acc\u00e8s \u00e0 la r\u00e9ponse HTTP compl\u00e8te du serveur\u00a0; [Postman] est un excellent outil p\u00e9dagogique pour comprendre la communication client / serveur du protocole HTTP.</li> </ul> <p>[Postman] est disponible \u00e0 l\u2019URL [https://www.getpostman.com/downloads/]. Proc\u00e9dez \u00e0 l\u2019installation de votre version de [Postman]. Au cours de l\u2019installation, on vous demandera de cr\u00e9er un compte\u00a0: celui-ci sera inutile ici. Le compte [Postman] sert \u00e0 synchroniser diff\u00e9rents appareils afin que la configuration de l\u2019un soit r\u00e9pliqu\u00e9 sur un autre. Rien de tout ceci n\u2019est utile ici.</p> <p>Une fois install\u00e9, [Postman] pr\u00e9sente l\u2019interface suivante\u00a0:</p> <p></p> <ul> <li>en [2-3], on a acc\u00e8s au param\u00e9trage du produit\u00a0;</li> </ul> <p></p> <ul> <li> <p>en [6], la version utilis\u00e9e dans ce document\u00a0; Nous allons ici utiliser [Postman] pour tester le service web jSON pr\u00e9c\u00e9dent\u00a0:</p> </li> <li> <p>noux ex\u00e9cutons le script [flask/03/main_01]\u00a0;</p> </li> <li>puis nous demandons l\u2019URL [http://localhost:5000/] avec Postman\u00a0;</li> </ul> <p></p> <ul> <li>en [1], on cr\u00e9e une requ\u00eate\u00a0;</li> <li>en [2], ce sera une requ\u00eate HTTP GET\u00a0;</li> <li>en [3], l\u2019URL du service web interrog\u00e9\u00a0;</li> <li>en [4], on envoie la requ\u00eate au service web\u00a0;</li> </ul> <p></p> <ul> <li>en [5], on s\u00e9lectionne l\u2019onglet [Body] qui affiche le document re\u00e7u\u00a0;</li> <li>en [6], on s\u00e9lectionne l\u2019onglet [Pretty]\u00a0qui affiche le document re\u00e7u avec une mise en forme appropri\u00e9e, ici une forme appropri\u00e9e \u00e0 une cha\u00eene jSON\u00a0;</li> <li>en [7], le document jSON re\u00e7u\u00a0;</li> <li>en [8-9], le document re\u00e7u sans mise en forme\u00a0;</li> </ul> <p></p> <ul> <li>en [10], on affiche les ent\u00eates HTTP re\u00e7us par Postman\u00a0;</li> <li>en [11], le statut HTTP de la r\u00e9ponse\u00a0re\u00e7ue\u00a0;</li> <li>en [12], les ent\u00eates HTTP re\u00e7us\u00a0;</li> <li>en [13], l\u2019ent\u00eate [Content-type] qui a permis \u00e0 Postman de savoir qu\u2019il allait recevoir une cha\u00eene jSON. Postman a utilis\u00e9 cette information pour mettre en forme, d\u2019une certaine fa\u00e7on, le document re\u00e7u\u00a0; Il y a une autre fa\u00e7on d\u2019utiliser Postman. Elle consiste \u00e0 utiliser la console Postman (Ctrl-Alt-C). Celle-ci permet de voir le dialogue client / serveur. Outre la s\u00e9quence Ctrl-Alt-C, la console Postman est disponible via une ic\u00f4ne en bas \u00e0 gauche de la fen\u00eatre principale de Postman\u00a0:</li> </ul> <p></p> <p>La console Postman m\u00e9morise les dialogues client / serveur qui ont lieu lorsqu\u2019une requ\u00eate Postman est ex\u00e9cut\u00e9e\u00a0:</p> <p></p> <ul> <li>en [3], la liste des requ\u00eates faites par Postman depuis qu\u2019il a \u00e9t\u00e9 lanc\u00e9. Les plus r\u00e9centes sont en bas de la liste\u00a0;</li> <li>en [4], la requ\u00eate HTTP faite par Postman\u00a0;</li> <li>en [5-6], la r\u00e9ponse HTTP faite par le serveur web\u00a0;</li> <li>en [7], on peut voir les logs en mode [raw], \u00e7-\u00e0-d sans artifice de pr\u00e9sentation\u00a0; En mode [raw] la fen\u00eatre de la console devient la suivante\u00a0:</li> </ul> <p></p> <ul> <li>en [8], la requ\u00eate HTTP faite par Postman au serveur web\u00a0;</li> <li>en [9], la r\u00e9ponse HTTP faite par le serveur web\u00a0;</li> <li>en [10], on peut revenir au mode [pretty logs]\u00a0; Afin de faciliter les explications, nous num\u00e9roterons les lignes obtenues \u00e0 partir de la console Postman.</li> </ul> <p>Pour le client\u00a0:</p> <pre><code>GET / HTTP/1.1\nUser-Agent: PostmanRuntime/7.26.1\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 70e2acaa-b3e5-46f6-8375-989e6b94e694\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\n</code></pre> <p>Pour le serveur\u00a0:</p> <pre><code>HTTP/1.0 200 OK\nContent-type: application/json; charser=utf8\nContent-Length: 56\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Mon, 13 Jul 2020 17:19:56 GMT\n{\"pr\u00e9nom\": \"Agla\u00eb\", \"nom\": \"de la H\u00fbche\", \"\u00e2ge\": 87}\n</code></pre> <p>A partir de maintenant, nous utiliserons principalement\u00a0:</p> <ul> <li>[Postman] comme client web\u00a0;</li> <li>la console [Postman] en [raw mode] pour expliquer le dialogue client / serveur\u00a0;</li> </ul>"},{"location":"services-web-avec-le-framework-flask.html#2243-script-main_02","title":"22.4.3. script [main_02]","text":"<p>Le script web [main_02] est le suivant\u00a0:</p> <pre><code># on configure l'application\nimport config\nconfig=config.configure()\n\n# imports\nfrom flask import Flask, make_response\nfrom flask_api import status\n\n# d\u00e9pendances\nfrom Personne import Personne\n\n# application Flask\napp = Flask(__name__)\n\n\n# Home URL\n@app.route('/')\ndef index():\n    # une personne\n    personne = Personne().fromdict({\"pr\u00e9nom\": \"Agla\u00eb\", \"nom\": \"de la H\u00fbche\", \"\u00e2ge\": 87})\n    # contenu\n    response = make_response(f\"personne[{personne.pr\u00e9nom}, {personne.nom}, {personne.\u00e2ge}]\")\n    # headers HTTP\n    response.headers.set(\"Content-Type\", \"text/plain; charset=utf8\")\n    # r\u00e9ponse HTTP\n    return response, status.HTTP_200_OK\n\n\n# main uniquement\nif __name__ == '__main__':\n    # on lance le serveur\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>le script [main_02]est analogue au script [main_01]. Il en diff\u00e8re sur deux points\u00a0:</li> <li>ligne 22\u00a0: le document envoy\u00e9 au client est une cha\u00eene de caract\u00e8res brute, pas une cha\u00eene jSON\u00a0;</li> <li>ligne 24\u00a0: ceci est refl\u00e9t\u00e9 dans l\u2019ent\u00eate HTTP [Content-Type] qui indique le type [text/plain] pour le document\u00a0; Nous ex\u00e9cutons le script web [main_02] puis utilisons [Postman] pour l\u2019interroger\u00a0:</li> </ul> <p></p> <ul> <li>en [1-3], on fait la requ\u00eate au service web\u00a0;</li> <li>en [5], le statut OK de la r\u00e9ponse\u00a0;</li> <li>en [4, 6], les ent\u00eates HTTP de la r\u00e9ponse\u00a0;</li> <li>en [7], l\u2019ent\u00eate [Content-Type]\u00a0;</li> <li>en [8-10], le document envoy\u00e9 par le service web, une cha\u00eene de caract\u00e8res\u00a0; La console Postman donne les logs suivants\u00a0:</li> </ul> <p>Requ\u00eate du client\u00a0:</p> <pre><code>GET / HTTP/1.1\nUser-Agent: PostmanRuntime/7.26.1\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 7c7fc9f3-8df8-49ae-9dc8-53c2d87d111a\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\n</code></pre> <p>R\u00e9ponse du serveur\u00a0:</p> <pre><code>HTTP/1.0 200 OK\nContent-Type: text/plain; charset=utf8\nContent-Length: 34\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Mon, 13 Jul 2020 17:34:22 GMT\n\npersonne[Agla\u00eb, de la H\u00fbche, 87]\n</code></pre>"},{"location":"services-web-avec-le-framework-flask.html#2244-script-main_03","title":"22.4.4. script [main_03]","text":"<p>Le script web [main_03] est le suivant\u00a0:</p> <pre><code># on configure l'application\nimport config\nconfig = config.configure()\n\n# imports\nfrom flask import Flask, make_response\nfrom flask_api import status\n\n# d\u00e9pendances\nfrom MyException import MyException\nfrom Personne import Personne\n\n# application Flask\napp = Flask(__name__)\n\n\n# Home URL\n@app.route('/')\ndef index():\n    # une personne incorrecte\n    msg_erreur = None\n    try:\n        personne = Personne().fromdict({\"pr\u00e9nom\": \"\", \"nom\": \"\", \"\u00e2ge\": 87})\n    except MyException as erreur:\n        msg_erreur = f\"{erreur}\"\n    # erreur ?\n    if msg_erreur:\n        response = make_response(msg_erreur)\n        status_code = status.HTTP_500_INTERNAL_SERVER_ERROR\n    else:\n        response = make_response(f\"personne[{personne.pr\u00e9nom}, {personne.nom}, {personne.\u00e2ge}]\")\n        status_code = status.HTTP_200_OK\n    # headers HTTP\n    response.headers.set(\"Content-Type\", \"text/plain; charset=utf8\")\n    # r\u00e9ponse HTTP\n    return response, status_code\n\n\n# main uniquement\nif __name__ == '__main__':\n    # on lance le serveur\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>ligne 23\u00a0: on provoque une erreur en instanciant une personne incorrecte\u00a0;</li> <li>lignes 27-29\u00a0: \u00e0 cause de l\u2019erreur\u00a0:</li> <li>ligne 28\u00a0: on pr\u00e9pare une r\u00e9ponse HTTP ayant comme contenu le message d\u2019erreur\u00a0;</li> <li>ligne 29\u00a0: on donne au code de statut HTTP une valeur d\u2019erreur [500 Internal Server Error]\u00a0;</li> <li>ligne 34\u00a0: on indique au client qu\u2019on lui envoie un texte brut\u00a0;</li> <li>ligne 36\u00a0: on envoie la r\u00e9ponse HTTP au client\u00a0; Nous lan\u00e7ons le service web [main_03] et nous utilisons Postman pour l\u2019interroger\u00a0:</li> </ul> <p></p> <ul> <li>en [1-3], nous envoyons la requ\u00eate\u00a0;</li> <li>en [4], on obtient une r\u00e9ponse avec un code de statut [500 INTERNAL SERVER ERROR]\u00a0;</li> <li>en [5-7]\u00a0: la r\u00e9ponse est un texte d\u00e9crivant l\u2019erreur qui s\u2019est produite\u00a0;</li> </ul> <p></p> <ul> <li>en [8-10], les ent\u00eates HTTP de la r\u00e9ponse\u00a0du service web\u00a0; Dans la console Postman, les r\u00e9sultats en mode [raw] sont les suivants\u00a0:</li> </ul> <p>Requ\u00eate du client\u00a0:</p> <pre><code>GET / HTTP/1.1\nUser-Agent: PostmanRuntime/7.26.1\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 925ff036-a360-47af-adf6-78173c01a247\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\n</code></pre> <p>R\u00e9ponse du serveur\u00a0:</p> <pre><code>HTTP/1.0 500 INTERNAL SERVER ERROR\nContent-Type: text/plain; charset=utf8\nContent-Length: 74\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Mon, 13 Jul 2020 17:39:24 GMT\n\nMyException[11, Le pr\u00e9nom doit \u00eatre une cha\u00eene de caract\u00e8res non vide]\n</code></pre>"},{"location":"services-web-avec-le-framework-flask.html#225-scripts-flask04-informations-encapsulees-dans-la-requete","title":"22.5. scripts [flask/04]\u00a0: informations encapsul\u00e9es dans la requ\u00eate","text":"<p>Le script [request_parameters.py] se propose de montrer que le service web a acc\u00e8s \u00e0 diverses informations encapsul\u00e9es dans la requ\u00eate d\u2019un client web. Le code est le suivant\u00a0:</p> <pre><code># import\nfrom flask import Flask, make_response, request\nfrom flask_api import status\n# application Flask\napp = Flask(__name__)\n\n\n# Home URL\n@app.route('/', methods=['GET', 'POST'])\ndef index():\n    # param\u00e8tres de la requ\u00eate\n    request_data = {}\n    request_data[\"environ\"] = f\"{request.environ}\"\n    request_data[\"path\"] = request.path\n    request_data[\"full_path\"] = request.full_path\n    request_data[\"script_root\"] = request.script_root\n    request_data[\"url\"] = request.url\n    request_data[\"base_url\"] = request.base_url\n    request_data[\"url_root\"] = request.url_root\n    request_data[\"accept_charsets\"] = request.accept_charsets\n    request_data[\"accept_encodings\"] = request.accept_encodings\n    request_data[\"accept_languages\"] = request.accept_languages\n    request_data[\"accept_mimetypes\"] = request.accept_mimetypes\n    request_data[\"args\"] = request.args\n    request_data[\"content_encoding\"] = request.content_encoding\n    request_data[\"content_length\"] = request.content_length\n    request_data[\"content_type\"] = request.content_type\n    request_data[\"endpoint\"] = request.endpoint\n    request_data[\"files\"] = request.files\n    request_data[\"form\"] = request.form\n    request_data[\"host\"] = request.host\n    request_data[\"method\"] = request.method\n    request_data[\"query_string\"] = request.query_string.decode()\n    request_data[\"referrer\"] = request.referrer\n    request_data[\"remote_addr\"] = request.remote_addr\n    request_data[\"remote_user\"] = request.remote_user\n    request_data[\"scheme\"] = request.scheme\n    request_data[\"script_root\"] = request.script_root\n    request_data[\"user_agent\"] = f\"{request.user_agent}\"\n    request_data[\"values\"] = request.values\n    # r\u00e9ponse HTTP\n    response = make_response(request_data)\n    # headers HTTP\n    response.headers[\"Content-Type\"] = \"application/json; charset=utf-8\"\n    # envoi r\u00e9ponse HTTP\n    return response, status.HTTP_200_OK\n\n\n# main\nif __name__ == '__main__':\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>ligne 9\u00a0: nous introduisons un changement. Nous pr\u00e9cisons quelles sont les verbes autoris\u00e9s dans la requ\u00eate du client. Postman en donne la liste\u00a0:</li> </ul> <p></p> <p>Les deux premiers [GET, POST] sont les plus utilis\u00e9s et seront \u00e9galement les seuls \u00e0 \u00eatre utilis\u00e9s dans ce document. Pour en revenir \u00e0 la ligne 9 du code, le param\u00e8tre [methods] contient la liste des m\u00e9thodes de la liste ci-dessus autoris\u00e9es par l\u2019URL. En l\u2019absence de ce param\u00e8tre, seule la m\u00e9thode [GET] est autoris\u00e9e. C\u2019est ce qui s\u2019est pass\u00e9 jusqu\u2019\u00e0 maintenant\u00a0;</p> <ul> <li>ligne 12\u00a0: nous allons construire le dictionnaire [request_data]\u00a0;</li> <li>ligne 13\u00a0: la requ\u00eate du client est disponible dans un objet pr\u00e9d\u00e9fini [request], import\u00e9 ligne 2, de type [werkzeug.local.LocalProxy].  Les lignes qui suivent r\u00e9cup\u00e8rent divers attributs de cet objet\u00a0;</li> <li>plut\u00f4t que de d\u00e9tailler chaque attribut de l\u2019objet [request], nous allons ex\u00e9cuter ce code et regarder les r\u00e9sultats. On comprendra alors mieux la signification des diff\u00e9rents attributs affich\u00e9s\u00a0;</li> <li>ligne 42\u00a0: le dictionnaire [request_data] sera le contenu de la r\u00e9ponse HTTP. On se rappelle que celui-ci doit \u00eatre du texte. Flask transforme automatiquement les dictionnaires en cha\u00eenes jSON\u00a0;</li> <li>ligne 44\u00a0: on dit au client qu\u2019il va recevoir du jSON\u00a0;</li> <li>ligne 46\u00a0: on envoie la r\u00e9ponse au client\u00a0; Avec le client Postman, nous envoyons la requ\u00eate suivante au service web pr\u00e9c\u00e9dent\u00a0:</li> </ul> <p></p> <ul> <li>en [1-2], la requ\u00eate envoy\u00e9e\u00a0;</li> <li>en [2], la requ\u00eate est param\u00e9tr\u00e9e. Les param\u00e8tres sont accol\u00e9s \u00e0 l\u2019URL sous la forme [\u00a0?param1=valeur1&amp;param2=valeur2]. Il y a deux fa\u00e7ons de saisir ces param\u00e8tres dans Postman\u00a0:</li> <li>les \u00e9crire directement dans l\u2019URL\u00a0;</li> <li>les \u00e9crire en [3-4]\u00a0; Les deux m\u00e9thodes sont \u00e9quivalentes\u00a0;</li> </ul> <p>Nous ajoutons d\u2019autres param\u00e8tres \u00e0 la requ\u00eate\u00a0:</p> <p></p> <ul> <li>en [5-7], nous ajoutons des param\u00e8tres dans le corps (=body) de le requ\u00eate. Alors que les param\u00e8tres de l\u2019URL sont visibles par l\u2019utilisateur d\u2019un navigateur web, ceux qui font partie du corps de la requ\u00eate ne sont pas visibles. Le navigateur (ou Postman ici) les envoie au serveur apr\u00e8s les ent\u00eates HTTP. La requ\u00eate du client web a alors la m\u00eame structure que la r\u00e9ponse du serveur web\u00a0: des ent\u00eates HTTP suivis par un document. Cela va faire appara\u00eetre deux nouveaux ent\u00eates HTTP\u00a0dans la requ\u00eate du client\u00a0:</li> <li>[Content-Type]\u00a0: le client dit au serveur quel type de document il envoie\u00a0;</li> <li>[Content-Length]\u00a0: la taille du document en octets\u00a0;</li> <li>en [6], le codage \u00e0 employer pour les param\u00e8tres d\u00e9clar\u00e9s en [7]. Ceux-ci peuvent \u00eatre cod\u00e9s de diverses fa\u00e7ons. [x-www-form-urlencoded] est une m\u00e9thode utilis\u00e9e fr\u00e9quemment par les navigateurs\u00a0; On peut voir la requ\u00eate qui va \u00eatre g\u00e9n\u00e9r\u00e9e\u00a0:</li> </ul> <p></p> <p>La r\u00e9ponse \u00e0 cette requ\u00eate est la suivante\u00a0:</p> <p></p> <ul> <li>en [1-5], on a re\u00e7u une cha\u00eene jSON [3]\u00a0;</li> <li>ce qui g\u00e9n\u00e9ralement int\u00e9resse le service web, ce sont les param\u00e8tres de l\u2019URL [\u00a0?param1=valeur1&amp;param2=valeur2] et ceux qui ont \u00e9t\u00e9 transmis dans le corps de la requ\u00eate (document). C\u2019est comme \u00e7a, en g\u00e9n\u00e9ral, que le client lui transmet des informations. On voit en [5] que les param\u00e8tres de l\u2019URL sont disponibles dans [request.args]\u00a0; Le reste de la r\u00e9ponse est le suivant\u00a0:</li> </ul> <p></p> <ul> <li>en [9], les attributs des param\u00e8tres mis dans le corps de la requ\u00eate\u00a0:</li> <li>[content_type] est le type du document accompagnant la requ\u00eate. On a vu que ce document contenait des informations de type [param=valeur] encod\u00e9es sous la forme [x-www-form-urlencoded]. Postman a donc g\u00e9n\u00e9r\u00e9 un ent\u00eate HTTP [Content-Type] indiquant la nature du document\u00a0;</li> <li>[content_length] est la taille en octets de ce document\u00a0;</li> <li>en [10], l\u2019attribut [request.environ] contient de nombreuses informations sur l\u2019environnement dans lequel la requ\u00eate du client est trait\u00e9e. La plupart de ces informations se retrouvent dans les autres attributs de l\u2019objet [request]\u00a0;</li> <li>en [11], les param\u00e8tres pr\u00e9sents dans le corps de la requ\u00eate sont disponibles dans l\u2019attribut [request.form]\u00a0;</li> <li>en [12], la m\u00e9thode utilis\u00e9e pour envoyer la requ\u00eate, ici la m\u00e9thode [GET]\u00a0;</li> <li>en [13], l\u2019attribut [request.values] est le dictionnaire de tous les param\u00e8tres, ceux de l\u2019URL et ceux du corps du document. Pour obtenir les param\u00e8tres de la requ\u00eate, on utilisera l\u2019attribut\u00a0:</li> <li>[request.args] pour avoir ceux pr\u00e9sents dans l\u2019URL\u00a0;</li> <li>[request.form] pour avoir ceux pr\u00e9sents dans le corps du document\u00a0; Dans la console Postman, les logs sont les suivants\u00a0:</li> </ul> <p>Requ\u00eate du client\u00a0:</p> <pre><code>GET /?param1=valeur1&amp;param2=valeur2 HTTP/1.1\nUser-Agent: PostmanRuntime/7.26.1\nAccept: */*\nCache-Control: no-cache\nPostman-Token: cbfac6aa-71a0-4076-a0c3-91d36d74a4c0\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 60\n\nnom=s%C3%A9l%C3%A9n%C3%A9&amp;pr%C3%A9nom=agla%C3%AB&amp;%C3%A2ge=77\n</code></pre> <ul> <li>ligne 9\u00a0: le type du document envoy\u00e9 ligne 12 au serveur\u00a0;</li> <li>ligne 11\u00a0: les ent\u00eates HTTP de la requ\u00eate sont s\u00e9par\u00e9s du document envoy\u00e9 par une ligne vide. C\u2019est comme cela que le serveur rep\u00e8re la fin des ent\u00eates HTTP du client\u00a0;</li> <li>ligne 12\u00a0: le document \u2018url-encod\u00e9\u2019. Tous les caract\u00e8res accentu\u00e9s ont subi un encodage\u00a0; La r\u00e9ponse du client est la suivante\u00a0:</li> </ul> <pre><code>HTTP/1.0 200 OK\nContent-Type: application/json; charset=utf-8\nContent-Length: 2433\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Wed, 15 Jul 2020 06:09:09 GMT\n\n{\n  \"accept_charsets\": [], \n  \"accept_encodings\": [\n    [\n      \"gzip\", \n      1\n    ], \n    [\n      \"deflate\", \n      1\n    ], \n    [\n      \"br\", \n      1\n    ]\n  ], \n  \"accept_languages\": [], \n  \"accept_mimetypes\": [\n    [\n      \"*/*\", \n      1\n    ]\n  ], \n  \"args\": {\n    \"param1\": \"valeur1\", \n    \"param2\": \"valeur2\"\n  }, \n  \"base_url\": \"http://localhost:5000/\", \n  \"content_encoding\": null, \n  \"content_length\": 60, \n  \"content_type\": \"application/x-www-form-urlencoded\", \n  \"endpoint\": \"index\", \n  \"environ\": \"{'wsgi.version': (1, 0), 'wsgi.url_scheme': 'http', 'wsgi.input': &lt;_io.BufferedReader name=908&gt;, 'wsgi.errors': &lt;_io.TextIOWrapper name='&lt;stderr&gt;' mode='w' encoding='utf-8'&gt;, 'wsgi.multithread': True, 'wsgi.multiprocess': False, 'wsgi.run_once': False, 'werkzeug.server.shutdown': &lt;function WSGIRequestHandler.make_environ.&lt;locals&gt;.shutdown_server at 0x00000173CA6E5160&gt;, 'SERVER_SOFTWARE': 'Werkzeug/1.0.1', 'REQUEST_METHOD': 'GET', 'SCRIPT_NAME': '', 'PATH_INFO': '/', 'QUERY_STRING': 'param1=valeur1&amp;param2=valeur2', 'REQUEST_URI': '/?param1=valeur1&amp;param2=valeur2', 'RAW_URI': '/?param1=valeur1&amp;param2=valeur2', 'REMOTE_ADDR': '127.0.0.1', 'REMOTE_PORT': 50592, 'SERVER_NAME': '127.0.0.1', 'SERVER_PORT': '5000', 'SERVER_PROTOCOL': 'HTTP/1.1', 'HTTP_USER_AGENT': 'PostmanRuntime/7.26.1', 'HTTP_ACCEPT': '*/*', 'HTTP_CACHE_CONTROL': 'no-cache', 'HTTP_POSTMAN_TOKEN': 'cbfac6aa-71a0-4076-a0c3-91d36d74a4c0', 'HTTP_HOST': 'localhost:5000', 'HTTP_ACCEPT_ENCODING': 'gzip, deflate, br', 'HTTP_CONNECTION': 'keep-alive', 'CONTENT_TYPE': 'application/x-www-form-urlencoded', 'CONTENT_LENGTH': '60', 'werkzeug.request': &lt;Request 'http://localhost:5000/?param1=valeur1&amp;param2=valeur2' [GET]&gt;}\", \n  \"files\": {}, \n  \"form\": {\n    \"nom\": \"s\\u00e9l\\u00e9n\\u00e9\", \n    \"pr\\u00e9nom\": \"agla\\u00eb\", \n    \"\\u00e2ge\": \"77\"\n  }, \n  \"full_path\": \"/?param1=valeur1&amp;param2=valeur2\", \n  \"host\": \"localhost:5000\", \n  \"method\": \"GET\", \n  \"path\": \"/\", \n  \"query_string\": \"param1=valeur1&amp;param2=valeur2\", \n  \"referrer\": null, \n  \"remote_addr\": \"127.0.0.1\", \n  \"remote_user\": null, \n  \"scheme\": \"http\", \n  \"script_root\": \"\", \n  \"url\": \"http://localhost:5000/?param1=valeur1&amp;param2=valeur2\", \n  \"url_root\": \"http://localhost:5000/\", \n  \"user_agent\": \"PostmanRuntime/7.26.1\", \n  \"values\": {\n    \"nom\": \"s\\u00e9l\\u00e9n\\u00e9\", \n    \"param1\": \"valeur1\", \n    \"param2\": \"valeur2\", \n    \"pr\\u00e9nom\": \"agla\\u00eb\", \n    \"\\u00e2ge\": \"77\"\n  }\n}\n</code></pre> <ul> <li>lignes 1-5\u00a0: les ent\u00eates HTTP de la r\u00e9ponse termin\u00e9s par une ligne vide\u00a0;</li> <li>lignes 41-45\u00a0: les \u00e9l\u00e9ments accentu\u00e9s ont subi un encodage UTF-8\u00a0; Si maintenant on utilise la m\u00e9thode [POST] pour envoyer la m\u00eame requ\u00eate avec les m\u00eames param\u00e8tres, on obtiendra la m\u00eame r\u00e9ponse si ce n\u2019est qu\u2019en [12], on aura [\u2018method\u2019\u00a0: \u2018POST\u2019].</li> </ul> <p>Aussi quelle est la diff\u00e9rence entre les m\u00e9thodes GET et POST\u00a0? La diff\u00e9rence est mince et a \u00e9t\u00e9 institu\u00e9e par l\u2019usage qu\u2019en ont fait historiquement les navigateurs\u00a0:</p> <ul> <li>les param\u00e8tres dans l\u2019URL sont pratiques parce qu\u2019une URL ainsi param\u00e9tr\u00e9e peut servir de lien dans un document HTML. L\u2019utilisateur peut \u00e9galement changer les param\u00e8tres lui-m\u00eame pour obtenir des r\u00e9ponses diff\u00e9rentes du serveur. Dans ce cas, les navigateurs utilisent couramment la m\u00e9thode [GET] et il n\u2019y a pas de corps (content_length=0) dans la requ\u00eate envoy\u00e9e au serveur web (pas de param\u00e8tres cach\u00e9s)\u00a0;</li> <li> <p>parfois on ne veut pas que les param\u00e8tres soient affich\u00e9s dans l\u2019URL. C\u2019est le cas des mots de passe envoy\u00e9s au serveur. Par ailleurs, la taille occup\u00e9e par les param\u00e8tres de l\u2019URL est limit\u00e9e (une URL ne peut d\u00e9passer une certaine taille). Les param\u00e8tres du corps de la requ\u00eate n\u2019ont pas cette limitation. Egalement, beaucoup de param\u00e8tres dans l\u2019URL la rendent illisible. Prenons le cas courant d\u2019un formulaire d\u2019inscription \u00e0 un site web. Historiquement, lorsque les pages HTML n\u2019embarquaient pas encore du Javascript, les navigateurs envoyaient les renseignements saisis par un POST. On parlait alors de valeurs post\u00e9es\u00a0; Donc au d\u00e9but de la programmation web\u00a0:</p> </li> <li> <p>les m\u00e9thodes GET \u00e9taient plut\u00f4t associ\u00e9es \u00e0 la demande d\u2019informations d\u00e9livr\u00e9es par un serveur web\u00a0;</p> </li> <li>les m\u00e9thodes POST \u00e9taient plut\u00f4t associ\u00e9es \u00e0 l\u2019envoi d\u2019informations du navigateur vers le serveur. Le serveur \u00e9tait alors \u2018enrichi\u2019 par celles-ci\u00a0; Depuis Javascript est pass\u00e9 par l\u00e0. Alors que dans les exemples pr\u00e9c\u00e9dents, le d\u00e9veloppeur n\u2019avait pas la main (cliquer sur un lien d\u00e9clenchait forc\u00e9ment un GET, valider un formulaire passait forc\u00e9ment par un POST), le Javascript leur a redonn\u00e9 la main. Dans ce mod\u00e8le, la page HTML est associ\u00e9e \u00e0 du code Javascript qui peut court-circuiter le navigateur. Ainsi le clic sur un lien peut-il \u00eatre intercept\u00e9 par le code Javascript qui peut ensuite ex\u00e9cuter un code faisant une requ\u00eate au serveur. Cette requ\u00eate sera transparente pour l\u2019utilisateur. Il ne la verra pas. Ce code est un client web et comme nous l\u2019avons fait avec Postman le d\u00e9veloppeur peut cr\u00e9er la requ\u00eate qu\u2019il veut. Pour revenir sur le clic sur un lien, il peut r\u00e9aliser un POST alors que par d\u00e9faut le navigateur aurait r\u00e9alis\u00e9 un GET. Ces \u00e9volutions ont rendu les diff\u00e9rences entre GET et POST moins pertinentes.</li> </ul> <p>Cependant, les d\u00e9veloppeurs adoptent souvent les r\u00e8gles suivantes\u00a0:</p> <ul> <li>un GET ne doit pas modifier l\u2019\u00e9tat du serveur. Des GET successifs r\u00e9alis\u00e9s avec les m\u00eames param\u00e8tres dans l\u2019URL divent ramener le m\u00eame document. De plus le GET n\u2019a le plus souvent pas de corps (pas de document associ\u00e9), seulement des param\u00e8tres dans l\u2019URL\u00a0;</li> <li>le POST peut modifier l\u2019\u00e9tat du serveur. Les param\u00e8tres sont le plus souvent envoy\u00e9s dans le corps de la requ\u00eate. On parle alors de valeurs post\u00e9es. L\u2019exemple du formulaire est le plus \u00e9loquent\u00a0: les valeurs saisies par l\u2019utilisateur vont \u00eatre mises dans le corps du POST et le serveur va les enregistrer quelque part, souvent une base de donn\u00e9es\u00a0;  Dans la suite du document, nous ne nous astreignons \u00e0 respecter aucune r\u00e8gle particuli\u00e8re.</li> </ul>"},{"location":"services-web-avec-le-framework-flask.html#226-scripts-flask-05-gestion-de-la-memoire-de-lutilisateur","title":"22.6. scripts [flask-05]\u00a0: gestion de la m\u00e9moire de l\u2019utilisateur","text":""},{"location":"services-web-avec-le-framework-flask.html#2261-introduction","title":"22.6.1. Introduction","text":"<p>Dans les exemples client / serveur pr\u00e9c\u00e9dents on avait le fonctionnement suivant\u00a0:</p> <ul> <li>le client ouvre une connexion vers le port 80 de la machine du service web\u00a0;</li> <li>il envoie la s\u00e9quence de texte\u00a0: en-t\u00eates HTTP, ligne vide, [document]\u00a0;</li> <li>en r\u00e9ponse, le serveur envoie une s\u00e9quence du m\u00eame type\u00a0;</li> <li>le serveur cl\u00f4t la connexion vers le client\u00a0;</li> <li>le client cl\u00f4t la connexion vers le serveur\u00a0; Si le m\u00eame client fait peu apr\u00e8s une nouvelle demande au serveur web, une nouvelle connexion est cr\u00e9\u00e9e entre le client et le serveur. Celui-ci ne peut pas savoir si le client qui se connecte est d\u00e9j\u00e0 venu ou si c'est une premi\u00e8re demande. Entre deux connexions, le serveur \"oublie\" son client. Pour cette raison, on dit que le protocole HTTP est un protocole sans \u00e9tat. Il est pourtant utile que le serveur se souvienne de ses clients. Ainsi si une application est s\u00e9curis\u00e9e, le client va envoyer au serveur un login et un mot de passe pour s'identifier. Si le serveur \"oublie\" son client entre deux connexions, celui-ci devra s'identifier \u00e0 chaque nouvelle connexion, ce qui n'est pas envisageable.</li> </ul> <p>Pour faire le suivi d'un client, le serveur peut proc\u00e9der de diverses fa\u00e7ons\u00a0:</p> <ul> <li>lors d'une premi\u00e8re demande d'un client, il inclut dans sa r\u00e9ponse un identifiant que le client doit ensuite lui renvoyer \u00e0 chaque nouvelle demande. Gr\u00e2ce \u00e0 cet identifiant, diff\u00e9rent pour chaque client, le serveur peut reconna\u00eetre un client. Il peut alors g\u00e9rer une m\u00e9moire pour ce client sous la forme d'une m\u00e9moire associ\u00e9e de fa\u00e7on unique \u00e0 l'identifiant du client. C\u2019est ainsi que fonctionnent, par exemple, les services PHP\u00a0;</li> <li> <p>lors d'une premi\u00e8re demande d'un client, il inclut dans sa r\u00e9ponse non pas un identifiant mais la m\u00e9moire de l\u2019utilisateur elle-m\u00eame. Il ne garde rien c\u00f4t\u00e9 serveur. Pour maintenir sa m\u00e9moire, le client web doit renvoyer cette m\u00e9moire \u00e0 chaque nouvelle requ\u00eate. Celle-ci est modifi\u00e9e (ou non) \u00e0 chaque nouvelle requ\u00eate et renvoy\u00e9e (ou non) au client. C\u2019est la m\u00e9thode utilis\u00e9e par le framework Flask\u00a0; Les diff\u00e9rences entre les deux m\u00e9thodes sont les suivantes\u00a0:</p> </li> <li> <p>la m\u00e9thode 1 est moins gourmande en bande passante. Seul est \u00e9chang\u00e9 entre le client et le serveur un identifiant. Lorsque la m\u00e9moire de l\u2019utilisateur grandit, cela n\u2019a aucune cons\u00e9quence sur l\u2019identifiant qui reste le m\u00eame. Ce n\u2019est pas le cas de la m\u00e9thode 2 o\u00f9 la m\u00e9moire de l\u2019utilisateur est \u00e9chang\u00e9e \u00e0 chaque requ\u00eate\u00a0et peut grossir au fil des requ\u00eates\u00a0;</p> </li> <li> <p>la m\u00e9thode 1 est plus gourmande en espace m\u00e9moire. En effet, le serveur stocke la m\u00e9moire de l\u2019utilisateur sur ses syst\u00e8mes de fichiers. S\u2019il y a un million d\u2019utilisateurs, cela peut peut-\u00eatre poser un probl\u00e8me. La m\u00e9thode 2 ne stocke rien sur le serveur\u00a0; Techniquement cela se passe ainsi\u00a0dans les deux m\u00e9thodes\u00a0:</p> </li> <li> <p>dans la r\u00e9ponse \u00e0 un nouveau client, le serveur inclut l'en-t\u00eate HTTP [Set-Cookie\u00a0: MotCl\u00e9=Identifiant] ou [Set-Cookie\u00a0: m\u00e9moire]. Avec la m\u00e9thode 1, il ne fait cela qu'\u00e0 la premi\u00e8re demande. Avec la m\u00e9thode 2, il le fait \u00e0 chaque fois que la m\u00e9moire de l\u2019utilisateur change\u00a0;</p> </li> <li>dans ses demandes, le client renvoie syst\u00e9matiquement ce qu\u2019il a re\u00e7u, un identifiant ou une m\u00e9moire. Il le fait via l'en-t\u00eate HTTP [Cookie\u00a0: MotCl\u00e9=Valeur]\u00a0; On peut se demander comment le serveur fait pour savoir qu'il a affaire \u00e0 un nouveau client plut\u00f4t qu'\u00e0 un client d\u00e9j\u00e0 venu. C'est la pr\u00e9sence de l'en-t\u00eate HTTP Cookie dans les en-t\u00eates HTTP du client qui le lui indique. Pour un nouveau client, cet en-t\u00eate est absent.</li> </ul> <p>L'ensemble des connexions d'un client donn\u00e9 est appel\u00e9 une session.</p> <p>Le serveur peut maintenir d\u2019autres types de m\u00e9moire\u00a0:</p> <p></p> <ul> <li>en [1], la m\u00e9moire de la requ\u00eate est particuli\u00e8re. Elle est utilis\u00e9e lorsque la demande du client web est trait\u00e9e non pas par un service (ou application) mais par plusieurs. Pour passer des informations au service i+1, le service i peut enrichir la requ\u00eate trait\u00e9e (request) avec ces informations. C\u2019est ce qu\u2019on appelle la m\u00e9moire de niveau requ\u00eate. Nous n\u2019utiliserons pas ce type de m\u00e9moire dans ce document\u00a0;</li> <li>en [2, 4], la m\u00e9moire de l\u2019utilisateur que nous venons de d\u00e9crire. Elle peut \u00eatre impl\u00e9ment\u00e9e localement [2] ou maintenue \u00e0 l\u2019aide du client [4]\u00a0;</li> <li>en [3], la m\u00e9moire de niveau \u2018application\u2019 est tr\u00e8s g\u00e9n\u00e9ralement une m\u00e9moire en lecture seule. Elle est partag\u00e9e par tous les utilisateurs. On y retrouve souvent des \u00e9l\u00e9ments de la configuration de l\u2019application web, configuration partag\u00e9e par tous les utilisateurs de l\u2019application. On doit \u00eatre prudents avec ce type de m\u00e9moire\u00a0: l\u2019\u00e9criture dedans doit se faire \u00e0 un moment o\u00f9 les utilisateurs n\u2019ont pas encore envoy\u00e9 de requ\u00eates, au d\u00e9marrage de l\u2019application le plus souvent. Ensuite, lorsque les requ\u00eates arrivent, il est difficile d\u2019\u00e9crire dans cette m\u00e9moire. Lorsque le serveur web sert simultan\u00e9ment plusieurs utilisateurs et que deux d\u2019entre-eux veulent \u00e9crire dans la m\u00e9moire de niveau \u2018application\u2019, il y a un risque que cette m\u00e9moire soit corrompue. En effet, alors que l\u2019utilisateur 1 a commenc\u00e9 \u00e0 \u00e9crire dans la m\u00e9moire de niveau \u2018application\u2019, il peut \u00eatre interrompu avant m\u00eame d\u2019avoir fini. On a alors une m\u00e9moire d\u2019application incompl\u00e8te. Comme elle est partag\u00e9e, un utilisateur 2 peut la lire et obtenir un \u00e9tat incorrect\u00a0;</li> </ul>"},{"location":"services-web-avec-le-framework-flask.html#2262-script-session_scope_01","title":"22.6.2. script [session_scope_01]","text":"<p>Les scripts [session_scope_xx] illustrent la gestion des m\u00e9moires utilisateurs.</p> <p>Le script [session_scope_01] est le suivant\u00a0:</p> <pre><code># on configure l'application\nimport config\nconfig = config.configure()\n\n# d\u00e9pendances\nimport json\nfrom flask import Flask, make_response, session\nfrom flask_api import status\n\n# application Flask\napp = Flask(__name__)\n\n# cl\u00e9 secr\u00e8te de la session\napp.secret_key = config[\"SECRET_KEY\"]\n\n\n@app.route('/set-session', methods=['GET'])\ndef set_session():\n    # on met qq chose dans la session\n    session['nom'] = 's\u00e9l\u00e9n\u00e9'\n    # on envoie une r\u00e9ponse vide\n    response = make_response()\n    response.headers['Content-Length'] = 0\n    return response, status.HTTP_200_OK\n\n\n@app.route('/get-session', methods=['GET'])\ndef get_session():\n    # on r\u00e9cup\u00e8re la session et on envoie la r\u00e9ponse\n    response = make_response(json.dumps({\"nom\": session['nom']}, ensure_ascii=False))\n    response.headers['Content-Type'] = 'application/json; charset=utf-8'\n    return response, status.HTTP_200_OK\n\n\n# main seulement\nif __name__ == '__main__':\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>ligne 11\u00a0: une application Flask est instanci\u00e9e\u00a0;</li> <li> <p>ligne 14\u00a0: l\u2019attribut [secret_key] de cette application re\u00e7oit une valeur prise dans le fichier de configuration exploit\u00e9 aux lignes 1-3. Une session Flask n\u2019est possible que si cet attribut est initialis\u00e9. On peut mettre n\u2019importe quoi dedans. Il sert \u00e0 crypter une partie de la \u2018m\u00e9moire utilisateur\u2019 qui sera envoy\u00e9e au client. On met en g\u00e9n\u00e9ral quelque chose difficile \u00e0 deviner. Dans le fichier [config], la cl\u00e9 secr\u00e8te est d\u00e9finie de la fa\u00e7on suivante\u00a0: <pre><code>    # on rend la config\n    config = {\n        # configuration Flask\n        \"SECRET_KEY\": \"vibnFfrdWYUp?*LQ\"\n    }\n</code></pre></p> </li> <li> <p>pour la premi\u00e8re fois, nous d\u00e9finissons une application web qui sert autre chose que l\u2019URL /</p> </li> <li>ligne 17\u00a0: l\u2019URL [/set-session] sert \u00e0 initialiser la session de l\u2019utilisateur\u00a0;</li> <li>ligne 27\u00a0: l\u2019URL [/get-session] sert \u00e0 retrouver la m\u00e9moire de l\u2019utilisateur (ou session de l\u2019utilisateur)\u00a0;</li> <li>ligne 20\u00a0: on met quelque chose dans la m\u00e9moire (= la session) de l\u2019utilisateur, ici un nom. La session se g\u00e8re un peu comme un dictionnaire. On ne peut pas mettre n\u2019importe quoi dans la session. Il faut que les valeurs qu\u2019on y met puissent \u00eatre transform\u00e9es en jSON. Pour les types pr\u00e9d\u00e9finis de Python, cela se fait sans intervention du d\u00e9veloppeur. Pour des objets propri\u00e9taires que Python ne conna\u00eet pas, il faut faire soi-m\u00eame la conversion jSON\u00a0;</li> <li>ligne 22\u00a0: on cr\u00e9e une r\u00e9ponse HTTP sans contenu (absence de param\u00e8tre \u00e0 make_response)\u00a0;</li> <li>ligne 23\u00a0: on dit au client qu\u2019il va recevoir un document vide (taille de 0 octet)\u00a0;</li> <li>ligne 24\u00a0: on envoie la r\u00e9ponse HTTP au client. L\u2019URL [/set-session] ne fait donc rien d\u2019autres que d\u2019initialiser une session utilisateur\u00a0;</li> <li>ligne 27\u00a0: l\u2019URL [/get-session] permet \u00e0 l\u2019utilisateur de savoir ce qu\u2019il y a dans sa session\u00a0;</li> <li>ligne 30\u00a0: on cr\u00e9e une r\u00e9ponse HTTP contenant la cha\u00eene jSON de la session de l\u2019utilisateur. Ici on a cr\u00e9\u00e9 la cha\u00eene jSON nous-m\u00eames au lieu de laisser Flask la g\u00e9n\u00e9rer. En effet, on ne veut pas que les caract\u00e8res accentu\u00e9s soient \u00e9chapp\u00e9s (ensure_ascii=False)\u00a0;</li> <li>ligne 31\u00a0: on dit au client qu\u2019on lui envoie du jSON\u00a0;</li> <li> <p>ligne 32\u00a0: on envoie la r\u00e9ponse HTTP au client\u00a0; Le but de ce script est de montrer que la session utilisateur permet de faire le lien entre les requ\u00eates successives de celui-ci\u00a0:</p> </li> <li> <p>la requ\u00eate 1 demandera l\u2019URL [/set-session]\u00a0;</p> </li> <li>la requ\u00eate 2 demandera l\u2019URL [/get-session] et va r\u00e9cup\u00e9rer le nom que la requ\u00eate 1 aura initialis\u00e9\u00a0; Le script [config] qui configure les scripts du dossier [flask/05] est le suivant\u00a0:</li> </ul> <pre><code>def configure():\n    # chemin absolu r\u00e9f\u00e9rence des chemins relatifs de la configuration\n    root_dir = \"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020\"\n\n    # d\u00e9pendances de l'application\n    absolute_dependencies = [\n        # Personne, Utils, MyException\n        f\"{root_dir}/classes/02/entities\",\n    ]\n    # on fixe le syspath\n    from myutils import set_syspath\n    set_syspath(absolute_dependencies)\n\n    # on rend la config\n    config = {\n        # configuration Flask\n        \"SECRET_KEY\": \"vibnFfrdWYUp?*LQ\"\n    }\n\n    return config\n</code></pre> <p>Nous lan\u00e7ons le script [session_scope_01] puis avec Postman nous allons demander l\u2019URL [/set-session]. Auparavant nous allons v\u00e9rifier quelques \u00e9l\u00e9ments de la requ\u00eate qui va \u00eatre faite\u00a0:</p> <p></p> <ul> <li>en [1], acc\u00e9der aux cookies de Postman\u00a0;</li> </ul> <p></p> <ul> <li>en [2-4], on v\u00e9rifie les cookies connus de Postman et on les supprime tous [4-5]\u00a0; Maintenant v\u00e9rifions la requ\u00eate HTTP qui va \u00eatre g\u00e9n\u00e9r\u00e9e\u00a0:</li> </ul> <p></p> <ul> <li>en [9]\u00a0: une partie des ent\u00eates HTTP que Postman va mettre dans la requ\u00eate \u00e0 partir de la configuration que nous avons pu faire pour celle-ci. Cette v\u00e9rification vous permet de v\u00e9rifier que vous n\u2019avez pas omis des param\u00e8tres ou au contraire laiss\u00e9 des param\u00e8tres inutiles\u00a0; Ceci fait, on peut ex\u00e9cuter la requ\u00eate\u00a0:</li> </ul> <p></p> <p>Il y a diff\u00e9rentes fa\u00e7ons de v\u00e9rifier le r\u00e9sultat. On peut d\u00e9j\u00e0 regarder la fen\u00eatre principale\u00a0:</p> <p></p> <ul> <li>en [1-2], la requ\u00eate faite au service web\u00a0;</li> <li>en [3-6], les ent\u00eates HTTP de la r\u00e9ponse\u00a0;</li> <li>en [4], comme dans le code on n\u2019a pas pr\u00e9cis\u00e9 le type de la r\u00e9ponse, Flask a utilis\u00e9 par d\u00e9faut le type [text/html]\u00a0;</li> <li>en [5], le client sait qu\u2019il n\u2019y a pas de document dans la r\u00e9ponse\u00a0;</li> <li>ligne 6\u00a0: l\u2019ent\u00eate [Set-Cookie] a \u00e9t\u00e9 envoy\u00e9 par le serveur Flask. Sa valeur est appel\u00e9e un cookie de session. Elle est constitu\u00e9e de trois \u00e9l\u00e9ments\u00a0:</li> <li>[session=valeur]\u00a0: valeur repr\u00e9sente la m\u00e9moire de l\u2019utilisateur sous une forme cod\u00e9e. Cette m\u00e9moire est d\u00e9codable (cf. |https://blog.miguelgrinberg.com/post/how-secure-is-the-flask-user-session|). N\u00e9anmoins \u00e0 cause de la cl\u00e9 secr\u00e8te utilis\u00e9e par le serveur, l\u2019utilisateur ne peut pas\u00a0modifier la m\u00e9moire re\u00e7ue pour la renvoyer ensuite au serveur. Lorsque le serveur re\u00e7oit une session, il est ainsi assur\u00e9 de recevoir une session non corrompue\u00a0;</li> <li>[HttpOnly]\u00a0: la pr\u00e9sence de cet \u00e9l\u00e9ment indique au navigateur qui le re\u00e7oit que le cookie ne doit pas \u00eatre accessible au Javascript que peut contenir la page qu\u2019il affiche\u00a0;</li> <li>[Path=/] est le chemin pour lequel il faut renvoyer le cookie de session donc ici tout chemin de l\u2019application web. A chaque fois que l\u2019utilisateur au clavier demandera explicitement (il tape une URL) ou implicitement (il clique sur un lien) une URL de ce domaine, le navigateur renverra automatiquement le cookie de session qu\u2019il a re\u00e7u\u00a0; L\u2019inconv\u00e9nient de la fen\u00eatre principale est qu\u2019on n\u2019a pas acc\u00e8s \u00e0 la requ\u00eate compl\u00e8te qui a amen\u00e9 \u00e0 cette r\u00e9ponse. Ce qui est pr\u00e9sent\u00e9 dans cette fen\u00eatre pr\u00eate \u00e0 confusion\u00a0:</li> </ul> <p></p> <ul> <li>dans les ent\u00eates HTTP [3-4] est pr\u00e9sent\u00e9 en [5] un cookie de session. On pourrait croire alors que Postman a mis dans la requ\u00eate un cookie de session alors que ce n\u2019est pas le cas. Les ent\u00eates [3] repr\u00e9sentent en fait les ent\u00eates HTTP qui seront envoy\u00e9s lors de la prochaine requ\u00eate telle que celle-ci est actuellement configur\u00e9e. Postman vient de recevoir un cookie de session qu\u2019il renverra lors de la prochaine requ\u00eate. C\u2019est pourquoi on a [5]\u00a0; On peut avoir acc\u00e8s au dialogue client / serveur dans la console Postman qu\u2019on obtient avec Ctrl-Alt-C\u00a0:</li> </ul> <pre><code>GET /set-session HTTP/1.1\nUser-Agent: PostmanRuntime/7.26.1\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 3673b73f-7600-4df4-8c4b-c37973e50df8\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\n\nHTTP/1.0 200 OK\nContent-Type: text/html; charset=utf-8\nContent-Length: 0\nVary: Cookie\nSet-Cookie: session=eyJub20iOiJzXHUwMGU5bFx1MDBlOW5cdTAwZTkifQ.Xw6jGQ.y5Icu70wTIN-B0o_hwx0xDH247I; HttpOnly; Path=/\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Wed, 15 Jul 2020 06:32:57 GMT\n</code></pre> <ul> <li>ligne 14\u00a0: le cookie de session envoy\u00e9 par le serveur\u00a0; Maintenant demandons l\u2019URL [/get-session]\u00a0:</li> </ul> <pre><code>GET /get-session HTTP/1.1\nUser-Agent: PostmanRuntime/7.26.1\nAccept: */*\nCache-Control: no-cache\nPostman-Token: ce991398-2d9a-46d0-9ccd-c7ff3c7f4d6d\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\nCookie: session=eyJub20iOiJzXHUwMGU5bFx1MDBlOW5cdTAwZTkifQ.Xw6jGQ.y5Icu70wTIN-B0o_hwx0xDH247I\n\nHTTP/1.0 200 OK\nContent-Type: application/json; charset=utf-8\nContent-Length: 20\nVary: Cookie\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Wed, 15 Jul 2020 06:36:52 GMT\n\n{\"nom\": \"s\u00e9l\u00e9n\u00e9\"}\n</code></pre> <ul> <li>ligne 9\u00a0: le client Postman a renvoy\u00e9 au serveur le cookie de session qu\u2019il avait re\u00e7u\u00a0;</li> <li> <p>ligne 18\u00a0: la cha\u00eene jSON envoy\u00e9e par le serveur\u00a0; Cet exemple nous montre divers points\u00a0:</p> </li> <li> <p>le client Postman renvoie le cookie de session qu\u2019il re\u00e7oit du serveur Flask. Les navigateurs web proc\u00e8dent toujours ainsi\u00a0;</p> </li> <li>nous voyons que la requ\u00eate 2 [/get-session] a permis de r\u00e9cup\u00e9rer une information cr\u00e9\u00e9e lors de la requ\u00eate 1 [/set-session]. On a donc l\u00e0 une m\u00e9moire de l\u2019utilisateur\u00a0;</li> <li>lignes 11-16\u00a0: le serveur Flask n\u2019a pas renvoy\u00e9 de cookie de session. Ce n\u2019est pas syst\u00e9matique. Le serveur Flask ne renvoie le cookie de session que si la derni\u00e8re requ\u00eate a modifi\u00e9 la m\u00e9moire de l\u2019utilisateur\u00a0;</li> </ul>"},{"location":"services-web-avec-le-framework-flask.html#2263-script-session_scope_02","title":"22.6.3. script [session_scope_02]","text":"<p>Le script [session_02] est le suivant\u00a0:</p> <pre><code># d\u00e9pendances\nimport os\n\nfrom flask import Flask, make_response, session\nfrom flask_api import status\n\n# application Flask\napp = Flask(__name__)\n\n# cl\u00e9 secr\u00e8te de la session\napp.secret_key = os.urandom(12).hex()\n\n\n# Home URL\n@app.route('/', methods=['GET'])\ndef index():\n    # on g\u00e8re tois compteurs\n    if session.get('n1') is None:\n        session['n1'] = 0\n    else:\n        session['n1'] = session['n1'] + 1\n    if session.get('n2') is None:\n        session['n2'] = 10\n    else:\n        session['n2'] = session['n2'] + 1\n    if session.get('n3') is None:\n        session['n3'] = 100\n    else:\n        session['n3'] = session['n3'] + 1\n    # dictionnaire des compteurs\n    compteurs = {\"n1\": session['n1'], \"n2\": session['n2'], \"n3\": session['n3']}\n    # on envoie la r\u00e9ponse\n    response = make_response(compteurs)\n    response.headers['Content-Type'] = 'application/json; charset=utf-8'\n    return response, status.HTTP_200_OK\n\n\n# main\nif __name__ == '__main__':\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>ligne 11\u00a0: ici la cl\u00e9 secr\u00e8te est g\u00e9n\u00e9r\u00e9e \u00e0 l\u2019aide d\u2019une fonction. L\u2019int\u00e9r\u00eat de celle-ci est qu\u2019elle g\u00e9n\u00e8re une cha\u00eene de caract\u00e8res complexe de fa\u00e7on al\u00e9atoire. On rappelle que la variable [app] est l\u2019instance de classe Flask cr\u00e9\u00e9e ligne 8\u00a0;</li> <li>ligne 15\u00a0: cette fois-ci, il n\u2019y aura qu\u2019une route, la route /\u00a0;</li> <li>lignes 17-29\u00a0: on g\u00e8re une session contenant trois compteurs [n1, n2, n3]. Lors du 1er appel de l\u2019utilisateur [n1, n2, n3]=[0, 10, 100] puis \u00e0 chaque appel ces compteurs sont incr\u00e9ment\u00e9s de 1\u00a0;</li> <li>ligne 18\u00a0: lors de la 1\u00e8re requ\u00eate, la session de l\u2019application est vide. L\u2019expression [session.get(\u2018cl\u00e9\u2019)] rend la valeur [None]. Pour les requ\u00eates suivantes, cette expression rendra la valeur associ\u00e9e \u00e0 la cl\u00e9\u00a0;</li> <li>ligne 31\u00a0: ces compteurs sont mis dans un dictionnaire\u00a0;</li> <li>ligne 33\u00a0: ce dictionnaire est le document de la r\u00e9ponse HTTP. On rappelle, que Flask transforme automatiquement les dictionnaires en cha\u00eene jSON\u00a0;</li> <li>ligne 34\u00a0: on dit au client web qu\u2019il va recevoir du jSON\u00a0;</li> <li>ligne 35\u00a0: on envoie la r\u00e9ponse HTTP au client\u00a0; Ex\u00e9cutons ce script et interrogeons l\u2019application web ainsi cr\u00e9\u00e9e avec Postman\u00a0apr\u00e8s avoir supprim\u00e9 tous les cookies du client Postman\u00a0[1-3]\u00a0:</li> </ul> <p></p> <p>Dans la console Postman, les \u00e9changes client / serveur sont les suivants\u00a0:</p> <pre><code>GET / HTTP/1.1\nUser-Agent: PostmanRuntime/7.26.1\nAccept: */*\nCache-Control: no-cache\nPostman-Token: c7db536d-9352-4aa6-9877-04560e03d935\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\n\nHTTP/1.0 200 OK\nContent-Type: application/json; charset=utf-8\nContent-Length: 41\nVary: Cookie\nSet-Cookie: session=eyJuMSI6MCwibjIiOjEwLCJuMyI6MTAwfQ.Xw6nLg.v49CeDWwqP-6Dp9Qt330GAe-dNA; HttpOnly; Path=/\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Wed, 15 Jul 2020 06:50:22 GMT\n\n{\n\"n1\": 0, \n\"n2\": 10, \n\"n3\": 100\n}\n</code></pre> <ul> <li>en [14], le cookie de session envoy\u00e9 par le serveur\u00a0;</li> <li>en [18-22], la r\u00e9ponse du serveur sous la forme d\u2019une cha\u00eene jSON\u00a0; Refaisons une deuxi\u00e8me fois la m\u00eame requ\u00eate. Les logs \u00e9voluent de la fa\u00e7on suivante\u00a0:</li> </ul> <pre><code>GET / HTTP/1.1\nUser-Agent: PostmanRuntime/7.26.1\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 8205ad85-37b3-41f2-a171-70dd3b3a1679\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\nCookie: session=eyJuMSI6MCwibjIiOjEwLCJuMyI6MTAwfQ.Xw6nLg.v49CeDWwqP-6Dp9Qt330GAe-dNA\n\nHTTP/1.0 200 OK\nContent-Type: application/json; charset=utf-8\nContent-Length: 41\nVary: Cookie\nSet-Cookie: session=eyJuMSI6MSwibjIiOjExLCJuMyI6MTAxfQ.Xw6nsw.OuxIQnGhmhSsan5Qu_FL3Iyu-9k; HttpOnly; Path=/\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Wed, 15 Jul 2020 06:52:35 GMT\n\n{\n\"n1\": 1, \n\"n2\": 11, \n\"n3\": 101\n}\n</code></pre> <ul> <li>ligne 9\u00a0: le client Postman renvoie le cookie de session qu\u2019il a re\u00e7u\u00a0;</li> <li>ligne 15\u00a0: dans sa r\u00e9ponse, le serveur envoie un nouveau cookie de session, ceci parce que la requ\u00eate du client a modifi\u00e9 la m\u00e9moire de l\u2019utilisateur (= la session)\u00a0;</li> <li>lignes 19-23\u00a0: les nouvelles valeurs des compteurs\u00a0;</li> </ul>"},{"location":"services-web-avec-le-framework-flask.html#2264-script-session_scope_03","title":"22.6.4. script [session_scope_03]","text":"<p>Ce nouveau script vise \u00e0 montrer qu\u2019on peut mettre diff\u00e9rents types Python dans une session\u00a0: liste, dictionnaire, objet. La seule contrainte est que les objets mis en session soient s\u00e9rialisables en jSON. S\u2019ils ne le sont pas par d\u00e9faut (listes, dictionnaires), il faut alors faire soi-m\u00eame la conversion en jSON.</p> <pre><code># on configure l'application\nimport config\nconfig = config.configure()\n\n# d\u00e9pendances\nimport json\nimport os\n\nfrom flask import Flask, make_response, session\nfrom flask_api import status\nfrom Personne import Personne\n\n# application Flask\napp = Flask(__name__)\n\n# cl\u00e9 secr\u00e8te de la session\napp.secret_key = os.urandom(12).hex()\n\n\n# Home URL\n@app.route('/', methods=['GET'])\ndef index():\n    # gestion d'une liste\n    liste = session.get('liste')\n    if liste is None:\n        # 1\u00e8re requ\u00eate\n        liste = [0, 10, 100]\n    else:\n        # requ\u00eates suivantes\n        for i in range(len(liste)):\n            liste[i] += 1\n    # on remet la liste dans la session\n    session['liste'] = liste\n\n    # gestion d'un dictionnaire\n    dico = session.get('dico')\n    if not dico:\n        # 1\u00e8re requ\u00eate\n        dico = {\"un\": 0, \"deux\": 10, \"trois\": 100}\n    else:\n        # requ\u00eates suivantes\n        dico = session['dico']\n        for key in dico.keys():\n            dico[key] += 1\n    # on remet le dictionnaire dans la session\n    session['dico'] = dico\n\n    # gestion d'une personne\n    personne_json = session.get('personne')\n    if personne_json is None:\n        # 1\u00e8re requ\u00eate\n        personne = Personne().fromdict({\"pr\u00e9nom\": \"agla\u00eb\", \"nom\": \"s\u00e9l\u00e9n\u00e9\", \"\u00e2ge\": 70})\n    else:\n        # requ\u00eates suivantes\n        personne = Personne().fromjson(personne_json)\n        personne.\u00e2ge += 1\n    # on remet la personne dans la session\n    session['personne'] = personne.asjson()\n\n    # dictionnaire des r\u00e9sultats\n    r\u00e9sultats = {\"liste\": liste, \"dict\": dico, \"personne\": personne.asdict()}\n\n    # on envoie une r\u00e9ponse jSON\n    response = make_response(json.dumps(r\u00e9sultats, ensure_ascii=False))\n    response.headers['Content-Type'] = 'application/json; charset=utf-8'\n    return response, status.HTTP_200_OK\n\n\n# main\nif __name__ == '__main__':\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>lignes 1-3\u00a0: l\u2019application web est configur\u00e9e\u00a0;</li> <li>lignes 5-11\u00a0: les d\u00e9pendances sont import\u00e9es\u00a0;</li> <li>ligne 14\u00a0: l\u2019application Flask est instanci\u00e9e\u00a0;</li> <li>ligne 17\u00a0: l\u2019attribut [secret_key] est initialis\u00e9. C\u2019est ce qui permet l\u2019utilisation de sessions\u00a0;</li> <li>ligne 21\u00a0: l\u2019unique route de l\u2019application\u00a0;</li> <li>lignes 23-33\u00a0: gestion d\u2019une liste dans la session. On a mis dans celle-ci des \u00e9l\u00e9ments s\u00e9rialisables par d\u00e9faut en jSON\u00a0;</li> <li>lignes 35-46\u00a0: gestion d\u2019un dictionnaire dans la session. On a mis dans celui-ci des \u00e9l\u00e9ments s\u00e9rialisables par d\u00e9faut en jSON\u00a0;</li> <li>lignes 48-58\u00a0: gestion d\u2019une personne. Un objet [Personne] n\u2019est pas s\u00e9rialisable par d\u00e9faut en jSON. Il faut donc prendre des pr\u00e9cautions\u00a0;</li> <li>ligne 58\u00a0: on utilise la m\u00e9thode [BaseEntity.asjson] pour stocker dans la session la cha\u00eene jSON de la personne. Noter qu\u2019on aurait pu utiliser [personne.asdict] car [personne.asdict] est un dictionnaire contenant des valeurs s\u00e9rialisables par d\u00e9faut en jSON\u00a0;</li> <li>ligne 55\u00a0: parce qu\u2019on a stock\u00e9 une cha\u00eene jSON dans la session, on r\u00e9cup\u00e8re la personne dans celle-ci en utilisant la m\u00e9thode [BaseEntity.fromjson]\u00a0;</li> <li>ligne 61\u00a0: on cr\u00e9e le dictionnaire [r\u00e9sultats] qui sera envoy\u00e9 comme r\u00e9ponse au client. On sait que dans ce cas l\u00e0, Flask envoie la cha\u00eene jSON du dictionnaire. Il faut donc que celui-ci ne contienne que des valeurs s\u00e9rialisables par d\u00e9faut en jSON\u00a0;</li> <li>ligne 64\u00a0: on met explicitement la cha\u00eene jSON du dictionnaire [r\u00e9sultats] dans a r\u00e9ponse HTTP. Flask l\u2019aurait fait par d\u00e9faut. Seulement, toujours par d\u00e9faut, il utilise le param\u00e8tre [ensure_ascii=True], ce qui ne nous convenait pas\u00a0;</li> <li>ligne 65\u00a0: on dit au client qu\u2019il va recevoir du jSON\u00a0;</li> <li>ligne 66\u00a0: on lui envoie la r\u00e9ponse\u00a0; On lance l\u2019application web. On supprime tous les cookies du client Postman. Puis celui-ci demande l\u2019URL [http://localhost:5000]. Le dialogue client / serveur dans la console Postman est le suivant\u00a0:</li> </ul> <pre><code>GET / HTTP/1.1\nUser-Agent: PostmanRuntime/7.26.1\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 5f8b7c63-aa8a-4429-a2fa-62141423d933\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\n\nHTTP/1.0 200 OK\nContent-Type: application/json; charset=utf-8\nContent-Length: 135\nVary: Cookie\nSet-Cookie: session=.eJw9isEKwyAQRH-lzHkPm15K91dqD2mzBMFq0AgF8d-jsRQG9u3MK1jsO0AKFs1fyMSEPQabOjbOHsKV4GzaFfJgmnr4Sdg0puB9a1EMtmgys959-BjIxWBe3XxWLwNq_39IQ3Q_f5zhnHxdtYs3rqgH4gQvMg.Xw6yGw.Bwpt3q-sH03gFLmg2FIPXV_ZNt8; HttpOnly; Path=/\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Wed, 15 Jul 2020 07:36:59 GMT\n\n{\"liste\": [0, 10, 100], \"dict\": {\"un\": 0, \"deux\": 10, \"trois\": 100}, \"personne\": {\"pr\u00e9nom\": \"agla\u00eb\", \"nom\": \"s\u00e9l\u00e9n\u00e9\", \"\u00e2ge\": 70}}\n</code></pre> <p>Nous faisons la requ\u00eate une seconde fois\u00a0:</p> <pre><code>GET / HTTP/1.1\nUser-Agent: PostmanRuntime/7.26.1\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 40fd00ea-d45c-46b7-a51e-d4d433a37b5c\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\nCookie: session=.eJw9isEKwyAQRH-lzHkPm15K91dqD2mzBMFq0AgF8d-jsRQG9u3MK1jsO0AKFs1fyMSEPQabOjbOHsKV4GzaFfJgmnr4Sdg0puB9a1EMtmgys959-BjIxWBe3XxWLwNq_39IQ3Q_f5zhnHxdtYs3rqgH4gQvMg.Xw6yGw.Bwpt3q-sH03gFLmg2FIPXV_ZNt8\n\nHTTP/1.0 200 OK\nContent-Type: application/json; charset=utf-8\nContent-Length: 135\nVary: Cookie\nSet-Cookie: session=.eJw9isEKwyAQRH-lzHkP2kupv9LtIW2WIBgNGqEg_nu3seQ0b2Zew-zfCa5hlvqBs5aw5-SLolGuUaETgi-7wD0sqaHPk7BJLilGXdEYW-ZqjNxjWhnuwpiWMB3Ti0Haz6MMMfz9EcM5-LrIT7zZjv4F5NYvOQ.Xw6ydQ.PMWRCqKx9HNnb_DyK-ha-9pCF7M; HttpOnly; Path=/\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Wed, 15 Jul 2020 07:38:29 GMT\n\n{\"liste\": [1, 11, 101], \"dict\": {\"deux\": 11, \"trois\": 101, \"un\": 1}, \"personne\": {\"pr\u00e9nom\": \"agla\u00eb\", \"nom\": \"s\u00e9l\u00e9n\u00e9\", \"\u00e2ge\": 71}}\n</code></pre> <ul> <li>ligne 9\u00a0: le client renvoie le cookie de session qu\u2019il a re\u00e7u\u00a0;</li> <li>ligne 15\u00a0: le serveur lui en renvoie un autre car le contenu de la session a chang\u00e9 (ligne 19). On rappelle que ce contenu est pr\u00e9sent dans le cookie de session sous forme cod\u00e9e\u00a0;</li> </ul>"},{"location":"services-web-avec-le-framework-flask.html#227-scripts-flask06-informations-partagees-par-tous-les-utilisateurs","title":"22.7. scripts [flask/06]\u00a0: informations partag\u00e9es par tous les utilisateurs","text":""},{"location":"services-web-avec-le-framework-flask.html#2271-introduction","title":"22.7.1. Introduction","text":"<p>Cette section vise \u00e0 montrer comment g\u00e9rer des informations de port\u00e9e application, \u00e7-\u00e0-d partag\u00e9es par tous les utilisateurs. Ces informations sont typiquement des informations de configuration de l\u2019application. Nous avons vu qu\u2019une application web pouvait maintenir diff\u00e9rents types de m\u00e9moire\u00a0:</p> <p></p> <p>Nous nous int\u00e9ressons ici \u00e0 la m\u00e9moire de l\u2019application [3].</p>"},{"location":"services-web-avec-le-framework-flask.html#2272-script-application_scope_01","title":"22.7.2. script [application_scope_01]","text":"<p>Le script [application_scope_01] montre une fa\u00e7on de g\u00e9rer des donn\u00e9es de port\u00e9e \u2018application\u2019\u00a0:</p> <pre><code># on configure l'application\nimport config\nconfig = config.configure()\n\n# d\u00e9pendances\nfrom flask import Flask, make_response\nfrom flask_api import status\n\n# application Flask\napp = Flask(__name__)\n\n\n# Home URL\n@app.route('/', methods=['GET'])\ndef index():\n    # on vise \u00e0 montrer que l'application reste en m\u00e9moire entre les requ\u00eates des diff\u00e9rents clients\n    # chaque client a affaire \u00e0 la m\u00eame application\n\n    # app_infos repr\u00e9sente des informations de niveau application et non de niveau session\n    # c-\u00e0-d qu'elle concerne tous les utilisateurs et non un en particulier\n    # cette information est ici stock\u00e9e dans [config] (pas obligatoire)\n\n    # dictionnaire des r\u00e9sultats\n    r\u00e9sultats = {\"config\": config}\n\n    # on envoie la r\u00e9ponse\n    response = make_response(r\u00e9sultats)\n    response.headers['Content-Type'] = 'application/json; charset=utf-8'\n    return response, status.HTTP_200_OK\n\n\n# main\nif __name__ == '__main__':\n    # on v\u00e9rifie si ce code est ex\u00e9cut\u00e9 plusieurs fois\n    print(\"application app lanc\u00e9e\")\n    # on lance l'application web\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>lignes 1-3\u00a0: on r\u00e9cup\u00e8re le dictionnaire de la configuration. On va montrer que le code situ\u00e9 en-dehors des fonctions de routage n\u2019est ex\u00e9cut\u00e9 qu\u2019une fois. L\u2019application Flask reste en m\u00e9moire. Toutes les informations initialis\u00e9es en-dehors des routes sont globales \u00e0 celles-ci et donc connues de celles-ci. Ainsi le dictionnaire [config] de la ligne 3 va-t-il \u00eatre rendu par la route / (ligne 24). On va montrer que tous les clients web vont recevoir le m\u00eame dictionnaire et que celui-ci est donc partag\u00e9 par tous les clients. C\u2019est donc une information de port\u00e9e \u2018application\u2019\u00a0;</li> <li>ligne 35\u00a0: on met un log pour voir si le code des lignes en-dehors de la fonction de routage (lignes 1-10, 32-38) est ex\u00e9cut\u00e9 plusieurs fois\u00a0; La configuration [config] est la suivante\u00a0:</li> </ul> <pre><code>def\u00a0configure():\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0{\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0Flask\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\"SECRET_KEY\":\u00a0\"vibnFfrdWYUp?*LQ\"\n\u00a0\u00a0\u00a0\u00a0}\n\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <p>Nous lan\u00e7ons cette application. Les logs dans la console PyCharm sont les suivants\u00a0:</p> <p></p> <ul> <li>en [1], lancement initial de l\u2019application\u00a0;</li> <li>en [2] parce qu\u2019on a demand\u00e9 le mode [Debug], l\u2019application est relanc\u00e9e en mode [Debug]\u00a0; Maintenant avec un navigateur (Chrome ci-dessous), on demande l\u2019URL [http://127.0.0.1:5000/]\u00a0:</li> </ul> <p></p> <p>Maintenant avec un navigateur Firefox\u00a0:</p> <p></p> <p>Maintenant avec le client Postman\u00a0:</p> <pre><code>GET / HTTP/1.1\nUser-Agent: PostmanRuntime/7.26.1\nAccept: */*\nCache-Control: no-cache\nPostman-Token: 51e75099-8ecb-4f27-ae3b-9386e982ede4\nHost: localhost:5000\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\n\nHTTP/1.0 200 OK\nContent-Type: application/json; charset=utf-8\nContent-Length: 39\nServer: Werkzeug/1.0.1 Python/3.8.1\nDate: Wed, 15 Jul 2020 10:34:26 GMT\n\n{\n\"SECRET_KEY\": \"vibnFfrdWYUp?*LQ\"\n}\n</code></pre> <p>Maintenant, on revient dans la console [Run] de Pycharm\u00a0:</p> <p></p> <ul> <li>les deux logs [1, 2] sont toujours l\u00e0 mais il n\u2019y en a pas d\u2019autres alors que l\u2019on voit les trois requ\u00eates re\u00e7ues par le serveur web\u00a0; Pour \u00eatre totalement s\u00fbrs que l\u2019application n\u2019est pas recharg\u00e9e \u00e0 chaque nouvelle requ\u00eate, on peut mettre un compteur dans la configuration et l\u2019incr\u00e9menter \u00e0 chaque nouvelle requ\u00eate. On verra alors que chaque client voit le compteur dans l\u2019\u00e9tat o\u00f9 l\u2019a laiss\u00e9 le pr\u00e9c\u00e9dent client. On rappelle cependant que les clients ne devraient pas modifier des donn\u00e9es de port\u00e9e application parce qu\u2019elles sont partag\u00e9es entre tous les clients et que dans un contexte o\u00f9 le serveur sert simultan\u00e9ment plusieurs clients sans garantie que la requ\u00eate d\u2019un client soit ex\u00e9cut\u00e9e enti\u00e8rement sans \u00eatre interrompue, un client 1 qui a \u00e9mis une requ\u00eate 1 interrompue avant sa fin peut laisser les donn\u00e9es partag\u00e9es dans un \u00e9tat corrompu pour les clients suivants.</li> </ul>"},{"location":"services-web-avec-le-framework-flask.html#2273-script-application_scope_02","title":"22.7.3. script [application_scope_02]","text":"<p>Le script [application_scope_02] va faire ce qu\u2019il ne faut pas faire\u00a0: permettre aux clients de modifier des informations partag\u00e9es avec les autres utilisateurs. On va partager un compteur entre les utilisateurs qui vont l\u2019incr\u00e9menter. On va voir que chaque utilisateur voit les modifications apport\u00e9es par les autres utilisateurs au compteur.</p> <p>Le script est le suivant\u00a0:</p> <pre><code># d\u00e9pendances\n\nfrom flask import Flask, make_response\nfrom flask_api import status\n\n# application Flask\napp = Flask(__name__)\n\n# donn\u00e9es de port\u00e9e application\nconfig = {\n    \"counter\": 0\n}\n\n\n# Home URL\n@app.route('/', methods=['GET'])\ndef index():\n    # on vise \u00e0 montrer que le dictionnaire [config] est partag\u00e9 entre tous les clients\n    # de l'application web\n\n    # on incr\u00e9mente le compteur\n    config[\"counter\"] += 1\n    # on envoie la r\u00e9ponse\n    response = make_response(config)\n    response.headers['Content-Type'] = 'application/json; charset=utf-8'\n    return response, status.HTTP_200_OK\n\n\n# main\nif __name__ == '__main__':\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>lignes 10-12\u00a0: le dictionnaire [config] partag\u00e9 par les utilisateurs. Il contient un compteur\u00a0;</li> <li>ligne 22\u00a0: \u00e0 chaque fois qu\u2019un utilisateur demandera l\u2019URL /, le compteur de la configuration sera incr\u00e9ment\u00e9\u00a0;</li> <li>lignes 23-26\u00a0: la cha\u00eene jSON du dictionnaire est envoy\u00e9e \u00e0 chaque client\u00a0; On lance ce script. Puis on demande l\u2019URL [http://127.0.0.1:5000/] avec un premier navigateur\u00a0:</li> </ul> <p></p> <p>On fait ensuite la m\u00eame chose avec un second navigateur\u00a0:</p> <p></p> <p>Puis une troisi\u00e8me fois avec Postman\u00a0:</p> <p></p> <p>On voit que chaque client r\u00e9cup\u00e8re le compteur dans l\u2019\u00e9tat o\u00f9 le client pr\u00e9c\u00e9dent l\u2019a laiss\u00e9. Ils ont donc bien acc\u00e8s \u00e0 la m\u00eame information.</p>"},{"location":"services-web-avec-le-framework-flask.html#2274-script-application_scope_03","title":"22.7.4. script [application_scope_03]","text":"<p>Le script [application_scope_03] montre pourquoi l\u2019information partag\u00e9e entre utilisateurs doit \u00eatre en lecture seule.</p> <p></p> <p>Le script est le suivant\u00a0:</p> <pre><code># d\u00e9pendances\nimport threading\nfrom time import sleep\n\nfrom flask import Flask, make_response\nfrom flask_api import status\n\n# application Flask\napp = Flask(__name__)\n\n# donn\u00e9es de port\u00e9e application\nconfig = {\n    \"counter\": 0\n}\n\n\n# Home URL\n@app.route('/', methods=['GET'])\ndef index():\n    # on vise \u00e0 montrer que le dictionnaire [config] est partag\u00e9 entre tous les clients\n    # de l'application web et qu'il doit \u00eatre en lecture seule\n\n    # nom du thread\n    thread_name = threading.current_thread().name\n    # on lit le compteur\n    counter = config[\"counter\"]\n    print(f\"compteur lu : {counter}, par le thread {thread_name}\")\n    # on s'arr\u00eate 5 secondes - du coup d'autres clients vont \u00eatre servis\n    sleep(5)\n    # on incr\u00e9mente le compteur de la configuration\n    config[\"counter\"] = counter + 1\n    # log\n    print(f\"compteur \u00e9crit : {config['counter']}, par le thread {thread_name}\")\n    # on envoie la r\u00e9ponse\n    response = make_response(config)\n    response.headers['Content-Type'] = 'application/json; charset=utf-8'\n    return response, status.HTTP_200_OK\n\n\n# main\nif __name__ == '__main__':\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run(threaded=True)\n</code></pre> <ul> <li>ligne 43\u00a0: on a chang\u00e9 le mode d\u2019ex\u00e9cution de l\u2019application web. On a \u00e9crit [threaded=True] pour indiquer que l\u2019application devait servir les utilisateurs simultan\u00e9ment. Cela se fait au moyen de threads d\u2019ex\u00e9cution\u00a0:</li> <li>il peut y avoir plusieurs threads d\u2019ex\u00e9cution simultan\u00e9s, chacun servant un utilisateur\u00a0;</li> <li>le processeur de la machine est partag\u00e9 par ces threads\u00a0;</li> <li>un thread peut \u00eatre interrompu avant qu\u2019il n\u2019ait termin\u00e9 son travail. Il sera repris ult\u00e9rieurement\u00a0;</li> <li>ligne 19\u00a0: la fonction [index] peut \u00eatre ex\u00e9cut\u00e9e simultan\u00e9ment par plusieurs threads\u00a0;</li> <li>ligne 24\u00a0: on r\u00e9cup\u00e8re le nom du thread qui ex\u00e9cute la fonction [index]\u00a0;</li> <li>ligne 26\u00a0: on lit la valeur du compteur. Pour les besoins de notre d\u00e9monstration on d\u00e9compose l\u2019incr\u00e9mentation du compteur de la fa\u00e7on suivante\u00a0:</li> <li>\u00e9tape 1\u00a0: lecture du compteur\u00a0(1 par exemple) par le thread 1\u00a0;</li> <li>\u00e9tape 2\u00a0: pause du thread 1 pendant 5 secondes (ligne 29). Parce que le thread 1 a demand\u00e9 une pause, le processeur est donn\u00e9 \u00e0 un autre thread, le thread 2. Le but est que ce nouveau thread lise la m\u00eame valeur du compteur\u00a0(=1). Puis lui aussi fait une pause de 5 secondes et perd le processeur\u00a0;</li> <li>\u00e9tape 3\u00a0: incr\u00e9mentation du compteur, ligne 31 \u00e0 partir de la valeur lue\u00a0\u00e0 l\u2019\u00e9tape 1 (=1). Le thread 1 est le 1er \u00e0 le faire\u00a0: il passe le compteur \u00e0 2 puis termine l\u2019ex\u00e9cution de la fonction [index]. Puis c\u2019est au tour du thread 2 de se r\u00e9veiller et de passer lui aussi le compteur \u00e0 2 \u00e0 partir de la valeur lue\u00a0\u00e0 l\u2019\u00e9tape 1 (=1). Au final, apr\u00e8s le passage des deux threads, le compteur est \u00e0 2 alors qu\u2019il devrait \u00eatre \u00e0 3\u00a0;</li> <li>ligne 33\u00a0: on affiche la valeur du compteur pour v\u00e9rification\u00a0; Nous lan\u00e7ons le script puis demandons l\u2019url [http://loaclhost\u00a0:5000/] avec deux navigateurs\u00a0puis avec Postman. Les logs dans la console PyCharm sont alors les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/flask/06/application_scope_03.py\n * Serving Flask app \"application_scope_03\" (lazy loading)\n * Environment: development\n * Debug mode: on\n * Restarting with stat\n * Debugger is active!\n * Debugger PIN: 334-263-283\n * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)\ncompteur lu : 0, par le thread Thread-2\ncompteur lu : 0, par le thread Thread-4\ncompteur \u00e9crit : 1, par le thread Thread-2\n127.0.0.1 - - [16/Jul/2020 08:55:37] \"GET / HTTP/1.1\" 200 -\ncompteur \u00e9crit : 1, par le thread Thread-4\n127.0.0.1 - - [16/Jul/2020 08:55:40] \"GET / HTTP/1.1\" 200 -\ncompteur lu : 1, par le thread Thread-5\ncompteur \u00e9crit : 2, par le thread Thread-5\n127.0.0.1 - - [16/Jul/2020 08:55:46] \"GET / HTTP/1.1\" 200 -\n</code></pre> <ul> <li>lignes 9-10\u00a0: les deux premiers threads 2 et 4 lisent la m\u00eame valeur 0 du compteur\u00a0;</li> <li>ligne 11\u00a0: le thread 2 passe le compteur \u00e0 1\u00a0;</li> <li>ligne 13\u00a0: le thread 4 passe le compteur \u00e0 1. A partir de maintenant la valeur du compteur est incorrecte\u00a0;</li> <li>lignes 15-16\u00a0: le thread 5 n\u2019est pas interrompu et g\u00e8re correctement la valeur du compteur\u00a0; On retiendra de cet exemple que le code d\u2019une application web ne doit pas modifier la valeur d\u2019informations partag\u00e9es par les utilisateurs.</li> </ul>"},{"location":"services-web-avec-le-framework-flask.html#228-scripts-flask07-gestion-des-routes","title":"22.8. scripts [flask/07]\u00a0: gestion des routes","text":"<p>Nous nous int\u00e9ressons ici \u00e0 la gestion des routes d\u2019une application, \u00e7-\u00e0-d les URL servies par l\u2019application web.</p>"},{"location":"services-web-avec-le-framework-flask.html#2281-script-main_01-routes-parametrees","title":"22.8.1. script [main_01]\u00a0: routes param\u00e9tr\u00e9es","text":"<p>Le script [main_01] introduit la possibilit\u00e9 de param\u00e9trer les routes\u00a0:</p> <pre><code>from flask import Flask, make_response\nfrom flask_api import status\n\n# application Flask\napp = Flask(__name__)\n\n\n# envoi de la r\u00e9ponse\ndef send_plain_response(r\u00e9ponse: str):\n    # on envoie la r\u00e9ponse\n    response = make_response(r\u00e9ponse)\n    response.headers['Content-Type'] = 'text/plain; charset=utf-8'\n    return response, status.HTTP_200_OK\n\n\n# /nom/prenom\n@app.route('/&lt;string:nom&gt;/&lt;string:prenom&gt;', methods=['GET'])\ndef index(nom, prenom):\n    # r\u00e9ponse\n    return send_plain_response(f\"{prenom} {nom}\")\n\n\n# init-session\n@app.route('/init-session/&lt;string:type&gt;', methods=['GET'])\ndef init_session(type: str):\n    # r\u00e9ponse\n    return send_plain_response(f\"/init-session/{type}\")\n\n\n# authentifier-utilisateur\n@app.route('/authentifier-utilisateur', methods=['POST'])\ndef authentifier_utilisateur():\n    # r\u00e9ponse\n    return send_plain_response(\"/authentifier-utilisateur\")\n\n\n# calculer-impot\n@app.route('/calculer-impot', methods=['POST'])\ndef calculer_impot():\n    # r\u00e9ponse\n    return send_plain_response(\"/calculer-impot\")\n\n\n# lister-simulations\n@app.route('/lister-simulations', methods=['GET'])\ndef lister_simulations():\n    # r\u00e9ponse\n    return send_plain_response(\"/lister-simulations\")\n\n\n# supprimer-simulation\n@app.route('/supprimer-simulation/&lt;int:numero&gt;', methods=['GET'])\ndef supprimer_simulation(numero: int):\n    # r\u00e9ponse\n    return send_plain_response(f\"/supprimer-simulation/{numero}\")\n\n\n# fin-session\n@app.route('/fin-session', methods=['GET'])\ndef fin_session():\n    # r\u00e9ponse\n    return send_plain_response(f\"/fin-session\")\n\n\n# main\nif __name__ == '__main__':\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>ligne 17\u00a0: on pr\u00e9cise le type des param\u00e8tres de l\u2019URL. Cela permet \u00e0 Flask de faire des v\u00e9rifications. Si le param\u00e8tre n\u2019est pas du type attendu, la requ\u00eate du client sera refus\u00e9e (erreur 400 Bad Request). Donc Flask fait une partie du travail que nous aurions du faire\u00a0;</li> <li>ligne 18\u00a0: pour les param\u00e8tres, on doit reprendre les noms exacts des param\u00e8tres de la ligne 17 mais pas forc\u00e9ment leur ordre\u00a0;</li> <li>ligne 20\u00a0: on utilise la fonction [send_plain_response] pour envoyer la r\u00e9ponse au client web\u00a0;</li> <li>ligne 9\u00a0: la fonction [send_plain_response] re\u00e7oit la cha\u00eene de caract\u00e8res \u00e0 envoyer au client\u00a0;</li> <li>ligne 11\u00a0: le corps de la r\u00e9ponse HTTP est construit\u00a0;</li> <li>ligne 12\u00a0: on dit au client qu\u2019on lui envoie du texte brut\u00a0;</li> <li>ligne 13\u00a0: on envoie la r\u00e9ponse HTTP\u00a0;</li> <li>lignes 23-62\u00a0: d\u2019autres routes param\u00e9tr\u00e9es qui seront utilis\u00e9es ult\u00e9rieurement dans un exercice d\u2019application\u00a0; On lance le script et on l\u2019interroge avec le client Postman\u00a0:</li> </ul> <p></p>"},{"location":"services-web-avec-le-framework-flask.html#2282-script-main_02-externalisation-des-routes","title":"22.8.2. script [main_02]\u00a0: externalisation des routes","text":"<p>Dans le script [main_01] pr\u00e9c\u00e9dent, le code peut devenir important s\u2019il y a de nombreuses routes. Le script [main_02] montre comment externaliser les routes.</p> <p></p> <p>Le script [routes_02] rassemble les fonctions associ\u00e9es aux routes du script pr\u00e9c\u00e9dent\u00a0:</p> <pre><code>from flask import make_response\nfrom flask_api import status\n\n\ndef send_response(r\u00e9ponse: str):\n    # on envoie la r\u00e9ponse\n    response = make_response(r\u00e9ponse)\n    response.headers['Content-Type'] = 'text/plain; charset=utf-8'\n    return response, status.HTTP_200_OK\n\n\n# Home URL\ndef index(nom, prenom):\n    # r\u00e9ponse\n    return send_response(f\"{prenom} {nom}\")\n\n\n# init-session\ndef init_session(type: str):\n    # r\u00e9ponse\n    return send_response(f\"/init-session/{type}\")\n\n\n# authentifier-utilisateur\ndef authentifier_utilisateur():\n    # r\u00e9ponse\n    return send_response(\"/authentifier-utilisateur\")\n\n\n# calculer-impot\ndef calculer_impot():\n    # r\u00e9ponse\n    return send_response(\"/calculer-impot\")\n\n\n# lister-simulations\ndef lister_simulations():\n    # r\u00e9ponse\n    return send_response(\"/lister-simulations\")\n\n\n# supprimer-simulation\ndef supprimer_simulation(numero: int):\n    # r\u00e9ponse\n    return send_response(f\"/supprimer-simulation/{numero}\")\n\n\n# fin-session\ndef fin_session():\n    # r\u00e9ponse\n    return send_response(f\"/fin-session\")\n</code></pre> <p>On notera que le script [routes_02] n\u2019est pas un script de routes. C\u2019est une liste de fonctions. C\u2019est le script principal [main_02] qui fait le lien entre routes et fonctions\u00a0:</p> <pre><code>from flask import Flask\n\n# on d\u00e9porte les fonctions des routes dans leur propre script\nimport routes_02\n\n# application Flask\napp = Flask(__name__)\n\n# associations routes / fonctions\napp.add_url_rule('/&lt;string:nom&gt;/&lt;string:prenom&gt;', methods=['GET'], view_func=routes_02.index)\napp.add_url_rule('/init-session/&lt;string:type&gt;', methods=['GET'], view_func=routes_02.init_session)\napp.add_url_rule('/authentifier-utilisateur', methods=['POST'], view_func=routes_02.authentifier_utilisateur)\napp.add_url_rule('/calculer-impot', methods=['POST'], view_func=routes_02.calculer_impot)\napp.add_url_rule('/lister-simulations', methods=['GET'], view_func=routes_02.lister_simulations)\napp.add_url_rule('/supprimer-simulation/&lt;int:numero&gt;', methods=['GET'], view_func=routes_02.supprimer_simulation)\napp.add_url_rule('/fin-session', methods=['GET'], view_func=routes_02.fin_session)\n\n# main\nif __name__ == '__main__':\n    app.config.update(ENV=\"development\", DEBUG=True)\n    app.run()\n</code></pre> <ul> <li>ligne 4\u00a0: on importe le script des fonctions associ\u00e9es aux routes\u00a0;</li> <li>lignes 9-16\u00a0: association routes / fonctions\u00a0; Avec cette m\u00e9thode, chaque fonction associ\u00e9e \u00e0 une route peut faire l\u2019objet d\u2019un script s\u00e9par\u00e9 si n\u00e9cessaire.</li> </ul> <p>Les r\u00e9sultats sont les m\u00eames que ceux obtenus avec le script [main_01] pr\u00e9c\u00e9dent.</p>"},{"location":"utilisation-de-lorm-sqlalchemy.html","title":"19. Utilisation de l\u2019ORM SQLALCHEMY","text":"<p>Le chapitre pr\u00e9c\u00e9dent a montr\u00e9 que dans certains cas on pouvait \u00e9crire du code ind\u00e9pendant du SGBD utilis\u00e9 avec l\u2019architecture suivante\u00a0:</p> <p></p> <p>Dans ce chapitre nous allons utiliser l\u2019ORM (Object Relational Mapper) [sqlalchemy] pour acc\u00e9der aux SGBD de fa\u00e7on uniforme quelque soit le SGBD utilis\u00e9. Un ORM permet deux choses\u00a0:</p> <ul> <li>il permet \u00e0 un script de dialoguer avec le SGBD sans \u00e9mettre d\u2019ordres SQL\u00a0;</li> <li>il masque au script les particularit\u00e9s de chaque SGBD\u00a0; L\u2019architecture devient la suivante\u00a0:</li> </ul> <p></p> <p>Le script est d\u00e9sormais s\u00e9par\u00e9 des connecteurs par l\u2019ORM. Il dialogue avec l\u2019ORM avec des classes et des m\u00e9thodes. Il n\u2019ex\u00e9cute pas de code SQL. C\u2019est l\u2019ORM qui le fait avec les connecteurs auxquels il est reli\u00e9. Il cache au script les particularit\u00e9s de ces connecteurs. Aussi le code du script est-il insensible \u00e0 un changement de connecteur (donc du SGBD)\u00a0;</p> <p>L\u2019arborescence des scripts \u00e9tudi\u00e9s sera la suivante\u00a0:</p> <p></p>"},{"location":"utilisation-de-lorm-sqlalchemy.html#191-installation-de-lorm-sqlalchemy","title":"19.1. Installation de l\u2019ORM [sqlalchemy]","text":"<p>L\u2019ORM [sqlalchemy] vient sous la forme d\u2019un package python qu\u2019il faut installer\u00a0dans un terminal Python\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\databases\\sqlalchemy&gt;pip install sqlalchemy\nCollecting sqlalchemy\n  Downloading SQLAlchemy-1.3.18-cp38-cp38-win_amd64.whl (1.2 MB)\n     || 1.2 MB 3.3 MB/s\nInstalling collected packages: sqlalchemy\nSuccessfully installed sqlalchemy-1.3.18\n</code></pre>"},{"location":"utilisation-de-lorm-sqlalchemy.html#192-scripts-01-les-bases","title":"19.2. Scripts 01\u00a0: les bases","text":"<ul> <li>en [1], les scripts qui vont \u00eatre \u00e9tudi\u00e9s. Ces scripts vont utiliser les classes de [2]\u00a0: BaseEntity, MyException, Personne, Utils\u00a0;</li> </ul>"},{"location":"utilisation-de-lorm-sqlalchemy.html#1921-configuration","title":"19.2.1. Configuration","text":"<p>Le fichier [config] configure l\u2019application de la fa\u00e7on suivante\u00a0:</p> <pre><code>def\u00a0configure():\n\u00a0\u00a0\u00a0\u00a0#\u00a0root_dir\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0absolu\u00a0r\u00e9f\u00e9rence\u00a0des\u00a0chemins\u00a0relatifs\u00a0de\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020\"\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemins\u00a0absolus\u00a0des\u00a0d\u00e9pendances\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0BaseEntity,\u00a0MyException,\u00a0Personne,\u00a0Utils\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/classes/02/entities\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fixe\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0des\u00a0classes\n\u00a0\u00a0\u00a0\u00a0from\u00a0Personne\u00a0import\u00a0Personne\n\u00a0\u00a0\u00a0\u00a0Personne.excluded_keys\u00a0=\u00a0['_sa_instance_state']\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0return\u00a0{}\n</code></pre> <p>Commentaires</p> <ul> <li>ligne 8\u00a0: on met dans le Python Path le dossier contenant les classes [BaseEntity, MyException, Personne, Utils]\u00a0;</li> <li>lignes 12-13\u00a0: on fixe le Python Path de l\u2019application\u00a0;</li> <li>lignes 16-17\u00a0: on se rappelle peut-\u00eatre que la classe |BaseEntity| a un attribut de classe nomm\u00e9 [excluded_keys]. Cet attribut est une liste dans laquelle on met les propri\u00e9t\u00e9s de la classe qu\u2019on ne veut pas voir appara\u00eetre dans le dictionnaire de celle-ci (fonction asdict). Ici on exclut la propri\u00e9t\u00e9 [_sa_instance_state] de l\u2019\u00e9tat de la classe [Personne]. On verra bient\u00f4t pourquoi\u00a0;</li> </ul>"},{"location":"utilisation-de-lorm-sqlalchemy.html#1922-script-demo","title":"19.2.2. Script [d\u00e9mo]","text":"<p>Le script [d\u00e9mo] montre une premi\u00e8re utilisation de l\u2019ORM [sqlalchemy]\u00a0:</p> <pre><code># on r\u00e9cup\u00e8re la configuration de l'application\nimport config\n\nconfig = config.configure()\n\n# imports\nfrom sqlalchemy import Table, Column, Integer, String, MetaData, UniqueConstraint\nfrom sqlalchemy.orm import mapper\n\nfrom Personne import Personne\n\n# metadata\nmetadata = MetaData()\n\n# la table\npersonnes_table = Table(\"personnes\", metadata,\n                        Column('id', Integer, primary_key=True),\n                        Column('prenom', String(30), nullable=False),\n                        Column(\"nom\", String(30), nullable=False),\n                        Column(\"age\", Integer, nullable=False),\n                        UniqueConstraint('nom', 'prenom', name='uix_1')\n                        )\n# la classe Personne avant le mapping\npersonne1 = Personne().fromdict({\"id\": 67, \"pr\u00e9nom\": \"x\", \"nom\": \"y\", \"\u00e2ge\": 10})\nprint(f\"personne1={personne1.__dict__}\")\n\n# le mapping\nmapper(Personne, personnes_table, properties={\n    'id': personnes_table.c.id,\n    'pr\u00e9nom': personnes_table.c.prenom,\n    'nom': personnes_table.c.nom,\n    '\u00e2ge': personnes_table.c.age\n})\n\n# personne1 n'a pas \u00e9t\u00e9 modifi\u00e9e\nprint(f\"personne1={personne1.__dict__}\")\n# la classe Personne a elle \u00e9t\u00e9 modifi\u00e9e - elle a \u00e9t\u00e9 \"enrichie\"\npersonne2 = Personne().fromdict({\"id\": 68, \"pr\u00e9nom\": \"x1\", \"nom\": \"y1\", \"\u00e2ge\": 11})\nprint(f\"personne2={personne2.__dict__}\")\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 1-4\u00a0: on configure l\u2019application\u00a0;</li> <li>lignes 6-10\u00a0: on importe les modules n\u00e9cessaires au script\u00a0;</li> <li>ligne 13\u00a0: [MetaData] est une classe de [sqlalchemy]\u00a0;</li> <li>lignes 15-22\u00a0: [Table] est une classe de [sqlalchemy]. Elle permet de d\u00e9crire une table d\u2019une base de donn\u00e9es. Ici, nous allons d\u00e9crire la table [personnes] de la base MySQL [dbpersonnes] \u00e9tudi\u00e9e au chapitre |MySQL|\u00a0;</li> <li>ligne 16\u00a0: le 1er param\u00e8tre [personnes] est le nom de la table d\u00e9crite\u00a0;</li> <li>ligne 16\u00a0: le second param\u00e8tre [metadata] est l\u2019instance [MetaData] cr\u00e9\u00e9e ligne 13\u00a0;</li> <li>lignes 17-22\u00a0: chacun des param\u00e8tres suivants d\u00e9crit une colonne de la table avec une syntaxe propre \u00e0 [sqlalchemy] mais proche de la syntaxe SQL\u00a0;</li> <li>chaque colonne se d\u00e9crit avec une instance de la classe [Column] de [sqlalchemy]\u00a0;</li> <li>le 1er param\u00e8tre est le nom de la colonne\u00a0;</li> <li>le second param\u00e8tre est son type\u00a0;</li> <li>les param\u00e8tres suivants sont des param\u00e8tres nomm\u00e9s\u00a0:</li> <li>ligne 17\u00a0: [primary_key=True] pour indiquer que la colonne [id] est cl\u00e9 primaire de la table [personnes]\u00a0;</li> <li>ligne 18\u00a0: [nullable=False] pour indiquer qu\u2019uen colonne doit forc\u00e9ment avoir une valeur lorsqu\u2019une ligne est ins\u00e9r\u00e9e dans la table\u00a0;</li> <li>ligne 21\u00a0: enfin la classe [UniqueConstraint] permet de d\u00e9crire une contrainte d\u2019unicit\u00e9. Ici on indique que les colonnes (nom, prenom) doivent \u00eatre uniques dans la table. La propri\u00e9t\u00e9 nomm\u00e9e [name] permet de donner un nom \u00e0 cette constrainte. Ici, il faut distinguer deux cas\u00a0:</li> <li>on d\u00e9crit une table existante. Il faut alors chercher le nom de la contrainte dans les propri\u00e9t\u00e9s de la table (phpMyAdmin ou pgAdmin)\u00a0;</li> <li>on d\u00e9crit une table que l\u2019on va cr\u00e9er. Alors on met le nom que l\u2019on veut\u00a0;</li> <li> <p>lignes 23-25\u00a0: on cr\u00e9e une personne [personne1] et on affiche son dictionnaire [dict]. On va avoir ici\u00a0: <pre><code>personne1={'_BaseEntity__id': 67, '_Personne__pr\u00e9nom': 'x', '_Personne__nom': 'y', '_Personne__\u00e2ge': 10}\n</code></pre></p> </li> <li> <p>lignes 27-33\u00a0: on fait un mapping, \u00e7-\u00e0-d qu\u2019on cr\u00e9e une correspondance entre la classe [Personne] et la table [personnes]. C\u2019est essentiellement une correspondance [propri\u00e9t\u00e9s de la classe \uf0df\uf0e0 colonnes de la table]. La fonction [mapper] accepte ici trois param\u00e8tres\u00a0:</p> </li> <li>ligne 28\u00a0: le 1er param\u00e8tre est le nom de la classe pour laquelle on fait le mapping\u00a0;</li> <li>ligne 28\u00a0: le second param\u00e8tre est la table \u00e0 laquelle elle va \u00eatre associ\u00e9e. Celle-ci est l\u2019objet [Table] cr\u00e9\u00e9 ligne 16\u00a0;</li> <li>ligne 28\u00a0: le 3i\u00e8me param\u00e8tre est ici un param\u00e8tre nomm\u00e9 [properties]. C\u2019est un dictionnaire dans lequel les cl\u00e9s sont les propri\u00e9t\u00e9s de la classe mapp\u00e9e et les valeurs les colonnes de la table mapp\u00e9e. Pour d\u00e9signer la colonne X de la table [personnes_table], on \u00e9crit [personnes_table.c.X]\u00a0;</li> <li> <p>lignes 35-36\u00a0: on r\u00e9affiche la personne [personne1] une fois le mapping fait. On constate qu\u2019elle n\u2019a pas chang\u00e9\u00a0: <pre><code>personne1={'_BaseEntity__id': 67, '_Personne__pr\u00e9nom': 'x', '_Personne__nom': 'y', '_Personne__\u00e2ge': 10}\n</code></pre></p> </li> <li> <p>lignes 37-39\u00a0: on cr\u00e9e une nouvelle personne [personne2] et on l\u2019affiche. On a alors l\u2019affichage suivant\u00a0: <pre><code>personne2={'_sa_instance_state': &lt;sqlalchemy.orm.state.InstanceState object at 0x00000259A6747FA0&gt;, 'id': 68, 'pr\u00e9nom': 'x1', 'nom': 'y1', '\u00e2ge': 11}\n</code></pre></p> </li> </ul> <p>On constate que le dictionnaire [dict] a \u00e9t\u00e9 profond\u00e9ment modifi\u00e9\u00a0:</p> <ul> <li>une nouvelle propri\u00e9t\u00e9 [_sa_instance_state] appara\u00eet. On voit que c\u2019est un objet de l\u2019ORM [sqlalchemy]\u00a0;</li> <li>les autres propri\u00e9t\u00e9s ont \u00e9t\u00e9 d\u00e9barrass\u00e9es de leur pr\u00e9fixe qui indiquait \u00e0 quelle classe elles appartenaient\u00a0; On peut donc conclure que l\u2019op\u00e9ration de mapping des lignes 27-33 a modifi\u00e9 la classe [Personne].</li> </ul> <p>Lorsqu\u2019on voudra afficher l\u2019\u00e9tat d\u2019un objet [Personne], on ne voudra pas en g\u00e9n\u00e9ral de la propri\u00e9t\u00e9 [_sa_instance_state]. Elle n\u2019est l\u00e0 en effet que pour la cuisine interne de [sqlalchemy] et en g\u00e9n\u00e9ral elle ne nous int\u00e9resse pas. C\u2019est pourquoi on a \u00e9crit dans le script [config]\u00a0:</p> <pre><code>    # configuration des classes\n    from Personne import Personne\n    Personne.excluded_keys = ['_sa_instance_state']\n</code></pre>"},{"location":"utilisation-de-lorm-sqlalchemy.html#1923-le-script-main","title":"19.2.3. Le script [main]","text":"<p>Le script [main] va manipuler la table [personnes] de la base MySQL [dbpersonnes] en s\u2019interfa\u00e7ant avec [sqlalchemy]. Pour comprendre la suite, il faut se rappeler l\u2019architecture utilis\u00e9e ici\u00a0:</p> <p></p> <p>Si [Database1] est la base [dbpersonnes], on voit que la liaison entre le script et cette base passe par deux entit\u00e9s\u00a0:</p> <ul> <li>le connecteur Python au SGBD MySQL\u00a0;</li> <li>le SGBD MySQL\u00a0; Le script [main] va dialoguer avec l\u2019ORM qui va ensuite dialoguer avec le connecteur Python. L\u2019ORM dialogue avec ce connecteur avec les outils d\u00e9crits dans les paragraphes |MySQL| et |PostgreSQL| notamment en \u00e9mettant des ordres SQL. Le script [main] ne va pas utiliser d\u2019ordres SQL. Il va s\u2019appuyer sur l\u2019API (Application Programming Interface) de l\u2019ORM, faite de classes et d\u2019interfaces.</li> </ul> <p>Le script [main] est le suivant\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# imports\nfrom sqlalchemy import create_engine, Table, Column, Integer, String, MetaData, UniqueConstraint\nfrom sqlalchemy.exc import IntegrityError, InterfaceError\nfrom sqlalchemy.orm import mapper, sessionmaker\n\nfrom Personne import Personne\n\n# cha\u00eene de connexion \u00e0 une base de donn\u00e9es MySQL\nengine = create_engine(\"mysql+mysqlconnector://admpersonnes:nobody@localhost/dbpersonnes\")\n\n# metadata\nmetadata = MetaData()\n\n# la table\npersonnes_table = Table(\"personnes\", metadata,\n                        Column('id', Integer, primary_key=True),\n                        Column('prenom', String(30), nullable=False),\n                        Column(\"nom\", String(30), nullable=False),\n                        Column(\"age\", Integer, nullable=False),\n                        UniqueConstraint('nom', 'prenom', name='uix_1')\n                        )\n\n# le mapping\nmapper(Personne, personnes_table, properties={\n    'id': personnes_table.c.id,\n    'pr\u00e9nom': personnes_table.c.prenom,\n    'nom': personnes_table.c.nom,\n    '\u00e2ge': personnes_table.c.age\n})\n\n# la session factory\nSession = sessionmaker()\nSession.configure(bind=engine)\n\nsession = None\ntry:\n    # une session\n    session = Session()\n\n    # suppression de la table [personnes]\n    session.execute(\"drop table if exists personnes\")\n\n    # recr\u00e9ation de la table \u00e0 partir du mapping\n    metadata.create_all(engine)\n\n    # une insertion\n    session.add(Personne().fromdict({\"id\": 67, \"pr\u00e9nom\": \"x\", \"nom\": \"y\", \"\u00e2ge\": 10}))\n    # session.commit()\n\n    # une requ\u00eate\n    personnes = session.query(Personne).all()\n\n    # affichage\n    print(\"Liste des personnes ---------\")\n    for personne in personnes:\n        print(personne)\n\n    # deux autres insertions dont la seconde \u00e9choue \u00e0 cause de l'unicit\u00e9 (pr\u00e9nom,nom)\n    session.add(Personne().fromdict({\"id\": 68, \"pr\u00e9nom\": \"x1\", \"nom\": \"y1\", \"\u00e2ge\": 10}))\n    session.add(Personne().fromdict({\"id\": 69, \"pr\u00e9nom\": \"x1\", \"nom\": \"y1\", \"\u00e2ge\": 10}))\n\n    # une requ\u00eate\n    personnes = session.query(Personne).all()\n\n    # affichage\n    print(\"Liste des personnes ---------\")\n    for personne in personnes:\n        print(personne)\n\n    # validation de la session\n    session.commit()\n\nexcept (InterfaceError, IntegrityError) as erreur:\n    # affichage\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\n    # annulation de la derni\u00e8re session\n    if session:\n        print(\"rollback...\")\n        session.rollback()\nfinally:\n    # on lib\u00e8re les ressources de la session\n    if session:\n        session.close()\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 1-4\u00a0: l\u2019application est configur\u00e9e\u00a0;</li> <li>lignes 7-9\u00a0: on importe toute une s\u00e9rie de classes et d\u2019interfaces de la biblioth\u00e8que [sqlalchemy]\u00a0;</li> <li>ligne 11\u00a0: la classe [Personne] est import\u00e9e\u00a0;</li> <li>ligne 14\u00a0: la cha\u00eene de connexion \u00e0 la base de donn\u00e9es. Elle pr\u00e9cise\u00a0:</li> <li>le SGBD utilis\u00e9 (mysql)\u00a0;</li> <li>le connecteur Python utilis\u00e9 (mysql.connector sans le .)\u00a0;</li> <li>l\u2019utilisateur qui se connecte (admpersonnes)\u00a0;</li> <li>son mot de passe (nobody)\u00a0;</li> <li>la machine sur laquelle se trouve le SGBD (localhost=machine sur laquelle se trouve le script qui s\u2019ex\u00e9cute)\u00a0;</li> <li> <p>le nom de la base de donn\u00e9es (dbpersonnes)\u00a0; Avec ces informations, [sqlalchemy] peut se connecter \u00e0 la base de donn\u00e9es. A noter que le connecteur Python utilis\u00e9 doit \u00eatre d\u00e9j\u00e0 install\u00e9. [sqlalchemy] ne le fait pas.</p> </li> <li> <p>lignes 19-26\u00a0: description de la table [personnes]\u00a0;</p> </li> <li>lignes 28-34\u00a0: mapping entre la classe [Personne] et la table [personnes]\u00a0;</li> <li>lignes 36-38\u00a0: la plupart des op\u00e9rations [sqlalchemy] se font dans une session. La notion de session [sqlalchemy] est proche de celle de transaction SQL. Les sessions sont cr\u00e9es \u00e0 partir de la classe [Session] rendue par la fonction [sessionmaker] de la ligne 37\u00a0;</li> <li>ligne 38\u00a0: la classe [Session] est associ\u00e9e \u00e0 la base [dbpersonnes] via la cha\u00eene de connexion de la ligne 14\u00a0;</li> <li>ligne 43\u00a0: on cr\u00e9e une session. Comme il a \u00e9t\u00e9 dit, on peut rapprocher une session d\u2019une transaction\u00a0;</li> <li>lignes 45-46\u00a0: la m\u00e9thode [Session.execute] permet d\u2019ex\u00e9cuter un ordre SQL. Ce n\u2019est pas quelque chose de courant puisqu\u2019on a dit que l\u2019ORM permettait d\u2019\u00e9viter le langage SQL\u00a0;</li> <li>lignes 48-49\u00a0: la m\u00e9thode [metadata.create_all] permet de cr\u00e9er toutes les tables utilisant l\u2019instance [MetaData] de la ligne 17. Nous n\u2019en avons qu\u2019une\u00a0: la table [personnes] d\u00e9finie lignes 20-26. [sqlalchemy] va utiliser l\u2019information de ces lignes pour cr\u00e9er la table. On a l\u00e0 un premier int\u00e9r\u00eat de l\u2019ORM\u00a0: il cache les sp\u00e9cificit\u00e9s des SGBD. En effet, l\u2019ordre SQL [create] peut \u00eatre tr\u00e8s diff\u00e9rent d\u2019un SGBD \u00e0 l\u2019autre \u00e0 cause des types donn\u00e9s aux colonnes. Il n\u2019y a pas eu d\u2019uniformisation SQL des types de donn\u00e9es. Ainsi l\u2019ordre [create] varie d\u2019un SGBD \u00e0 l\u2019autre. Ici, gr\u00e2ce \u00e0 [sqlalchemy]\u00a0:</li> <li>nous d\u00e9crivons de fa\u00e7on unique la table que nous d\u00e9sirons\u00a0;</li> <li>[sqlalchemy] se d\u00e9brouille pour g\u00e9n\u00e9rer le [create] qui va bien pour le SGBD qu\u2019il a en face de lui\u00a0;</li> <li>ligne 52\u00a0: on ajoute un objet [Personne] \u00e0 la session. Cela ne l\u2019ajoute pas automatiquement en base de donn\u00e9es. En effet, un ORM suit ses propres r\u00e8gles pour se synchroniser avec la base de donn\u00e9es. Il va toujours chercher \u00e0 optimiser le nombre de requ\u00eates qu\u2019il fait. Prenons un exemple. Le script ajoute (add) deux personnes (personne1, personne2) dans la session puis fait ensuite une requ\u00eate\u00a0: il veut voir toutes les personnes pr\u00e9sentes dans la table. [sqlalchemy] peut proc\u00e9der ainsi\u00a0:</li> <li>l\u2019ajout de [personne1] peut se faire en m\u00e9moire. Il n\u2019y a pas besoin pour l\u2019instant de le mettre en base de donn\u00e9es\u00a0;</li> <li>idem pour [personne2]\u00a0;</li> <li> <p>vient ensuite la requ\u00eate de type [select]. Il faut alors r\u00e9cup\u00e9rer toutes les lignes de la table [personnes]. [sqlalchemy] va alors mettre [personne1, personne2] en base puis faire la requ\u00eate\u00a0; [sqlalchemy] va ainsi faire des optimisations transparentes pour le d\u00e9veloppeur.</p> </li> <li> <p>ligne 56\u00a0: pour faire une requ\u00eate de type [select] (je veux voir \u2026), on utilise la m\u00e9thode [Session.query]. Le param\u00e8tre de la m\u00e9thode [query] est la classe mapp\u00e9e avec la table interrog\u00e9e. Cette m\u00e9thode rend un type [Query]. La m\u00e9thode [Query.all] demande tous les objets [Personne] de la session. On lui ram\u00e8ne toutes les lignes de la table [personnes], chacune sous la forme d\u2019un objet [Personne]. Pour faire cela, [sqlalchemy] utilise le mapping qui a \u00e9t\u00e9 fait entre la classe [Personne] et la table [personnes]. Le r\u00e9sultat de la ligne 56 est une liste d\u2019objets [Personne]\u00a0;</p> </li> <li>lignes 58-61\u00a0: on affiche les \u00e9l\u00e9ments de la liste [personnes]. Parce que la classe [Personne] d\u00e9rive de la classe [BaseEntity], la m\u00e9thode [Personne.str] utilis\u00e9e ici implicitement dans la ligne 61, est en fait la m\u00e9thode [BaseEntity.str] qui rend la cha\u00eene jSON de l\u2019objet appelant. Cette cha\u00eene est la cha\u00eene jSON du dictionnaire [Personne.asdict] (cf. |BaseEntity|). Nous avons dit qu\u2019apr\u00e8s le mapping, on allait trouver la propri\u00e9t\u00e9 [_sa_instance_state] dans chaque objet [Personne]. Or la valeur de cette propri\u00e9t\u00e9 n\u2019est pas un type [BaseEntity]. Il faut donc l\u2019exclure du dictionnaire de la classe [Personne] sinon l\u2019affichage \u2018plante\u2019. C\u2019est ce qui a \u00e9t\u00e9 fait dans le script [config]\u00a0;</li> <li>lignes 63-65\u00a0: on ajoute deux autres personnes qui ont les m\u00eames nom et pr\u00e9nom. Or on a une contrainte d\u2019unicit\u00e9 sur l\u2019union de ces deux colonnes. Une erreur devrait donc se produire. C\u2019est ce qu\u2019on cherche \u00e0 voir\u00a0;</li> <li>lignes 67-68\u00a0: on demande de nouveau la liste de toutes les personnes de la base\u00a0;</li> <li>lignes 70-73\u00a0: et on les affiche\u00a0;</li> <li>lignes 75-76\u00a0: la session est valid\u00e9e \u2018commit\u00e9e\u2019. Comme son nom l\u2019indique, la transaction sous-jacente va \u00eatre valid\u00e9e\u00a0;</li> <li>on va voir \u00e0 l\u2019ex\u00e9cution que les lignes 67-76 ne vont pas \u00eatre ex\u00e9cut\u00e9es \u00e0 cause de l\u2019exception produite par la ligne 65. On va alors aller aux lignes 78-84 pour g\u00e9rer l\u2019exception\u00a0;</li> <li>ligne 78\u00a0: l\u2019exception [InterfaceError] se produit si [sqlalchemy] n\u2019arrive pas \u00e0 se connecter \u00e0 la base de donn\u00e9es [dbpersonnes]. L\u2019exception [IntegrityError] se produit ligne 65\u00a0;</li> <li>ligne 80\u00a0: on affiche l\u2019erreur\u00a0;</li> <li>lignes 82-84\u00a0: si la session existe, on l\u2019annule. Cela revient \u00e0 annuler la transaction sous-jacente\u00a0;</li> <li>lignes 85-88\u00a0: dans tous les cas, erreur ou pas, la session est ferm\u00e9e pour lib\u00e9rer des ressources\u00a0; Les r\u00e9sultats de l\u2019ex\u00e9cution sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/sqlalchemy/01/main.py\nListe des personnes ---------\n{\"nom\": \"y\", \"pr\u00e9nom\": \"x\", \"id\": 67, \"\u00e2ge\": 10}\nL'erreur suivante s'est produite : (raised as a result of Query-invoked autoflush; consider using a session.no_autoflush block if this flush is occurring prematurely)\n(mysql.connector.errors.IntegrityError) 1062 (23000): Duplicate entry 'y1-x1' for key 'uix_1'\n[SQL: INSERT INTO personnes (id, prenom, nom, age) VALUES (%(id)s, %(prenom)s, %(nom)s, %(age)s)]\n[parameters: ({'id': 68, 'prenom': 'x1', 'nom': 'y1', 'age': 10}, {'id': 69, 'prenom': 'x1', 'nom': 'y1', 'age': 10})]\n(Background on this error at: http://sqlalche.me/e/13/gkpj)\nrollback...\n\nProcess finished with exit code 0\n</code></pre> <ul> <li>lignes 2-3\u00a0: la liste des personnes apr\u00e8s la 1\u00e8re insertion\u00a0;</li> <li>ligne 5\u00a0: l\u2019exception [IntegrityError] qui s\u2019est produite lorsqu\u2019on a ajout\u00e9 deux personnes ayant les m\u00eames nom et pr\u00e9nom\u00a0;</li> <li>lignes 6-7\u00a0: on notera l\u2019ordre SQL qui a \u00e9chou\u00e9. C\u2019est un ordre INSERT param\u00e9tr\u00e9\u00a0: [sqlalchemy] a ins\u00e9r\u00e9 les deux personnes avec un unique INSERT. On voit l\u00e0 qu\u2019il a essay\u00e9 d\u2019optimiser les ordres SQL \u00e9mis\u00a0; Maintenant allons-voir, avec phpMyAdmin, le contenu de la table [personnes]\u00a0:</li> </ul> <p></p> <p>On voit en [6] que la table est vide. Il n\u2019y a m\u00eame pas la 1\u00e8re personne que le script avait mis dans la session. Ceci parce que celle-ci se d\u00e9roulait dans une transaction et que celle-ci a \u00e9t\u00e9 d\u00e9faite dans la clause [except] du script [main].</p> <p>Proc\u00e9dons maintenant \u00e0 la modification suivante\u00a0dans [main]\u00a0:</p> <pre><code>    # une insertion\n    session.add(Personne().fromdict({\"id\": 67, \"pr\u00e9nom\": \"x\", \"nom\": \"y\", \"\u00e2ge\": 10}))\n    # session.commit()\n</code></pre> <p>Apr\u00e8s avoir ajout\u00e9 une personne ligne 2, nous d\u00e9commentons la ligne 3. L\u2019op\u00e9ration [session.commit] va valider la transaction sous-jacente et une nouvelle transaction va d\u00e9marrer. Apr\u00e8s ex\u00e9cution, le contenu de la table [personnes] est le suivant\u00a0:</p> <p></p> <p>On voit en [6] que la 1\u00e8re insertion a \u00e9t\u00e9 conserv\u00e9e. Cela vient du fait qu\u2019elle a \u00e9t\u00e9 faite au sein d\u2019une transaction 1 et que l\u2019erreur qui a suivi a \u00e9t\u00e9 faite au sein d\u2019une transaction 2.</p>"},{"location":"utilisation-de-lorm-sqlalchemy.html#193-scripts-02-les-mappings-de-sqlalchemy","title":"19.3. Scripts 02\u00a0: les mappings de [sqlalchemy]","text":"<p>Les scripts 02 sont une variante des scripts 01. On essaie de faire le maximum de configurations dans [config.py]. On y configure maintenant l\u2019environnement [sqlalchemy] de l\u2019application\u00a0:</p> <pre><code>def\u00a0configure():\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0absolu\u00a0r\u00e9f\u00e9rence\u00a0des\u00a0chemins\u00a0relatifs\u00a0de\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020\"\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemins\u00a0absolus\u00a0des\u00a0d\u00e9pendances\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0BaseEntity,\u00a0MyException,\u00a0Personne,\u00a0Utils\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/classes/02/entities\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0fixe\u00a0le\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0imports\n\u00a0\u00a0\u00a0\u00a0from\u00a0sqlalchemy\u00a0import\u00a0create_engine,\u00a0Table,\u00a0Column,\u00a0Integer,\u00a0String,\u00a0MetaData,\u00a0UniqueConstraint\n\u00a0\u00a0\u00a0\u00a0from\u00a0sqlalchemy.orm\u00a0import\u00a0mapper,\u00a0sessionmaker\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0lien\u00a0vers\u00a0une\u00a0base\u00a0de\u00a0donn\u00e9es\u00a0MySQL\n\u00a0\u00a0\u00a0\u00a0engine\u00a0=\u00a0create_engine(\"mysql+mysqlconnector://admpersonnes:nobody@localhost/dbpersonnes\")\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0metadata\n\u00a0\u00a0\u00a0\u00a0metadata\u00a0=\u00a0MetaData()\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0table\n\u00a0\u00a0\u00a0\u00a0personnes_table\u00a0=\u00a0Table(\"personnes\",\u00a0metadata,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Column('id',\u00a0Integer,\u00a0primary_key=True),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Column('prenom',\u00a0String(30),\u00a0nullable=False),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Column(\"nom\",\u00a0String(30),\u00a0nullable=False),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0Column(\"age\",\u00a0Integer,\u00a0nullable=False),\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0UniqueConstraint('nom',\u00a0'prenom',\u00a0name='uix_1')\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0le\u00a0mapping\n\u00a0\u00a0\u00a0\u00a0from\u00a0Personne\u00a0import\u00a0Personne\n\n\u00a0\u00a0\u00a0\u00a0mapper(Personne,\u00a0personnes_table,\u00a0properties={\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0'id':\u00a0personnes_table.c.id,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0'pr\u00e9nom':\u00a0personnes_table.c.prenom,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0'nom':\u00a0personnes_table.c.nom,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0'\u00e2ge':\u00a0personnes_table.c.age\n\u00a0\u00a0\u00a0\u00a0})\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0la\u00a0session\u00a0factory\n\u00a0\u00a0\u00a0\u00a0Session\u00a0=\u00a0sessionmaker()\n\u00a0\u00a0\u00a0\u00a0Session.configure(bind=engine)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0met\u00a0ces\u00a0informations\u00a0dans\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0{}\n\u00a0\u00a0\u00a0\u00a0config[\"Session\"]\u00a0=\u00a0Session\n\u00a0\u00a0\u00a0\u00a0config[\"metadata\"]\u00a0=\u00a0metadata\n\u00a0\u00a0\u00a0\u00a0config[\"engine\"]\u00a0=\u00a0engine\n\u00a0\u00a0\u00a0\u00a0config[\"personnes_table\"]\u00a0=\u00a0personnes_table\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0des\u00a0classes\n\u00a0\u00a0\u00a0\u00a0from\u00a0Personne\u00a0import\u00a0Personne\n\u00a0\u00a0\u00a0\u00a0Personne.excluded_keys\u00a0=\u00a0['_sa_instance_state']\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 2-12\u00a0: configuration du Python Path\u00a0;</li> <li>lignes 14-45\u00a0: on configure l\u2019environnement [sqlalchemy]\u00a0;</li> <li>lignes 47-52\u00a0: l\u2019environnement [sqlalchemy] est mis dans le dictionnaire de la configuration\u00a0;</li> <li>lignes 54-56\u00a0: on configure la classe [Personne]\u00a0; Avec cette configuration le script [main] devient le suivant\u00a0:</li> </ul> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# le syspath est configur\u00e9 - on fait les imports\nfrom sqlalchemy.exc import IntegrityError, DatabaseError, InterfaceError\nfrom sqlalchemy.orm.exc import FlushError\n\nfrom Personne import Personne\n\nsession = None\ntry:\n    # une session\n    session = config[\"Session\"]()\n\n    # suppression de la table [personnes]\n    session.execute(\"drop table if exists personnes\")\n\n    # recr\u00e9ation de la table \u00e0 partir du mapping\n    config[\"metadata\"].create_all(config[\"engine\"])\n\n    # deux insertions\n    session.add(Personne().fromdict({\"pr\u00e9nom\": \"x\", \"nom\": \"y\", \"\u00e2ge\": 10}))\n    personne = Personne().fromdict({\"pr\u00e9nom\": \"x1\", \"nom\": \"y1\", \"\u00e2ge\": 7})\n    session.add(personne)\n\n    # validation des deux insertions\n    session.commit()\n\n    # une requ\u00eate\n    personnes = session.query(Personne).all()\n\n    # affichage\n    print(\"Liste des personnes-----------\")\n    for personne in personnes:\n        print(personne)\n\n    # deux autres insertions dont la seconde \u00e9choue\n    session.add(Personne().fromdict({\"pr\u00e9nom\": \"x2\", \"nom\": \"y2\", \"\u00e2ge\": 10}))\n    session.add(Personne().fromdict({\"pr\u00e9nom\": \"x2\", \"nom\": \"y2\", \"\u00e2ge\": 10}))\n\n    # une requ\u00eate\n    personnes = session.query(Personne).all()\n\n    # affichage\n    print(\"Liste des personnes-----------\")\n    for personne in personnes:\n        print(personne)\n\n    # validation de la session\n    session.commit()\n\nexcept (FlushError, DatabaseError, InterfaceError, IntegrityError) as erreur:\n    # affichage\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\n    # annulation de la derni\u00e8re session\n    if session:\n        print(\"rollback...\")\n        session.rollback()\nfinally:\n    # affichage\n    print(\"Travail termin\u00e9...\")\n    # on lib\u00e8re les ressources de la session\n    if session:\n        session.close()\n</code></pre> <p>Les r\u00e9sultats de l\u2019ex\u00e9cution sont les suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/sqlalchemy/02/main.py\nListe des personnes-----------\n{\"\u00e2ge\": 10, \"nom\": \"y\", \"pr\u00e9nom\": \"x\", \"id\": 1}\n{\"\u00e2ge\": 7, \"nom\": \"y1\", \"pr\u00e9nom\": \"x1\", \"id\": 2}\nL'erreur suivante s'est produite : (raised as a result of Query-invoked autoflush; consider using a session.no_autoflush block if this flush is occurring prematurely)\n(mysql.connector.errors.IntegrityError) 1062 (23000): Duplicate entry 'y2-x2' for key 'uix_1'\n[SQL: INSERT INTO personnes (prenom, nom, age) VALUES (%(prenom)s, %(nom)s, %(age)s)]\n[parameters: {'prenom': 'x2', 'nom': 'y2', 'age': 10}]\n(Background on this error at: http://sqlalche.me/e/13/gkpj)\nrollback...\nTravail termin\u00e9...\n\nProcess finished with exit code 0\n</code></pre> <p>Dans phpMyAdmin, la table [personnes] est devenue la suivante\u00a0:</p> <p></p> <p>Maintenant, regardons la table [personnes]\u00a0g\u00e9n\u00e9r\u00e9e par [sqlalchemy]\u00a0:</p> <p></p> <ul> <li>en [6], les types utilis\u00e9s pour les diff\u00e9rentes colonnes\u00a0;</li> <li>en [7], on voit que la colonne [id] a l\u2019attribut [AUTO_INCREMENT]. Cela signifie que lors de l\u2019insertion d\u2019une ligne dans la table, si cette ligne n\u2019a pas de valeur pour la colonne [id], celle-ci sera g\u00e9n\u00e9r\u00e9e par MySQL de fa\u00e7on incr\u00e9mentale\u00a0: 1, 2, 3, \u2026 Cette propri\u00e9t\u00e9 nous \u00e9vite de nous pr\u00e9occuper de la valeur de la cl\u00e9 primaire lorsque nous faisons une insertion dans la table\u00a0: nous laissons MySQL la g\u00e9n\u00e9rer\u00a0;</li> <li>en [8], on voit que la colonne [id] est cl\u00e9 primaire\u00a0;</li> <li>en [9], on retrouve la contrainte d\u2019unicit\u00e9 sur les champs [nom, prenom]\u00a0;</li> </ul>"},{"location":"utilisation-de-lorm-sqlalchemy.html#194-scripts-03-manipulation-des-entites-de-la-session-sqlalchemy","title":"19.4. Scripts 03\u00a0: manipulation des entit\u00e9s de la session [sqlalchemy]","text":"<p>Le fichier de configuration [config] est le m\u00eame que dans l\u2019exemple pr\u00e9c\u00e9dent. Dans le script [main] on fait les op\u00e9rations classiques [INSERT, UPDATE, DELETE, SELECT] sur la table [personnes]\u00a0\u00e0 l\u2019aide des m\u00e9thodes de [sqlalchemy]\u00a0:</p> <pre><code># on configure l'application\nimport config\n\nconfig = config.configure()\n\n# imports\nfrom sqlalchemy import func\nfrom sqlalchemy.exc import IntegrityError, DatabaseError, InterfaceError\nfrom sqlalchemy.orm.session import Session\nfrom Personne import Personne\n\n# affiche le contenu de la table [personnes]\ndef affiche_table(session: Session):\n    print(\"----------------\")\n    # une requ\u00eate\n    personnes = session.query(Personne).all()\n    # affichage\n    affiche_personnes(personnes)\n\n# affiche une liste de personnes\ndef affiche_personnes(personnes: list):\n    print(\"----------------\")\n    # affichage\n    for personne in personnes:\n        print(personne)\n\n\n# main ---------------------------\nsession = None\ntry:\n    # une session\n    session = config[\"Session\"]()\n\n    # suppression de la table [personnes]\n    # checkfirst=True : v\u00e9rifie d'abord que la table existe\n    config[\"personnes_table\"].drop(config[\"engine\"], checkfirst=True)\n\n    # recr\u00e9ation de la table \u00e0 partir du mapping\n    config[\"metadata\"].create_all(config[\"engine\"])\n\n    # des insertions\n    session.add(Personne().fromdict({\"pr\u00e9nom\": \"Pierre\", \"nom\": \"Nicazou\", \"\u00e2ge\": 35}))\n    session.add(Personne().fromdict({\"pr\u00e9nom\": \"G\u00e9raldine\", \"nom\": \"Colou\", \"\u00e2ge\": 26}))\n    session.add(Personne().fromdict({\"pr\u00e9nom\": \"Paulette\", \"nom\": \"Girond\u00e9\", \"\u00e2ge\": 56}))\n\n    # on affiche le contenu de la session\n    affiche_table(session)\n\n    # liste des personnes par ordre alphab\u00e9tique des noms et \u00e0 nom \u00e9gal par ordre alphab\u00e9tique des pr\u00e9noms\n    personnes = session.query(Personne).order_by(Personne.nom.desc(), Personne.pr\u00e9nom.desc())\n\n    # affichage\n    affiche_personnes(personnes)\n\n    # liste des personnes ayant un \u00e2ge dans l'intervalle [20,40] par ordre d\u00e9croissant de l'\u00e2ge\n    # puis \u00e0 \u00e2ge \u00e9gal par ordre alphab\u00e9tique des noms et \u00e0 nom \u00e9gal par ordre alphab\u00e9tique des pr\u00e9noms\n    personnes = session.query(Personne). \\\n        filter(Personne.\u00e2ge &gt;= 20, Personne.\u00e2ge &lt;= 40). \\\n        order_by(Personne.\u00e2ge.desc(), Personne.nom.asc(), Personne.pr\u00e9nom.asc())\n\n    # affichage\n    affiche_personnes(personnes)\n\n    # insertion de mme Bruneau\n    bruneau = Personne().fromdict({\"pr\u00e9nom\": \"Josette\", \"nom\": \"Bruneau\", \"\u00e2ge\": 46})\n    session.add(bruneau)\n    # modification de son \u00e2ge\n    bruneau.\u00e2ge = 47\n\n    # liste des personnes ayant Bruneau pour nom\n    personne = session.query(Personne).filter(func.lower(Personne.nom) == \"bruneau\").first()\n\n    # affichage\n    affiche_personnes([personne])\n\n    # suppression de Mme Bruneau\n    session.delete(personne)\n\n    # liste des personnes ayant Bruneau pour nom\n    personnes = session.query(Personne).filter(func.lower(Personne.nom) == \"bruneau\")\n\n    # affichage\n    affiche_personnes(personnes)\n\n    # validation de la session\n    session.commit()\n\nexcept (DatabaseError, InterfaceError, IntegrityError) as erreur:\n    # affichage\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\n    # annulation de la derni\u00e8re session\n    if session:\n        session.rollback()\n\nfinally:\n    # affichage\n    print(\"Travail termin\u00e9...\")\n    # on lib\u00e8re les ressources de la session\n    if session:\n        session.close()\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 20-25\u00a0: la fonction [affiche_personnes] affiche les \u00e9l\u00e9ments d\u2019une liste de personnes\u00a0;</li> <li>lignes 12-18\u00a0: la fonction [affiche_table] affiche le contenu de la table [personnes]\u00a0;</li> <li>lignes 34-36\u00a0: on supprime la table [personnes]. Contrairement aux versions pr\u00e9c\u00e9dentes, on n\u2019utilise pas un ordre SQL mais une m\u00e9thode de [sqlalchemy]\u00a0:</li> <li>config[\"personnes_table\"] est l\u2019objet [Table] d\u00e9crivant la table [personnes]\u00a0;</li> <li>config[\"engine\"] est la cha\u00eene de connexion \u00e0 la base de donn\u00e9es [dbpersonnes]\u00a0;</li> <li>le param\u00e8tre nomm\u00e9 [checkfirst=True] demande \u00e0 ce que l\u2019op\u00e9ration ne se fasse que si la table [personnes] existe\u00a0;</li> <li>lignes 38-39\u00a0: la table [personnes] est recr\u00e9\u00e9e\u00a0;</li> <li>lignes 41-44\u00a0: trois personnes sont mises dans la session. On rappelle qu\u2019elles ne sont pas forc\u00e9ment ins\u00e9r\u00e9es imm\u00e9diatement dans la table [personnes]. Cela d\u00e9pend de la strat\u00e9gie de [sqlalchemy] qui vise la performance\u00a0;</li> <li>lignes 46-47\u00a0: le contenu de la table [personnes] es affich\u00e9. Si les insertions des trois personnes n\u2019avaient pas encore \u00e9t\u00e9 faites elles le sont maintenant \u00e0 cause de cette demande\u00a0;</li> <li>lignes 49-50\u00a0: un exemple d\u2019utilisation de la m\u00e9thode [order_by] qui permet de pr\u00e9senter les r\u00e9sultats d\u2019une requ\u00eate dans un certain ordre. La syntaxe [order_by(crit\u00e8re1, crit\u00e8re2)] affiche les r\u00e9sultats d\u2019abord selon le crit\u00e8re [crit\u00e8re1] et lorsque des lignes pr\u00e9sentent la m\u00eame valeur de [crit\u00e8re1], elles sont alors tri\u00e9es selon le crit\u00e8re [crit\u00e8re2]. On peut mettre plusieurs crit\u00e8res ainsi\u00a0;</li> <li>lignes 55-59\u00a0: introduisent la notion de filtre avec la m\u00e9thode [filter]. La notation [filter(crit\u00e8re1, crit\u00e8re2)] fait un ET logique (AND) entre les crit\u00e8re utilis\u00e9s\u00a0;</li> <li>lignes 64-67\u00a0: une nouvelle personne est mise en session\u00a0;</li> <li>lignes 70-71\u00a0: un autre exemple de requ\u00eate filtr\u00e9e. La fonction [func.lower(param)] rend [param] en minuscules. Il existe ainsi d\u2019autres fonctions disponibles not\u00e9es [func.xx]. Dans l\u2019expression de la ligne 71\u00a0:</li> <li>[session.query.filter] rend une liste\u00a0d\u2019objets [Personne]\u00a0;</li> <li>[session.query.filter.first] rend le 1er \u00e9l\u00e9ment de cette liste\u00a0;</li> <li>ligne 77\u00a0: on supprime un \u00e9l\u00e9ment de la session\u00a0;</li> <li>ligne 86\u00a0: la session est valid\u00e9e\u00a0; Les r\u00e9sultats de l\u2019ex\u00e9cution sont les suivants\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/sqlalchemy/03/main.py\n----------------\n----------------\n{\"\u00e2ge\": 35, \"nom\": \"Nicazou\", \"pr\u00e9nom\": \"Pierre\", \"id\": 1}\n{\"\u00e2ge\": 26, \"nom\": \"Colou\", \"pr\u00e9nom\": \"G\u00e9raldine\", \"id\": 2}\n{\"\u00e2ge\": 56, \"nom\": \"Girond\u00e9\", \"pr\u00e9nom\": \"Paulette\", \"id\": 3}\n----------------\n{\"\u00e2ge\": 35, \"nom\": \"Nicazou\", \"pr\u00e9nom\": \"Pierre\", \"id\": 1}\n{\"\u00e2ge\": 56, \"nom\": \"Girond\u00e9\", \"pr\u00e9nom\": \"Paulette\", \"id\": 3}\n{\"\u00e2ge\": 26, \"nom\": \"Colou\", \"pr\u00e9nom\": \"G\u00e9raldine\", \"id\": 2}\n----------------\n{\"\u00e2ge\": 35, \"nom\": \"Nicazou\", \"pr\u00e9nom\": \"Pierre\", \"id\": 1}\n{\"\u00e2ge\": 26, \"nom\": \"Colou\", \"pr\u00e9nom\": \"G\u00e9raldine\", \"id\": 2}\n----------------\n{\"pr\u00e9nom\": \"Josette\", \"nom\": \"Bruneau\", \"\u00e2ge\": 47, \"id\": 4}\n----------------\nTravail termin\u00e9...\n\nProcess finished with exit code 0\n</code></pre> <ul> <li>lignes 4-6\u00a0: le contenu de la session\u00a0;</li> <li>lignes 8-10\u00a0: le contenu de la session dans l\u2019ordre d\u00e9croissant des noms\u00a0;</li> <li>lignes 12-13\u00a0: le contenu de la session pour les personnes dont l\u2019\u00e2ge est dans l\u2019intervalle [20, 40]\u00a0;</li> <li>ligne 15\u00a0: la personne de nom \u00ab\u00a0bruneau\u00a0\u00bb\u00a0; Dans phpMyAdmin, le contenu de la table [personnes] \u00e0 la fin de l\u2019ex\u00e9cution est le suivant\u00a0:</li> </ul> <p></p>"},{"location":"utilisation-de-lorm-sqlalchemy.html#195-scripts-04-utilisation-dune-base-postgresql","title":"19.5. Scripts 04\u00a0: utilisation d\u2019une base [PostgreSQL]","text":"<p>Le dossier [04] est une copie du dossier [03]. On change une unique chose, la cha\u00eene de connexion dans le fichier [config]\u00a0:</p> <pre><code>    # lien vers une base de donn\u00e9es PostgreSQL\n    engine = create_engine(\"postgresql+psycopg2://admpersonnes:nobody@localhost/dbpersonnes\")\n</code></pre> <p>D\u00e9sormais cette cha\u00eene de connexion d\u00e9signe la base [dbpersonnes] d\u2019un SGBD [PostgreSQL]. On notera l\u2019utilisation du connecteur [psycopg2]. Il faut que celui-ci soit install\u00e9.</p> <p>L\u2019ex\u00e9cution du script [main] donne les r\u00e9sultats suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/sqlalchemy/04/main.py\n----------------\n----------------\n{\"nom\": \"Nicazou\", \"pr\u00e9nom\": \"Pierre\", \"id\": 1, \"\u00e2ge\": 35}\n{\"nom\": \"Colou\", \"pr\u00e9nom\": \"G\u00e9raldine\", \"id\": 2, \"\u00e2ge\": 26}\n{\"nom\": \"Girond\u00e9\", \"pr\u00e9nom\": \"Paulette\", \"id\": 3, \"\u00e2ge\": 56}\n----------------\n{\"nom\": \"Nicazou\", \"pr\u00e9nom\": \"Pierre\", \"id\": 1, \"\u00e2ge\": 35}\n{\"nom\": \"Girond\u00e9\", \"pr\u00e9nom\": \"Paulette\", \"id\": 3, \"\u00e2ge\": 56}\n{\"nom\": \"Colou\", \"pr\u00e9nom\": \"G\u00e9raldine\", \"id\": 2, \"\u00e2ge\": 26}\n----------------\n{\"nom\": \"Nicazou\", \"pr\u00e9nom\": \"Pierre\", \"id\": 1, \"\u00e2ge\": 35}\n{\"nom\": \"Colou\", \"pr\u00e9nom\": \"G\u00e9raldine\", \"id\": 2, \"\u00e2ge\": 26}\n----------------\n{\"pr\u00e9nom\": \"Josette\", \"nom\": \"Bruneau\", \"\u00e2ge\": 47, \"id\": 4}\n----------------\nTravail termin\u00e9...\n\nProcess finished with exit code 0\n</code></pre> <p>Avec l\u2019outil [pgAdmin] (cf. paragraphe |pgAdmin|), la table [personnes] est dans l\u2019\u00e9tat suivant\u00a0:</p> <p></p> <p>La table [personnes] a \u00e9t\u00e9 g\u00e9n\u00e9r\u00e9e avec le code SQL suivant\u00a0:</p> <p></p> <ul> <li>en [4-5], on voit que la colonne [id] est cl\u00e9 primaire. On voit \u00e9galement qu\u2019elle a une valeur par d\u00e9faut [mot cl\u00e9 DEFAULT] qui fait que si on ins\u00e8re une ligne sans cl\u00e9 primaire, celle-ci sera g\u00e9n\u00e9r\u00e9e par le SGBD. C\u2019est un fonctionnement fr\u00e9quent\u00a0: on laisse le SGBD g\u00e9n\u00e9rer les cl\u00e9s primaires\u00a0; Cette version 05 des scripts [sqlalchemy] montre bien la facilit\u00e9 de passer d\u2019un SGBD \u00e0 l\u2019autre\u00a0: il a suffi de changer la cha\u00eene de connexion dans un script de configuration. Rien d\u2019autre n\u2019a chang\u00e9. Si on compare les types des colonnes [id, nom, prenom, age] ci-dessus avec ceux de la table MySQL de l\u2019exemple |02|, on voit qu\u2019ils sont diff\u00e9rents. [sqlalchemy] les adapte au SGBD utilis\u00e9. Cette facilit\u00e9 de s\u2019adapter \u00e0 un nouveau SGBD est une raison suffisante pour adopter [sqlalchemy] ou un autre ORM.</li> </ul>"},{"location":"utilisation-de-lorm-sqlalchemy.html#196-scripts-05-exemple-complet","title":"19.6. Scripts 05\u00a0: exemple complet","text":"<p>L\u2019exemple \u00e9tudi\u00e9 est une reprise de celui \u00e9tudi\u00e9 au paragraphe |troiscouches-v01|. Cet exemple pr\u00e9sentait une architecture \u00e0 trois couches [ui, m\u00e9tier, dao] qui manipulait des entit\u00e9s [Classe, El\u00e8ve, Mati\u00e8re, Note]. Les entit\u00e9s \u00e9taient cod\u00e9es en dur dans une couche [dao]. Nous les mettons maintenant dans une base de donn\u00e9es. Nous utiliserons deux SGBD\u00a0: MySQL et PostgreSQL.</p>"},{"location":"utilisation-de-lorm-sqlalchemy.html#1961-larchitecture-de-lapplication","title":"19.6.1. L\u2019architecture de l\u2019application","text":"<p>L\u2019architecture de l\u2019application sera la suivante\u00a0:</p> <p></p> <ul> <li>en [1-3], on trouve les couches [ui, m\u00e9tier, dao] d\u00e9j\u00e0 pr\u00e9sentes dans l\u2019exemple |troiscouches-v01|. La couche [dao] communique d\u00e9sormais avec la couche [ORM]\u00a0;</li> <li>les couches [1-5] sont impl\u00e9ment\u00e9es par du code Python\u00a0;</li> </ul>"},{"location":"utilisation-de-lorm-sqlalchemy.html#1962-les-bases-de-donnees","title":"19.6.2. Les bases de donn\u00e9es","text":"<p>Nous construisons une base MySQL nomm\u00e9e [dbecole] propri\u00e9t\u00e9 de l\u2019utilisateur [admecole] ayant le mot de passe [mdpecole]. Pour cela nous suivons la proc\u00e9dure d\u00e9crite au paragraphe |cr\u00e9ation d'une base de donn\u00e9es|\u00a0:</p> <p></p> <p></p> <p></p> <ul> <li>en [1], la base [dbecole] sans tables [3]\u00a0;</li> <li>en [7], l\u2019utilisateur [admecole] a tous les privil\u00e8ges sur cette base de donn\u00e9es\u00a0; On fait de m\u00eame avec le SGBD PostgreSQL. Nous construisons une base nomm\u00e9e [dbecole] propri\u00e9t\u00e9 de l\u2019utilisateur [admecole] ayant le mot de passe [mdpecole]. Pour cela nous suivons la proc\u00e9dure d\u00e9crite au paragraphe |cr\u00e9ation d'une base de donn\u00e9es|\u00a0:</li> </ul> <p></p> <ul> <li>en [1], la base [dbecole]\u00a0;</li> <li>en [2], l\u2019utilisateur [admecole]\u00a0;</li> <li>en [3-4], la base [dbecole] est la propri\u00e9t\u00e9 de l\u2019utilisateur [admecole]\u00a0;</li> </ul>"},{"location":"utilisation-de-lorm-sqlalchemy.html#1963-les-entites-manipulees-par-lapplication","title":"19.6.3. Les entit\u00e9s manipul\u00e9es par l\u2019application","text":"<p>Dans l\u2019application |troiscouches v01|, les entit\u00e9s manipul\u00e9es \u00e9taient les suivantes (cf. |entit\u00e9s|). Ce sont ces entit\u00e9s qui vont \u00eatre stock\u00e9es dans les bases de donn\u00e9es pr\u00e9c\u00e9dentes. Nous ne dupliquerons pas ces entit\u00e9s dans la nouvelle application. Nous irons les chercher l\u00e0 o\u00f9 elles sont d\u00e9j\u00e0 d\u00e9finies.</p> <p>La classe [Classe]\u00a0:</p> <pre><code># imports\nfrom BaseEntity import BaseEntity\nfrom MyException import MyException\nfrom Utils import Utils\n\n\nclass Classe(BaseEntity):\n    # attributs exclus de l'\u00e9tat de la classe\n    excluded_keys = []\n\n    # propri\u00e9t\u00e9s de la classe\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        # id : identifiant de la classe\n        # nom : nom de la classe\n        return BaseEntity.get_allowed_keys() + [\"nom\"]\n\n    # getter\n    @property\n    def nom(self: object) -&gt; str:\n        return self.__nom\n\n    #  setters\n    @nom.setter\n    def nom(self: object, nom: str):\n        # nom doit \u00eatre une cha\u00eene de caract\u00e8res non vide\n        if Utils.is_string_ok(nom):\n            self.__nom = nom\n        else:\n            raise MyException(11, f\"Le nom de la classe {self.id} doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\n</code></pre> <p>La classe [El\u00e8ve]\u00a0:</p> <pre><code># imports\nfrom BaseEntity import BaseEntity\nfrom Classe import Classe\nfrom MyException import MyException\n\nfrom Utils import Utils\n\n\nclass El\u00e8ve(BaseEntity):\n    # attributs exclus de l'\u00e9tat de la classe\n    excluded_keys = []\n\n    # propri\u00e9t\u00e9s de la classe\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        # id : identifiant de l'\u00e9l\u00e8ve\n        # nom : nom de l'\u00e9l\u00e8ve\n        # pr\u00e9nom : pr\u00e9nom de l'\u00e9l\u00e8ve\n        # classe : classe de l'\u00e9l\u00e8ve\n        return BaseEntity.get_allowed_keys() + [\"nom\", \"pr\u00e9nom\", \"classe\"]\n\n    # getters\n    @property\n    def nom(self: object) -&gt; str:\n        return self.__nom\n\n    @property\n    def pr\u00e9nom(self: object) -&gt; str:\n        return self.__pr\u00e9nom\n\n    @property\n    def classe(self: object) -&gt; Classe:\n        return self.__classe\n\n    #  setters\n    @nom.setter\n    def nom(self: object, nom: str) -&gt; str:\n        # nom doit \u00eatre une cha\u00eene de caract\u00e8res non vide\n        if Utils.is_string_ok(nom):\n            self.__nom = nom\n        else:\n            raise MyException(41, f\"Le nom de l'\u00e9l\u00e8ve {self.id} doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\n\n    @pr\u00e9nom.setter\n    def pr\u00e9nom(self: object, pr\u00e9nom: str) -&gt; str:\n        # pr\u00e9nom doit \u00eatre une cha\u00eene de caract\u00e8res non vide\n        if Utils.is_string_ok(pr\u00e9nom):\n            self.__pr\u00e9nom = pr\u00e9nom\n        else:\n            raise MyException(42, f\"Le pr\u00e9nom de l'\u00e9l\u00e8ve {self.id} doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\n\n    @classe.setter\n    def classe(self: object, value):\n        try:\n            # on attend un type Classe\n            if isinstance(value, Classe):\n                self.__classe = value\n            # ou un type dict\n            elif isinstance(value,dict):\n                self.__classe=Classe().fromdict(value)\n            # ou un type json\n            elif isinstance(value,str):\n                self.__classe = Classe().fromjson(value)\n        except BaseException as erreur:\n            raise MyException(43, f\"L'attribut [{value}] de l'\u00e9l\u00e8ve {self.id} doit \u00eatre de type Classe ou dict ou json. Erreur : {erreur}\")\n</code></pre> <p>La classe [Mati\u00e8re]\u00a0:</p> <pre><code># imports\nfrom BaseEntity import BaseEntity\nfrom MyException import MyException\nfrom Utils import Utils\n\n\nclass Mati\u00e8re(BaseEntity):\n    # attributs exclus de l'\u00e9tat de la classe\n    excluded_keys = []\n\n    # propri\u00e9t\u00e9s de la classe\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        # id : identifiant de la mati\u00e8re\n        # nom : nom de la mati\u00e8re\n        # coefficient : coefficient de la mati\u00e8re\n        return BaseEntity.get_allowed_keys() + [\"nom\", \"coefficient\"]\n\n    # getter\n    @property\n    def nom(self: object) -&gt; str:\n        return self.__nom\n\n    @property\n    def coefficient(self: object) -&gt; float:\n        return self.__coefficient\n\n    #  setters\n    @nom.setter\n    def nom(self: object, nom: str):\n        # nom doit \u00eatre une cha\u00eene de caract\u00e8res non vide\n        if Utils.is_string_ok(nom):\n            self.__nom = nom\n        else:\n            raise MyException(21, f\"Le nom de la mati\u00e8re {self.id} doit \u00eatre une cha\u00eene de caract\u00e8res non vide\")\n\n    @coefficient.setter\n    def coefficient(self, coefficient: float):\n        # le coefficient doit \u00eatre un r\u00e9el &gt;=0\n        erreur = False\n        if isinstance(coefficient, (int, float)):\n            if coefficient &gt;= 0:\n                self.__coefficient = coefficient\n            else:\n                erreur = True\n        else:\n            erreur = True\n        # erreur ?\n        if erreur:\n            raise MyException(22, f\"Le coefficient de la mati\u00e8re {self.nom} doit \u00eatre un r\u00e9el &gt;=0\")\n</code></pre> <p>La classe [Note]\u00a0:</p> <pre><code># imports\nfrom BaseEntity import BaseEntity\nfrom El\u00e8ve import El\u00e8ve\nfrom Mati\u00e8re import Mati\u00e8re\nfrom MyException import MyException\n\n\nclass Note(BaseEntity):\n    # attributs exclus de l'\u00e9tat de la classe\n    excluded_keys = []\n\n    # propri\u00e9t\u00e9s de la classe\n    @staticmethod\n    def get_allowed_keys() -&gt; list:\n        # id : identifiant de la note\n        # valeur : la note elle-m\u00eame\n        # \u00e9l\u00e8ve : \u00e9l\u00e8ve (de type El\u00e8ve) concern\u00e9 par la note\n        # mati\u00e8re : mati\u00e8re (de type Mati\u00e8re) concern\u00e9e par la note\n        # l'objet Note est donc la note d'un \u00e9l\u00e8ve dans une mati\u00e8re\n        return BaseEntity.get_allowed_keys() + [\"valeur\", \"\u00e9l\u00e8ve\", \"mati\u00e8re\"]\n\n    # getters\n    @property\n    def valeur(self: object) -&gt; float:\n        return self.__valeur\n\n    @property\n    def \u00e9l\u00e8ve(self: object) -&gt; El\u00e8ve:\n        return self.__\u00e9l\u00e8ve\n\n    @property\n    def mati\u00e8re(self: object) -&gt; Mati\u00e8re:\n        return self.__mati\u00e8re\n\n    # getters\n    @valeur.setter\n    def valeur(self: object, valeur: float):\n        # la note doit \u00eatre un r\u00e9el entre 0 et 20\n        if isinstance(valeur, (int, float)) and 0 &lt;= valeur &lt;= 20:\n            self.__valeur = valeur\n        else:\n            raise MyException(31,\n                f\"L'attribut {valeur} de la note {self.id} doit \u00eatre un nombre dans l'intervalle [0,20]\")\n\n    @\u00e9l\u00e8ve.setter\n    def \u00e9l\u00e8ve(self: object, value):\n        try:\n            # on attend un type El\u00e8ve\n            if isinstance(value, El\u00e8ve):\n                self.__\u00e9l\u00e8ve = value\n            # ou un type dict\n            elif isinstance(value, dict):\n                self.__\u00e9l\u00e8ve = El\u00e8ve().fromdict(value)\n            # ou un type json\n            elif isinstance(value, str):\n                self.__\u00e9l\u00e8ve = El\u00e8ve().fromjson(value)\n        except BaseException as erreur:\n            raise MyException(32,\n                f\"L'attribut [{value}] de la note {self.id} doit \u00eatre de type El\u00e8ve ou dict ou json. Erreur : {erreur}\")\n\n    @mati\u00e8re.setter\n    def mati\u00e8re(self: object, value):\n        try:\n            # on attend un type Mati\u00e8re\n            if isinstance(value, Mati\u00e8re):\n                self.__mati\u00e8re = value\n            # ou un type dict\n            elif isinstance(value, dict):\n                self.__mati\u00e8re = Mati\u00e8re().fromdict(value)\n            # ou un type json\n            elif isinstance(value, str):\n                self.__mati\u00e8re = Mati\u00e8re().fromjson(value)\n        except BaseException as erreur:\n            raise MyException(33,\n                f\"L'attribut [{value}] de la note {self.id} doit \u00eatre de type Mati\u00e8re ou dict ou json. Erreur : {erreur}\")\n</code></pre>"},{"location":"utilisation-de-lorm-sqlalchemy.html#1964-configuration","title":"19.6.4. Configuration","text":"<p>La configuration a \u00e9t\u00e9 \u00e9clat\u00e9e sur plusieurs fichiers\u00a0:</p> <ul> <li>la configuration g\u00e9n\u00e9rale dans [config.py] : elle \u00e9tablit le Python Path de l\u2019application et instancie les couches de l\u2019architecture\u00a0;</li> <li>la configuration de [sqlalchemy] dans [config_database] : elle fait les mappings Classes / Tables\u00a0;</li> <li>les couches de l\u2019application sont configur\u00e9es dans [config_layers]\u00a0; Le fichier [config] est le suivant\u00a0:</li> </ul> <pre><code>def\u00a0configure(config:\u00a0dict)\u00a0-&gt;\u00a0dict:\n\u00a0\u00a0\u00a0\u00a0import\u00a0os\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a01\u00a0---\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0\u00e9tablit\u00a0le\u00a0Python\u00a0Path\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0absolu\u00a0du\u00a0dossier\u00a0de\u00a0ce\u00a0script\n\u00a0\u00a0\u00a0\u00a0script_dir\u00a0=\u00a0os.path.dirname(os.path.abspath(__file__))\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemin\u00a0absolu\u00a0r\u00e9f\u00e9rence\u00a0des\u00a0chemins\u00a0relatifs\u00a0de\u00a0la\u00a0configuration\n\u00a0\u00a0\u00a0\u00a0root_dir\u00a0=\u00a0\"C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020\"\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0chemins\u00a0absolus\u00a0des\u00a0d\u00e9pendances\n\u00a0\u00a0\u00a0\u00a0absolute_dependencies\u00a0=\u00a0[\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0BaseEntity,\u00a0MyException\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/classes/02/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0projet\u00a0troiscouches\u00a0v01\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/troiscouches/v01/interfaces\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/troiscouches/v01/services\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{root_dir}/troiscouches/v01/entities\",\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0#\u00a0dossiers\u00a0du\u00a0pr\u00e9sent\u00a0projet\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0script_dir,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0f\"{script_dir}/../services\",\n\u00a0\u00a0\u00a0\u00a0]\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0mise\u00a0\u00e0\u00a0jour\u00a0du\u00a0syspath\n\u00a0\u00a0\u00a0\u00a0from\u00a0myutils\u00a0import\u00a0set_syspath\n\u00a0\u00a0\u00a0\u00a0set_syspath(absolute_dependencies)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a02\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0configuration\u00a0base\u00a0de\u00a0donn\u00e9es\n\u00a0\u00a0\u00a0\u00a0import\u00a0config_database\n\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0config_database.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0\u00e9tape\u00a03\u00a0------\n\u00a0\u00a0\u00a0\u00a0#\u00a0instanciation\u00a0des\u00a0couches\u00a0de\u00a0l'application\n\u00a0\u00a0\u00a0\u00a0import\u00a0config_layers\n\u00a0\u00a0\u00a0\u00a0config\u00a0=\u00a0config_layers.configure(config)\n\n\u00a0\u00a0\u00a0\u00a0#\u00a0on\u00a0rend\u00a0la\u00a0config\n\u00a0\u00a0\u00a0\u00a0return\u00a0config\n</code></pre> <ul> <li>lignes 4-27\u00a0: construction du Python Path de l\u2019application\u00a0;</li> <li>lignes 29-32\u00a0: configuration [sqlalchemy]\u00a0;</li> <li>lignes 34-37\u00a0: configuration des couches de l\u2019application\u00a0; Le fichier [config_database] est le suivant\u00a0:</li> </ul> <pre><code>def configure(config: dict) -&gt; dict:\n    # config['sgbd'] est le nom du SGBD utilis\u00e9\n    # mysql : MySQL\n    # pgres : PostgreSQL\n\n    # configuration sqlalchemy\n    from sqlalchemy import Table, Column, Integer, MetaData, String, Float, ForeignKey, create_engine\n\n    from sqlalchemy.orm import mapper, relationship, sessionmaker\n\n    # cha\u00eenes de connexion aux bases de donn\u00e9es exploit\u00e9es\n    engines = {\n        'mysql': \"mysql+mysqlconnector://admecole:mdpecole@localhost/dbecole\",\n        'pgres': \"postgresql+psycopg2://admecole:mdpecole@localhost/dbecole\"\n    }\n    # cha\u00eene de connexion \u00e0 la base de donn\u00e9es exploit\u00e9e\n    engine = create_engine(engines[config['sgbd']])\n\n    # metadata\n    metadata = MetaData()\n\n    # les tables de la base\n    tables = {}\n    # les classes mapp\u00e9es\n    from Classe import Classe\n    from El\u00e8ve import El\u00e8ve\n    from Note import Note\n    from Mati\u00e8re import Mati\u00e8re\n\n    # la table des classes\n    tables['classes'] = classes_table = \\\n        Table(\"classes\", metadata,\n              Column('id', Integer, primary_key=True),\n              Column('nom', String(30), nullable=False),\n              )\n\n    mapper(Classe, tables['classes'], properties={\n        'id': classes_table.c.id,\n        'nom': classes_table.c.nom\n    })\n\n    # la table des \u00e9l\u00e8ves\n    tables['\u00e9l\u00e8ves'] = \u00e9l\u00e8ves_table = \\\n        Table(\"\u00e9l\u00e8ves\", metadata,\n              Column('id', Integer, primary_key=True),\n              Column('nom', String(30), nullable=False),\n              Column('pr\u00e9nom', String(30), nullable=False),\n              # un \u00e9l\u00e8ve appartient \u00e0 une classe\n              Column('classe_id', Integer, ForeignKey('classes.id')),\n              )\n    # mapping\n    mapper(El\u00e8ve, tables['\u00e9l\u00e8ves'], properties={\n        'id': \u00e9l\u00e8ves_table.c.id,\n        'nom': \u00e9l\u00e8ves_table.c.nom,\n        'pr\u00e9nom': \u00e9l\u00e8ves_table.c.pr\u00e9nom,\n        'classe': relationship(Classe, backref=\"\u00e9l\u00e8ves\", lazy=\"select\")\n    })\n\n    # la table des mati\u00e8res\n    tables['mati\u00e8res'] = mati\u00e8res_table = \\\n        Table(\"mati\u00e8res\", metadata,\n              Column('id', Integer, primary_key=True),\n              Column('nom', String(30), nullable=False),\n              Column('coefficient', Float, nullable=False)\n              )\n    # mapping\n    mapper(Mati\u00e8re, tables['mati\u00e8res'], properties={\n        'id': mati\u00e8res_table.c.id,\n        'nom': mati\u00e8res_table.c.nom,\n        \"coefficient\": mati\u00e8res_table.c.coefficient\n    })\n\n    # la table des notes\n    tables['notes'] = notes_table = \\\n        Table(\"notes\", metadata,\n              Column('id', Integer, primary_key=True),\n              Column('valeur', Float, nullable=False),\n              # une note est celle d'un \u00e9l\u00e8ve\n              Column('\u00e9l\u00e8ve_id', Integer, ForeignKey('\u00e9l\u00e8ves.id')),\n              # une note est celle d'une mati\u00e8re\n              Column('mati\u00e8re_id', Integer, ForeignKey('mati\u00e8res.id')),\n              )\n\n    # mapping\n    mapper(Note, tables['notes'], properties={\n        'id': notes_table.c.id,\n        'valeur': notes_table.c.valeur,\n        '\u00e9l\u00e8ve': relationship(El\u00e8ve, backref=\"notes\", lazy=\"select\"),\n        'mati\u00e8re': relationship(Mati\u00e8re, backref=\"notes\", lazy=\"select\")\n    })\n\n    # configuration des entit\u00e9s [BaseEntity]\n    El\u00e8ve.excluded_keys = ['_sa_instance_state', 'notes', 'classe']\n    Classe.excluded_keys = ['_sa_instance_state', '\u00e9l\u00e8ves']\n    Mati\u00e8re.excluded_keys = ['_sa_instance_state', 'notes']\n    Note.excluded_keys = ['_sa_instance_state', 'mati\u00e8re', '\u00e9l\u00e8ve']\n\n    # la session factory\n    Session = sessionmaker()\n    Session.configure(bind=engine)\n\n    # une session\n    session = Session()\n\n    # on enregistre certaines informations dans le dictionnaire de la configuration\n    config['database'] = {\"engine\": engine, \"metadata\": metadata, \"tables\": tables, \"session\": session}\n\n    # on rend la config\n    return config\n</code></pre> <p>Commentaires</p> <ul> <li>lignes 1-4\u00a0: la fonction [configure] re\u00e7oit un dictionnaire en param\u00e8tre. Seule la cl\u00e9 [sgbd] est exploit\u00e9e. Elle vaut [mysql] si la base est une base MySQL, [pgres] si la base est une base PostgreSQL\u00a0;</li> <li>lignes 6-9\u00a0: imports d\u2019\u00e9l\u00e9ments de [sqlalchemy]. Le script [config_database] fait les mappings entre les tables de la base [dbecole] et les entit\u00e9s [Classes, El\u00e8ve, Mati\u00e8re, Note]. Dans la table, les donn\u00e9es de l\u2019entit\u00e9 sont encapsul\u00e9es dans une ligne. Dans le code Python, elles sont encapsul\u00e9es dans un objet. D\u2019o\u00f9 le nom ORM (Object Relational Mapper)\u00a0: l\u2019ORM fait un mapping (une liaison) entre les lignes d\u2019une base de donn\u00e9es relationnelle et des objets. Dans cette application, nous avons quatre entit\u00e9s [Classe, El\u00e8ve, Mati\u00e8re, Note] qui seront reli\u00e9es \u00e0 quatre tables [classes, \u00e9l\u00e8ves, mati\u00e8res, notes]. Notez que les noms des tables peuvent comporter des caract\u00e8res accentu\u00e9s\u00a0;</li> <li>lignes 11-17\u00a0: la cha\u00eene de connexion \u00e0 la base de donn\u00e9es exploit\u00e9e. Celle-ci d\u00e9pend de l\u2019\u00e9l\u00e9ment config[\u2018sgbd\u2019]\u00a0;</li> <li>lignes 24-28\u00a0: les entit\u00e9s de l\u2019application qui vont faire l\u2019objet d\u2019un mapping [sqlalchemy]. Lorsque ces lignes seront ex\u00e9cut\u00e9es, le Python Path aura d\u00e9j\u00e0 \u00e9t\u00e9 \u00e9tabli par le script [config]\u00a0;</li> <li>lignes 30-40\u00a0: le mapping entre l\u2019entit\u00e9 [Classe] et la table [classes]\u00a0;</li> <li>lignes 30-35\u00a0: la table [classes] est d\u00e9finie avec la classe [Table] de [sqlalchemy]. Nous indiquons que cette table a deux colonnes\u00a0:</li> <li>la colonne [id] qui est cl\u00e9 primaire\u00a0et qui est le n\u00b0 de la classe, ligne 33\u00a0;</li> <li>la colonne [nom] qui contient le nom de la classe, ligne 34\u00a0;</li> <li>lignes 31-32\u00a0: notez que la syntaxe x=y=z est l\u00e9gale en Python\u00a0: la valeur de z est affect\u00e9e \u00e0 y puis la valeur de y \u00e0 x\u00a0;</li> <li>lignes 37-40\u00a0: on liste les correspondances entre les colonnes de la table [classes] et les propri\u00e9t\u00e9s de l\u2019entit\u00e9 [Classe]\u00a0;</li> <li>lignes 42-57\u00a0: le mapping entre l\u2019entit\u00e9 [El\u00e8ve] et la table [\u00e9l\u00e8ves]\u00a0;</li> <li>lignes 51-57\u00a0: la table [\u00e9l\u00e8ves] est d\u00e9finie avec la classe [Table] de [sqlalchemy]. Nous indiquons que cette table a quatre colonnes\u00a0:</li> <li>la colonne [id] qui est cl\u00e9 primaire\u00a0et qui est le n\u00b0 de l\u2019\u00e9l\u00e8ve, ligne 45\u00a0;</li> <li>la colonne [nom] qui contient le nom de l\u2019\u00e9l\u00e8ve, ligne 46\u00a0;</li> <li>la colonne [pr\u00e9nom] qui contient le pr\u00e9nom de l\u2019\u00e9l\u00e8ve, ligne 47. Notez qu\u2019un nom de colonne peut comporter des caract\u00e8res accentu\u00e9s\u00a0;</li> <li>ligne 49, la colonne [classe_id] qui contiendra le n\u00b0 de la classe \u00e0 laquelle appartient l\u2019\u00e9l\u00e8ve. On appelle cela une cl\u00e9 \u00e9trang\u00e8re. [\u00e9l\u00e8ves.classe_id] est une cl\u00e9 \u00e9trang\u00e8re (ForeignKey) sur la colonne [classes.id]. Cela signifie que la valeur de [\u00e9l\u00e8ves.classe_id] doit exister dans la colonne [classes.id]\u00a0;</li> <li>lignes 51-57\u00a0: on liste les correspondances entre les colonnes de la table [\u00e9l\u00e8ves] et les propri\u00e9t\u00e9s de l\u2019entit\u00e9 [El\u00e8ve]\u00a0:</li> <li>les lignes 53-55 sont simples \u00e0 comprendre\u00a0;</li> <li>la ligne 56\u00a0est plus difficile\u00a0: elle d\u00e9finit la valeur de la propri\u00e9t\u00e9 [El\u00e8ve.classe] comme \u00e9tant calcul\u00e9e par la relation (relationship) de cl\u00e9 \u00e9trang\u00e8re qui relie les tables [\u00e9l\u00e8ves] et [classes]. Les param\u00e8tres de la fonction [relationship] sont les suivants\u00a0:</li> <li>[Classe]\u00a0: c\u2019est le nom de l\u2019entit\u00e9 avec laquelle l\u2019entit\u00e9 [El\u00e8ve] a une relation de cl\u00e9 \u00e9trang\u00e8re. Celle-ci doit se mat\u00e9rialiser dans la table [\u00e9l\u00e8ves] par la pr\u00e9sence d\u2019une cl\u00e9 \u00e9trang\u00e8re sur la table [classes]. Nous savons que celle-ci existe\u00a0;</li> <li>[backref=\"\u00e9l\u00e8ves\"]\u00a0: le nom d\u2019une propri\u00e9t\u00e9 qui sera ajout\u00e9e \u00e0 l\u2019entit\u00e9 [Classe]. [Classe.\u00e9l\u00e8ves] sera la liste de tous les \u00e9l\u00e8ves de la classe. Cette propri\u00e9t\u00e9 ne doit pas d\u00e9j\u00e0 exister. Si elle existe d\u00e9j\u00e0, il faut simplement choisir un autre nom ici pour [backref]. Le d\u00e9veloppeur n\u2019a pas \u00e0 g\u00e9rer cette propri\u00e9t\u00e9. C\u2019est [sqlalchemy] qui le fera. Il doit simplement savoir qu\u2019elle existe, ajout\u00e9e par [sqlalchemy], et qu\u2019il peut l\u2019utiliser\u00a0dans son code\u00a0;</li> <li>[lazy=\u2019select\u2019]\u00a0: cela signifie que l\u2019ORM ne doit pas chercher \u00e0 donner imm\u00e9diatement une valeur \u00e0 la propri\u00e9t\u00e9 [El\u00e8ve.classe]. Il ne doit chercher sa valeur que lorsque le code la demande explicitement. Ainsi\u00a0:</li> <li>si le code demande la liste de tous les \u00e9l\u00e8ves, ceux-ci seront ramen\u00e9s mais leur propri\u00e9t\u00e9 [classe] ne sera pas calcul\u00e9e\u00a0;</li> <li>un peu plus tard, le code s\u2019int\u00e9resse \u00e0 un \u00e9l\u00e8ve [e] pr\u00e9cis et r\u00e9f\u00e9rence sa classe [e.classe]. Cette r\u00e9f\u00e9rence va alors forcer [sqlalchemy] \u00e0 faire une requ\u00eate en base pour ramener la classe de l\u2019\u00e9l\u00e8ve, ceci de fa\u00e7on transparente pour le d\u00e9veloppeur\u00a0;</li> <li>aussi mettre [lazy=\u2019select\u2019] vise \u00e0 \u00e9viter les requ\u00eates inutiles en base\u00a0;</li> <li>ligne 56\u00a0: lorsque l\u2019ORM r\u00e9cup\u00e8re une ligne de la table [\u00e9l\u00e8ves], il r\u00e9cup\u00e8re les informations [id, nom, pr\u00e9nom, classe_id]. A partir de l\u00e0, il doit construire un objet El\u00e8ve(id, nom, pr\u00e9nom, classe). Pour les propri\u00e9t\u00e9s [id, nom, pr\u00e9nom] \u00e7a ne pose pas de difficult\u00e9s. Pour la propri\u00e9t\u00e9 [classe], c\u2019est plus compliqu\u00e9. Sa valeur est une r\u00e9f\u00e9rence d\u2019objet de type [Classe]. Or l\u2019ORM ne dispose que d\u2019une information [\u00e9l\u00e8ves.classe_id]. Comme [\u00e9l\u00e8ves.classe_id] est une cl\u00e9 \u00e9trang\u00e8re sur la colonne [classes.id], on lui dit ici d\u2019utiliser cette relation pour r\u00e9cup\u00e9rer dans la table [classes] la ligne de n\u00b0 id=[\u00e9l\u00e8ves.classe_id] (elle existe forc\u00e9ment) et de cr\u00e9er \u00e0 partir de cette ligne l\u2019objet [Classe] attendu par la propri\u00e9t\u00e9 [El\u00e8ve.classe]\u00a0;</li> <li>lignes 59-71\u00a0: le mapping entre l\u2019entit\u00e9 [Mati\u00e8re] et la table [mati\u00e8res]\u00a0;</li> <li>lignes 59-65\u00a0: d\u00e9finition de la table [sqlalchemy] nomm\u00e9e [mati\u00e8res]\u00a0;</li> <li>lignes 66-71\u00a0: on liste les correspondances entre les colonnes de la table [mati\u00e8res] et les propri\u00e9t\u00e9s de l\u2019entit\u00e9 [Mati\u00e8re]. Il n\u2019y a pas de difficult\u00e9s ici\u00a0;</li> <li>lignes 73-90\u00a0: le mapping entre l\u2019entit\u00e9 [Note] et la table [notes]\u00a0;</li> <li>lignes 73-82\u00a0: d\u00e9finition de la table [sqlalchemy] nomm\u00e9e [notes]. Elle a deux cl\u00e9s \u00e9trang\u00e8res\u00a0:</li> <li>ligne 79, la colonne [notes.\u00e9l\u00e8ve_id] prend ses valeurs dans la colonne [\u00e9l\u00e8ves.id] ]. Cette cl\u00e9 \u00e9trang\u00e8re mat\u00e9rialise le fait qu\u2019une note est la note d\u2019un \u00e9l\u00e8ve pr\u00e9cis\u00a0;</li> <li>ligne 81, la colonne [notes.mati\u00e8re_id] prend ses valeurs dans la colonne [mati\u00e8res.id]. Cette cl\u00e9 \u00e9trang\u00e8re mat\u00e9rialise le fait qu\u2019une note est une note dans une mati\u00e8re pr\u00e9cise\u00a0;</li> <li>lignes 84-90\u00a0: le mapping entre l\u2019entit\u00e9 [Note] et la table [notes]\u00a0:</li> <li>ligne 88\u00a0: la propri\u00e9t\u00e9 [Note.\u00e9l\u00e8ve] doit avoir pour valeur une instance de type [El\u00e8ve]. L\u2019ORM n\u2019a pour information dans la ligne de la table [notes] que la colonne [notes.\u00e9l\u00e8ve_id] qui r\u00e9f\u00e9rence la colonne [\u00e9l\u00e8ves.id]. On dit ici d\u2019utiliser cette relation de cl\u00e9 \u00e9trang\u00e8re pour retrouver l\u2019intance [El\u00e8ve] dont on a la note. Par ailleurs [relationship(El\u00e8ve, backref=\"notes\", \u2026)] va cr\u00e9er la nouvelle propri\u00e9t\u00e9 [El\u00e8ve.notes] qui sera la liste des notes de l\u2019\u00e9l\u00e8ve. Cette propri\u00e9t\u00e9 ne doit pas d\u00e9j\u00e0 exister dans la classe [El\u00e8ve]\u00a0;</li> <li>ligne 89\u00a0: la propri\u00e9t\u00e9 [Note.mati\u00e8re] doit avoir pour valeur une instance de type [Mati\u00e8re]. L\u2019ORM n\u2019a pour information dans la ligne de la table [notes] que la colonne [notes.mati\u00e8re_id] qui r\u00e9f\u00e9rence la colonne [mati\u00e8res.id]. On dit ici d\u2019utiliser cette relation de cl\u00e9 \u00e9trang\u00e8re pour retrouver l\u2019intance [Mati\u00e8re] dont on a la note. Par ailleurs [relationship(Mati\u00e8re, backref=\"notes\", \u2026)] va cr\u00e9er la nouvelle propri\u00e9t\u00e9 [Mati\u00e8re.notes] qui sera la liste des notes dans la mati\u00e8re. Cette propri\u00e9t\u00e9 ne doit pas d\u00e9j\u00e0 exister dans la classe [Mati\u00e8re]\u00a0;</li> <li>lignes 92-96\u00a0: on d\u00e9finit pour chaque entit\u00e9 d\u00e9riv\u00e9e de [BaseEntity] la liste des propri\u00e9t\u00e9s \u00e0 exclure du dictionnaire des propri\u00e9t\u00e9s de l\u2019entit\u00e9 (BaseEntity.asdict). Nous avons vu que [sqlalchemy] ajoutait la propri\u00e9t\u00e9 [_sa_instance_state] \u00e0 toutes entit\u00e9s mapp\u00e9es. On ne la veut pas dans le dictionnaire des propri\u00e9t\u00e9s. Par ailleurs on a vu que les mappings pr\u00e9c\u00e9dents avaient ajout\u00e9 de nouvelles propri\u00e9t\u00e9s aux entit\u00e9s\u00a0:</li> <li>[El\u00e8ve.notes]\u00a0: toutes les notes de l\u2019\u00e9l\u00e8ve\u00a0;</li> <li>[Classe.\u00e9l\u00e8ves]\u00a0: tous les \u00e9l\u00e8ves de la classe\u00a0;</li> <li> <p>[Mati\u00e8re.notes]\u00a0: toutes les notes de la mati\u00e8re\u00a0; En g\u00e9n\u00e9ral, on ve veut pas ces propri\u00e9t\u00e9s ajout\u00e9es dans l\u2019\u00e9tat de l\u2019entit\u00e9. En effet, calculer leur valeur a un co\u00fbt SQL et cette valeur est souvent inutile. Ainsi si on r\u00e9cup\u00e8re l\u2019\u00e9l\u00e8ve de nom \u2018X\u2019\u00a0:</p> </li> <li> <p>l\u2019ORM va ramener une entit\u00e9 [El\u00e8ve(id, nom, pr\u00e9nom, classe, notes)]. A cause de [lazy=\u2019select\u2019], les propri\u00e9t\u00e9s [classe, notes] li\u00e9es \u00e0 des cl\u00e9s \u00e9trang\u00e8res de la base n\u2019auront pas \u00e9t\u00e9 calcul\u00e9es\u00a0;</p> </li> <li>maintenant si j\u2019affiche la cha\u00eene jSON de cet \u00e9l\u00e8ve, on sait que ce sera la cha\u00eene jSON du dictionnaire [asdict] de l\u2019entit\u00e9. Si les propri\u00e9t\u00e9s [classe] et [notes] sont dedans, [sqlalchemy] va \u00eatre oblig\u00e9 de faire des requ\u00eates SQL pour calculer leurs valeurs. C\u2019est co\u00fbteux. Si on peut \u00e9viter ces requ\u00eates, c\u2019est pr\u00e9f\u00e9rable\u00a0;</li> <li>ici, nous avons exclu toutes les propri\u00e9t\u00e9s li\u00e9es \u00e0 une cl\u00e9 \u00e9trang\u00e8re\u00a0;</li> <li>lignes 98-100\u00a0: instanciation et configuration d\u2019une [Session factory] (factory=usine de production). L\u2019objet [Session] sert \u00e0 cr\u00e9er des sessions [sqlalchemy] adoss\u00e9es \u00e0 des transactions\u00a0;</li> <li>lignes 102-103\u00a0: cr\u00e9ation d\u2019une session sqlalchemy]\u00a0;</li> <li>ligne 106\u00a0: certains \u00e9l\u00e9ments de la configuration [sqlalchemy] sont mis dans le dictionnaire global de la configuration de l\u2019application\u00a0;</li> <li>ligne 109\u00a0: on rend ce dictionnaire\u00a0; Le fichier [config_layers] configure les couches de l\u2019application\u00a0:</li> </ul> <pre><code>def configure(config: dict) -&gt; dict:\n    # instanciation couche [dao]\n    from DatabaseDao import DatabaseDao\n    dao = DatabaseDao(config)\n\n    # instanciation de la couche [m\u00e9tier]\n    from M\u00e9tier import M\u00e9tier\n    m\u00e9tier = M\u00e9tier(dao)\n\n    # instanciation de la couche [ui]\n    from Console import Console\n    ui = Console(m\u00e9tier)\n\n    # on met les couches dans la config\n    config['dao'] = dao\n    config['m\u00e9tier'] = m\u00e9tier\n    config['ui'] = ui\n\n    # on rend la config\n    return config\n</code></pre> <ul> <li>ligne 1\u00a0: la fonction [configure] re\u00e7oit le dictionnaire de la configuration globale de l\u2019application\u00a0;</li> <li>lignes 2-12\u00a0: les couches de l\u2019application sont instanci\u00e9es\u00a0;</li> <li>lignes 15-17\u00a0: les r\u00e9f\u00e9rences des couches sont mises dans la configuration globale\u00a0;</li> <li>ligne 20\u00a0: on rend la nouvelle configuration\u00a0;</li> </ul>"},{"location":"utilisation-de-lorm-sqlalchemy.html#1965-la-couche-dao-1","title":"19.6.5. La couche [dao] - 1","text":"<p>Il faut comprendre ici que la couche [dao] [3] communique avec l\u2019ORM [sqlalchemy] [4] configur\u00e9 comme il a \u00e9t\u00e9 d\u00e9crit dans le paragraphe pr\u00e9c\u00e9dent. Des trois couches [ui, m\u00e9tier, dao] de l\u2019application |troiscouches v01|, seule la couche [dao] doit \u00eatre r\u00e9\u00e9crite. Les couches [ui, m\u00e9tier] sont conserv\u00e9es.</p> <p>L\u2019impl\u00e9mentation de la couche [dao] a \u00e9t\u00e9 plac\u00e9e dans le dossier [services]\u00a0:</p> <p></p> <p>[InterfaceDatabaseDao] est l\u2019interface de la couche [dao]\u00a0:</p> <pre><code>from abc import ABC, abstractmethod\n\nfrom InterfaceDao import InterfaceDao\n\n\nclass InterfaceDatabaseDao(InterfaceDao, ABC):\n\n    # initialisation de la base de donn\u00e9es\n    @abstractmethod\n    def init_database(self, data: dict):\n        pass\n</code></pre> <ul> <li>ligne 6\u00a0: l\u2019interface [InterfaceDatabaseDao] d\u00e9rive \u00e0 la fois de la classe [ABC] pour \u00eatre une classe abstraite et de l\u2019interface [InterfaceDao] du projet |troiscouches v01|\u00a0;</li> <li>lignes 8-11\u00a0: on ajoute la m\u00e9thode [init_database] aux m\u00e9thodes h\u00e9rit\u00e9es de [InterfaceDao]. Elle aura pour r\u00f4le d\u2019initialiser la base de donn\u00e9es avec les donn\u00e9es du dictionnaire [data] qu\u2019on lui passe en param\u00e8tre ligne 10\u00a0; Rappelons que l\u2019interface [InterfaceDao] \u00e9tait la suivante\u00a0:</li> </ul> <pre><code># imports\nfrom abc import ABC, abstractmethod\n\n# interface Dao\nfrom El\u00e8ve import El\u00e8ve\n\n\nclass InterfaceDao(ABC):\n    # liste des classes\n    @abstractmethod\n    def get_classes(self: object) -&gt; list:\n        pass\n\n    # liste des \u00e9l\u00e8ves\n    @abstractmethod\n    def get_\u00e9l\u00e8ves(self: object) -&gt; list:\n        pass\n\n    # liste des mati\u00e8res\n    @abstractmethod\n    def get_mati\u00e8res(self: object) -&gt; list:\n        pass\n\n    # liste des notes\n    @abstractmethod\n    def get_notes(self: object) -&gt; list:\n        pass\n\n    # liste des notes d'un \u00e9l\u00e8ve\n    @abstractmethod\n    def get_notes_for_\u00e9l\u00e8ve_by_id(self: object, \u00e9l\u00e8ve_id: int) -&gt; list:\n        pass\n\n    # chercher un \u00e9l\u00e8ve par son id\n    @abstractmethod\n    def get_\u00e9l\u00e8ve_by_id(self: object, \u00e9l\u00e8ve_id: int) -&gt; El\u00e8ve:\n        pass\n</code></pre> <p>L\u2019impl\u00e9mentation de la couche [dao] est la suivante\u00a0:</p> <pre><code>from sqlalchemy.exc import DatabaseError, IntegrityError, InterfaceError\n\nfrom Classe import Classe\nfrom El\u00e8ve import El\u00e8ve\nfrom InterfaceDatabaseDao import InterfaceDatabaseDao\nfrom Mati\u00e8re import Mati\u00e8re\nfrom MyException import MyException\nfrom Note import Note\n\n\nclass DatabaseDao(InterfaceDatabaseDao):\n\n    def __init__(self, config: dict):\n        # database = {\"engine\": engine, \"metadata\": metadata, \"tables\": tables, \"session\": session}\n        self.database = config['database']\n        self.session = self.database['session']\n\n    def init_database(self, data: dict):\n        \u2026\n\u2026\n</code></pre> <ul> <li>ligne 11\u00a0: la classe [DatabaseDao] impl\u00e9mente l\u2019interface [InterfaceDatabaseDao]\u00a0;</li> <li>lignes 13-16\u00a0: le constructeur de la classe. Il re\u00e7oit en param\u00e8tre, le dictionnaire de la configuration de l\u2019application\u00a0;</li> <li>ligne 15\u00a0: on m\u00e9morise la configuration [sqlalchemy]\u00a0;</li> <li>ligne 16\u00a0: on m\u00e9morise la session [sqlalchemy] au travers de laquelle on va manipuler la base de donn\u00e9es\u00a0;</li> <li>ligne 18\u00a0: la m\u00e9thode [init_database] initialise la base de donn\u00e9es avec le dictionnaire [data]\u00a0; Le dictionnaire [data] est impl\u00e9ment\u00e9 par le script [data.py] suivant\u00a0:</li> </ul> <pre><code>def configure():\n    from Classe import Classe\n    from El\u00e8ve import El\u00e8ve\n    from Mati\u00e8re import Mati\u00e8re\n    from Note import Note\n\n    # on instancie les classes\n    classe1 = Classe().fromdict({\"id\": 1, \"nom\": \"classe1\"})\n    classe2 = Classe().fromdict({\"id\": 2, \"nom\": \"classe2\"})\n    classes = [classe1, classe2]\n    # les mati\u00e8res\n    mati\u00e8re1 = Mati\u00e8re().fromdict({\"id\": 1, \"nom\": \"mati\u00e8re1\", \"coefficient\": 1})\n    mati\u00e8re2 = Mati\u00e8re().fromdict({\"id\": 2, \"nom\": \"mati\u00e8re2\", \"coefficient\": 2})\n    mati\u00e8res = [mati\u00e8re1, mati\u00e8re2]\n    # les \u00e9l\u00e8ves\n    \u00e9l\u00e8ve11 = El\u00e8ve().fromdict({\"id\": 11, \"nom\": \"nom1\", \"pr\u00e9nom\": \"pr\u00e9nom1\", \"classe\": classe1})\n    \u00e9l\u00e8ve21 = El\u00e8ve().fromdict({\"id\": 21, \"nom\": \"nom2\", \"pr\u00e9nom\": \"pr\u00e9nom2\", \"classe\": classe1})\n    \u00e9l\u00e8ve32 = El\u00e8ve().fromdict({\"id\": 32, \"nom\": \"nom3\", \"pr\u00e9nom\": \"pr\u00e9nom3\", \"classe\": classe2})\n    \u00e9l\u00e8ve42 = El\u00e8ve().fromdict({\"id\": 42, \"nom\": \"nom4\", \"pr\u00e9nom\": \"pr\u00e9nom4\", \"classe\": classe2})\n    \u00e9l\u00e8ves = [\u00e9l\u00e8ve11, \u00e9l\u00e8ve21, \u00e9l\u00e8ve32, \u00e9l\u00e8ve42]\n    # les notes des \u00e9l\u00e8ves dans les diff\u00e9rentes mati\u00e8res\n    note1 = Note().fromdict({\"id\": 1, \"valeur\": 10, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve11, \"mati\u00e8re\": mati\u00e8re1})\n    note2 = Note().fromdict({\"id\": 2, \"valeur\": 12, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve21, \"mati\u00e8re\": mati\u00e8re1})\n    note3 = Note().fromdict({\"id\": 3, \"valeur\": 14, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve32, \"mati\u00e8re\": mati\u00e8re1})\n    note4 = Note().fromdict({\"id\": 4, \"valeur\": 16, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve42, \"mati\u00e8re\": mati\u00e8re1})\n    note5 = Note().fromdict({\"id\": 5, \"valeur\": 6, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve11, \"mati\u00e8re\": mati\u00e8re2})\n    note6 = Note().fromdict({\"id\": 6, \"valeur\": 8, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve21, \"mati\u00e8re\": mati\u00e8re2})\n    note7 = Note().fromdict({\"id\": 7, \"valeur\": 10, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve32, \"mati\u00e8re\": mati\u00e8re2})\n    note8 = Note().fromdict({\"id\": 8, \"valeur\": 12, \"\u00e9l\u00e8ve\": \u00e9l\u00e8ve42, \"mati\u00e8re\": mati\u00e8re2})\n    notes = [note1, note2, note3, note4, note5, note6, note7, note8]\n    # on regroupe l'ensemble\n    data = {\"\u00e9l\u00e8ves\": \u00e9l\u00e8ves, \"classes\": classes, \"mati\u00e8res\": mati\u00e8res, \"notes\": notes}\n    # on rend les donn\u00e9es\n    return data\n</code></pre> <ul> <li>ligne 34\u00a0: le dictionnaire qui sera pass\u00e9 \u00e0 la m\u00e9thode [init_database]. Ce dictionnaire est compos\u00e9 des cl\u00e9s suivantes\u00a0(ligne 32)\u00a0:</li> <li>[\u00e9l\u00e8ves]\u00a0: la liste des \u00e9l\u00e8ves\u00a0;</li> <li>[classes]\u00a0: la liste des classes\u00a0;</li> <li>[mati\u00e8res]\u00a0: la liste des mati\u00e8res\u00a0;</li> <li>[notes]\u00a0: la liste des notes de tous les \u00e9l\u00e8ves dans toutes les mati\u00e8res\u00a0; Revenons \u00e0 la m\u00e9thode [init_database]\u00a0:</li> </ul> <pre><code>def init_database(self, data: dict):\n        # config de la bd\n        database = self.database\n        engine = database['engine']\n        metadata = database['metadata']\n        tables = database['tables']\n\n        try:\n            # suppression des tables existantes\n            # checkfirst=True : v\u00e9rifie d'abord que la table existe\n            tables[\"notes\"].drop(engine, checkfirst=True)\n            tables[\"mati\u00e8res\"].drop(engine, checkfirst=True)\n            tables[\"\u00e9l\u00e8ves\"].drop(engine, checkfirst=True)\n            tables[\"classes\"].drop(engine, checkfirst=True)\n\n            # recr\u00e9ation des tables \u00e0 partir du mapping\n            metadata.create_all(engine)\n\n            # remplissage des tables\n            session = self.session\n\n            # classes\n            classes = data[\"classes\"]\n            for classe in classes:\n                session.add(classe)\n\n            # mati\u00e8res\n            mati\u00e8res = data[\"mati\u00e8res\"]\n            for mati\u00e8re in mati\u00e8res:\n                session.add(mati\u00e8re)\n\n            # \u00e9l\u00e8ves\n            \u00e9l\u00e8ves = data[\"\u00e9l\u00e8ves\"]\n            for \u00e9l\u00e8ve in \u00e9l\u00e8ves:\n                session.add(\u00e9l\u00e8ve)\n\n            # notes\n            notes = data[\"notes\"]\n            for note in notes:\n                session.add(note)\n\n            # commit\n            session.commit()\n        except (DatabaseError, InterfaceError, IntegrityError) as erreur:\n            # annulation de la session\n            if session:\n                session.rollback()\n            # on remonte l'exception\n            raise MyException(23, f\"{erreur}\")\n</code></pre> <ul> <li>lignes 3-6\u00a0: on r\u00e9cup\u00e8re des informations dans la configuration de la base de donn\u00e9es\u00a0;</li> <li>lignes 9-14\u00a0: nous avons vu que la configuration [sqlalchemy] avait mapp\u00e9 quatre entit\u00e9s sur quatre tables [\u00e9l\u00e8ves, mati\u00e8res, classes, notes]. On commence par supprimer ces tables si elles existent\u00a0;</li> <li>lignes 16-17\u00a0: on recr\u00e9e les quatre tables qu\u2019on vient de supprimer\u00a0;</li> <li>lignes 22-25\u00a0: on met toutes les classes dans la session\u00a0;</li> <li>lignes 27-30\u00a0: on met toutes les mati\u00e8res dans la session\u00a0;</li> <li>lignes 32-35\u00a0: on met tous les \u00e9l\u00e8ves dans la session\u00a0;</li> <li>lignes 37-40\u00a0: on met toutes les notes dans la session\u00a0;</li> <li>pour faire ces ajouts, on a suivi un ordre. On a commenc\u00e9 par les entit\u00e9s n\u2019ayant pas de relations avec d\u2019autres entit\u00e9s pour terminer par celles qui en avaient. Ainsi lorsqu\u2019on ajoute les \u00e9l\u00e8ves dans la session, les classes que ceux-ci r\u00e9f\u00e9rencent sont d\u00e9j\u00e0 en session\u00a0;</li> <li>ligne 43\u00a0: la session [sqlalchemy] est valid\u00e9e. Apr\u00e8s cette op\u00e9ration, on est s\u00fbrs que toutes les donn\u00e9es en session ont \u00e9t\u00e9 synchronis\u00e9es avec la base de donn\u00e9es. En clair, elles sont arriv\u00e9es dans les tables. Ceci a pu se faire gr\u00e2ce aux mappings qui ont \u00e9t\u00e9 faits dans la configuration de [sqlalchemy]. [sqlalchemy] sait comment chaque entit\u00e9 doit \u00eatre stock\u00e9e dans les tables. [sqlalchemy] a \u00e9galement g\u00e9n\u00e9r\u00e9 les cl\u00e9s \u00e9trang\u00e8res que peuvent poss\u00e9der les tables\u00a0;</li> <li>lignes 44-49\u00a0: si on rencontre un probl\u00e8me, la session [sqlalchemy] est annul\u00e9e\u00a0et ligne 49, une exception est lev\u00e9e\u00a0; </li> </ul>"},{"location":"utilisation-de-lorm-sqlalchemy.html#1966-initialisation-de-la-base-de-donnees","title":"19.6.6. Initialisation de la base de donn\u00e9es","text":"<p>Le script [main_init_database] initialise la base de donn\u00e9es avec le contenu du script [data.py]. Son code est le suivant\u00a0:</p> <pre><code># on attend un param\u00e8tre mysql ou pgres\nimport sys\n\nsyntaxe = f\"{sys.argv[0]} mysql / pgres\"\nerreur = len(sys.argv) != 2\nif not erreur:\n    sgbd = sys.argv[1].lower()\n    erreur = sgbd != \"mysql\" and sgbd != \"pgres\"\nif erreur:\n    print(f\"syntaxe : {syntaxe}\")\n    sys.exit()\n\n# on configure l'application\nimport config\nconfig = config.configure({'sgbd': sgbd})\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom MyException import MyException\n\n# on r\u00e9cup\u00e8re les donn\u00e9es \u00e0 mettre en base\nimport data\ndata = data.configure()\n\n# on r\u00e9cup\u00e8re la couche [dao]\ndao = config[\"dao\"]\n\n# ----------- main\ntry:\n    # cr\u00e9ation et initialisation des tables de la bd\n    dao.init_database(data)\nexcept MyException as ex:\n    # on affiche l'erreur\n    print(f\"L'erreur suivante s'est produite : {ex}\")\nfinally:\n    # lib\u00e9ration des ressources mobilis\u00e9es par l'application\n    import shutdown\n    shutdown.execute(config)\n# fin\nprint(\"Travail termin\u00e9...\")\n</code></pre> <ul> <li>lignes 1-11\u00a0: le script attend un param\u00e8tre [mysql] ou [pgres] selon qu\u2019on veut initialiser une base MySQL ou PostgreSQL\u00a0;</li> <li>lignes 13-15\u00a0: l\u2019application est configur\u00e9e pour le SGBD pass\u00e9 en param\u00e8tre\u00a0;</li> <li>lignes 20-22\u00a0: on r\u00e9cup\u00e8re les donn\u00e9es \u00e0 mettre en base\u00a0;</li> <li>ligne 25\u00a0: la couche [dao] a d\u00e9j\u00e0 \u00e9t\u00e9 instanci\u00e9e et est accessible dans la configuration de l\u2019application\u00a0;</li> <li>ligne 30\u00a0: la base de donn\u00e9es est initialis\u00e9e\u00a0;</li> <li>lignes 34-37\u00a0: erreur ou pas, on lib\u00e8re les ressources de l\u2019application \u00e0 l\u2019aide du module [shutdown]\u00a0; Le module [shutdown.py] est le suivant\u00a0:</li> </ul> <pre><code>def execute(config: dict):\n    # on lib\u00e8re les ressources mobilis\u00e9es par l'application\n    sqlalchemy_session = config['database']['session']\n    if sqlalchemy_session:\n        sqlalchemy_session.close()\n</code></pre> <p>La fonction [shutdown.execute] ferme la session [sqlalchemy] utilis\u00e9e pour initialiser la base de donn\u00e9es.</p> <p>Nous cr\u00e9ons une 1\u00e8re configuration d\u2019ex\u00e9cution\u00a0(cf. |configuration d\u2019ex\u00e9cution|) pour ex\u00e9cuter [main_init_database] avec le SGBD MySQL\u00a0:</p> <p></p> <p>Les r\u00e9sultats de l\u2019ex\u00e9cution de cette configuration sont les suivants dans phpMyAdmin\u00a0:</p> <p></p> <p></p> <p></p> <p>Pour le SGBD [PostgreSQL], nous utilisons la configuration d\u2019ex\u00e9cution suivante\u00a0:</p> <p></p> <p>A l\u2019ex\u00e9cution, les r\u00e9sultats dans [pgAdmin] sont les suivants\u00a0:</p> <p></p> <p></p> <p></p> <p>On notera la facilit\u00e9 avec laquelle on a pu changer de SGBD.</p>"},{"location":"utilisation-de-lorm-sqlalchemy.html#1967-la-couche-dao-2","title":"19.6.7. La couche [dao] \u2013 2","text":"<p>Nous revenons sur la classe [DatabaseDao] qui impl\u00e9mente la couche [dao]. Nous n\u2019avons montr\u00e9 pour l\u2019instant que l\u2019impl\u00e9mentation de la m\u00e9thode [init_database]. Nous montrons maintenant l\u2019impl\u00e9mentation des autres m\u00e9thodes\u00a0:</p> <pre><code>from sqlalchemy.exc import DatabaseError, IntegrityError, InterfaceError\n\nfrom Classe import Classe\nfrom El\u00e8ve import El\u00e8ve\nfrom InterfaceDatabaseDao import InterfaceDatabaseDao\nfrom Mati\u00e8re import Mati\u00e8re\nfrom MyException import MyException\nfrom Note import Note\n\n\nclass DatabaseDao(InterfaceDatabaseDao):\n\n    def __init__(self, config: dict):\n        # database = {\"engine\": engine, \"metadata\": metadata, \"tables\": tables, \"session\": session}\n        self.database = config['database']\n        self.session = self.database['session']\n\n    def init_database(self, data: dict):\n        \u2026\n\n    # liste de toutes les classes\n    def get_classes(self: object) -&gt; list:\n        # requ\u00eate\n        return self.session.query(Classe).all()\n\n    # liste de tous les \u00e9l\u00e8ves\n    def get_\u00e9l\u00e8ves(self: object) -&gt; list:\n        # requ\u00eate\n        return self.session.query(El\u00e8ve).all()\n\n    # liste de toutes les mati\u00e8res\n    def get_mati\u00e8res(self: object) -&gt; list:\n        # requ\u00eate\n        return self.session.query(Mati\u00e8re).all()\n\n    # la liste des notes de tous les \u00e9l\u00e8ves\n    def get_notes(self: object) -&gt; list:\n        # requ\u00eate\n        return self.session.query(Note).all()\n\n    # la liste des notes d'un \u00e9l\u00e8ve particulier\n    def get_notes_for_\u00e9l\u00e8ve_by_id(self: object, \u00e9l\u00e8ve_id: int) -&gt; list:\n        # on cherche l'\u00e9l\u00e8ve - une exception est lanc\u00e9e s'il n'existe pas\n        # on la laisse remonter\n        \u00e9l\u00e8ve = self.get_\u00e9l\u00e8ve_by_id(\u00e9l\u00e8ve_id)\n        # on r\u00e9cup\u00e8re ses notes (lazy loading)\n        notes = \u00e9l\u00e8ve.notes\n        # on rend un dictionnaire\n        return {\"\u00e9l\u00e8ve\": \u00e9l\u00e8ve, \"notes\": notes}\n\n    # un \u00e9l\u00e8ve rep\u00e9r\u00e9 par son n\u00b0\n    def get_\u00e9l\u00e8ve_by_id(self, \u00e9l\u00e8ve_id: int) -&gt; El\u00e8ve:\n        # on cherche l'\u00e9l\u00e8ve\n        \u00e9l\u00e8ves = self.session.query(El\u00e8ve).filter(El\u00e8ve.id == \u00e9l\u00e8ve_id).all()\n        # a-t-on trouv\u00e9 ?\n        if \u00e9l\u00e8ves:\n            return \u00e9l\u00e8ves[0]\n        else:\n            raise MyException(11, f\"L'\u00e9l\u00e8ve d'identifiant {\u00e9l\u00e8ve_id} n'existe pas\")\n\n    # un \u00e9l\u00e8ve rep\u00e9r\u00e9 par son nom\n    def get_\u00e9l\u00e8ve_by_name(self, \u00e9l\u00e8ve_name: str) -&gt; El\u00e8ve:\n        # on cherche l'\u00e9l\u00e8ve\n        \u00e9l\u00e8ves = self.session.query(El\u00e8ve).filter(El\u00e8ve.nom == \u00e9l\u00e8ve_name).all()\n        # a-t-on trouv\u00e9 ?\n        if \u00e9l\u00e8ves:\n            return \u00e9l\u00e8ves[0]\n        else:\n            raise MyException(12, f\"L'\u00e9l\u00e8ve de nom {\u00e9l\u00e8ve_name} n'existe pas\")\n\n    # une classe rep\u00e9r\u00e9e par son n\u00b0\n    def get_classe_by_id(self, classe_id: int) -&gt; Classe:\n        # on cherche la classe\n        classes = self.session.query(Classe).filter(Classe.id == classe_id).all()\n        # a-t-on trouv\u00e9 ?\n        if classes:\n            return classes[0]\n        else:\n            raise MyException(13, f\"La classe d'identifiant {classe_id} n'existe pas\")\n\n    # une classe rep\u00e9r\u00e9e par son nom\n    def get_classe_by_name(self, classe_name: str) -&gt; Classe:\n        # on cherche l'classe\n        classes = self.session.query(Classe).filter(Classe.nom == classe_name).all()\n        # a-t-on trouv\u00e9 ?\n        if classes:\n            return classes[0]\n        else:\n            raise MyException(14, f\"La classe de nom {classe_name} n'existe pas\")\n\n    # une mati\u00e8re rep\u00e9r\u00e9e par son n\u00b0\n    def get_mati\u00e8re_by_id(self, mati\u00e8re_id: int) -&gt; Mati\u00e8re:\n        # on cherche l'mati\u00e8re\n        mati\u00e8res = self.session.query(Mati\u00e8re).filter(Mati\u00e8re.id == mati\u00e8re_id).all()\n        # a-t-on trouv\u00e9 ?\n        if mati\u00e8res:\n            return mati\u00e8res[0]\n        else:\n            raise MyException(11, f\"La mati\u00e8re d'identifiant {mati\u00e8re_id} n'existe pas\")\n\n    # une mati\u00e8re rep\u00e9r\u00e9e par son nom\n    def get_mati\u00e8re_by_name(self, mati\u00e8re_name: str) -&gt; Mati\u00e8re:\n        # on cherche la mati\u00e8re\n        mati\u00e8res = self.session.query(Mati\u00e8re).filter(Mati\u00e8re.nom == mati\u00e8re_name).all()\n        # a-t-on trouv\u00e9 ?\n        if mati\u00e8res:\n            return mati\u00e8res[0]\n        else:\n            raise MyException(15, f\"La mati\u00e8re de nom {mati\u00e8re_name} n'existe pas\")\n</code></pre> <ul> <li>lignes 21-24\u00a0: la m\u00e9thode [get_classes] doit rendre la liste des classes de l\u2019\u00e9cole. Ligne 20, nous utilisons une requ\u00eate d\u00e9j\u00e0 rencontr\u00e9e\u00a0;</li> <li>lignes 26-39\u00a0: trois autres m\u00e9thodes similaires pour obtenir les listes des \u00e9l\u00e8ves, des mati\u00e8res et des notes\u00a0;</li> <li>lignes 51-59\u00a0: la m\u00e9thode [get_\u00e9l\u00e8ve_by_id] doit rendre un \u00e9l\u00e8ve identifi\u00e9 par son n\u00b0. Elle lance une exception si celui-ci n\u2019existe pas\u00a0;</li> <li>ligne 54\u00a0: on utilise une requ\u00eatre filtr\u00e9e. On obtient une liste vide ou avec un \u00e9l\u00e9ment\u00a0;</li> <li>ligne 57\u00a0: si la liste r\u00e9cup\u00e9r\u00e9e n\u2019est pas vide\u00a0on rend le 1er \u00e9l\u00e9ment de la liste\u00a0;</li> <li>sinon ligne 59, on lance une exception\u00a0;</li> <li>lignes 41-49\u00a0: la m\u00e9thode [get_notes_for_\u00e9l\u00e8ve_by_id] doit rendre les notes d\u2019un \u00e9l\u00e8ve identifi\u00e9 par son n\u00b0\u00a0:</li> <li>ligne 45, on utilise la m\u00e9thode [get_\u00e9l\u00e8ve_by_id] pour obtenir l\u2019entit\u00e9 El\u00e8ve de l\u2019\u00e9l\u00e8ve\u00a0;</li> <li>ligne 47, on utilise la propri\u00e9t\u00e9 [El\u00e8ve.notes] cr\u00e9\u00e9e par le mapping entre l\u2019entit\u00e9 [Note] et la table [notes] (cf. paragraphe |configuration sqlalchemy|) et qui repr\u00e9sente les notes de l\u2019\u00e9l\u00e8ve\u00a0;</li> <li>ligne 49\u00a0: on rend un dictionnaire\u00a0;</li> <li>lignes 61-109\u00a0: une s\u00e9rie de m\u00e9thodes analogues permettant de\u00a0:</li> <li>retrouver un \u00e9l\u00e8ve par son nom, lignes 61-69\u00a0;</li> <li>retrouver une classe, lignes 71-89\u00a0;</li> <li>retrouver une mati\u00e8re, lignes 91-109\u00a0;</li> </ul>"},{"location":"utilisation-de-lorm-sqlalchemy.html#1968-le-script-main_joined_queries","title":"19.6.8. Le script [main_joined_queries]","text":"<p>Le script [main_joined_queries] s\u2019appelle ainsi parce qu\u2019il vise \u00e0 mettre en lumi\u00e8re les requ\u00eates faites implicitement par [sqlalchemy] pour r\u00e9cup\u00e9rer des informations appartenant \u00e0 plusieurs tables. Ces requ\u00eates cach\u00e9es au programmeur sont faites \u00e0 chaque fois qu\u2019une propri\u00e9t\u00e9 d\u2019une entit\u00e9 a \u00e9t\u00e9 associ\u00e9e \u00e0 la fonction [relationship] dans le mapping de l\u2019entit\u00e9. Par exemple\u00a0:</p> <pre><code>    # mapping\n    mapper(Note, tables['notes'], properties={\n        'id': notes_table.c.id,\n        'valeur': notes_table.c.valeur,\n        '\u00e9l\u00e8ve': relationship(El\u00e8ve, backref=\"notes\", lazy=\"select\"),\n        'mati\u00e8re': relationship(Mati\u00e8re, backref=\"notes\", lazy=\"select\")\n    })\n</code></pre> <p>Ci-dessus, le mapping entre l\u2019entit\u00e9 [Note] et la table [notes]\u00a0:</p> <ul> <li>ligne 5, lorsque la propri\u00e9t\u00e9 [\u00e9l\u00e8ve] d\u2019une entit\u00e9 [Note] est demand\u00e9e pour la 1\u00e8re fois, elle sera cherch\u00e9e dans la table [\u00e9l\u00e8ves] via une requ\u00eate SQL. Tant que cette propri\u00e9t\u00e9 n\u2019a pas \u00e9t\u00e9 demand\u00e9e, elle reste ind\u00e9finie (lazy load). Une fois qu\u2019elle a \u00e9t\u00e9 obtenue, sa valeur reste en m\u00e9moire de l\u2019ORM. Lorsqu\u2019elle sera r\u00e9f\u00e9renc\u00e9e une deuxi\u00e8me fois, l\u2019ORM d\u00e9livrera imm\u00e9diatement sa valeur sans passer par une nouvelle requ\u00eate SQL. Tout cela est transparent pour le d\u00e9veloppeur\u00a0;</li> <li>idem pour la propri\u00e9t\u00e9 inverse [El\u00e8ve.notes] (backref), ligne 5\u00a0;</li> <li>idem pour la propri\u00e9t\u00e9 [Note.mati\u00e8re] et sa propri\u00e9t\u00e9 inverse [Mati\u00e8re.notes] (backref), ligne 6\u00a0; Le script [main_joined_queries] est le suivant\u00a0:</li> </ul> <pre><code># on attend un param\u00e8tre mysql ou pgres\nimport sys\n\nsyntaxe = f\"{sys.argv[0]} mysql / pgres\"\nerreur = len(sys.argv) != 2\nif not erreur:\n    sgbd = sys.argv[1].lower()\n    erreur = sgbd != \"mysql\" and sgbd != \"pgres\"\nif erreur:\n    print(f\"syntaxe : {syntaxe}\")\n    sys.exit()\n\n# on configure l'application\nimport config\nconfig = config.configure({\"sgbd\": sgbd})\n\n# le syspath est configur\u00e9 - on peut faire els imports\nfrom MyException import MyException\n\n# la couche [dao]\ndao = config[\"dao\"]\ntry:\n    # \u00e9l\u00e8ve by id\n    print(\"\u00e9l\u00e8ve id=11 -----------\")\n    \u00e9l\u00e8ve = dao.get_\u00e9l\u00e8ve_by_id(11)\n    print(f\"\u00e9l\u00e8ve={\u00e9l\u00e8ve}\")\n    # la classe de l'\u00e9l\u00e8ve (lazy loading)\n    classe = \u00e9l\u00e8ve.classe\n    print(f\"classe de l'\u00e9l\u00e8ve : {classe}\")\n    # les \u00e9l\u00e8ves de la m\u00eame classe (lazy loading)\n    print(\"\u00e9l\u00e8ves dans la m\u00eame classe :\")\n    for \u00e9l\u00e8ve in classe.\u00e9l\u00e8ves:\n        print(f\"\u00e9l\u00e8ve={\u00e9l\u00e8ve}\")\n\n    # un \u00e9l\u00e8ve par son nom\n    print(\"\u00e9l\u00e8ve nom='nom2' -----------\")\n    print(f\"\u00e9l\u00e8ve={dao.get_\u00e9l\u00e8ve_by_name('nom2')}\")\n    # sa classe (lazy loading)\n    print(f\"classe de l'\u00e9l\u00e8ve : {\u00e9l\u00e8ve.classe}\")\n\n    # notes d'un \u00e9l\u00e8ve\n    print(\"notes de l'\u00e9l\u00e8ve id=11 -----------\")\n    # d'abord l'\u00e9l\u00e8ve\n    \u00e9l\u00e8ve = dao.get_\u00e9l\u00e8ve_by_id(11)\n    # puis ses notes (lazy loading)\n    for note in \u00e9l\u00e8ve.notes:\n        # la note\n        print(f\"note={note}, \"\n              # la mati\u00e8re de la note (lazy loading)\n              f\"mati\u00e8re={note.mati\u00e8re}\")\n\n    # les \u00e9l\u00e8ves d'une classe\n    print(\"\u00e9l\u00e8ves de la classe nom='classe1' -----------\")\n    # d'abord la classe\n    classe = dao.get_classe_by_name('classe1')\n    # puis les \u00e9l\u00e8ves (lazy loading)\n    for \u00e9l\u00e8ve in classe.\u00e9l\u00e8ves:\n        print(\u00e9l\u00e8ve)\n\n    # m\u00eame chose pour [classe2]\n    print(\"\u00e9l\u00e8ves de la classe de nom 'classe2' -----------\")\n    classe = dao.get_classe_by_name('classe2')\n    for \u00e9l\u00e8ve in classe.\u00e9l\u00e8ves:\n        print(\u00e9l\u00e8ve)\n\n    # les notes dans une mati\u00e8re\n    print(\"mati\u00e8re de nom='mati\u00e8re1' -----------\")\n    # d'abord la mati\u00e8re\n    mati\u00e8re = dao.get_mati\u00e8re_by_name('mati\u00e8re1')\n    print(f\"mati\u00e8re={mati\u00e8re}\")\n    # puis les notes dans cette mati\u00e8re (lazy loading)\n    print(\"Notes dans la mati\u00e8re : \")\n    for note in mati\u00e8re.notes:\n        print(note)\n\n    # m\u00eame chose pour mati\u00e8re2\n    print(\"mati\u00e8re de nom='mati\u00e8re2' -----------\")\n    mati\u00e8re = dao.get_mati\u00e8re_by_name('mati\u00e8re2')\n    print(f\"mati\u00e8re={mati\u00e8re}\")\n    print(\"Notes dans la mati\u00e8re : \")\n    for note in mati\u00e8re.notes:\n        print(f\"note={note}\")\nexcept MyException as ex1:\n    # on affiche l'erreur\n    print(f\"L'erreur 1 suivante s'est produite : {ex1}\")\nexcept BaseException as ex2:\n    # on affiche l'erreur\n    print(f\"L'erreur 2 suivante s'est produite : {ex2}\")\nfinally:\n    # on lib\u00e8re les ressources\n    import shutdown\n    shutdown.execute(config)\n</code></pre> <p>Les commentaires suffisent \u00e0 comprendre le code.</p> <p>On cr\u00e9e une configuration d\u2019ex\u00e9cution pour MySQL\u00a0:</p> <p></p> <p>Les r\u00e9sultats de l\u2019ex\u00e9cution sont les suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/sqlalchemy/05/main/main_joined_queries.py mysql\n\u00e9l\u00e8ve id=11 -----------\n\u00e9l\u00e8ve={\"classe_id\": 1, \"nom\": \"nom1\", \"pr\u00e9nom\": \"pr\u00e9nom1\", \"id\": 11}\nclasse de l'\u00e9l\u00e8ve : {\"nom\": \"classe1\", \"id\": 1}\n\u00e9l\u00e8ves dans la m\u00eame classe :\n\u00e9l\u00e8ve={\"classe_id\": 1, \"nom\": \"nom1\", \"pr\u00e9nom\": \"pr\u00e9nom1\", \"id\": 11}\n\u00e9l\u00e8ve={\"classe_id\": 1, \"nom\": \"nom2\", \"pr\u00e9nom\": \"pr\u00e9nom2\", \"id\": 21}\n\u00e9l\u00e8ve nom='nom2' -----------\n\u00e9l\u00e8ve={\"classe_id\": 1, \"nom\": \"nom2\", \"pr\u00e9nom\": \"pr\u00e9nom2\", \"id\": 21}\nclasse de l'\u00e9l\u00e8ve : {\"nom\": \"classe1\", \"id\": 1}\nnotes de l'\u00e9l\u00e8ve id=11 -----------\nnote={\"mati\u00e8re_id\": 1, \"valeur\": 10.0, \"\u00e9l\u00e8ve_id\": 11, \"id\": 1}, mati\u00e8re={\"coefficient\": 1.0, \"nom\": \"mati\u00e8re1\", \"id\": 1}\nnote={\"mati\u00e8re_id\": 2, \"valeur\": 6.0, \"\u00e9l\u00e8ve_id\": 11, \"id\": 5}, mati\u00e8re={\"coefficient\": 2.0, \"nom\": \"mati\u00e8re2\", \"id\": 2}\n\u00e9l\u00e8ves de la classe nom='classe1' -----------\n{\"classe_id\": 1, \"nom\": \"nom1\", \"pr\u00e9nom\": \"pr\u00e9nom1\", \"id\": 11}\n{\"classe_id\": 1, \"nom\": \"nom2\", \"pr\u00e9nom\": \"pr\u00e9nom2\", \"id\": 21}\n\u00e9l\u00e8ves de la classe de nom 'classe2' -----------\n{\"classe_id\": 2, \"nom\": \"nom3\", \"pr\u00e9nom\": \"pr\u00e9nom3\", \"id\": 32}\n{\"classe_id\": 2, \"nom\": \"nom4\", \"pr\u00e9nom\": \"pr\u00e9nom4\", \"id\": 42}\nmati\u00e8re de nom='mati\u00e8re1' -----------\nmati\u00e8re={\"coefficient\": 1.0, \"nom\": \"mati\u00e8re1\", \"id\": 1}\nNotes dans la mati\u00e8re : \n{\"mati\u00e8re_id\": 1, \"valeur\": 10.0, \"\u00e9l\u00e8ve_id\": 11, \"id\": 1}\n{\"mati\u00e8re_id\": 1, \"valeur\": 12.0, \"\u00e9l\u00e8ve_id\": 21, \"id\": 2}\n{\"mati\u00e8re_id\": 1, \"valeur\": 14.0, \"\u00e9l\u00e8ve_id\": 32, \"id\": 3}\n{\"mati\u00e8re_id\": 1, \"valeur\": 16.0, \"\u00e9l\u00e8ve_id\": 42, \"id\": 4}\nmati\u00e8re de nom='mati\u00e8re2' -----------\nmati\u00e8re={\"coefficient\": 2.0, \"nom\": \"mati\u00e8re2\", \"id\": 2}\nNotes dans la mati\u00e8re : \nnote={\"mati\u00e8re_id\": 2, \"valeur\": 6.0, \"\u00e9l\u00e8ve_id\": 11, \"id\": 5}\nnote={\"mati\u00e8re_id\": 2, \"valeur\": 8.0, \"\u00e9l\u00e8ve_id\": 21, \"id\": 6}\nnote={\"mati\u00e8re_id\": 2, \"valeur\": 10.0, \"\u00e9l\u00e8ve_id\": 32, \"id\": 7}\nnote={\"mati\u00e8re_id\": 2, \"valeur\": 12.0, \"\u00e9l\u00e8ve_id\": 42, \"id\": 8}\n\nProcess finished with exit code 0\n</code></pre> <p>Pour comprendre ces r\u00e9sultats, il faut se rappeler qu\u2019on a exclu certaines propri\u00e9t\u00e9s du dictionnaire des entit\u00e9s (cf |configuration|)\u00a0:</p> <pre><code>    # configuration des entit\u00e9s [BaseEntity]\n    El\u00e8ve.excluded_keys = ['_sa_instance_state', 'notes', 'classe']\n    Classe.excluded_keys = ['_sa_instance_state', '\u00e9l\u00e8ves']\n    Mati\u00e8re.excluded_keys = ['_sa_instance_state', 'notes']\n    Note.excluded_keys = ['_sa_instance_state', 'mati\u00e8re', '\u00e9l\u00e8ve']\n</code></pre> <p>Ainsi, lorsqu\u2019on \u00e9crit [print(f\"\u00e9l\u00e8ve={\u00e9l\u00e8ve}\")] ligne 26 du code, la ligne 1 ci-dessus nous dit que les propri\u00e9t\u00e9s ['_sa_instance_state', 'notes', 'classe'] ne seront pas affich\u00e9es. C\u2019est ce qu\u2019on voit ligne 3 des r\u00e9sultats. Toutes les autres propri\u00e9t\u00e9s sont affich\u00e9es. Ainsi, toujours ligne 3, on d\u00e9couvre une nouvelle propri\u00e9t\u00e9 [classe_id] qui n\u2019existait initialement pas dans l\u2019entit\u00e9 [El\u00e8ve]. Cette propri\u00e9t\u00e9 correspond directement \u00e0 la colonne [classe_id] de la table [\u00e9l\u00e8ves]. Ainsi [sqlalchemy] a jout\u00e9 les propri\u00e9t\u00e9s suivantes \u00e0 l\u2019entit\u00e9 [El\u00e8ve]\u00a0: [classe_id, _sa_instance_state, notes]. Il faut en avoir conscience, notamment parce qu\u2019elles ne doivent pas d\u00e9j\u00e0 exister dans l\u2019entit\u00e9 mapp\u00e9e.</p> <p>Les propri\u00e9t\u00e9s exclues du dictionnaire des entit\u00e9s sont importantes. Si par exemple, on n\u2019exclut pas les propri\u00e9t\u00e9s [notes, \u00e9l\u00e8ve] de l\u2019entit\u00e9 [El\u00e8ve] alors l\u2019op\u00e9ration [print(f\"\u00e9l\u00e8ve={\u00e9l\u00e8ve}\")] va les afficher et va donc, comme il vient d\u2019\u00eatre expliqu\u00e9, provoquer des requ\u00eates SQL implicites (lazy loading) pour r\u00e9cup\u00e9rer les valeurs de ces propri\u00e9t\u00e9s. Si, comme ici, c\u2019est une liste d\u2019\u00e9l\u00e8ves qui est affich\u00e9e, les op\u00e9rations SQL implicites sont faites pour chaque \u00e9l\u00e8ve. Cela peut \u00eatre d\u2019une part inutile et d\u2019autre part s\u00fbrement co\u00fbteux en temps d\u2019ex\u00e9cution.</p> <p>Pour ex\u00e9cuter le script avec une base PostgreSQL, on cr\u00e9e la configuration d\u2019ex\u00e9cution suivante\u00a0:</p> <p></p> <p>L\u2019ex\u00e9cution donne les m\u00eames r\u00e9sultats qu\u2019avec MySQL.</p>"},{"location":"utilisation-de-lorm-sqlalchemy.html#1969-le-script-main_stats_for_eleve","title":"19.6.9. Le script [main_stats_for_\u00e9l\u00e8ve]","text":"<p>Le script [main_stats_for_\u00e9l\u00e8ve] est celui d\u00e9j\u00e0 utilis\u00e9 dans l\u2019application |troiscouches v01]. Il s\u2019appelait alors [main]. C\u2019est une application console permettant d\u2019obtenir certains indicateurs sur les notes d\u2019un \u00e9l\u00e8ve\u00a0: [moyenne pond\u00e9r\u00e9e, min, max, liste]. Il s\u2019ins\u00e8re dans l\u2019architecture suivante\u00a0:</p> <p></p> <p>Dans cette architecture en couches, seule la couche [dao] a \u00e9t\u00e9 chang\u00e9e entre l\u2019application |troiscouches v01| et celle-ci. Comme la nouvelle couche [dao] respecte l\u2019interface [InterfaceDao] de l\u2019ancienne couche [dao], les couches [ui, m\u00e9tier] n\u2019ont pas \u00e0 \u00eatre chang\u00e9es. On peut donc continuer \u00e0 utiliser celles d\u00e9finies dans l\u2019application |troiscouches v01|.</p> <p>Le script [main_stats_for_\u00e9l\u00e8ve] impl\u00e9mente la couche [main] du sch\u00e9ma ci-dessus de la fa\u00e7on suivante\u00a0:</p> <pre><code># on attend un param\u00e8tre mysql ou pgres\nimport sys\n\nsyntaxe = f\"{sys.argv[0]} mysql / pgres\"\nerreur = len(sys.argv) != 2\nif not erreur:\n    sgbd = sys.argv[1].lower()\n    erreur = sgbd != \"mysql\" and sgbd != \"pgres\"\nif erreur:\n    print(f\"syntaxe : {syntaxe}\")\n    sys.exit()\n\n# on configure l'application\nimport config\nconfig = config.configure({'sgbd': sgbd})\n\n# le syspath est configur\u00e9 - on peut faire les imports\nfrom MyException import MyException\n\n# la couche [ui]\nui = config[\"ui\"]\ntry:\n    # ex\u00e9cution couche [ui]\n    ui.run()\nexcept MyException as ex1:\n    # on affiche l'erreur\n    print(f\"L'erreur 1 suivante s'est produite : {ex1}\")\nexcept BaseException as ex2:\n    # on affiche l'erreur\n    print(f\"L'erreur 2 suivante s'est produite : {ex2}\")\nfinally:\n    # on lib\u00e8re les ressources\n    import shutdown\n    shutdown.execute(config)\n</code></pre> <ul> <li>ligne 20\u00a0: on r\u00e9cup\u00e8re une r\u00e9f\u00e9rence sur la couche [ui] dans la configuration de l\u2019application\u00a0;</li> <li>ligne 24\u00a0: on lance le dialogue avec l\u2019utilisateur \u00e0 l\u2019aide de l\u2019unique m\u00e9thode de la couche [ui]\u00a0; Une configuration d\u2019ex\u00e9cution pour PostgreSQL serait la suivante\u00a0:</li> </ul> <p></p> <p>Voici un exemple d\u2019ex\u00e9cution\u00a0avec cette configuration\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/sqlalchemy/05/main/main_stats_for_\u00e9l\u00e8ve.py pgres\nNum\u00e9ro de l'\u00e9l\u00e8ve (&gt;=1 et * pour arr\u00eater) : 11\nEl\u00e8ve={\"pr\u00e9nom\": \"pr\u00e9nom1\", \"id\": 11, \"classe_id\": 1, \"nom\": \"nom1\"}, notes=[10.0 6.0], max=10.0, min=6.0, moyenne pond\u00e9r\u00e9e=7.33\nNum\u00e9ro de l'\u00e9l\u00e8ve (&gt;=1 et * pour arr\u00eater) : 1\nL'erreur suivante s'est produite : MyException[11, L'\u00e9l\u00e8ve d'identifiant 1 n'existe pas]\nNum\u00e9ro de l'\u00e9l\u00e8ve (&gt;=1 et * pour arr\u00eater) : *\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"utilisation-du-sgbd-mysql.html","title":"16. Utilisation du SGBD MySQL","text":""},{"location":"utilisation-du-sgbd-mysql.html#161-intallation-du-sgbd-mysql","title":"16.1. Intallation du SGBD MySQL","text":"<p>Pour disposer du SGBD MySQL, nous allons installer le logiciel Laragon.</p>"},{"location":"utilisation-du-sgbd-mysql.html#1611-installation-de-laragon","title":"16.1.1. Installation de Laragon","text":"<p>Laragon est un package r\u00e9unissant plusieurs logiciels\u00a0:</p> <ul> <li>un serveur web Apache. Nous l'utiliserons pour l'\u00e9criture de scripts web en Python\u00a0;</li> <li>le SGBD MySQL\u00a0;</li> <li>le langage de script PHP que nous n'utiliserons pas\u00a0;</li> <li>un serveur Redis impl\u00e9mentant un cache pour des applications web. Nous n'utiliserons\u00a0; Laragon peut \u00eatre t\u00e9l\u00e9charg\u00e9 (f\u00e9vrier 2020) \u00e0 l'adresse suivante\u00a0:</li> </ul> <pre><code>[https://laragon.org/download/](https://laragon.org/download/)\n</code></pre> <p></p> <p></p> <ul> <li>l'installation [1-5] donne naissance \u00e0 l'arborescence suivante\u00a0:</li> </ul> <p></p> <ul> <li>en [6] le dossier d'installation de PHP (pas utilis\u00e9 dans ce document)\u00a0; Le lancement de [Laragon] affiche la fen\u00eatre suivante\u00a0:</li> </ul> <p></p> <ul> <li>[1]\u00a0: le menu principal de Laragon\u00a0;</li> <li>[2]\u00a0: le bouton [Start All] lance le serveur web Apache et le SGBD MySQL\u00a0;</li> <li>[3]\u00a0: le bouton [WEB] affiche la page web [http://localhost]\u00a0;</li> <li>[4]\u00a0: le bouton [Database] permet de g\u00e9rer le SGBD MySQL avec l\u2019outil [phpMyAdmin]. Il faut auparavant installer celui-ci\u00a0;</li> <li>[5]\u00a0: le bouton [Terminal] ouvre un terminal de commandes\u00a0;</li> <li>[6]\u00a0: le bouton [Root] ouvre un explorateur Windows positionn\u00e9 sur le dossier [&lt;laragon&gt;/www] qui est la racine du site web [http://localhost]. C\u2019est l\u00e0 qu\u2019il faut placer les applications web statiques g\u00e9r\u00e9es par le serveur Apache de Laragon\u00a0;</li> </ul>"},{"location":"utilisation-du-sgbd-mysql.html#1612-creation-dune-base-de-donnees","title":"16.1.2. Cr\u00e9ation d\u2019une base de donn\u00e9es","text":"<p>Nous montrons maintenant comment cr\u00e9er une base de donn\u00e9es ainsi qu'un utilisateur MySQL avec l\u2019outil Laragon.</p> <p></p> <ul> <li>une fois lanc\u00e9, Laragon [1] peut \u00eatre administr\u00e9 \u00e0 partir d'un menu [2]\u00a0;</li> <li>en [3-5], on installe l'outil [phpMyAdmin] d'administration de MySQL s\u2019il n\u2019a pas d\u00e9j\u00e0 \u00e9t\u00e9 install\u00e9\u00a0;</li> </ul> <p></p> <ul> <li>en [6], on d\u00e9marre le serveur web Apache ainsi que le SGBD MySQL\u00a0;</li> <li>en [7], le serveur Apache est lanc\u00e9\u00a0;</li> <li>en [8], le SGBD MySQL est lanc\u00e9\u00a0;</li> </ul> <p></p> <ul> <li>en [8-10], on cr\u00e9e une base de donn\u00e9es qu\u2019on nomme [dbpersonnes] [11]. On va construire une base de donn\u00e9es de personnes\u00a0;</li> </ul> <p></p> <ul> <li>en [11], on va g\u00e9rer la base de donn\u00e9es qu\u2019on vient de cr\u00e9er\u00a0;</li> </ul> <p></p> <ul> <li>l\u2019op\u00e9ration [Bases de donn\u00e9es] \u00e9met une requ\u00eate web vers l\u2019URL [http://localhost/phpmyadmin] [12]. C\u2019est le serveur web Apache de Laragon qui r\u00e9pond. L\u2019URL [http://localhost/phpmyadmin] est l\u2019URL de l\u2019utilitaire [phpMyAdmin] que nous avons install\u00e9 pr\u00e9c\u00e9demment [5]. Cet utilitaire permet de g\u00e9rer les bases de donn\u00e9es MySQL\u00a0;</li> <li>par d\u00e9faut, les identifiants de connexion de l\u2019administrateur de la base sont\u00a0: root [13] sans mot de passe [14]\u00a0;</li> </ul> <p></p> <ul> <li>en [16], la base de donn\u00e9es que nous avons cr\u00e9\u00e9e pr\u00e9c\u00e9demment\u00a0;</li> </ul> <p></p> <ul> <li>on a pour l\u2019instant une base [dbpersonnes] [17] qui est vide [18]\u00a0; On cr\u00e9e un utilisateur [admpersonnes] avec le mot de passe [nobody] qui va avoir tous les droits sur la base de donn\u00e9es [dbpersonnes]\u00a0:</li> </ul> <p></p> <ul> <li>en [19], on est positionn\u00e9s sur la base [dbpersonnes]\u00a0;</li> <li>en [20], on s\u00e9lectionne l\u2019onglet [Privileges]\u00a0;</li> <li>en [21-22], on voit que l\u2019utilisateur [root] a tous les droits sur la base [dbpersonnes]\u00a0;</li> <li>en [23], on cr\u00e9e un nouvel utilisateur\u00a0;</li> </ul> <p></p> <ul> <li>en [25-26], l\u2019utilisateur aura l\u2019identifiant [admdbpersonnes]\u00a0;</li> <li>en [27-29], son mot de passe sera [nobody]\u00a0;</li> <li>en [30], phpMyAdmin signale que le mot de passe est tr\u00e8s faible (facile \u00e0 craquer). En production, il est pr\u00e9f\u00e9rable de g\u00e9n\u00e9rer un mot de passe fort avec [31]\u00a0;</li> <li>en [32], on indique que l\u2019utilisateur [admdbpersonnes] doit avoir tous les droits sur la base [dbpersonnes]\u00a0;</li> <li>en [33], on valide les renseignements donn\u00e9s\u00a0;</li> </ul> <p></p> <ul> <li>en [35], phpMyAdmin indique que l\u2019utilisateur a \u00e9t\u00e9 cr\u00e9\u00e9\u00a0;</li> <li>en [36], l\u2019ordre SQL qui a \u00e9t\u00e9 \u00e9mis sur la base\u00a0;</li> <li> <p>en [37], l\u2019utilisateur [admpersonnes] a tous les droits sur la base de donn\u00e9es [dbpersonnes]\u00a0; D\u00e9sormais nous avons\u00a0:</p> </li> <li> <p>une base de donn\u00e9es MySQL [dbpersonnes]\u00a0;</p> </li> <li>un utilisateur [admpersonnes/nobody] qui a tous les droits sur cette base de donn\u00e9es\u00a0;</li> </ul>"},{"location":"utilisation-du-sgbd-mysql.html#162-intallation-du-package-mysql-connector-python","title":"16.2. Intallation du package [mysql-connector-python]","text":"<p>Nous allons \u00e9crire des scripts Python pour exploiter la base de donn\u00e9es cr\u00e9\u00e9e pr\u00e9c\u00e9demment avec l'architecture suivante\u00a0:</p> <p></p> <p>Un connecteur sert \u00e0 isoler le code Python du SGBD exploit\u00e9. Il existe des connecteurs pour diff\u00e9rents SGBD et ceux-ci respectent la m\u00eame interface. Aussi lorsque ci-dessus, on remplace le SGBD MySQL par le SGBD PostgreSQL, l'architecture devient la suivante\u00a0:</p> <p></p> <p>Parce que tous les connecteurs de SGBD respectent tous la m\u00eame interface, le script Python n'a normalement pas \u00e0 \u00eatre modifi\u00e9. Dans la r\u00e9alit\u00e9, la plupart des SGBD ont un SQL propri\u00e9taire\u00a0:</p> <ul> <li>ils respectent la norme SQL (Structured Query Language)\u00a0;</li> <li>mais l'\u00e9tendent, car elle n'est pas suffisante, avec des extensions du langage propri\u00e9taires\u00a0; Aussi, est-il fr\u00e9quent que lors d'un changement de SGBD il y ait des modifications de SQL \u00e0 faire dans les scripts.</li> </ul> <p>Nativement, Python n'offre pas la possibilit\u00e9 de g\u00e9rer une base MySQL. Il faut pour cela t\u00e9l\u00e9charger un package. Il en existe plusieurs. Nous allons utiliser ici le package [mysql-connector-python] qui est le connecteur Officiel d'Oracle, l'entreprise qui poss\u00e8de MySQL.</p> <p>L'installation du package se fera dans une fen\u00eatre [Terminal] de Pycharm\u00a0:</p> <p></p> <ul> <li> <p>le dossier en [2] n'a pas d'importance pour ce qui va suivre\u00a0; Dans le terminal, on tape la commande [pip search MySQL]\u00a0:</p> </li> <li> <p>[pip] (Package Installer for Python) est l'outil d'installation des packages Python. L'outil [pip] se connecte au d\u00e9p\u00f4t contenant les packages Python\u00a0;</p> </li> <li>[search MySQL]\u00a0: demande la liste des packages contenant le terme [MySQL] (la casse n'a pas d'importance) dans leur nom\u00a0; Les r\u00e9sultats de la commande sont les suivants\u00a0:</li> </ul> <pre><code>mysql (0.0.2)                                                   - Virtual package for MySQL-python\njx-mysql (3.49.20042)                                           - jx-mysql - JSON Expressions for MySQL\nweibo-mysql (0.1)                                               - insert mysql\nbits-mysql (1.0.3)                                              - BITS MySQL\nMySQL-python (1.2.5)                                            - Python interface to MySQL\ndeployfish-mysql (0.2.13)                                       - Deployfish MySQL plugin\nmtstat-mysql (0.7.3.3)                                          - MySQL Plugins for mtstat\nbottle-mysql (0.3.1)                                            - MySQL integration for Bottle.\nWintxDriver-MySQL (2.0.0-1)                                     - MySQL support for Wintx\npy-mysql (1.0)                                                  - Operating Mysql for Python.\nmysql-utilities (1.4.3)                                         - MySQL Utilities 1.4.3 (part of MySQL Workbench Distribution 6.0.0)\n\u2026.                                        - Tool to move slices of data from one MySQL store to another\nmysql-tracer (2.0.2)                                            - A MySQL client to run queries, write execution reports and export results\nmysql-utils (0.0.2)                                             - A simple MySQL library including a set of utility APIs for Python database programming\nmysql-connector-repackaged (0.3.1)                              - MySQL driver written in Python\ndffml-source-mysql (0.0.5)                                      - DFFML Source for MySQL Protocol\nmysql-connector-python (8.0.19)                                 - MySQL driver written in Python\n  INSTALLED: 8.0.19 (latest)\nprometheus-mysql-exporter (0.2.0)                               - MySQL query Prometheus exporter\nbackwork-backup-mysql (0.3.0)                                   - Backwork plug-in for MySQL backups.\ndjango-mysql-manager (0.1.4)                                    - django-mysql-manager is a Django based management interface for MySQL users and databases.\n\u2026.                                              - mysql operate\n\nC:\\Data\\st-2020\\dev\\python\\cours-2020\\v-01&gt;\n</code></pre> <p>Ont \u00e9t\u00e9 list\u00e9s tous les modules dont le nom ou la description ont le mot cl\u00e9 MySQL. Celui que nous utiliserons (f\u00e9v 2020) est [mysql-connector-python], ligne 17. Pour l'installer, on tape dans le terminal la commande [pip install -U mysql-connector-python]\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\v-01&gt;pip install -U mysql-connector-python\nCollecting mysql-connector-python\n  Using cached mysql_connector_python-8.0.19-py2.py3-none-any.whl (355 kB)\nRequirement already satisfied, skipping upgrade: protobuf==3.6.1 in c:\\myprograms\\python38\\lib\\site-packages (from mysql-connector-python) (3.6.1)\nRequirement already satisfied, skipping upgrade: dnspython==1.16.0 in c:\\myprograms\\python38\\lib\\site-packages (from mysql-connector-python) (1.16.0)\nRequirement already satisfied, skipping upgrade: six&gt;=1.9 in c:\\users\\serge\\appdata\\roaming\\python\\python38\\site-packages (from protobuf==3.6.1-&gt;mysql-connector-python) (1.14.0)\nRequirement already satisfied, skipping upgrade: setuptools in c:\\myprograms\\python38\\lib\\site-packages (from protobuf==3.6.1-&gt;mysql-connector-python) (41.2.0)\nInstalling collected packages: mysql-connector-python\nSuccessfully installed mysql-connector-python-8.0.19\n</code></pre> <ul> <li>ligne 1\u00a0: l'option [install -U] (U=upgrade) demande la version la plus r\u00e9cente des diff\u00e9rents packages associ\u00e9s au package [mysql-connector-python]\u00a0; Pour conna\u00eetre les packages install\u00e9s dans l'environnement Python de notre macine, on tape la commande [pip list]\u00a0:</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\v-01&gt;pip list\nPackage                Version\n---------------------- ----------\nasgiref                3.2.3\nastroid                2.3.3\natomicwrites           1.3.0\nattrs                  19.3.0\ncertifi                2019.11.28\n\u2026\nMarkupSafe             1.1.1\nmccabe                 0.6.1\nmore-itertools         8.1.0\nmysql-connector-python 8.0.19\nmysqlclient            1.4.6\npackaging              20.0\npip                    20.0.1\npipenv                 2018.11.26\n\u2026\n</code></pre> <ul> <li>ligne 13\u00a0: on a bien le package [mysql-connector-python]\u00a0; Pour savoir comment utiliser le package [mysql-connector-python] afin de g\u00e9rer une base de donn\u00e9es MySQL, on ira sur le site du package |https://dev.mysql.com/doc/connector-python/en/|. La suite pr\u00e9sente une s\u00e9rie d'exemples.</li> </ul>"},{"location":"utilisation-du-sgbd-mysql.html#163-script-mysql_01-connexion-a-une-base-mysql-1","title":"16.3. script [mysql_01]\u00a0: connexion \u00e0 une base MySQL - 1","text":"<p>Le script [mysql_01] pr\u00e9sente la premi\u00e8re \u00e9tape de l'utilisation d'une base de donn\u00e9es. Il va nous permettre de v\u00e9rifier qu'on est capables de se connecter \u00e0 la base [dbpersonnes] cr\u00e9\u00e9e pr\u00e9c\u00e9demment.</p> <pre><code># import du module mysql.connector\nfrom mysql.connector import connect, DatabaseError, InterfaceError\n\n# connexion \u00e0 une base MySql [dbpersonnes]\n# l'identit\u00e9 de l'utilisateur est (admpersonnes,nobody)\nUSER = \"admpersonnes\"\nPWD = \"nobody\"\nHOST = \"localhost\"\nDATABASE = \"dbpersonnes\"\n\n# c'est parti\nconnexion = None\ntry:\n    print(\"Connexion au SGBD MySQL en cours...\")\n    # connexion\n    connexion = connect(host=HOST, user=USER, password=PWD, database=DATABASE)\n    # suivi\n    print(\n        f\"Connexion MySQL r\u00e9ussie \u00e0 la base database={DATABASE}, host={HOST} sous l'identit\u00e9 user={USER}, passwd={PWD}\")\nexcept (InterfaceError, DatabaseError) as erreur:\n    # on affiche l'erreur\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\nfinally:\n    # on ferme la connexion si elle a \u00e9t\u00e9 ouverte\n    if connexion:\n        connexion.close()\n</code></pre> <p>Notes</p> <ul> <li>ligne 2\u00a0: on importe certaines fonctions et classes du module [mysql.connector]\u00a0;</li> <li>lignes 6-7\u00a0: les identifiants de l'utilisateur qui va se connecter\u00a0;</li> <li>ligne 8\u00a0: la machine qui h\u00e9berge la base de donn\u00e9es. En effet, le connecteur MySQL permet de travailler avec une base distante\u00a0;</li> <li>ligne 9\u00a0: le nom de la base de donn\u00e9es \u00e0 laquelle on veut se connecter\u00a0;</li> <li>lignes 11-26\u00a0: le script va connecter (ligne 16) l'utilisateur [admpersonnes / nobody] \u00e0 la base de donn\u00e9es [dbpersonnes]\u00a0;</li> <li>lignes 20-26\u00a0: la connexion peut \u00e9chouer. Aussi la fait-on dans un try / except / finally\u00a0;</li> <li>ligne 16\u00a0: la m\u00e9thode connect du module [mysq.connector] admet diff\u00e9rents param\u00e8tres nomm\u00e9s\u00a0:</li> <li>user\u00a0: utilisateur propri\u00e9taire de la connexion [admpersonnes]\u00a0;</li> <li>password\u00a0: mot de passe de l'utilisateur [nobody]\u00a0;</li> <li>host\u00a0: machine du SGBD MySQL [localhost]\u00a0;</li> <li>database\u00a0: la base de donn\u00e9es \u00e0 laquelle on se connecte. Optionnel.</li> <li>ligne 20\u00a0: si une exception est lanc\u00e9e, elle est de type [DatabaseError]\u00a0ou [InterfaceError]\u00a0;</li> <li>lignes 23-26\u00a0: dans la clause [finally], on ferme la connexion\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/mysql/mysql_01.py\nConnexion au SGBD MySQL en cours...\nConnexion MySQL r\u00e9ussie \u00e0 la base database=dbpersonnes, host=localhost sous l'identit\u00e9 user=admpersonnes, passwd=nobody\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"utilisation-du-sgbd-mysql.html#164-script-mysql_02-connexion-a-une-base-mysql-2","title":"16.4. script [mysql_02]\u00a0: connexion \u00e0 une base MySQL - 2","text":"<p>Dans ce nouveau script, la connexion \u00e0 la base est isol\u00e9e dans une fonction\u00a0:</p> <pre><code># import du module mysql.connector\nfrom mysql.connector import DatabaseError, InterfaceError, connect\n\n\n# ---------------------------------------------------------------------------------\ndef connexion(host: str, database: str, login: str, pwd: str):\n    # connecte puis d\u00e9connecte (login,pwd) de la base [database] du serveur [host]\n    # lance l'exception DatabaseError si probl\u00e8me\n    connexion = None\n    try:\n        # connexion\n        connexion = connect(host=host, user=login, password=pwd, database=database)\n        print(\n            f\"Connexion r\u00e9ussie \u00e0 la base database={database}, host={host} sous l'identit\u00e9 user={login}, passwd={pwd}\")\n    finally:\n        # on ferme la connexion si elle a \u00e9t\u00e9 ouverte\n        if connexion:\n            connexion.close()\n            print(\"D\u00e9connexion r\u00e9ussie\\n\")\n\n\n# ---------------------------------------------- main\n# identifiants de la connexion\nUSER = \"admpersonnes\"\nPASSWD = \"nobody\"\nHOST = \"localhost\"\nDATABASE = \"dbpersonnes\"\n\n# connexion d'un utilisateur existant\ntry:\n    connexion(host=HOST, login=USER, pwd=PASSWD, database=DATABASE)\nexcept (InterfaceError, DatabaseError) as erreur:\n    # on affiche l'erreur\n    print(erreur)\n\n# connexion d'un utilisateur inexistant\ntry:\n    connexion(host=HOST, login=\"xx\", pwd=\"xx\", database=DATABASE)\nexcept (InterfaceError, DatabaseError) as erreur:\n    # on affiche l'erreur\n    print(erreur)\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>lignes 6-19\u00a0: une fonction [connexion] qui tente de connecter puis de d\u00e9connecter un utilisateur \u00e0 la base de donn\u00e9es [dbpersonnes]. Affiche le r\u00e9sultat\u00a0;</li> <li>lignes 29-41\u00a0: programme principal \u2013 appelle deux fois la m\u00e9thode connexion et affiche les \u00e9ventuelles exceptions\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/mysql/mysql_02.py\nConnexion MySQL r\u00e9ussie \u00e0 la base database=dbpersonnes, host=localhost sous l'identit\u00e9 user=admpersonnes, passwd=nobody\nD\u00e9connexion MySQL r\u00e9ussie\n\n1045 (28000): Access denied for user 'xx'@'localhost' (using password: YES)\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"utilisation-du-sgbd-mysql.html#165-script-mysql_03-creation-dune-table-mysql","title":"16.5. script [mysql_03]\u00a0: cr\u00e9ation d'une table MySQL","text":"<p>Maintenant qu'on sait cr\u00e9er une connexion avec un SGBD MySQL, on commence \u00e0 \u00e9mettre des ordres SQL sur cette connexion. Pour cela, nous allons nous connecter \u00e0 la base cr\u00e9\u00e9e [dbpersonnes] et utiliser la connexion pour cr\u00e9er une table dans la base.</p> <pre><code># imports\nimport sys\n\nfrom mysql.connector import DatabaseError, InterfaceError, connect\nfrom mysql.connector.connection import MySQLConnection\n\n\n# ---------------------------------------------------------------------------------\ndef execute_sql(connexion: MySQLConnection, update: str):\n    # ex\u00e9cute une requ\u00eate de mise \u00e0 jour sur la connexion\n    curseur = None\n    try:\n        # on demande un curseur\n        curseur = connexion.cursor()\n        # ex\u00e9cute la requ\u00eate update sur la connexion\n        curseur.execute(update)\n    finally:\n        # fermeture du curseur s'il a \u00e9t\u00e9 obtenu\n        if curseur:\n            curseur.close()\n\n\n# ---------------------------------------------- main\n# identifiants de la connexion\n# l'identit\u00e9 de l'utilisateur\nID = \"admpersonnes\"\nPWD = \"nobody\"\n# la machine h\u00f4te du sgbd\nHOST = \"localhost\"\n# identit\u00e9 de la base\nDATABASE = \"dbpersonnes\"\n\n# on y va \u00e9tape par \u00e9tape\ntry:\n    # connexion\n    connexion = connect(host=HOST, user=ID, password=PWD, database=DATABASE)\n    # mode AUTOCOMMIT\n    connexion.autocommit = True\nexcept (InterfaceError, DatabaseError) as erreur:\n    # on affiche l'erreur\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\n    # on quitte\n    sys.exit()\n\n# suppression de la table personnes si elle existe\n# si elle n'existe pas une erreur se produira - on l'ignore\nrequ\u00eate = \"drop table personnes\"\ntry:\n    execute_sql(connexion, requ\u00eate)\nexcept (InterfaceError, DatabaseError):\n    pass\n\n# cr\u00e9ation de la table personnes\nrequ\u00eate = \"create table personnes (id int PRIMARY KEY, prenom varchar(30) NOT NULL, nom varchar(30) NOT NULL, age integer NOT NULL, \" \\\n          \"unique(nom,prenom)) \"\ntry:\n    # ex\u00e9cution requ\u00eate\n    execute_sql(connexion, requ\u00eate)\n    # affichage\n    print(f\"{requ\u00eate} : requ\u00eate r\u00e9ussie\")\nexcept (InterfaceError, DatabaseError) as erreur:\n    # on affiche l'erreur\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\nfinally:\n    # on se d\u00e9connecte\n    connexion.close()\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>ligne 9\u00a0: la fonction execute_sql ex\u00e9cute une requ\u00eate SQL sur une connexion ouverte\u00a0;</li> <li>ligne 14\u00a0: les op\u00e9rations SQL sur la connexion se font au travers d'un objet particulier appel\u00e9 curseur\u00a0;</li> <li>ligne 14\u00a0: obtention d'un curseur\u00a0;</li> <li>ligne 16\u00a0: ex\u00e9cution de la requ\u00eate SQL\u00a0;</li> <li>lignes 17-20\u00a0: qu'il y ait erreur ou non, le curseur est ferm\u00e9. Cela lib\u00e8re les ressources qui lui sont associ\u00e9es. Si exception il y a, alors elle n'est pas g\u00e9r\u00e9e ici. Elle va remonter au code appelant\u00a0;</li> <li>lignes 33-43\u00a0: cr\u00e9ation d'une connexion avec la base de donn\u00e9es\u00a0;</li> <li>ligne 38\u00a0: le mode AUTOCOMMIT=True pour une connexion signifie que chaque ex\u00e9cution d'une requ\u00eate s'ex\u00e9cute dans une transaction automatique. Le mode par d\u00e9faut est AUTOCOMMIT=False o\u00f9 c'est le d\u00e9veloppeur qui a la responsabilit\u00e9 de g\u00e9rer les transactions. Une transaction est un m\u00e9canisme qui englobe l'ex\u00e9cution de plusieurs requ\u00eates 1 \u00e0 n. Soit celles-ci r\u00e9ussissent toutes, soit aucune ne r\u00e9ussit. Ainsi si les requ\u00eates 1 \u00e0 i r\u00e9ussissent mais que la requ\u00eate i+1 \u00e9choue, alors les requ\u00eates 1 \u00e0 i vont \u00eatre 'd\u00e9faites' pour que la base retrouve l'\u00e9tat qu'elle avait avant l'ex\u00e9cution de la requ\u00eate 1\u00a0;</li> <li>ici, il y a deux requ\u00eates SQL (lignes 49, 58). Elles seront chacune ex\u00e9cut\u00e9es dans une transaction. Que la seconde \u00e9choue n'a aucun impact sur la premi\u00e8re\u00a0;</li> <li>lignes 45-51\u00a0: l'ordre SQL [drop table personnes] est ex\u00e9cut\u00e9. Elle supprime la table appel\u00e9e [personnes]. Si celle-ci n'existe pas, une erreur peut \u00eatre signal\u00e9e. Celle-ci est ignor\u00e9e (ligne 51)\u00a0;</li> <li>lignes 53-55\u00a0: l'ordre de cr\u00e9ation de la table [personnes]. Une table peut \u00eatre vue comme un ensemble de lignes et de colonnes. L'ordre de cr\u00e9ation pr\u00e9cise le nom des colonnes\u00a0:</li> <li>[id]\u00a0: un identifiant entier. Il sera unique pour chaque personne. Ce sera la cl\u00e9 primaire (PRIMARY KEY). Cela signifie que dans la table, cette colonne n\u2019a pas deux fois la m\u00eame valeur et qu\u2019elle peut \u00eatre utilis\u00e9e pour identifier une personne\u00a0;</li> <li>[nom]\u00a0: une cha\u00eene d'au plus 30 caract\u00e8res\u00a0;</li> <li>[prenom]\u00a0: une cha\u00eene d'au plus 30 caract\u00e8res\u00a0;</li> <li>[age]\u00a0: un nombre entier\u00a0;</li> <li>l'attribut [NOT NULL] pour chacune de ces colonnes signifie que dans une ligne de la table, aucune des trois colonnes ne peut \u00eatre vide\u00a0;</li> <li>le param\u00e8tre [unique(nom,prenom)] s'appelle une contrainte. Ici la contrainte sur les lignes est que le tuple (nom, prenom) de la ligne doit \u00eatre unique dans la table. Cela signifie qu'on peut rep\u00e9rer de fa\u00e7on unique dans la table, un individu dont on conna\u00eet les nom et pr\u00e9nom\u00a0;</li> <li>lignes 56-60\u00a0: ex\u00e9cution de l\u2019ordre SQL\u00a0;</li> <li>lignes 61-63\u00a0: gestion de l\u2019\u00e9ventuelle exception\u00a0;</li> <li>lignes 64-66\u00a0: on se d\u00e9connecte de la base de donn\u00e9es\u00a0; R\u00e9sultats</li> </ul> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/mysql/mysql_03.py\ncreate table personnes (id int PRIMARY KEY, prenom varchar(30) NOT NULL, nom varchar(30) NOT NULL, age integer NOT NULL, unique(nom,prenom))  : requ\u00eate r\u00e9ussie\n\nProcess finished with exit code 0\n</code></pre> <p>V\u00e9rification avec [phpMyAdmin]\u00a0:</p> <p></p> <ul> <li>la base de donn\u00e9es [dbpersonnes] [1] a une table [personnes] [2] qui a la structure [3-4], la cl\u00e9 primaire [5] et la contrainte d\u2019unicit\u00e9 [6]\u00a0;</li> </ul>"},{"location":"utilisation-du-sgbd-mysql.html#166-script-mysql_04-execution-dun-fichier-dordres-sql","title":"16.6. script [mysql_04]\u00a0: ex\u00e9cution d'un fichier d'ordres SQL","text":"<p>Apr\u00e8s avoir cr\u00e9\u00e9 pr\u00e9c\u00e9demment la table [personnes], maintenant nous la remplissons puis l'exploitons \u00e0 l'aide d'ordres SQL.</p> <p>Nous souhaitons ex\u00e9cuter les ordres SQL d'un fichier texte\u00a0:</p> <p></p> <p>Le contenu du fichier [commandes.sql] est le suivant\u00a0:</p> <pre><code># suppression de la table [personnes]\ndrop table personnes\n# cr\u00e9ation de la table personnes\ncreate table personnes (prenom varchar(30) not null, nom varchar(30) not null, age integer not null, primary key (nom,prenom))\n# insertion de deux personnes\ninsert into personnes(prenom, nom, age) values('Paul','Langevin',48)\ninsert into personnes(prenom, nom, age) values ('Sylvie','Lefur',70)\n# affichage de la table\nselect prenom, nom, age from personnes\n# erreur volontaire\nxx\n# insertion de trois personnes\ninsert into personnes(prenom, nom, age) values ('Pierre','Nicazou',35)\ninsert into personnes(prenom, nom, age) values ('Geraldine','Colou',26)\ninsert into personnes(prenom, nom, age) values ('Paulette','Girond',56)\n# affichage de la table\nselect prenom, nom, age from personnes\n# liste des personnes par ordre alphab\u00e9tique des noms et \u00e0 nom \u00e9gal par ordre alphab\u00e9tique des pr\u00e9noms\nselect nom,prenom from personnes order by nom asc, prenom desc\n# liste des personnes ayant un \u00e2ge dans l'intervalle [20,40] par ordre d\u00e9croissant de l'\u00e2ge\n# puis \u00e0 \u00e2ge \u00e9gal par ordre alphab\u00e9tique des noms et \u00e0 nom \u00e9gal par ordre alphab\u00e9tique des pr\u00e9noms\nselect nom,prenom,age from personnes where age between 20 and 40 order by age desc, nom asc, prenom asc\n# insertion de mme Bruneau\ninsert into personnes(prenom, nom, age) values('Josette','Bruneau',46)\n# mise \u00e0 jour de son \u00e2ge\nupdate personnes set age=47 where nom='Bruneau'\n# liste des personnes ayant Bruneau pour nom\nselect nom,prenom,age from personnes where nom='Bruneau'\n# suppression de Mme Bruneau\ndelete from personnes where nom='Bruneau'\n# liste des personnes ayant Bruneau pour nom\nselect nom,prenom,age from personnes where nom='Bruneau'\n</code></pre> <p>Nous d\u00e9finissons tout d'abord des fonctions que nous installons dans un module afin de pouvoir les r\u00e9utiliser\u00a0:</p> <p></p> <p>Le script [mysql_module] est le suivant\u00a0:</p> <pre><code># imports\nfrom mysql.connector import DatabaseError, InterfaceError\nfrom mysql.connector.connection import MySQLConnection\nfrom mysql.connector.cursor import MySQLCursor\n\n\n# ---------------------------------------------------------------------------------\ndef afficher_infos(curseur: MySQLCursor):\n    # affiche le r\u00e9sultat d'une command sql\n    \u2026\n\n\n# ---------------------------------------------------------------------------------\ndef execute_list_of_commands(connexion: MySQLConnection, sql_commands: list,\n                             suivi: bool = False, arr\u00eat: bool = True, with_transaction: bool = True):\n    # utilise la connexion ouverte [connexion]\n    # ex\u00e9cute sur cette connexion les commandes SQL contenues dans la liste [sql_commands]\n    # ce fichier est un fichier de commandes SQL \u00e0 ex\u00e9cuter \u00e0 raison d'une par ligne\n    # si suivi=True alors chaque ex\u00e9cution d'un ordre SQL fait l'objet d'un affichage indiquant sa r\u00e9ussite ou son \u00e9chec\n    # si arr\u00eat=True, la fonction s'arr\u00eate sur la 1\u00e8re erreur rencontr\u00e9e sinon elle ex\u00e9cute ttes les commandes sql\n    # si with_transaction=True alors toute erreur annule l'ensemble des ordres SQL ex\u00e9cut\u00e9s auparavant\n    # si with_transaction=False alors une erreur n'a aucun impact sur les ordres SQL ex\u00e9cut\u00e9s auparavant\n    # la fonction rend une liste [erreur1, erreur2, ...]\n\n    \u2026.\n\n\n# ---------------------------------------------------------------------------------\ndef execute_file_of_commands(connexion: MySQLConnection, sql_filename: str,\n                             suivi: bool = False, arr\u00eat: bool = True, with_transaction: bool = True):\n    # utilise la connexion ouverte [connexion]\n    # ex\u00e9cute sur cette connexion les commandes SQL contenues dans le fichier texte sql_filename\n    # ce fichier est un fichier de commandes SQL \u00e0 ex\u00e9cuter \u00e0 raison d'une par ligne\n    # si suivi=True alors chaque ex\u00e9cution d'un ordre SQL fait l'objet d'un affichage indiquant sa r\u00e9ussite ou son \u00e9chec\n    # si arr\u00eat=True, la fonction s'arr\u00eate sur la 1\u00e8re erreur rencontr\u00e9e sinon elle ex\u00e9cute ttes les commandes sql\n    # si with_transaction=True alors toute erreur annule l'ensemble des ordres SQL ex\u00e9cut\u00e9s auparavant\n    # si with_transaction=False alors une erreur n'a aucun impact sur les ordres SQL ex\u00e9cut\u00e9s auparavant\n    # la fonction rend une liste [erreur1, erreur2, ...]\n\n    # exploitation du fichier SQL\n    try:\n        # ouverture du fichier en lecture\n        file = open(sql_filename, \"r\")\n        # exploitation\n        return execute_list_of_commands(connexion, file.readlines(), suivi, arr\u00eat, with_transaction)\n    except BaseException as erreur:\n        # on rend un tableau d'erreurs\n        return [f\"Le fichier {sql_filename} n'a pu \u00eatre \u00eatre exploit\u00e9 : {erreur}\"]\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>ligne 29\u00a0: la fonction [execute_file_of_commands] ex\u00e9cute les ordres SQL contenu dans le fichier texte nomm\u00e9 [sql_filename]\u00a0:</li> <li>on lira les commentaires des lignes 31-38 pour conna\u00eetre la signification des param\u00e8tres\u00a0;</li> <li>lignes 40-48\u00a0: on exploite le fichier texte [sql_filename]\u00a0;</li> <li>ligne 43\u00a0: ouverture du fichier\u00a0;</li> <li>ligne 34\u00a0: ex\u00e9cution de la fonction [execute_list_of_commands] qui ex\u00e9cute les commandes SQL qu'on lui passe dans une liste. Cette liste est ici constitu\u00e9e par la liste de toutes les lignes du fichier texte [file.readlines()]\u00a0(ligne 45)\u00a0; La fonction [execute_list_of_commands] est la suivante\u00a0:</li> </ul> <pre><code># ---------------------------------------------------------------------------------\ndef execute_list_of_commands(connexion: MySQLConnection, sql_commands: list,\n                             suivi: bool = False, arr\u00eat: bool = True, with_transaction: bool = True):\n    # utilise la connexion ouverte [connexion]\n    # ex\u00e9cute sur cette connexion les commandes SQL contenues dans la liste [sql_commands]\n    # ce fichier est un fichier de commandes SQL \u00e0 ex\u00e9cuter \u00e0 raison d'une par ligne\n    # si suivi=True alors chaque ex\u00e9cution d'un ordre SQL fait l'objet d'un affichage indiquant sa r\u00e9ussite ou son \u00e9chec\n    # si arr\u00eat=True, la fonction s'arr\u00eate sur la 1\u00e8re erreur rencontr\u00e9e sinon elle ex\u00e9cute ttes les commandes sql\n    # si with_transaction=True alors toute erreur annule l'ensemble des ordres SQL ex\u00e9cut\u00e9s auparavant\n    # si with_transaction=False alors une erreur n'a aucun impact sur les ordres SQL ex\u00e9cut\u00e9s auparavant\n    # la fonction rend une liste [erreur1, erreur2, ...]\n\n    # initialisations\n    curseur = None\n    connexion.autocommit = not with_transaction\n    erreurs = []\n    try:\n        # on demande un curseur\n        curseur = connexion.cursor()\n        # ex\u00e9cution des sql_commands SQL contenues dans sql_commands\n        # on les ex\u00e9cute une \u00e0 une\n        for command in sql_commands:\n            # on \u00e9limine les blancs de d\u00e9but et de fin de la commande courante\n            command = command.strip()\n            # a-t-on une commande vide ou un commentaire ? Si oui, on passe \u00e0 la commande suivante\n            if command == '' or command[0] == \"#\":\n                continue\n            # ex\u00e9cution de la commande courante\n            error = None\n            try:\n                curseur.execute(command)\n            except (InterfaceError, DatabaseError) as erreur:\n                error = erreur\n            # y-a-t-il eu une erreur ?\n            if error:\n                # une erreur de plus\n                msg = f\"{command} : Erreur ({error})\"\n                erreurs.append(msg)\n                # suivi \u00e9cran ou non ?\n                if suivi:\n                    print(msg)\n                # on s'arr\u00eate ?\n                if with_transaction or arr\u00eat:\n                    # on rend la liste d'erreurs\n                    return erreurs\n            else:\n                # pas d'erreur\n                if suivi:\n                    print(f\"[{command}] : Ex\u00e9cution r\u00e9ussie\")\n                # on affiche le r\u00e9sultat de la command\n                afficher_infos(curseur)\n        # on rend le tableau des erreurs\n        return erreurs\n    finally:\n        # fermeture du curseur\n        if curseur:\n            curseur.close()\n        # on valide / annule la transaction si elle existe\n        if with_transaction:\n            if erreurs:\n                # annulation\n                connexion.rollback()\n            else:\n                # validation\n                connexion.commit()\n</code></pre> <p>Notes</p> <ul> <li>ligne 2\u00a0: la fonction [execute_list_of_commands] ex\u00e9cute les ordres SQL contenu dans la liste [sql_commands]\u00a0:</li> <li>on lira les commentaires des lignes 4-11 pour conna\u00eetre la signification des param\u00e8tres\u00a0;</li> <li>ligne 2\u00a0: la connexion re\u00e7ue est une connexion ouverte vers une base de donn\u00e9es\u00a0;</li> <li>ligne 15\u00a0: si on veut que l'ensemble des commandes de la liste [sql_commands] s'ex\u00e9cute au sein d'une transaction alors il faut travailler en mode AUTOCOMMIT=False. Sinon, on travaillera en  mode AUTOCOMMIT=True et alors chacune des commandes de la liste [sqlCommands] s'ex\u00e9cutera au sein d'une transaction automatique et il n'y aura pas de transaction globale\u00a0;</li> <li>ligne 19\u00a0: on demande un curseur pour ex\u00e9cuter les diff\u00e9rentes commandes SQL\u00a0;</li> <li>lignes 22-51\u00a0: on ex\u00e9cute les commandes une par une\u00a0;</li> <li>lignes 26-27\u00a0: on accepte les lignes blanches ainsi que les commentaires dans la liste des commandes SQL. Dans ce cas, on ignore simplement la commande\u00a0;</li> <li>lignes 30-33\u00a0: ex\u00e9cution de la requ\u00eate courante\u00a0;</li> <li>lignes 35-45\u00a0: on traite le cas d'une \u00e9ventuelle erreur d'ex\u00e9cution de la requ\u00eate courante\u00a0;</li> <li>lignes 37-38\u00a0: l'erreur est ajout\u00e9e au tableau des erreurs\u00a0;</li> <li>lignes 40-41\u00a0: si un suivi a \u00e9t\u00e9 demand\u00e9, alors le message d'erreur est affich\u00e9\u00a0;</li> <li>lignes 43-45\u00a0: si le code appelant a demand\u00e9 un arr\u00eat apr\u00e8s la premi\u00e8re erreur ou s'il a demand\u00e9 l'utilisation d'une transaction, alors il faut s'arr\u00eater. On rend le tableau des erreurs\u00a0;</li> <li>lignes 46-51\u00a0: cas o\u00f9 il n'y a pas eu d'erreur d'ex\u00e9cution de la requ\u00eate courante\u00a0;</li> <li>lignes 48-49\u00a0: si un suivi a \u00e9t\u00e9 demand\u00e9, on affiche la requ\u00eate ex\u00e9cut\u00e9e avec la mention 'r\u00e9ussie'\u00a0;</li> <li>lignes 50-51\u00a0: on affiche le r\u00e9sultat de la requ\u00eate ex\u00e9cut\u00e9e. On va revenir sur la fonction [afficher_infos] un peu plus loin\u00a0;</li> <li>lignes 54-65\u00a0: la clause [finally] est ex\u00e9cut\u00e9e dans tous les cas, qu'il y ait eu une exception ou pas\u00a0;</li> <li>lignes 56-57\u00a0: fermeture du curseur. Cela lib\u00e8re les ressources allou\u00e9es \u00e0 celui-ci\u00a0;</li> <li>lignes 59-65\u00a0: on traite le cas o\u00f9 le code appelant a demand\u00e9 \u00e0 ce que les commandes SQL soient ex\u00e9cut\u00e9es dans une transaction\u00a0;</li> <li>ligne 60\u00a0: on regarde si la liste [erreurs] est vide, ce qui signifie qu'aucune exception n'a eu lieu. Dans ce cas, la transaction est valid\u00e9e (ligne 65), sinon elle est annul\u00e9e (ligne 62)\u00a0; La fonction [afficher_infos] affiche le r\u00e9sultat d'une requ\u00eate\u00a0:</li> </ul> <pre><code># ---------------------------------------------------------------------------------\ndef afficher_infos(curseur: MySQLCursor):\n    print(type(curseur))\n    # affiche le r\u00e9sultat d'une command sql\n    # s'agissait-il d'un select ?\n    if curseur.description:\n        # le curseur a une description - donc il a ex\u00e9cut\u00e9 un select\n        # description[i] est la description de la colonne n\u00b0 i du select\n        # description[i][0] est le nom de la colonne n\u00b0 i du select\n        # on affiche les noms des champs\n        titre = \"\"\n        for i in range(len(curseur.description)):\n            titre += curseur.description[i][0] + \", \"\n        # on affiche la liste des champs sans la virgule de fin\n        print(titre[0:len(titre) - 1])\n        # ligne s\u00e9paratrice\n        print(\"*\" * (len(titre) - 1))\n        # ligne courante du select\n        ligne = curseur.fetchone()\n        while ligne:\n            # on l'affiche\n            print(ligne)\n            # ligne suivante du select\n            ligne = curseur.fetchone()\n        # ligne s\u00e9paratrice\n        print(\"*\" * (len(titre) - 1))\n    else:\n        # le curseur n'a pas de champ [description] - il a donc ex\u00e9cut\u00e9 un ordre SQL\n        # de mise \u00e0 jour (insert, delete, update)\n        print(f\"nombre de lignes modifi\u00e9es : {curseur.rowcount}\")\n</code></pre> <p>Notes</p> <ul> <li>ligne 1\u00a0: le param\u00e8tre de la fonction est le curseur qui vient d'ex\u00e9cuter un ordre SQL. Selon que cet ordre est un SELECT ou un ordre de mise \u00e0 jour INSERT, UPDATE, DELETE, le contenu du curseur n'est pas le m\u00eame\u00a0;</li> <li>ligne 6\u00a0: si le curseur a le champ [description] alors il a ex\u00e9cut\u00e9 un SELECT et [description] d\u00e9crit les champs demand\u00e9s dans le SELECT\u00a0:</li> <li>description[i] d\u00e9crit le champ n\u00b0 i demand\u00e9 par le SELECT. C'est une liste\u00a0;</li> <li>description[i][0] est le nom du champ n\u00b0 i\u00a0;</li> <li>lignes 11-17\u00a0: on affiche le nom des champs demand\u00e9s par le SELECT\u00a0;</li> <li>lignes 18-24\u00a0: on exploite le r\u00e9sultat du SELECT\u00a0;</li> <li>lignes 20, 24\u00a0: le r\u00e9sultat d'un SELECT s'exploite s\u00e9quentiellement. Ce r\u00e9sultat est un ensemble de lignes. La ligne courante est obtenue par [curseur.fetchone()] (ligne 19). On obtient alors un tuple\u00a0;</li> <li>lignes 27-30\u00a0:  si le curseur n'a pas le champ [description] alors il a ex\u00e9cut\u00e9 un ordre de mise \u00e0 jour  INSERT, UPDATE, DELETE. On peut alors savoir combien de lignes de la table ont \u00e9t\u00e9 modifi\u00e9es par l'ex\u00e9cution de cet ordre\u00a0;</li> <li>ligne 30\u00a0: [curseur.rowcount] est ce nombre\u00a0; Le script principal [mysql-04] utilise le module [mysql_module] que nous venons de d\u00e9crire\u00a0:</li> </ul> <p></p> <p>Le fichier [config_04] configure le contexte d\u2019ex\u00e9cution du script [mysql_04]\u00a0:</p> <pre><code>def configure():\n    import os\n\n    # chemin absolu du dossier du fichier de configuration\n    script_dir = os.path.dirname(os.path.abspath(__file__))\n    # configuration des dossiers du syspath\n    absolute_dependencies = [\n        # dossiers locaux\n        f\"{script_dir}/shared\",\n    ]\n\n    # fixation du syspath\n    from myutils import set_syspath\n    set_syspath(absolute_dependencies)\n\n    # on rend la config\n    return {\n        # fichier des commandes SQL\n        \"commands_filename\": f\"{script_dir}/data/commandes.sql\",\n        # identifiants de la connexion \u00e0 la base de donn\u00e9es\n        \"host\": \"localhost\",\n        \"database\": \"dbpersonnes\",\n        \"user\": \"admpersonnes\",\n        \"password\": \"nobody\"\n    }\n</code></pre> <p>Le script [mysql_04] est le suivant\u00a0:</p> <pre><code># on r\u00e9cup\u00e8re la configuration de l'application\nimport config_04\n\nconfig = config_04.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nimport sys\nfrom mysql_module import execute_file_of_commands\nfrom mysql.connector import connect, DatabaseError, InterfaceError\n\n# ---------------------------------------------- main\n# v\u00e9rification de la syntaxe de l'appel\n# argv[0] true / false\nargs = sys.argv\nerreur = len(args) != 2\nif not erreur:\n    with_transaction = args[1].lower()\n    erreur = with_transaction != \"true\" and with_transaction != \"false\"\n# erreur ?\nif erreur:\n    print(f\"syntaxe : {args[0]} true / false\")\n    sys.exit()\n\n# calcul d'un texte\nwith_transaction = with_transaction == \"true\"\nif with_transaction:\n    texte = \"avec transaction\"\nelse:\n    texte = \"sans transaction\"\n\n# logs \u00e9cran\nprint(\"--------------------------------------------------------------------\")\nprint(f\"Ex\u00e9cution du fichier SQL {config['commands_filename']} {texte}\")\nprint(\"--------------------------------------------------------------------\")\n\n# ex\u00e9cution des ordres SQL du fichier\nconnexion = None\ntry:\n    # connexion \u00e0 la bd\n    connexion = connect(host=config['host'], user=config['user'], password=config['password'],\n                        database=config['database'])\n    # ex\u00e9cution du fichier des commandes SQL\n    erreurs = execute_file_of_commands(connexion, config[\"commands_filename\"], suivi=True, arr\u00eat=False,\n                                       with_transaction=with_transaction)\nexcept (InterfaceError, DatabaseError) as erreur:\n    # affichage de l'erreur\n    print(f\"L'erreur fatale suivante s'est produite : {erreur}\")\n    # on s'arr\u00eate\n    sys.exit()\nfinally:\n    # fermeture de la connexion si elle a \u00e9t\u00e9 ouverte\n    if connexion:\n        connexion.close()\n\n# affichage nombre d'erreurs\nprint(\"--------------------------------------------------------------------\")\nprint(f\"Ex\u00e9cution termin\u00e9e\")\nprint(\"--------------------------------------------------------------------\")\nprint(f\"Il y a eu {len(erreurs)} erreur(s)\")\n# affichage des erreurs\nfor erreur in erreurs:\n    print(erreur)\n</code></pre> <p>Notes</p> <ul> <li>lignes 1-4\u00a0: configuration du script\u00a0;</li> <li>ligne 8\u00a0: import du module [mysql_module] d\u00e9crit pr\u00e9c\u00e9demment\u00a0:</li> <li>lignes 12-22\u00a0: le script [mysql-04] attend un param\u00e8tre qui doit avoir l'une des valeurs [true / false]. Ce param\u00e8tre indique si le fichier d'ordres SQL doit \u00eatre ex\u00e9cut\u00e9 au sein d'une transaction (true) ou pas (false)\u00a0;</li> <li>ligne 14\u00a0: les param\u00e8tres pass\u00e9s par l'utilisateur au script sont trouv\u00e9s dans la liste [sys.argv]\u00a0;</li> <li>ligne 15\u00a0: il faut deux param\u00e8tres, par exemple [mysql-04 true]. Le nom du script compte comme un param\u00e8tre\u00a0;</li> <li>lignes 17-18\u00a0: s'il y a bien deux param\u00e8tres, il faut que le 2e soit une cha\u00eene de caract\u00e8res de valeur 'true' ou 'false'\u00a0;</li> <li>lignes 24-29\u00a0: calcul d'un texte affich\u00e9 ligne 33\u00a0;</li> <li>lignes 39-44\u00a0: on ex\u00e9cute les commandes du fichier [./data/commandes.sql]\u00a0;</li> <li>lignes 45-49\u00a0: s\u2019il se produit une erreur \u00e0 la connexion (ligne 40) ou non g\u00e9r\u00e9e par le script [execute_file_of_commands] on affiche l\u2019erreur et on arr\u00eate tout\u00a0;</li> <li>lignes 55-62\u00a0: en cas d\u2019ex\u00e9cution r\u00e9ussie, on affiche le nombre d\u2019erreurs rencontr\u00e9es dans l\u2019ex\u00e9cution des commandes SQL\u00a0; Ex\u00e9cution n\u00b0 1</li> </ul> <p>On fait d'abord une ex\u00e9cution sans transaction. Pour cela, on va cr\u00e9er une configuration d'ex\u00e9cution\u00a0comme il a \u00e9t\u00e9 fait dans le paragraphe |configuration d\u2019un contexte d\u2019ex\u00e9cution|:</p> <p></p> <ul> <li>en [1-4], on cr\u00e9e une configuration d'ex\u00e9cution\u00a0Python\u00a0;</li> </ul> <p></p> <ul> <li>[5]\u00a0: nom de la configuration d'x\u00e9cution\u00a0;</li> <li>[6]\u00a0: chemin du script \u00e0 ex\u00e9cuter\u00a0;</li> <li>[7]\u00a0\u00a0: param\u00e8tres du script\u00a0;</li> <li>[8]\u00a0: dossier d\u2019ex\u00e9cution\u00a0; Cette configuration correspond donc \u00e0 une ex\u00e9cution du fichier SQL avec une transaction. Utiliser le bouton [Apply] pour valider la configuration.</li> </ul> <p>Nous cr\u00e9ons de la m\u00eame fa\u00e7on la configuration d'ex\u00e9cution [mysql mysql-04 without_transaction]\u00a0:</p> <p></p> <p>Cette configuration correspond donc \u00e0 une ex\u00e9cution du fichier SQL sans transaction. Utiliser le bouton [Apply] pour valider la configuration.</p> <p>Nous ex\u00e9cutons d'abord la version sans transaction\u00a0:</p> <p></p> <p>Les r\u00e9sultats sont alors les suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/mysql/mysql_04.py false\n--------------------------------------------------------------------\nEx\u00e9cution du fichier SQL C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\databases\\mysql/data/commandes.sql sans transaction\n--------------------------------------------------------------------\n[drop table personnes] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 0\n[create table personnes (id int primary key, prenom varchar(30) not null, nom varchar(30) not null, age integer not null, unique (nom,prenom))] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 0\n[insert into personnes(id, prenom, nom, age) values(1, 'Paul','Langevin',48)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[insert into personnes(id, prenom, nom, age) values (2, 'Sylvie','Lefur',70)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[select prenom, nom, age from personnes] : Ex\u00e9cution r\u00e9ussie\nprenom, nom, age,\n*****************\n('Paul', 'Langevin', 48)\n('Sylvie', 'Lefur', 70)\n*****************\nxx : Erreur (1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'xx' at line 1)\n[insert into personnes(id, prenom, nom, age) values (3, 'Pierre','Nicazou',35)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[insert into personnes(id, prenom, nom, age) values (4, 'Geraldine','Colou',26)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[insert into personnes(id, prenom, nom, age) values (5, 'Paulette','Girond',56)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[select prenom, nom, age from personnes] : Ex\u00e9cution r\u00e9ussie\nprenom, nom, age,\n*****************\n('Paul', 'Langevin', 48)\n('Sylvie', 'Lefur', 70)\n('Pierre', 'Nicazou', 35)\n('Geraldine', 'Colou', 26)\n('Paulette', 'Girond', 56)\n*****************\n[select nom,prenom from personnes order by nom asc, prenom desc] : Ex\u00e9cution r\u00e9ussie\nnom, prenom,\n************\n('Colou', 'Geraldine')\n('Girond', 'Paulette')\n('Langevin', 'Paul')\n('Lefur', 'Sylvie')\n('Nicazou', 'Pierre')\n************\n[select nom,prenom,age from personnes where age between 20 and 40 order by age desc, nom asc, prenom asc] : Ex\u00e9cution r\u00e9ussie\nnom, prenom, age,\n*****************\n('Nicazou', 'Pierre', 35)\n('Colou', 'Geraldine', 26)\n*****************\n[insert into personnes(id, prenom, nom, age) values(6, 'Josette','Bruneau',46)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[update personnes set age=47 where nom='Bruneau'] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[select nom,prenom,age from personnes where nom='Bruneau'] : Ex\u00e9cution r\u00e9ussie\nnom, prenom, age,\n*****************\n('Bruneau', 'Josette', 47)\n*****************\n[delete from personnes where nom='Bruneau'] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[select nom,prenom,age from personnes where nom='Bruneau'] : Ex\u00e9cution r\u00e9ussie\nnom, prenom, age,\n*****************\n*****************\n--------------------------------------------------------------------\nEx\u00e9cution termin\u00e9e\n--------------------------------------------------------------------\nIl y a eu 1 erreur(s)\nxx : Erreur (1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'xx' at line 1)\n\nProcess finished with exit code 0\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>ligne 19\u00a0: on voit qu'apr\u00e8s l'erreur l'ex\u00e9cution des ordres SQL a continu\u00e9, ceci parce que l'ex\u00e9cution s'est faite sans transaction et avec le param\u00e8tre [arr\u00eat=False]. Tous les ordres SQL ont donc \u00e9t\u00e9 ex\u00e9cut\u00e9s. On devrait donc avoir une table [personnes] refl\u00e9tant cette ex\u00e9cution\u00a0; V\u00e9rification avec phpMyAdmin\u00a0:</li> </ul> <p></p> <p>Ex\u00e9cution n\u00b0 2</p> <p>Nous ex\u00e9cutons maintenant la configuration [mysql mysql-04 with_transaction]. Les r\u00e9sultats sont les suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/mysql/mysql_04.py true\n--------------------------------------------------------------------\nEx\u00e9cution du fichier SQL C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\databases\\mysql/data/commandes.sql avec transaction\n--------------------------------------------------------------------\n[drop table personnes] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 0\n[create table personnes (id int primary key, prenom varchar(30) not null, nom varchar(30) not null, age integer not null, unique (nom,prenom))] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 0\n[insert into personnes(id, prenom, nom, age) values(1, 'Paul','Langevin',48)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[insert into personnes(id, prenom, nom, age) values (2, 'Sylvie','Lefur',70)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[select prenom, nom, age from personnes] : Ex\u00e9cution r\u00e9ussie\nprenom, nom, age,\n*****************\n('Paul', 'Langevin', 48)\n('Sylvie', 'Lefur', 70)\n*****************\nxx : Erreur (1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'xx' at line 1)\n--------------------------------------------------------------------\nEx\u00e9cution termin\u00e9e\n--------------------------------------------------------------------\nIl y a eu 1 erreur(s)\nxx : Erreur (1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'xx' at line 1)\n\nProcess finished with exit code 0\n</code></pre> <p>Notes\u00a0:</p> <ul> <li>ligne 19\u00a0: on voit qu'apr\u00e8s l'erreur il n'y a plus d'ex\u00e9cution d'ordres SQL, ceci parce que l'ex\u00e9cution s'est faite dans une transaction et qu'\u00e0 la 1re erreur rencontr\u00e9e nous avons d\u00e9fait la transaction et arr\u00eat\u00e9 l'ex\u00e9cution des ordres SQL. Ceci signifie que le r\u00e9sultat des ordres des lignes 9, 11, 13 a \u00e9t\u00e9 d\u00e9fait. On devrait donc avoir une table [personnes] vide\u00a0; V\u00e9rifications avec phpMyAdmin\u00a0:</li> </ul> <p></p> <ul> <li>en [5], on voit que la table [personnes] [2] est vide\u00a0;</li> </ul>"},{"location":"utilisation-du-sgbd-mysql.html#167-script-mysql_05-utilisation-de-requetes-parametrees","title":"16.7. script [mysql_05]\u00a0: utilisation de requ\u00eates param\u00e9tr\u00e9es","text":"<p>Le script  [mysql_05] introduit la notion de requ\u00eates param\u00e9tr\u00e9es\u00a0:</p> <pre><code># imports\nfrom mysql.connector import connect, DatabaseError, InterfaceError\n\n# l'identit\u00e9 de l'utilisateur\nID = \"admpersonnes\"\nPWD = \"nobody\"\n# la machine h\u00f4te du sgbd\nHOST = \"localhost\"\n# identit\u00e9 de la base\nBASE = \"dbpersonnes\"\n\n# liste de personnes (nom,prenom,age)\npersonnes = []\nfor i in range(5):\n    personnes.append((i, f\"n0{i}\", f\"p0{i}\", i + 10))\npersonnes.append((40, \"d'Aboot\", \"Y'\u00e9na\", 18))\n# autre liste de personnes\nautresPersonnes = []\nfor i in range(5):\n    autresPersonnes.append((i + 100, f\"n1{i}\", f\"p1{i}\", i + 20))\nautresPersonnes.append((200, \"d'Aboot\", \"F'ilhem\", 34))\n\n# acc\u00e8s au SGBD\nconnexion = None\ntry:\n    # connexion\n    connexion = connect(host=HOST, user=ID, password=PWD, database=BASE)\n    # curseur\n    curseur = connexion.cursor()\n    # suppression des enregistrement existants\n    curseur.execute(\"delete from personnes\")\n    # insertions personne par personne avec une requ\u00eate pr\u00e9par\u00e9e\n    for personne in personnes:\n        curseur.execute(\"insert into personnes(id,nom,prenom,age) values(%s,%s,%s,%s)\", personne)\n    # insertion en bloc d'une liste de personnes\n    curseur.executemany(\"insert into personnes(id,nom,prenom,age) values(%s, %s,%s,%s)\", autresPersonnes)\n    # validation de la transaction\n    connexion.commit()\nexcept (DatabaseError, InterfaceError) as erreur:\n    # affichage erreur\n    print(f\"L'erreur suivante s'est produite : {erreur}\")\n    # annulation transaction\n    if connexion:\n        connexion.rollback()\nfinally:\n    # fermeture connexion\n    if connexion:\n        connexion.close()\n</code></pre> <p>Notes</p> <ul> <li>lignes 12-21\u00a0: on cr\u00e9e deux listes de personnes \u00e0 inclure dans la base de donn\u00e9es [dbpersonnes]\u00a0;</li> <li>ligne 27\u00a0: connexion \u00e0 la base de donn\u00e9es\u00a0;</li> <li>ligne 31\u00a0: suppression du contenu de la table [personnes]\u00a0;</li> <li>lignes 33-34\u00a0: insertion de personnes avec une requ\u00eate param\u00e9tr\u00e9e. Ligne 34, le 1er param\u00e8tre est l'ordre SQL \u00e0 ex\u00e9cuter. Celui-ci est incomplet. Il contient des param\u00e8tres [%s] qui vont \u00eatre remplac\u00e9s un par un et dans l'ordre par les valeurs de la liste du second param\u00e8tre\u00a0;</li> <li> <p>ligne 36\u00a0: insertion de personnes avec cette fois une seule instruction [curseur.executemany]. Le second param\u00e8tre de [executemany] est alors une liste de listes\u00a0; L'int\u00e9r\u00eat des requ\u00eates param\u00e9tr\u00e9es r\u00e9side en deux points\u00a0:</p> </li> <li> <p>elles sont ex\u00e9cut\u00e9es plus rapidement que des requ\u00eates en 'dur' qu'il faut analyser \u00e0 chaque ex\u00e9cution. La requ\u00eate param\u00e9tr\u00e9e [executemany] n'est analys\u00e9e qu'une fois. Ensuite elle est ex\u00e9cut\u00e9e n fois sans \u00eatre analys\u00e9e de nouveau\u00a0;</p> </li> <li>les param\u00e8tres inject\u00e9s dans la requ\u00eate param\u00e9tr\u00e9e sont v\u00e9rifi\u00e9s. S'ils contiennent des caract\u00e8res r\u00e9serv\u00e9s, comme l'apostrophe par exemple, ceux-ci sont 'prot\u00e9g\u00e9s' afin qu'ils n'interf\u00e8rent pas dans l'ex\u00e9cution de l'ordre SQL. C\u2019est pour v\u00e9rifier ce point qu\u2019on a inclus des noms et pr\u00e9noms avec apostrophes dans la liste (lignes 16 et 21)\u00a0; Les r\u00e9sultats obtenus dans phpMyAdmin sont les suivants\u00a0:</li> </ul> <p></p> <ul> <li>on notera que les cha\u00eenes ayant une apostrophe, caract\u00e8re r\u00e9serv\u00e9 en SQL, ont \u00e9t\u00e9 correctement ins\u00e9r\u00e9es. La requ\u00eate  param\u00e9tr\u00e9e les a 'prot\u00e9g\u00e9es'. Sans requ\u00eate param\u00e9tr\u00e9e, il aurait fallu faire ce travail nous-m\u00eames\u00a0;</li> </ul>"},{"location":"utilisation-du-sgbd-postgresql.html","title":"17. Utilisation du SGBD PostgreSQL","text":"<p>Le SGBD PostgreSQL est librement disponible. Il est une alternative \u00e0 la version 'community' de MySQL.</p> <p>Nous l'utilisons ici pour montrer qu'il est assez simple de migrer des scripts Python / MySQL vers des scripts Python / PostgreSQL.</p> <p>Avec le SGBD MySQL, l'architecture de nos scripts \u00e9tait la suivante\u00a0:</p> <p></p> <p>Avec le SGBD PostgreSQL, elle sera la suivante\u00a0:</p> <p></p>"},{"location":"utilisation-du-sgbd-postgresql.html#171-installation-du-sgbd-postgresql","title":"17.1. Installation du  SGBD PostgreSQL","text":"<p>Les distributions du SGBD PostgreSQL sont disponibles \u00e0 l\u2019URL [https://www.postgresql.org/download/] (mai 2019). Nous montrons l\u2019installation de la version pour Windows 64 bits\u00a0:</p> <p></p> <p></p> <ul> <li>en [1-4], on t\u00e9l\u00e9charge l\u2019installateur du SGBD\u00a0; On lance l\u2019installateur t\u00e9l\u00e9charg\u00e9\u00a0:</li> </ul> <p></p> <ul> <li>en [6], indiquez un dossier d\u2019installation\u00a0;</li> </ul> <p></p> <ul> <li>en [8], l\u2019option [Stack Builder] est inutile pour ce qu\u2019on veut faire ici\u00a0;</li> <li>en [10], laissez la valeur qui vous sera pr\u00e9sent\u00e9e\u00a0;</li> </ul> <p></p> <ul> <li>en [12-13], on a mis ici le mot de passe [root]. Ce sera le mot de passe de l\u2019administrateur du SGBD qui s\u2019appelle [postgres]. PostgreSQL l\u2019appelle \u00e9galement le super-utilisateur\u00a0;</li> <li>en [15], laissez la valeur par d\u00e9faut\u00a0: c\u2019est le port d\u2019\u00e9coute du SGBD\u00a0;</li> </ul> <p></p> <ul> <li>en [17], laissez la valeur par d\u00e9faut\u00a0;</li> <li>en [19], le r\u00e9sum\u00e9 de la configuration de l\u2019installation\u00a0;</li> </ul> <p></p> <p></p> <p>Sous windows, le SGBD PostgreSQL est install\u00e9 comme un service windows lanc\u00e9 automatiquement. La plupart du temps ce n\u2019est pas souhaitable. Nous allons modifier cette configuration. Tapez [services] dans la barre de recherche de Windows [24-26]\u00a0:</p> <p></p> <ul> <li>en [29], on voit que le service du SGBD PostgreSQL est en mode automatique. On change cela en acc\u00e9dant aux propri\u00e9t\u00e9s du service [30]\u00a0:</li> </ul> <p></p> <ul> <li>en [31-32], mettez le d\u00e9marrage en mode manuel\u00a0;</li> <li>en [33], arr\u00eatez le service\u00a0; Lorsque vous voudrez d\u00e9marrer manuellement le SGBD, revenez \u00e0 l\u2019application [services], cliquez droit sur le service [postgresql] (34) et lancez le (35).</li> </ul>"},{"location":"utilisation-du-sgbd-postgresql.html#172-administrer-postgresql-avec-loutil-pgadmin","title":"17.2. Administrer PostgreSQL avec l\u2019outil [pgAdmin]","text":"<p>Lancez le service windows du SGBD PostgreSQL (paragraphe pr\u00e9c\u00e9dent). Puis de la m\u00eame fa\u00e7on que vous avez lanc\u00e9 l\u2019outil [services], lancez l\u2019outil [pgadmin] qui permet d\u2019administrer le SGBD PostgreSQL [1-3]\u00a0:</p> <p></p> <p>Il est possible qu\u2019\u00e0 un moment donn\u00e9 on vous demande le mot de passe du super-utilisateur. Celui-ci s\u2019appelle [postgres]. Vous avez d\u00e9fini son mot de passe lors de l\u2019installation du SGBD. Dans ce document, nous avons donn\u00e9 le mot de passe [root] au super-utilisateur lors de l\u2019installation.</p> <ul> <li>en [4], [pgAdmin] est une application web\u00a0;</li> <li>en [5], la liste des serveurs PostgreSQL d\u00e9tect\u00e9s par [pgAdmin], ici 1\u00a0;</li> <li>en [6], le serveur PostgreSQL que nous avons lanc\u00e9\u00a0;</li> <li>en [7], les bases de donn\u00e9es du SGBD, ici 1\u00a0;</li> <li>en [8], la base [postgresql] est g\u00e9r\u00e9e par le super-utilisateur [postgres]\u00a0; Cr\u00e9ons tout d\u2019abord un utilisateur [admpersonnes] avec le mot de passe [nobody]\u00a0:</li> </ul> <p></p> <p></p> <ul> <li>en [17], on a mis [nobody]\u00a0;</li> </ul> <p></p> <ul> <li>en [21], le code SQL que va \u00e9mettre l\u2019outil [pgAdmin] vers le SGBD PostgreSQL. C\u2019est une fa\u00e7on d\u2019apprendre le langage SQL propri\u00e9taire de PostgreSQL\u00a0;</li> <li>en [22], apr\u00e8s validation de l\u2019assistant [Save], l\u2019utilisateur [admpersonnes] a \u00e9t\u00e9 cr\u00e9\u00e9\u00a0; Maintenant nous cr\u00e9ons la base [dbpersonnes]\u00a0:</li> </ul> <p></p> <p>On clique droit sur [23], puis [24-25] pour cr\u00e9er une nouvelle base de donn\u00e9es. Dans l\u2019onglet [26], on d\u00e9finit le nom de la base [27] et son propri\u00e9taire [admpersonnes] [28].</p> <p></p> <ul> <li>en [30], le code SQL de cr\u00e9ation de la base\u00a0;</li> <li>en [31], apr\u00e8s validation de l\u2019assistant [Save], la base [dbpersonnes] est cr\u00e9\u00e9e\u00a0; Nous allons exploiter la base [dbpersonnes] avec des scripts Python.</li> </ul>"},{"location":"utilisation-du-sgbd-postgresql.html#173-installation-du-connecteur-python-du-sgbd-postgresql","title":"17.3. Installation du connecteur Python du SGBD PostgreSQL","text":"<p>Dans le sch\u00e9ma ci-dessus est repr\u00e9sent\u00e9 un connecteur faisant le lien entre les scripts Python et le SGBD PostgreSQL. Il en existe plusieurs. Nous installons le connecteur [psycopg2]. Cela se fait dans un terminal Python (peu importe le dossier dans lequel est ouvert ce terminal). Le connecteur est install\u00e9 par la commande [pip install psycopg2]\u00a0:</p> <pre><code>(venv) C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\troiscouches\\v01\\tests&gt;pip install psycopg2\nCollecting psycopg2\n  Downloading psycopg2-2.8.5-cp38-cp38-win_amd64.whl (1.1 MB)\n     || 1.1 MB 3.2 MB/s\nInstalling collected packages: psycopg2\nSuccessfully installed psycopg2-2.8.5\n</code></pre>"},{"location":"utilisation-du-sgbd-postgresql.html#174-portage-des-scripts-mysql-vers-des-scripts-postgresql","title":"17.4. Portage des scripts MySQL vers des scripts PostgreSQL","text":"<ul> <li>le dossier [1] des scripts MySQL est dupliqu\u00e9 (Ctrl-C / Ctrl-V), puis les noms des fichiers sont chang\u00e9s mais par leur contenu\u00a0;</li> </ul>"},{"location":"utilisation-du-sgbd-postgresql.html#1741-module-pgres_module","title":"17.4.1. module [pgres_module]","text":"<p>Ce module est la copie du module [mysql_module] (cf paragraphe |script [mysql-04]\u00a0: ex\u00e9cution d'un fichier d'ordres SQL|). On change les imports\u00a0:</p> <p>Au lieu de\u00a0:</p> <pre><code># imports\nfrom mysql.connector import DatabaseError, InterfaceError\nfrom mysql.connector.connection import MySQLConnection\nfrom mysql.connector.cursor import MySQLCursor\n</code></pre> <p>on \u00e9crit\u00a0:</p> <pre><code># imports\nfrom psycopg2 import DatabaseError, InterfaceError\nfrom psycopg2.extensions import connection, cursor\n</code></pre> <p>La signature de la fonction [afficher_infos] \u00e9tait\u00a0:</p> <pre><code>def afficher_infos(curseur: MySQLCursor):\n</code></pre> <p>Elle devient\u00a0:</p> <pre><code>def afficher_infos(curseur: cursor)\n</code></pre> <p>La signature de la fonction [execute_list_of_commands] \u00e9tait\u00a0:</p> <pre><code>def execute_list_of_commands(connexion: MySQLConnection, sql_commands: list,\n                             suivi: bool = False, arr\u00eat: bool = True, with_transaction: bool = True)\n</code></pre> <p>Elle devient\u00a0:</p> <pre><code>def execute_list_of_commands(connexion: connection, sql_commands: list,\n                             suivi: bool = False, arr\u00eat: bool = True, with_transaction: bool = True):\n</code></pre> <p>Sinon rien d\u2019autre ne change.</p>"},{"location":"utilisation-du-sgbd-postgresql.html#1742-script-pgres_01","title":"17.4.2. script [pgres_01]","text":"<p>Le script [pgres_01] est la copie du script [mysql_01] (cf paragraphe |script [mysql-01]\u00a0: connexion \u00e0 une base MySQL - 1|). On y fait les modifications suivantes\u00a0:</p> <p>Au lieu de\u00a0:</p> <pre><code># import du module mysql.connector\nfrom mysql.connector import connect, DatabaseError, InterfaceError\n</code></pre> <p>on \u00e9crit\u00a0:</p> <pre><code># import du module psycopg2\nfrom psycopg2 import connect, DatabaseError, InterfaceError\n</code></pre> <p>Le reste ne change pas. Les r\u00e9sultats sont les m\u00eames qu'avec MySQL.</p>"},{"location":"utilisation-du-sgbd-postgresql.html#1743-script-pgres_02","title":"17.4.3. script [pgres_02]","text":"<p>Le script [pgres_02] est la copie du script [mysql_02] (cf paragraphe |script [mysql-02]\u00a0: connexion \u00e0 une base MySQL - 2|). On y fait les modifications suivantes\u00a0:</p> <p>Au lieu de\u00a0:</p> <pre><code># import du module mysql.connector\nfrom mysql.connector import DatabaseError, InterfaceError, connect\n</code></pre> <p>on \u00e9crit\u00a0:</p> <pre><code># import du module psycopg2\nfrom psycopg2 import DatabaseError, InterfaceError, connect\n</code></pre> <p>Les r\u00e9sultats ne sont pas les m\u00eames que ceux du script [mysql_02]\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/postgresql/pgres_02.py\nConnexion MySQL r\u00e9ussie \u00e0 la base database=dbpersonnes, host=localhost sous l'identit\u00e9 user=admpersonnes, passwd=nobody\nD\u00e9connexion MySQL r\u00e9ussie\n\nProcess finished with exit code 0\n</code></pre> <p>Le script [pgres_02] est le suivant\u00a0:</p> <pre><code># import du module mysql.connector\nfrom psycopg2 import DatabaseError, InterfaceError, connect\n\n\n# ---------------------------------------------------------------------------------\ndef connexion(host: str, database: str, login: str, pwd: str):\n    # connecte puis d\u00e9connecte (login,pwd) de la base [database] du serveur [host]\n    # lance l'exception DatabaseError si probl\u00e8me\n    connexion = None\n    try:\n        # connexion\n        connexion = connect(host=host, user=login, password=pwd, database=database)\n        print(\n            f\"Connexion r\u00e9ussie \u00e0 la base database={database}, host={host} sous l'identit\u00e9 user={login}, passwd={pwd}\")\n    finally:\n        # on ferme la connexion si elle a \u00e9t\u00e9 ouverte\n        if connexion:\n            connexion.close()\n            print(\"D\u00e9connexion r\u00e9ussie\\n\")\n\n\n# ---------------------------------------------- main\n# identifiants de la connexion\nUSER = \"admpersonnes\"\nPASSWD = \"nobody\"\nHOST = \"localhost\"\nDATABASE = \"dbpersonnes\"\n\n# connexion d'un utilisateur existant\ntry:\n    connexion(host=HOST, login=USER, pwd=PASSWD, database=DATABASE)\nexcept (InterfaceError, DatabaseError) as erreur:\n    # on affiche l'erreur\n    print(erreur)\n\n# connexion d'un utilisateur inexistant\ntry:\n    connexion(host=HOST, login=\"xx\", pwd=\"yy\", database=DATABASE)\nexcept (InterfaceError, DatabaseError) as erreur:\n    # on affiche l'erreur\n    print(erreur)\n</code></pre> <p>Alors que les lignes 36-41 auraient d\u00fb afficher un message d'erreur indiquant que la connexion au SGBD avait \u00e9chou\u00e9, rien n'est affich\u00e9. En fait lorsqu'on creuse la question, on voit qu'on passe bien dans le [except] des lignes 35-37 mais que la variable [erreur] vaut [None]. Ceci avec la versions 2.8.4 du connecteur [psycopg2].</p> <p>On peut contourner ce probl\u00e8me en \u00e9crivant un message g\u00e9n\u00e9rique mais moins pr\u00e9cis\u00a0:</p> <pre><code># connexion d'un utilisateur inexistant\ntry:\n    connexion(host=HOST, login=\"xx\", pwd=\"yy\", database=DATABASE)\nexcept (InterfaceError, DatabaseError) as erreur:\n    # on affiche l'erreur\n    print(f\"Erreur de connexion \u00e0 la base [{DATABASE}] par l'utilisateur [xx/yy]\")\n</code></pre> <p>Les r\u00e9sultats sont alors les suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/postgresql/pgres_02.py\nConnexion r\u00e9ussie \u00e0 la base database=dbpersonnes, host=localhost sous l'identit\u00e9 user=admpersonnes, passwd=nobody\nD\u00e9connexion r\u00e9ussie\n\nErreur de connexion \u00e0 la base [dbpersonnes] par l'utilisateur [xx/yy]\n\nProcess finished with exit code 0\n</code></pre>"},{"location":"utilisation-du-sgbd-postgresql.html#1744-script-pgres_03","title":"17.4.4. script [pgres_03]","text":"<p>Le script [pgres_03] est la copie du script [mysql_03] (cf paragraphe |script [mysql-03]\u00a0: cr\u00e9ation d'une table MySQL|). On y fait les modifications suivantes\u00a0:</p> <p>Au lieu de\u00a0:</p> <pre><code>from mysql.connector import DatabaseError, InterfaceError, connect\nfrom mysql.connector.connection import MySQLConnection\n</code></pre> <p>on \u00e9crit\u00a0:</p> <pre><code>from psycopg2 import DatabaseError, InterfaceError, connect\nfrom psycopg2.extensions import connection\n</code></pre> <p>Par ailleurs, la signature de la fonction [execute_sql] qui \u00e9tait\u00a0:</p> <pre><code>def execute_sql(connexion: MySQLConnection, update: str):\n</code></pre> <p>devient\u00a0:</p> <pre><code>def execute_sql(connexion: connection, update: str):\n</code></pre> <p>Le reste ne change pas. Le r\u00e9sultat est le suivant\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/postgresql/pgres_03.py\ncreate table personnes (id int PRIMARY KEY, prenom varchar(30) NOT NULL, nom varchar(30) NOT NULL, age integer NOT NULL, unique(nom,prenom))  : requ\u00eate r\u00e9ussie\n\nProcess finished with exit code 0\n</code></pre> <p>On peut v\u00e9rifier la pr\u00e9sence de la table [personnes] avec l'outil d'administration [pgAdmin]\u00a0:</p> <p></p>"},{"location":"utilisation-du-sgbd-postgresql.html#1745-script-pgres_04","title":"17.4.5. script [pgres_04]","text":"<p>Le script [pgres_04] est une copie du script [mysql_04] (cf paragraphe |script [mysql-04]\u00a0: ex\u00e9cution d'un fichier d'ordres SQL|). Il utilise le module [pgres_module]\u00a0:</p> <pre><code># on r\u00e9cup\u00e8re la configuration de l'application\nimport config_04\n\nconfig = config_04.configure()\n\n# le syspath est configur\u00e9 - on peut faire les imports\nimport sys\nfrom pgres_module import execute_file_of_commands\nfrom psycopg2 import connect, DatabaseError, InterfaceError\n</code></pre> <p>Le reste ne change pas.</p> <p>On cr\u00e9e une configuration [pgres pgres-04 without_transaction] comme il a \u00e9t\u00e9 fait au paragraphe |script [mysql-04]\u00a0: ex\u00e9cution d'un fichier d'ordres SQL|. On cr\u00e9e de m\u00eame une configuration [pgres pgres-04 with_transaction].</p> <p>L'ex\u00e9cution de la configuration [pgres pgres-04 without_transaction] donne les r\u00e9sultats suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/postgresql/pgres_04.py false\n--------------------------------------------------------------------\nEx\u00e9cution du fichier SQL C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\databases\\postgresql/data/commandes.sql sans transaction\n--------------------------------------------------------------------\n[drop table if exists personnes] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : -1\n[create table personnes (id int primary key, prenom varchar(30) not null, nom varchar(30) not null, age integer not null, unique (nom,prenom))] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : -1\n[insert into personnes(id, prenom, nom, age) values(1, 'Paul','Langevin',48)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[insert into personnes(id, prenom, nom, age) values (2, 'Sylvie','Lefur',70)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[select prenom, nom, age from personnes] : Ex\u00e9cution r\u00e9ussie\nprenom, nom, age,\n*****************\n('Paul', 'Langevin', 48)\n('Sylvie', 'Lefur', 70)\n*****************\nxx : Erreur (ERREUR:  erreur de syntaxe sur ou pr\u00e8s de \u00ab xx \u00bb\nLINE 1: xx\n        ^\n)\n[insert into personnes(id, prenom, nom, age) values (3, 'Pierre','Nicazou',35)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[insert into personnes(id, prenom, nom, age) values (4, 'Geraldine','Colou',26)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[insert into personnes(id, prenom, nom, age) values (5, 'Paulette','Girond',56)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[select prenom, nom, age from personnes] : Ex\u00e9cution r\u00e9ussie\nprenom, nom, age,\n*****************\n('Paul', 'Langevin', 48)\n('Sylvie', 'Lefur', 70)\n('Pierre', 'Nicazou', 35)\n('Geraldine', 'Colou', 26)\n('Paulette', 'Girond', 56)\n*****************\n[select nom,prenom from personnes order by nom asc, prenom desc] : Ex\u00e9cution r\u00e9ussie\nnom, prenom,\n************\n('Colou', 'Geraldine')\n('Girond', 'Paulette')\n('Langevin', 'Paul')\n('Lefur', 'Sylvie')\n('Nicazou', 'Pierre')\n************\n[select nom,prenom,age from personnes where age between 20 and 40 order by age desc, nom asc, prenom asc] : Ex\u00e9cution r\u00e9ussie\nnom, prenom, age,\n*****************\n('Nicazou', 'Pierre', 35)\n('Colou', 'Geraldine', 26)\n*****************\n[insert into personnes(id, prenom, nom, age) values(6, 'Josette','Bruneau',46)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[update personnes set age=47 where nom='Bruneau'] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[select nom,prenom,age from personnes where nom='Bruneau'] : Ex\u00e9cution r\u00e9ussie\nnom, prenom, age,\n*****************\n('Bruneau', 'Josette', 47)\n*****************\n[delete from personnes where nom='Bruneau'] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[select nom,prenom,age from personnes where nom='Bruneau'] : Ex\u00e9cution r\u00e9ussie\nnom, prenom, age,\n*****************\n*****************\n--------------------------------------------------------------------\nEx\u00e9cution termin\u00e9e\n--------------------------------------------------------------------\nIl y a eu 1 erreur(s)\nxx : Erreur (ERREUR:  erreur de syntaxe sur ou pr\u00e8s de \u00ab xx \u00bb\nLINE 1: xx\n        ^\n)\n\nProcess finished with exit code 0\n</code></pre> <ul> <li>ligne 5\u00a0: on a d\u00fb modifier la commande de suppression de la table [personnes]. Contrairement au connecteur de MySQL le connecteur de PostgreSQL lance une exception si la table \u00e0 supprimer n\u2019existe pas. La commande [drop table] a une variante [drop table if exists] qui ne lance pas d\u2019exception si la table n\u2019existe pas. Nous l\u2019avons utilis\u00e9e ici. C\u2019est un exemple o\u00f9 deux SGBD ne se comportent pas de la m\u00eame fa\u00e7on dans des situations analogues\u00a0; La table [personnes] dans l'outil [pgAdmin] est la suivante\u00a0:</li> </ul> <p></p> <p>L'ex\u00e9cution de la configuration [pgres pgres_04 with_transaction] donne les r\u00e9sultats suivants\u00a0:</p> <pre><code>C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\venv\\Scripts\\python.exe C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020/databases/postgresql/pgres_04.py true\n--------------------------------------------------------------------\nEx\u00e9cution du fichier SQL C:\\Data\\st-2020\\dev\\python\\cours-2020\\python3-flask-2020\\databases\\postgresql/data/commandes.sql avec transaction\n--------------------------------------------------------------------\n[drop table if exists personnes] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : -1\n[create table personnes (id int primary key, prenom varchar(30) not null, nom varchar(30) not null, age integer not null, unique (nom,prenom))] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : -1\n[insert into personnes(id, prenom, nom, age) values(1, 'Paul','Langevin',48)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[insert into personnes(id, prenom, nom, age) values (2, 'Sylvie','Lefur',70)] : Ex\u00e9cution r\u00e9ussie\nnombre de lignes modifi\u00e9es : 1\n[select prenom, nom, age from personnes] : Ex\u00e9cution r\u00e9ussie\nprenom, nom, age,\n*****************\n('Paul', 'Langevin', 48)\n('Sylvie', 'Lefur', 70)\n*****************\nxx : Erreur (ERREUR:  erreur de syntaxe sur ou pr\u00e8s de \u00ab xx \u00bb\nLINE 1: xx\n        ^\n)\n--------------------------------------------------------------------\nEx\u00e9cution termin\u00e9e\n--------------------------------------------------------------------\nIl y a eu 1 erreur(s)\nxx : Erreur (ERREUR:  erreur de syntaxe sur ou pr\u00e8s de \u00ab xx \u00bb\nLINE 1: xx\n        ^\n)\n\nProcess finished with exit code 0\n</code></pre> <p>La table [personnes] dans l'outil [pgAdmin] est la suivante\u00a0:</p> <p></p> <p>Ici, le r\u00e9sultat est diff\u00e9rent de celui obtenu avec MySQL. Si on ex\u00e9cute les scripts dans les m\u00eames conditions, \u00e7-\u00e0-d apr\u00e8s ex\u00e9cution du script sans transaction, on a les r\u00e9sultats suivants\u00a0:</p> <ul> <li>avec MySQL, la table [personnes] est vide\u00a0;</li> <li> <p>avec PostgreSQL, la table [personnes] ne l'est pas\u00a0; La diff\u00e9rence repose sur les fa\u00e7ons diff\u00e9rentes qu'ont ces deux SGBD de d\u00e9faire la transaction\u00a0:</p> </li> <li> <p>MySQL ne d\u00e9fait pas les ordres [drop table] et [create table]. On se retrouve avec une table [personnes] vide\u00a0;</p> </li> <li>PostgreSQL d\u00e9fait les ordres [drop table] et [create table]. On retrouve la table dans l'\u00e9tat o\u00f9 elle \u00e9tait avant l'ex\u00e9cution du script avec transaction\u00a0;</li> </ul>"},{"location":"utilisation-du-sgbd-postgresql.html#1746-script-pgres_05","title":"17.4.6. script [pgres_05]","text":"<p>Le script [pgres_05] est une copie du script [mysql_05] (cf paragraphe |script [mysql-05]\u00a0: utilisation de requ\u00eates param\u00e9tr\u00e9es|). Le script est modifi\u00e9 de la fa\u00e7on suivante\u00a0:</p> <p>Au lieu de\u00a0:</p> <pre><code># imports\nfrom mysql.connector import connect, DatabaseError, InterfaceError\n</code></pre> <p>on \u00e9crit\u00a0:</p> <pre><code># imports\nfrom psycopg2 import connect, DatabaseError, InterfaceError\n</code></pre> <p>Le reste ne change pas.</p> <p>Les r\u00e9sultats obtenus dans [pgAdmin] sont les suivants\u00a0:</p> <p></p>"},{"location":"utilisation-du-sgbd-postgresql.html#175-conclusion","title":"17.5. Conclusion","text":"<p>Le portage des scripts MySQL vers des scripts PostgreSQL s'est r\u00e9alis\u00e9 plut\u00f4t facilement. C'est une exception. Les deux SGBD ne supportent pas les m\u00eames r\u00e8gles de nommage des objets SQL (bases, tables, colonnes, contraintes, types des donn\u00e9es\u2026), ont des extensions SQL incompatibles\u2026 Pour assurer un portage simple, il faut s'en tenir dans les deux cas \u00e0 la norme SQL sans essayer d'utiliser les extensions propri\u00e9taires des SGBD. Cela se fait alors aux d\u00e9pens des performances.</p>"}]}