
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Introduction au langage Python 3 et au framework web Flask par l'exemple">
      
      
        <meta name="author" content="Serge Tahé">
      
      
        <link rel="canonical" href="https://stahe.github.io/python-flask-sept-2020/exercice-dapplication-version-8.html">
      
      
        <link rel="prev" href="exercice-dapplication-version-7.html">
      
      
        <link rel="next" href="du-dictionnaire-a-xml-et-vice-versa.html">
      
      
        
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>25. Exercice d’application : version 8 - Introduction au langage Python 3 et au framework web Flask par l'exemple</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="stylesheets/focus.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#25-exercice-dapplication-version-8" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Introduction au langage Python 3 et au framework web Flask par l&#39;exemple" class="md-header__button md-logo" aria-label="Introduction au langage Python 3 et au framework web Flask par l'exemple" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Introduction au langage Python 3 et au framework web Flask par l'exemple
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              25. Exercice d’application : version 8
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode sombre"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Passer au mode sombre" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode clair"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Passer au mode clair" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/stahe/python-flask-sept-2020" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Introduction au langage Python 3 et au framework web Flask par l&#39;exemple" class="md-nav__button md-logo" aria-label="Introduction au langage Python 3 et au framework web Flask par l'exemple" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Introduction au langage Python 3 et au framework web Flask par l'exemple
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/stahe/python-flask-sept-2020" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accueil
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="avant-propos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Avant-propos
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="installation-dx27un-environnement-de-travail.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Installation d&#x27;un environnement de travail
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-bases-de-python.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Les bases de Python
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-chaines-de-caracteres.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Les chaînes de caractères
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-exceptions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Les exceptions
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-fonctions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Les fonctions
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-fichiers-texte.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    7. Les fichiers texte
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application---version-1.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    8. Exercice d&#x27;application – version 1
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-imports.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    9. Les imports
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-2.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    10. Exercice d’application : version 2
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-3.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    11. Exercice d’application : version 3
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-classes-et-objets.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    12. Les classes et objets
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-classes-generiques-baseentity-et-myexception.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    13. Les classes génériques [BaseEntity] et [MyException]
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="architecture-en-couches-et-programmation-par-interfaces.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    14. Architecture en couches et programmation par interfaces
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application---version-4.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    15. Exercice d&#x27;application - version 4
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-du-sgbd-mysql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    16. Utilisation du SGBD MySQL
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-du-sgbd-postgresql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    17. Utilisation du SGBD PostgreSQL
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="ecrire-du-code-independant-du-sgbd.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    18. Ecrire du code indépendant du SGBD
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-de-lorm-sqlalchemy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    19. Utilisation de l’ORM SQLALCHEMY
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application-version-5.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    20. Exercice d&#x27;application : version 5
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="fonctions-internet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    21. Fonctions internet
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="services-web-avec-le-framework-flask.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    22. Services web avec le framework Flask
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-6.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    23. Exercice d’application : version 6
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-7.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    24. Exercice d’application : version 7
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    25. Exercice d’application : version 8
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="exercice-dapplication-version-8.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    25. Exercice d’application : version 8
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#251-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        25.1. Introduction
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#252-le-serveur-web" class="md-nav__link">
    <span class="md-ellipsis">
      
        25.2. Le serveur web
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="25.2. Le serveur web">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2521-la-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        25.2.1. La configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2522-le-script-principal-main" class="md-nav__link">
    <span class="md-ellipsis">
      
        25.2.2. Le script principal [main]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2523-le-controleur-index_controller" class="md-nav__link">
    <span class="md-ellipsis">
      
        25.2.3. Le contrôleur [index_controller]
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#253-le-client-web" class="md-nav__link">
    <span class="md-ellipsis">
      
        25.3. Le client web
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="25.3. Le client web">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2531-la-couche-dao" class="md-nav__link">
    <span class="md-ellipsis">
      
        25.3.1. La couche [dao]
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="25.3.1. La couche [dao]">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#25311-la-classe-impotsdaowithhttpsession" class="md-nav__link">
    <span class="md-ellipsis">
      
        25.3.1.1. La classe [ImpôtsDaoWithHttpSession]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25312-la-fonction-de-decodage-de-la-session-flask" class="md-nav__link">
    <span class="md-ellipsis">
      
        25.3.1.2. La fonction de décodage de la session Flask
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25313-la-classe-impotsdaowithhttpsessionfactory" class="md-nav__link">
    <span class="md-ellipsis">
      
        25.3.1.3. La classe [ImpôtsDaoWithHttpSessionFactory]
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2532-la-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        25.3.2. La configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2533-le-script-principal-du-client" class="md-nav__link">
    <span class="md-ellipsis">
      
        25.3.3. Le script principal du client
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2534-execution-du-client" class="md-nav__link">
    <span class="md-ellipsis">
      
        25.3.4. Exécution du client
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#254-tests-de-la-couche-dao" class="md-nav__link">
    <span class="md-ellipsis">
      
        25.4. Tests de la couche [dao]
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="du-dictionnaire-a-xml-et-vice-versa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    26. Du dictionnaire à XML et vice-versa
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-9.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    27. Exercice d’application : version 9
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-10.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    28. Exercice d’application : version 10
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-11.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    29. Exercice d’application : version 11
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    30. Exercice d’application : version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="clients-web-pour-les-services-json-et-xml-de-la-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    31. Clients web pour les services jSON et XML de la version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="le-mode-html-de-la-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    32. Le mode HTML de la version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-13.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    33. Exercice d’application : version 13
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-14.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    34. Exercice d’application : version 14
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-15.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    35. Exercice d’application : version 15
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-16.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    36. Exercice d’application : version 16
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-17.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    37. Exercice d’application : version 17
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-18.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    38. Exercice d’application : version 18
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="conclusion.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    39. Conclusion
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="25-exercice-dapplication-version-8">25. Exercice d’application : version 8</h1>
<h2 id="251-introduction">25.1. Introduction</h2>
<p>Nous allons écrire une nouvelle application client / serveur. La nouveauté du serveur est qu’il va gérer une session. Au lieu de mettre les données de l’administration fiscale dans un objet de portée <strong>[application]</strong>, on va les mettre dans un objet de portée <strong>[session]</strong>. Ce faisant, on régresse dans les performances du code. Lorsqu’un objet peut être partagé en lecture seule par tous les utilisateurs, il est préférable d’en faire un objet de portée <strong>[application]</strong> plutôt que de portée <strong>[session]</strong>. On gagne au minimum de la bande passante puisque qu’on diminue ainsi la taille du cookie de session. Mais nous voulons montrer une application client / serveur où le client et le serveur s’échangent un cookie de session.</p>
<p>L’architecture de l’application ne change pas :</p>
<p><img src="images/10000000000003BE000003E50F9DB416.png" style="width:11.082cm;height:11.531cm;" alt="Image" /></p>
<h2 id="252-le-serveur-web">25.2. Le serveur web</h2>
<p>L’arborescence des scripts du serveur est la suivante :</p>
<p><img src="images/100000000000019000000205E9DBED3E.png" style="width:4.631cm;height:5.98cm;" alt="Image" /></p>
<p>Le dossier <strong>[http-servers/03]</strong> est obtenu initialement par recopie du dossier <strong>[http-servers/02]</strong>. On procède ensuite à des modifications.</p>
<h3 id="2521-la-configuration">25.2.1. La configuration</h3>
<p>Elle est la même que dans la |<a href="#_Configuration_1"><u><u>version précédente</u></u></a>| avec quelques modifications dans le script <strong>[config]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1"># dépendances absolues</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="n">absolute_dependencies</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="c1"># dossiers du projet</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="c1"># BaseEntity, MyException</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/classes/02/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>        <span class="c1"># InterfaceImpôtsDao, InterfaceImpôtsMétier, InterfaceImpôtsUi</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/interfaces&quot;</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>        <span class="c1"># AbstractImpôtsdao, ImpôtsConsole, ImpôtsMétier</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/services&quot;</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="c1"># ImpotsDaoWithAdminDataInDatabase</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v05/services&quot;</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="c1"># AdminData, ImpôtsError, TaxPayer</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="c1"># Constantes, Tranches</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v05/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="c1"># index_controller</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../controllers&quot;</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="c1"># scripts [config_database, config_layers]</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="n">script_dir</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="c1"># Logger, SendAdminMail</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/http-servers/02/utilities&quot;</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 17 : on va réécrire un contrôleur pour la fonction <strong>[index]</strong> qui traite l’URL / ;</li>
<li>ligne 21 : on utilise les utilitaires de la |<a href="#_Les_utilitaires"><u><u>version précédente</u></u></a>| ;</li>
</ul>
<h3 id="2522-le-script-principal-main">25.2.2. Le script principal [main]</h3>
<p>Le nouveau script <strong>[main]</strong> amène quelques modifications au script principal <strong>[main]</strong> de la version précédente :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span>
<span class="normal"><a href="#__codelineno-1-3">3</a></span>
<span class="normal"><a href="#__codelineno-1-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># l&#39;application Flask peut démarrer</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="c1"># clé secrète de la session</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 4 : on crée une clé secrète pour l’application. On sait que celle-ci est nécessaire pour gérer les sessions ;
Ensuite, les données fiscale ne sont plus demandées dans le code de <strong>[main]</strong>. Les lignes suivantes sont supprimées :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1"># récupération des données de l&#39;administration fiscale</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="n">erreur</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>    <span class="c1"># admindata sera une donnée de portée application en lecture seule</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;admindata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_admindata</span><span class="p">()</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>    <span class="c1"># log de réussite</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[serveur] connexion à la base de données réussie</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="k">except</span> <span class="n">ImpôtsError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>    <span class="c1"># on note l&#39;erreur</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>    <span class="c1"># log d&#39;erreur</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>    <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>    <span class="c1"># console</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>    <span class="c1"># fichier de logs</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">log</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>    <span class="c1"># mail à l&#39;administrateur</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a>    <span class="n">send_adminmail</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Par ailleurs, le contrôleur <strong>[index_controller]</strong> admet un paramètre supplémentaire, la session Flask :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span>
<span class="normal"><a href="#__codelineno-3-3">3</a></span>
<span class="normal"><a href="#__codelineno-3-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">session</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="err">…</span><span class="o">.</span>        
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>        <span class="c1"># on fait exécuter la requête par un contrôleur</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>        <span class="n">résultat</span><span class="p">,</span> <span class="n">status_code</span> <span class="o">=</span> <span class="n">index_controller</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="2523-le-controleur-index_controller">25.2.3. Le contrôleur [index_controller]</h3>
<p>Le contrôleur <strong>[index_controller]</strong> gère désormais une session :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span>
<span class="normal"><a href="#__codelineno-4-29">29</a></span>
<span class="normal"><a href="#__codelineno-4-30">30</a></span>
<span class="normal"><a href="#__codelineno-4-31">31</a></span>
<span class="normal"><a href="#__codelineno-4-32">32</a></span>
<span class="normal"><a href="#__codelineno-4-33">33</a></span>
<span class="normal"><a href="#__codelineno-4-34">34</a></span>
<span class="normal"><a href="#__codelineno-4-35">35</a></span>
<span class="normal"><a href="#__codelineno-4-36">36</a></span>
<span class="normal"><a href="#__codelineno-4-37">37</a></span>
<span class="normal"><a href="#__codelineno-4-38">38</a></span>
<span class="normal"><a href="#__codelineno-4-39">39</a></span>
<span class="normal"><a href="#__codelineno-4-40">40</a></span>
<span class="normal"><a href="#__codelineno-4-41">41</a></span>
<span class="normal"><a href="#__codelineno-4-42">42</a></span>
<span class="normal"><a href="#__codelineno-4-43">43</a></span>
<span class="normal"><a href="#__codelineno-4-44">44</a></span>
<span class="normal"><a href="#__codelineno-4-45">45</a></span>
<span class="normal"><a href="#__codelineno-4-46">46</a></span>
<span class="normal"><a href="#__codelineno-4-47">47</a></span>
<span class="normal"><a href="#__codelineno-4-48">48</a></span>
<span class="normal"><a href="#__codelineno-4-49">49</a></span>
<span class="normal"><a href="#__codelineno-4-50">50</a></span>
<span class="normal"><a href="#__codelineno-4-51">51</a></span>
<span class="normal"><a href="#__codelineno-4-52">52</a></span>
<span class="normal"><a href="#__codelineno-4-53">53</a></span>
<span class="normal"><a href="#__codelineno-4-54">54</a></span>
<span class="normal"><a href="#__codelineno-4-55">55</a></span>
<span class="normal"><a href="#__codelineno-4-56">56</a></span>
<span class="normal"><a href="#__codelineno-4-57">57</a></span>
<span class="normal"><a href="#__codelineno-4-58">58</a></span>
<span class="normal"><a href="#__codelineno-4-59">59</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1"># import des dépendances</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="c1"># URL paramétrée : /?marié=xx&amp;enfants=yy&amp;salaire=zz</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">AdminData</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdminData</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a>    <span class="c1"># dépendances</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">TaxPayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaxPayer</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a>    <span class="c1"># au départ pas d&#39;erreurs</span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a>    <span class="n">erreurs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a>    <span class="err">…</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a>    <span class="c1"># des erreurs ?</span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a>    <span class="k">if</span> <span class="n">erreurs</span><span class="p">:</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a>        <span class="c1"># on rend une réponse d&#39;erreur au client</span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;erreurs&quot;</span><span class="p">:</span> <span class="n">erreurs</span><span class="p">}},</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a>    <span class="c1"># pas d&#39;erreurs, on peut travailler</span>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a>    <span class="c1"># on récupère la config associée au thread</span>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a>    <span class="n">thread_name</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">thread_name</span><span class="p">][</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="s2">&quot;logger&quot;</span><span class="p">]</span>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a>    <span class="c1"># on exécute la requête</span>
<a id="__codelineno-4-32" name="__codelineno-4-32"></a>    <span class="n">réponse</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-33" name="__codelineno-4-33"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-34" name="__codelineno-4-34"></a>        <span class="c1"># le cas le + simple - admindata est déjà en session</span>
<a id="__codelineno-4-35" name="__codelineno-4-35"></a>        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;client_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-36" name="__codelineno-4-36"></a>            <span class="c1"># on récupère les informations de la session</span>
<a id="__codelineno-4-37" name="__codelineno-4-37"></a>            <span class="n">client_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;client_id&#39;</span><span class="p">)</span>
<a id="__codelineno-4-38" name="__codelineno-4-38"></a>            <span class="n">admindata</span> <span class="o">=</span> <span class="n">AdminData</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;admindata&#39;</span><span class="p">))</span>
<a id="__codelineno-4-39" name="__codelineno-4-39"></a>            <span class="c1"># log</span>
<a id="__codelineno-4-40" name="__codelineno-4-40"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[index_controller] client [</span><span class="si">{</span><span class="n">client_id</span><span class="si">}</span><span class="s2">], données fiscales prises en session</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-41" name="__codelineno-4-41"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-42" name="__codelineno-4-42"></a>            <span class="c1"># récupération des données de l&#39;administration fiscale</span>
<a id="__codelineno-4-43" name="__codelineno-4-43"></a>            <span class="n">admindata</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_admindata</span><span class="p">()</span>
<a id="__codelineno-4-44" name="__codelineno-4-44"></a>            <span class="c1"># mise en session de admindata</span>
<a id="__codelineno-4-45" name="__codelineno-4-45"></a>            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;admindata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">admindata</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span>
<a id="__codelineno-4-46" name="__codelineno-4-46"></a>            <span class="c1"># on donne un n° au client et on met ce n° en session</span>
<a id="__codelineno-4-47" name="__codelineno-4-47"></a>            <span class="c1"># cela va nous permettre de le suivre dans les logs du serveur</span>
<a id="__codelineno-4-48" name="__codelineno-4-48"></a>            <span class="n">client_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
<a id="__codelineno-4-49" name="__codelineno-4-49"></a>            <span class="n">session</span><span class="p">[</span><span class="s1">&#39;client_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_id</span>
<a id="__codelineno-4-50" name="__codelineno-4-50"></a>            <span class="c1"># log</span>
<a id="__codelineno-4-51" name="__codelineno-4-51"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[index_controller] client [</span><span class="si">{</span><span class="n">client_id</span><span class="si">}</span><span class="s2">], données fiscales prises dans la couche dao</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-52" name="__codelineno-4-52"></a>        <span class="c1"># calcul de l&#39;impôt</span>
<a id="__codelineno-4-53" name="__codelineno-4-53"></a>        <span class="n">taxpayer</span> <span class="o">=</span> <span class="n">TaxPayer</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="n">marié</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="n">enfants</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="n">salaire</span><span class="p">})</span>
<a id="__codelineno-4-54" name="__codelineno-4-54"></a>        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;métier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">taxpayer</span><span class="p">,</span> <span class="n">admindata</span><span class="p">)</span>
<a id="__codelineno-4-55" name="__codelineno-4-55"></a>        <span class="c1"># on rend la réponse au client</span>
<a id="__codelineno-4-56" name="__codelineno-4-56"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">taxpayer</span><span class="o">.</span><span class="n">asdict</span><span class="p">()}},</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span>
<a id="__codelineno-4-57" name="__codelineno-4-57"></a>    <span class="k">except</span> <span class="p">(</span><span class="ne">BaseException</span><span class="p">,</span> <span class="n">ImpôtsError</span><span class="p">)</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-4-58" name="__codelineno-4-58"></a>        <span class="c1"># on rend la réponse au client</span>
<a id="__codelineno-4-59" name="__codelineno-4-59"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;erreurs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]}},</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 14 : le contrôleur reçoit la session courante du client web ;</li>
<li>lignes 35-38 : si le client a une session, alors celle-ci contient deux clés :</li>
<li><strong>[client_id]</strong> : un n° de client (ligne 37) ;</li>
<li><strong>[admindata]</strong> : les données de l’administration fiscale sous le forme d’un dictionnaire (ligne 38) ;</li>
<li>ligne 35 : on regarde si la session a une des deux clés attendues ;</li>
<li>lignes 42-51 : cas où la session du client n’a pas encore été initialisée ;</li>
<li>ligne 43 : on récupère les données de l’administration fiscale auprès de la couche <strong>[dao]</strong> ;</li>
<li>ligne 45 : ces données sont mises dans la session sous la forme d’un dictionnaire ;</li>
<li>ligne 48 : on affecte un n° aléatoire au client. Ce n° sera différent pour chaque client ;</li>
<li>ligne 49 : ce n° est mis en session ;</li>
<li>ligne 51 : on logue le fait que les données de l’administration fiscale ont été obtenues par la couche <strong>[dao]</strong>. Les accès à la couche <strong>[dao]</strong> sont en général coûteux. C’est pourquoi il faut les limiter. L’idée ici est d’obtenir une fois les données fiscales auprès de la couche <strong>[dao]</strong>, de les mettre en session et d’aller les chercher là lors des requêtes ultérieures du même client. On rappelle que ce n’est pas la meilleure solution. Les données fiscales de l’administration étant les mêmes pour tous les clients, leur place est dans un objet de portée application ;</li>
<li>lignes 35-40 : cas où la session du client a été initialisée lors d’une précédente requête ;</li>
<li>ligne 37 : on récupère le n° du client dans la session ;</li>
<li>ligne 38 : on récupère les données fiscales de l’administration dans la session ;</li>
<li>ligne 40 : on logue le fait que le client a obtenu les données fiscales de l’administration dans la session ;</li>
</ul>
<h2 id="253-le-client-web">25.3. Le client web</h2>
<p><img src="images/1000000000000208000001F24E91AAF1.png" style="width:6.01cm;height:5.74cm;" alt="Image" /></p>
<h3 id="2531-la-couche-dao">25.3.1. La couche [dao]</h3>
<h4 id="25311-la-classe-impotsdaowithhttpsession">25.3.1.1. La classe [ImpôtsDaoWithHttpSession]</h4>
<p>La couche <strong>[dao]</strong> est implémentée par la classe <strong>[</strong><strong>ImpôtsDaoWithHttpSession</strong><strong>]</strong> suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span>
<span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span>
<span class="normal"><a href="#__codelineno-5-28">28</a></span>
<span class="normal"><a href="#__codelineno-5-29">29</a></span>
<span class="normal"><a href="#__codelineno-5-30">30</a></span>
<span class="normal"><a href="#__codelineno-5-31">31</a></span>
<span class="normal"><a href="#__codelineno-5-32">32</a></span>
<span class="normal"><a href="#__codelineno-5-33">33</a></span>
<span class="normal"><a href="#__codelineno-5-34">34</a></span>
<span class="normal"><a href="#__codelineno-5-35">35</a></span>
<span class="normal"><a href="#__codelineno-5-36">36</a></span>
<span class="normal"><a href="#__codelineno-5-37">37</a></span>
<span class="normal"><a href="#__codelineno-5-38">38</a></span>
<span class="normal"><a href="#__codelineno-5-39">39</a></span>
<span class="normal"><a href="#__codelineno-5-40">40</a></span>
<span class="normal"><a href="#__codelineno-5-41">41</a></span>
<span class="normal"><a href="#__codelineno-5-42">42</a></span>
<span class="normal"><a href="#__codelineno-5-43">43</a></span>
<span class="normal"><a href="#__codelineno-5-44">44</a></span>
<span class="normal"><a href="#__codelineno-5-45">45</a></span>
<span class="normal"><a href="#__codelineno-5-46">46</a></span>
<span class="normal"><a href="#__codelineno-5-47">47</a></span>
<span class="normal"><a href="#__codelineno-5-48">48</a></span>
<span class="normal"><a href="#__codelineno-5-49">49</a></span>
<span class="normal"><a href="#__codelineno-5-50">50</a></span>
<span class="normal"><a href="#__codelineno-5-51">51</a></span>
<span class="normal"><a href="#__codelineno-5-52">52</a></span>
<span class="normal"><a href="#__codelineno-5-53">53</a></span>
<span class="normal"><a href="#__codelineno-5-54">54</a></span>
<span class="normal"><a href="#__codelineno-5-55">55</a></span>
<span class="normal"><a href="#__codelineno-5-56">56</a></span>
<span class="normal"><a href="#__codelineno-5-57">57</a></span>
<span class="normal"><a href="#__codelineno-5-58">58</a></span>
<span class="normal"><a href="#__codelineno-5-59">59</a></span>
<span class="normal"><a href="#__codelineno-5-60">60</a></span>
<span class="normal"><a href="#__codelineno-5-61">61</a></span>
<span class="normal"><a href="#__codelineno-5-62">62</a></span>
<span class="normal"><a href="#__codelineno-5-63">63</a></span>
<span class="normal"><a href="#__codelineno-5-64">64</a></span>
<span class="normal"><a href="#__codelineno-5-65">65</a></span>
<span class="normal"><a href="#__codelineno-5-66">66</a></span>
<span class="normal"><a href="#__codelineno-5-67">67</a></span>
<span class="normal"><a href="#__codelineno-5-68">68</a></span>
<span class="normal"><a href="#__codelineno-5-69">69</a></span>
<span class="normal"><a href="#__codelineno-5-70">70</a></span>
<span class="normal"><a href="#__codelineno-5-71">71</a></span>
<span class="normal"><a href="#__codelineno-5-72">72</a></span>
<span class="normal"><a href="#__codelineno-5-73">73</a></span>
<span class="normal"><a href="#__codelineno-5-74">74</a></span>
<span class="normal"><a href="#__codelineno-5-75">75</a></span>
<span class="normal"><a href="#__codelineno-5-76">76</a></span>
<span class="normal"><a href="#__codelineno-5-77">77</a></span>
<span class="normal"><a href="#__codelineno-5-78">78</a></span>
<span class="normal"><a href="#__codelineno-5-79">79</a></span>
<span class="normal"><a href="#__codelineno-5-80">80</a></span>
<span class="normal"><a href="#__codelineno-5-81">81</a></span>
<span class="normal"><a href="#__codelineno-5-82">82</a></span>
<span class="normal"><a href="#__codelineno-5-83">83</a></span>
<span class="normal"><a href="#__codelineno-5-84">84</a></span>
<span class="normal"><a href="#__codelineno-5-85">85</a></span>
<span class="normal"><a href="#__codelineno-5-86">86</a></span>
<span class="normal"><a href="#__codelineno-5-87">87</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1"># imports</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">decode_flask_session</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">AbstractImpôtsDao</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbstractImpôtsDao</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">AdminData</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdminData</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceImpôtsMétier</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceImpôtsMétier</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">TaxPayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaxPayer</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">ImpôtsDaoWithHttpSession</span><span class="p">(</span><span class="n">AbstractImpôtsDao</span><span class="p">,</span> <span class="n">InterfaceImpôtsMétier</span><span class="p">):</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a>    <span class="c1"># constructeur</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a>        <span class="c1"># initialisation parent</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a>        <span class="n">AbstractImpôtsDao</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a>        <span class="c1"># mémorisation éléments de la configuration</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a>        <span class="c1"># config générale</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a>        <span class="c1"># serveur</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">]</span>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a>        <span class="c1"># mode debug</span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__debug</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">]</span>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a>        <span class="c1"># logger</span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a>        <span class="c1"># cookies</span>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__cookies</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-31" name="__codelineno-5-31"></a>
<a id="__codelineno-5-32" name="__codelineno-5-32"></a>    <span class="c1"># méthode inutilisée</span>
<a id="__codelineno-5-33" name="__codelineno-5-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_admindata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AdminData</span><span class="p">:</span>
<a id="__codelineno-5-34" name="__codelineno-5-34"></a>        <span class="k">pass</span>
<a id="__codelineno-5-35" name="__codelineno-5-35"></a>
<a id="__codelineno-5-36" name="__codelineno-5-36"></a>    <span class="c1"># calcul de l&#39;impôt</span>
<a id="__codelineno-5-37" name="__codelineno-5-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_tax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taxpayer</span><span class="p">:</span> <span class="n">TaxPayer</span><span class="p">,</span> <span class="n">admindata</span><span class="p">:</span> <span class="n">AdminData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-5-38" name="__codelineno-5-38"></a>        <span class="c1"># on laisse remonter les exceptions</span>
<a id="__codelineno-5-39" name="__codelineno-5-39"></a>        <span class="c1"># paramètres du get</span>
<a id="__codelineno-5-40" name="__codelineno-5-40"></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="n">taxpayer</span><span class="o">.</span><span class="n">marié</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="n">taxpayer</span><span class="o">.</span><span class="n">enfants</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="n">taxpayer</span><span class="o">.</span><span class="n">salaire</span><span class="p">}</span>
<a id="__codelineno-5-41" name="__codelineno-5-41"></a>        <span class="c1"># connexion avec authentification Auth Basic ?</span>
<a id="__codelineno-5-42" name="__codelineno-5-42"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span><span class="p">[</span><span class="s1">&#39;authBasic&#39;</span><span class="p">]:</span>
<a id="__codelineno-5-43" name="__codelineno-5-43"></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-5-44" name="__codelineno-5-44"></a>                <span class="c1"># URL du serveur interrogé</span>
<a id="__codelineno-5-45" name="__codelineno-5-45"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span><span class="p">[</span><span class="s1">&#39;urlServer&#39;</span><span class="p">],</span>
<a id="__codelineno-5-46" name="__codelineno-5-46"></a>                <span class="c1"># paramètres de l&#39;URL</span>
<a id="__codelineno-5-47" name="__codelineno-5-47"></a>                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
<a id="__codelineno-5-48" name="__codelineno-5-48"></a>                <span class="c1"># authentification Basic</span>
<a id="__codelineno-5-49" name="__codelineno-5-49"></a>                <span class="n">auth</span><span class="o">=</span><span class="p">(</span>
<a id="__codelineno-5-50" name="__codelineno-5-50"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;login&quot;</span><span class="p">],</span>
<a id="__codelineno-5-51" name="__codelineno-5-51"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;password&quot;</span><span class="p">]),</span>
<a id="__codelineno-5-52" name="__codelineno-5-52"></a>                <span class="n">cookies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__cookies</span><span class="p">)</span>
<a id="__codelineno-5-53" name="__codelineno-5-53"></a>
<a id="__codelineno-5-54" name="__codelineno-5-54"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-55" name="__codelineno-5-55"></a>            <span class="c1"># connexion sans authentification Auth Basic</span>
<a id="__codelineno-5-56" name="__codelineno-5-56"></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span><span class="p">[</span><span class="s1">&#39;urlServer&#39;</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__cookies</span><span class="p">)</span>
<a id="__codelineno-5-57" name="__codelineno-5-57"></a>        <span class="c1"># on récupère les cookies de la réponse s&#39;il y en a</span>
<a id="__codelineno-5-58" name="__codelineno-5-58"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
<a id="__codelineno-5-59" name="__codelineno-5-59"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__cookies</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">cookies</span>
<a id="__codelineno-5-60" name="__codelineno-5-60"></a>            <span class="c1"># on récupère le cookie de session</span>
<a id="__codelineno-5-61" name="__codelineno-5-61"></a>            <span class="n">session_cookie</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<a id="__codelineno-5-62" name="__codelineno-5-62"></a>            <span class="c1"># on le décode pour le loguer</span>
<a id="__codelineno-5-63" name="__codelineno-5-63"></a>            <span class="k">if</span> <span class="n">session_cookie</span><span class="p">:</span>
<a id="__codelineno-5-64" name="__codelineno-5-64"></a>                <span class="c1"># logueur</span>
<a id="__codelineno-5-65" name="__codelineno-5-65"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="p">:</span>
<a id="__codelineno-5-66" name="__codelineno-5-66"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__config</span><span class="p">[</span><span class="s1">&#39;logger&#39;</span><span class="p">]</span>
<a id="__codelineno-5-67" name="__codelineno-5-67"></a>                <span class="c1"># on logue</span>
<a id="__codelineno-5-68" name="__codelineno-5-68"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cookie de session=</span><span class="si">{</span><span class="n">decode_flask_session</span><span class="p">(</span><span class="n">session_cookie</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-69" name="__codelineno-5-69"></a>
<a id="__codelineno-5-70" name="__codelineno-5-70"></a>        <span class="c1"># mode debug ?</span>
<a id="__codelineno-5-71" name="__codelineno-5-71"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug</span><span class="p">:</span>
<a id="__codelineno-5-72" name="__codelineno-5-72"></a>            <span class="c1"># logueur</span>
<a id="__codelineno-5-73" name="__codelineno-5-73"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="p">:</span>
<a id="__codelineno-5-74" name="__codelineno-5-74"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__config</span><span class="p">[</span><span class="s1">&#39;logger&#39;</span><span class="p">]</span>
<a id="__codelineno-5-75" name="__codelineno-5-75"></a>            <span class="c1"># on logue</span>
<a id="__codelineno-5-76" name="__codelineno-5-76"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-77" name="__codelineno-5-77"></a>        <span class="c1"># code de statut de la réponse HTTP</span>
<a id="__codelineno-5-78" name="__codelineno-5-78"></a>        <span class="n">status_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
<a id="__codelineno-5-79" name="__codelineno-5-79"></a>        <span class="c1"># on met la réponse jSON dans un dictionnaire</span>
<a id="__codelineno-5-80" name="__codelineno-5-80"></a>        <span class="n">résultat</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-5-81" name="__codelineno-5-81"></a>        <span class="c1"># erreur si code de statut différent de 200 OK</span>
<a id="__codelineno-5-82" name="__codelineno-5-82"></a>        <span class="k">if</span> <span class="n">status_code</span> <span class="o">!=</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">:</span>
<a id="__codelineno-5-83" name="__codelineno-5-83"></a>            <span class="c1"># on sait que les erreurs ont été associées à la clé [erreurs] de la réponse</span>
<a id="__codelineno-5-84" name="__codelineno-5-84"></a>            <span class="k">raise</span> <span class="n">ImpôtsError</span><span class="p">(</span><span class="mi">87</span><span class="p">,</span> <span class="n">résultat</span><span class="p">[</span><span class="s1">&#39;réponse&#39;</span><span class="p">][</span><span class="s1">&#39;erreurs&#39;</span><span class="p">])</span>
<a id="__codelineno-5-85" name="__codelineno-5-85"></a>        <span class="c1"># on sait que le résultat a été associé à la clé [result] de la réponse</span>
<a id="__codelineno-5-86" name="__codelineno-5-86"></a>        <span class="c1"># on modifie le paramètre d&#39;entrée avec ce résultat</span>
<a id="__codelineno-5-87" name="__codelineno-5-87"></a>        <span class="n">taxpayer</span><span class="o">.</span><span class="n">fromdict</span><span class="p">(</span><span class="n">résultat</span><span class="p">[</span><span class="s2">&quot;réponse&quot;</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 30 : la couche <strong>[dao]</strong> va gérer un dictionnaire de cookies ;</li>
<li>ligne 58 : la propriété <strong>[response.cookies]</strong> est un dictionnaire rassemblant les cookies envoyés par le serveur dans les entêtes HTTP <strong>[Set-Cookie]</strong> ;</li>
<li>ligne 59 : ces cookies sont mémorisés dans la couche <strong>[dao]</strong>. Ils seront renvoyés au serveur lors des requêtes ultérieures du même client ;</li>
<li>lignes 60-68 : bien que ce ne soit pas indispensable on récupère le cookie de session. Dans le dictionnaire des cookies envoyés par le serveur, le cookie de session est associé à la clé <strong>[session]</strong> ;</li>
<li>lignes 62-68 : on décode le cookie de session pour le loguer ;</li>
<li>ligne 68 : nous reviendrons ultérieurement sur la fonction <strong>[</strong><strong>decode_flask_session</strong><strong>]</strong> qui décode le cookie de session ;</li>
<li>lignes 52 et 57 : à chaque requête du même client, les cookies envoyés par le serveur lui sont renvoyés. C’est de cette façon que la session Flask est maintenue entre le client et le serveur ;
Il faut se souvenir maintenant que la couche <strong>[dao]</strong> va être exécutée simultanément par plusieurs threads. Il faut donc regarder toutes les propriétés de l’instance de classe et voir si l’accès simultané à ces propriétés pose problème. Ici nous avons ajouté la propriété <strong>[self.__cookies]</strong>, ligne 30. Cette propriété est modifiée à la ligne 59. On a donc un accès en écriture à une donnée partagée par tous les threads. Or cet accès pose problème : chaque thread représentant un client donné a son propre cookie de session. En effet, dedans il y a un n° de client (=thread) unique pour chaque client. Si on ne fait rien, le thread T2 peut écraser les cookies du thread T1.</li>
</ul>
<p>On a déjà vu une méthode pour gérer ce problème : on peut créer dans le fichier <strong>[config]</strong> passé en paramètre au constructeur (ligne 17), des clés différentes pour chaque thread. On peut par exemple utiliser comme clé le nom du thread :</p>
<ul>
<li>
<p>ligne 59, on pourrait écrire :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="n">config</span><span class="p">[</span><span class="n">thread_name</span><span class="p">][</span><span class="err">‘</span><span class="n">cookies</span><span class="err">’</span><span class="p">]</span><span class="o">=</span><span class="n">cookies</span>
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>ligne 52, on pourrait alors écrire :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">cookies</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="n">thread_name</span><span class="p">][</span><span class="err">‘</span><span class="n">cookies</span><span class="err">’</span><span class="p">]</span>
</code></pre></div></td></tr></table></div></p>
</li>
</ul>
<p>Nous allons ici utiliser une technique différente : chaque thread (=client) aura sa propre couche <strong>[dao]</strong>. Ainsi la ligne 59 ne pose plus problème car les cookies utilisés sont alors ceux d’un unique client.</p>
<p>Pour cela, nous allons créer une nouvelle classe <strong>[</strong><strong>ImpôtsDaoWithHttpSessionFactory</strong><strong>]</strong>.</p>
<h4 id="25312-la-fonction-de-decodage-de-la-session-flask">25.3.1.2. La fonction de décodage de la session Flask</h4>
<p>La fonction <strong>[</strong><strong>decode_flask_session</strong><strong>]</strong> est définie dans le script <strong>[myutils]</strong> :</p>
<p><img src="images/1000000000000146000001109F11451C.png" style="width:3.761cm;height:3.14cm;" alt="Image" /></p>
<p>Nous avons déjà étudié le script |<a href="#_Installation_d’un_module"><u><u>myutils</u></u></a>|. Ce script est un module de portée machine que les différents scripts de ce cours peuvent importer avec l’instruction :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">myutils</span>
</code></pre></div></td></tr></table></div>
<p>On y définit la fonction <strong>[decode_flask_session]</strong> de la façon suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">decode_flask_session</span><span class="p">(</span><span class="n">cookie</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>    <span class="c1"># source : https://www.kirsle.net/wizards/flask-session.cgi</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>    <span class="n">compressed</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>    <span class="n">payload</span> <span class="o">=</span> <span class="n">cookie</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>    <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>        <span class="n">compressed</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">base64_decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a>    <span class="k">if</span> <span class="n">compressed</span><span class="p">:</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a>    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 2 : l’URL où j’ai trouvé cette fonction ;</li>
<li>ligne 1 : le paramètre <strong>[cookie]</strong> est la chaîne de caractères associée à la clé <strong>[session]</strong> dans le dictionnaire des cookies reçus par un client web ;</li>
<li>lignes 3-16 : je ne commenterai pas ce code que je ne maîtrise pas ;
On ajoute une nouvelle importation dans le fichier <strong>[<strong>init</strong>.py]</strong> :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_syspath</span><span class="p">,</span> <span class="n">json_response</span><span class="p">,</span> <span class="n">decode_flask_session</span>
</code></pre></div></td></tr></table></div>
<p>La nouvelle version de <strong>[myutils]</strong> est installée parmi les modules de portée machine avec la commande <strong>[pip install .]</strong> dans un terminal Pycharm :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="p">(</span><span class="n">venv</span><span class="p">)</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">packages</span><span class="o">&gt;</span><span class="n">pip</span> <span class="n">install</span> <span class="o">.</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="n">Processing</span> <span class="n">c</span><span class="p">:</span>\<span class="n">data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">packages</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="n">Using</span> <span class="n">legacy</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span> <span class="k">for</span> <span class="n">myutils</span><span class="p">,</span> <span class="n">since</span> <span class="n">package</span> <span class="s1">&#39;wheel&#39;</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">installed</span><span class="o">.</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="n">Installing</span> <span class="n">collected</span> <span class="n">packages</span><span class="p">:</span> <span class="n">myutils</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>  <span class="n">Attempting</span> <span class="n">uninstall</span><span class="p">:</span> <span class="n">myutils</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>    <span class="n">Found</span> <span class="n">existing</span> <span class="n">installation</span><span class="p">:</span> <span class="n">myutils</span> <span class="mf">0.1</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>    <span class="n">Uninstalling</span> <span class="n">myutils</span><span class="o">-</span><span class="mf">0.1</span><span class="p">:</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a>      <span class="n">Successfully</span> <span class="n">uninstalled</span> <span class="n">myutils</span><span class="o">-</span><span class="mf">0.1</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>    <span class="n">Running</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span> <span class="k">for</span> <span class="n">myutils</span> <span class="o">...</span> <span class="n">done</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="n">Successfully</span> <span class="n">installed</span> <span class="n">myutils</span><span class="o">-</span><span class="mf">0.1</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 1 : il faut être dans le dossier <strong>[packages]</strong> pour taper cette instruction ;</li>
</ul>
<h4 id="25313-la-classe-impotsdaowithhttpsessionfactory">25.3.1.3. La classe [ImpôtsDaoWithHttpSessionFactory]</h4>
<p>La classe <strong>[</strong><strong>ImpôtsDaoWithHttpSessionFactory</strong><strong>]</strong> est la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsDaoWithHttpSession</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsDaoWithHttpSession</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">ImpôtsDaoWithHttpSessionFactory</span><span class="p">:</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a>        <span class="c1"># on mémorise le paramètre</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">new_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a>        <span class="c1"># on rend une instance de la couche [dao]</span>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a>        <span class="k">return</span> <span class="n">ImpôtsDaoWithHttpSession</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>la classe <strong>[</strong><strong>ImpôtsDaoWithHttpSessionFactory</strong><strong>]</strong> permet de créer une nouvelle implémentation de la couche <strong>[dao]</strong> avec la méthode <strong>[</strong><strong>new_instance</strong><strong>]</strong> des lignes 10-12 ;</li>
</ul>
<h3 id="2532-la-configuration">25.3.2. La configuration</h3>
<p>Le script <strong>[config_layers]</strong> qui configure les couches du client web est modifié de la façon suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a>    <span class="c1"># instanciation des couches de l&#39;applicatuon</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>    <span class="c1"># couche dao</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsDaoWithHttpSessionFactory</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsDaoWithHttpSessionFactory</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a>    <span class="n">dao_factory</span> <span class="o">=</span> <span class="n">ImpôtsDaoWithHttpSessionFactory</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a>    <span class="c1"># on rend la configuation des couches</span>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a>        <span class="s2">&quot;dao_factory&quot;</span><span class="p">:</span> <span class="n">dao_factory</span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 5-6 : au lieu d’instancier une couche <strong>[dao]</strong> unique comme c’était fait précédemment, on instancie une ‘factory’ de cette couche (factory=usine de production d’objets, ici la couche <strong>[dao]</strong>) ;</li>
<li>lignes 9-11 : on rend la configuration des couches ;</li>
</ul>
<h3 id="2533-le-script-principal-du-client">25.3.3. Le script principal du client</h3>
<p>Le script <strong>[main]</strong> évolue de la façon suivante par rapport à celui de la version précédente :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span>
<span class="normal"><a href="#__codelineno-14-18">18</a></span>
<span class="normal"><a href="#__codelineno-14-19">19</a></span>
<span class="normal"><a href="#__codelineno-14-20">20</a></span>
<span class="normal"><a href="#__codelineno-14-21">21</a></span>
<span class="normal"><a href="#__codelineno-14-22">22</a></span>
<span class="normal"><a href="#__codelineno-14-23">23</a></span>
<span class="normal"><a href="#__codelineno-14-24">24</a></span>
<span class="normal"><a href="#__codelineno-14-25">25</a></span>
<span class="normal"><a href="#__codelineno-14-26">26</a></span>
<span class="normal"><a href="#__codelineno-14-27">27</a></span>
<span class="normal"><a href="#__codelineno-14-28">28</a></span>
<span class="normal"><a href="#__codelineno-14-29">29</a></span>
<span class="normal"><a href="#__codelineno-14-30">30</a></span>
<span class="normal"><a href="#__codelineno-14-31">31</a></span>
<span class="normal"><a href="#__codelineno-14-32">32</a></span>
<span class="normal"><a href="#__codelineno-14-33">33</a></span>
<span class="normal"><a href="#__codelineno-14-34">34</a></span>
<span class="normal"><a href="#__codelineno-14-35">35</a></span>
<span class="normal"><a href="#__codelineno-14-36">36</a></span>
<span class="normal"><a href="#__codelineno-14-37">37</a></span>
<span class="normal"><a href="#__codelineno-14-38">38</a></span>
<span class="normal"><a href="#__codelineno-14-39">39</a></span>
<span class="normal"><a href="#__codelineno-14-40">40</a></span>
<span class="normal"><a href="#__codelineno-14-41">41</a></span>
<span class="normal"><a href="#__codelineno-14-42">42</a></span>
<span class="normal"><a href="#__codelineno-14-43">43</a></span>
<span class="normal"><a href="#__codelineno-14-44">44</a></span>
<span class="normal"><a href="#__codelineno-14-45">45</a></span>
<span class="normal"><a href="#__codelineno-14-46">46</a></span>
<span class="normal"><a href="#__codelineno-14-47">47</a></span>
<span class="normal"><a href="#__codelineno-14-48">48</a></span>
<span class="normal"><a href="#__codelineno-14-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({})</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="c1"># dépendances</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">Logger</span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a>
<a id="__codelineno-14-13" name="__codelineno-14-13"></a>
<a id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="c1"># exécution de la couche [dao] dans un thread</span>
<a id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="c1"># taxpayers est une liste de contribuables</span>
<a id="__codelineno-14-16" name="__codelineno-14-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">thread_function</span><span class="p">(</span><span class="n">thread_dao</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">taxpayers</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-14-17" name="__codelineno-14-17"></a>    <span class="err">…</span>
<a id="__codelineno-14-18" name="__codelineno-14-18"></a>
<a id="__codelineno-14-19" name="__codelineno-14-19"></a>
<a id="__codelineno-14-20" name="__codelineno-14-20"></a><span class="c1"># liste des threads du client</span>
<a id="__codelineno-14-21" name="__codelineno-14-21"></a><span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-14-22" name="__codelineno-14-22"></a><span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-14-23" name="__codelineno-14-23"></a><span class="c1"># code</span>
<a id="__codelineno-14-24" name="__codelineno-14-24"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-14-25" name="__codelineno-14-25"></a>    <span class="err">…</span>
<a id="__codelineno-14-26" name="__codelineno-14-26"></a>    <span class="n">l_taxpayers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">taxpayers</span><span class="p">)</span>
<a id="__codelineno-14-27" name="__codelineno-14-27"></a>    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">taxpayers</span><span class="p">):</span>
<a id="__codelineno-14-28" name="__codelineno-14-28"></a>        <span class="err">…</span>
<a id="__codelineno-14-29" name="__codelineno-14-29"></a>        <span class="c1"># chaque thread doit avoir sa propre couche [dao] pour gérer correctement son cookie de session</span>
<a id="__codelineno-14-30" name="__codelineno-14-30"></a>        <span class="n">thread_dao</span> <span class="o">=</span> <span class="n">dao_factory</span><span class="o">.</span><span class="n">new_instance</span><span class="p">()</span>
<a id="__codelineno-14-31" name="__codelineno-14-31"></a>        <span class="c1"># on crée le thread</span>
<a id="__codelineno-14-32" name="__codelineno-14-32"></a>        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">thread_function</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">thread_dao</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">thread_taxpayers</span><span class="p">))</span>
<a id="__codelineno-14-33" name="__codelineno-14-33"></a>        <span class="c1"># on l&#39;ajoute à la liste des threads du script principal</span>
<a id="__codelineno-14-34" name="__codelineno-14-34"></a>        <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
<a id="__codelineno-14-35" name="__codelineno-14-35"></a>        <span class="c1"># on lance le thread - cette opération est asynchrone - on n&#39;attend pas le résultat du thread</span>
<a id="__codelineno-14-36" name="__codelineno-14-36"></a>        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-14-37" name="__codelineno-14-37"></a>    <span class="c1"># le thread principal attend la fin de tous les threads qu&#39;il a lancés</span>
<a id="__codelineno-14-38" name="__codelineno-14-38"></a>    <span class="err">…</span>
<a id="__codelineno-14-39" name="__codelineno-14-39"></a><span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-14-40" name="__codelineno-14-40"></a>    <span class="c1"># affichage de l&#39;erreur</span>
<a id="__codelineno-14-41" name="__codelineno-14-41"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-14-42" name="__codelineno-14-42"></a><span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-14-43" name="__codelineno-14-43"></a>    <span class="c1"># on ferme le logueur</span>
<a id="__codelineno-14-44" name="__codelineno-14-44"></a>    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-14-45" name="__codelineno-14-45"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-14-46" name="__codelineno-14-46"></a>    <span class="c1"># on a fini</span>
<a id="__codelineno-14-47" name="__codelineno-14-47"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Travail terminé...&quot;</span><span class="p">)</span>
<a id="__codelineno-14-48" name="__codelineno-14-48"></a>    <span class="c1"># fin des threads qui pourraient encore exister si on s&#39;est arrêté sur erreur</span>
<a id="__codelineno-14-49" name="__codelineno-14-49"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 29-30 : chaque thread a sa couche <strong>[dao]</strong> ;</li>
</ul>
<h3 id="2534-execution-du-client">25.3.4. Exécution du client</h3>
<p>Le serveur web est lancé, le SGBD est lancé, le serveur de mails <strong>[hMailServer]</strong> est lancé. Puis on lance le script <strong>[main]</strong> du client web. Les logs de l’exécution dans <strong>[data/logs/logs.txt]</strong> sont alors les suivants :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span>
<span class="normal"><a href="#__codelineno-15-18">18</a></span>
<span class="normal"><a href="#__codelineno-15-19">19</a></span>
<span class="normal"><a href="#__codelineno-15-20">20</a></span>
<span class="normal"><a href="#__codelineno-15-21">21</a></span>
<span class="normal"><a href="#__codelineno-15-22">22</a></span>
<span class="normal"><a href="#__codelineno-15-23">23</a></span>
<span class="normal"><a href="#__codelineno-15-24">24</a></span>
<span class="normal"><a href="#__codelineno-15-25">25</a></span>
<span class="normal"><a href="#__codelineno-15-26">26</a></span>
<span class="normal"><a href="#__codelineno-15-27">27</a></span>
<span class="normal"><a href="#__codelineno-15-28">28</a></span>
<span class="normal"><a href="#__codelineno-15-29">29</a></span>
<span class="normal"><a href="#__codelineno-15-30">30</a></span>
<span class="normal"><a href="#__codelineno-15-31">31</a></span>
<span class="normal"><a href="#__codelineno-15-32">32</a></span>
<span class="normal"><a href="#__codelineno-15-33">33</a></span>
<span class="normal"><a href="#__codelineno-15-34">34</a></span>
<span class="normal"><a href="#__codelineno-15-35">35</a></span>
<span class="normal"><a href="#__codelineno-15-36">36</a></span>
<span class="normal"><a href="#__codelineno-15-37">37</a></span>
<span class="normal"><a href="#__codelineno-15-38">38</a></span>
<span class="normal"><a href="#__codelineno-15-39">39</a></span>
<span class="normal"><a href="#__codelineno-15-40">40</a></span>
<span class="normal"><a href="#__codelineno-15-41">41</a></span>
<span class="normal"><a href="#__codelineno-15-42">42</a></span>
<span class="normal"><a href="#__codelineno-15-43">43</a></span>
<span class="normal"><a href="#__codelineno-15-44">44</a></span>
<span class="normal"><a href="#__codelineno-15-45">45</a></span>
<span class="normal"><a href="#__codelineno-15-46">46</a></span>
<span class="normal"><a href="#__codelineno-15-47">47</a></span>
<span class="normal"><a href="#__codelineno-15-48">48</a></span>
<span class="normal"><a href="#__codelineno-15-49">49</a></span>
<span class="normal"><a href="#__codelineno-15-50">50</a></span>
<span class="normal"><a href="#__codelineno-15-51">51</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.478511</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">avec</span> <span class="mi">1</span> <span class="n">contribuable</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.479111</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 1, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 55555}</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.479111</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="n">avec</span> <span class="mi">1</span> <span class="n">contribuable</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.480195</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="n">avec</span> <span class="mi">2</span> <span class="n">contribuable</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.480195</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 2, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 50000}</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.481137</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="n">avec</span> <span class="mi">3</span> <span class="n">contribuable</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.481137</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 3, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 50000}</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.482279</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="n">avec</span> <span class="mi">3</span> <span class="n">contribuable</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.482622</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">6</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span> <span class="n">avec</span> <span class="mi">1</span> <span class="n">contribuable</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.482622</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 5, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 100000}</span>
<a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.485923</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 8, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 0, &quot;salaire&quot;: 100000}</span>
<a id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.485923</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">6</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 11, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 200000}</span>
<a id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.725910</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">cookie</span> <span class="n">de</span> <span class="n">session</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;admindata&quot;</span><span class="p">:{</span><span class="s2">&quot;abattement_dixpourcent_max&quot;</span><span class="p">:</span><span class="mf">12502.0</span><span class="p">,</span><span class="s2">&quot;abattement_dixpourcent_min&quot;</span><span class="p">:</span><span class="mf">437.0</span><span class="p">,</span><span class="s2">&quot;coeffn&quot;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1394.96</span><span class="p">,</span><span class="mf">5798.0</span><span class="p">,</span><span class="mf">13913.7</span><span class="p">,</span><span class="mf">20163.4</span><span class="p">],</span><span class="s2">&quot;coeffr&quot;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.14</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.41</span><span class="p">,</span><span class="mf">0.45</span><span class="p">],</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;limites&quot;</span><span class="p">:[</span><span class="mf">9964.0</span><span class="p">,</span><span class="mf">27519.0</span><span class="p">,</span><span class="mf">73779.0</span><span class="p">,</span><span class="mf">156244.0</span><span class="p">,</span><span class="mf">90000.0</span><span class="p">],</span><span class="s2">&quot;plafond_decote_celibataire&quot;</span><span class="p">:</span><span class="mf">1196.0</span><span class="p">,</span><span class="s2">&quot;plafond_decote_couple&quot;</span><span class="p">:</span><span class="mf">1970.0</span><span class="p">,</span><span class="s2">&quot;plafond_impot_celibataire_pour_decote&quot;</span><span class="p">:</span><span class="mf">1595.0</span><span class="p">,</span><span class="s2">&quot;plafond_impot_couple_pour_decote&quot;</span><span class="p">:</span><span class="mf">2627.0</span><span class="p">,</span><span class="s2">&quot;plafond_qf_demi_part&quot;</span><span class="p">:</span><span class="mf">1551.0</span><span class="p">,</span><span class="s2">&quot;plafond_revenus_celibataire_pour_reduction&quot;</span><span class="p">:</span><span class="mf">21037.0</span><span class="p">,</span><span class="s2">&quot;plafond_revenus_couple_pour_reduction&quot;</span><span class="p">:</span><span class="mf">42074.0</span><span class="p">,</span><span class="s2">&quot;valeur_reduc_demi_part&quot;</span><span class="p">:</span><span class="mf">3797.0</span><span class="p">},</span><span class="s2">&quot;client_id&quot;</span><span class="p">:</span><span class="s2">&quot;fa3c83b82761c83e13217967&quot;</span><span class="p">}</span>
<a id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.725910</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">16782</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">7176</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.725910</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 5, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 100000, &quot;impôt&quot;: 16782, &quot;surcôte&quot;: 7176, &quot;taux&quot;: 0.41, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.726960</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 6, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 100000}</span>
<a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.514108</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="n">cookie</span> <span class="n">de</span> <span class="n">session</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;admindata&quot;</span><span class="p">:{</span><span class="s2">&quot;abattement_dixpourcent_max&quot;</span><span class="p">:</span><span class="mf">12502.0</span><span class="p">,</span><span class="s2">&quot;abattement_dixpourcent_min&quot;</span><span class="p">:</span><span class="mf">437.0</span><span class="p">,</span><span class="s2">&quot;coeffn&quot;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1394.96</span><span class="p">,</span><span class="mf">5798.0</span><span class="p">,</span><span class="mf">13913.7</span><span class="p">,</span><span class="mf">20163.4</span><span class="p">],</span><span class="s2">&quot;coeffr&quot;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.14</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.41</span><span class="p">,</span><span class="mf">0.45</span><span class="p">],</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;limites&quot;</span><span class="p">:[</span><span class="mf">9964.0</span><span class="p">,</span><span class="mf">27519.0</span><span class="p">,</span><span class="mf">73779.0</span><span class="p">,</span><span class="mf">156244.0</span><span class="p">,</span><span class="mf">24999.5</span><span class="p">],</span><span class="s2">&quot;plafond_decote_celibataire&quot;</span><span class="p">:</span><span class="mf">1196.0</span><span class="p">,</span><span class="s2">&quot;plafond_decote_couple&quot;</span><span class="p">:</span><span class="mf">1970.0</span><span class="p">,</span><span class="s2">&quot;plafond_impot_celibataire_pour_decote&quot;</span><span class="p">:</span><span class="mf">1595.0</span><span class="p">,</span><span class="s2">&quot;plafond_impot_couple_pour_decote&quot;</span><span class="p">:</span><span class="mf">2627.0</span><span class="p">,</span><span class="s2">&quot;plafond_qf_demi_part&quot;</span><span class="p">:</span><span class="mf">1551.0</span><span class="p">,</span><span class="s2">&quot;plafond_revenus_celibataire_pour_reduction&quot;</span><span class="p">:</span><span class="mf">21037.0</span><span class="p">,</span><span class="s2">&quot;plafond_revenus_couple_pour_reduction&quot;</span><span class="p">:</span><span class="mf">42074.0</span><span class="p">,</span><span class="s2">&quot;valeur_reduc_demi_part&quot;</span><span class="p">:</span><span class="mf">3797.0</span><span class="p">},</span><span class="s2">&quot;client_id&quot;</span><span class="p">:</span><span class="s2">&quot;700e3f5dc808c7c48f0c9007&quot;</span><span class="p">}</span>
<a id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.514610</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">720</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.514939</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 3, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 50000, &quot;impôt&quot;: 0, &quot;surcôte&quot;: 0, &quot;taux&quot;: 0.14, &quot;décôte&quot;: 720, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-15-20" name="__codelineno-15-20"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.514939</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 4, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 100000}</span>
<a id="__codelineno-15-21" name="__codelineno-15-21"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.527211</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">cookie</span> <span class="n">de</span> <span class="n">session</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;admindata&quot;</span><span class="p">:{</span><span class="s2">&quot;abattement_dixpourcent_max&quot;</span><span class="p">:</span><span class="mf">12502.0</span><span class="p">,</span><span class="s2">&quot;abattement_dixpourcent_min&quot;</span><span class="p">:</span><span class="mf">437.0</span><span class="p">,</span><span class="s2">&quot;coeffn&quot;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1394.96</span><span class="p">,</span><span class="mf">5798.0</span><span class="p">,</span><span class="mf">13913.7</span><span class="p">,</span><span class="mf">20163.4</span><span class="p">],</span><span class="s2">&quot;coeffr&quot;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.14</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.41</span><span class="p">,</span><span class="mf">0.45</span><span class="p">],</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;limites&quot;</span><span class="p">:[</span><span class="mf">9964.0</span><span class="p">,</span><span class="mf">27519.0</span><span class="p">,</span><span class="mf">73779.0</span><span class="p">,</span><span class="mf">156244.0</span><span class="p">,</span><span class="mf">90000.0</span><span class="p">],</span><span class="s2">&quot;plafond_decote_celibataire&quot;</span><span class="p">:</span><span class="mf">1196.0</span><span class="p">,</span><span class="s2">&quot;plafond_decote_couple&quot;</span><span class="p">:</span><span class="mf">1970.0</span><span class="p">,</span><span class="s2">&quot;plafond_impot_celibataire_pour_decote&quot;</span><span class="p">:</span><span class="mf">1595.0</span><span class="p">,</span><span class="s2">&quot;plafond_impot_couple_pour_decote&quot;</span><span class="p">:</span><span class="mf">2627.0</span><span class="p">,</span><span class="s2">&quot;plafond_qf_demi_part&quot;</span><span class="p">:</span><span class="mf">1551.0</span><span class="p">,</span><span class="s2">&quot;plafond_revenus_celibataire_pour_reduction&quot;</span><span class="p">:</span><span class="mf">21037.0</span><span class="p">,</span><span class="s2">&quot;plafond_revenus_couple_pour_reduction&quot;</span><span class="p">:</span><span class="mf">42074.0</span><span class="p">,</span><span class="s2">&quot;valeur_reduc_demi_part&quot;</span><span class="p">:</span><span class="mf">3797.0</span><span class="p">},</span><span class="s2">&quot;client_id&quot;</span><span class="p">:</span><span class="s2">&quot;9e14a5d4a3057f69ab95ab2d&quot;</span><span class="p">}</span>
<a id="__codelineno-15-22" name="__codelineno-15-22"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.527211</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="n">cookie</span> <span class="n">de</span> <span class="n">session</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;admindata&quot;</span><span class="p">:{</span><span class="s2">&quot;abattement_dixpourcent_max&quot;</span><span class="p">:</span><span class="mf">12502.0</span><span class="p">,</span><span class="s2">&quot;abattement_dixpourcent_min&quot;</span><span class="p">:</span><span class="mf">437.0</span><span class="p">,</span><span class="s2">&quot;coeffn&quot;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1394.96</span><span class="p">,</span><span class="mf">5798.0</span><span class="p">,</span><span class="mf">13913.7</span><span class="p">,</span><span class="mf">20163.4</span><span class="p">],</span><span class="s2">&quot;coeffr&quot;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.14</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.41</span><span class="p">,</span><span class="mf">0.45</span><span class="p">],</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;limites&quot;</span><span class="p">:[</span><span class="mf">9964.0</span><span class="p">,</span><span class="mf">27519.0</span><span class="p">,</span><span class="mf">73779.0</span><span class="p">,</span><span class="mf">156244.0</span><span class="p">,</span><span class="mf">22500.0</span><span class="p">],</span><span class="s2">&quot;plafond_decote_celibataire&quot;</span><span class="p">:</span><span class="mf">1196.0</span><span class="p">,</span><span class="s2">&quot;plafond_decote_couple&quot;</span><span class="p">:</span><span class="mf">1970.0</span><span class="p">,</span><span class="s2">&quot;plafond_impot_celibataire_pour_decote&quot;</span><span class="p">:</span><span class="mf">1595.0</span><span class="p">,</span><span class="s2">&quot;plafond_impot_couple_pour_decote&quot;</span><span class="p">:</span><span class="mf">2627.0</span><span class="p">,</span><span class="s2">&quot;plafond_qf_demi_part&quot;</span><span class="p">:</span><span class="mf">1551.0</span><span class="p">,</span><span class="s2">&quot;plafond_revenus_celibataire_pour_reduction&quot;</span><span class="p">:</span><span class="mf">21037.0</span><span class="p">,</span><span class="s2">&quot;plafond_revenus_couple_pour_reduction&quot;</span><span class="p">:</span><span class="mf">42074.0</span><span class="p">,</span><span class="s2">&quot;valeur_reduc_demi_part&quot;</span><span class="p">:</span><span class="mf">3797.0</span><span class="p">},</span><span class="s2">&quot;client_id&quot;</span><span class="p">:</span><span class="s2">&quot;a06e8fd70a44c9e311f4dce0&quot;</span><span class="p">}</span>
<a id="__codelineno-15-23" name="__codelineno-15-23"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.527211</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">22986</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-24" name="__codelineno-15-24"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.527211</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">cookie</span> <span class="n">de</span> <span class="n">session</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;admindata&quot;</span><span class="p">:{</span><span class="s2">&quot;abattement_dixpourcent_max&quot;</span><span class="p">:</span><span class="mf">12502.0</span><span class="p">,</span><span class="s2">&quot;abattement_dixpourcent_min&quot;</span><span class="p">:</span><span class="mf">437.0</span><span class="p">,</span><span class="s2">&quot;coeffn&quot;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1394.96</span><span class="p">,</span><span class="mf">5798.0</span><span class="p">,</span><span class="mf">13913.7</span><span class="p">,</span><span class="mf">20163.4</span><span class="p">],</span><span class="s2">&quot;coeffr&quot;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.14</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.41</span><span class="p">,</span><span class="mf">0.45</span><span class="p">],</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;limites&quot;</span><span class="p">:[</span><span class="mf">9964.0</span><span class="p">,</span><span class="mf">27519.0</span><span class="p">,</span><span class="mf">73779.0</span><span class="p">,</span><span class="mf">156244.0</span><span class="p">,</span><span class="mf">90000.0</span><span class="p">],</span><span class="s2">&quot;plafond_decote_celibataire&quot;</span><span class="p">:</span><span class="mf">1196.0</span><span class="p">,</span><span class="s2">&quot;plafond_decote_couple&quot;</span><span class="p">:</span><span class="mf">1970.0</span><span class="p">,</span><span class="s2">&quot;plafond_impot_celibataire_pour_decote&quot;</span><span class="p">:</span><span class="mf">1595.0</span><span class="p">,</span><span class="s2">&quot;plafond_impot_couple_pour_decote&quot;</span><span class="p">:</span><span class="mf">2627.0</span><span class="p">,</span><span class="s2">&quot;plafond_qf_demi_part&quot;</span><span class="p">:</span><span class="mf">1551.0</span><span class="p">,</span><span class="s2">&quot;plafond_revenus_celibataire_pour_reduction&quot;</span><span class="p">:</span><span class="mf">21037.0</span><span class="p">,</span><span class="s2">&quot;plafond_revenus_couple_pour_reduction&quot;</span><span class="p">:</span><span class="mf">42074.0</span><span class="p">,</span><span class="s2">&quot;valeur_reduc_demi_part&quot;</span><span class="p">:</span><span class="mf">3797.0</span><span class="p">},</span><span class="s2">&quot;client_id&quot;</span><span class="p">:</span><span class="s2">&quot;28c38df998f67685b3a482b8&quot;</span><span class="p">}</span>
<a id="__codelineno-15-25" name="__codelineno-15-25"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.527211</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">1384</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">384</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">347</span><span class="p">}}}</span>
<a id="__codelineno-15-26" name="__codelineno-15-26"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.528341</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 8, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 0, &quot;salaire&quot;: 100000, &quot;impôt&quot;: 22986, &quot;surcôte&quot;: 0, &quot;taux&quot;: 0.41, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-15-27" name="__codelineno-15-27"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.528341</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">55555</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">2814</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-28" name="__codelineno-15-28"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.528842</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 2, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 50000, &quot;impôt&quot;: 1384, &quot;surcôte&quot;: 0, &quot;taux&quot;: 0.14, &quot;décôte&quot;: 384, &quot;réduction&quot;: 347}</span>
<a id="__codelineno-15-29" name="__codelineno-15-29"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.529349</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 9, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 30000}</span>
<a id="__codelineno-15-30" name="__codelineno-15-30"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.529699</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 1, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 55555, &quot;impôt&quot;: 2814, &quot;surcôte&quot;: 0, &quot;taux&quot;: 0.14, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-15-31" name="__codelineno-15-31"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.529699</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-15-32" name="__codelineno-15-32"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.531905</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-15-33" name="__codelineno-15-33"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.536121</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">6</span> <span class="p">:</span> <span class="n">cookie</span> <span class="n">de</span> <span class="n">session</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;admindata&quot;</span><span class="p">:{</span><span class="s2">&quot;abattement_dixpourcent_max&quot;</span><span class="p">:</span><span class="mf">12502.0</span><span class="p">,</span><span class="s2">&quot;abattement_dixpourcent_min&quot;</span><span class="p">:</span><span class="mf">437.0</span><span class="p">,</span><span class="s2">&quot;coeffn&quot;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1394.96</span><span class="p">,</span><span class="mf">5798.0</span><span class="p">,</span><span class="mf">13913.7</span><span class="p">,</span><span class="mf">20163.4</span><span class="p">],</span><span class="s2">&quot;coeffr&quot;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.14</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.41</span><span class="p">,</span><span class="mf">0.45</span><span class="p">],</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;limites&quot;</span><span class="p">:[</span><span class="mf">9964.0</span><span class="p">,</span><span class="mf">27519.0</span><span class="p">,</span><span class="mf">73779.0</span><span class="p">,</span><span class="mf">156244.0</span><span class="p">,</span><span class="mf">93749.0</span><span class="p">],</span><span class="s2">&quot;plafond_decote_celibataire&quot;</span><span class="p">:</span><span class="mf">1196.0</span><span class="p">,</span><span class="s2">&quot;plafond_decote_couple&quot;</span><span class="p">:</span><span class="mf">1970.0</span><span class="p">,</span><span class="s2">&quot;plafond_impot_celibataire_pour_decote&quot;</span><span class="p">:</span><span class="mf">1595.0</span><span class="p">,</span><span class="s2">&quot;plafond_impot_couple_pour_decote&quot;</span><span class="p">:</span><span class="mf">2627.0</span><span class="p">,</span><span class="s2">&quot;plafond_qf_demi_part&quot;</span><span class="p">:</span><span class="mf">1551.0</span><span class="p">,</span><span class="s2">&quot;plafond_revenus_celibataire_pour_reduction&quot;</span><span class="p">:</span><span class="mf">21037.0</span><span class="p">,</span><span class="s2">&quot;plafond_revenus_couple_pour_reduction&quot;</span><span class="p">:</span><span class="mf">42074.0</span><span class="p">,</span><span class="s2">&quot;valeur_reduc_demi_part&quot;</span><span class="p">:</span><span class="mf">3797.0</span><span class="p">},</span><span class="s2">&quot;client_id&quot;</span><span class="p">:</span><span class="s2">&quot;38499b63076516c02f2770ec&quot;</span><span class="p">}</span>
<a id="__codelineno-15-34" name="__codelineno-15-34"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.537161</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">19884</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">4480</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-35" name="__codelineno-15-35"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.537161</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">6</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">42842</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">17283</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-36" name="__codelineno-15-36"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.538156</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 4, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 100000, &quot;impôt&quot;: 19884, &quot;surcôte&quot;: 4480, &quot;taux&quot;: 0.41, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-15-37" name="__codelineno-15-37"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.538557</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">6</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 11, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 200000, &quot;impôt&quot;: 42842, &quot;surcôte&quot;: 17283, &quot;taux&quot;: 0.41, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-15-38" name="__codelineno-15-38"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.538828</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
<a id="__codelineno-15-39" name="__codelineno-15-39"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.538828</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">6</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
<a id="__codelineno-15-40" name="__codelineno-15-40"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.546198</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-41" name="__codelineno-15-41"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.546198</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 9, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 30000, &quot;impôt&quot;: 0, &quot;surcôte&quot;: 0, &quot;taux&quot;: 0.0, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-15-42" name="__codelineno-15-42"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.546198</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 10, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 0, &quot;salaire&quot;: 200000}</span>
<a id="__codelineno-15-43" name="__codelineno-15-43"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.739643</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">9200</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">2180</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-44" name="__codelineno-15-44"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.739643</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 6, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 100000, &quot;impôt&quot;: 9200, &quot;surcôte&quot;: 2180, &quot;taux&quot;: 0.3, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-15-45" name="__codelineno-15-45"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.740668</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 7, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 5, &quot;salaire&quot;: 100000}</span>
<a id="__codelineno-15-46" name="__codelineno-15-46"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">48.557469</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">64210</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">7498</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.45</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-47" name="__codelineno-15-47"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">48.558715</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 10, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 0, &quot;salaire&quot;: 200000, &quot;impôt&quot;: 64210, &quot;surcôte&quot;: 7498, &quot;taux&quot;: 0.45, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-15-48" name="__codelineno-15-48"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">48.558715</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
<a id="__codelineno-15-49" name="__codelineno-15-49"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">48.753025</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">4230</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-50" name="__codelineno-15-50"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">48.753318</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 7, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 5, &quot;salaire&quot;: 100000, &quot;impôt&quot;: 4230, &quot;surcôte&quot;: 0, &quot;taux&quot;: 0.14, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-15-51" name="__codelineno-15-51"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">48.753540</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>on a au total 6 threads donc 6 clients (lignes 1, 3, 4, 6, 8, 9) qui interrogent simultanément le serveur de calcul de l’impôt ;</li>
<li>nous allons suivre le thread <strong>[Thread-4]</strong> qui gère 3 contribuables (ligne 6). Il va faire séquentiellement trois requêtes au serveur de calcul de l’impôt ;</li>
<li>ligne 10 : la 1ère requête de <strong>[Thread-4]</strong> ;</li>
<li>ligne 13 : <strong>[Thread-4]</strong> a reçu la réponse à sa 1ère requête. Dedans elle trouve un cookie de session dans lequel il y a le n° <strong>[</strong><strong>fa3c83b82761c83e13217967</strong><strong>]</strong> que lui a attribué le serveur ;</li>
<li>ligne 14 : l’impôt du 1er contribuable ;</li>
<li>ligne 16 : <strong>[Thread-4]</strong> fait une requête pour le 2ième contribuable ;</li>
<li>ligne 43 : <strong>[Thread-4]</strong> reçoit l’impôt du 2ième contribuable ;</li>
<li>ligne 45 : <strong>[Thread-4]</strong> fait une requête pour le 3ième contribuable ;</li>
<li>ligne 49 : <strong>[Thread-4]</strong> reçoit l’impôt du 3ième contribuable ;</li>
<li>ligne 51 : <strong>[Thread-4]</strong> a terminé son travail ;
Maintenant, regardons comment les 3 requêtes de <strong>[Thread-4]</strong> ont été traitées côté serveur. On va pouvoir le suivre dans les logs du serveur grâce à son n° de client <strong>[</strong><strong>fa3c83b82761c83e13217967</strong><strong>]</strong>.</li>
</ul>
<p>Les logs <strong>[data/logs/logs.txt]</strong> côté serveur sont les suivants :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span>
<span class="normal"><a href="#__codelineno-16-20">20</a></span>
<span class="normal"><a href="#__codelineno-16-21">21</a></span>
<span class="normal"><a href="#__codelineno-16-22">22</a></span>
<span class="normal"><a href="#__codelineno-16-23">23</a></span>
<span class="normal"><a href="#__codelineno-16-24">24</a></span>
<span class="normal"><a href="#__codelineno-16-25">25</a></span>
<span class="normal"><a href="#__codelineno-16-26">26</a></span>
<span class="normal"><a href="#__codelineno-16-27">27</a></span>
<span class="normal"><a href="#__codelineno-16-28">28</a></span>
<span class="normal"><a href="#__codelineno-16-29">29</a></span>
<span class="normal"><a href="#__codelineno-16-30">30</a></span>
<span class="normal"><a href="#__codelineno-16-31">31</a></span>
<span class="normal"><a href="#__codelineno-16-32">32</a></span>
<span class="normal"><a href="#__codelineno-16-33">33</a></span>
<span class="normal"><a href="#__codelineno-16-34">34</a></span>
<span class="normal"><a href="#__codelineno-16-35">35</a></span>
<span class="normal"><a href="#__codelineno-16-36">36</a></span>
<span class="normal"><a href="#__codelineno-16-37">37</a></span>
<span class="normal"><a href="#__codelineno-16-38">38</a></span>
<span class="normal"><a href="#__codelineno-16-39">39</a></span>
<span class="normal"><a href="#__codelineno-16-40">40</a></span>
<span class="normal"><a href="#__codelineno-16-41">41</a></span>
<span class="normal"><a href="#__codelineno-16-42">42</a></span>
<span class="normal"><a href="#__codelineno-16-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">39.187366</span><span class="p">,</span> <span class="n">MainThread</span> <span class="p">:</span> <span class="p">[</span><span class="n">serveur</span><span class="p">]</span> <span class="n">démarrage</span> <span class="n">du</span> <span class="n">serveur</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">40.439093</span><span class="p">,</span> <span class="n">MainThread</span> <span class="p">:</span> <span class="p">[</span><span class="n">serveur</span><span class="p">]</span> <span class="n">démarrage</span> <span class="n">du</span> <span class="n">serveur</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.502011</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=oui&amp;enfants=3&amp;salaire=50000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.504049</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">mis</span> <span class="n">en</span> <span class="n">pause</span> <span class="n">du</span> <span class="n">thread</span> <span class="n">pendant</span> <span class="mi">1</span> <span class="n">seconde</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.505452</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=oui&amp;enfants=2&amp;salaire=55555&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.506257</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">mis</span> <span class="n">en</span> <span class="n">pause</span> <span class="n">du</span> <span class="n">thread</span> <span class="n">pendant</span> <span class="mi">1</span> <span class="n">seconde</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.507292</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=non&amp;enfants=0&amp;salaire=100000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.507292</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">mis</span> <span class="n">en</span> <span class="n">pause</span> <span class="n">du</span> <span class="n">thread</span> <span class="n">pendant</span> <span class="mi">1</span> <span class="n">seconde</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.508301</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=oui&amp;enfants=2&amp;salaire=50000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.509293</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">mis</span> <span class="n">en</span> <span class="n">pause</span> <span class="n">du</span> <span class="n">thread</span> <span class="n">pendant</span> <span class="mi">1</span> <span class="n">seconde</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.511808</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">6</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=non&amp;enfants=3&amp;salaire=100000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.517604</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">7</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=oui&amp;enfants=3&amp;salaire=200000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.517604</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">7</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">mis</span> <span class="n">en</span> <span class="n">pause</span> <span class="n">du</span> <span class="n">thread</span> <span class="n">pendant</span> <span class="mi">1</span> <span class="n">seconde</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-16-14" name="__codelineno-16-14"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.719504</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">6</span> <span class="p">:</span> <span class="p">[</span><span class="n">index_controller</span><span class="p">]</span> <span class="n">client</span> <span class="p">[</span><span class="n">fa3c83b82761c83e13217967</span><span class="p">],</span> <span class="n">données</span> <span class="n">fiscales</span> <span class="n">prises</span> <span class="n">dans</span> <span class="n">la</span> <span class="n">couche</span> <span class="n">dao</span>
<a id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.720003</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">6</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;non&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">16782</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">7176</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-16-16" name="__codelineno-16-16"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.736108</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">8</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=oui&amp;enfants=3&amp;salaire=100000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-16-17" name="__codelineno-16-17"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">46.736108</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">8</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">mis</span> <span class="n">en</span> <span class="n">pause</span> <span class="n">du</span> <span class="n">thread</span> <span class="n">pendant</span> <span class="mi">1</span> <span class="n">seconde</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-16-18" name="__codelineno-16-18"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.506709</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">[</span><span class="n">index_controller</span><span class="p">]</span> <span class="n">client</span> <span class="p">[</span><span class="mf">700e3</span><span class="n">f5dc808c7c48f0c9007</span><span class="p">],</span> <span class="n">données</span> <span class="n">fiscales</span> <span class="n">prises</span> <span class="n">dans</span> <span class="n">la</span> <span class="n">couche</span> <span class="n">dao</span>
<a id="__codelineno-16-19" name="__codelineno-16-19"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.507216</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">720</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-16-20" name="__codelineno-16-20"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.507216</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="p">[</span><span class="n">index_controller</span><span class="p">]</span> <span class="n">client</span> <span class="p">[</span><span class="mi">28</span><span class="n">c38df998f67685b3a482b8</span><span class="p">],</span> <span class="n">données</span> <span class="n">fiscales</span> <span class="n">prises</span> <span class="n">dans</span> <span class="n">la</span> <span class="n">couche</span> <span class="n">dao</span>
<a id="__codelineno-16-21" name="__codelineno-16-21"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.508442</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">[</span><span class="n">index_controller</span><span class="p">]</span> <span class="n">client</span> <span class="p">[</span><span class="mf">9e14</span><span class="n">a5d4a3057f69ab95ab2d</span><span class="p">],</span> <span class="n">données</span> <span class="n">fiscales</span> <span class="n">prises</span> <span class="n">dans</span> <span class="n">la</span> <span class="n">couche</span> <span class="n">dao</span>
<a id="__codelineno-16-22" name="__codelineno-16-22"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.508940</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">55555</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">2814</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-16-23" name="__codelineno-16-23"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.510506</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;non&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">22986</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-16-24" name="__codelineno-16-24"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.511513</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="p">[</span><span class="n">index_controller</span><span class="p">]</span> <span class="n">client</span> <span class="p">[</span><span class="n">a06e8fd70a44c9e311f4dce0</span><span class="p">],</span> <span class="n">données</span> <span class="n">fiscales</span> <span class="n">prises</span> <span class="n">dans</span> <span class="n">la</span> <span class="n">couche</span> <span class="n">dao</span>
<a id="__codelineno-16-25" name="__codelineno-16-25"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.514939</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">1384</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">384</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">347</span><span class="p">}}}</span>
<a id="__codelineno-16-26" name="__codelineno-16-26"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.520727</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">7</span> <span class="p">:</span> <span class="p">[</span><span class="n">index_controller</span><span class="p">]</span> <span class="n">client</span> <span class="p">[</span><span class="mi">38499</span><span class="n">b63076516c02f2770ec</span><span class="p">],</span> <span class="n">données</span> <span class="n">fiscales</span> <span class="n">prises</span> <span class="n">dans</span> <span class="n">la</span> <span class="n">couche</span> <span class="n">dao</span>
<a id="__codelineno-16-27" name="__codelineno-16-27"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.523162</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">7</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">42842</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">17283</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-16-28" name="__codelineno-16-28"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.530835</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">9</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=non&amp;enfants=2&amp;salaire=100000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-16-29" name="__codelineno-16-29"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.531736</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">9</span> <span class="p">:</span> <span class="p">[</span><span class="n">index_controller</span><span class="p">]</span> <span class="n">client</span> <span class="p">[</span><span class="mf">700e3</span><span class="n">f5dc808c7c48f0c9007</span><span class="p">],</span> <span class="n">données</span> <span class="n">fiscales</span> <span class="n">prises</span> <span class="n">en</span> <span class="n">session</span>
<a id="__codelineno-16-30" name="__codelineno-16-30"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.531905</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">9</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;non&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">19884</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">4480</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-16-31" name="__codelineno-16-31"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.541899</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">10</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=oui&amp;enfants=2&amp;salaire=30000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-16-32" name="__codelineno-16-32"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.542488</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">10</span> <span class="p">:</span> <span class="p">[</span><span class="n">index_controller</span><span class="p">]</span> <span class="n">client</span> <span class="p">[</span><span class="mf">9e14</span><span class="n">a5d4a3057f69ab95ab2d</span><span class="p">],</span> <span class="n">données</span> <span class="n">fiscales</span> <span class="n">prises</span> <span class="n">en</span> <span class="n">session</span>
<a id="__codelineno-16-33" name="__codelineno-16-33"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.542488</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">10</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-16-34" name="__codelineno-16-34"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.553628</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">11</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=non&amp;enfants=0&amp;salaire=200000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-16-35" name="__codelineno-16-35"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.553628</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">11</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">mis</span> <span class="n">en</span> <span class="n">pause</span> <span class="n">du</span> <span class="n">thread</span> <span class="n">pendant</span> <span class="mi">1</span> <span class="n">seconde</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-16-36" name="__codelineno-16-36"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.736910</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">8</span> <span class="p">:</span> <span class="p">[</span><span class="n">index_controller</span><span class="p">]</span> <span class="n">client</span> <span class="p">[</span><span class="n">fa3c83b82761c83e13217967</span><span class="p">],</span> <span class="n">données</span> <span class="n">fiscales</span> <span class="n">prises</span> <span class="n">en</span> <span class="n">session</span>
<a id="__codelineno-16-37" name="__codelineno-16-37"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.737191</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">8</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">9200</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">2180</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-16-38" name="__codelineno-16-38"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.748226</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">12</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=oui&amp;enfants=5&amp;salaire=100000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-16-39" name="__codelineno-16-39"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">47.748226</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">12</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">mis</span> <span class="n">en</span> <span class="n">pause</span> <span class="n">du</span> <span class="n">thread</span> <span class="n">pendant</span> <span class="mi">1</span> <span class="n">seconde</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-16-40" name="__codelineno-16-40"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">48.554695</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">11</span> <span class="p">:</span> <span class="p">[</span><span class="n">index_controller</span><span class="p">]</span> <span class="n">client</span> <span class="p">[</span><span class="mf">9e14</span><span class="n">a5d4a3057f69ab95ab2d</span><span class="p">],</span> <span class="n">données</span> <span class="n">fiscales</span> <span class="n">prises</span> <span class="n">en</span> <span class="n">session</span>
<a id="__codelineno-16-41" name="__codelineno-16-41"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">48.555070</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">11</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;non&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">64210</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">7498</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.45</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-16-42" name="__codelineno-16-42"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">48.748753</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">12</span> <span class="p">:</span> <span class="p">[</span><span class="n">index_controller</span><span class="p">]</span> <span class="n">client</span> <span class="p">[</span><span class="n">fa3c83b82761c83e13217967</span><span class="p">],</span> <span class="n">données</span> <span class="n">fiscales</span> <span class="n">prises</span> <span class="n">en</span> <span class="n">session</span>
<a id="__codelineno-16-43" name="__codelineno-16-43"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">25</span> <span class="mi">10</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">48.748753</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">12</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">4230</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>on trouve le client <strong>[</strong><strong>fa3c83b82761c83e13217967</strong><strong>]</strong> pour la 1ère fois en ligne 14 : pour calculer l’impôt, le serveur a dû aller chercher en base les données de l’administration fiscale ;</li>
<li>puis on retrouve le client <strong>[</strong><strong>fa3c83b82761c83e13217967</strong><strong>]</strong> en ligne 36. Cette fois-ci, le serveur trouve les données de l’administration fiscale en session, ce qui lui évite un accès, possiblement coûteux, à la couche <strong>[dao]</strong> ;</li>
<li>on retrouve le client <strong>[</strong><strong>fa3c83b82761c83e13217967</strong><strong>]</strong> une 3ième fois en ligne 42, où là encore le serveur utilise la session du client ;
Cet exemple montre bien l’intérêt de la session pour un client : on y met des données partagées par toutes les requêtes de ce client et qui sont coûteuses à acquérir.</li>
</ul>
<p>Côté client, les résultats dans le fichier <strong>[data/output/résultats.json]</strong> sont les mêmes que pour les versions précédentes.</p>
<h2 id="254-tests-de-la-couche-dao">25.4. Tests de la couche [dao]</h2>
<p>Comme nous l’avons fait dans les |<a href="#_Tests_de_la"><u><u>versions précédentes</u></u></a>| nous testons la couche <strong>[dao]</strong> du client :</p>
<p><img src="images/10000000000003CF000003C7638DD447.png" style="width:11.27cm;height:11.171cm;" alt="Image" /></p>
<p>La classe de test sera exécutée dans l’environnement suivant :</p>
<p><img src="images/10000000000001AA000001F423CB28F2.png" style="width:4.911cm;height:5.781cm;" alt="Image" /></p>
<ul>
<li>la configuration <strong>[2]</strong> est identique à la configuration <strong>[1]</strong> que nous venons d’étudier ;
La classe de test <strong>[</strong><strong>TestHttpClientDao</strong><strong>]</strong> est la suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span>
<span class="normal"><a href="#__codelineno-17-20">20</a></span>
<span class="normal"><a href="#__codelineno-17-21">21</a></span>
<span class="normal"><a href="#__codelineno-17-22">22</a></span>
<span class="normal"><a href="#__codelineno-17-23">23</a></span>
<span class="normal"><a href="#__codelineno-17-24">24</a></span>
<span class="normal"><a href="#__codelineno-17-25">25</a></span>
<span class="normal"><a href="#__codelineno-17-26">26</a></span>
<span class="normal"><a href="#__codelineno-17-27">27</a></span>
<span class="normal"><a href="#__codelineno-17-28">28</a></span>
<span class="normal"><a href="#__codelineno-17-29">29</a></span>
<span class="normal"><a href="#__codelineno-17-30">30</a></span>
<span class="normal"><a href="#__codelineno-17-31">31</a></span>
<span class="normal"><a href="#__codelineno-17-32">32</a></span>
<span class="normal"><a href="#__codelineno-17-33">33</a></span>
<span class="normal"><a href="#__codelineno-17-34">34</a></span>
<span class="normal"><a href="#__codelineno-17-35">35</a></span>
<span class="normal"><a href="#__codelineno-17-36">36</a></span>
<span class="normal"><a href="#__codelineno-17-37">37</a></span>
<span class="normal"><a href="#__codelineno-17-38">38</a></span>
<span class="normal"><a href="#__codelineno-17-39">39</a></span>
<span class="normal"><a href="#__codelineno-17-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">unittest</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">Logger</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestHttpClientDao</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">TaxPayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaxPayer</span>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a>        <span class="c1"># {&#39;marié&#39;: &#39;oui&#39;, &#39;enfants&#39;: 2, &#39;salaire&#39;: 55555,</span>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a>        <span class="c1"># &#39;impôt&#39;: 2814, &#39;surcôte&#39;: 0, &#39;décôte&#39;: 0, &#39;réduction&#39;: 0, &#39;taux&#39;: 0.14}</span>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a>        <span class="n">taxpayer</span> <span class="o">=</span> <span class="n">TaxPayer</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">55555</span><span class="p">})</span>
<a id="__codelineno-17-14" name="__codelineno-17-14"></a>        <span class="n">dao</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">taxpayer</span><span class="p">)</span>
<a id="__codelineno-17-15" name="__codelineno-17-15"></a>        <span class="c1"># vérification</span>
<a id="__codelineno-17-16" name="__codelineno-17-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">impôt</span><span class="p">,</span> <span class="mi">2815</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-17-17" name="__codelineno-17-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">décôte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-17-18" name="__codelineno-17-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">réduction</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-17-19" name="__codelineno-17-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">taux</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<a id="__codelineno-17-20" name="__codelineno-17-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">surcôte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-17-21" name="__codelineno-17-21"></a><span class="err">…</span>
<a id="__codelineno-17-22" name="__codelineno-17-22"></a>
<a id="__codelineno-17-23" name="__codelineno-17-23"></a>
<a id="__codelineno-17-24" name="__codelineno-17-24"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-17-25" name="__codelineno-17-25"></a>    <span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-17-26" name="__codelineno-17-26"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-17-27" name="__codelineno-17-27"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({})</span>
<a id="__codelineno-17-28" name="__codelineno-17-28"></a>
<a id="__codelineno-17-29" name="__codelineno-17-29"></a>    <span class="c1"># logger</span>
<a id="__codelineno-17-30" name="__codelineno-17-30"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;logsFilename&quot;</span><span class="p">])</span>
<a id="__codelineno-17-31" name="__codelineno-17-31"></a>    <span class="c1"># on le mémorise dans la config</span>
<a id="__codelineno-17-32" name="__codelineno-17-32"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;logger&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-17-33" name="__codelineno-17-33"></a>    <span class="c1"># on récupère la factory de la couche [dao]</span>
<a id="__codelineno-17-34" name="__codelineno-17-34"></a>    <span class="n">dao_factory</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;dao_factory&quot;</span><span class="p">]</span>
<a id="__codelineno-17-35" name="__codelineno-17-35"></a>    <span class="c1"># on crée une instance de la couche [dao]</span>
<a id="__codelineno-17-36" name="__codelineno-17-36"></a>    <span class="n">dao</span> <span class="o">=</span> <span class="n">dao_factory</span><span class="o">.</span><span class="n">new_instance</span><span class="p">()</span>
<a id="__codelineno-17-37" name="__codelineno-17-37"></a>
<a id="__codelineno-17-38" name="__codelineno-17-38"></a>    <span class="c1"># on exécute les méthodes de test</span>
<a id="__codelineno-17-39" name="__codelineno-17-39"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tests en cours...&quot;</span><span class="p">)</span>
<a id="__codelineno-17-40" name="__codelineno-17-40"></a>    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>on crée une |<a href="#_Tests_de_la"><u><u>configuration d’exécution</u></u></a>| pour ce test ;</li>
<li>on lance le serveur web avec tout son environnement ;</li>
<li>on exécute le test ;
Les résultats sont les suivants :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span>
<span class="normal"><a href="#__codelineno-18-3">3</a></span>
<span class="normal"><a href="#__codelineno-18-4">4</a></span>
<span class="normal"><a href="#__codelineno-18-5">5</a></span>
<span class="normal"><a href="#__codelineno-18-6">6</a></span>
<span class="normal"><a href="#__codelineno-18-7">7</a></span>
<span class="normal"><a href="#__codelineno-18-8">8</a></span>
<span class="normal"><a href="#__codelineno-18-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">Scripts</span>\<span class="n">python</span><span class="o">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">st</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">cours</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">impots</span><span class="o">/</span><span class="n">http</span><span class="o">-</span><span class="n">clients</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">TestHttpClientDao</span><span class="o">.</span><span class="n">py</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="n">tests</span> <span class="n">en</span> <span class="n">cours</span><span class="o">...</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="o">...........</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="o">----------------------------------------------------------------------</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="n">Ran</span> <span class="mi">11</span> <span class="n">tests</span> <span class="ow">in</span> <span class="mf">3.392</span><span class="n">s</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="n">OK</span>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="n">Process</span> <span class="n">finished</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner">

      <div>
        <a href="https://tahe.developpez.com" target="_blank">
          https://tahe.developpez.com
        </a>
        <br>
        Ce cours tutoriel écrit par <strong>Serge Tahé</strong> est mis à disposition du public selon les termes de la
        <em>Licence Creative Commons Attribution – Pas d’Utilisation Commerciale –
        Partage dans les Mêmes Conditions 3.0 non transposé</em>.
      </div>

    </div>
  </div>

      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": ".", "features": ["navigation.sections", "navigation.indexes", "toc.integrate", "navigation.top"], "search": "assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="javascripts/focus.js"></script>
      
    
  </body>
</html>