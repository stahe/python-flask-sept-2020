
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Introduction au langage Python 3 et au framework web Flask par l'exemple">
      
      
        <meta name="author" content="Serge Tahé">
      
      
        <link rel="canonical" href="https://stahe.github.io/python-flask-sept-2020/utilisation-de-lorm-sqlalchemy.html">
      
      
        <link rel="prev" href="ecrire-du-code-independant-du-sgbd.html">
      
      
        <link rel="next" href="exercice-dx27application-version-5.html">
      
      
        
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>19. Utilisation de l’ORM SQLALCHEMY - Introduction au langage Python 3 et au framework web Flask par l'exemple</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="stylesheets/focus.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#19-utilisation-de-lorm-sqlalchemy" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Introduction au langage Python 3 et au framework web Flask par l&#39;exemple" class="md-header__button md-logo" aria-label="Introduction au langage Python 3 et au framework web Flask par l'exemple" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Introduction au langage Python 3 et au framework web Flask par l'exemple
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              19. Utilisation de l’ORM SQLALCHEMY
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode sombre"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Passer au mode sombre" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode clair"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Passer au mode clair" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/stahe/python-flask-sept-2020" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Introduction au langage Python 3 et au framework web Flask par l&#39;exemple" class="md-nav__button md-logo" aria-label="Introduction au langage Python 3 et au framework web Flask par l'exemple" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Introduction au langage Python 3 et au framework web Flask par l'exemple
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/stahe/python-flask-sept-2020" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accueil
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="avant-propos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Avant-propos
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="installation-dx27un-environnement-de-travail.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Installation d&#x27;un environnement de travail
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-bases-de-python.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Les bases de Python
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-chaines-de-caracteres.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Les chaînes de caractères
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-exceptions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Les exceptions
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-fonctions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Les fonctions
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-fichiers-texte.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    7. Les fichiers texte
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application---version-1.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    8. Exercice d&#x27;application – version 1
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-imports.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    9. Les imports
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-2.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    10. Exercice d’application : version 2
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-3.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    11. Exercice d’application : version 3
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-classes-et-objets.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    12. Les classes et objets
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-classes-generiques-baseentity-et-myexception.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    13. Les classes génériques [BaseEntity] et [MyException]
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="architecture-en-couches-et-programmation-par-interfaces.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    14. Architecture en couches et programmation par interfaces
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application---version-4.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    15. Exercice d&#x27;application - version 4
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-du-sgbd-mysql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    16. Utilisation du SGBD MySQL
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-du-sgbd-postgresql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    17. Utilisation du SGBD PostgreSQL
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="ecrire-du-code-independant-du-sgbd.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    18. Ecrire du code indépendant du SGBD
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    19. Utilisation de l’ORM SQLALCHEMY
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="utilisation-de-lorm-sqlalchemy.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    19. Utilisation de l’ORM SQLALCHEMY
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#191-installation-de-lorm-sqlalchemy" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.1. Installation de l’ORM [sqlalchemy]
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#192-scripts-01-les-bases" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.2. Scripts 01 : les bases
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="19.2. Scripts 01 : les bases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1921-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.2.1. Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1922-script-demo" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.2.2. Script [démo]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1923-le-script-main" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.2.3. Le script [main]
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#193-scripts-02-les-mappings-de-sqlalchemy" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.3. Scripts 02 : les mappings de [sqlalchemy]
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#194-scripts-03-manipulation-des-entites-de-la-session-sqlalchemy" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.4. Scripts 03 : manipulation des entités de la session [sqlalchemy]
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#195-scripts-04-utilisation-dune-base-postgresql" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.5. Scripts 04 : utilisation d’une base [PostgreSQL]
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#196-scripts-05-exemple-complet" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.6. Scripts 05 : exemple complet
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="19.6. Scripts 05 : exemple complet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1961-larchitecture-de-lapplication" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.6.1. L’architecture de l’application
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1962-les-bases-de-donnees" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.6.2. Les bases de données
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1963-les-entites-manipulees-par-lapplication" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.6.3. Les entités manipulées par l’application
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1964-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.6.4. Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1965-la-couche-dao-1" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.6.5. La couche [dao] - 1
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1966-initialisation-de-la-base-de-donnees" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.6.6. Initialisation de la base de données
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1967-la-couche-dao-2" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.6.7. La couche [dao] – 2
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1968-le-script-main_joined_queries" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.6.8. Le script [main_joined_queries]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1969-le-script-main_stats_for_eleve" class="md-nav__link">
    <span class="md-ellipsis">
      
        19.6.9. Le script [main_stats_for_élève]
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application-version-5.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    20. Exercice d&#x27;application : version 5
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="fonctions-internet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    21. Fonctions internet
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="services-web-avec-le-framework-flask.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    22. Services web avec le framework Flask
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-6.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    23. Exercice d’application : version 6
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-7.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    24. Exercice d’application : version 7
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-8.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    25. Exercice d’application : version 8
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="du-dictionnaire-a-xml-et-vice-versa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    26. Du dictionnaire à XML et vice-versa
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-9.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    27. Exercice d’application : version 9
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-10.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    28. Exercice d’application : version 10
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-11.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    29. Exercice d’application : version 11
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    30. Exercice d’application : version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="clients-web-pour-les-services-json-et-xml-de-la-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    31. Clients web pour les services jSON et XML de la version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="le-mode-html-de-la-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    32. Le mode HTML de la version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-13.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    33. Exercice d’application : version 13
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-14.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    34. Exercice d’application : version 14
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-15.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    35. Exercice d’application : version 15
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-16.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    36. Exercice d’application : version 16
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-17.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    37. Exercice d’application : version 17
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-18.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    38. Exercice d’application : version 18
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="conclusion.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    39. Conclusion
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="19-utilisation-de-lorm-sqlalchemy">19. Utilisation de l’ORM SQLALCHEMY</h1>
<p>Le chapitre précédent a montré que dans certains cas on pouvait écrire du code indépendant du SGBD utilisé avec l’architecture suivante :</p>
<p><img src="images/10000000000003B4000000E6700B9C1D.png" style="width:10.951cm;height:2.661cm;" alt="Image" /></p>
<p>Dans ce chapitre nous allons utiliser l’ORM (Object Relational Mapper) <strong>[sqlalchemy]</strong> pour accéder aux SGBD de façon uniforme quelque soit le SGBD utilisé. Un ORM permet deux choses :</p>
<ul>
<li>il permet à un script de dialoguer avec le SGBD sans émettre d’ordres SQL ;</li>
<li>il masque au script les particularités de chaque SGBD ;
L’architecture devient la suivante :</li>
</ul>
<p><img src="images/10000000000004720000016D5DDF6324.png" style="width:13.151cm;height:4.22cm;" alt="Image" /></p>
<p>Le script est désormais séparé des connecteurs par l’ORM. Il dialogue avec l’ORM avec des classes et des méthodes. Il n’exécute pas de code SQL. C’est l’ORM qui le fait avec les connecteurs auxquels il est relié. Il cache au script les particularités de ces connecteurs. Aussi le code du script est-il insensible à un changement de connecteur (donc du SGBD) ;</p>
<p>L’arborescence des scripts étudiés sera la suivante :</p>
<p><img src="images/100000000000010100000175309D0E1A.png" style="width:2.971cm;height:4.301cm;" alt="Image" /></p>
<h2 id="191-installation-de-lorm-sqlalchemy">19.1. Installation de l’ORM [sqlalchemy]</h2>
<p>L’ORM <strong>[sqlalchemy]</strong> vient sous la forme d’un package python qu’il faut installer dans un terminal Python :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="p">(</span><span class="n">venv</span><span class="p">)</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">databases</span>\<span class="n">sqlalchemy</span><span class="o">&gt;</span><span class="n">pip</span> <span class="n">install</span> <span class="n">sqlalchemy</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="n">Collecting</span> <span class="n">sqlalchemy</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>  <span class="n">Downloading</span> <span class="n">SQLAlchemy</span><span class="o">-</span><span class="mf">1.3.18</span><span class="o">-</span><span class="n">cp38</span><span class="o">-</span><span class="n">cp38</span><span class="o">-</span><span class="n">win_amd64</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mf">1.2</span> <span class="n">MB</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>     <span class="o">||</span> <span class="mf">1.2</span> <span class="n">MB</span> <span class="mf">3.3</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="n">Installing</span> <span class="n">collected</span> <span class="n">packages</span><span class="p">:</span> <span class="n">sqlalchemy</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="n">Successfully</span> <span class="n">installed</span> <span class="n">sqlalchemy</span><span class="o">-</span><span class="mf">1.3.18</span>
</code></pre></div></td></tr></table></div>
<h2 id="192-scripts-01-les-bases">19.2. Scripts 01 : les bases</h2>
<p><img src="images/10000000000004730000018C58EFD1D0.png" style="width:13.14cm;height:4.56cm;" alt="Image" /></p>
<ul>
<li>en <strong>[1]</strong>, les scripts qui vont être étudiés. Ces scripts vont utiliser les classes de <strong>[2]</strong> : BaseEntity, MyException, Personne, Utils ;</li>
</ul>
<h3 id="1921-configuration">19.2.1. Configuration</h3>
<p>Le fichier <strong>[config]</strong> configure l’application de la façon suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">():</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>    <span class="c1"># root_dir</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>    <span class="c1"># chemin absolu référence des chemins relatifs de la configuration</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>    <span class="n">root_dir</span> <span class="o">=</span> <span class="s2">&quot;C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020&quot;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>    <span class="c1"># chemins absolus des dépendances</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>    <span class="n">absolute_dependencies</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>        <span class="c1"># BaseEntity, MyException, Personne, Utils</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/classes/02/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>    <span class="p">]</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>    <span class="c1"># on fixe le syspath</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_syspath</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>    <span class="n">set_syspath</span><span class="p">(</span><span class="n">absolute_dependencies</span><span class="p">)</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a>    <span class="c1"># configuration des classes</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Personne</span><span class="w"> </span><span class="kn">import</span> <span class="n">Personne</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a>    <span class="n">Personne</span><span class="o">.</span><span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_sa_instance_state&#39;</span><span class="p">]</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a>    <span class="c1"># on rend la config</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a>    <span class="k">return</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
<p><strong>Commentaires</strong></p>
<ul>
<li>ligne 8 : on met dans le Python Path le dossier contenant les classes <strong>[</strong><strong>BaseEntity, MyException, Personne, Utils</strong><strong>]</strong> ;</li>
<li>lignes 12-13 : on fixe le Python Path de l’application ;</li>
<li>lignes 16-17 : on se rappelle peut-être que la classe |<a href="#_La_classe_[BaseEntity]"><u><u>BaseEntity</u></u></a>| a un attribut de classe nommé <strong>[excluded_keys]</strong>. Cet attribut est une liste dans laquelle on met les propriétés de la classe qu’on ne veut pas voir apparaître dans le dictionnaire de celle-ci (fonction asdict). Ici on exclut la propriété <strong>[</strong><strong>_sa_instance_state</strong><strong>]</strong> de l’état de la classe <strong>[Personne]</strong>. On verra bientôt pourquoi ;</li>
</ul>
<h3 id="1922-script-demo">19.2.2. Script [démo]</h3>
<p>Le script <strong>[démo]</strong> montre une première utilisation de l’ORM <strong>[sqlalchemy]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span>
<span class="normal"><a href="#__codelineno-2-22">22</a></span>
<span class="normal"><a href="#__codelineno-2-23">23</a></span>
<span class="normal"><a href="#__codelineno-2-24">24</a></span>
<span class="normal"><a href="#__codelineno-2-25">25</a></span>
<span class="normal"><a href="#__codelineno-2-26">26</a></span>
<span class="normal"><a href="#__codelineno-2-27">27</a></span>
<span class="normal"><a href="#__codelineno-2-28">28</a></span>
<span class="normal"><a href="#__codelineno-2-29">29</a></span>
<span class="normal"><a href="#__codelineno-2-30">30</a></span>
<span class="normal"><a href="#__codelineno-2-31">31</a></span>
<span class="normal"><a href="#__codelineno-2-32">32</a></span>
<span class="normal"><a href="#__codelineno-2-33">33</a></span>
<span class="normal"><a href="#__codelineno-2-34">34</a></span>
<span class="normal"><a href="#__codelineno-2-35">35</a></span>
<span class="normal"><a href="#__codelineno-2-36">36</a></span>
<span class="normal"><a href="#__codelineno-2-37">37</a></span>
<span class="normal"><a href="#__codelineno-2-38">38</a></span>
<span class="normal"><a href="#__codelineno-2-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1"># on récupère la configuration de l&#39;application</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="c1"># imports</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">UniqueConstraint</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapper</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Personne</span><span class="w"> </span><span class="kn">import</span> <span class="n">Personne</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="c1"># metadata</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="c1"># la table</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="n">personnes_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;personnes&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>                        <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a>                        <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;prenom&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a>                        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;nom&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>                        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a>                        <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;nom&#39;</span><span class="p">,</span> <span class="s1">&#39;prenom&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;uix_1&#39;</span><span class="p">)</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a>                        <span class="p">)</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="c1"># la classe Personne avant le mapping</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="n">personne1</span> <span class="o">=</span> <span class="n">Personne</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">67</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;personne1=</span><span class="si">{</span><span class="n">personne1</span><span class="o">.</span><span class="vm">__dict__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="c1"># le mapping</span>
<a id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="n">mapper</span><span class="p">(</span><span class="n">Personne</span><span class="p">,</span> <span class="n">personnes_table</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-2-29" name="__codelineno-2-29"></a>    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">personnes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-2-30" name="__codelineno-2-30"></a>    <span class="s1">&#39;prénom&#39;</span><span class="p">:</span> <span class="n">personnes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">prenom</span><span class="p">,</span>
<a id="__codelineno-2-31" name="__codelineno-2-31"></a>    <span class="s1">&#39;nom&#39;</span><span class="p">:</span> <span class="n">personnes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">nom</span><span class="p">,</span>
<a id="__codelineno-2-32" name="__codelineno-2-32"></a>    <span class="s1">&#39;âge&#39;</span><span class="p">:</span> <span class="n">personnes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">age</span>
<a id="__codelineno-2-33" name="__codelineno-2-33"></a><span class="p">})</span>
<a id="__codelineno-2-34" name="__codelineno-2-34"></a>
<a id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="c1"># personne1 n&#39;a pas été modifiée</span>
<a id="__codelineno-2-36" name="__codelineno-2-36"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;personne1=</span><span class="si">{</span><span class="n">personne1</span><span class="o">.</span><span class="vm">__dict__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-37" name="__codelineno-2-37"></a><span class="c1"># la classe Personne a elle été modifiée - elle a été &quot;enrichie&quot;</span>
<a id="__codelineno-2-38" name="__codelineno-2-38"></a><span class="n">personne2</span> <span class="o">=</span> <span class="n">Personne</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">})</span>
<a id="__codelineno-2-39" name="__codelineno-2-39"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;personne2=</span><span class="si">{</span><span class="n">personne2</span><span class="o">.</span><span class="vm">__dict__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p><strong>Commentaires</strong></p>
<ul>
<li>lignes 1-4 : on configure l’application ;</li>
<li>lignes 6-10 : on importe les modules nécessaires au script ;</li>
<li>ligne 13 : <strong>[MetaData]</strong> est une classe de <strong>[sqlalchemy]</strong> ;</li>
<li>lignes 15-22 : <strong>[Table]</strong> est une classe de <strong>[sqlalchemy]</strong>. Elle permet de décrire une table d’une base de données. Ici, nous allons décrire la table <strong>[personnes]</strong> de la base MySQL <strong>[dbpersonnes]</strong> étudiée au chapitre |<a href="#_Utilisation_du_SGBD"><u><u>MySQL</u></u></a>| ;</li>
<li>ligne 16 : le 1er paramètre <strong>[personnes]</strong> est le nom de la table décrite ;</li>
<li>ligne 16 : le second paramètre <strong>[metadata]</strong> est l’instance <strong>[MetaData]</strong> créée ligne 13 ;</li>
<li>lignes 17-22 : chacun des paramètres suivants décrit une colonne de la table avec une syntaxe propre à <strong>[sqlalchemy]</strong> mais proche de la syntaxe SQL ;</li>
<li>chaque colonne se décrit avec une instance de la classe <strong>[Column]</strong> de <strong>[sqlalchemy]</strong> ;</li>
<li>le 1er paramètre est le nom de la colonne ;</li>
<li>le second paramètre est son type ;</li>
<li>les paramètres suivants sont des paramètres nommés :</li>
<li>ligne 17 : <strong>[</strong><strong>primary_key=</strong><strong>True</strong><strong>]</strong> pour indiquer que la colonne <strong>[id]</strong> est clé primaire de la table <strong>[personnes]</strong> ;</li>
<li>ligne 18 : <strong>[</strong><strong>nullable=</strong><strong>False</strong><strong>]</strong> pour indiquer qu’uen colonne doit forcément avoir une valeur lorsqu’une ligne est insérée dans la table ;</li>
<li>ligne 21 : enfin la classe <strong>[UniqueConstraint]</strong> permet de décrire une contrainte d’unicité. Ici on indique que les colonnes (nom, prenom) doivent être uniques dans la table. La propriété nommée <strong>[name]</strong> permet de donner un nom à cette constrainte. Ici, il faut distinguer deux cas :</li>
<li>on décrit une table existante. Il faut alors chercher le nom de la contrainte dans les propriétés de la table (phpMyAdmin ou pgAdmin) ;</li>
<li>on décrit une table que l’on va créer. Alors on met le nom que l’on veut ;</li>
<li>
<p>lignes 23-25 : on crée une personne <strong>[personne1]</strong> et on affiche son dictionnaire <strong>[<strong>dict</strong>]</strong>. On va avoir ici :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">personne1</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;_BaseEntity__id&#39;</span><span class="p">:</span> <span class="mi">67</span><span class="p">,</span> <span class="s1">&#39;_Personne__prénom&#39;</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;_Personne__nom&#39;</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;_Personne__âge&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>lignes 27-33 : on fait un mapping, ç-à-d qu’on crée une correspondance entre la classe <strong>[Personne]</strong> et la table <strong>[personnes]</strong>. C’est essentiellement une correspondance <strong>[propriétés de la classe </strong><strong></strong><strong> colonnes de la table]</strong>. La fonction <strong>[mapper]</strong> accepte ici trois paramètres :</p>
</li>
<li>ligne 28 : le 1er paramètre est le nom de la classe pour laquelle on fait le mapping ;</li>
<li>ligne 28 : le second paramètre est la table à laquelle elle va être associée. Celle-ci est l’objet <strong>[Table]</strong> créé ligne 16 ;</li>
<li>ligne 28 : le 3ième paramètre est ici un paramètre nommé <strong>[properties]</strong>. C’est un dictionnaire dans lequel les clés sont les propriétés de la classe mappée et les valeurs les colonnes de la table mappée. Pour désigner la colonne X de la table <strong>[personnes_table]</strong>, on écrit <strong>[personnes_table.c.X]</strong> ;</li>
<li>
<p>lignes 35-36 : on réaffiche la personne <strong>[personne1]</strong> une fois le mapping fait. On constate qu’elle n’a pas changé :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="n">personne1</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;_BaseEntity__id&#39;</span><span class="p">:</span> <span class="mi">67</span><span class="p">,</span> <span class="s1">&#39;_Personne__prénom&#39;</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;_Personne__nom&#39;</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;_Personne__âge&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>lignes 37-39 : on crée une nouvelle personne <strong>[personne2]</strong> et on l’affiche. On a alors l’affichage suivant :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="n">personne2</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;_sa_instance_state&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">InstanceState</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x00000259A6747FA0</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span> <span class="s1">&#39;prénom&#39;</span><span class="p">:</span> <span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="s1">&#39;nom&#39;</span><span class="p">:</span> <span class="s1">&#39;y1&#39;</span><span class="p">,</span> <span class="s1">&#39;âge&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
</li>
</ul>
<p>On constate que le dictionnaire <strong>[<strong>dict</strong>]</strong> a été profondément modifié :</p>
<ul>
<li>une nouvelle propriété <strong>[</strong><strong>_sa_instance_state</strong><strong>]</strong> apparaît. On voit que c’est un objet de l’ORM <strong>[sqlalchemy]</strong> ;</li>
<li>les autres propriétés ont été débarrassées de leur préfixe qui indiquait à quelle classe elles appartenaient ;
On peut donc conclure que l’opération de mapping des lignes 27-33 a modifié la classe <strong>[Personne]</strong>.</li>
</ul>
<p>Lorsqu’on voudra afficher l’état d’un objet <strong>[Personne]</strong>, on ne voudra pas en général de la propriété <strong>[</strong><strong>_sa_instance_state</strong><strong>]</strong>. Elle n’est là en effet que pour la cuisine interne de <strong>[sqlalchemy]</strong> et en général elle ne nous intéresse pas. C’est pourquoi on a écrit dans le script <strong>[config]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a>    <span class="c1"># configuration des classes</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Personne</span><span class="w"> </span><span class="kn">import</span> <span class="n">Personne</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>    <span class="n">Personne</span><span class="o">.</span><span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_sa_instance_state&#39;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
<h3 id="1923-le-script-main">19.2.3. Le script [main]</h3>
<p>Le script <strong>[main]</strong> va manipuler la table <strong>[personnes]</strong> de la base MySQL <strong>[dbpersonnes]</strong> en s’interfaçant avec <strong>[sqlalchemy]</strong>. Pour comprendre la suite, il faut se rappeler l’architecture utilisée ici :</p>
<p><img src="images/10000000000004720000016D5DDF6324.png" style="width:13.151cm;height:4.22cm;" alt="Image" /></p>
<p>Si <strong>[Database1]</strong> est la base <strong>[dbpersonnes]</strong>, on voit que la liaison entre le script et cette base passe par deux entités :</p>
<ul>
<li>le connecteur Python au SGBD MySQL ;</li>
<li>le SGBD MySQL ;
Le script <strong>[main]</strong> va dialoguer avec l’ORM qui va ensuite dialoguer avec le connecteur Python. L’ORM dialogue avec ce connecteur avec les outils décrits dans les paragraphes |<a href="#_Intallation_du_SGBD"><u><u>MySQL</u></u></a>| et |<a href="#_Utilisation_du_SGBD_1"><u><u>PostgreSQL</u></u></a>| notamment en émettant des ordres SQL. Le script <strong>[main]</strong> ne va pas utiliser d’ordres SQL. Il va s’appuyer sur l’API (Application Programming Interface) de l’ORM, faite de classes et d’interfaces.</li>
</ul>
<p>Le script <strong>[main]</strong> est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span>
<span class="normal"><a href="#__codelineno-7-34">34</a></span>
<span class="normal"><a href="#__codelineno-7-35">35</a></span>
<span class="normal"><a href="#__codelineno-7-36">36</a></span>
<span class="normal"><a href="#__codelineno-7-37">37</a></span>
<span class="normal"><a href="#__codelineno-7-38">38</a></span>
<span class="normal"><a href="#__codelineno-7-39">39</a></span>
<span class="normal"><a href="#__codelineno-7-40">40</a></span>
<span class="normal"><a href="#__codelineno-7-41">41</a></span>
<span class="normal"><a href="#__codelineno-7-42">42</a></span>
<span class="normal"><a href="#__codelineno-7-43">43</a></span>
<span class="normal"><a href="#__codelineno-7-44">44</a></span>
<span class="normal"><a href="#__codelineno-7-45">45</a></span>
<span class="normal"><a href="#__codelineno-7-46">46</a></span>
<span class="normal"><a href="#__codelineno-7-47">47</a></span>
<span class="normal"><a href="#__codelineno-7-48">48</a></span>
<span class="normal"><a href="#__codelineno-7-49">49</a></span>
<span class="normal"><a href="#__codelineno-7-50">50</a></span>
<span class="normal"><a href="#__codelineno-7-51">51</a></span>
<span class="normal"><a href="#__codelineno-7-52">52</a></span>
<span class="normal"><a href="#__codelineno-7-53">53</a></span>
<span class="normal"><a href="#__codelineno-7-54">54</a></span>
<span class="normal"><a href="#__codelineno-7-55">55</a></span>
<span class="normal"><a href="#__codelineno-7-56">56</a></span>
<span class="normal"><a href="#__codelineno-7-57">57</a></span>
<span class="normal"><a href="#__codelineno-7-58">58</a></span>
<span class="normal"><a href="#__codelineno-7-59">59</a></span>
<span class="normal"><a href="#__codelineno-7-60">60</a></span>
<span class="normal"><a href="#__codelineno-7-61">61</a></span>
<span class="normal"><a href="#__codelineno-7-62">62</a></span>
<span class="normal"><a href="#__codelineno-7-63">63</a></span>
<span class="normal"><a href="#__codelineno-7-64">64</a></span>
<span class="normal"><a href="#__codelineno-7-65">65</a></span>
<span class="normal"><a href="#__codelineno-7-66">66</a></span>
<span class="normal"><a href="#__codelineno-7-67">67</a></span>
<span class="normal"><a href="#__codelineno-7-68">68</a></span>
<span class="normal"><a href="#__codelineno-7-69">69</a></span>
<span class="normal"><a href="#__codelineno-7-70">70</a></span>
<span class="normal"><a href="#__codelineno-7-71">71</a></span>
<span class="normal"><a href="#__codelineno-7-72">72</a></span>
<span class="normal"><a href="#__codelineno-7-73">73</a></span>
<span class="normal"><a href="#__codelineno-7-74">74</a></span>
<span class="normal"><a href="#__codelineno-7-75">75</a></span>
<span class="normal"><a href="#__codelineno-7-76">76</a></span>
<span class="normal"><a href="#__codelineno-7-77">77</a></span>
<span class="normal"><a href="#__codelineno-7-78">78</a></span>
<span class="normal"><a href="#__codelineno-7-79">79</a></span>
<span class="normal"><a href="#__codelineno-7-80">80</a></span>
<span class="normal"><a href="#__codelineno-7-81">81</a></span>
<span class="normal"><a href="#__codelineno-7-82">82</a></span>
<span class="normal"><a href="#__codelineno-7-83">83</a></span>
<span class="normal"><a href="#__codelineno-7-84">84</a></span>
<span class="normal"><a href="#__codelineno-7-85">85</a></span>
<span class="normal"><a href="#__codelineno-7-86">86</a></span>
<span class="normal"><a href="#__codelineno-7-87">87</a></span>
<span class="normal"><a href="#__codelineno-7-88">88</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="c1"># imports</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">UniqueConstraint</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.exc</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntegrityError</span><span class="p">,</span> <span class="n">InterfaceError</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">sessionmaker</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Personne</span><span class="w"> </span><span class="kn">import</span> <span class="n">Personne</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="c1"># chaîne de connexion à une base de données MySQL</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;mysql+mysqlconnector://admpersonnes:nobody@localhost/dbpersonnes&quot;</span><span class="p">)</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="c1"># metadata</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="c1"># la table</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="n">personnes_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;personnes&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a>                        <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a>                        <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;prenom&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a>                        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;nom&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a>                        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a>                        <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;nom&#39;</span><span class="p">,</span> <span class="s1">&#39;prenom&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;uix_1&#39;</span><span class="p">)</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a>                        <span class="p">)</span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="c1"># le mapping</span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a><span class="n">mapper</span><span class="p">(</span><span class="n">Personne</span><span class="p">,</span> <span class="n">personnes_table</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a>    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">personnes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-7-31" name="__codelineno-7-31"></a>    <span class="s1">&#39;prénom&#39;</span><span class="p">:</span> <span class="n">personnes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">prenom</span><span class="p">,</span>
<a id="__codelineno-7-32" name="__codelineno-7-32"></a>    <span class="s1">&#39;nom&#39;</span><span class="p">:</span> <span class="n">personnes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">nom</span><span class="p">,</span>
<a id="__codelineno-7-33" name="__codelineno-7-33"></a>    <span class="s1">&#39;âge&#39;</span><span class="p">:</span> <span class="n">personnes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">age</span>
<a id="__codelineno-7-34" name="__codelineno-7-34"></a><span class="p">})</span>
<a id="__codelineno-7-35" name="__codelineno-7-35"></a>
<a id="__codelineno-7-36" name="__codelineno-7-36"></a><span class="c1"># la session factory</span>
<a id="__codelineno-7-37" name="__codelineno-7-37"></a><span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()</span>
<a id="__codelineno-7-38" name="__codelineno-7-38"></a><span class="n">Session</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<a id="__codelineno-7-39" name="__codelineno-7-39"></a>
<a id="__codelineno-7-40" name="__codelineno-7-40"></a><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-41" name="__codelineno-7-41"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-7-42" name="__codelineno-7-42"></a>    <span class="c1"># une session</span>
<a id="__codelineno-7-43" name="__codelineno-7-43"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
<a id="__codelineno-7-44" name="__codelineno-7-44"></a>
<a id="__codelineno-7-45" name="__codelineno-7-45"></a>    <span class="c1"># suppression de la table [personnes]</span>
<a id="__codelineno-7-46" name="__codelineno-7-46"></a>    <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;drop table if exists personnes&quot;</span><span class="p">)</span>
<a id="__codelineno-7-47" name="__codelineno-7-47"></a>
<a id="__codelineno-7-48" name="__codelineno-7-48"></a>    <span class="c1"># recréation de la table à partir du mapping</span>
<a id="__codelineno-7-49" name="__codelineno-7-49"></a>    <span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<a id="__codelineno-7-50" name="__codelineno-7-50"></a>
<a id="__codelineno-7-51" name="__codelineno-7-51"></a>    <span class="c1"># une insertion</span>
<a id="__codelineno-7-52" name="__codelineno-7-52"></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Personne</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">67</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}))</span>
<a id="__codelineno-7-53" name="__codelineno-7-53"></a>    <span class="c1"># session.commit()</span>
<a id="__codelineno-7-54" name="__codelineno-7-54"></a>
<a id="__codelineno-7-55" name="__codelineno-7-55"></a>    <span class="c1"># une requête</span>
<a id="__codelineno-7-56" name="__codelineno-7-56"></a>    <span class="n">personnes</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Personne</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-7-57" name="__codelineno-7-57"></a>
<a id="__codelineno-7-58" name="__codelineno-7-58"></a>    <span class="c1"># affichage</span>
<a id="__codelineno-7-59" name="__codelineno-7-59"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Liste des personnes ---------&quot;</span><span class="p">)</span>
<a id="__codelineno-7-60" name="__codelineno-7-60"></a>    <span class="k">for</span> <span class="n">personne</span> <span class="ow">in</span> <span class="n">personnes</span><span class="p">:</span>
<a id="__codelineno-7-61" name="__codelineno-7-61"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">personne</span><span class="p">)</span>
<a id="__codelineno-7-62" name="__codelineno-7-62"></a>
<a id="__codelineno-7-63" name="__codelineno-7-63"></a>    <span class="c1"># deux autres insertions dont la seconde échoue à cause de l&#39;unicité (prénom,nom)</span>
<a id="__codelineno-7-64" name="__codelineno-7-64"></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Personne</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}))</span>
<a id="__codelineno-7-65" name="__codelineno-7-65"></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Personne</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">69</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}))</span>
<a id="__codelineno-7-66" name="__codelineno-7-66"></a>
<a id="__codelineno-7-67" name="__codelineno-7-67"></a>    <span class="c1"># une requête</span>
<a id="__codelineno-7-68" name="__codelineno-7-68"></a>    <span class="n">personnes</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Personne</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-7-69" name="__codelineno-7-69"></a>
<a id="__codelineno-7-70" name="__codelineno-7-70"></a>    <span class="c1"># affichage</span>
<a id="__codelineno-7-71" name="__codelineno-7-71"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Liste des personnes ---------&quot;</span><span class="p">)</span>
<a id="__codelineno-7-72" name="__codelineno-7-72"></a>    <span class="k">for</span> <span class="n">personne</span> <span class="ow">in</span> <span class="n">personnes</span><span class="p">:</span>
<a id="__codelineno-7-73" name="__codelineno-7-73"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">personne</span><span class="p">)</span>
<a id="__codelineno-7-74" name="__codelineno-7-74"></a>
<a id="__codelineno-7-75" name="__codelineno-7-75"></a>    <span class="c1"># validation de la session</span>
<a id="__codelineno-7-76" name="__codelineno-7-76"></a>    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-7-77" name="__codelineno-7-77"></a>
<a id="__codelineno-7-78" name="__codelineno-7-78"></a><span class="k">except</span> <span class="p">(</span><span class="n">InterfaceError</span><span class="p">,</span> <span class="n">IntegrityError</span><span class="p">)</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-7-79" name="__codelineno-7-79"></a>    <span class="c1"># affichage</span>
<a id="__codelineno-7-80" name="__codelineno-7-80"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-7-81" name="__codelineno-7-81"></a>    <span class="c1"># annulation de la dernière session</span>
<a id="__codelineno-7-82" name="__codelineno-7-82"></a>    <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-7-83" name="__codelineno-7-83"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rollback...&quot;</span><span class="p">)</span>
<a id="__codelineno-7-84" name="__codelineno-7-84"></a>        <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-7-85" name="__codelineno-7-85"></a><span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-7-86" name="__codelineno-7-86"></a>    <span class="c1"># on libère les ressources de la session</span>
<a id="__codelineno-7-87" name="__codelineno-7-87"></a>    <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-7-88" name="__codelineno-7-88"></a>        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p><strong>Commentaires</strong></p>
<ul>
<li>lignes 1-4 : l’application est configurée ;</li>
<li>lignes 7-9 : on importe toute une série de classes et d’interfaces de la bibliothèque <strong>[sqlalchemy]</strong> ;</li>
<li>ligne 11 : la classe <strong>[Personne]</strong> est importée ;</li>
<li>ligne 14 : la chaîne de connexion à la base de données. Elle précise :</li>
<li>le SGBD utilisé (mysql) ;</li>
<li>le connecteur Python utilisé (mysql.connector sans le .) ;</li>
<li>l’utilisateur qui se connecte (admpersonnes) ;</li>
<li>son mot de passe (nobody) ;</li>
<li>la machine sur laquelle se trouve le SGBD (localhost=machine sur laquelle se trouve le script qui s’exécute) ;</li>
<li>
<p>le nom de la base de données (dbpersonnes) ;
Avec ces informations, <strong>[sqlalchemy]</strong> peut se connecter à la base de données. A noter que le connecteur Python utilisé doit être déjà installé. <strong>[sqlalchemy]</strong> ne le fait pas.</p>
</li>
<li>
<p>lignes 19-26 : description de la table <strong>[personnes]</strong> ;</p>
</li>
<li>lignes 28-34 : mapping entre la classe <strong>[Personne]</strong> et la table <strong>[personnes]</strong> ;</li>
<li>lignes 36-38 : la plupart des opérations <strong>[sqlalchemy]</strong> se font dans une session. La notion de session <strong>[sqlalchemy]</strong> est proche de celle de transaction SQL. Les sessions sont crées à partir de la classe <strong>[Session]</strong> rendue par la fonction <strong>[sessionmaker]</strong> de la ligne 37 ;</li>
<li>ligne 38 : la classe <strong>[Session]</strong> est associée à la base <strong>[dbpersonnes]</strong> via la chaîne de connexion de la ligne 14 ;</li>
<li>ligne 43 : on crée une session. Comme il a été dit, on peut rapprocher une session d’une transaction ;</li>
<li>lignes 45-46 : la méthode <strong>[Session.execute]</strong> permet d’exécuter un ordre SQL. Ce n’est pas quelque chose de courant puisqu’on a dit que l’ORM permettait d’éviter le langage SQL ;</li>
<li>lignes 48-49 : la méthode <strong>[</strong><strong>metadata.create_all</strong><strong>]</strong> permet de créer toutes les tables utilisant l’instance <strong>[MetaData]</strong> de la ligne 17. Nous n’en avons qu’une : la table <strong>[personnes]</strong> définie lignes 20-26. <strong>[sqlalchemy]</strong> va utiliser l’information de ces lignes pour créer la table. On a là un premier intérêt de l’ORM : il cache les spécificités des SGBD. En effet, l’ordre SQL <strong>[create]</strong> peut être très différent d’un SGBD à l’autre à cause des types donnés aux colonnes. Il n’y a pas eu d’uniformisation SQL des types de données. Ainsi l’ordre <strong>[create]</strong> varie d’un SGBD à l’autre. Ici, grâce à <strong>[sqlalchemy]</strong> :</li>
<li>nous décrivons de façon unique la table que nous désirons ;</li>
<li><strong>[sqlalchemy]</strong> se débrouille pour générer le <strong>[create]</strong> qui va bien pour le SGBD qu’il a en face de lui ;</li>
<li>ligne 52 : on ajoute un objet <strong>[Personne]</strong> à la session. Cela ne l’ajoute pas automatiquement en base de données. En effet, un ORM suit ses propres règles pour se synchroniser avec la base de données. Il va toujours chercher à optimiser le nombre de requêtes qu’il fait. Prenons un exemple. Le script ajoute (add) deux personnes (personne1, personne2) dans la session puis fait ensuite une requête : il veut voir toutes les personnes présentes dans la table. <strong>[sqlalchemy]</strong> peut procéder ainsi :</li>
<li>l’ajout de <strong>[personne1]</strong> peut se faire en mémoire. Il n’y a pas besoin pour l’instant de le mettre en base de données ;</li>
<li>idem pour <strong>[personne2]</strong> ;</li>
<li>
<p>vient ensuite la requête de type <strong>[select]</strong>. Il faut alors récupérer toutes les lignes de la table <strong>[personnes]</strong>. <strong>[sqlalchemy]</strong> va alors mettre <strong>[personne1, personne2]</strong> en base puis faire la requête ;
<strong>[sqlalchemy]</strong> va ainsi faire des optimisations transparentes pour le développeur.</p>
</li>
<li>
<p>ligne 56 : pour faire une requête de type <strong>[select]</strong> (je veux voir …), on utilise la méthode <strong>[Session.query]</strong>. Le paramètre de la méthode <strong>[query]</strong> est la classe mappée avec la table interrogée. Cette méthode rend un type <strong>[Query]</strong>. La méthode <strong>[Query.all]</strong> demande tous les objets <strong>[Personne]</strong> de la session. On lui ramène toutes les lignes de la table <strong>[personnes]</strong>, chacune sous la forme d’un objet <strong>[Personne]</strong>. Pour faire cela, <strong>[sqlalchemy]</strong> utilise le mapping qui a été fait entre la classe <strong>[Personne]</strong> et la table <strong>[personnes]</strong>. Le résultat de la ligne 56 est une liste d’objets <strong>[Personne]</strong> ;</p>
</li>
<li>lignes 58-61 : on affiche les éléments de la liste <strong>[personnes]</strong>. Parce que la classe <strong>[Personne]</strong> dérive de la classe <strong>[BaseEntity]</strong>, la méthode <strong>[Personne.<strong>str</strong>]</strong> utilisée ici implicitement dans la ligne 61, est en fait la méthode <strong>[BaseEntity.<strong>str</strong>]</strong> qui rend la chaîne jSON de l’objet appelant. Cette chaîne est la chaîne jSON du dictionnaire <strong>[Personne.asdict]</strong> (cf. |<a href="#_La_méthode_[BaseEntity.asdict]"><u><u>BaseEntity</u></u></a>|). Nous avons dit qu’après le mapping, on allait trouver la propriété <strong>[</strong><strong>_sa_instance_state</strong><strong>]</strong> dans chaque objet <strong>[Personne]</strong>. Or la valeur de cette propriété n’est pas un type <strong>[BaseEntity]</strong>. Il faut donc l’exclure du dictionnaire de la classe <strong>[Personne]</strong> sinon l’affichage ‘plante’. C’est ce qui a été fait dans le script <strong>[config]</strong> ;</li>
<li>lignes 63-65 : on ajoute deux autres personnes qui ont les mêmes nom et prénom. Or on a une contrainte d’unicité sur l’union de ces deux colonnes. Une erreur devrait donc se produire. C’est ce qu’on cherche à voir ;</li>
<li>lignes 67-68 : on demande de nouveau la liste de toutes les personnes de la base ;</li>
<li>lignes 70-73 : et on les affiche ;</li>
<li>lignes 75-76 : la session est validée ‘commitée’. Comme son nom l’indique, la transaction sous-jacente va être validée ;</li>
<li>on va voir à l’exécution que les lignes 67-76 ne vont pas être exécutées à cause de l’exception produite par la ligne 65. On va alors aller aux lignes 78-84 pour gérer l’exception ;</li>
<li>ligne 78 : l’exception <strong>[InterfaceError]</strong> se produit si <strong>[sqlalchemy]</strong> n’arrive pas à se connecter à la base de données <strong>[dbpersonnes]</strong>. L’exception <strong>[IntegrityError]</strong> se produit ligne 65 ;</li>
<li>ligne 80 : on affiche l’erreur ;</li>
<li>lignes 82-84 : si la session existe, on l’annule. Cela revient à annuler la transaction sous-jacente ;</li>
<li>lignes 85-88 : dans tous les cas, erreur ou pas, la session est fermée pour libérer des ressources ;
Les résultats de l’exécution sont les suivants :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">Scripts</span>\<span class="n">python</span><span class="o">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">st</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">cours</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">databases</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="mi">01</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">py</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="n">Liste</span> <span class="n">des</span> <span class="n">personnes</span> <span class="o">---------</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="p">{</span><span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">67</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="n">L</span><span class="s1">&#39;erreur suivante s&#39;</span><span class="n">est</span> <span class="n">produite</span> <span class="p">:</span> <span class="p">(</span><span class="n">raised</span> <span class="k">as</span> <span class="n">a</span> <span class="n">result</span> <span class="n">of</span> <span class="n">Query</span><span class="o">-</span><span class="n">invoked</span> <span class="n">autoflush</span><span class="p">;</span> <span class="n">consider</span> <span class="n">using</span> <span class="n">a</span> <span class="n">session</span><span class="o">.</span><span class="n">no_autoflush</span> <span class="n">block</span> <span class="k">if</span> <span class="n">this</span> <span class="n">flush</span> <span class="ow">is</span> <span class="n">occurring</span> <span class="n">prematurely</span><span class="p">)</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="p">(</span><span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">)</span> <span class="mi">1062</span> <span class="p">(</span><span class="mi">23000</span><span class="p">):</span> <span class="n">Duplicate</span> <span class="n">entry</span> <span class="s1">&#39;y1-x1&#39;</span> <span class="k">for</span> <span class="n">key</span> <span class="s1">&#39;uix_1&#39;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="p">[</span><span class="n">SQL</span><span class="p">:</span> <span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">personnes</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">prenom</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">age</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="o">%</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="n">s</span><span class="p">,</span> <span class="o">%</span><span class="p">(</span><span class="n">prenom</span><span class="p">)</span><span class="n">s</span><span class="p">,</span> <span class="o">%</span><span class="p">(</span><span class="n">nom</span><span class="p">)</span><span class="n">s</span><span class="p">,</span> <span class="o">%</span><span class="p">(</span><span class="n">age</span><span class="p">)</span><span class="n">s</span><span class="p">)]</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="p">[</span><span class="n">parameters</span><span class="p">:</span> <span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span> <span class="s1">&#39;prenom&#39;</span><span class="p">:</span> <span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="s1">&#39;nom&#39;</span><span class="p">:</span> <span class="s1">&#39;y1&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">69</span><span class="p">,</span> <span class="s1">&#39;prenom&#39;</span><span class="p">:</span> <span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="s1">&#39;nom&#39;</span><span class="p">:</span> <span class="s1">&#39;y1&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">})]</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="p">(</span><span class="n">Background</span> <span class="n">on</span> <span class="n">this</span> <span class="n">error</span> <span class="n">at</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">sqlalche</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">e</span><span class="o">/</span><span class="mi">13</span><span class="o">/</span><span class="n">gkpj</span><span class="p">)</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="n">rollback</span><span class="o">...</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="n">Process</span> <span class="n">finished</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 2-3 : la liste des personnes après la 1ère insertion ;</li>
<li>ligne 5 : l’exception <strong>[IntegrityError]</strong> qui s’est produite lorsqu’on a ajouté deux personnes ayant les mêmes nom et prénom ;</li>
<li>lignes 6-7 : on notera l’ordre SQL qui a échoué. C’est un ordre INSERT paramétré : <strong>[sqlalchemy]</strong> a inséré les deux personnes avec un unique INSERT. On voit là qu’il a essayé d’optimiser les ordres SQL émis ;
Maintenant allons-voir, avec phpMyAdmin, le contenu de la table <strong>[personnes]</strong> :</li>
</ul>
<p><img src="images/1000000000000475000001DB4297A5F6.png" style="width:13.151cm;height:5.49cm;" alt="Image" /></p>
<p>On voit en <strong>[6]</strong> que la table est vide. Il n’y a même pas la 1ère personne que le script avait mis dans la session. Ceci parce que celle-ci se déroulait dans une transaction et que celle-ci a été défaite dans la clause <strong>[except]</strong> du script <strong>[main]</strong>.</p>
<p>Procédons maintenant à la modification suivante dans <strong>[main]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a>    <span class="c1"># une insertion</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Personne</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">67</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}))</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>    <span class="c1"># session.commit()</span>
</code></pre></div></td></tr></table></div>
<p>Après avoir ajouté une personne ligne 2, nous décommentons la ligne 3. L’opération <strong>[session.commit]</strong> va valider la transaction sous-jacente et une nouvelle transaction va démarrer. Après exécution, le contenu de la table <strong>[personnes]</strong> est le suivant :</p>
<p><img src="images/10000000000005EB00000225B4EB43EE.png" style="width:17.521cm;height:6.351cm;" alt="Image" /></p>
<p>On voit en <strong>[6]</strong> que la 1ère insertion a été conservée. Cela vient du fait qu’elle a été faite au sein d’une transaction 1 et que l’erreur qui a suivi a été faite au sein d’une transaction 2.</p>
<h2 id="193-scripts-02-les-mappings-de-sqlalchemy">19.3. Scripts 02 : les mappings de [sqlalchemy]</h2>
<p><img src="images/1000000000000137000001D285EAF188.png" style="width:3.59cm;height:5.381cm;" alt="Image" /></p>
<p>Les scripts 02 sont une variante des scripts 01. On essaie de faire le maximum de configurations dans <strong>[config.py]</strong>. On y configure maintenant l’environnement <strong>[sqlalchemy]</strong> de l’application :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span>
<span class="normal"><a href="#__codelineno-10-24">24</a></span>
<span class="normal"><a href="#__codelineno-10-25">25</a></span>
<span class="normal"><a href="#__codelineno-10-26">26</a></span>
<span class="normal"><a href="#__codelineno-10-27">27</a></span>
<span class="normal"><a href="#__codelineno-10-28">28</a></span>
<span class="normal"><a href="#__codelineno-10-29">29</a></span>
<span class="normal"><a href="#__codelineno-10-30">30</a></span>
<span class="normal"><a href="#__codelineno-10-31">31</a></span>
<span class="normal"><a href="#__codelineno-10-32">32</a></span>
<span class="normal"><a href="#__codelineno-10-33">33</a></span>
<span class="normal"><a href="#__codelineno-10-34">34</a></span>
<span class="normal"><a href="#__codelineno-10-35">35</a></span>
<span class="normal"><a href="#__codelineno-10-36">36</a></span>
<span class="normal"><a href="#__codelineno-10-37">37</a></span>
<span class="normal"><a href="#__codelineno-10-38">38</a></span>
<span class="normal"><a href="#__codelineno-10-39">39</a></span>
<span class="normal"><a href="#__codelineno-10-40">40</a></span>
<span class="normal"><a href="#__codelineno-10-41">41</a></span>
<span class="normal"><a href="#__codelineno-10-42">42</a></span>
<span class="normal"><a href="#__codelineno-10-43">43</a></span>
<span class="normal"><a href="#__codelineno-10-44">44</a></span>
<span class="normal"><a href="#__codelineno-10-45">45</a></span>
<span class="normal"><a href="#__codelineno-10-46">46</a></span>
<span class="normal"><a href="#__codelineno-10-47">47</a></span>
<span class="normal"><a href="#__codelineno-10-48">48</a></span>
<span class="normal"><a href="#__codelineno-10-49">49</a></span>
<span class="normal"><a href="#__codelineno-10-50">50</a></span>
<span class="normal"><a href="#__codelineno-10-51">51</a></span>
<span class="normal"><a href="#__codelineno-10-52">52</a></span>
<span class="normal"><a href="#__codelineno-10-53">53</a></span>
<span class="normal"><a href="#__codelineno-10-54">54</a></span>
<span class="normal"><a href="#__codelineno-10-55">55</a></span>
<span class="normal"><a href="#__codelineno-10-56">56</a></span>
<span class="normal"><a href="#__codelineno-10-57">57</a></span>
<span class="normal"><a href="#__codelineno-10-58">58</a></span>
<span class="normal"><a href="#__codelineno-10-59">59</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">():</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>    <span class="c1"># chemin absolu référence des chemins relatifs de la configuration</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>    <span class="n">root_dir</span> <span class="o">=</span> <span class="s2">&quot;C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020&quot;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>    <span class="c1"># chemins absolus des dépendances</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>    <span class="n">absolute_dependencies</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>        <span class="c1"># BaseEntity, MyException, Personne, Utils</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/classes/02/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a>    <span class="p">]</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a>    <span class="c1"># on fixe le syspath</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_syspath</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a>    <span class="n">set_syspath</span><span class="p">(</span><span class="n">absolute_dependencies</span><span class="p">)</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a>    <span class="c1"># imports</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">UniqueConstraint</span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">sessionmaker</span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a>    <span class="c1"># lien vers une base de données MySQL</span>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a>    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;mysql+mysqlconnector://admpersonnes:nobody@localhost/dbpersonnes&quot;</span><span class="p">)</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a>    <span class="c1"># metadata</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a>    <span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a>    <span class="c1"># la table</span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a>    <span class="n">personnes_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;personnes&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a>                            <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a>                            <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;prenom&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a>                            <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;nom&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-10-29" name="__codelineno-10-29"></a>                            <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-10-30" name="__codelineno-10-30"></a>                            <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;nom&#39;</span><span class="p">,</span> <span class="s1">&#39;prenom&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;uix_1&#39;</span><span class="p">)</span>
<a id="__codelineno-10-31" name="__codelineno-10-31"></a>                            <span class="p">)</span>
<a id="__codelineno-10-32" name="__codelineno-10-32"></a>
<a id="__codelineno-10-33" name="__codelineno-10-33"></a>    <span class="c1"># le mapping</span>
<a id="__codelineno-10-34" name="__codelineno-10-34"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Personne</span><span class="w"> </span><span class="kn">import</span> <span class="n">Personne</span>
<a id="__codelineno-10-35" name="__codelineno-10-35"></a>
<a id="__codelineno-10-36" name="__codelineno-10-36"></a>    <span class="n">mapper</span><span class="p">(</span><span class="n">Personne</span><span class="p">,</span> <span class="n">personnes_table</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-10-37" name="__codelineno-10-37"></a>        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">personnes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-10-38" name="__codelineno-10-38"></a>        <span class="s1">&#39;prénom&#39;</span><span class="p">:</span> <span class="n">personnes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">prenom</span><span class="p">,</span>
<a id="__codelineno-10-39" name="__codelineno-10-39"></a>        <span class="s1">&#39;nom&#39;</span><span class="p">:</span> <span class="n">personnes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">nom</span><span class="p">,</span>
<a id="__codelineno-10-40" name="__codelineno-10-40"></a>        <span class="s1">&#39;âge&#39;</span><span class="p">:</span> <span class="n">personnes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">age</span>
<a id="__codelineno-10-41" name="__codelineno-10-41"></a>    <span class="p">})</span>
<a id="__codelineno-10-42" name="__codelineno-10-42"></a>
<a id="__codelineno-10-43" name="__codelineno-10-43"></a>    <span class="c1"># la session factory</span>
<a id="__codelineno-10-44" name="__codelineno-10-44"></a>    <span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()</span>
<a id="__codelineno-10-45" name="__codelineno-10-45"></a>    <span class="n">Session</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<a id="__codelineno-10-46" name="__codelineno-10-46"></a>
<a id="__codelineno-10-47" name="__codelineno-10-47"></a>    <span class="c1"># on met ces informations dans la config</span>
<a id="__codelineno-10-48" name="__codelineno-10-48"></a>    <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-10-49" name="__codelineno-10-49"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Session&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Session</span>
<a id="__codelineno-10-50" name="__codelineno-10-50"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
<a id="__codelineno-10-51" name="__codelineno-10-51"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;engine&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">engine</span>
<a id="__codelineno-10-52" name="__codelineno-10-52"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;personnes_table&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">personnes_table</span>
<a id="__codelineno-10-53" name="__codelineno-10-53"></a>
<a id="__codelineno-10-54" name="__codelineno-10-54"></a>    <span class="c1"># configuration des classes</span>
<a id="__codelineno-10-55" name="__codelineno-10-55"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Personne</span><span class="w"> </span><span class="kn">import</span> <span class="n">Personne</span>
<a id="__codelineno-10-56" name="__codelineno-10-56"></a>    <span class="n">Personne</span><span class="o">.</span><span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_sa_instance_state&#39;</span><span class="p">]</span>
<a id="__codelineno-10-57" name="__codelineno-10-57"></a>
<a id="__codelineno-10-58" name="__codelineno-10-58"></a>    <span class="c1"># on rend la config</span>
<a id="__codelineno-10-59" name="__codelineno-10-59"></a>    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
<p><strong>Commentaires</strong></p>
<ul>
<li>lignes 2-12 : configuration du Python Path ;</li>
<li>lignes 14-45 : on configure l’environnement <strong>[sqlalchemy]</strong> ;</li>
<li>lignes 47-52 : l’environnement <strong>[sqlalchemy]</strong> est mis dans le dictionnaire de la configuration ;</li>
<li>lignes 54-56 : on configure la classe <strong>[Personne]</strong> ;
Avec cette configuration le script <strong>[main]</strong> devient le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span>
<span class="normal"><a href="#__codelineno-11-31">31</a></span>
<span class="normal"><a href="#__codelineno-11-32">32</a></span>
<span class="normal"><a href="#__codelineno-11-33">33</a></span>
<span class="normal"><a href="#__codelineno-11-34">34</a></span>
<span class="normal"><a href="#__codelineno-11-35">35</a></span>
<span class="normal"><a href="#__codelineno-11-36">36</a></span>
<span class="normal"><a href="#__codelineno-11-37">37</a></span>
<span class="normal"><a href="#__codelineno-11-38">38</a></span>
<span class="normal"><a href="#__codelineno-11-39">39</a></span>
<span class="normal"><a href="#__codelineno-11-40">40</a></span>
<span class="normal"><a href="#__codelineno-11-41">41</a></span>
<span class="normal"><a href="#__codelineno-11-42">42</a></span>
<span class="normal"><a href="#__codelineno-11-43">43</a></span>
<span class="normal"><a href="#__codelineno-11-44">44</a></span>
<span class="normal"><a href="#__codelineno-11-45">45</a></span>
<span class="normal"><a href="#__codelineno-11-46">46</a></span>
<span class="normal"><a href="#__codelineno-11-47">47</a></span>
<span class="normal"><a href="#__codelineno-11-48">48</a></span>
<span class="normal"><a href="#__codelineno-11-49">49</a></span>
<span class="normal"><a href="#__codelineno-11-50">50</a></span>
<span class="normal"><a href="#__codelineno-11-51">51</a></span>
<span class="normal"><a href="#__codelineno-11-52">52</a></span>
<span class="normal"><a href="#__codelineno-11-53">53</a></span>
<span class="normal"><a href="#__codelineno-11-54">54</a></span>
<span class="normal"><a href="#__codelineno-11-55">55</a></span>
<span class="normal"><a href="#__codelineno-11-56">56</a></span>
<span class="normal"><a href="#__codelineno-11-57">57</a></span>
<span class="normal"><a href="#__codelineno-11-58">58</a></span>
<span class="normal"><a href="#__codelineno-11-59">59</a></span>
<span class="normal"><a href="#__codelineno-11-60">60</a></span>
<span class="normal"><a href="#__codelineno-11-61">61</a></span>
<span class="normal"><a href="#__codelineno-11-62">62</a></span>
<span class="normal"><a href="#__codelineno-11-63">63</a></span>
<span class="normal"><a href="#__codelineno-11-64">64</a></span>
<span class="normal"><a href="#__codelineno-11-65">65</a></span>
<span class="normal"><a href="#__codelineno-11-66">66</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="c1"># le syspath est configuré - on fait les imports</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.exc</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntegrityError</span><span class="p">,</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">InterfaceError</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm.exc</span><span class="w"> </span><span class="kn">import</span> <span class="n">FlushError</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Personne</span><span class="w"> </span><span class="kn">import</span> <span class="n">Personne</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a>    <span class="c1"># une session</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Session&quot;</span><span class="p">]()</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a>    <span class="c1"># suppression de la table [personnes]</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a>    <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;drop table if exists personnes&quot;</span><span class="p">)</span>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a>    <span class="c1"># recréation de la table à partir du mapping</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;engine&quot;</span><span class="p">])</span>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a>    <span class="c1"># deux insertions</span>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Personne</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}))</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a>    <span class="n">personne</span> <span class="o">=</span> <span class="n">Personne</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">})</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">personne</span><span class="p">)</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a>    <span class="c1"># validation des deux insertions</span>
<a id="__codelineno-11-29" name="__codelineno-11-29"></a>    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-11-30" name="__codelineno-11-30"></a>
<a id="__codelineno-11-31" name="__codelineno-11-31"></a>    <span class="c1"># une requête</span>
<a id="__codelineno-11-32" name="__codelineno-11-32"></a>    <span class="n">personnes</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Personne</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-11-33" name="__codelineno-11-33"></a>
<a id="__codelineno-11-34" name="__codelineno-11-34"></a>    <span class="c1"># affichage</span>
<a id="__codelineno-11-35" name="__codelineno-11-35"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Liste des personnes-----------&quot;</span><span class="p">)</span>
<a id="__codelineno-11-36" name="__codelineno-11-36"></a>    <span class="k">for</span> <span class="n">personne</span> <span class="ow">in</span> <span class="n">personnes</span><span class="p">:</span>
<a id="__codelineno-11-37" name="__codelineno-11-37"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">personne</span><span class="p">)</span>
<a id="__codelineno-11-38" name="__codelineno-11-38"></a>
<a id="__codelineno-11-39" name="__codelineno-11-39"></a>    <span class="c1"># deux autres insertions dont la seconde échoue</span>
<a id="__codelineno-11-40" name="__codelineno-11-40"></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Personne</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}))</span>
<a id="__codelineno-11-41" name="__codelineno-11-41"></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Personne</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}))</span>
<a id="__codelineno-11-42" name="__codelineno-11-42"></a>
<a id="__codelineno-11-43" name="__codelineno-11-43"></a>    <span class="c1"># une requête</span>
<a id="__codelineno-11-44" name="__codelineno-11-44"></a>    <span class="n">personnes</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Personne</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-11-45" name="__codelineno-11-45"></a>
<a id="__codelineno-11-46" name="__codelineno-11-46"></a>    <span class="c1"># affichage</span>
<a id="__codelineno-11-47" name="__codelineno-11-47"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Liste des personnes-----------&quot;</span><span class="p">)</span>
<a id="__codelineno-11-48" name="__codelineno-11-48"></a>    <span class="k">for</span> <span class="n">personne</span> <span class="ow">in</span> <span class="n">personnes</span><span class="p">:</span>
<a id="__codelineno-11-49" name="__codelineno-11-49"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">personne</span><span class="p">)</span>
<a id="__codelineno-11-50" name="__codelineno-11-50"></a>
<a id="__codelineno-11-51" name="__codelineno-11-51"></a>    <span class="c1"># validation de la session</span>
<a id="__codelineno-11-52" name="__codelineno-11-52"></a>    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-11-53" name="__codelineno-11-53"></a>
<a id="__codelineno-11-54" name="__codelineno-11-54"></a><span class="k">except</span> <span class="p">(</span><span class="n">FlushError</span><span class="p">,</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">InterfaceError</span><span class="p">,</span> <span class="n">IntegrityError</span><span class="p">)</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-11-55" name="__codelineno-11-55"></a>    <span class="c1"># affichage</span>
<a id="__codelineno-11-56" name="__codelineno-11-56"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-11-57" name="__codelineno-11-57"></a>    <span class="c1"># annulation de la dernière session</span>
<a id="__codelineno-11-58" name="__codelineno-11-58"></a>    <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-11-59" name="__codelineno-11-59"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rollback...&quot;</span><span class="p">)</span>
<a id="__codelineno-11-60" name="__codelineno-11-60"></a>        <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-11-61" name="__codelineno-11-61"></a><span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-11-62" name="__codelineno-11-62"></a>    <span class="c1"># affichage</span>
<a id="__codelineno-11-63" name="__codelineno-11-63"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Travail terminé...&quot;</span><span class="p">)</span>
<a id="__codelineno-11-64" name="__codelineno-11-64"></a>    <span class="c1"># on libère les ressources de la session</span>
<a id="__codelineno-11-65" name="__codelineno-11-65"></a>    <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-11-66" name="__codelineno-11-66"></a>        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>Les résultats de l’exécution sont les suivants :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">Scripts</span>\<span class="n">python</span><span class="o">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">st</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">cours</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">databases</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">py</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="n">Liste</span> <span class="n">des</span> <span class="n">personnes</span><span class="o">-----------</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="p">{</span><span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="p">{</span><span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="n">L</span><span class="s1">&#39;erreur suivante s&#39;</span><span class="n">est</span> <span class="n">produite</span> <span class="p">:</span> <span class="p">(</span><span class="n">raised</span> <span class="k">as</span> <span class="n">a</span> <span class="n">result</span> <span class="n">of</span> <span class="n">Query</span><span class="o">-</span><span class="n">invoked</span> <span class="n">autoflush</span><span class="p">;</span> <span class="n">consider</span> <span class="n">using</span> <span class="n">a</span> <span class="n">session</span><span class="o">.</span><span class="n">no_autoflush</span> <span class="n">block</span> <span class="k">if</span> <span class="n">this</span> <span class="n">flush</span> <span class="ow">is</span> <span class="n">occurring</span> <span class="n">prematurely</span><span class="p">)</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="p">(</span><span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">)</span> <span class="mi">1062</span> <span class="p">(</span><span class="mi">23000</span><span class="p">):</span> <span class="n">Duplicate</span> <span class="n">entry</span> <span class="s1">&#39;y2-x2&#39;</span> <span class="k">for</span> <span class="n">key</span> <span class="s1">&#39;uix_1&#39;</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="p">[</span><span class="n">SQL</span><span class="p">:</span> <span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">personnes</span> <span class="p">(</span><span class="n">prenom</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">age</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="o">%</span><span class="p">(</span><span class="n">prenom</span><span class="p">)</span><span class="n">s</span><span class="p">,</span> <span class="o">%</span><span class="p">(</span><span class="n">nom</span><span class="p">)</span><span class="n">s</span><span class="p">,</span> <span class="o">%</span><span class="p">(</span><span class="n">age</span><span class="p">)</span><span class="n">s</span><span class="p">)]</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="p">[</span><span class="n">parameters</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;prenom&#39;</span><span class="p">:</span> <span class="s1">&#39;x2&#39;</span><span class="p">,</span> <span class="s1">&#39;nom&#39;</span><span class="p">:</span> <span class="s1">&#39;y2&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}]</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="p">(</span><span class="n">Background</span> <span class="n">on</span> <span class="n">this</span> <span class="n">error</span> <span class="n">at</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">sqlalche</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">e</span><span class="o">/</span><span class="mi">13</span><span class="o">/</span><span class="n">gkpj</span><span class="p">)</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="n">rollback</span><span class="o">...</span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="n">Travail</span> <span class="n">terminé</span><span class="o">...</span>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a>
<a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="n">Process</span> <span class="n">finished</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
<p>Dans phpMyAdmin, la table <strong>[personnes]</strong> est devenue la suivante :</p>
<p><img src="images/100000000000038D0000026712C762DF.png" style="width:10.51cm;height:7.111cm;" alt="Image" /></p>
<p>Maintenant, regardons la table <strong>[personnes]</strong> générée par <strong>[sqlalchemy]</strong> :</p>
<p><img src="images/1000000000000557000002B211F50426.png" style="width:15.77cm;height:7.961cm;" alt="Image" /></p>
<ul>
<li>en <strong>[6]</strong>, les types utilisés pour les différentes colonnes ;</li>
<li>en <strong>[7]</strong>, on voit que la colonne <strong>[id]</strong> a l’attribut <strong>[AUTO_INCREMENT]</strong>. Cela signifie que lors de l’insertion d’une ligne dans la table, si cette ligne n’a pas de valeur pour la colonne <strong>[id]</strong>, celle-ci sera générée par MySQL de façon incrémentale : 1, 2, 3, … Cette propriété nous évite de nous préoccuper de la valeur de la clé primaire lorsque nous faisons une insertion dans la table : nous laissons MySQL la générer ;</li>
<li>en <strong>[8]</strong>, on voit que la colonne <strong>[id]</strong> est clé primaire ;</li>
<li>en <strong>[9]</strong>, on retrouve la contrainte d’unicité sur les champs <strong>[nom, prenom]</strong> ;</li>
</ul>
<h2 id="194-scripts-03-manipulation-des-entites-de-la-session-sqlalchemy">19.4. Scripts 03 : manipulation des entités de la session [sqlalchemy]</h2>
<p><img src="images/1000000000000136000001BB2902EAD6.png" style="width:3.581cm;height:5.121cm;" alt="Image" /></p>
<p>Le fichier de configuration <strong>[config]</strong> est le même que dans l’exemple précédent. Dans le script <strong>[main]</strong> on fait les opérations classiques <strong>[INSERT, UPDATE, DELETE, SELECT]</strong> sur la table <strong>[personnes]</strong> à l’aide des méthodes de <strong>[sqlalchemy]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">  1</a></span>
<span class="normal"><a href="#__codelineno-13-2">  2</a></span>
<span class="normal"><a href="#__codelineno-13-3">  3</a></span>
<span class="normal"><a href="#__codelineno-13-4">  4</a></span>
<span class="normal"><a href="#__codelineno-13-5">  5</a></span>
<span class="normal"><a href="#__codelineno-13-6">  6</a></span>
<span class="normal"><a href="#__codelineno-13-7">  7</a></span>
<span class="normal"><a href="#__codelineno-13-8">  8</a></span>
<span class="normal"><a href="#__codelineno-13-9">  9</a></span>
<span class="normal"><a href="#__codelineno-13-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-13-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-13-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-13-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-13-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-13-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-13-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-13-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-13-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-13-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-13-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-13-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-13-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-13-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-13-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-13-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-13-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-13-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-13-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-13-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-13-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-13-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-13-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-13-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-13-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-13-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-13-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-13-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-13-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-13-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-13-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-13-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-13-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-13-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-13-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-13-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-13-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-13-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-13-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-13-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-13-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-13-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-13-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-13-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-13-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-13-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-13-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-13-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-13-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-13-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-13-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-13-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-13-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-13-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-13-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-13-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-13-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-13-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-13-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-13-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-13-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-13-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-13-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-13-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-13-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-13-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-13-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-13-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-13-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-13-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-13-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-13-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-13-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-13-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-13-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-13-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-13-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-13-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-13-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-13-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-13-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-13-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-13-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-13-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-13-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-13-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-13-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-13-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-13-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-13-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-13-100">100</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="c1"># imports</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">func</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.exc</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntegrityError</span><span class="p">,</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">InterfaceError</span>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm.session</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Personne</span><span class="w"> </span><span class="kn">import</span> <span class="n">Personne</span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="c1"># affiche le contenu de la table [personnes]</span>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">affiche_table</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------&quot;</span><span class="p">)</span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a>    <span class="c1"># une requête</span>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a>    <span class="n">personnes</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Personne</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-13-17" name="__codelineno-13-17"></a>    <span class="c1"># affichage</span>
<a id="__codelineno-13-18" name="__codelineno-13-18"></a>    <span class="n">affiche_personnes</span><span class="p">(</span><span class="n">personnes</span><span class="p">)</span>
<a id="__codelineno-13-19" name="__codelineno-13-19"></a>
<a id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="c1"># affiche une liste de personnes</span>
<a id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="k">def</span><span class="w"> </span><span class="nf">affiche_personnes</span><span class="p">(</span><span class="n">personnes</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-13-22" name="__codelineno-13-22"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------&quot;</span><span class="p">)</span>
<a id="__codelineno-13-23" name="__codelineno-13-23"></a>    <span class="c1"># affichage</span>
<a id="__codelineno-13-24" name="__codelineno-13-24"></a>    <span class="k">for</span> <span class="n">personne</span> <span class="ow">in</span> <span class="n">personnes</span><span class="p">:</span>
<a id="__codelineno-13-25" name="__codelineno-13-25"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">personne</span><span class="p">)</span>
<a id="__codelineno-13-26" name="__codelineno-13-26"></a>
<a id="__codelineno-13-27" name="__codelineno-13-27"></a>
<a id="__codelineno-13-28" name="__codelineno-13-28"></a><span class="c1"># main ---------------------------</span>
<a id="__codelineno-13-29" name="__codelineno-13-29"></a><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-13-30" name="__codelineno-13-30"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-13-31" name="__codelineno-13-31"></a>    <span class="c1"># une session</span>
<a id="__codelineno-13-32" name="__codelineno-13-32"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Session&quot;</span><span class="p">]()</span>
<a id="__codelineno-13-33" name="__codelineno-13-33"></a>
<a id="__codelineno-13-34" name="__codelineno-13-34"></a>    <span class="c1"># suppression de la table [personnes]</span>
<a id="__codelineno-13-35" name="__codelineno-13-35"></a>    <span class="c1"># checkfirst=True : vérifie d&#39;abord que la table existe</span>
<a id="__codelineno-13-36" name="__codelineno-13-36"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;personnes_table&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;engine&quot;</span><span class="p">],</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-13-37" name="__codelineno-13-37"></a>
<a id="__codelineno-13-38" name="__codelineno-13-38"></a>    <span class="c1"># recréation de la table à partir du mapping</span>
<a id="__codelineno-13-39" name="__codelineno-13-39"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;engine&quot;</span><span class="p">])</span>
<a id="__codelineno-13-40" name="__codelineno-13-40"></a>
<a id="__codelineno-13-41" name="__codelineno-13-41"></a>    <span class="c1"># des insertions</span>
<a id="__codelineno-13-42" name="__codelineno-13-42"></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Personne</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Pierre&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Nicazou&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">35</span><span class="p">}))</span>
<a id="__codelineno-13-43" name="__codelineno-13-43"></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Personne</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Géraldine&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Colou&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">}))</span>
<a id="__codelineno-13-44" name="__codelineno-13-44"></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Personne</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Paulette&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Girondé&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">56</span><span class="p">}))</span>
<a id="__codelineno-13-45" name="__codelineno-13-45"></a>
<a id="__codelineno-13-46" name="__codelineno-13-46"></a>    <span class="c1"># on affiche le contenu de la session</span>
<a id="__codelineno-13-47" name="__codelineno-13-47"></a>    <span class="n">affiche_table</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
<a id="__codelineno-13-48" name="__codelineno-13-48"></a>
<a id="__codelineno-13-49" name="__codelineno-13-49"></a>    <span class="c1"># liste des personnes par ordre alphabétique des noms et à nom égal par ordre alphabétique des prénoms</span>
<a id="__codelineno-13-50" name="__codelineno-13-50"></a>    <span class="n">personnes</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Personne</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Personne</span><span class="o">.</span><span class="n">nom</span><span class="o">.</span><span class="n">desc</span><span class="p">(),</span> <span class="n">Personne</span><span class="o">.</span><span class="n">prénom</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
<a id="__codelineno-13-51" name="__codelineno-13-51"></a>
<a id="__codelineno-13-52" name="__codelineno-13-52"></a>    <span class="c1"># affichage</span>
<a id="__codelineno-13-53" name="__codelineno-13-53"></a>    <span class="n">affiche_personnes</span><span class="p">(</span><span class="n">personnes</span><span class="p">)</span>
<a id="__codelineno-13-54" name="__codelineno-13-54"></a>
<a id="__codelineno-13-55" name="__codelineno-13-55"></a>    <span class="c1"># liste des personnes ayant un âge dans l&#39;intervalle [20,40] par ordre décroissant de l&#39;âge</span>
<a id="__codelineno-13-56" name="__codelineno-13-56"></a>    <span class="c1"># puis à âge égal par ordre alphabétique des noms et à nom égal par ordre alphabétique des prénoms</span>
<a id="__codelineno-13-57" name="__codelineno-13-57"></a>    <span class="n">personnes</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Personne</span><span class="p">)</span><span class="o">.</span> \
<a id="__codelineno-13-58" name="__codelineno-13-58"></a>        <span class="nb">filter</span><span class="p">(</span><span class="n">Personne</span><span class="o">.</span><span class="n">âge</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">Personne</span><span class="o">.</span><span class="n">âge</span> <span class="o">&lt;=</span> <span class="mi">40</span><span class="p">)</span><span class="o">.</span> \
<a id="__codelineno-13-59" name="__codelineno-13-59"></a>        <span class="n">order_by</span><span class="p">(</span><span class="n">Personne</span><span class="o">.</span><span class="n">âge</span><span class="o">.</span><span class="n">desc</span><span class="p">(),</span> <span class="n">Personne</span><span class="o">.</span><span class="n">nom</span><span class="o">.</span><span class="n">asc</span><span class="p">(),</span> <span class="n">Personne</span><span class="o">.</span><span class="n">prénom</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span>
<a id="__codelineno-13-60" name="__codelineno-13-60"></a>
<a id="__codelineno-13-61" name="__codelineno-13-61"></a>    <span class="c1"># affichage</span>
<a id="__codelineno-13-62" name="__codelineno-13-62"></a>    <span class="n">affiche_personnes</span><span class="p">(</span><span class="n">personnes</span><span class="p">)</span>
<a id="__codelineno-13-63" name="__codelineno-13-63"></a>
<a id="__codelineno-13-64" name="__codelineno-13-64"></a>    <span class="c1"># insertion de mme Bruneau</span>
<a id="__codelineno-13-65" name="__codelineno-13-65"></a>    <span class="n">bruneau</span> <span class="o">=</span> <span class="n">Personne</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Josette&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Bruneau&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">46</span><span class="p">})</span>
<a id="__codelineno-13-66" name="__codelineno-13-66"></a>    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bruneau</span><span class="p">)</span>
<a id="__codelineno-13-67" name="__codelineno-13-67"></a>    <span class="c1"># modification de son âge</span>
<a id="__codelineno-13-68" name="__codelineno-13-68"></a>    <span class="n">bruneau</span><span class="o">.</span><span class="n">âge</span> <span class="o">=</span> <span class="mi">47</span>
<a id="__codelineno-13-69" name="__codelineno-13-69"></a>
<a id="__codelineno-13-70" name="__codelineno-13-70"></a>    <span class="c1"># liste des personnes ayant Bruneau pour nom</span>
<a id="__codelineno-13-71" name="__codelineno-13-71"></a>    <span class="n">personne</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Personne</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">Personne</span><span class="o">.</span><span class="n">nom</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;bruneau&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a id="__codelineno-13-72" name="__codelineno-13-72"></a>
<a id="__codelineno-13-73" name="__codelineno-13-73"></a>    <span class="c1"># affichage</span>
<a id="__codelineno-13-74" name="__codelineno-13-74"></a>    <span class="n">affiche_personnes</span><span class="p">([</span><span class="n">personne</span><span class="p">])</span>
<a id="__codelineno-13-75" name="__codelineno-13-75"></a>
<a id="__codelineno-13-76" name="__codelineno-13-76"></a>    <span class="c1"># suppression de Mme Bruneau</span>
<a id="__codelineno-13-77" name="__codelineno-13-77"></a>    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">personne</span><span class="p">)</span>
<a id="__codelineno-13-78" name="__codelineno-13-78"></a>
<a id="__codelineno-13-79" name="__codelineno-13-79"></a>    <span class="c1"># liste des personnes ayant Bruneau pour nom</span>
<a id="__codelineno-13-80" name="__codelineno-13-80"></a>    <span class="n">personnes</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Personne</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">Personne</span><span class="o">.</span><span class="n">nom</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;bruneau&quot;</span><span class="p">)</span>
<a id="__codelineno-13-81" name="__codelineno-13-81"></a>
<a id="__codelineno-13-82" name="__codelineno-13-82"></a>    <span class="c1"># affichage</span>
<a id="__codelineno-13-83" name="__codelineno-13-83"></a>    <span class="n">affiche_personnes</span><span class="p">(</span><span class="n">personnes</span><span class="p">)</span>
<a id="__codelineno-13-84" name="__codelineno-13-84"></a>
<a id="__codelineno-13-85" name="__codelineno-13-85"></a>    <span class="c1"># validation de la session</span>
<a id="__codelineno-13-86" name="__codelineno-13-86"></a>    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-13-87" name="__codelineno-13-87"></a>
<a id="__codelineno-13-88" name="__codelineno-13-88"></a><span class="k">except</span> <span class="p">(</span><span class="n">DatabaseError</span><span class="p">,</span> <span class="n">InterfaceError</span><span class="p">,</span> <span class="n">IntegrityError</span><span class="p">)</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-13-89" name="__codelineno-13-89"></a>    <span class="c1"># affichage</span>
<a id="__codelineno-13-90" name="__codelineno-13-90"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-13-91" name="__codelineno-13-91"></a>    <span class="c1"># annulation de la dernière session</span>
<a id="__codelineno-13-92" name="__codelineno-13-92"></a>    <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-13-93" name="__codelineno-13-93"></a>        <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-13-94" name="__codelineno-13-94"></a>
<a id="__codelineno-13-95" name="__codelineno-13-95"></a><span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-13-96" name="__codelineno-13-96"></a>    <span class="c1"># affichage</span>
<a id="__codelineno-13-97" name="__codelineno-13-97"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Travail terminé...&quot;</span><span class="p">)</span>
<a id="__codelineno-13-98" name="__codelineno-13-98"></a>    <span class="c1"># on libère les ressources de la session</span>
<a id="__codelineno-13-99" name="__codelineno-13-99"></a>    <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-13-100" name="__codelineno-13-100"></a>        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p><strong>Commentaires</strong></p>
<ul>
<li>lignes 20-25 : la fonction <strong>[affiche_personnes]</strong> affiche les éléments d’une liste de personnes ;</li>
<li>lignes 12-18 : la fonction <strong>[affiche_table]</strong> affiche le contenu de la table <strong>[personnes]</strong> ;</li>
<li>lignes 34-36 : on supprime la table <strong>[personnes]</strong>. Contrairement aux versions précédentes, on n’utilise pas un ordre SQL mais une méthode de <strong>[sqlalchemy]</strong> :</li>
<li>config<strong>[</strong><strong>&quot;personnes_table&quot;</strong><strong>]</strong> est l’objet <strong>[Table]</strong> décrivant la table <strong>[personnes]</strong> ;</li>
<li>config<strong>[</strong><strong>&quot;engine&quot;</strong><strong>]</strong> est la chaîne de connexion à la base de données <strong>[dbpersonnes]</strong> ;</li>
<li>le paramètre nommé <strong>[</strong><strong>checkfirst=</strong><strong>True</strong><strong>]</strong> demande à ce que l’opération ne se fasse que si la table <strong>[personnes]</strong> existe ;</li>
<li>lignes 38-39 : la table <strong>[personnes]</strong> est recréée ;</li>
<li>lignes 41-44 : trois personnes sont mises dans la session. On rappelle qu’elles ne sont pas forcément insérées immédiatement dans la table <strong>[personnes]</strong>. Cela dépend de la stratégie de <strong>[sqlalchemy]</strong> qui vise la performance ;</li>
<li>lignes 46-47 : le contenu de la table <strong>[personnes]</strong> es affiché. Si les insertions des trois personnes n’avaient pas encore été faites elles le sont maintenant à cause de cette demande ;</li>
<li>lignes 49-50 : un exemple d’utilisation de la méthode <strong>[order_by]</strong> qui permet de présenter les résultats d’une requête dans un certain ordre. La syntaxe <strong>[order_by(critère1, critère2)]</strong> affiche les résultats d’abord selon le critère <strong>[critère1]</strong> et lorsque des lignes présentent la même valeur de <strong>[critère1]</strong>, elles sont alors triées selon le critère <strong>[critère2]</strong>. On peut mettre plusieurs critères ainsi ;</li>
<li>lignes 55-59 : introduisent la notion de filtre avec la méthode <strong>[filter]</strong>. La notation <strong>[filter(critère1, critère2)]</strong> fait un ET logique (AND) entre les critère utilisés ;</li>
<li>lignes 64-67 : une nouvelle personne est mise en session ;</li>
<li>lignes 70-71 : un autre exemple de requête filtrée. La fonction <strong>[func.lower(param)]</strong> rend <strong>[param]</strong> en minuscules. Il existe ainsi d’autres fonctions disponibles notées <strong>[func.xx]</strong>. Dans l’expression de la ligne 71 :</li>
<li><strong>[session.query.filter]</strong> rend une liste d’objets <strong>[Personne]</strong> ;</li>
<li><strong>[session.query.filter.first]</strong> rend le 1er élément de cette liste ;</li>
<li>ligne 77 : on supprime un élément de la session ;</li>
<li>ligne 86 : la session est validée ;
Les résultats de l’exécution sont les suivants :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span>
<span class="normal"><a href="#__codelineno-14-18">18</a></span>
<span class="normal"><a href="#__codelineno-14-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">Scripts</span>\<span class="n">python</span><span class="o">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">st</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">cours</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">databases</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">py</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="o">----------------</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="o">----------------</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="p">{</span><span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">35</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Nicazou&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Pierre&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="p">{</span><span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Colou&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Géraldine&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="p">{</span><span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Girondé&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Paulette&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="o">----------------</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="p">{</span><span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">35</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Nicazou&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Pierre&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="p">{</span><span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Girondé&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Paulette&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="p">{</span><span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Colou&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Géraldine&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="o">----------------</span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="p">{</span><span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">35</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Nicazou&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Pierre&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<a id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="p">{</span><span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Colou&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Géraldine&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<a id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="o">----------------</span>
<a id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="p">{</span><span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Josette&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Bruneau&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">47</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
<a id="__codelineno-14-16" name="__codelineno-14-16"></a><span class="o">----------------</span>
<a id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="n">Travail</span> <span class="n">terminé</span><span class="o">...</span>
<a id="__codelineno-14-18" name="__codelineno-14-18"></a>
<a id="__codelineno-14-19" name="__codelineno-14-19"></a><span class="n">Process</span> <span class="n">finished</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 4-6 : le contenu de la session ;</li>
<li>lignes 8-10 : le contenu de la session dans l’ordre décroissant des noms ;</li>
<li>lignes 12-13 : le contenu de la session pour les personnes dont l’âge est dans l’intervalle <strong>[20, 40]</strong> ;</li>
<li>ligne 15 : la personne de nom « bruneau » ;
Dans phpMyAdmin, le contenu de la table <strong>[personnes]</strong> à la fin de l’exécution est le suivant :</li>
</ul>
<p><img src="images/100000000000038D0000027A6C971FC8.png" style="width:10.51cm;height:7.331cm;" alt="Image" /></p>
<h2 id="195-scripts-04-utilisation-dune-base-postgresql">19.5. Scripts 04 : utilisation d’une base [PostgreSQL]</h2>
<p><img src="images/1000000000000137000001BC55E511D0.png" style="width:3.59cm;height:5.121cm;" alt="Image" /></p>
<p>Le dossier <strong>[04]</strong> est une copie du dossier <strong>[03]</strong>. On change une unique chose, la chaîne de connexion dans le fichier <strong>[config]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a>    <span class="c1"># lien vers une base de données PostgreSQL</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a>    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://admpersonnes:nobody@localhost/dbpersonnes&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Désormais cette chaîne de connexion désigne la base <strong>[dbpersonnes]</strong> d’un SGBD <strong>[PostgreSQL]</strong>. On notera l’utilisation du connecteur <strong>[psycopg2]</strong>. Il faut que celui-ci soit installé.</p>
<p>L’exécution du script <strong>[main]</strong> donne les résultats suivants :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">Scripts</span>\<span class="n">python</span><span class="o">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">st</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">cours</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">databases</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="mi">04</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">py</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="o">----------------</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="o">----------------</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="p">{</span><span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Nicazou&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Pierre&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">35</span><span class="p">}</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="p">{</span><span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Colou&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Géraldine&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">}</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="p">{</span><span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Girondé&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Paulette&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">56</span><span class="p">}</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="o">----------------</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="p">{</span><span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Nicazou&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Pierre&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">35</span><span class="p">}</span>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="p">{</span><span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Girondé&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Paulette&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">56</span><span class="p">}</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="p">{</span><span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Colou&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Géraldine&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">}</span>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="o">----------------</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="p">{</span><span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Nicazou&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Pierre&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">35</span><span class="p">}</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="p">{</span><span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Colou&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Géraldine&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">}</span>
<a id="__codelineno-16-14" name="__codelineno-16-14"></a><span class="o">----------------</span>
<a id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="p">{</span><span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;Josette&quot;</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;Bruneau&quot;</span><span class="p">,</span> <span class="s2">&quot;âge&quot;</span><span class="p">:</span> <span class="mi">47</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
<a id="__codelineno-16-16" name="__codelineno-16-16"></a><span class="o">----------------</span>
<a id="__codelineno-16-17" name="__codelineno-16-17"></a><span class="n">Travail</span> <span class="n">terminé</span><span class="o">...</span>
<a id="__codelineno-16-18" name="__codelineno-16-18"></a>
<a id="__codelineno-16-19" name="__codelineno-16-19"></a><span class="n">Process</span> <span class="n">finished</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
<p>Avec l’outil <strong>[pgAdmin]</strong> (cf. paragraphe |<a href="#_Administrer_PostgreSQL_avec"><u><u>pgAdmin</u></u></a>|), la table <strong>[personnes]</strong> est dans l’état suivant :</p>
<p><img src="images/1000000000000556000001EDD383D916.png" style="width:15.761cm;height:5.68cm;" alt="Image" /></p>
<p>La table <strong>[personnes]</strong> a été générée avec le code SQL suivant :</p>
<p><img src="images/10000000000005E200000368429811FC.png" style="width:17.402cm;height:10.06cm;" alt="Image" /></p>
<ul>
<li>en <strong>[4-5]</strong>, on voit que la colonne <strong>[id]</strong> est clé primaire. On voit également qu’elle a une valeur par défaut <strong>[mot clé DEFAULT]</strong> qui fait que si on insère une ligne sans clé primaire, celle-ci sera générée par le SGBD. C’est un fonctionnement fréquent : on laisse le SGBD générer les clés primaires ;
Cette version 05 des scripts <strong>[sqlalchemy]</strong> montre bien la facilité de passer d’un SGBD à l’autre : il a suffi de changer la chaîne de connexion dans un script de configuration. Rien d’autre n’a changé. Si on compare les types des colonnes <strong>[id, nom, prenom, age]</strong> ci-dessus avec ceux de la table MySQL de l’exemple |<a href="#_Scripts_02_:"><u><u>02</u></u></a>|, on voit qu’ils sont différents. <strong>[sqlalchemy]</strong> les adapte au SGBD utilisé. Cette facilité de s’adapter à un nouveau SGBD est une raison suffisante pour adopter <strong>[sqlalchemy]</strong> ou un autre ORM.</li>
</ul>
<h2 id="196-scripts-05-exemple-complet">19.6. Scripts 05 : exemple complet</h2>
<p>L’exemple étudié est une reprise de celui étudié au paragraphe |<a href="#_Exemple_1"><u><u>troiscouches-v01</u></u></a>|. Cet exemple présentait une architecture à trois couches <strong>[ui, métier, dao]</strong> qui manipulait des entités <strong>[Classe, Elève, Matière, Note]</strong>. Les entités étaient codées en dur dans une couche <strong>[dao]</strong>. Nous les mettons maintenant dans une base de données. Nous utiliserons deux SGBD : MySQL et PostgreSQL.</p>
<h3 id="1961-larchitecture-de-lapplication">19.6.1. L’architecture de l’application</h3>
<p>L’architecture de l’application sera la suivante :</p>
<p><img src="images/1000000000000472000002BF207099F8.png" style="width:13.151cm;height:8.111cm;" alt="Image" /></p>
<ul>
<li>en <strong>[1-3]</strong>, on trouve les couches <strong>[ui, métier, dao]</strong> déjà présentes dans l’exemple |<a href="#_Exemple_1"><u><u>troiscouches-v01</u></u></a>|. La couche <strong>[dao]</strong> communique désormais avec la couche <strong>[ORM]</strong> ;</li>
<li>les couches <strong>[1-5]</strong> sont implémentées par du code Python ;</li>
</ul>
<h3 id="1962-les-bases-de-donnees">19.6.2. Les bases de données</h3>
<p>Nous construisons une base MySQL nommée <strong>[dbecole]</strong> propriété de l’utilisateur <strong>[admecole]</strong> ayant le mot de passe <strong>[mdpecole]</strong>. Pour cela nous suivons la procédure décrite au paragraphe |<a href="#_Création_d’une_base"><u><u>création d&#x27;une base de données</u></u></a>| :</p>
<p><img src="images/1000000000000473000001C3AB170B89.png" style="width:13.131cm;height:5.201cm;" alt="Image" /></p>
<p><img src="images/10000001000000E40000006371CCA81F.png" style="width:2.629cm;height:1.146cm;" alt="Image" /></p>
<p><img src="images/10000000000005EA000001D05278D0D1.png" style="width:17.511cm;height:5.361cm;" alt="Image" /></p>
<ul>
<li>en <strong>[1]</strong>, la base <strong>[dbecole]</strong> sans tables <strong>[3]</strong> ;</li>
<li>en <strong>[7]</strong>, l’utilisateur <strong>[admecole]</strong> a tous les privilèges sur cette base de données ;
On fait de même avec le SGBD PostgreSQL. Nous construisons une base nommée <strong>[dbecole]</strong> propriété de l’utilisateur <strong>[admecole]</strong> ayant le mot de passe <strong>[mdpecole]</strong>. Pour cela nous suivons la procédure décrite au paragraphe |<a href="#_Administrer_PostgreSQL_avec"><u><u>création d&#x27;une base de données</u></u></a>| :</li>
</ul>
<p><img src="images/10000000000004D8000003823AF5ED71.png" style="width:14.331cm;height:10.381cm;" alt="Image" /></p>
<ul>
<li>en <strong>[1]</strong>, la base <strong>[dbecole]</strong> ;</li>
<li>en <strong>[2]</strong>, l’utilisateur <strong>[admecole]</strong> ;</li>
<li>en <strong>[3-4]</strong>, la base <strong>[dbecole]</strong> est la propriété de l’utilisateur <strong>[admecole]</strong> ;</li>
</ul>
<h3 id="1963-les-entites-manipulees-par-lapplication">19.6.3. Les entités manipulées par l’application</h3>
<p>Dans l’application |<a href="#_Exemple_1"><u><u>troiscouches v01</u></u></a>|, les entités manipulées étaient les suivantes (cf. |<a href="#_Les_entités_de"><u><u>entités</u></u></a>|). Ce sont ces entités qui vont être stockées dans les bases de données précédentes. Nous ne dupliquerons pas ces entités dans la nouvelle application. Nous irons les chercher là où elles sont déjà définies.</p>
<p>La classe <strong>[Classe]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span>
<span class="normal"><a href="#__codelineno-17-20">20</a></span>
<span class="normal"><a href="#__codelineno-17-21">21</a></span>
<span class="normal"><a href="#__codelineno-17-22">22</a></span>
<span class="normal"><a href="#__codelineno-17-23">23</a></span>
<span class="normal"><a href="#__codelineno-17-24">24</a></span>
<span class="normal"><a href="#__codelineno-17-25">25</a></span>
<span class="normal"><a href="#__codelineno-17-26">26</a></span>
<span class="normal"><a href="#__codelineno-17-27">27</a></span>
<span class="normal"><a href="#__codelineno-17-28">28</a></span>
<span class="normal"><a href="#__codelineno-17-29">29</a></span>
<span class="normal"><a href="#__codelineno-17-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1"># imports</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">BaseEntity</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseEntity</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">MyException</span><span class="w"> </span><span class="kn">import</span> <span class="n">MyException</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Utils</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Classe</span><span class="p">(</span><span class="n">BaseEntity</span><span class="p">):</span>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a>    <span class="c1"># attributs exclus de l&#39;état de la classe</span>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a>    <span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a>    <span class="c1"># propriétés de la classe</span>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_allowed_keys</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-17-14" name="__codelineno-17-14"></a>        <span class="c1"># id : identifiant de la classe</span>
<a id="__codelineno-17-15" name="__codelineno-17-15"></a>        <span class="c1"># nom : nom de la classe</span>
<a id="__codelineno-17-16" name="__codelineno-17-16"></a>        <span class="k">return</span> <span class="n">BaseEntity</span><span class="o">.</span><span class="n">get_allowed_keys</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;nom&quot;</span><span class="p">]</span>
<a id="__codelineno-17-17" name="__codelineno-17-17"></a>
<a id="__codelineno-17-18" name="__codelineno-17-18"></a>    <span class="c1"># getter</span>
<a id="__codelineno-17-19" name="__codelineno-17-19"></a>    <span class="nd">@property</span>
<a id="__codelineno-17-20" name="__codelineno-17-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nom</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-17-21" name="__codelineno-17-21"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nom</span>
<a id="__codelineno-17-22" name="__codelineno-17-22"></a>
<a id="__codelineno-17-23" name="__codelineno-17-23"></a>    <span class="c1">#  setters</span>
<a id="__codelineno-17-24" name="__codelineno-17-24"></a>    <span class="nd">@nom</span><span class="o">.</span><span class="n">setter</span>
<a id="__codelineno-17-25" name="__codelineno-17-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nom</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">nom</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-17-26" name="__codelineno-17-26"></a>        <span class="c1"># nom doit être une chaîne de caractères non vide</span>
<a id="__codelineno-17-27" name="__codelineno-17-27"></a>        <span class="k">if</span> <span class="n">Utils</span><span class="o">.</span><span class="n">is_string_ok</span><span class="p">(</span><span class="n">nom</span><span class="p">):</span>
<a id="__codelineno-17-28" name="__codelineno-17-28"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__nom</span> <span class="o">=</span> <span class="n">nom</span>
<a id="__codelineno-17-29" name="__codelineno-17-29"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-17-30" name="__codelineno-17-30"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Le nom de la classe </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> doit être une chaîne de caractères non vide&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>La classe <strong>[Elève]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span>
<span class="normal"><a href="#__codelineno-18-16">16</a></span>
<span class="normal"><a href="#__codelineno-18-17">17</a></span>
<span class="normal"><a href="#__codelineno-18-18">18</a></span>
<span class="normal"><a href="#__codelineno-18-19">19</a></span>
<span class="normal"><a href="#__codelineno-18-20">20</a></span>
<span class="normal"><a href="#__codelineno-18-21">21</a></span>
<span class="normal"><a href="#__codelineno-18-22">22</a></span>
<span class="normal"><a href="#__codelineno-18-23">23</a></span>
<span class="normal"><a href="#__codelineno-18-24">24</a></span>
<span class="normal"><a href="#__codelineno-18-25">25</a></span>
<span class="normal"><a href="#__codelineno-18-26">26</a></span>
<span class="normal"><a href="#__codelineno-18-27">27</a></span>
<span class="normal"><a href="#__codelineno-18-28">28</a></span>
<span class="normal"><a href="#__codelineno-18-29">29</a></span>
<span class="normal"><a href="#__codelineno-18-30">30</a></span>
<span class="normal"><a href="#__codelineno-18-31">31</a></span>
<span class="normal"><a href="#__codelineno-18-32">32</a></span>
<span class="normal"><a href="#__codelineno-18-33">33</a></span>
<span class="normal"><a href="#__codelineno-18-34">34</a></span>
<span class="normal"><a href="#__codelineno-18-35">35</a></span>
<span class="normal"><a href="#__codelineno-18-36">36</a></span>
<span class="normal"><a href="#__codelineno-18-37">37</a></span>
<span class="normal"><a href="#__codelineno-18-38">38</a></span>
<span class="normal"><a href="#__codelineno-18-39">39</a></span>
<span class="normal"><a href="#__codelineno-18-40">40</a></span>
<span class="normal"><a href="#__codelineno-18-41">41</a></span>
<span class="normal"><a href="#__codelineno-18-42">42</a></span>
<span class="normal"><a href="#__codelineno-18-43">43</a></span>
<span class="normal"><a href="#__codelineno-18-44">44</a></span>
<span class="normal"><a href="#__codelineno-18-45">45</a></span>
<span class="normal"><a href="#__codelineno-18-46">46</a></span>
<span class="normal"><a href="#__codelineno-18-47">47</a></span>
<span class="normal"><a href="#__codelineno-18-48">48</a></span>
<span class="normal"><a href="#__codelineno-18-49">49</a></span>
<span class="normal"><a href="#__codelineno-18-50">50</a></span>
<span class="normal"><a href="#__codelineno-18-51">51</a></span>
<span class="normal"><a href="#__codelineno-18-52">52</a></span>
<span class="normal"><a href="#__codelineno-18-53">53</a></span>
<span class="normal"><a href="#__codelineno-18-54">54</a></span>
<span class="normal"><a href="#__codelineno-18-55">55</a></span>
<span class="normal"><a href="#__codelineno-18-56">56</a></span>
<span class="normal"><a href="#__codelineno-18-57">57</a></span>
<span class="normal"><a href="#__codelineno-18-58">58</a></span>
<span class="normal"><a href="#__codelineno-18-59">59</a></span>
<span class="normal"><a href="#__codelineno-18-60">60</a></span>
<span class="normal"><a href="#__codelineno-18-61">61</a></span>
<span class="normal"><a href="#__codelineno-18-62">62</a></span>
<span class="normal"><a href="#__codelineno-18-63">63</a></span>
<span class="normal"><a href="#__codelineno-18-64">64</a></span>
<span class="normal"><a href="#__codelineno-18-65">65</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="c1"># imports</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">BaseEntity</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseEntity</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Classe</span><span class="w"> </span><span class="kn">import</span> <span class="n">Classe</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">MyException</span><span class="w"> </span><span class="kn">import</span> <span class="n">MyException</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Utils</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">Elève</span><span class="p">(</span><span class="n">BaseEntity</span><span class="p">):</span>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a>    <span class="c1"># attributs exclus de l&#39;état de la classe</span>
<a id="__codelineno-18-11" name="__codelineno-18-11"></a>    <span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-18-12" name="__codelineno-18-12"></a>
<a id="__codelineno-18-13" name="__codelineno-18-13"></a>    <span class="c1"># propriétés de la classe</span>
<a id="__codelineno-18-14" name="__codelineno-18-14"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-18-15" name="__codelineno-18-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_allowed_keys</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-18-16" name="__codelineno-18-16"></a>        <span class="c1"># id : identifiant de l&#39;élève</span>
<a id="__codelineno-18-17" name="__codelineno-18-17"></a>        <span class="c1"># nom : nom de l&#39;élève</span>
<a id="__codelineno-18-18" name="__codelineno-18-18"></a>        <span class="c1"># prénom : prénom de l&#39;élève</span>
<a id="__codelineno-18-19" name="__codelineno-18-19"></a>        <span class="c1"># classe : classe de l&#39;élève</span>
<a id="__codelineno-18-20" name="__codelineno-18-20"></a>        <span class="k">return</span> <span class="n">BaseEntity</span><span class="o">.</span><span class="n">get_allowed_keys</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;nom&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">,</span> <span class="s2">&quot;classe&quot;</span><span class="p">]</span>
<a id="__codelineno-18-21" name="__codelineno-18-21"></a>
<a id="__codelineno-18-22" name="__codelineno-18-22"></a>    <span class="c1"># getters</span>
<a id="__codelineno-18-23" name="__codelineno-18-23"></a>    <span class="nd">@property</span>
<a id="__codelineno-18-24" name="__codelineno-18-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nom</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-18-25" name="__codelineno-18-25"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nom</span>
<a id="__codelineno-18-26" name="__codelineno-18-26"></a>
<a id="__codelineno-18-27" name="__codelineno-18-27"></a>    <span class="nd">@property</span>
<a id="__codelineno-18-28" name="__codelineno-18-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prénom</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-18-29" name="__codelineno-18-29"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__prénom</span>
<a id="__codelineno-18-30" name="__codelineno-18-30"></a>
<a id="__codelineno-18-31" name="__codelineno-18-31"></a>    <span class="nd">@property</span>
<a id="__codelineno-18-32" name="__codelineno-18-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">classe</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Classe</span><span class="p">:</span>
<a id="__codelineno-18-33" name="__codelineno-18-33"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__classe</span>
<a id="__codelineno-18-34" name="__codelineno-18-34"></a>
<a id="__codelineno-18-35" name="__codelineno-18-35"></a>    <span class="c1">#  setters</span>
<a id="__codelineno-18-36" name="__codelineno-18-36"></a>    <span class="nd">@nom</span><span class="o">.</span><span class="n">setter</span>
<a id="__codelineno-18-37" name="__codelineno-18-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nom</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">nom</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-18-38" name="__codelineno-18-38"></a>        <span class="c1"># nom doit être une chaîne de caractères non vide</span>
<a id="__codelineno-18-39" name="__codelineno-18-39"></a>        <span class="k">if</span> <span class="n">Utils</span><span class="o">.</span><span class="n">is_string_ok</span><span class="p">(</span><span class="n">nom</span><span class="p">):</span>
<a id="__codelineno-18-40" name="__codelineno-18-40"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__nom</span> <span class="o">=</span> <span class="n">nom</span>
<a id="__codelineno-18-41" name="__codelineno-18-41"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-18-42" name="__codelineno-18-42"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">41</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Le nom de l&#39;élève </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> doit être une chaîne de caractères non vide&quot;</span><span class="p">)</span>
<a id="__codelineno-18-43" name="__codelineno-18-43"></a>
<a id="__codelineno-18-44" name="__codelineno-18-44"></a>    <span class="nd">@prénom</span><span class="o">.</span><span class="n">setter</span>
<a id="__codelineno-18-45" name="__codelineno-18-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prénom</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">prénom</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-18-46" name="__codelineno-18-46"></a>        <span class="c1"># prénom doit être une chaîne de caractères non vide</span>
<a id="__codelineno-18-47" name="__codelineno-18-47"></a>        <span class="k">if</span> <span class="n">Utils</span><span class="o">.</span><span class="n">is_string_ok</span><span class="p">(</span><span class="n">prénom</span><span class="p">):</span>
<a id="__codelineno-18-48" name="__codelineno-18-48"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__prénom</span> <span class="o">=</span> <span class="n">prénom</span>
<a id="__codelineno-18-49" name="__codelineno-18-49"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-18-50" name="__codelineno-18-50"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Le prénom de l&#39;élève </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> doit être une chaîne de caractères non vide&quot;</span><span class="p">)</span>
<a id="__codelineno-18-51" name="__codelineno-18-51"></a>
<a id="__codelineno-18-52" name="__codelineno-18-52"></a>    <span class="nd">@classe</span><span class="o">.</span><span class="n">setter</span>
<a id="__codelineno-18-53" name="__codelineno-18-53"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">classe</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-18-54" name="__codelineno-18-54"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-18-55" name="__codelineno-18-55"></a>            <span class="c1"># on attend un type Classe</span>
<a id="__codelineno-18-56" name="__codelineno-18-56"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Classe</span><span class="p">):</span>
<a id="__codelineno-18-57" name="__codelineno-18-57"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__classe</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-18-58" name="__codelineno-18-58"></a>            <span class="c1"># ou un type dict</span>
<a id="__codelineno-18-59" name="__codelineno-18-59"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-18-60" name="__codelineno-18-60"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__classe</span><span class="o">=</span><span class="n">Classe</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-18-61" name="__codelineno-18-61"></a>            <span class="c1"># ou un type json</span>
<a id="__codelineno-18-62" name="__codelineno-18-62"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-18-63" name="__codelineno-18-63"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__classe</span> <span class="o">=</span> <span class="n">Classe</span><span class="p">()</span><span class="o">.</span><span class="n">fromjson</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-18-64" name="__codelineno-18-64"></a>        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-18-65" name="__codelineno-18-65"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">43</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;L&#39;attribut [</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">] de l&#39;élève </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> doit être de type Classe ou dict ou json. Erreur : </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>La classe <strong>[Matière]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span>
<span class="normal"><a href="#__codelineno-19-27">27</a></span>
<span class="normal"><a href="#__codelineno-19-28">28</a></span>
<span class="normal"><a href="#__codelineno-19-29">29</a></span>
<span class="normal"><a href="#__codelineno-19-30">30</a></span>
<span class="normal"><a href="#__codelineno-19-31">31</a></span>
<span class="normal"><a href="#__codelineno-19-32">32</a></span>
<span class="normal"><a href="#__codelineno-19-33">33</a></span>
<span class="normal"><a href="#__codelineno-19-34">34</a></span>
<span class="normal"><a href="#__codelineno-19-35">35</a></span>
<span class="normal"><a href="#__codelineno-19-36">36</a></span>
<span class="normal"><a href="#__codelineno-19-37">37</a></span>
<span class="normal"><a href="#__codelineno-19-38">38</a></span>
<span class="normal"><a href="#__codelineno-19-39">39</a></span>
<span class="normal"><a href="#__codelineno-19-40">40</a></span>
<span class="normal"><a href="#__codelineno-19-41">41</a></span>
<span class="normal"><a href="#__codelineno-19-42">42</a></span>
<span class="normal"><a href="#__codelineno-19-43">43</a></span>
<span class="normal"><a href="#__codelineno-19-44">44</a></span>
<span class="normal"><a href="#__codelineno-19-45">45</a></span>
<span class="normal"><a href="#__codelineno-19-46">46</a></span>
<span class="normal"><a href="#__codelineno-19-47">47</a></span>
<span class="normal"><a href="#__codelineno-19-48">48</a></span>
<span class="normal"><a href="#__codelineno-19-49">49</a></span>
<span class="normal"><a href="#__codelineno-19-50">50</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="c1"># imports</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">BaseEntity</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseEntity</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">MyException</span><span class="w"> </span><span class="kn">import</span> <span class="n">MyException</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Utils</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Matière</span><span class="p">(</span><span class="n">BaseEntity</span><span class="p">):</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a>    <span class="c1"># attributs exclus de l&#39;état de la classe</span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a>    <span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a>    <span class="c1"># propriétés de la classe</span>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_allowed_keys</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a>        <span class="c1"># id : identifiant de la matière</span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a>        <span class="c1"># nom : nom de la matière</span>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a>        <span class="c1"># coefficient : coefficient de la matière</span>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a>        <span class="k">return</span> <span class="n">BaseEntity</span><span class="o">.</span><span class="n">get_allowed_keys</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;nom&quot;</span><span class="p">,</span> <span class="s2">&quot;coefficient&quot;</span><span class="p">]</span>
<a id="__codelineno-19-18" name="__codelineno-19-18"></a>
<a id="__codelineno-19-19" name="__codelineno-19-19"></a>    <span class="c1"># getter</span>
<a id="__codelineno-19-20" name="__codelineno-19-20"></a>    <span class="nd">@property</span>
<a id="__codelineno-19-21" name="__codelineno-19-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nom</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-19-22" name="__codelineno-19-22"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nom</span>
<a id="__codelineno-19-23" name="__codelineno-19-23"></a>
<a id="__codelineno-19-24" name="__codelineno-19-24"></a>    <span class="nd">@property</span>
<a id="__codelineno-19-25" name="__codelineno-19-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">coefficient</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-19-26" name="__codelineno-19-26"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__coefficient</span>
<a id="__codelineno-19-27" name="__codelineno-19-27"></a>
<a id="__codelineno-19-28" name="__codelineno-19-28"></a>    <span class="c1">#  setters</span>
<a id="__codelineno-19-29" name="__codelineno-19-29"></a>    <span class="nd">@nom</span><span class="o">.</span><span class="n">setter</span>
<a id="__codelineno-19-30" name="__codelineno-19-30"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nom</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">nom</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-19-31" name="__codelineno-19-31"></a>        <span class="c1"># nom doit être une chaîne de caractères non vide</span>
<a id="__codelineno-19-32" name="__codelineno-19-32"></a>        <span class="k">if</span> <span class="n">Utils</span><span class="o">.</span><span class="n">is_string_ok</span><span class="p">(</span><span class="n">nom</span><span class="p">):</span>
<a id="__codelineno-19-33" name="__codelineno-19-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__nom</span> <span class="o">=</span> <span class="n">nom</span>
<a id="__codelineno-19-34" name="__codelineno-19-34"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-19-35" name="__codelineno-19-35"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Le nom de la matière </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> doit être une chaîne de caractères non vide&quot;</span><span class="p">)</span>
<a id="__codelineno-19-36" name="__codelineno-19-36"></a>
<a id="__codelineno-19-37" name="__codelineno-19-37"></a>    <span class="nd">@coefficient</span><span class="o">.</span><span class="n">setter</span>
<a id="__codelineno-19-38" name="__codelineno-19-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">coefficient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coefficient</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-19-39" name="__codelineno-19-39"></a>        <span class="c1"># le coefficient doit être un réel &gt;=0</span>
<a id="__codelineno-19-40" name="__codelineno-19-40"></a>        <span class="n">erreur</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-19-41" name="__codelineno-19-41"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coefficient</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-19-42" name="__codelineno-19-42"></a>            <span class="k">if</span> <span class="n">coefficient</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-19-43" name="__codelineno-19-43"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__coefficient</span> <span class="o">=</span> <span class="n">coefficient</span>
<a id="__codelineno-19-44" name="__codelineno-19-44"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-19-45" name="__codelineno-19-45"></a>                <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-19-46" name="__codelineno-19-46"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-19-47" name="__codelineno-19-47"></a>            <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-19-48" name="__codelineno-19-48"></a>        <span class="c1"># erreur ?</span>
<a id="__codelineno-19-49" name="__codelineno-19-49"></a>        <span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-19-50" name="__codelineno-19-50"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Le coefficient de la matière </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nom</span><span class="si">}</span><span class="s2"> doit être un réel &gt;=0&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>La classe <strong>[Note]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span>
<span class="normal"><a href="#__codelineno-20-17">17</a></span>
<span class="normal"><a href="#__codelineno-20-18">18</a></span>
<span class="normal"><a href="#__codelineno-20-19">19</a></span>
<span class="normal"><a href="#__codelineno-20-20">20</a></span>
<span class="normal"><a href="#__codelineno-20-21">21</a></span>
<span class="normal"><a href="#__codelineno-20-22">22</a></span>
<span class="normal"><a href="#__codelineno-20-23">23</a></span>
<span class="normal"><a href="#__codelineno-20-24">24</a></span>
<span class="normal"><a href="#__codelineno-20-25">25</a></span>
<span class="normal"><a href="#__codelineno-20-26">26</a></span>
<span class="normal"><a href="#__codelineno-20-27">27</a></span>
<span class="normal"><a href="#__codelineno-20-28">28</a></span>
<span class="normal"><a href="#__codelineno-20-29">29</a></span>
<span class="normal"><a href="#__codelineno-20-30">30</a></span>
<span class="normal"><a href="#__codelineno-20-31">31</a></span>
<span class="normal"><a href="#__codelineno-20-32">32</a></span>
<span class="normal"><a href="#__codelineno-20-33">33</a></span>
<span class="normal"><a href="#__codelineno-20-34">34</a></span>
<span class="normal"><a href="#__codelineno-20-35">35</a></span>
<span class="normal"><a href="#__codelineno-20-36">36</a></span>
<span class="normal"><a href="#__codelineno-20-37">37</a></span>
<span class="normal"><a href="#__codelineno-20-38">38</a></span>
<span class="normal"><a href="#__codelineno-20-39">39</a></span>
<span class="normal"><a href="#__codelineno-20-40">40</a></span>
<span class="normal"><a href="#__codelineno-20-41">41</a></span>
<span class="normal"><a href="#__codelineno-20-42">42</a></span>
<span class="normal"><a href="#__codelineno-20-43">43</a></span>
<span class="normal"><a href="#__codelineno-20-44">44</a></span>
<span class="normal"><a href="#__codelineno-20-45">45</a></span>
<span class="normal"><a href="#__codelineno-20-46">46</a></span>
<span class="normal"><a href="#__codelineno-20-47">47</a></span>
<span class="normal"><a href="#__codelineno-20-48">48</a></span>
<span class="normal"><a href="#__codelineno-20-49">49</a></span>
<span class="normal"><a href="#__codelineno-20-50">50</a></span>
<span class="normal"><a href="#__codelineno-20-51">51</a></span>
<span class="normal"><a href="#__codelineno-20-52">52</a></span>
<span class="normal"><a href="#__codelineno-20-53">53</a></span>
<span class="normal"><a href="#__codelineno-20-54">54</a></span>
<span class="normal"><a href="#__codelineno-20-55">55</a></span>
<span class="normal"><a href="#__codelineno-20-56">56</a></span>
<span class="normal"><a href="#__codelineno-20-57">57</a></span>
<span class="normal"><a href="#__codelineno-20-58">58</a></span>
<span class="normal"><a href="#__codelineno-20-59">59</a></span>
<span class="normal"><a href="#__codelineno-20-60">60</a></span>
<span class="normal"><a href="#__codelineno-20-61">61</a></span>
<span class="normal"><a href="#__codelineno-20-62">62</a></span>
<span class="normal"><a href="#__codelineno-20-63">63</a></span>
<span class="normal"><a href="#__codelineno-20-64">64</a></span>
<span class="normal"><a href="#__codelineno-20-65">65</a></span>
<span class="normal"><a href="#__codelineno-20-66">66</a></span>
<span class="normal"><a href="#__codelineno-20-67">67</a></span>
<span class="normal"><a href="#__codelineno-20-68">68</a></span>
<span class="normal"><a href="#__codelineno-20-69">69</a></span>
<span class="normal"><a href="#__codelineno-20-70">70</a></span>
<span class="normal"><a href="#__codelineno-20-71">71</a></span>
<span class="normal"><a href="#__codelineno-20-72">72</a></span>
<span class="normal"><a href="#__codelineno-20-73">73</a></span>
<span class="normal"><a href="#__codelineno-20-74">74</a></span>
<span class="normal"><a href="#__codelineno-20-75">75</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="c1"># imports</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">BaseEntity</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseEntity</span>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Elève</span><span class="w"> </span><span class="kn">import</span> <span class="n">Elève</span>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Matière</span><span class="w"> </span><span class="kn">import</span> <span class="n">Matière</span>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">MyException</span><span class="w"> </span><span class="kn">import</span> <span class="n">MyException</span>
<a id="__codelineno-20-6" name="__codelineno-20-6"></a>
<a id="__codelineno-20-7" name="__codelineno-20-7"></a>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">Note</span><span class="p">(</span><span class="n">BaseEntity</span><span class="p">):</span>
<a id="__codelineno-20-9" name="__codelineno-20-9"></a>    <span class="c1"># attributs exclus de l&#39;état de la classe</span>
<a id="__codelineno-20-10" name="__codelineno-20-10"></a>    <span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-20-11" name="__codelineno-20-11"></a>
<a id="__codelineno-20-12" name="__codelineno-20-12"></a>    <span class="c1"># propriétés de la classe</span>
<a id="__codelineno-20-13" name="__codelineno-20-13"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-20-14" name="__codelineno-20-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_allowed_keys</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-20-15" name="__codelineno-20-15"></a>        <span class="c1"># id : identifiant de la note</span>
<a id="__codelineno-20-16" name="__codelineno-20-16"></a>        <span class="c1"># valeur : la note elle-même</span>
<a id="__codelineno-20-17" name="__codelineno-20-17"></a>        <span class="c1"># élève : élève (de type Elève) concerné par la note</span>
<a id="__codelineno-20-18" name="__codelineno-20-18"></a>        <span class="c1"># matière : matière (de type Matière) concernée par la note</span>
<a id="__codelineno-20-19" name="__codelineno-20-19"></a>        <span class="c1"># l&#39;objet Note est donc la note d&#39;un élève dans une matière</span>
<a id="__codelineno-20-20" name="__codelineno-20-20"></a>        <span class="k">return</span> <span class="n">BaseEntity</span><span class="o">.</span><span class="n">get_allowed_keys</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;valeur&quot;</span><span class="p">,</span> <span class="s2">&quot;élève&quot;</span><span class="p">,</span> <span class="s2">&quot;matière&quot;</span><span class="p">]</span>
<a id="__codelineno-20-21" name="__codelineno-20-21"></a>
<a id="__codelineno-20-22" name="__codelineno-20-22"></a>    <span class="c1"># getters</span>
<a id="__codelineno-20-23" name="__codelineno-20-23"></a>    <span class="nd">@property</span>
<a id="__codelineno-20-24" name="__codelineno-20-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">valeur</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-20-25" name="__codelineno-20-25"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__valeur</span>
<a id="__codelineno-20-26" name="__codelineno-20-26"></a>
<a id="__codelineno-20-27" name="__codelineno-20-27"></a>    <span class="nd">@property</span>
<a id="__codelineno-20-28" name="__codelineno-20-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">élève</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Elève</span><span class="p">:</span>
<a id="__codelineno-20-29" name="__codelineno-20-29"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__élève</span>
<a id="__codelineno-20-30" name="__codelineno-20-30"></a>
<a id="__codelineno-20-31" name="__codelineno-20-31"></a>    <span class="nd">@property</span>
<a id="__codelineno-20-32" name="__codelineno-20-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">matière</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matière</span><span class="p">:</span>
<a id="__codelineno-20-33" name="__codelineno-20-33"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__matière</span>
<a id="__codelineno-20-34" name="__codelineno-20-34"></a>
<a id="__codelineno-20-35" name="__codelineno-20-35"></a>    <span class="c1"># getters</span>
<a id="__codelineno-20-36" name="__codelineno-20-36"></a>    <span class="nd">@valeur</span><span class="o">.</span><span class="n">setter</span>
<a id="__codelineno-20-37" name="__codelineno-20-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">valeur</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">valeur</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-20-38" name="__codelineno-20-38"></a>        <span class="c1"># la note doit être un réel entre 0 et 20</span>
<a id="__codelineno-20-39" name="__codelineno-20-39"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valeur</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">valeur</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
<a id="__codelineno-20-40" name="__codelineno-20-40"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__valeur</span> <span class="o">=</span> <span class="n">valeur</span>
<a id="__codelineno-20-41" name="__codelineno-20-41"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-20-42" name="__codelineno-20-42"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span>
<a id="__codelineno-20-43" name="__codelineno-20-43"></a>                <span class="sa">f</span><span class="s2">&quot;L&#39;attribut </span><span class="si">{</span><span class="n">valeur</span><span class="si">}</span><span class="s2"> de la note </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> doit être un nombre dans l&#39;intervalle [0,20]&quot;</span><span class="p">)</span>
<a id="__codelineno-20-44" name="__codelineno-20-44"></a>
<a id="__codelineno-20-45" name="__codelineno-20-45"></a>    <span class="nd">@élève</span><span class="o">.</span><span class="n">setter</span>
<a id="__codelineno-20-46" name="__codelineno-20-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">élève</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-20-47" name="__codelineno-20-47"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-20-48" name="__codelineno-20-48"></a>            <span class="c1"># on attend un type Elève</span>
<a id="__codelineno-20-49" name="__codelineno-20-49"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Elève</span><span class="p">):</span>
<a id="__codelineno-20-50" name="__codelineno-20-50"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__élève</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-20-51" name="__codelineno-20-51"></a>            <span class="c1"># ou un type dict</span>
<a id="__codelineno-20-52" name="__codelineno-20-52"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-20-53" name="__codelineno-20-53"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__élève</span> <span class="o">=</span> <span class="n">Elève</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-20-54" name="__codelineno-20-54"></a>            <span class="c1"># ou un type json</span>
<a id="__codelineno-20-55" name="__codelineno-20-55"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-20-56" name="__codelineno-20-56"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__élève</span> <span class="o">=</span> <span class="n">Elève</span><span class="p">()</span><span class="o">.</span><span class="n">fromjson</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-20-57" name="__codelineno-20-57"></a>        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-20-58" name="__codelineno-20-58"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-20-59" name="__codelineno-20-59"></a>                <span class="sa">f</span><span class="s2">&quot;L&#39;attribut [</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">] de la note </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> doit être de type Elève ou dict ou json. Erreur : </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-20-60" name="__codelineno-20-60"></a>
<a id="__codelineno-20-61" name="__codelineno-20-61"></a>    <span class="nd">@matière</span><span class="o">.</span><span class="n">setter</span>
<a id="__codelineno-20-62" name="__codelineno-20-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">matière</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-20-63" name="__codelineno-20-63"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-20-64" name="__codelineno-20-64"></a>            <span class="c1"># on attend un type Matière</span>
<a id="__codelineno-20-65" name="__codelineno-20-65"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Matière</span><span class="p">):</span>
<a id="__codelineno-20-66" name="__codelineno-20-66"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__matière</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-20-67" name="__codelineno-20-67"></a>            <span class="c1"># ou un type dict</span>
<a id="__codelineno-20-68" name="__codelineno-20-68"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-20-69" name="__codelineno-20-69"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__matière</span> <span class="o">=</span> <span class="n">Matière</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-20-70" name="__codelineno-20-70"></a>            <span class="c1"># ou un type json</span>
<a id="__codelineno-20-71" name="__codelineno-20-71"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-20-72" name="__codelineno-20-72"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__matière</span> <span class="o">=</span> <span class="n">Matière</span><span class="p">()</span><span class="o">.</span><span class="n">fromjson</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-20-73" name="__codelineno-20-73"></a>        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-20-74" name="__codelineno-20-74"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">33</span><span class="p">,</span>
<a id="__codelineno-20-75" name="__codelineno-20-75"></a>                <span class="sa">f</span><span class="s2">&quot;L&#39;attribut [</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">] de la note </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> doit être de type Matière ou dict ou json. Erreur : </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="1964-configuration">19.6.4. Configuration</h3>
<p><img src="images/1000000000000193000001C3ED33463B.png" style="width:4.65cm;height:5.201cm;" alt="Image" /></p>
<p>La configuration a été éclatée sur plusieurs fichiers :</p>
<ul>
<li>la configuration générale dans <strong>[config.py]</strong> : elle établit le Python Path de l’application et instancie les couches de l’architecture ;</li>
<li>la configuration de <strong>[sqlalchemy]</strong> dans <strong>[config_database]</strong> : elle fait les mappings Classes / Tables ;</li>
<li>les couches de l’application sont configurées dans <strong>[config_layers]</strong> ;
Le fichier <strong>[config]</strong> est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span>
<span class="normal"><a href="#__codelineno-21-12">12</a></span>
<span class="normal"><a href="#__codelineno-21-13">13</a></span>
<span class="normal"><a href="#__codelineno-21-14">14</a></span>
<span class="normal"><a href="#__codelineno-21-15">15</a></span>
<span class="normal"><a href="#__codelineno-21-16">16</a></span>
<span class="normal"><a href="#__codelineno-21-17">17</a></span>
<span class="normal"><a href="#__codelineno-21-18">18</a></span>
<span class="normal"><a href="#__codelineno-21-19">19</a></span>
<span class="normal"><a href="#__codelineno-21-20">20</a></span>
<span class="normal"><a href="#__codelineno-21-21">21</a></span>
<span class="normal"><a href="#__codelineno-21-22">22</a></span>
<span class="normal"><a href="#__codelineno-21-23">23</a></span>
<span class="normal"><a href="#__codelineno-21-24">24</a></span>
<span class="normal"><a href="#__codelineno-21-25">25</a></span>
<span class="normal"><a href="#__codelineno-21-26">26</a></span>
<span class="normal"><a href="#__codelineno-21-27">27</a></span>
<span class="normal"><a href="#__codelineno-21-28">28</a></span>
<span class="normal"><a href="#__codelineno-21-29">29</a></span>
<span class="normal"><a href="#__codelineno-21-30">30</a></span>
<span class="normal"><a href="#__codelineno-21-31">31</a></span>
<span class="normal"><a href="#__codelineno-21-32">32</a></span>
<span class="normal"><a href="#__codelineno-21-33">33</a></span>
<span class="normal"><a href="#__codelineno-21-34">34</a></span>
<span class="normal"><a href="#__codelineno-21-35">35</a></span>
<span class="normal"><a href="#__codelineno-21-36">36</a></span>
<span class="normal"><a href="#__codelineno-21-37">37</a></span>
<span class="normal"><a href="#__codelineno-21-38">38</a></span>
<span class="normal"><a href="#__codelineno-21-39">39</a></span>
<span class="normal"><a href="#__codelineno-21-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a>    <span class="c1"># étape 1 ---</span>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a>    <span class="c1"># on établit le Python Path de l&#39;application</span>
<a id="__codelineno-21-6" name="__codelineno-21-6"></a>    <span class="c1"># chemin absolu du dossier de ce script</span>
<a id="__codelineno-21-7" name="__codelineno-21-7"></a>    <span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<a id="__codelineno-21-8" name="__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9"></a>    <span class="c1"># chemin absolu référence des chemins relatifs de la configuration</span>
<a id="__codelineno-21-10" name="__codelineno-21-10"></a>    <span class="n">root_dir</span> <span class="o">=</span> <span class="s2">&quot;C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020&quot;</span>
<a id="__codelineno-21-11" name="__codelineno-21-11"></a>
<a id="__codelineno-21-12" name="__codelineno-21-12"></a>    <span class="c1"># chemins absolus des dépendances</span>
<a id="__codelineno-21-13" name="__codelineno-21-13"></a>    <span class="n">absolute_dependencies</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-21-14" name="__codelineno-21-14"></a>        <span class="c1"># BaseEntity, MyException</span>
<a id="__codelineno-21-15" name="__codelineno-21-15"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/classes/02/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-21-16" name="__codelineno-21-16"></a>        <span class="c1"># projet troiscouches v01</span>
<a id="__codelineno-21-17" name="__codelineno-21-17"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/troiscouches/v01/interfaces&quot;</span><span class="p">,</span>
<a id="__codelineno-21-18" name="__codelineno-21-18"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/troiscouches/v01/services&quot;</span><span class="p">,</span>
<a id="__codelineno-21-19" name="__codelineno-21-19"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/troiscouches/v01/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-21-20" name="__codelineno-21-20"></a>        <span class="c1"># dossiers du présent projet</span>
<a id="__codelineno-21-21" name="__codelineno-21-21"></a>        <span class="n">script_dir</span><span class="p">,</span>
<a id="__codelineno-21-22" name="__codelineno-21-22"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../services&quot;</span><span class="p">,</span>
<a id="__codelineno-21-23" name="__codelineno-21-23"></a>    <span class="p">]</span>
<a id="__codelineno-21-24" name="__codelineno-21-24"></a>
<a id="__codelineno-21-25" name="__codelineno-21-25"></a>    <span class="c1"># mise à jour du syspath</span>
<a id="__codelineno-21-26" name="__codelineno-21-26"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_syspath</span>
<a id="__codelineno-21-27" name="__codelineno-21-27"></a>    <span class="n">set_syspath</span><span class="p">(</span><span class="n">absolute_dependencies</span><span class="p">)</span>
<a id="__codelineno-21-28" name="__codelineno-21-28"></a>
<a id="__codelineno-21-29" name="__codelineno-21-29"></a>    <span class="c1"># étape 2 ------</span>
<a id="__codelineno-21-30" name="__codelineno-21-30"></a>    <span class="c1"># configuration base de données</span>
<a id="__codelineno-21-31" name="__codelineno-21-31"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config_database</span>
<a id="__codelineno-21-32" name="__codelineno-21-32"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">config_database</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-21-33" name="__codelineno-21-33"></a>
<a id="__codelineno-21-34" name="__codelineno-21-34"></a>    <span class="c1"># étape 3 ------</span>
<a id="__codelineno-21-35" name="__codelineno-21-35"></a>    <span class="c1"># instanciation des couches de l&#39;application</span>
<a id="__codelineno-21-36" name="__codelineno-21-36"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config_layers</span>
<a id="__codelineno-21-37" name="__codelineno-21-37"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">config_layers</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-21-38" name="__codelineno-21-38"></a>
<a id="__codelineno-21-39" name="__codelineno-21-39"></a>    <span class="c1"># on rend la config</span>
<a id="__codelineno-21-40" name="__codelineno-21-40"></a>    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 4-27 : construction du Python Path de l’application ;</li>
<li>lignes 29-32 : configuration <strong>[sqlalchemy]</strong> ;</li>
<li>lignes 34-37 : configuration des couches de l’application ;
Le fichier <strong>[config_database]</strong> est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">  1</a></span>
<span class="normal"><a href="#__codelineno-22-2">  2</a></span>
<span class="normal"><a href="#__codelineno-22-3">  3</a></span>
<span class="normal"><a href="#__codelineno-22-4">  4</a></span>
<span class="normal"><a href="#__codelineno-22-5">  5</a></span>
<span class="normal"><a href="#__codelineno-22-6">  6</a></span>
<span class="normal"><a href="#__codelineno-22-7">  7</a></span>
<span class="normal"><a href="#__codelineno-22-8">  8</a></span>
<span class="normal"><a href="#__codelineno-22-9">  9</a></span>
<span class="normal"><a href="#__codelineno-22-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-22-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-22-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-22-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-22-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-22-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-22-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-22-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-22-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-22-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-22-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-22-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-22-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-22-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-22-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-22-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-22-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-22-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-22-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-22-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-22-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-22-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-22-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-22-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-22-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-22-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-22-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-22-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-22-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-22-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-22-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-22-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-22-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-22-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-22-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-22-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-22-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-22-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-22-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-22-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-22-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-22-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-22-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-22-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-22-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-22-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-22-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-22-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-22-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-22-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-22-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-22-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-22-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-22-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-22-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-22-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-22-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-22-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-22-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-22-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-22-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-22-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-22-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-22-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-22-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-22-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-22-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-22-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-22-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-22-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-22-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-22-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-22-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-22-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-22-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-22-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-22-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-22-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-22-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-22-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-22-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-22-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-22-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-22-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-22-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-22-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-22-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-22-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-22-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-22-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-22-100">100</a></span>
<span class="normal"><a href="#__codelineno-22-101">101</a></span>
<span class="normal"><a href="#__codelineno-22-102">102</a></span>
<span class="normal"><a href="#__codelineno-22-103">103</a></span>
<span class="normal"><a href="#__codelineno-22-104">104</a></span>
<span class="normal"><a href="#__codelineno-22-105">105</a></span>
<span class="normal"><a href="#__codelineno-22-106">106</a></span>
<span class="normal"><a href="#__codelineno-22-107">107</a></span>
<span class="normal"><a href="#__codelineno-22-108">108</a></span>
<span class="normal"><a href="#__codelineno-22-109">109</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a>    <span class="c1"># config[&#39;sgbd&#39;] est le nom du SGBD utilisé</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a>    <span class="c1"># mysql : MySQL</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a>    <span class="c1"># pgres : PostgreSQL</span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a>    <span class="c1"># configuration sqlalchemy</span>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">create_engine</span>
<a id="__codelineno-22-8" name="__codelineno-22-8"></a>
<a id="__codelineno-22-9" name="__codelineno-22-9"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">sessionmaker</span>
<a id="__codelineno-22-10" name="__codelineno-22-10"></a>
<a id="__codelineno-22-11" name="__codelineno-22-11"></a>    <span class="c1"># chaînes de connexion aux bases de données exploitées</span>
<a id="__codelineno-22-12" name="__codelineno-22-12"></a>    <span class="n">engines</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-22-13" name="__codelineno-22-13"></a>        <span class="s1">&#39;mysql&#39;</span><span class="p">:</span> <span class="s2">&quot;mysql+mysqlconnector://admecole:mdpecole@localhost/dbecole&quot;</span><span class="p">,</span>
<a id="__codelineno-22-14" name="__codelineno-22-14"></a>        <span class="s1">&#39;pgres&#39;</span><span class="p">:</span> <span class="s2">&quot;postgresql+psycopg2://admecole:mdpecole@localhost/dbecole&quot;</span>
<a id="__codelineno-22-15" name="__codelineno-22-15"></a>    <span class="p">}</span>
<a id="__codelineno-22-16" name="__codelineno-22-16"></a>    <span class="c1"># chaîne de connexion à la base de données exploitée</span>
<a id="__codelineno-22-17" name="__codelineno-22-17"></a>    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">engines</span><span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sgbd&#39;</span><span class="p">]])</span>
<a id="__codelineno-22-18" name="__codelineno-22-18"></a>
<a id="__codelineno-22-19" name="__codelineno-22-19"></a>    <span class="c1"># metadata</span>
<a id="__codelineno-22-20" name="__codelineno-22-20"></a>    <span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<a id="__codelineno-22-21" name="__codelineno-22-21"></a>
<a id="__codelineno-22-22" name="__codelineno-22-22"></a>    <span class="c1"># les tables de la base</span>
<a id="__codelineno-22-23" name="__codelineno-22-23"></a>    <span class="n">tables</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-22-24" name="__codelineno-22-24"></a>    <span class="c1"># les classes mappées</span>
<a id="__codelineno-22-25" name="__codelineno-22-25"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Classe</span><span class="w"> </span><span class="kn">import</span> <span class="n">Classe</span>
<a id="__codelineno-22-26" name="__codelineno-22-26"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Elève</span><span class="w"> </span><span class="kn">import</span> <span class="n">Elève</span>
<a id="__codelineno-22-27" name="__codelineno-22-27"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Note</span><span class="w"> </span><span class="kn">import</span> <span class="n">Note</span>
<a id="__codelineno-22-28" name="__codelineno-22-28"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Matière</span><span class="w"> </span><span class="kn">import</span> <span class="n">Matière</span>
<a id="__codelineno-22-29" name="__codelineno-22-29"></a>
<a id="__codelineno-22-30" name="__codelineno-22-30"></a>    <span class="c1"># la table des classes</span>
<a id="__codelineno-22-31" name="__codelineno-22-31"></a>    <span class="n">tables</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">classes_table</span> <span class="o">=</span> \
<a id="__codelineno-22-32" name="__codelineno-22-32"></a>        <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;classes&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-22-33" name="__codelineno-22-33"></a>              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-22-34" name="__codelineno-22-34"></a>              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;nom&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-22-35" name="__codelineno-22-35"></a>              <span class="p">)</span>
<a id="__codelineno-22-36" name="__codelineno-22-36"></a>
<a id="__codelineno-22-37" name="__codelineno-22-37"></a>    <span class="n">mapper</span><span class="p">(</span><span class="n">Classe</span><span class="p">,</span> <span class="n">tables</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">],</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-22-38" name="__codelineno-22-38"></a>        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">classes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-22-39" name="__codelineno-22-39"></a>        <span class="s1">&#39;nom&#39;</span><span class="p">:</span> <span class="n">classes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">nom</span>
<a id="__codelineno-22-40" name="__codelineno-22-40"></a>    <span class="p">})</span>
<a id="__codelineno-22-41" name="__codelineno-22-41"></a>
<a id="__codelineno-22-42" name="__codelineno-22-42"></a>    <span class="c1"># la table des élèves</span>
<a id="__codelineno-22-43" name="__codelineno-22-43"></a>    <span class="n">tables</span><span class="p">[</span><span class="s1">&#39;élèves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">élèves_table</span> <span class="o">=</span> \
<a id="__codelineno-22-44" name="__codelineno-22-44"></a>        <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;élèves&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-22-45" name="__codelineno-22-45"></a>              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-22-46" name="__codelineno-22-46"></a>              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;nom&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-22-47" name="__codelineno-22-47"></a>              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;prénom&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-22-48" name="__codelineno-22-48"></a>              <span class="c1"># un élève appartient à une classe</span>
<a id="__codelineno-22-49" name="__codelineno-22-49"></a>              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;classe_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;classes.id&#39;</span><span class="p">)),</span>
<a id="__codelineno-22-50" name="__codelineno-22-50"></a>              <span class="p">)</span>
<a id="__codelineno-22-51" name="__codelineno-22-51"></a>    <span class="c1"># mapping</span>
<a id="__codelineno-22-52" name="__codelineno-22-52"></a>    <span class="n">mapper</span><span class="p">(</span><span class="n">Elève</span><span class="p">,</span> <span class="n">tables</span><span class="p">[</span><span class="s1">&#39;élèves&#39;</span><span class="p">],</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-22-53" name="__codelineno-22-53"></a>        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">élèves_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-22-54" name="__codelineno-22-54"></a>        <span class="s1">&#39;nom&#39;</span><span class="p">:</span> <span class="n">élèves_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">nom</span><span class="p">,</span>
<a id="__codelineno-22-55" name="__codelineno-22-55"></a>        <span class="s1">&#39;prénom&#39;</span><span class="p">:</span> <span class="n">élèves_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">prénom</span><span class="p">,</span>
<a id="__codelineno-22-56" name="__codelineno-22-56"></a>        <span class="s1">&#39;classe&#39;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Classe</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;élèves&quot;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s2">&quot;select&quot;</span><span class="p">)</span>
<a id="__codelineno-22-57" name="__codelineno-22-57"></a>    <span class="p">})</span>
<a id="__codelineno-22-58" name="__codelineno-22-58"></a>
<a id="__codelineno-22-59" name="__codelineno-22-59"></a>    <span class="c1"># la table des matières</span>
<a id="__codelineno-22-60" name="__codelineno-22-60"></a>    <span class="n">tables</span><span class="p">[</span><span class="s1">&#39;matières&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matières_table</span> <span class="o">=</span> \
<a id="__codelineno-22-61" name="__codelineno-22-61"></a>        <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;matières&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-22-62" name="__codelineno-22-62"></a>              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-22-63" name="__codelineno-22-63"></a>              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;nom&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-22-64" name="__codelineno-22-64"></a>              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;coefficient&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-22-65" name="__codelineno-22-65"></a>              <span class="p">)</span>
<a id="__codelineno-22-66" name="__codelineno-22-66"></a>    <span class="c1"># mapping</span>
<a id="__codelineno-22-67" name="__codelineno-22-67"></a>    <span class="n">mapper</span><span class="p">(</span><span class="n">Matière</span><span class="p">,</span> <span class="n">tables</span><span class="p">[</span><span class="s1">&#39;matières&#39;</span><span class="p">],</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-22-68" name="__codelineno-22-68"></a>        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">matières_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-22-69" name="__codelineno-22-69"></a>        <span class="s1">&#39;nom&#39;</span><span class="p">:</span> <span class="n">matières_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">nom</span><span class="p">,</span>
<a id="__codelineno-22-70" name="__codelineno-22-70"></a>        <span class="s2">&quot;coefficient&quot;</span><span class="p">:</span> <span class="n">matières_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">coefficient</span>
<a id="__codelineno-22-71" name="__codelineno-22-71"></a>    <span class="p">})</span>
<a id="__codelineno-22-72" name="__codelineno-22-72"></a>
<a id="__codelineno-22-73" name="__codelineno-22-73"></a>    <span class="c1"># la table des notes</span>
<a id="__codelineno-22-74" name="__codelineno-22-74"></a>    <span class="n">tables</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">notes_table</span> <span class="o">=</span> \
<a id="__codelineno-22-75" name="__codelineno-22-75"></a>        <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;notes&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-22-76" name="__codelineno-22-76"></a>              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-22-77" name="__codelineno-22-77"></a>              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;valeur&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-22-78" name="__codelineno-22-78"></a>              <span class="c1"># une note est celle d&#39;un élève</span>
<a id="__codelineno-22-79" name="__codelineno-22-79"></a>              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;élève_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;élèves.id&#39;</span><span class="p">)),</span>
<a id="__codelineno-22-80" name="__codelineno-22-80"></a>              <span class="c1"># une note est celle d&#39;une matière</span>
<a id="__codelineno-22-81" name="__codelineno-22-81"></a>              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;matière_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;matières.id&#39;</span><span class="p">)),</span>
<a id="__codelineno-22-82" name="__codelineno-22-82"></a>              <span class="p">)</span>
<a id="__codelineno-22-83" name="__codelineno-22-83"></a>
<a id="__codelineno-22-84" name="__codelineno-22-84"></a>    <span class="c1"># mapping</span>
<a id="__codelineno-22-85" name="__codelineno-22-85"></a>    <span class="n">mapper</span><span class="p">(</span><span class="n">Note</span><span class="p">,</span> <span class="n">tables</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">],</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-22-86" name="__codelineno-22-86"></a>        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">notes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-22-87" name="__codelineno-22-87"></a>        <span class="s1">&#39;valeur&#39;</span><span class="p">:</span> <span class="n">notes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">valeur</span><span class="p">,</span>
<a id="__codelineno-22-88" name="__codelineno-22-88"></a>        <span class="s1">&#39;élève&#39;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Elève</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;notes&quot;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s2">&quot;select&quot;</span><span class="p">),</span>
<a id="__codelineno-22-89" name="__codelineno-22-89"></a>        <span class="s1">&#39;matière&#39;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Matière</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;notes&quot;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s2">&quot;select&quot;</span><span class="p">)</span>
<a id="__codelineno-22-90" name="__codelineno-22-90"></a>    <span class="p">})</span>
<a id="__codelineno-22-91" name="__codelineno-22-91"></a>
<a id="__codelineno-22-92" name="__codelineno-22-92"></a>    <span class="c1"># configuration des entités [BaseEntity]</span>
<a id="__codelineno-22-93" name="__codelineno-22-93"></a>    <span class="n">Elève</span><span class="o">.</span><span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_sa_instance_state&#39;</span><span class="p">,</span> <span class="s1">&#39;notes&#39;</span><span class="p">,</span> <span class="s1">&#39;classe&#39;</span><span class="p">]</span>
<a id="__codelineno-22-94" name="__codelineno-22-94"></a>    <span class="n">Classe</span><span class="o">.</span><span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_sa_instance_state&#39;</span><span class="p">,</span> <span class="s1">&#39;élèves&#39;</span><span class="p">]</span>
<a id="__codelineno-22-95" name="__codelineno-22-95"></a>    <span class="n">Matière</span><span class="o">.</span><span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_sa_instance_state&#39;</span><span class="p">,</span> <span class="s1">&#39;notes&#39;</span><span class="p">]</span>
<a id="__codelineno-22-96" name="__codelineno-22-96"></a>    <span class="n">Note</span><span class="o">.</span><span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_sa_instance_state&#39;</span><span class="p">,</span> <span class="s1">&#39;matière&#39;</span><span class="p">,</span> <span class="s1">&#39;élève&#39;</span><span class="p">]</span>
<a id="__codelineno-22-97" name="__codelineno-22-97"></a>
<a id="__codelineno-22-98" name="__codelineno-22-98"></a>    <span class="c1"># la session factory</span>
<a id="__codelineno-22-99" name="__codelineno-22-99"></a>    <span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()</span>
<a id="__codelineno-22-100" name="__codelineno-22-100"></a>    <span class="n">Session</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<a id="__codelineno-22-101" name="__codelineno-22-101"></a>
<a id="__codelineno-22-102" name="__codelineno-22-102"></a>    <span class="c1"># une session</span>
<a id="__codelineno-22-103" name="__codelineno-22-103"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
<a id="__codelineno-22-104" name="__codelineno-22-104"></a>
<a id="__codelineno-22-105" name="__codelineno-22-105"></a>    <span class="c1"># on enregistre certaines informations dans le dictionnaire de la configuration</span>
<a id="__codelineno-22-106" name="__codelineno-22-106"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;engine&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">,</span> <span class="s2">&quot;tables&quot;</span><span class="p">:</span> <span class="n">tables</span><span class="p">,</span> <span class="s2">&quot;session&quot;</span><span class="p">:</span> <span class="n">session</span><span class="p">}</span>
<a id="__codelineno-22-107" name="__codelineno-22-107"></a>
<a id="__codelineno-22-108" name="__codelineno-22-108"></a>    <span class="c1"># on rend la config</span>
<a id="__codelineno-22-109" name="__codelineno-22-109"></a>    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
<p><strong>Commentaires</strong></p>
<ul>
<li>lignes 1-4 : la fonction <strong>[configure]</strong> reçoit un dictionnaire en paramètre. Seule la clé <strong>[sgbd]</strong> est exploitée. Elle vaut <strong>[mysql]</strong> si la base est une base MySQL, <strong>[pgres]</strong> si la base est une base PostgreSQL ;</li>
<li>lignes 6-9 : imports d’éléments de <strong>[sqlalchemy]</strong>. Le script <strong>[config_database]</strong> fait les mappings entre les tables de la base <strong>[dbecole]</strong> et les entités <strong>[Classes, Elève, Matière, Note]</strong>. Dans la table, les données de l’entité sont encapsulées dans une ligne. Dans le code Python, elles sont encapsulées dans un objet. D’où le nom ORM (Object Relational Mapper) : l’ORM fait un mapping (une liaison) entre les lignes d’une base de données relationnelle et des objets. Dans cette application, nous avons quatre entités <strong>[Classe, Elève, Matière, Note]</strong> qui seront reliées à quatre tables <strong>[classes, élèves, matières, notes]</strong>. Notez que les noms des tables peuvent comporter des caractères accentués ;</li>
<li>lignes 11-17 : la chaîne de connexion à la base de données exploitée. Celle-ci dépend de l’élément config<strong>[‘sgbd’]</strong> ;</li>
<li>lignes 24-28 : les entités de l’application qui vont faire l’objet d’un mapping <strong>[sqlalchemy]</strong>. Lorsque ces lignes seront exécutées, le Python Path aura déjà été établi par le script <strong>[config]</strong> ;</li>
<li>lignes 30-40 : le mapping entre l’entité <strong>[Classe]</strong> et la table <strong>[classes]</strong> ;</li>
<li>lignes 30-35 : la table <strong>[classes]</strong> est définie avec la classe <strong>[Table]</strong> de <strong>[sqlalchemy]</strong>. Nous indiquons que cette table a deux colonnes :</li>
<li>la colonne <strong>[id]</strong> qui est clé primaire et qui est le n° de la classe, ligne 33 ;</li>
<li>la colonne <strong>[nom]</strong> qui contient le nom de la classe, ligne 34 ;</li>
<li>lignes 31-32 : notez que la syntaxe x=y=z est légale en Python : la valeur de z est affectée à y puis la valeur de y à x ;</li>
<li>lignes 37-40 : on liste les correspondances entre les colonnes de la table <strong>[classes]</strong> et les propriétés de l’entité <strong>[Classe]</strong> ;</li>
<li>lignes 42-57 : le mapping entre l’entité <strong>[Elève]</strong> et la table <strong>[élèves]</strong> ;</li>
<li>lignes 51-57 : la table <strong>[élèves]</strong> est définie avec la classe <strong>[Table]</strong> de <strong>[sqlalchemy]</strong>. Nous indiquons que cette table a quatre colonnes :</li>
<li>la colonne <strong>[id]</strong> qui est clé primaire et qui est le n° de l’élève, ligne 45 ;</li>
<li>la colonne <strong>[nom]</strong> qui contient le nom de l’élève, ligne 46 ;</li>
<li>la colonne <strong>[prénom]</strong> qui contient le prénom de l’élève, ligne 47. Notez qu’un nom de colonne peut comporter des caractères accentués ;</li>
<li>ligne 49, la colonne <strong>[classe_id]</strong> qui contiendra le n° de la classe à laquelle appartient l’élève. On appelle cela une clé étrangère. <strong>[élèves.classe_id]</strong> est une clé étrangère (ForeignKey) sur la colonne <strong>[classes.id]</strong>. Cela signifie que la valeur de <strong>[élèves.classe_id]</strong> doit exister dans la colonne <strong>[classes.id]</strong> ;</li>
<li>lignes 51-57 : on liste les correspondances entre les colonnes de la table <strong>[élèves]</strong> et les propriétés de l’entité <strong>[Elève]</strong> :</li>
<li>les lignes 53-55 sont simples à comprendre ;</li>
<li>la ligne 56 est plus difficile : elle définit la valeur de la propriété <strong>[Elève.classe]</strong> comme étant calculée par la relation (relationship) de clé étrangère qui relie les tables <strong>[élèves]</strong> et <strong>[classes]</strong>. Les paramètres de la fonction <strong>[relationship]</strong> sont les suivants :</li>
<li><strong>[Classe]</strong> : c’est le nom de l’entité avec laquelle l’entité <strong>[Elève]</strong> a une relation de clé étrangère. Celle-ci doit se matérialiser dans la table <strong>[élèves]</strong> par la présence d’une clé étrangère sur la table <strong>[classes]</strong>. Nous savons que celle-ci existe ;</li>
<li><strong>[backref=</strong><strong>&quot;</strong><strong>élèves</strong><strong>&quot;</strong><strong>]</strong> : le nom d’une propriété qui sera <strong>ajoutée</strong> à l’entité <strong>[Classe]</strong>. <strong>[Classe.</strong><strong>élèves</strong><strong>]</strong> sera la liste de tous les élèves de la classe. <strong>Cette propriété ne doit pas déjà exister</strong>. Si elle existe déjà, il faut simplement choisir un autre nom ici pour <strong>[backref]</strong>. Le développeur n’a pas à gérer cette propriété. C’est <strong>[sqlalchemy]</strong> qui le fera. Il doit simplement savoir qu’elle existe, ajoutée par <strong>[sqlalchemy]</strong>, et qu’il peut l’utiliser dans son code ;</li>
<li><strong>[lazy=’select’]</strong> : cela signifie que l’ORM ne doit pas chercher à donner immédiatement une valeur à la propriété <strong>[Elève.classe]</strong>. Il ne doit chercher sa valeur que lorsque le code la demande explicitement. Ainsi :</li>
<li>si le code demande la liste de tous les élèves, ceux-ci seront ramenés mais leur propriété <strong>[classe]</strong> ne sera pas calculée ;</li>
<li>un peu plus tard, le code s’intéresse à un élève <strong>[e]</strong> précis et référence sa classe <strong>[e.classe]</strong>. Cette référence va alors forcer <strong>[sqlalchemy]</strong> à faire une requête en base pour ramener la classe de l’élève, ceci de façon transparente pour le développeur ;</li>
<li>aussi mettre <strong>[lazy=’select’]</strong> vise à éviter les requêtes inutiles en base ;</li>
<li>ligne 56 : lorsque l’ORM récupère une ligne de la table <strong>[élèves]</strong>, il récupère les informations <strong>[id, nom, prénom, classe_id]</strong>. A partir de là, il doit construire un objet Elève(id, nom, prénom, classe). Pour les propriétés <strong>[id, nom, </strong><strong>prénom]</strong> ça ne pose pas de difficultés. Pour la propriété <strong>[classe]</strong>, c’est plus compliqué. Sa valeur est une référence d’objet de type <strong>[Classe]</strong>. Or l’ORM ne dispose que d’une information <strong>[élèves.classe_id]</strong>. Comme <strong>[élèves.classe_id]</strong> est une clé étrangère sur la colonne <strong>[classes.id]</strong>, on lui dit ici d’utiliser cette relation pour récupérer dans la table <strong>[classes]</strong> la ligne de n° id=<strong>[élèves.classe_id]</strong> (elle existe forcément) et de créer à partir de cette ligne l’objet <strong>[Classe]</strong> attendu par la propriété <strong>[Elève.classe]</strong> ;</li>
<li>lignes 59-71 : le mapping entre l’entité <strong>[Matière]</strong> et la table <strong>[matières]</strong> ;</li>
<li>lignes 59-65 : définition de la table <strong>[sqlalchemy]</strong> nommée <strong>[matières]</strong> ;</li>
<li>lignes 66-71 : on liste les correspondances entre les colonnes de la table <strong>[matières]</strong> et les propriétés de l’entité <strong>[Matière]</strong>. Il n’y a pas de difficultés ici ;</li>
<li>lignes 73-90 : le mapping entre l’entité <strong>[Note]</strong> et la table <strong>[notes]</strong> ;</li>
<li>lignes 73-82 : définition de la table <strong>[sqlalchemy]</strong> nommée <strong>[notes]</strong>. Elle a deux clés étrangères :</li>
<li>ligne 79, la colonne <strong>[notes.élève_id]</strong> prend ses valeurs dans la colonne <strong>[élèves.id]</strong> ]. Cette clé étrangère matérialise le fait qu’une note est la note d’un élève précis ;</li>
<li>ligne 81, la colonne <strong>[notes.matière_id]</strong> prend ses valeurs dans la colonne <strong>[matières.id]</strong>. Cette clé étrangère matérialise le fait qu’une note est une note dans une matière précise ;</li>
<li>lignes 84-90 : le mapping entre l’entité <strong>[Note]</strong> et la table <strong>[notes]</strong> :</li>
<li>ligne 88 : la propriété <strong>[Note.élève]</strong> doit avoir pour valeur une instance de type <strong>[Elève]</strong>. L’ORM n’a pour information dans la ligne de la table <strong>[notes]</strong> que la colonne <strong>[notes.élève_id]</strong> qui référence la colonne <strong>[élèves.id]</strong>. On dit ici d’utiliser cette relation de clé étrangère pour retrouver l’intance <strong>[Elève]</strong> dont on a la note. Par ailleurs <strong>[relationship(Elève, backref=</strong><strong>&quot;notes&quot;</strong><strong>, …)]</strong> va créer la nouvelle propriété <strong>[Elève.notes]</strong> qui sera la liste des notes de l’élève. Cette propriété ne doit pas déjà exister dans la classe <strong>[Elève]</strong> ;</li>
<li>ligne 89 : la propriété <strong>[Note.matière]</strong> doit avoir pour valeur une instance de type <strong>[Matière]</strong>. L’ORM n’a pour information dans la ligne de la table <strong>[notes]</strong> que la colonne <strong>[notes.matière_id]</strong> qui référence la colonne <strong>[matières.id]</strong>. On dit ici d’utiliser cette relation de clé étrangère pour retrouver l’intance <strong>[Matière]</strong> dont on a la note. Par ailleurs <strong>[relationship(Matière, backref=</strong><strong>&quot;notes&quot;</strong><strong>, …)]</strong> va créer la nouvelle propriété <strong>[Matière.notes]</strong> qui sera la liste des notes dans la matière. Cette propriété ne doit pas déjà exister dans la classe <strong>[Matière]</strong> ;</li>
<li>lignes 92-96 : on définit pour chaque entité dérivée de <strong>[BaseEntity]</strong> la liste des propriétés à exclure du dictionnaire des propriétés de l’entité (BaseEntity.asdict). Nous avons vu que <strong>[sqlalchemy]</strong> ajoutait la propriété <strong>[</strong><strong>_sa_instance_state</strong><strong>]</strong> à toutes entités mappées. On ne la veut pas dans le dictionnaire des propriétés. Par ailleurs on a vu que les mappings précédents avaient ajouté de nouvelles propriétés aux entités :</li>
<li><strong>[Elève.notes]</strong> : toutes les notes de l’élève ;</li>
<li><strong>[Classe.élèves]</strong> : tous les élèves de la classe ;</li>
<li>
<p><strong>[Matière.notes]</strong> : toutes les notes de la matière ;
En général, on ve veut pas ces propriétés ajoutées dans l’état de l’entité. En effet, calculer leur valeur a un coût SQL et cette valeur est souvent inutile. Ainsi si on récupère l’élève de nom ‘X’ :</p>
</li>
<li>
<p>l’ORM va ramener une entité <strong>[Elève(id, nom, prénom, classe, notes)]</strong>. A cause de <strong>[lazy=’select’]</strong>, les propriétés <strong>[classe, notes]</strong> liées à des clés étrangères de la base n’auront pas été calculées ;</p>
</li>
<li>maintenant si j’affiche la chaîne jSON de cet élève, on sait que ce sera la chaîne jSON du dictionnaire <strong>[asdict]</strong> de l’entité. Si les propriétés <strong>[classe]</strong> et <strong>[notes]</strong> sont dedans, <strong>[sqlalchemy]</strong> va être obligé de faire des requêtes SQL pour calculer leurs valeurs. C’est coûteux. Si on peut éviter ces requêtes, c’est préférable ;</li>
<li>ici, nous avons exclu toutes les propriétés liées à une clé étrangère ;</li>
<li>lignes 98-100 : instanciation et configuration d’une <strong>[Session factory]</strong> (factory=usine de production). L’objet <strong>[Session]</strong> sert à créer des sessions <strong>[sqlalchemy]</strong> adossées à des transactions ;</li>
<li>lignes 102-103 : création d’une session sqlalchemy] ;</li>
<li>ligne 106 : certains éléments de la configuration <strong>[sqlalchemy]</strong> sont mis dans le dictionnaire global de la configuration de l’application ;</li>
<li>ligne 109 : on rend ce dictionnaire ;
Le fichier <strong>[config_layers]</strong> configure les couches de l’application :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span>
<span class="normal"><a href="#__codelineno-23-15">15</a></span>
<span class="normal"><a href="#__codelineno-23-16">16</a></span>
<span class="normal"><a href="#__codelineno-23-17">17</a></span>
<span class="normal"><a href="#__codelineno-23-18">18</a></span>
<span class="normal"><a href="#__codelineno-23-19">19</a></span>
<span class="normal"><a href="#__codelineno-23-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a>    <span class="c1"># instanciation couche [dao]</span>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">DatabaseDao</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatabaseDao</span>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a>    <span class="n">dao</span> <span class="o">=</span> <span class="n">DatabaseDao</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a>    <span class="c1"># instanciation de la couche [métier]</span>
<a id="__codelineno-23-7" name="__codelineno-23-7"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Métier</span><span class="w"> </span><span class="kn">import</span> <span class="n">Métier</span>
<a id="__codelineno-23-8" name="__codelineno-23-8"></a>    <span class="n">métier</span> <span class="o">=</span> <span class="n">Métier</span><span class="p">(</span><span class="n">dao</span><span class="p">)</span>
<a id="__codelineno-23-9" name="__codelineno-23-9"></a>
<a id="__codelineno-23-10" name="__codelineno-23-10"></a>    <span class="c1"># instanciation de la couche [ui]</span>
<a id="__codelineno-23-11" name="__codelineno-23-11"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Console</span><span class="w"> </span><span class="kn">import</span> <span class="n">Console</span>
<a id="__codelineno-23-12" name="__codelineno-23-12"></a>    <span class="n">ui</span> <span class="o">=</span> <span class="n">Console</span><span class="p">(</span><span class="n">métier</span><span class="p">)</span>
<a id="__codelineno-23-13" name="__codelineno-23-13"></a>
<a id="__codelineno-23-14" name="__codelineno-23-14"></a>    <span class="c1"># on met les couches dans la config</span>
<a id="__codelineno-23-15" name="__codelineno-23-15"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dao&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dao</span>
<a id="__codelineno-23-16" name="__codelineno-23-16"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;métier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">métier</span>
<a id="__codelineno-23-17" name="__codelineno-23-17"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ui&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ui</span>
<a id="__codelineno-23-18" name="__codelineno-23-18"></a>
<a id="__codelineno-23-19" name="__codelineno-23-19"></a>    <span class="c1"># on rend la config</span>
<a id="__codelineno-23-20" name="__codelineno-23-20"></a>    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 1 : la fonction <strong>[configure]</strong> reçoit le dictionnaire de la configuration globale de l’application ;</li>
<li>lignes 2-12 : les couches de l’application sont instanciées ;</li>
<li>lignes 15-17 : les références des couches sont mises dans la configuration globale ;</li>
<li>ligne 20 : on rend la nouvelle configuration ;</li>
</ul>
<h3 id="1965-la-couche-dao-1">19.6.5. La couche [dao] - 1</h3>
<p><img src="images/1000000000000472000002BF608ECFE1.png" style="width:13.151cm;height:8.111cm;" alt="Image" /></p>
<p>Il faut comprendre ici que la couche <strong>[dao]</strong> <strong>[3]</strong> communique avec l’ORM <strong>[sqlalchemy]</strong> <strong>[4]</strong> configuré comme il a été décrit dans le paragraphe précédent. Des trois couches <strong>[ui, métier, dao]</strong> de l’application |<a href="#_Exemple_1"><u><u>troiscouches v01</u></u></a>|, seule la couche <strong>[dao]</strong> doit être réécrite. Les couches <strong>[ui, métier]</strong> sont conservées.</p>
<p>L’implémentation de la couche <strong>[dao]</strong> a été placée dans le dossier <strong>[services]</strong> :</p>
<p><img src="images/10000000000001ED000000D5BBC1F406.png" style="width:5.261cm;height:2.271cm;" alt="Image" /></p>
<p><strong>[InterfaceDatabaseDao]</strong> est l’interface de la couche <strong>[dao]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceDao</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceDao</span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a>
<a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">InterfaceDatabaseDao</span><span class="p">(</span><span class="n">InterfaceDao</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-24-7" name="__codelineno-24-7"></a>
<a id="__codelineno-24-8" name="__codelineno-24-8"></a>    <span class="c1"># initialisation de la base de données</span>
<a id="__codelineno-24-9" name="__codelineno-24-9"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-24-10" name="__codelineno-24-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-24-11" name="__codelineno-24-11"></a>        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 6 : l’interface <strong>[</strong><strong>InterfaceDatabaseDao</strong><strong>]</strong> dérive à la fois de la classe <strong>[ABC]</strong> pour être une classe abstraite et de l’interface <strong>[InterfaceDao]</strong> du projet |<a href="#_Interface_[InterfaceDao]"><u><u>troiscouches v01</u></u></a>| ;</li>
<li>lignes 8-11 : on ajoute la méthode <strong>[init_database]</strong> aux méthodes héritées de <strong>[InterfaceDao]</strong>. Elle aura pour rôle d’initialiser la base de données avec les données du dictionnaire <strong>[data]</strong> qu’on lui passe en paramètre ligne 10 ;
Rappelons que l’interface <strong>[InterfaceDao]</strong> était la suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span>
<span class="normal"><a href="#__codelineno-25-11">11</a></span>
<span class="normal"><a href="#__codelineno-25-12">12</a></span>
<span class="normal"><a href="#__codelineno-25-13">13</a></span>
<span class="normal"><a href="#__codelineno-25-14">14</a></span>
<span class="normal"><a href="#__codelineno-25-15">15</a></span>
<span class="normal"><a href="#__codelineno-25-16">16</a></span>
<span class="normal"><a href="#__codelineno-25-17">17</a></span>
<span class="normal"><a href="#__codelineno-25-18">18</a></span>
<span class="normal"><a href="#__codelineno-25-19">19</a></span>
<span class="normal"><a href="#__codelineno-25-20">20</a></span>
<span class="normal"><a href="#__codelineno-25-21">21</a></span>
<span class="normal"><a href="#__codelineno-25-22">22</a></span>
<span class="normal"><a href="#__codelineno-25-23">23</a></span>
<span class="normal"><a href="#__codelineno-25-24">24</a></span>
<span class="normal"><a href="#__codelineno-25-25">25</a></span>
<span class="normal"><a href="#__codelineno-25-26">26</a></span>
<span class="normal"><a href="#__codelineno-25-27">27</a></span>
<span class="normal"><a href="#__codelineno-25-28">28</a></span>
<span class="normal"><a href="#__codelineno-25-29">29</a></span>
<span class="normal"><a href="#__codelineno-25-30">30</a></span>
<span class="normal"><a href="#__codelineno-25-31">31</a></span>
<span class="normal"><a href="#__codelineno-25-32">32</a></span>
<span class="normal"><a href="#__codelineno-25-33">33</a></span>
<span class="normal"><a href="#__codelineno-25-34">34</a></span>
<span class="normal"><a href="#__codelineno-25-35">35</a></span>
<span class="normal"><a href="#__codelineno-25-36">36</a></span>
<span class="normal"><a href="#__codelineno-25-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="c1"># imports</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="c1"># interface Dao</span>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Elève</span><span class="w"> </span><span class="kn">import</span> <span class="n">Elève</span>
<a id="__codelineno-25-6" name="__codelineno-25-6"></a>
<a id="__codelineno-25-7" name="__codelineno-25-7"></a>
<a id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">InterfaceDao</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-25-9" name="__codelineno-25-9"></a>    <span class="c1"># liste des classes</span>
<a id="__codelineno-25-10" name="__codelineno-25-10"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-25-11" name="__codelineno-25-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-25-12" name="__codelineno-25-12"></a>        <span class="k">pass</span>
<a id="__codelineno-25-13" name="__codelineno-25-13"></a>
<a id="__codelineno-25-14" name="__codelineno-25-14"></a>    <span class="c1"># liste des élèves</span>
<a id="__codelineno-25-15" name="__codelineno-25-15"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-25-16" name="__codelineno-25-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_élèves</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-25-17" name="__codelineno-25-17"></a>        <span class="k">pass</span>
<a id="__codelineno-25-18" name="__codelineno-25-18"></a>
<a id="__codelineno-25-19" name="__codelineno-25-19"></a>    <span class="c1"># liste des matières</span>
<a id="__codelineno-25-20" name="__codelineno-25-20"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-25-21" name="__codelineno-25-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_matières</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-25-22" name="__codelineno-25-22"></a>        <span class="k">pass</span>
<a id="__codelineno-25-23" name="__codelineno-25-23"></a>
<a id="__codelineno-25-24" name="__codelineno-25-24"></a>    <span class="c1"># liste des notes</span>
<a id="__codelineno-25-25" name="__codelineno-25-25"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-25-26" name="__codelineno-25-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_notes</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-25-27" name="__codelineno-25-27"></a>        <span class="k">pass</span>
<a id="__codelineno-25-28" name="__codelineno-25-28"></a>
<a id="__codelineno-25-29" name="__codelineno-25-29"></a>    <span class="c1"># liste des notes d&#39;un élève</span>
<a id="__codelineno-25-30" name="__codelineno-25-30"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-25-31" name="__codelineno-25-31"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_notes_for_élève_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">élève_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-25-32" name="__codelineno-25-32"></a>        <span class="k">pass</span>
<a id="__codelineno-25-33" name="__codelineno-25-33"></a>
<a id="__codelineno-25-34" name="__codelineno-25-34"></a>    <span class="c1"># chercher un élève par son id</span>
<a id="__codelineno-25-35" name="__codelineno-25-35"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-25-36" name="__codelineno-25-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_élève_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">élève_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Elève</span><span class="p">:</span>
<a id="__codelineno-25-37" name="__codelineno-25-37"></a>        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
<p>L’implémentation de la couche <strong>[dao]</strong> est la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-26-10">10</a></span>
<span class="normal"><a href="#__codelineno-26-11">11</a></span>
<span class="normal"><a href="#__codelineno-26-12">12</a></span>
<span class="normal"><a href="#__codelineno-26-13">13</a></span>
<span class="normal"><a href="#__codelineno-26-14">14</a></span>
<span class="normal"><a href="#__codelineno-26-15">15</a></span>
<span class="normal"><a href="#__codelineno-26-16">16</a></span>
<span class="normal"><a href="#__codelineno-26-17">17</a></span>
<span class="normal"><a href="#__codelineno-26-18">18</a></span>
<span class="normal"><a href="#__codelineno-26-19">19</a></span>
<span class="normal"><a href="#__codelineno-26-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.exc</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">IntegrityError</span><span class="p">,</span> <span class="n">InterfaceError</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Classe</span><span class="w"> </span><span class="kn">import</span> <span class="n">Classe</span>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Elève</span><span class="w"> </span><span class="kn">import</span> <span class="n">Elève</span>
<a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceDatabaseDao</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceDatabaseDao</span>
<a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Matière</span><span class="w"> </span><span class="kn">import</span> <span class="n">Matière</span>
<a id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">MyException</span><span class="w"> </span><span class="kn">import</span> <span class="n">MyException</span>
<a id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Note</span><span class="w"> </span><span class="kn">import</span> <span class="n">Note</span>
<a id="__codelineno-26-9" name="__codelineno-26-9"></a>
<a id="__codelineno-26-10" name="__codelineno-26-10"></a>
<a id="__codelineno-26-11" name="__codelineno-26-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">DatabaseDao</span><span class="p">(</span><span class="n">InterfaceDatabaseDao</span><span class="p">):</span>
<a id="__codelineno-26-12" name="__codelineno-26-12"></a>
<a id="__codelineno-26-13" name="__codelineno-26-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-26-14" name="__codelineno-26-14"></a>        <span class="c1"># database = {&quot;engine&quot;: engine, &quot;metadata&quot;: metadata, &quot;tables&quot;: tables, &quot;session&quot;: session}</span>
<a id="__codelineno-26-15" name="__codelineno-26-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span>
<a id="__codelineno-26-16" name="__codelineno-26-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span>
<a id="__codelineno-26-17" name="__codelineno-26-17"></a>
<a id="__codelineno-26-18" name="__codelineno-26-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-26-19" name="__codelineno-26-19"></a>        <span class="err">…</span>
<a id="__codelineno-26-20" name="__codelineno-26-20"></a><span class="err">…</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 11 : la classe <strong>[</strong><strong>DatabaseDao</strong><strong>]</strong> implémente l’interface <strong>[</strong><strong>InterfaceDatabaseDao</strong><strong>]</strong> ;</li>
<li>lignes 13-16 : le constructeur de la classe. Il reçoit en paramètre, le dictionnaire de la configuration de l’application ;</li>
<li>ligne 15 : on mémorise la configuration <strong>[sqlalchemy]</strong> ;</li>
<li>ligne 16 : on mémorise la session <strong>[sqlalchemy]</strong> au travers de laquelle on va manipuler la base de données ;</li>
<li>ligne 18 : la méthode <strong>[init_database]</strong> initialise la base de données avec le dictionnaire <strong>[data]</strong> ;
Le dictionnaire <strong>[data]</strong> est implémenté par le script <strong>[data.py]</strong> suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span>
<span class="normal"><a href="#__codelineno-27-18">18</a></span>
<span class="normal"><a href="#__codelineno-27-19">19</a></span>
<span class="normal"><a href="#__codelineno-27-20">20</a></span>
<span class="normal"><a href="#__codelineno-27-21">21</a></span>
<span class="normal"><a href="#__codelineno-27-22">22</a></span>
<span class="normal"><a href="#__codelineno-27-23">23</a></span>
<span class="normal"><a href="#__codelineno-27-24">24</a></span>
<span class="normal"><a href="#__codelineno-27-25">25</a></span>
<span class="normal"><a href="#__codelineno-27-26">26</a></span>
<span class="normal"><a href="#__codelineno-27-27">27</a></span>
<span class="normal"><a href="#__codelineno-27-28">28</a></span>
<span class="normal"><a href="#__codelineno-27-29">29</a></span>
<span class="normal"><a href="#__codelineno-27-30">30</a></span>
<span class="normal"><a href="#__codelineno-27-31">31</a></span>
<span class="normal"><a href="#__codelineno-27-32">32</a></span>
<span class="normal"><a href="#__codelineno-27-33">33</a></span>
<span class="normal"><a href="#__codelineno-27-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">():</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Classe</span><span class="w"> </span><span class="kn">import</span> <span class="n">Classe</span>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Elève</span><span class="w"> </span><span class="kn">import</span> <span class="n">Elève</span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Matière</span><span class="w"> </span><span class="kn">import</span> <span class="n">Matière</span>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Note</span><span class="w"> </span><span class="kn">import</span> <span class="n">Note</span>
<a id="__codelineno-27-6" name="__codelineno-27-6"></a>
<a id="__codelineno-27-7" name="__codelineno-27-7"></a>    <span class="c1"># on instancie les classes</span>
<a id="__codelineno-27-8" name="__codelineno-27-8"></a>    <span class="n">classe1</span> <span class="o">=</span> <span class="n">Classe</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;classe1&quot;</span><span class="p">})</span>
<a id="__codelineno-27-9" name="__codelineno-27-9"></a>    <span class="n">classe2</span> <span class="o">=</span> <span class="n">Classe</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;classe2&quot;</span><span class="p">})</span>
<a id="__codelineno-27-10" name="__codelineno-27-10"></a>    <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">classe1</span><span class="p">,</span> <span class="n">classe2</span><span class="p">]</span>
<a id="__codelineno-27-11" name="__codelineno-27-11"></a>    <span class="c1"># les matières</span>
<a id="__codelineno-27-12" name="__codelineno-27-12"></a>    <span class="n">matière1</span> <span class="o">=</span> <span class="n">Matière</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;matière1&quot;</span><span class="p">,</span> <span class="s2">&quot;coefficient&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<a id="__codelineno-27-13" name="__codelineno-27-13"></a>    <span class="n">matière2</span> <span class="o">=</span> <span class="n">Matière</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;matière2&quot;</span><span class="p">,</span> <span class="s2">&quot;coefficient&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<a id="__codelineno-27-14" name="__codelineno-27-14"></a>    <span class="n">matières</span> <span class="o">=</span> <span class="p">[</span><span class="n">matière1</span><span class="p">,</span> <span class="n">matière2</span><span class="p">]</span>
<a id="__codelineno-27-15" name="__codelineno-27-15"></a>    <span class="c1"># les élèves</span>
<a id="__codelineno-27-16" name="__codelineno-27-16"></a>    <span class="n">élève11</span> <span class="o">=</span> <span class="n">Elève</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;nom1&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;prénom1&quot;</span><span class="p">,</span> <span class="s2">&quot;classe&quot;</span><span class="p">:</span> <span class="n">classe1</span><span class="p">})</span>
<a id="__codelineno-27-17" name="__codelineno-27-17"></a>    <span class="n">élève21</span> <span class="o">=</span> <span class="n">Elève</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;nom2&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;prénom2&quot;</span><span class="p">,</span> <span class="s2">&quot;classe&quot;</span><span class="p">:</span> <span class="n">classe1</span><span class="p">})</span>
<a id="__codelineno-27-18" name="__codelineno-27-18"></a>    <span class="n">élève32</span> <span class="o">=</span> <span class="n">Elève</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;nom3&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;prénom3&quot;</span><span class="p">,</span> <span class="s2">&quot;classe&quot;</span><span class="p">:</span> <span class="n">classe2</span><span class="p">})</span>
<a id="__codelineno-27-19" name="__codelineno-27-19"></a>    <span class="n">élève42</span> <span class="o">=</span> <span class="n">Elève</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;nom4&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;prénom4&quot;</span><span class="p">,</span> <span class="s2">&quot;classe&quot;</span><span class="p">:</span> <span class="n">classe2</span><span class="p">})</span>
<a id="__codelineno-27-20" name="__codelineno-27-20"></a>    <span class="n">élèves</span> <span class="o">=</span> <span class="p">[</span><span class="n">élève11</span><span class="p">,</span> <span class="n">élève21</span><span class="p">,</span> <span class="n">élève32</span><span class="p">,</span> <span class="n">élève42</span><span class="p">]</span>
<a id="__codelineno-27-21" name="__codelineno-27-21"></a>    <span class="c1"># les notes des élèves dans les différentes matières</span>
<a id="__codelineno-27-22" name="__codelineno-27-22"></a>    <span class="n">note1</span> <span class="o">=</span> <span class="n">Note</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;élève&quot;</span><span class="p">:</span> <span class="n">élève11</span><span class="p">,</span> <span class="s2">&quot;matière&quot;</span><span class="p">:</span> <span class="n">matière1</span><span class="p">})</span>
<a id="__codelineno-27-23" name="__codelineno-27-23"></a>    <span class="n">note2</span> <span class="o">=</span> <span class="n">Note</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;élève&quot;</span><span class="p">:</span> <span class="n">élève21</span><span class="p">,</span> <span class="s2">&quot;matière&quot;</span><span class="p">:</span> <span class="n">matière1</span><span class="p">})</span>
<a id="__codelineno-27-24" name="__codelineno-27-24"></a>    <span class="n">note3</span> <span class="o">=</span> <span class="n">Note</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;élève&quot;</span><span class="p">:</span> <span class="n">élève32</span><span class="p">,</span> <span class="s2">&quot;matière&quot;</span><span class="p">:</span> <span class="n">matière1</span><span class="p">})</span>
<a id="__codelineno-27-25" name="__codelineno-27-25"></a>    <span class="n">note4</span> <span class="o">=</span> <span class="n">Note</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;élève&quot;</span><span class="p">:</span> <span class="n">élève42</span><span class="p">,</span> <span class="s2">&quot;matière&quot;</span><span class="p">:</span> <span class="n">matière1</span><span class="p">})</span>
<a id="__codelineno-27-26" name="__codelineno-27-26"></a>    <span class="n">note5</span> <span class="o">=</span> <span class="n">Note</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;élève&quot;</span><span class="p">:</span> <span class="n">élève11</span><span class="p">,</span> <span class="s2">&quot;matière&quot;</span><span class="p">:</span> <span class="n">matière2</span><span class="p">})</span>
<a id="__codelineno-27-27" name="__codelineno-27-27"></a>    <span class="n">note6</span> <span class="o">=</span> <span class="n">Note</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;élève&quot;</span><span class="p">:</span> <span class="n">élève21</span><span class="p">,</span> <span class="s2">&quot;matière&quot;</span><span class="p">:</span> <span class="n">matière2</span><span class="p">})</span>
<a id="__codelineno-27-28" name="__codelineno-27-28"></a>    <span class="n">note7</span> <span class="o">=</span> <span class="n">Note</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;élève&quot;</span><span class="p">:</span> <span class="n">élève32</span><span class="p">,</span> <span class="s2">&quot;matière&quot;</span><span class="p">:</span> <span class="n">matière2</span><span class="p">})</span>
<a id="__codelineno-27-29" name="__codelineno-27-29"></a>    <span class="n">note8</span> <span class="o">=</span> <span class="n">Note</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;élève&quot;</span><span class="p">:</span> <span class="n">élève42</span><span class="p">,</span> <span class="s2">&quot;matière&quot;</span><span class="p">:</span> <span class="n">matière2</span><span class="p">})</span>
<a id="__codelineno-27-30" name="__codelineno-27-30"></a>    <span class="n">notes</span> <span class="o">=</span> <span class="p">[</span><span class="n">note1</span><span class="p">,</span> <span class="n">note2</span><span class="p">,</span> <span class="n">note3</span><span class="p">,</span> <span class="n">note4</span><span class="p">,</span> <span class="n">note5</span><span class="p">,</span> <span class="n">note6</span><span class="p">,</span> <span class="n">note7</span><span class="p">,</span> <span class="n">note8</span><span class="p">]</span>
<a id="__codelineno-27-31" name="__codelineno-27-31"></a>    <span class="c1"># on regroupe l&#39;ensemble</span>
<a id="__codelineno-27-32" name="__codelineno-27-32"></a>    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;élèves&quot;</span><span class="p">:</span> <span class="n">élèves</span><span class="p">,</span> <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="n">classes</span><span class="p">,</span> <span class="s2">&quot;matières&quot;</span><span class="p">:</span> <span class="n">matières</span><span class="p">,</span> <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="n">notes</span><span class="p">}</span>
<a id="__codelineno-27-33" name="__codelineno-27-33"></a>    <span class="c1"># on rend les données</span>
<a id="__codelineno-27-34" name="__codelineno-27-34"></a>    <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 34 : le dictionnaire qui sera passé à la méthode <strong>[init_database]</strong>. Ce dictionnaire est composé des clés suivantes (ligne 32) :</li>
<li><strong>[élèves]</strong> : la liste des élèves ;</li>
<li><strong>[classes]</strong> : la liste des classes ;</li>
<li><strong>[matières]</strong> : la liste des matières ;</li>
<li><strong>[notes]</strong> : la liste des notes de tous les élèves dans toutes les matières ;
Revenons à la méthode <strong>[init_database]</strong> :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span>
<span class="normal"><a href="#__codelineno-28-11">11</a></span>
<span class="normal"><a href="#__codelineno-28-12">12</a></span>
<span class="normal"><a href="#__codelineno-28-13">13</a></span>
<span class="normal"><a href="#__codelineno-28-14">14</a></span>
<span class="normal"><a href="#__codelineno-28-15">15</a></span>
<span class="normal"><a href="#__codelineno-28-16">16</a></span>
<span class="normal"><a href="#__codelineno-28-17">17</a></span>
<span class="normal"><a href="#__codelineno-28-18">18</a></span>
<span class="normal"><a href="#__codelineno-28-19">19</a></span>
<span class="normal"><a href="#__codelineno-28-20">20</a></span>
<span class="normal"><a href="#__codelineno-28-21">21</a></span>
<span class="normal"><a href="#__codelineno-28-22">22</a></span>
<span class="normal"><a href="#__codelineno-28-23">23</a></span>
<span class="normal"><a href="#__codelineno-28-24">24</a></span>
<span class="normal"><a href="#__codelineno-28-25">25</a></span>
<span class="normal"><a href="#__codelineno-28-26">26</a></span>
<span class="normal"><a href="#__codelineno-28-27">27</a></span>
<span class="normal"><a href="#__codelineno-28-28">28</a></span>
<span class="normal"><a href="#__codelineno-28-29">29</a></span>
<span class="normal"><a href="#__codelineno-28-30">30</a></span>
<span class="normal"><a href="#__codelineno-28-31">31</a></span>
<span class="normal"><a href="#__codelineno-28-32">32</a></span>
<span class="normal"><a href="#__codelineno-28-33">33</a></span>
<span class="normal"><a href="#__codelineno-28-34">34</a></span>
<span class="normal"><a href="#__codelineno-28-35">35</a></span>
<span class="normal"><a href="#__codelineno-28-36">36</a></span>
<span class="normal"><a href="#__codelineno-28-37">37</a></span>
<span class="normal"><a href="#__codelineno-28-38">38</a></span>
<span class="normal"><a href="#__codelineno-28-39">39</a></span>
<span class="normal"><a href="#__codelineno-28-40">40</a></span>
<span class="normal"><a href="#__codelineno-28-41">41</a></span>
<span class="normal"><a href="#__codelineno-28-42">42</a></span>
<span class="normal"><a href="#__codelineno-28-43">43</a></span>
<span class="normal"><a href="#__codelineno-28-44">44</a></span>
<span class="normal"><a href="#__codelineno-28-45">45</a></span>
<span class="normal"><a href="#__codelineno-28-46">46</a></span>
<span class="normal"><a href="#__codelineno-28-47">47</a></span>
<span class="normal"><a href="#__codelineno-28-48">48</a></span>
<span class="normal"><a href="#__codelineno-28-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">init_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-28-2" name="__codelineno-28-2"></a>        <span class="c1"># config de la bd</span>
<a id="__codelineno-28-3" name="__codelineno-28-3"></a>        <span class="n">database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span>
<a id="__codelineno-28-4" name="__codelineno-28-4"></a>        <span class="n">engine</span> <span class="o">=</span> <span class="n">database</span><span class="p">[</span><span class="s1">&#39;engine&#39;</span><span class="p">]</span>
<a id="__codelineno-28-5" name="__codelineno-28-5"></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="n">database</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span>
<a id="__codelineno-28-6" name="__codelineno-28-6"></a>        <span class="n">tables</span> <span class="o">=</span> <span class="n">database</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">]</span>
<a id="__codelineno-28-7" name="__codelineno-28-7"></a>
<a id="__codelineno-28-8" name="__codelineno-28-8"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-28-9" name="__codelineno-28-9"></a>            <span class="c1"># suppression des tables existantes</span>
<a id="__codelineno-28-10" name="__codelineno-28-10"></a>            <span class="c1"># checkfirst=True : vérifie d&#39;abord que la table existe</span>
<a id="__codelineno-28-11" name="__codelineno-28-11"></a>            <span class="n">tables</span><span class="p">[</span><span class="s2">&quot;notes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-28-12" name="__codelineno-28-12"></a>            <span class="n">tables</span><span class="p">[</span><span class="s2">&quot;matières&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-28-13" name="__codelineno-28-13"></a>            <span class="n">tables</span><span class="p">[</span><span class="s2">&quot;élèves&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-28-14" name="__codelineno-28-14"></a>            <span class="n">tables</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-28-15" name="__codelineno-28-15"></a>
<a id="__codelineno-28-16" name="__codelineno-28-16"></a>            <span class="c1"># recréation des tables à partir du mapping</span>
<a id="__codelineno-28-17" name="__codelineno-28-17"></a>            <span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<a id="__codelineno-28-18" name="__codelineno-28-18"></a>
<a id="__codelineno-28-19" name="__codelineno-28-19"></a>            <span class="c1"># remplissage des tables</span>
<a id="__codelineno-28-20" name="__codelineno-28-20"></a>            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
<a id="__codelineno-28-21" name="__codelineno-28-21"></a>
<a id="__codelineno-28-22" name="__codelineno-28-22"></a>            <span class="c1"># classes</span>
<a id="__codelineno-28-23" name="__codelineno-28-23"></a>            <span class="n">classes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span>
<a id="__codelineno-28-24" name="__codelineno-28-24"></a>            <span class="k">for</span> <span class="n">classe</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
<a id="__codelineno-28-25" name="__codelineno-28-25"></a>                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">classe</span><span class="p">)</span>
<a id="__codelineno-28-26" name="__codelineno-28-26"></a>
<a id="__codelineno-28-27" name="__codelineno-28-27"></a>            <span class="c1"># matières</span>
<a id="__codelineno-28-28" name="__codelineno-28-28"></a>            <span class="n">matières</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;matières&quot;</span><span class="p">]</span>
<a id="__codelineno-28-29" name="__codelineno-28-29"></a>            <span class="k">for</span> <span class="n">matière</span> <span class="ow">in</span> <span class="n">matières</span><span class="p">:</span>
<a id="__codelineno-28-30" name="__codelineno-28-30"></a>                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">matière</span><span class="p">)</span>
<a id="__codelineno-28-31" name="__codelineno-28-31"></a>
<a id="__codelineno-28-32" name="__codelineno-28-32"></a>            <span class="c1"># élèves</span>
<a id="__codelineno-28-33" name="__codelineno-28-33"></a>            <span class="n">élèves</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;élèves&quot;</span><span class="p">]</span>
<a id="__codelineno-28-34" name="__codelineno-28-34"></a>            <span class="k">for</span> <span class="n">élève</span> <span class="ow">in</span> <span class="n">élèves</span><span class="p">:</span>
<a id="__codelineno-28-35" name="__codelineno-28-35"></a>                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">élève</span><span class="p">)</span>
<a id="__codelineno-28-36" name="__codelineno-28-36"></a>
<a id="__codelineno-28-37" name="__codelineno-28-37"></a>            <span class="c1"># notes</span>
<a id="__codelineno-28-38" name="__codelineno-28-38"></a>            <span class="n">notes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;notes&quot;</span><span class="p">]</span>
<a id="__codelineno-28-39" name="__codelineno-28-39"></a>            <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">notes</span><span class="p">:</span>
<a id="__codelineno-28-40" name="__codelineno-28-40"></a>                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">note</span><span class="p">)</span>
<a id="__codelineno-28-41" name="__codelineno-28-41"></a>
<a id="__codelineno-28-42" name="__codelineno-28-42"></a>            <span class="c1"># commit</span>
<a id="__codelineno-28-43" name="__codelineno-28-43"></a>            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-28-44" name="__codelineno-28-44"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">DatabaseError</span><span class="p">,</span> <span class="n">InterfaceError</span><span class="p">,</span> <span class="n">IntegrityError</span><span class="p">)</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-28-45" name="__codelineno-28-45"></a>            <span class="c1"># annulation de la session</span>
<a id="__codelineno-28-46" name="__codelineno-28-46"></a>            <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-28-47" name="__codelineno-28-47"></a>                <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-28-48" name="__codelineno-28-48"></a>            <span class="c1"># on remonte l&#39;exception</span>
<a id="__codelineno-28-49" name="__codelineno-28-49"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 3-6 : on récupère des informations dans la configuration de la base de données ;</li>
<li>lignes 9-14 : nous avons vu que la configuration <strong>[sqlalchemy]</strong> avait mappé quatre entités sur quatre tables <strong>[élèves, matières, classes, notes]</strong>. On commence par supprimer ces tables si elles existent ;</li>
<li>lignes 16-17 : on recrée les quatre tables qu’on vient de supprimer ;</li>
<li>lignes 22-25 : on met toutes les classes dans la session ;</li>
<li>lignes 27-30 : on met toutes les matières dans la session ;</li>
<li>lignes 32-35 : on met tous les élèves dans la session ;</li>
<li>lignes 37-40 : on met toutes les notes dans la session ;</li>
<li>pour faire ces ajouts, on a suivi un ordre. On a commencé par les entités n’ayant pas de relations avec d’autres entités pour terminer par celles qui en avaient. Ainsi lorsqu’on ajoute les élèves dans la session, les classes que ceux-ci référencent sont déjà en session ;</li>
<li>ligne 43 : la session <strong>[sqlalchemy]</strong> est validée. Après cette opération, on est sûrs que toutes les données en session ont été synchronisées avec la base de données. En clair, elles sont arrivées dans les tables. Ceci a pu se faire grâce aux mappings qui ont été faits dans la configuration de <strong>[sqlalchemy]</strong>. <strong>[sqlalchemy]</strong> sait comment chaque entité doit être stockée dans les tables. <strong>[sqlalchemy]</strong> a également généré les clés étrangères que peuvent posséder les tables ;</li>
<li>lignes 44-49 : si on rencontre un problème, la session <strong>[sqlalchemy]</strong> est annulée et ligne 49, une exception est levée ; </li>
</ul>
<h3 id="1966-initialisation-de-la-base-de-donnees">19.6.6. Initialisation de la base de données</h3>
<p><img src="images/10000000000001C200000247D61944EA.png" style="width:4.672cm;height:6.061cm;" alt="Image" /></p>
<p>Le script <strong>[main_init_database]</strong> initialise la base de données avec le contenu du script <strong>[data.py]</strong>. Son code est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-29-10">10</a></span>
<span class="normal"><a href="#__codelineno-29-11">11</a></span>
<span class="normal"><a href="#__codelineno-29-12">12</a></span>
<span class="normal"><a href="#__codelineno-29-13">13</a></span>
<span class="normal"><a href="#__codelineno-29-14">14</a></span>
<span class="normal"><a href="#__codelineno-29-15">15</a></span>
<span class="normal"><a href="#__codelineno-29-16">16</a></span>
<span class="normal"><a href="#__codelineno-29-17">17</a></span>
<span class="normal"><a href="#__codelineno-29-18">18</a></span>
<span class="normal"><a href="#__codelineno-29-19">19</a></span>
<span class="normal"><a href="#__codelineno-29-20">20</a></span>
<span class="normal"><a href="#__codelineno-29-21">21</a></span>
<span class="normal"><a href="#__codelineno-29-22">22</a></span>
<span class="normal"><a href="#__codelineno-29-23">23</a></span>
<span class="normal"><a href="#__codelineno-29-24">24</a></span>
<span class="normal"><a href="#__codelineno-29-25">25</a></span>
<span class="normal"><a href="#__codelineno-29-26">26</a></span>
<span class="normal"><a href="#__codelineno-29-27">27</a></span>
<span class="normal"><a href="#__codelineno-29-28">28</a></span>
<span class="normal"><a href="#__codelineno-29-29">29</a></span>
<span class="normal"><a href="#__codelineno-29-30">30</a></span>
<span class="normal"><a href="#__codelineno-29-31">31</a></span>
<span class="normal"><a href="#__codelineno-29-32">32</a></span>
<span class="normal"><a href="#__codelineno-29-33">33</a></span>
<span class="normal"><a href="#__codelineno-29-34">34</a></span>
<span class="normal"><a href="#__codelineno-29-35">35</a></span>
<span class="normal"><a href="#__codelineno-29-36">36</a></span>
<span class="normal"><a href="#__codelineno-29-37">37</a></span>
<span class="normal"><a href="#__codelineno-29-38">38</a></span>
<span class="normal"><a href="#__codelineno-29-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="c1"># on attend un paramètre mysql ou pgres</span>
<a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="n">syntaxe</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> mysql / pgres&quot;</span>
<a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="n">erreur</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
<a id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-29-7" name="__codelineno-29-7"></a>    <span class="n">sgbd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-29-8" name="__codelineno-29-8"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;mysql&quot;</span> <span class="ow">and</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;pgres&quot;</span>
<a id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-29-10" name="__codelineno-29-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syntaxe : </span><span class="si">{</span><span class="n">syntaxe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-29-11" name="__codelineno-29-11"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<a id="__codelineno-29-12" name="__codelineno-29-12"></a>
<a id="__codelineno-29-13" name="__codelineno-29-13"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-29-14" name="__codelineno-29-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-29-15" name="__codelineno-29-15"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s1">&#39;sgbd&#39;</span><span class="p">:</span> <span class="n">sgbd</span><span class="p">})</span>
<a id="__codelineno-29-16" name="__codelineno-29-16"></a>
<a id="__codelineno-29-17" name="__codelineno-29-17"></a><span class="c1"># le syspath est configuré - on peut faire les imports</span>
<a id="__codelineno-29-18" name="__codelineno-29-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">MyException</span><span class="w"> </span><span class="kn">import</span> <span class="n">MyException</span>
<a id="__codelineno-29-19" name="__codelineno-29-19"></a>
<a id="__codelineno-29-20" name="__codelineno-29-20"></a><span class="c1"># on récupère les données à mettre en base</span>
<a id="__codelineno-29-21" name="__codelineno-29-21"></a><span class="kn">import</span><span class="w"> </span><span class="nn">data</span>
<a id="__codelineno-29-22" name="__codelineno-29-22"></a><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
<a id="__codelineno-29-23" name="__codelineno-29-23"></a>
<a id="__codelineno-29-24" name="__codelineno-29-24"></a><span class="c1"># on récupère la couche [dao]</span>
<a id="__codelineno-29-25" name="__codelineno-29-25"></a><span class="n">dao</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span>
<a id="__codelineno-29-26" name="__codelineno-29-26"></a>
<a id="__codelineno-29-27" name="__codelineno-29-27"></a><span class="c1"># ----------- main</span>
<a id="__codelineno-29-28" name="__codelineno-29-28"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-29-29" name="__codelineno-29-29"></a>    <span class="c1"># création et initialisation des tables de la bd</span>
<a id="__codelineno-29-30" name="__codelineno-29-30"></a>    <span class="n">dao</span><span class="o">.</span><span class="n">init_database</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-29-31" name="__codelineno-29-31"></a><span class="k">except</span> <span class="n">MyException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
<a id="__codelineno-29-32" name="__codelineno-29-32"></a>    <span class="c1"># on affiche l&#39;erreur</span>
<a id="__codelineno-29-33" name="__codelineno-29-33"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-29-34" name="__codelineno-29-34"></a><span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-29-35" name="__codelineno-29-35"></a>    <span class="c1"># libération des ressources mobilisées par l&#39;application</span>
<a id="__codelineno-29-36" name="__codelineno-29-36"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">shutdown</span>
<a id="__codelineno-29-37" name="__codelineno-29-37"></a>    <span class="n">shutdown</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-29-38" name="__codelineno-29-38"></a><span class="c1"># fin</span>
<a id="__codelineno-29-39" name="__codelineno-29-39"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Travail terminé...&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 1-11 : le script attend un paramètre <strong>[mysql]</strong> ou <strong>[pgres]</strong> selon qu’on veut initialiser une base MySQL ou PostgreSQL ;</li>
<li>lignes 13-15 : l’application est configurée pour le SGBD passé en paramètre ;</li>
<li>lignes 20-22 : on récupère les données à mettre en base ;</li>
<li>ligne 25 : la couche <strong>[dao]</strong> a déjà été instanciée et est accessible dans la configuration de l’application ;</li>
<li>ligne 30 : la base de données est initialisée ;</li>
<li>lignes 34-37 : erreur ou pas, on libère les ressources de l’application à l’aide du module <strong>[shutdown]</strong> ;
Le module <strong>[shutdown.py]</strong> est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1">1</a></span>
<span class="normal"><a href="#__codelineno-30-2">2</a></span>
<span class="normal"><a href="#__codelineno-30-3">3</a></span>
<span class="normal"><a href="#__codelineno-30-4">4</a></span>
<span class="normal"><a href="#__codelineno-30-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-30-2" name="__codelineno-30-2"></a>    <span class="c1"># on libère les ressources mobilisées par l&#39;application</span>
<a id="__codelineno-30-3" name="__codelineno-30-3"></a>    <span class="n">sqlalchemy_session</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">][</span><span class="s1">&#39;session&#39;</span><span class="p">]</span>
<a id="__codelineno-30-4" name="__codelineno-30-4"></a>    <span class="k">if</span> <span class="n">sqlalchemy_session</span><span class="p">:</span>
<a id="__codelineno-30-5" name="__codelineno-30-5"></a>        <span class="n">sqlalchemy_session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>La fonction <strong>[shutdown.execute]</strong> ferme la session <strong>[sqlalchemy]</strong> utilisée pour initialiser la base de données.</p>
<p>Nous créons une 1ère configuration d’exécution (cf. |<a href="#configuration_execution"><u><u>configuration d’exécution</u></u></a>|) pour exécuter <strong>[main_init_database]</strong> avec le SGBD MySQL :</p>
<p><img src="images/10000000000005150000029F2F31BFB5.png" style="width:15.001cm;height:7.73cm;" alt="Image" /></p>
<p>Les résultats de l’exécution de cette configuration sont les suivants dans phpMyAdmin :</p>
<p><img src="images/10000000000000E600000103F0FD84C6.png" style="width:2.661cm;height:2.991cm;" alt="Image" /></p>
<p><img src="images/1000000000000558000001E2FA0311CB.png" style="width:15.781cm;height:5.571cm;" alt="Image" /></p>
<p><img src="images/10000000000005540000028806783A84.png" style="width:15.761cm;height:7.481cm;" alt="Image" /></p>
<p>Pour le SGBD <strong>[PostgreSQL]</strong>, nous utilisons la configuration d’exécution suivante :</p>
<p><img src="images/10000000000005160000027FDC5AF745.png" style="width:15.02cm;height:7.37cm;" alt="Image" /></p>
<p>A l’exécution, les résultats dans <strong>[pgAdmin]</strong> sont les suivants :</p>
<p><img src="images/10000000000001EC000003E7CC385C46.png" style="width:5.68cm;height:11.531cm;" alt="Image" /></p>
<p><img src="images/1000000000000558000002081B1AD338.png" style="width:15.77cm;height:6.01cm;" alt="Image" /></p>
<p><img src="images/100000000000055700000262D912589F.png" style="width:15.781cm;height:7.032cm;" alt="Image" /></p>
<p>On notera la facilité avec laquelle on a pu changer de SGBD.</p>
<h3 id="1967-la-couche-dao-2">19.6.7. La couche [dao] – 2</h3>
<p>Nous revenons sur la classe <strong>[</strong><strong>DatabaseDao</strong><strong>]</strong> qui implémente la couche <strong>[dao]</strong>. Nous n’avons montré pour l’instant que l’implémentation de la méthode <strong>[init_database]</strong>. Nous montrons maintenant l’implémentation des autres méthodes :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1">  1</a></span>
<span class="normal"><a href="#__codelineno-31-2">  2</a></span>
<span class="normal"><a href="#__codelineno-31-3">  3</a></span>
<span class="normal"><a href="#__codelineno-31-4">  4</a></span>
<span class="normal"><a href="#__codelineno-31-5">  5</a></span>
<span class="normal"><a href="#__codelineno-31-6">  6</a></span>
<span class="normal"><a href="#__codelineno-31-7">  7</a></span>
<span class="normal"><a href="#__codelineno-31-8">  8</a></span>
<span class="normal"><a href="#__codelineno-31-9">  9</a></span>
<span class="normal"><a href="#__codelineno-31-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-31-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-31-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-31-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-31-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-31-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-31-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-31-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-31-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-31-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-31-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-31-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-31-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-31-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-31-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-31-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-31-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-31-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-31-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-31-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-31-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-31-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-31-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-31-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-31-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-31-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-31-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-31-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-31-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-31-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-31-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-31-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-31-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-31-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-31-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-31-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-31-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-31-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-31-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-31-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-31-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-31-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-31-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-31-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-31-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-31-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-31-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-31-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-31-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-31-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-31-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-31-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-31-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-31-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-31-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-31-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-31-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-31-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-31-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-31-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-31-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-31-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-31-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-31-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-31-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-31-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-31-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-31-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-31-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-31-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-31-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-31-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-31-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-31-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-31-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-31-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-31-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-31-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-31-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-31-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-31-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-31-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-31-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-31-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-31-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-31-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-31-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-31-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-31-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-31-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-31-100">100</a></span>
<span class="normal"><a href="#__codelineno-31-101">101</a></span>
<span class="normal"><a href="#__codelineno-31-102">102</a></span>
<span class="normal"><a href="#__codelineno-31-103">103</a></span>
<span class="normal"><a href="#__codelineno-31-104">104</a></span>
<span class="normal"><a href="#__codelineno-31-105">105</a></span>
<span class="normal"><a href="#__codelineno-31-106">106</a></span>
<span class="normal"><a href="#__codelineno-31-107">107</a></span>
<span class="normal"><a href="#__codelineno-31-108">108</a></span>
<span class="normal"><a href="#__codelineno-31-109">109</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.exc</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">IntegrityError</span><span class="p">,</span> <span class="n">InterfaceError</span>
<a id="__codelineno-31-2" name="__codelineno-31-2"></a>
<a id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Classe</span><span class="w"> </span><span class="kn">import</span> <span class="n">Classe</span>
<a id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Elève</span><span class="w"> </span><span class="kn">import</span> <span class="n">Elève</span>
<a id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceDatabaseDao</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceDatabaseDao</span>
<a id="__codelineno-31-6" name="__codelineno-31-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Matière</span><span class="w"> </span><span class="kn">import</span> <span class="n">Matière</span>
<a id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">MyException</span><span class="w"> </span><span class="kn">import</span> <span class="n">MyException</span>
<a id="__codelineno-31-8" name="__codelineno-31-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Note</span><span class="w"> </span><span class="kn">import</span> <span class="n">Note</span>
<a id="__codelineno-31-9" name="__codelineno-31-9"></a>
<a id="__codelineno-31-10" name="__codelineno-31-10"></a>
<a id="__codelineno-31-11" name="__codelineno-31-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">DatabaseDao</span><span class="p">(</span><span class="n">InterfaceDatabaseDao</span><span class="p">):</span>
<a id="__codelineno-31-12" name="__codelineno-31-12"></a>
<a id="__codelineno-31-13" name="__codelineno-31-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-31-14" name="__codelineno-31-14"></a>        <span class="c1"># database = {&quot;engine&quot;: engine, &quot;metadata&quot;: metadata, &quot;tables&quot;: tables, &quot;session&quot;: session}</span>
<a id="__codelineno-31-15" name="__codelineno-31-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span>
<a id="__codelineno-31-16" name="__codelineno-31-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span>
<a id="__codelineno-31-17" name="__codelineno-31-17"></a>
<a id="__codelineno-31-18" name="__codelineno-31-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-31-19" name="__codelineno-31-19"></a>        <span class="err">…</span>
<a id="__codelineno-31-20" name="__codelineno-31-20"></a>
<a id="__codelineno-31-21" name="__codelineno-31-21"></a>    <span class="c1"># liste de toutes les classes</span>
<a id="__codelineno-31-22" name="__codelineno-31-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-31-23" name="__codelineno-31-23"></a>        <span class="c1"># requête</span>
<a id="__codelineno-31-24" name="__codelineno-31-24"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Classe</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-31-25" name="__codelineno-31-25"></a>
<a id="__codelineno-31-26" name="__codelineno-31-26"></a>    <span class="c1"># liste de tous les élèves</span>
<a id="__codelineno-31-27" name="__codelineno-31-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_élèves</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-31-28" name="__codelineno-31-28"></a>        <span class="c1"># requête</span>
<a id="__codelineno-31-29" name="__codelineno-31-29"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Elève</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-31-30" name="__codelineno-31-30"></a>
<a id="__codelineno-31-31" name="__codelineno-31-31"></a>    <span class="c1"># liste de toutes les matières</span>
<a id="__codelineno-31-32" name="__codelineno-31-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_matières</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-31-33" name="__codelineno-31-33"></a>        <span class="c1"># requête</span>
<a id="__codelineno-31-34" name="__codelineno-31-34"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Matière</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-31-35" name="__codelineno-31-35"></a>
<a id="__codelineno-31-36" name="__codelineno-31-36"></a>    <span class="c1"># la liste des notes de tous les élèves</span>
<a id="__codelineno-31-37" name="__codelineno-31-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_notes</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-31-38" name="__codelineno-31-38"></a>        <span class="c1"># requête</span>
<a id="__codelineno-31-39" name="__codelineno-31-39"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Note</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-31-40" name="__codelineno-31-40"></a>
<a id="__codelineno-31-41" name="__codelineno-31-41"></a>    <span class="c1"># la liste des notes d&#39;un élève particulier</span>
<a id="__codelineno-31-42" name="__codelineno-31-42"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_notes_for_élève_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">élève_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-31-43" name="__codelineno-31-43"></a>        <span class="c1"># on cherche l&#39;élève - une exception est lancée s&#39;il n&#39;existe pas</span>
<a id="__codelineno-31-44" name="__codelineno-31-44"></a>        <span class="c1"># on la laisse remonter</span>
<a id="__codelineno-31-45" name="__codelineno-31-45"></a>        <span class="n">élève</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_élève_by_id</span><span class="p">(</span><span class="n">élève_id</span><span class="p">)</span>
<a id="__codelineno-31-46" name="__codelineno-31-46"></a>        <span class="c1"># on récupère ses notes (lazy loading)</span>
<a id="__codelineno-31-47" name="__codelineno-31-47"></a>        <span class="n">notes</span> <span class="o">=</span> <span class="n">élève</span><span class="o">.</span><span class="n">notes</span>
<a id="__codelineno-31-48" name="__codelineno-31-48"></a>        <span class="c1"># on rend un dictionnaire</span>
<a id="__codelineno-31-49" name="__codelineno-31-49"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;élève&quot;</span><span class="p">:</span> <span class="n">élève</span><span class="p">,</span> <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="n">notes</span><span class="p">}</span>
<a id="__codelineno-31-50" name="__codelineno-31-50"></a>
<a id="__codelineno-31-51" name="__codelineno-31-51"></a>    <span class="c1"># un élève repéré par son n°</span>
<a id="__codelineno-31-52" name="__codelineno-31-52"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_élève_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">élève_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Elève</span><span class="p">:</span>
<a id="__codelineno-31-53" name="__codelineno-31-53"></a>        <span class="c1"># on cherche l&#39;élève</span>
<a id="__codelineno-31-54" name="__codelineno-31-54"></a>        <span class="n">élèves</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Elève</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Elève</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">élève_id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-31-55" name="__codelineno-31-55"></a>        <span class="c1"># a-t-on trouvé ?</span>
<a id="__codelineno-31-56" name="__codelineno-31-56"></a>        <span class="k">if</span> <span class="n">élèves</span><span class="p">:</span>
<a id="__codelineno-31-57" name="__codelineno-31-57"></a>            <span class="k">return</span> <span class="n">élèves</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-31-58" name="__codelineno-31-58"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-31-59" name="__codelineno-31-59"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;L&#39;élève d&#39;identifiant </span><span class="si">{</span><span class="n">élève_id</span><span class="si">}</span><span class="s2"> n&#39;existe pas&quot;</span><span class="p">)</span>
<a id="__codelineno-31-60" name="__codelineno-31-60"></a>
<a id="__codelineno-31-61" name="__codelineno-31-61"></a>    <span class="c1"># un élève repéré par son nom</span>
<a id="__codelineno-31-62" name="__codelineno-31-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_élève_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">élève_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Elève</span><span class="p">:</span>
<a id="__codelineno-31-63" name="__codelineno-31-63"></a>        <span class="c1"># on cherche l&#39;élève</span>
<a id="__codelineno-31-64" name="__codelineno-31-64"></a>        <span class="n">élèves</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Elève</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Elève</span><span class="o">.</span><span class="n">nom</span> <span class="o">==</span> <span class="n">élève_name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-31-65" name="__codelineno-31-65"></a>        <span class="c1"># a-t-on trouvé ?</span>
<a id="__codelineno-31-66" name="__codelineno-31-66"></a>        <span class="k">if</span> <span class="n">élèves</span><span class="p">:</span>
<a id="__codelineno-31-67" name="__codelineno-31-67"></a>            <span class="k">return</span> <span class="n">élèves</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-31-68" name="__codelineno-31-68"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-31-69" name="__codelineno-31-69"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;L&#39;élève de nom </span><span class="si">{</span><span class="n">élève_name</span><span class="si">}</span><span class="s2"> n&#39;existe pas&quot;</span><span class="p">)</span>
<a id="__codelineno-31-70" name="__codelineno-31-70"></a>
<a id="__codelineno-31-71" name="__codelineno-31-71"></a>    <span class="c1"># une classe repérée par son n°</span>
<a id="__codelineno-31-72" name="__codelineno-31-72"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_classe_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classe_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Classe</span><span class="p">:</span>
<a id="__codelineno-31-73" name="__codelineno-31-73"></a>        <span class="c1"># on cherche la classe</span>
<a id="__codelineno-31-74" name="__codelineno-31-74"></a>        <span class="n">classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Classe</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Classe</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">classe_id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-31-75" name="__codelineno-31-75"></a>        <span class="c1"># a-t-on trouvé ?</span>
<a id="__codelineno-31-76" name="__codelineno-31-76"></a>        <span class="k">if</span> <span class="n">classes</span><span class="p">:</span>
<a id="__codelineno-31-77" name="__codelineno-31-77"></a>            <span class="k">return</span> <span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-31-78" name="__codelineno-31-78"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-31-79" name="__codelineno-31-79"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;La classe d&#39;identifiant </span><span class="si">{</span><span class="n">classe_id</span><span class="si">}</span><span class="s2"> n&#39;existe pas&quot;</span><span class="p">)</span>
<a id="__codelineno-31-80" name="__codelineno-31-80"></a>
<a id="__codelineno-31-81" name="__codelineno-31-81"></a>    <span class="c1"># une classe repérée par son nom</span>
<a id="__codelineno-31-82" name="__codelineno-31-82"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_classe_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classe_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Classe</span><span class="p">:</span>
<a id="__codelineno-31-83" name="__codelineno-31-83"></a>        <span class="c1"># on cherche l&#39;classe</span>
<a id="__codelineno-31-84" name="__codelineno-31-84"></a>        <span class="n">classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Classe</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Classe</span><span class="o">.</span><span class="n">nom</span> <span class="o">==</span> <span class="n">classe_name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-31-85" name="__codelineno-31-85"></a>        <span class="c1"># a-t-on trouvé ?</span>
<a id="__codelineno-31-86" name="__codelineno-31-86"></a>        <span class="k">if</span> <span class="n">classes</span><span class="p">:</span>
<a id="__codelineno-31-87" name="__codelineno-31-87"></a>            <span class="k">return</span> <span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-31-88" name="__codelineno-31-88"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-31-89" name="__codelineno-31-89"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;La classe de nom </span><span class="si">{</span><span class="n">classe_name</span><span class="si">}</span><span class="s2"> n&#39;existe pas&quot;</span><span class="p">)</span>
<a id="__codelineno-31-90" name="__codelineno-31-90"></a>
<a id="__codelineno-31-91" name="__codelineno-31-91"></a>    <span class="c1"># une matière repérée par son n°</span>
<a id="__codelineno-31-92" name="__codelineno-31-92"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_matière_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matière_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matière</span><span class="p">:</span>
<a id="__codelineno-31-93" name="__codelineno-31-93"></a>        <span class="c1"># on cherche l&#39;matière</span>
<a id="__codelineno-31-94" name="__codelineno-31-94"></a>        <span class="n">matières</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Matière</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Matière</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">matière_id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-31-95" name="__codelineno-31-95"></a>        <span class="c1"># a-t-on trouvé ?</span>
<a id="__codelineno-31-96" name="__codelineno-31-96"></a>        <span class="k">if</span> <span class="n">matières</span><span class="p">:</span>
<a id="__codelineno-31-97" name="__codelineno-31-97"></a>            <span class="k">return</span> <span class="n">matières</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-31-98" name="__codelineno-31-98"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-31-99" name="__codelineno-31-99"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;La matière d&#39;identifiant </span><span class="si">{</span><span class="n">matière_id</span><span class="si">}</span><span class="s2"> n&#39;existe pas&quot;</span><span class="p">)</span>
<a id="__codelineno-31-100" name="__codelineno-31-100"></a>
<a id="__codelineno-31-101" name="__codelineno-31-101"></a>    <span class="c1"># une matière repérée par son nom</span>
<a id="__codelineno-31-102" name="__codelineno-31-102"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_matière_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matière_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matière</span><span class="p">:</span>
<a id="__codelineno-31-103" name="__codelineno-31-103"></a>        <span class="c1"># on cherche la matière</span>
<a id="__codelineno-31-104" name="__codelineno-31-104"></a>        <span class="n">matières</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Matière</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Matière</span><span class="o">.</span><span class="n">nom</span> <span class="o">==</span> <span class="n">matière_name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-31-105" name="__codelineno-31-105"></a>        <span class="c1"># a-t-on trouvé ?</span>
<a id="__codelineno-31-106" name="__codelineno-31-106"></a>        <span class="k">if</span> <span class="n">matières</span><span class="p">:</span>
<a id="__codelineno-31-107" name="__codelineno-31-107"></a>            <span class="k">return</span> <span class="n">matières</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-31-108" name="__codelineno-31-108"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-31-109" name="__codelineno-31-109"></a>            <span class="k">raise</span> <span class="n">MyException</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;La matière de nom </span><span class="si">{</span><span class="n">matière_name</span><span class="si">}</span><span class="s2"> n&#39;existe pas&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 21-24 : la méthode <strong>[get_classes]</strong> doit rendre la liste des classes de l’école. Ligne 20, nous utilisons une requête déjà rencontrée ;</li>
<li>lignes 26-39 : trois autres méthodes similaires pour obtenir les listes des élèves, des matières et des notes ;</li>
<li>lignes 51-59 : la méthode <strong>[get_élève_by_id]</strong> doit rendre un élève identifié par son n°. Elle lance une exception si celui-ci n’existe pas ;</li>
<li>ligne 54 : on utilise une requêtre filtrée. On obtient une liste vide ou avec un élément ;</li>
<li>ligne 57 : si la liste récupérée n’est pas vide on rend le 1er élément de la liste ;</li>
<li>sinon ligne 59, on lance une exception ;</li>
<li>lignes 41-49 : la méthode <strong>[get_notes_for_élève_by_id]</strong> doit rendre les notes d’un élève identifié par son n° :</li>
<li>ligne 45, on utilise la méthode <strong>[get_élève_by_id]</strong> pour obtenir l’entité Elève de l’élève ;</li>
<li>ligne 47, on utilise la propriété <strong>[Elève.notes]</strong> créée par le mapping entre l’entité <strong>[Note]</strong> et la table <strong>[notes]</strong> (cf. paragraphe |<a href="#_Configuration"><u><u>configuration sqlalchemy</u></u></a>|) et qui représente les notes de l’élève ;</li>
<li>ligne 49 : on rend un dictionnaire ;</li>
<li>lignes 61-109 : une série de méthodes analogues permettant de :</li>
<li>retrouver un élève par son nom, lignes 61-69 ;</li>
<li>retrouver une classe, lignes 71-89 ;</li>
<li>retrouver une matière, lignes 91-109 ;</li>
</ul>
<h3 id="1968-le-script-main_joined_queries">19.6.8. Le script [main_joined_queries]</h3>
<p><img src="images/10000000000001B2000001A573DA45F8.png" style="width:4.511cm;height:4.37cm;" alt="Image" /></p>
<p>Le script <strong>[main_joined_queries]</strong> s’appelle ainsi parce qu’il vise à mettre en lumière les requêtes faites implicitement par <strong>[sqlalchemy]</strong> pour récupérer des informations appartenant à plusieurs tables. Ces requêtes cachées au programmeur sont faites à chaque fois qu’une propriété d’une entité a été associée à la fonction <strong>[relationship]</strong> dans le mapping de l’entité. Par exemple :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span>
<span class="normal"><a href="#__codelineno-32-2">2</a></span>
<span class="normal"><a href="#__codelineno-32-3">3</a></span>
<span class="normal"><a href="#__codelineno-32-4">4</a></span>
<span class="normal"><a href="#__codelineno-32-5">5</a></span>
<span class="normal"><a href="#__codelineno-32-6">6</a></span>
<span class="normal"><a href="#__codelineno-32-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a>    <span class="c1"># mapping</span>
<a id="__codelineno-32-2" name="__codelineno-32-2"></a>    <span class="n">mapper</span><span class="p">(</span><span class="n">Note</span><span class="p">,</span> <span class="n">tables</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">],</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-32-3" name="__codelineno-32-3"></a>        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">notes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-32-4" name="__codelineno-32-4"></a>        <span class="s1">&#39;valeur&#39;</span><span class="p">:</span> <span class="n">notes_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">valeur</span><span class="p">,</span>
<a id="__codelineno-32-5" name="__codelineno-32-5"></a>        <span class="s1">&#39;élève&#39;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Elève</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;notes&quot;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s2">&quot;select&quot;</span><span class="p">),</span>
<a id="__codelineno-32-6" name="__codelineno-32-6"></a>        <span class="s1">&#39;matière&#39;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Matière</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;notes&quot;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s2">&quot;select&quot;</span><span class="p">)</span>
<a id="__codelineno-32-7" name="__codelineno-32-7"></a>    <span class="p">})</span>
</code></pre></div></td></tr></table></div>
<p>Ci-dessus, le mapping entre l’entité <strong>[Note]</strong> et la table <strong>[notes]</strong> :</p>
<ul>
<li>ligne 5, lorsque la propriété <strong>[élève]</strong> d’une entité <strong>[Note]</strong> est demandée pour la 1ère fois, elle sera cherchée dans la table <strong>[élèves]</strong> via une requête SQL. Tant que cette propriété n’a pas été demandée, elle reste indéfinie (lazy load). Une fois qu’elle a été obtenue, sa valeur reste en mémoire de l’ORM. Lorsqu’elle sera référencée une deuxième fois, l’ORM délivrera immédiatement sa valeur sans passer par une nouvelle requête SQL. Tout cela est transparent pour le développeur ;</li>
<li>idem pour la propriété inverse <strong>[Elève.notes]</strong> (backref), ligne 5 ;</li>
<li>idem pour la propriété <strong>[Note.matière]</strong> et sa propriété inverse <strong>[Matière.notes]</strong> (backref), ligne 6 ;
Le script <strong>[main_joined_queries]</strong> est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span>
<span class="normal"><a href="#__codelineno-33-12">12</a></span>
<span class="normal"><a href="#__codelineno-33-13">13</a></span>
<span class="normal"><a href="#__codelineno-33-14">14</a></span>
<span class="normal"><a href="#__codelineno-33-15">15</a></span>
<span class="normal"><a href="#__codelineno-33-16">16</a></span>
<span class="normal"><a href="#__codelineno-33-17">17</a></span>
<span class="normal"><a href="#__codelineno-33-18">18</a></span>
<span class="normal"><a href="#__codelineno-33-19">19</a></span>
<span class="normal"><a href="#__codelineno-33-20">20</a></span>
<span class="normal"><a href="#__codelineno-33-21">21</a></span>
<span class="normal"><a href="#__codelineno-33-22">22</a></span>
<span class="normal"><a href="#__codelineno-33-23">23</a></span>
<span class="normal"><a href="#__codelineno-33-24">24</a></span>
<span class="normal"><a href="#__codelineno-33-25">25</a></span>
<span class="normal"><a href="#__codelineno-33-26">26</a></span>
<span class="normal"><a href="#__codelineno-33-27">27</a></span>
<span class="normal"><a href="#__codelineno-33-28">28</a></span>
<span class="normal"><a href="#__codelineno-33-29">29</a></span>
<span class="normal"><a href="#__codelineno-33-30">30</a></span>
<span class="normal"><a href="#__codelineno-33-31">31</a></span>
<span class="normal"><a href="#__codelineno-33-32">32</a></span>
<span class="normal"><a href="#__codelineno-33-33">33</a></span>
<span class="normal"><a href="#__codelineno-33-34">34</a></span>
<span class="normal"><a href="#__codelineno-33-35">35</a></span>
<span class="normal"><a href="#__codelineno-33-36">36</a></span>
<span class="normal"><a href="#__codelineno-33-37">37</a></span>
<span class="normal"><a href="#__codelineno-33-38">38</a></span>
<span class="normal"><a href="#__codelineno-33-39">39</a></span>
<span class="normal"><a href="#__codelineno-33-40">40</a></span>
<span class="normal"><a href="#__codelineno-33-41">41</a></span>
<span class="normal"><a href="#__codelineno-33-42">42</a></span>
<span class="normal"><a href="#__codelineno-33-43">43</a></span>
<span class="normal"><a href="#__codelineno-33-44">44</a></span>
<span class="normal"><a href="#__codelineno-33-45">45</a></span>
<span class="normal"><a href="#__codelineno-33-46">46</a></span>
<span class="normal"><a href="#__codelineno-33-47">47</a></span>
<span class="normal"><a href="#__codelineno-33-48">48</a></span>
<span class="normal"><a href="#__codelineno-33-49">49</a></span>
<span class="normal"><a href="#__codelineno-33-50">50</a></span>
<span class="normal"><a href="#__codelineno-33-51">51</a></span>
<span class="normal"><a href="#__codelineno-33-52">52</a></span>
<span class="normal"><a href="#__codelineno-33-53">53</a></span>
<span class="normal"><a href="#__codelineno-33-54">54</a></span>
<span class="normal"><a href="#__codelineno-33-55">55</a></span>
<span class="normal"><a href="#__codelineno-33-56">56</a></span>
<span class="normal"><a href="#__codelineno-33-57">57</a></span>
<span class="normal"><a href="#__codelineno-33-58">58</a></span>
<span class="normal"><a href="#__codelineno-33-59">59</a></span>
<span class="normal"><a href="#__codelineno-33-60">60</a></span>
<span class="normal"><a href="#__codelineno-33-61">61</a></span>
<span class="normal"><a href="#__codelineno-33-62">62</a></span>
<span class="normal"><a href="#__codelineno-33-63">63</a></span>
<span class="normal"><a href="#__codelineno-33-64">64</a></span>
<span class="normal"><a href="#__codelineno-33-65">65</a></span>
<span class="normal"><a href="#__codelineno-33-66">66</a></span>
<span class="normal"><a href="#__codelineno-33-67">67</a></span>
<span class="normal"><a href="#__codelineno-33-68">68</a></span>
<span class="normal"><a href="#__codelineno-33-69">69</a></span>
<span class="normal"><a href="#__codelineno-33-70">70</a></span>
<span class="normal"><a href="#__codelineno-33-71">71</a></span>
<span class="normal"><a href="#__codelineno-33-72">72</a></span>
<span class="normal"><a href="#__codelineno-33-73">73</a></span>
<span class="normal"><a href="#__codelineno-33-74">74</a></span>
<span class="normal"><a href="#__codelineno-33-75">75</a></span>
<span class="normal"><a href="#__codelineno-33-76">76</a></span>
<span class="normal"><a href="#__codelineno-33-77">77</a></span>
<span class="normal"><a href="#__codelineno-33-78">78</a></span>
<span class="normal"><a href="#__codelineno-33-79">79</a></span>
<span class="normal"><a href="#__codelineno-33-80">80</a></span>
<span class="normal"><a href="#__codelineno-33-81">81</a></span>
<span class="normal"><a href="#__codelineno-33-82">82</a></span>
<span class="normal"><a href="#__codelineno-33-83">83</a></span>
<span class="normal"><a href="#__codelineno-33-84">84</a></span>
<span class="normal"><a href="#__codelineno-33-85">85</a></span>
<span class="normal"><a href="#__codelineno-33-86">86</a></span>
<span class="normal"><a href="#__codelineno-33-87">87</a></span>
<span class="normal"><a href="#__codelineno-33-88">88</a></span>
<span class="normal"><a href="#__codelineno-33-89">89</a></span>
<span class="normal"><a href="#__codelineno-33-90">90</a></span>
<span class="normal"><a href="#__codelineno-33-91">91</a></span>
<span class="normal"><a href="#__codelineno-33-92">92</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="c1"># on attend un paramètre mysql ou pgres</span>
<a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-33-3" name="__codelineno-33-3"></a>
<a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="n">syntaxe</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> mysql / pgres&quot;</span>
<a id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="n">erreur</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
<a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-33-7" name="__codelineno-33-7"></a>    <span class="n">sgbd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-33-8" name="__codelineno-33-8"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;mysql&quot;</span> <span class="ow">and</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;pgres&quot;</span>
<a id="__codelineno-33-9" name="__codelineno-33-9"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-33-10" name="__codelineno-33-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syntaxe : </span><span class="si">{</span><span class="n">syntaxe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-33-11" name="__codelineno-33-11"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<a id="__codelineno-33-12" name="__codelineno-33-12"></a>
<a id="__codelineno-33-13" name="__codelineno-33-13"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-33-14" name="__codelineno-33-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-33-15" name="__codelineno-33-15"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s2">&quot;sgbd&quot;</span><span class="p">:</span> <span class="n">sgbd</span><span class="p">})</span>
<a id="__codelineno-33-16" name="__codelineno-33-16"></a>
<a id="__codelineno-33-17" name="__codelineno-33-17"></a><span class="c1"># le syspath est configuré - on peut faire els imports</span>
<a id="__codelineno-33-18" name="__codelineno-33-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">MyException</span><span class="w"> </span><span class="kn">import</span> <span class="n">MyException</span>
<a id="__codelineno-33-19" name="__codelineno-33-19"></a>
<a id="__codelineno-33-20" name="__codelineno-33-20"></a><span class="c1"># la couche [dao]</span>
<a id="__codelineno-33-21" name="__codelineno-33-21"></a><span class="n">dao</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span>
<a id="__codelineno-33-22" name="__codelineno-33-22"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-33-23" name="__codelineno-33-23"></a>    <span class="c1"># élève by id</span>
<a id="__codelineno-33-24" name="__codelineno-33-24"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;élève id=11 -----------&quot;</span><span class="p">)</span>
<a id="__codelineno-33-25" name="__codelineno-33-25"></a>    <span class="n">élève</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_élève_by_id</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<a id="__codelineno-33-26" name="__codelineno-33-26"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;élève=</span><span class="si">{</span><span class="n">élève</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-33-27" name="__codelineno-33-27"></a>    <span class="c1"># la classe de l&#39;élève (lazy loading)</span>
<a id="__codelineno-33-28" name="__codelineno-33-28"></a>    <span class="n">classe</span> <span class="o">=</span> <span class="n">élève</span><span class="o">.</span><span class="n">classe</span>
<a id="__codelineno-33-29" name="__codelineno-33-29"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;classe de l&#39;élève : </span><span class="si">{</span><span class="n">classe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-33-30" name="__codelineno-33-30"></a>    <span class="c1"># les élèves de la même classe (lazy loading)</span>
<a id="__codelineno-33-31" name="__codelineno-33-31"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;élèves dans la même classe :&quot;</span><span class="p">)</span>
<a id="__codelineno-33-32" name="__codelineno-33-32"></a>    <span class="k">for</span> <span class="n">élève</span> <span class="ow">in</span> <span class="n">classe</span><span class="o">.</span><span class="n">élèves</span><span class="p">:</span>
<a id="__codelineno-33-33" name="__codelineno-33-33"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;élève=</span><span class="si">{</span><span class="n">élève</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-33-34" name="__codelineno-33-34"></a>
<a id="__codelineno-33-35" name="__codelineno-33-35"></a>    <span class="c1"># un élève par son nom</span>
<a id="__codelineno-33-36" name="__codelineno-33-36"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;élève nom=&#39;nom2&#39; -----------&quot;</span><span class="p">)</span>
<a id="__codelineno-33-37" name="__codelineno-33-37"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;élève=</span><span class="si">{</span><span class="n">dao</span><span class="o">.</span><span class="n">get_élève_by_name</span><span class="p">(</span><span class="s1">&#39;nom2&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-33-38" name="__codelineno-33-38"></a>    <span class="c1"># sa classe (lazy loading)</span>
<a id="__codelineno-33-39" name="__codelineno-33-39"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;classe de l&#39;élève : </span><span class="si">{</span><span class="n">élève</span><span class="o">.</span><span class="n">classe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-33-40" name="__codelineno-33-40"></a>
<a id="__codelineno-33-41" name="__codelineno-33-41"></a>    <span class="c1"># notes d&#39;un élève</span>
<a id="__codelineno-33-42" name="__codelineno-33-42"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;notes de l&#39;élève id=11 -----------&quot;</span><span class="p">)</span>
<a id="__codelineno-33-43" name="__codelineno-33-43"></a>    <span class="c1"># d&#39;abord l&#39;élève</span>
<a id="__codelineno-33-44" name="__codelineno-33-44"></a>    <span class="n">élève</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_élève_by_id</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<a id="__codelineno-33-45" name="__codelineno-33-45"></a>    <span class="c1"># puis ses notes (lazy loading)</span>
<a id="__codelineno-33-46" name="__codelineno-33-46"></a>    <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">élève</span><span class="o">.</span><span class="n">notes</span><span class="p">:</span>
<a id="__codelineno-33-47" name="__codelineno-33-47"></a>        <span class="c1"># la note</span>
<a id="__codelineno-33-48" name="__codelineno-33-48"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;note=</span><span class="si">{</span><span class="n">note</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-33-49" name="__codelineno-33-49"></a>              <span class="c1"># la matière de la note (lazy loading)</span>
<a id="__codelineno-33-50" name="__codelineno-33-50"></a>              <span class="sa">f</span><span class="s2">&quot;matière=</span><span class="si">{</span><span class="n">note</span><span class="o">.</span><span class="n">matière</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-33-51" name="__codelineno-33-51"></a>
<a id="__codelineno-33-52" name="__codelineno-33-52"></a>    <span class="c1"># les élèves d&#39;une classe</span>
<a id="__codelineno-33-53" name="__codelineno-33-53"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;élèves de la classe nom=&#39;classe1&#39; -----------&quot;</span><span class="p">)</span>
<a id="__codelineno-33-54" name="__codelineno-33-54"></a>    <span class="c1"># d&#39;abord la classe</span>
<a id="__codelineno-33-55" name="__codelineno-33-55"></a>    <span class="n">classe</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_classe_by_name</span><span class="p">(</span><span class="s1">&#39;classe1&#39;</span><span class="p">)</span>
<a id="__codelineno-33-56" name="__codelineno-33-56"></a>    <span class="c1"># puis les élèves (lazy loading)</span>
<a id="__codelineno-33-57" name="__codelineno-33-57"></a>    <span class="k">for</span> <span class="n">élève</span> <span class="ow">in</span> <span class="n">classe</span><span class="o">.</span><span class="n">élèves</span><span class="p">:</span>
<a id="__codelineno-33-58" name="__codelineno-33-58"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">élève</span><span class="p">)</span>
<a id="__codelineno-33-59" name="__codelineno-33-59"></a>
<a id="__codelineno-33-60" name="__codelineno-33-60"></a>    <span class="c1"># même chose pour [classe2]</span>
<a id="__codelineno-33-61" name="__codelineno-33-61"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;élèves de la classe de nom &#39;classe2&#39; -----------&quot;</span><span class="p">)</span>
<a id="__codelineno-33-62" name="__codelineno-33-62"></a>    <span class="n">classe</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_classe_by_name</span><span class="p">(</span><span class="s1">&#39;classe2&#39;</span><span class="p">)</span>
<a id="__codelineno-33-63" name="__codelineno-33-63"></a>    <span class="k">for</span> <span class="n">élève</span> <span class="ow">in</span> <span class="n">classe</span><span class="o">.</span><span class="n">élèves</span><span class="p">:</span>
<a id="__codelineno-33-64" name="__codelineno-33-64"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">élève</span><span class="p">)</span>
<a id="__codelineno-33-65" name="__codelineno-33-65"></a>
<a id="__codelineno-33-66" name="__codelineno-33-66"></a>    <span class="c1"># les notes dans une matière</span>
<a id="__codelineno-33-67" name="__codelineno-33-67"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matière de nom=&#39;matière1&#39; -----------&quot;</span><span class="p">)</span>
<a id="__codelineno-33-68" name="__codelineno-33-68"></a>    <span class="c1"># d&#39;abord la matière</span>
<a id="__codelineno-33-69" name="__codelineno-33-69"></a>    <span class="n">matière</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_matière_by_name</span><span class="p">(</span><span class="s1">&#39;matière1&#39;</span><span class="p">)</span>
<a id="__codelineno-33-70" name="__codelineno-33-70"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;matière=</span><span class="si">{</span><span class="n">matière</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-33-71" name="__codelineno-33-71"></a>    <span class="c1"># puis les notes dans cette matière (lazy loading)</span>
<a id="__codelineno-33-72" name="__codelineno-33-72"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Notes dans la matière : &quot;</span><span class="p">)</span>
<a id="__codelineno-33-73" name="__codelineno-33-73"></a>    <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">matière</span><span class="o">.</span><span class="n">notes</span><span class="p">:</span>
<a id="__codelineno-33-74" name="__codelineno-33-74"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">note</span><span class="p">)</span>
<a id="__codelineno-33-75" name="__codelineno-33-75"></a>
<a id="__codelineno-33-76" name="__codelineno-33-76"></a>    <span class="c1"># même chose pour matière2</span>
<a id="__codelineno-33-77" name="__codelineno-33-77"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matière de nom=&#39;matière2&#39; -----------&quot;</span><span class="p">)</span>
<a id="__codelineno-33-78" name="__codelineno-33-78"></a>    <span class="n">matière</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_matière_by_name</span><span class="p">(</span><span class="s1">&#39;matière2&#39;</span><span class="p">)</span>
<a id="__codelineno-33-79" name="__codelineno-33-79"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;matière=</span><span class="si">{</span><span class="n">matière</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-33-80" name="__codelineno-33-80"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Notes dans la matière : &quot;</span><span class="p">)</span>
<a id="__codelineno-33-81" name="__codelineno-33-81"></a>    <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">matière</span><span class="o">.</span><span class="n">notes</span><span class="p">:</span>
<a id="__codelineno-33-82" name="__codelineno-33-82"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;note=</span><span class="si">{</span><span class="n">note</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-33-83" name="__codelineno-33-83"></a><span class="k">except</span> <span class="n">MyException</span> <span class="k">as</span> <span class="n">ex1</span><span class="p">:</span>
<a id="__codelineno-33-84" name="__codelineno-33-84"></a>    <span class="c1"># on affiche l&#39;erreur</span>
<a id="__codelineno-33-85" name="__codelineno-33-85"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur 1 suivante s&#39;est produite : </span><span class="si">{</span><span class="n">ex1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-33-86" name="__codelineno-33-86"></a><span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">ex2</span><span class="p">:</span>
<a id="__codelineno-33-87" name="__codelineno-33-87"></a>    <span class="c1"># on affiche l&#39;erreur</span>
<a id="__codelineno-33-88" name="__codelineno-33-88"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur 2 suivante s&#39;est produite : </span><span class="si">{</span><span class="n">ex2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-33-89" name="__codelineno-33-89"></a><span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-33-90" name="__codelineno-33-90"></a>    <span class="c1"># on libère les ressources</span>
<a id="__codelineno-33-91" name="__codelineno-33-91"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">shutdown</span>
<a id="__codelineno-33-92" name="__codelineno-33-92"></a>    <span class="n">shutdown</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Les commentaires suffisent à comprendre le code.</p>
<p>On crée une configuration d’exécution pour MySQL :</p>
<p><img src="images/100000000000051500000242D9998CD0.png" style="width:15.011cm;height:6.691cm;" alt="Image" /></p>
<p>Les résultats de l’exécution sont les suivants :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-34-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-34-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-34-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-34-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-34-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-34-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-34-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-34-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-34-10">10</a></span>
<span class="normal"><a href="#__codelineno-34-11">11</a></span>
<span class="normal"><a href="#__codelineno-34-12">12</a></span>
<span class="normal"><a href="#__codelineno-34-13">13</a></span>
<span class="normal"><a href="#__codelineno-34-14">14</a></span>
<span class="normal"><a href="#__codelineno-34-15">15</a></span>
<span class="normal"><a href="#__codelineno-34-16">16</a></span>
<span class="normal"><a href="#__codelineno-34-17">17</a></span>
<span class="normal"><a href="#__codelineno-34-18">18</a></span>
<span class="normal"><a href="#__codelineno-34-19">19</a></span>
<span class="normal"><a href="#__codelineno-34-20">20</a></span>
<span class="normal"><a href="#__codelineno-34-21">21</a></span>
<span class="normal"><a href="#__codelineno-34-22">22</a></span>
<span class="normal"><a href="#__codelineno-34-23">23</a></span>
<span class="normal"><a href="#__codelineno-34-24">24</a></span>
<span class="normal"><a href="#__codelineno-34-25">25</a></span>
<span class="normal"><a href="#__codelineno-34-26">26</a></span>
<span class="normal"><a href="#__codelineno-34-27">27</a></span>
<span class="normal"><a href="#__codelineno-34-28">28</a></span>
<span class="normal"><a href="#__codelineno-34-29">29</a></span>
<span class="normal"><a href="#__codelineno-34-30">30</a></span>
<span class="normal"><a href="#__codelineno-34-31">31</a></span>
<span class="normal"><a href="#__codelineno-34-32">32</a></span>
<span class="normal"><a href="#__codelineno-34-33">33</a></span>
<span class="normal"><a href="#__codelineno-34-34">34</a></span>
<span class="normal"><a href="#__codelineno-34-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">Scripts</span>\<span class="n">python</span><span class="o">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">st</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">cours</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">databases</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="mi">05</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">main_joined_queries</span><span class="o">.</span><span class="n">py</span> <span class="n">mysql</span>
<a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="n">élève</span> <span class="nb">id</span><span class="o">=</span><span class="mi">11</span> <span class="o">-----------</span>
<a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="n">élève</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;classe_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;nom1&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;prénom1&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">}</span>
<a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="n">classe</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;élève : {&quot;nom&quot;: &quot;classe1&quot;, &quot;id&quot;: 1}</span>
<a id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="n">élèves</span> <span class="n">dans</span> <span class="n">la</span> <span class="n">même</span> <span class="n">classe</span> <span class="p">:</span>
<a id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="n">élève</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;classe_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;nom1&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;prénom1&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">}</span>
<a id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="n">élève</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;classe_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;nom2&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;prénom2&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">}</span>
<a id="__codelineno-34-8" name="__codelineno-34-8"></a><span class="n">élève</span> <span class="n">nom</span><span class="o">=</span><span class="s1">&#39;nom2&#39;</span> <span class="o">-----------</span>
<a id="__codelineno-34-9" name="__codelineno-34-9"></a><span class="n">élève</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;classe_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;nom2&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;prénom2&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">}</span>
<a id="__codelineno-34-10" name="__codelineno-34-10"></a><span class="n">classe</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;élève : {&quot;nom&quot;: &quot;classe1&quot;, &quot;id&quot;: 1}</span>
<a id="__codelineno-34-11" name="__codelineno-34-11"></a><span class="n">notes</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;élève id=11 -----------</span>
<a id="__codelineno-34-12" name="__codelineno-34-12"></a><span class="n">note</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;matière_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s2">&quot;élève_id&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">matière</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;coefficient&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;matière1&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<a id="__codelineno-34-13" name="__codelineno-34-13"></a><span class="n">note</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;matière_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mf">6.0</span><span class="p">,</span> <span class="s2">&quot;élève_id&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span> <span class="n">matière</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;coefficient&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;matière2&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<a id="__codelineno-34-14" name="__codelineno-34-14"></a><span class="n">élèves</span> <span class="n">de</span> <span class="n">la</span> <span class="n">classe</span> <span class="n">nom</span><span class="o">=</span><span class="s1">&#39;classe1&#39;</span> <span class="o">-----------</span>
<a id="__codelineno-34-15" name="__codelineno-34-15"></a><span class="p">{</span><span class="s2">&quot;classe_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;nom1&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;prénom1&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">}</span>
<a id="__codelineno-34-16" name="__codelineno-34-16"></a><span class="p">{</span><span class="s2">&quot;classe_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;nom2&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;prénom2&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">}</span>
<a id="__codelineno-34-17" name="__codelineno-34-17"></a><span class="n">élèves</span> <span class="n">de</span> <span class="n">la</span> <span class="n">classe</span> <span class="n">de</span> <span class="n">nom</span> <span class="s1">&#39;classe2&#39;</span> <span class="o">-----------</span>
<a id="__codelineno-34-18" name="__codelineno-34-18"></a><span class="p">{</span><span class="s2">&quot;classe_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;nom3&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;prénom3&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">}</span>
<a id="__codelineno-34-19" name="__codelineno-34-19"></a><span class="p">{</span><span class="s2">&quot;classe_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;nom4&quot;</span><span class="p">,</span> <span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;prénom4&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">}</span>
<a id="__codelineno-34-20" name="__codelineno-34-20"></a><span class="n">matière</span> <span class="n">de</span> <span class="n">nom</span><span class="o">=</span><span class="s1">&#39;matière1&#39;</span> <span class="o">-----------</span>
<a id="__codelineno-34-21" name="__codelineno-34-21"></a><span class="n">matière</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;coefficient&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;matière1&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<a id="__codelineno-34-22" name="__codelineno-34-22"></a><span class="n">Notes</span> <span class="n">dans</span> <span class="n">la</span> <span class="n">matière</span> <span class="p">:</span> 
<a id="__codelineno-34-23" name="__codelineno-34-23"></a><span class="p">{</span><span class="s2">&quot;matière_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s2">&quot;élève_id&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<a id="__codelineno-34-24" name="__codelineno-34-24"></a><span class="p">{</span><span class="s2">&quot;matière_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mf">12.0</span><span class="p">,</span> <span class="s2">&quot;élève_id&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<a id="__codelineno-34-25" name="__codelineno-34-25"></a><span class="p">{</span><span class="s2">&quot;matière_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mf">14.0</span><span class="p">,</span> <span class="s2">&quot;élève_id&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<a id="__codelineno-34-26" name="__codelineno-34-26"></a><span class="p">{</span><span class="s2">&quot;matière_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mf">16.0</span><span class="p">,</span> <span class="s2">&quot;élève_id&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
<a id="__codelineno-34-27" name="__codelineno-34-27"></a><span class="n">matière</span> <span class="n">de</span> <span class="n">nom</span><span class="o">=</span><span class="s1">&#39;matière2&#39;</span> <span class="o">-----------</span>
<a id="__codelineno-34-28" name="__codelineno-34-28"></a><span class="n">matière</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;coefficient&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;matière2&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<a id="__codelineno-34-29" name="__codelineno-34-29"></a><span class="n">Notes</span> <span class="n">dans</span> <span class="n">la</span> <span class="n">matière</span> <span class="p">:</span> 
<a id="__codelineno-34-30" name="__codelineno-34-30"></a><span class="n">note</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;matière_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mf">6.0</span><span class="p">,</span> <span class="s2">&quot;élève_id&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
<a id="__codelineno-34-31" name="__codelineno-34-31"></a><span class="n">note</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;matière_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mf">8.0</span><span class="p">,</span> <span class="s2">&quot;élève_id&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span>
<a id="__codelineno-34-32" name="__codelineno-34-32"></a><span class="n">note</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;matière_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="s2">&quot;élève_id&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">}</span>
<a id="__codelineno-34-33" name="__codelineno-34-33"></a><span class="n">note</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;matière_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;valeur&quot;</span><span class="p">:</span> <span class="mf">12.0</span><span class="p">,</span> <span class="s2">&quot;élève_id&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
<a id="__codelineno-34-34" name="__codelineno-34-34"></a>
<a id="__codelineno-34-35" name="__codelineno-34-35"></a><span class="n">Process</span> <span class="n">finished</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
<p>Pour comprendre ces résultats, il faut se rappeler qu’on a exclu certaines propriétés du dictionnaire des entités (cf |<a href="#_Configuration"><u><u>configuration</u></u></a>|) :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1">1</a></span>
<span class="normal"><a href="#__codelineno-35-2">2</a></span>
<span class="normal"><a href="#__codelineno-35-3">3</a></span>
<span class="normal"><a href="#__codelineno-35-4">4</a></span>
<span class="normal"><a href="#__codelineno-35-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a>    <span class="c1"># configuration des entités [BaseEntity]</span>
<a id="__codelineno-35-2" name="__codelineno-35-2"></a>    <span class="n">Elève</span><span class="o">.</span><span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_sa_instance_state&#39;</span><span class="p">,</span> <span class="s1">&#39;notes&#39;</span><span class="p">,</span> <span class="s1">&#39;classe&#39;</span><span class="p">]</span>
<a id="__codelineno-35-3" name="__codelineno-35-3"></a>    <span class="n">Classe</span><span class="o">.</span><span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_sa_instance_state&#39;</span><span class="p">,</span> <span class="s1">&#39;élèves&#39;</span><span class="p">]</span>
<a id="__codelineno-35-4" name="__codelineno-35-4"></a>    <span class="n">Matière</span><span class="o">.</span><span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_sa_instance_state&#39;</span><span class="p">,</span> <span class="s1">&#39;notes&#39;</span><span class="p">]</span>
<a id="__codelineno-35-5" name="__codelineno-35-5"></a>    <span class="n">Note</span><span class="o">.</span><span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_sa_instance_state&#39;</span><span class="p">,</span> <span class="s1">&#39;matière&#39;</span><span class="p">,</span> <span class="s1">&#39;élève&#39;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
<p>Ainsi, lorsqu’on écrit <strong>[</strong><strong>print(</strong><strong>f&quot;élève={élève}&quot;</strong><strong>)</strong><strong>]</strong> ligne 26 du code, la ligne 1 ci-dessus nous dit que les propriétés <strong>[</strong><strong>&#x27;_sa_instance_state&#x27;</strong><strong>, </strong><strong>&#x27;notes&#x27;</strong><strong>, </strong><strong>&#x27;classe&#x27;</strong><strong>]</strong> ne seront pas affichées. C’est ce qu’on voit ligne 3 des résultats. Toutes les autres propriétés sont affichées. Ainsi, toujours ligne 3, on découvre une nouvelle propriété <strong>[classe_id]</strong> qui n’existait initialement pas dans l’entité <strong>[Elève]</strong>. Cette propriété correspond directement à la colonne <strong>[classe_id]</strong> de la table <strong>[élèves]</strong>. Ainsi <strong>[sqlalchemy]</strong> a jouté les propriétés suivantes à l’entité <strong>[Elève]</strong> : <strong>[classe_id, _sa_instance_state, notes]</strong>. Il faut en avoir conscience, notamment parce qu’elles ne doivent pas déjà exister dans l’entité mappée.</p>
<p>Les propriétés exclues du dictionnaire des entités sont importantes. Si par exemple, on n’exclut pas les propriétés <strong>[notes, élève]</strong> de l’entité <strong>[Elève]</strong> alors l’opération <strong>[</strong><strong>print(</strong><strong>f&quot;élève={élève}&quot;</strong><strong>)</strong><strong>]</strong> va les afficher et va donc, comme il vient d’être expliqué, provoquer des requêtes SQL implicites (lazy loading) pour récupérer les valeurs de ces propriétés. Si, comme ici, c’est une liste d’élèves qui est affichée, les opérations SQL implicites sont faites pour chaque élève. Cela peut être d’une part inutile et d’autre part sûrement coûteux en temps d’exécution.</p>
<p>Pour exécuter le script avec une base PostgreSQL, on crée la configuration d’exécution suivante :</p>
<p><img src="images/1000000000000512000002B1B10D945F.png" style="width:15.011cm;height:7.97cm;" alt="Image" /></p>
<p>L’exécution donne les mêmes résultats qu’avec MySQL.</p>
<h3 id="1969-le-script-main_stats_for_eleve">19.6.9. Le script [main_stats_for_élève]</h3>
<p>Le script <strong>[main_stats_for_élève]</strong> est celui déjà utilisé dans l’application |<a href="#_Le_script_principal_3"><u><u>troiscouches v01</u></u></a>]. Il s’appelait alors <strong>[main]</strong>. C’est une application console permettant d’obtenir certains indicateurs sur les notes d’un élève : <strong>[moyenne pondérée, min, max, liste]</strong>. Il s’insère dans l’architecture suivante :</p>
<p><img src="images/1000000000000474000002D9C68CBE82.png" style="width:13.151cm;height:8.4cm;" alt="Image" /></p>
<p>Dans cette architecture en couches, seule la couche <strong>[dao]</strong> a été changée entre l’application |<a href="#_Exemple_1"><u><u>troiscouches v01</u></u></a>| et celle-ci. Comme la nouvelle couche <strong>[dao]</strong> respecte l’interface <strong>[InterfaceDao]</strong> de l’ancienne couche <strong>[dao]</strong>, les couches <strong>[ui, métier]</strong> n’ont pas à être changées. On peut donc continuer à utiliser celles définies dans l’application |<a href="#_Exemple_1"><u><u>troiscouches v01</u></u></a>|.</p>
<p>Le script <strong>[main_stats_for_élève]</strong> implémente la couche <strong>[main]</strong> du schéma ci-dessus de la façon suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-36-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-36-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-36-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-36-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-36-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-36-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-36-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-36-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-36-10">10</a></span>
<span class="normal"><a href="#__codelineno-36-11">11</a></span>
<span class="normal"><a href="#__codelineno-36-12">12</a></span>
<span class="normal"><a href="#__codelineno-36-13">13</a></span>
<span class="normal"><a href="#__codelineno-36-14">14</a></span>
<span class="normal"><a href="#__codelineno-36-15">15</a></span>
<span class="normal"><a href="#__codelineno-36-16">16</a></span>
<span class="normal"><a href="#__codelineno-36-17">17</a></span>
<span class="normal"><a href="#__codelineno-36-18">18</a></span>
<span class="normal"><a href="#__codelineno-36-19">19</a></span>
<span class="normal"><a href="#__codelineno-36-20">20</a></span>
<span class="normal"><a href="#__codelineno-36-21">21</a></span>
<span class="normal"><a href="#__codelineno-36-22">22</a></span>
<span class="normal"><a href="#__codelineno-36-23">23</a></span>
<span class="normal"><a href="#__codelineno-36-24">24</a></span>
<span class="normal"><a href="#__codelineno-36-25">25</a></span>
<span class="normal"><a href="#__codelineno-36-26">26</a></span>
<span class="normal"><a href="#__codelineno-36-27">27</a></span>
<span class="normal"><a href="#__codelineno-36-28">28</a></span>
<span class="normal"><a href="#__codelineno-36-29">29</a></span>
<span class="normal"><a href="#__codelineno-36-30">30</a></span>
<span class="normal"><a href="#__codelineno-36-31">31</a></span>
<span class="normal"><a href="#__codelineno-36-32">32</a></span>
<span class="normal"><a href="#__codelineno-36-33">33</a></span>
<span class="normal"><a href="#__codelineno-36-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="c1"># on attend un paramètre mysql ou pgres</span>
<a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-36-3" name="__codelineno-36-3"></a>
<a id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="n">syntaxe</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> mysql / pgres&quot;</span>
<a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="n">erreur</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
<a id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-36-7" name="__codelineno-36-7"></a>    <span class="n">sgbd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-36-8" name="__codelineno-36-8"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;mysql&quot;</span> <span class="ow">and</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;pgres&quot;</span>
<a id="__codelineno-36-9" name="__codelineno-36-9"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-36-10" name="__codelineno-36-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syntaxe : </span><span class="si">{</span><span class="n">syntaxe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-36-11" name="__codelineno-36-11"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<a id="__codelineno-36-12" name="__codelineno-36-12"></a>
<a id="__codelineno-36-13" name="__codelineno-36-13"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-36-14" name="__codelineno-36-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-36-15" name="__codelineno-36-15"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s1">&#39;sgbd&#39;</span><span class="p">:</span> <span class="n">sgbd</span><span class="p">})</span>
<a id="__codelineno-36-16" name="__codelineno-36-16"></a>
<a id="__codelineno-36-17" name="__codelineno-36-17"></a><span class="c1"># le syspath est configuré - on peut faire les imports</span>
<a id="__codelineno-36-18" name="__codelineno-36-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">MyException</span><span class="w"> </span><span class="kn">import</span> <span class="n">MyException</span>
<a id="__codelineno-36-19" name="__codelineno-36-19"></a>
<a id="__codelineno-36-20" name="__codelineno-36-20"></a><span class="c1"># la couche [ui]</span>
<a id="__codelineno-36-21" name="__codelineno-36-21"></a><span class="n">ui</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;ui&quot;</span><span class="p">]</span>
<a id="__codelineno-36-22" name="__codelineno-36-22"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-36-23" name="__codelineno-36-23"></a>    <span class="c1"># exécution couche [ui]</span>
<a id="__codelineno-36-24" name="__codelineno-36-24"></a>    <span class="n">ui</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-36-25" name="__codelineno-36-25"></a><span class="k">except</span> <span class="n">MyException</span> <span class="k">as</span> <span class="n">ex1</span><span class="p">:</span>
<a id="__codelineno-36-26" name="__codelineno-36-26"></a>    <span class="c1"># on affiche l&#39;erreur</span>
<a id="__codelineno-36-27" name="__codelineno-36-27"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur 1 suivante s&#39;est produite : </span><span class="si">{</span><span class="n">ex1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-36-28" name="__codelineno-36-28"></a><span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">ex2</span><span class="p">:</span>
<a id="__codelineno-36-29" name="__codelineno-36-29"></a>    <span class="c1"># on affiche l&#39;erreur</span>
<a id="__codelineno-36-30" name="__codelineno-36-30"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur 2 suivante s&#39;est produite : </span><span class="si">{</span><span class="n">ex2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-36-31" name="__codelineno-36-31"></a><span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-36-32" name="__codelineno-36-32"></a>    <span class="c1"># on libère les ressources</span>
<a id="__codelineno-36-33" name="__codelineno-36-33"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">shutdown</span>
<a id="__codelineno-36-34" name="__codelineno-36-34"></a>    <span class="n">shutdown</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 20 : on récupère une référence sur la couche <strong>[ui]</strong> dans la configuration de l’application ;</li>
<li>ligne 24 : on lance le dialogue avec l’utilisateur à l’aide de l’unique méthode de la couche <strong>[ui]</strong> ;
Une configuration d’exécution pour PostgreSQL serait la suivante :</li>
</ul>
<p><img src="images/10000000000003D0000001CF2F1C40A1.png" style="width:11.281cm;height:5.351cm;" alt="Image" /></p>
<p>Voici un exemple d’exécution avec cette configuration :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1">1</a></span>
<span class="normal"><a href="#__codelineno-37-2">2</a></span>
<span class="normal"><a href="#__codelineno-37-3">3</a></span>
<span class="normal"><a href="#__codelineno-37-4">4</a></span>
<span class="normal"><a href="#__codelineno-37-5">5</a></span>
<span class="normal"><a href="#__codelineno-37-6">6</a></span>
<span class="normal"><a href="#__codelineno-37-7">7</a></span>
<span class="normal"><a href="#__codelineno-37-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">Scripts</span>\<span class="n">python</span><span class="o">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">st</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">cours</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">databases</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="mi">05</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">main_stats_for_élève</span><span class="o">.</span><span class="n">py</span> <span class="n">pgres</span>
<a id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="n">Numéro</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;élève (&gt;=1 et * pour arrêter) : 11</span>
<a id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="n">Elève</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;prénom&quot;</span><span class="p">:</span> <span class="s2">&quot;prénom1&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;classe_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;nom1&quot;</span><span class="p">},</span> <span class="n">notes</span><span class="o">=</span><span class="p">[</span><span class="mf">10.0</span> <span class="mf">6.0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">6.0</span><span class="p">,</span> <span class="n">moyenne</span> <span class="n">pondérée</span><span class="o">=</span><span class="mf">7.33</span>
<a id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="n">Numéro</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;élève (&gt;=1 et * pour arrêter) : 1</span>
<a id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="n">L</span><span class="s1">&#39;erreur suivante s&#39;</span><span class="n">est</span> <span class="n">produite</span> <span class="p">:</span> <span class="n">MyException</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="n">L</span><span class="s1">&#39;élève d&#39;</span><span class="n">identifiant</span> <span class="mi">1</span> <span class="n">n</span><span class="s1">&#39;existe pas]</span>
<a id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="n">Numéro</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;élève (&gt;=1 et * pour arrêter) : *</span>
<a id="__codelineno-37-7" name="__codelineno-37-7"></a>
<a id="__codelineno-37-8" name="__codelineno-37-8"></a><span class="n">Process</span> <span class="n">finished</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner">

      <div>
        <a href="https://tahe.developpez.com" target="_blank">
          https://tahe.developpez.com
        </a>
        <br>
        Ce cours tutoriel écrit par <strong>Serge Tahé</strong> est mis à disposition du public selon les termes de la
        <em>Licence Creative Commons Attribution – Pas d’Utilisation Commerciale –
        Partage dans les Mêmes Conditions 3.0 non transposé</em>.
      </div>

    </div>
  </div>

      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": ".", "features": ["navigation.sections", "navigation.indexes", "toc.integrate", "navigation.top"], "search": "assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="javascripts/focus.js"></script>
      
    
  </body>
</html>