
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Introduction au langage Python 3 et au framework web Flask par l'exemple">
      
      
        <meta name="author" content="Serge Tahé">
      
      
        <link rel="canonical" href="https://stahe.github.io/python-flask-sept-2020/exercice-dapplication-version-6.html">
      
      
        <link rel="prev" href="services-web-avec-le-framework-flask.html">
      
      
        <link rel="next" href="exercice-dapplication-version-7.html">
      
      
        
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>23. Exercice d’application : version 6 - Introduction au langage Python 3 et au framework web Flask par l'exemple</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="stylesheets/focus.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#23-exercice-dapplication-version-6" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Introduction au langage Python 3 et au framework web Flask par l&#39;exemple" class="md-header__button md-logo" aria-label="Introduction au langage Python 3 et au framework web Flask par l'exemple" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Introduction au langage Python 3 et au framework web Flask par l'exemple
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              23. Exercice d’application : version 6
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode sombre"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Passer au mode sombre" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode clair"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Passer au mode clair" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/stahe/python-flask-sept-2020" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Introduction au langage Python 3 et au framework web Flask par l&#39;exemple" class="md-nav__button md-logo" aria-label="Introduction au langage Python 3 et au framework web Flask par l'exemple" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Introduction au langage Python 3 et au framework web Flask par l'exemple
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/stahe/python-flask-sept-2020" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accueil
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="avant-propos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Avant-propos
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="installation-dx27un-environnement-de-travail.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Installation d&#x27;un environnement de travail
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-bases-de-python.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Les bases de Python
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-chaines-de-caracteres.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Les chaînes de caractères
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-exceptions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Les exceptions
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-fonctions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Les fonctions
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-fichiers-texte.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    7. Les fichiers texte
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application---version-1.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    8. Exercice d&#x27;application – version 1
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-imports.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    9. Les imports
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-2.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    10. Exercice d’application : version 2
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-3.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    11. Exercice d’application : version 3
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-classes-et-objets.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    12. Les classes et objets
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-classes-generiques-baseentity-et-myexception.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    13. Les classes génériques [BaseEntity] et [MyException]
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="architecture-en-couches-et-programmation-par-interfaces.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    14. Architecture en couches et programmation par interfaces
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application---version-4.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    15. Exercice d&#x27;application - version 4
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-du-sgbd-mysql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    16. Utilisation du SGBD MySQL
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-du-sgbd-postgresql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    17. Utilisation du SGBD PostgreSQL
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="ecrire-du-code-independant-du-sgbd.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    18. Ecrire du code indépendant du SGBD
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-de-lorm-sqlalchemy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    19. Utilisation de l’ORM SQLALCHEMY
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application-version-5.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    20. Exercice d&#x27;application : version 5
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="fonctions-internet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    21. Fonctions internet
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="services-web-avec-le-framework-flask.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    22. Services web avec le framework Flask
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    23. Exercice d’application : version 6
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="exercice-dapplication-version-6.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    23. Exercice d’application : version 6
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#231-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        23.1. Introduction
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#232-le-serveur-web-de-calcul-de-limpot" class="md-nav__link">
    <span class="md-ellipsis">
      
        23.2. Le serveur web de calcul de l’impôt
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="23.2. Le serveur web de calcul de l’impôt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2321-version-1" class="md-nav__link">
    <span class="md-ellipsis">
      
        23.2.1. Version 1
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2322-version-2" class="md-nav__link">
    <span class="md-ellipsis">
      
        23.2.2. Version 2
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2323-version-3" class="md-nav__link">
    <span class="md-ellipsis">
      
        23.2.3. Version 3
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#233-le-client-web-du-serveur-de-calcul-de-limpot" class="md-nav__link">
    <span class="md-ellipsis">
      
        23.3. Le client web du serveur de calcul de l’impôt
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="23.3. Le client web du serveur de calcul de l’impôt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2331-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        23.3.1. Introduction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2332-configuration-du-client-web" class="md-nav__link">
    <span class="md-ellipsis">
      
        23.3.2. Configuration du client web
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2333-le-script-principal-main" class="md-nav__link">
    <span class="md-ellipsis">
      
        23.3.3. Le script principal [main]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2334-implementation-de-la-couche-dao" class="md-nav__link">
    <span class="md-ellipsis">
      
        23.3.4. Implémentation de la couche [dao]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2335-execution" class="md-nav__link">
    <span class="md-ellipsis">
      
        23.3.5. Exécution
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#234-tests-de-la-couche-dao" class="md-nav__link">
    <span class="md-ellipsis">
      
        23.4. Tests de la couche [dao]
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-7.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    24. Exercice d’application : version 7
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-8.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    25. Exercice d’application : version 8
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="du-dictionnaire-a-xml-et-vice-versa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    26. Du dictionnaire à XML et vice-versa
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-9.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    27. Exercice d’application : version 9
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-10.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    28. Exercice d’application : version 10
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-11.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    29. Exercice d’application : version 11
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    30. Exercice d’application : version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="clients-web-pour-les-services-json-et-xml-de-la-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    31. Clients web pour les services jSON et XML de la version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="le-mode-html-de-la-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    32. Le mode HTML de la version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-13.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    33. Exercice d’application : version 13
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-14.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    34. Exercice d’application : version 14
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-15.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    35. Exercice d’application : version 15
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-16.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    36. Exercice d’application : version 16
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-17.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    37. Exercice d’application : version 17
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-18.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    38. Exercice d’application : version 18
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="conclusion.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    39. Conclusion
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="23-exercice-dapplication-version-6">23. Exercice d’application : version 6</h1>
<h2 id="231-introduction">23.1. Introduction</h2>
<p>Nous revenons maintenant à notre application de calcul de l’impôt. Nous allons construire autour d’elle différentes applications web.</p>
<p>Dans la version 5 de notre exercice d’application, les données de l’administration fiscale étaient rangées dans une base de données. Cette version 5 comportait deux applications distinctes mais ayant des couches en commun :</p>
<ul>
<li>une application qui calculait l’impôt en mode |<a href="#_Application_2_:"><u><u>batch</u></u></a>| pour des contribuables enregistrés dans un fichier texte ;</li>
<li>une application qui calculait l’impôt en mode |<a href="#_Application_3_:"><u><u>interactif</u></u></a>| pour des contribuables dont on saisissait les informations au clavier ;
La version 5 de l’application de calcul de l’impôt par lots (mode batch) avait l’architecture suivante :</li>
</ul>
<p><img src="images/100000000000041A00000306F9143924.png" style="width:12.12cm;height:8.94cm;" alt="Image" /></p>
<p>Ultimement, la version web de cette application aura l’architecture suivante :</p>
<p><img src="images/10000000000004090000050F8A8B031F.png" style="width:11.921cm;height:14.951cm;" alt="Image" /></p>
<ul>
<li>le client web <strong>[1]</strong> s’adresse au serveur web <strong>[2]</strong> qui lui communique avec le SGBD <strong>[3]</strong> ;</li>
<li>le serveur web <strong>[2]</strong> conserve les couches <strong>[métier]</strong> <strong>[8]</strong> et <strong>[dao]</strong> <strong>[9]</strong> de l’application initiale ;</li>
<li>l’application initiale conserve son script principal <strong>[4]</strong> et sa couche <strong>[métier]</strong> <strong>[15]</strong>. Les couches <strong>[métier]</strong> <strong>[8]</strong> et <strong>[15]</strong> sont identiques;</li>
<li>la communication client / serveur nécessite deux couches supplémentaires :</li>
<li>la couche <strong>[web]</strong> <strong>[7]</strong> qui implémente l’application web ;</li>
<li>
<p>la couche <strong>[dao]</strong> <strong>[5]</strong> cliente de l’application web <strong>[7]</strong> ;
Dans la version finale, le calcul de l’impôt par lots pourra se dérouler de deux façons :</p>
</li>
<li>
<p>le calcul métier de l’impôt se fait par la couche <strong>[métier]</strong> du serveur. Le script <strong>[main]</strong> utilisera cette méthode ;</p>
</li>
<li>le calcul métier de l’impôt se fait par la couche <strong>[métier]</strong> du client. Le script <strong>[main2]</strong> utilisera cette méthode ;
A partir de maintenant, nous allons développer plusieurs applications client / serveur du type ci-dessus, chacune illustrant une ou de nouvelles technologies de développement web.</li>
</ul>
<h2 id="232-le-serveur-web-de-calcul-de-limpot">23.2. Le serveur web de calcul de l’impôt</h2>
<h3 id="2321-version-1">23.2.1. Version 1</h3>
<p><img src="images/1000000000000141000001709781F7CD.png" style="width:3.701cm;height:4.25cm;" alt="Image" /></p>
<p>Le script <strong>[server_01]</strong> est l’application web suivante :</p>
<p><img src="images/100000000000058B00000090407B2D22.png" style="width:16.361cm;height:1.661cm;" alt="Image" /></p>
<ul>
<li>en <strong>[1]</strong>, on utilise une URL paramétrée dans laquelle on passe trois valeurs :</li>
<li><strong>[marié]</strong> (oui / non) pour indiquer si le contribuable est marié ;</li>
<li><strong>[enfants]</strong> : le nombre d’enfants du contribuable ;</li>
<li><strong>[salaire]</strong> : salaire annuel du contribuable ;</li>
<li>en <strong>[2]</strong>, le serveur web renvoie une chaîne jSON qui donne le montant de l’impôt à payer avec avec ses différentes composantes ;
L’architecture de l’application est la suivante :</li>
</ul>
<p><img src="images/10000000000003E10000042233EC5DF0.png" style="width:11.471cm;height:12.21cm;" alt="Image" /></p>
<ul>
<li>le navigateur <strong>[1]</strong> interroge le serveur <strong>[2]</strong>. Le script <strong>[server_01]</strong> implémente la couche <strong>[web]</strong> <strong>[2]</strong> du serveur ;</li>
<li>les couches <strong>[3-8]</strong> sont celles déjà utilisées dans la |<a href="#_Exercice_d'application_:"><u><u>version 5</u></u></a>| de l’application du calcul de l’impôt. Nous les reprenons telles-quelles ;</li>
<li>la couche <strong>[métier]</strong> <strong>[3]</strong> est définie |<a href="#_La_couche_[métier]"><u><u>ici</u></u></a>| ;</li>
<li>
<p>la couche <strong>[dao]</strong> <strong>[4]</strong> est définie |<a href="#_La_couche_[dao]"><u><u>ici</u></u></a>| ;
L’application web <strong>[server_01]</strong> est configurée à l’aide de trois scripts :</p>
</li>
<li>
<p><strong>[config]</strong> qui configure la totalité de l’application ;</p>
</li>
<li><strong>[config_database]</strong> qui configure l’accès à la base de données. On travaillera avec les SGBD MySQL et PostgreSQL ;</li>
<li><strong>[config_layers]</strong> qui configure les couches de l’application ;
Le script <strong>[config]</strong> est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="c1"># étape 1 ------</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="c1"># dossier de ce fichier</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="c1"># chemin racine</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="n">root_dir</span> <span class="o">=</span> <span class="s2">&quot;C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="c1"># dépendances absolues</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="n">absolute_dependencies</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="c1"># dossiers du projet</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="c1"># BaseEntity, MyException</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/classes/02/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="c1"># InterfaceImpôtsDao, InterfaceImpôtsMétier, InterfaceImpôtsUi</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/interfaces&quot;</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="c1"># AbstractImpôtsdao, ImpôtsConsole, ImpôtsMétier</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/services&quot;</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="c1"># ImpotsDaoWithAdminDataInDatabase</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v05/services&quot;</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="c1"># AdminData, ImpôtsError, TaxPayer</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="c1"># Constantes, tranches</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v05/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="c1"># IndexController</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../controllers&quot;</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="c1"># scripts [config_database, config_layers]</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="n">script_dir</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="p">]</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="c1"># on fixe le syspath</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_syspath</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">set_syspath</span><span class="p">(</span><span class="n">absolute_dependencies</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="c1"># étape 2 ------</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="c1"># configuration de l&#39;application</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="c1"># liste des utilisateurs autorisés à utiliser l&#39;application</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="p">{</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>            <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="p">}</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="p">]</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="c1"># étape 3 ------</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="c1"># configuration base de données</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config_database</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_database</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="c1"># étape 4 ------</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="c1"># instanciation des couches de l&#39;application</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config_layers</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_layers</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="c1"># on rend la configuration</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>la fonction <strong>[configure]</strong> reçoit un dictionnaire <strong>[config]</strong> en paramètre (ligne 1) et le rend comme résultat (ligne 54) après avoir enrichi son contenu. On aurait pu dire depuis longtemps qu’il n’était pas nécessaire de rendre le résultat <strong>[config]</strong>. En effet <strong>[config]</strong> est une référence de dictionnaire que le code appelant partage avec le code appelé. Le code appelant possède donc déjà cette référence (ligne 1) et il est inutile de la lui redonner (ligne 54). Ainsi écrire :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="n">config</span><span class="o">=</span><span class="p">[</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<p>est redondant. Il suffit d’écrire :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="p">[</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Néanmoins, j’ai gardé le type (1) d’écriture parce que j’ai pensé qu’il montrait peut-être mieux, que le code appelé modifiait le dictionnaire <strong>[config]</strong>.</p>
<ul>
<li>ligne 1 : le dictionnaire <strong>[config]</strong> reçu par la fonction <strong>[configure]</strong> a une clé ‘sgbd’ qui prend sa valeur dans la liste <strong>[‘mysql’, ‘pgres’]</strong>. <strong>[mysql]</strong> signifie que la base de données utilisée est gérée par MySQL alors que ‘pgres’ signifie que la base de données utilisée est gérée par PostgreSQL ;</li>
<li>lignes 4-27 : on liste tous les dossiers contenant des éléments nécessaires à l’application web. Ils feront partie du Python Path de l’application (lignes 30-31) ;</li>
<li>lignes 33-40 : on ne va autoriser que certains utilisateurs à accéder à l’application. Ici on a une liste avec un unique utilisateur ;</li>
<li>lignes 43-46 : c’est le script <strong>[config_database]</strong> qui construit la configuration de la base de données utilisée ;</li>
<li>ligne 46 : la configuration construite par le script <strong>[config_database]</strong> est un dictionnaire qu’on range dans la configuration générale associé à la clé ‘database’ ;</li>
<li>lignes 48-51 : le script <strong>[config_layers]</strong> instancie les couches de l’application web. Il rend un dictionnaire qu’on range dans la configuration générale associé à la clé ‘layers’ ;
Le script <strong>[config_database]</strong> est celui déjà utilisé dans la |<a href="#_Le_fichier_de"><u><u>version 5</u></u></a>|. On le redonne pour mémoire :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span>
<span class="normal"><a href="#__codelineno-3-24">24</a></span>
<span class="normal"><a href="#__codelineno-3-25">25</a></span>
<span class="normal"><a href="#__codelineno-3-26">26</a></span>
<span class="normal"><a href="#__codelineno-3-27">27</a></span>
<span class="normal"><a href="#__codelineno-3-28">28</a></span>
<span class="normal"><a href="#__codelineno-3-29">29</a></span>
<span class="normal"><a href="#__codelineno-3-30">30</a></span>
<span class="normal"><a href="#__codelineno-3-31">31</a></span>
<span class="normal"><a href="#__codelineno-3-32">32</a></span>
<span class="normal"><a href="#__codelineno-3-33">33</a></span>
<span class="normal"><a href="#__codelineno-3-34">34</a></span>
<span class="normal"><a href="#__codelineno-3-35">35</a></span>
<span class="normal"><a href="#__codelineno-3-36">36</a></span>
<span class="normal"><a href="#__codelineno-3-37">37</a></span>
<span class="normal"><a href="#__codelineno-3-38">38</a></span>
<span class="normal"><a href="#__codelineno-3-39">39</a></span>
<span class="normal"><a href="#__codelineno-3-40">40</a></span>
<span class="normal"><a href="#__codelineno-3-41">41</a></span>
<span class="normal"><a href="#__codelineno-3-42">42</a></span>
<span class="normal"><a href="#__codelineno-3-43">43</a></span>
<span class="normal"><a href="#__codelineno-3-44">44</a></span>
<span class="normal"><a href="#__codelineno-3-45">45</a></span>
<span class="normal"><a href="#__codelineno-3-46">46</a></span>
<span class="normal"><a href="#__codelineno-3-47">47</a></span>
<span class="normal"><a href="#__codelineno-3-48">48</a></span>
<span class="normal"><a href="#__codelineno-3-49">49</a></span>
<span class="normal"><a href="#__codelineno-3-50">50</a></span>
<span class="normal"><a href="#__codelineno-3-51">51</a></span>
<span class="normal"><a href="#__codelineno-3-52">52</a></span>
<span class="normal"><a href="#__codelineno-3-53">53</a></span>
<span class="normal"><a href="#__codelineno-3-54">54</a></span>
<span class="normal"><a href="#__codelineno-3-55">55</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>    <span class="c1"># configuration sqlalchemy</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Float</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">sessionmaker</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>    <span class="c1"># chaînes de connexion aux bases de données exploitées</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="n">connection_strings</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>        <span class="s1">&#39;mysql&#39;</span><span class="p">:</span> <span class="s2">&quot;mysql+mysqlconnector://admimpots:mdpimpots@localhost/dbimpots-2019&quot;</span><span class="p">,</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>        <span class="s1">&#39;pgres&#39;</span><span class="p">:</span> <span class="s2">&quot;postgresql+psycopg2://admimpots:mdpimpots@localhost/dbimpots-2019&quot;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>    <span class="p">}</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>    <span class="c1"># chaîne de connexion à la base de données exploitée</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">connection_strings</span><span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sgbd&#39;</span><span class="p">]])</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>    <span class="c1"># metadata</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a>    <span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>    <span class="c1"># la table des constantes</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>    <span class="n">constantes_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;tbconstantes&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_qf_demi_part&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_revenus_celibataire_pour_reduction&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_revenus_couple_pour_reduction&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;valeur_reduc_demi_part&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_decote_celibataire&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_decote_couple&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_impot_celibataire_pour_decote&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-3-27" name="__codelineno-3-27"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_impot_couple_pour_decote&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;abattement_dixpourcent_max&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-3-29" name="__codelineno-3-29"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;abattement_dixpourcent_min&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-30" name="__codelineno-3-30"></a>                             <span class="p">)</span>
<a id="__codelineno-3-31" name="__codelineno-3-31"></a>
<a id="__codelineno-3-32" name="__codelineno-3-32"></a>    <span class="c1"># la table des tranches de l&#39;impôt</span>
<a id="__codelineno-3-33" name="__codelineno-3-33"></a>    <span class="n">tranches_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;tbtranches&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-3-34" name="__codelineno-3-34"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-3-35" name="__codelineno-3-35"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;limite&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-3-36" name="__codelineno-3-36"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;coeffr&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-3-37" name="__codelineno-3-37"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;coeffn&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-38" name="__codelineno-3-38"></a>                           <span class="p">)</span>
<a id="__codelineno-3-39" name="__codelineno-3-39"></a>    <span class="c1"># les mappings</span>
<a id="__codelineno-3-40" name="__codelineno-3-40"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Tranche</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tranche</span>
<a id="__codelineno-3-41" name="__codelineno-3-41"></a>    <span class="n">mapper</span><span class="p">(</span><span class="n">Tranche</span><span class="p">,</span> <span class="n">tranches_table</span><span class="p">)</span>
<a id="__codelineno-3-42" name="__codelineno-3-42"></a>
<a id="__codelineno-3-43" name="__codelineno-3-43"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Constantes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Constantes</span>
<a id="__codelineno-3-44" name="__codelineno-3-44"></a>    <span class="n">mapper</span><span class="p">(</span><span class="n">Constantes</span><span class="p">,</span> <span class="n">constantes_table</span><span class="p">)</span>
<a id="__codelineno-3-45" name="__codelineno-3-45"></a>
<a id="__codelineno-3-46" name="__codelineno-3-46"></a>    <span class="c1"># la session factory</span>
<a id="__codelineno-3-47" name="__codelineno-3-47"></a>    <span class="n">session_factory</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()</span>
<a id="__codelineno-3-48" name="__codelineno-3-48"></a>    <span class="n">session_factory</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<a id="__codelineno-3-49" name="__codelineno-3-49"></a>
<a id="__codelineno-3-50" name="__codelineno-3-50"></a>    <span class="c1"># une session</span>
<a id="__codelineno-3-51" name="__codelineno-3-51"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">session_factory</span><span class="p">()</span>
<a id="__codelineno-3-52" name="__codelineno-3-52"></a>
<a id="__codelineno-3-53" name="__codelineno-3-53"></a>    <span class="c1"># on enregistre certaines informations et on les rend dans un dictionnaire</span>
<a id="__codelineno-3-54" name="__codelineno-3-54"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;engine&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">,</span> <span class="s2">&quot;tranches_table&quot;</span><span class="p">:</span> <span class="n">tranches_table</span><span class="p">,</span>
<a id="__codelineno-3-55" name="__codelineno-3-55"></a>            <span class="s2">&quot;constantes_table&quot;</span><span class="p">:</span> <span class="n">constantes_table</span><span class="p">,</span> <span class="s2">&quot;session&quot;</span><span class="p">:</span> <span class="n">session</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Le script <strong>[config_layers]</strong> configure les couches du serveur web. On reprend un |<a href="#_Configuration_de_l’application"><u><u>script</u></u></a>| déjà rencontré :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>    <span class="c1"># instanciation des couches de l&#39;application</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>    <span class="c1"># dao</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">ImpotsDaoWithAdminDataInDatabase</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpotsDaoWithAdminDataInDatabase</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>    <span class="n">dao</span> <span class="o">=</span> <span class="n">ImpotsDaoWithAdminDataInDatabase</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>    <span class="c1"># métier</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsMétier</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsMétier</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>    <span class="n">métier</span> <span class="o">=</span> <span class="n">ImpôtsMétier</span><span class="p">()</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>    <span class="c1"># on met les instances de couches dans un dictionnaire qu&#39;on rend au code appelant</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a>        <span class="s2">&quot;dao&quot;</span><span class="p">:</span> <span class="n">dao</span><span class="p">,</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a>        <span class="s2">&quot;métier&quot;</span><span class="p">:</span> <span class="n">métier</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 6 : la couche <strong>[dao]</strong> est implémentée avec une base de données ;</li>
<li><strong>[ImpotsDaoWithAdminDataInDatabase]</strong> a été définie |<a href="#_La_couche_[dao]"><u><u>ici</u></u></a>| ;</li>
<li><strong>[ImpôtsMétier]</strong> a été définie |<a href="#_La_classe_[ImpôtsMétier]"><u><u>ici</u></u></a>| ;
Le script principal <strong>[server_01]</strong> est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">  1</a></span>
<span class="normal"><a href="#__codelineno-5-2">  2</a></span>
<span class="normal"><a href="#__codelineno-5-3">  3</a></span>
<span class="normal"><a href="#__codelineno-5-4">  4</a></span>
<span class="normal"><a href="#__codelineno-5-5">  5</a></span>
<span class="normal"><a href="#__codelineno-5-6">  6</a></span>
<span class="normal"><a href="#__codelineno-5-7">  7</a></span>
<span class="normal"><a href="#__codelineno-5-8">  8</a></span>
<span class="normal"><a href="#__codelineno-5-9">  9</a></span>
<span class="normal"><a href="#__codelineno-5-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-5-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-5-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-5-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-5-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-5-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-5-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-5-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-5-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-5-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-5-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-5-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-5-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-5-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-5-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-5-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-5-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-5-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-5-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-5-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-5-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-5-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-5-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-5-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-5-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-5-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-5-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-5-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-5-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-5-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-5-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-5-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-5-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-5-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-5-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-5-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-5-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-5-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-5-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-5-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-5-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-5-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-5-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-5-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-5-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-5-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-5-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-5-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-5-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-5-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-5-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-5-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-5-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-5-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-5-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-5-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-5-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-5-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-5-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-5-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-5-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-5-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-5-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-5-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-5-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-5-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-5-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-5-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-5-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-5-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-5-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-5-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-5-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-5-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-5-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-5-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-5-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-5-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-5-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-5-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-5-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-5-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-5-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-5-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-5-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-5-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-5-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-5-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-5-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-5-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-5-100">100</a></span>
<span class="normal"><a href="#__codelineno-5-101">101</a></span>
<span class="normal"><a href="#__codelineno-5-102">102</a></span>
<span class="normal"><a href="#__codelineno-5-103">103</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1"># on attend un paramètre mysql ou pgres</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="n">syntaxe</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> mysql / pgres&quot;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="n">erreur</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>    <span class="n">sgbd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;mysql&quot;</span> <span class="ow">and</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;pgres&quot;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syntaxe : </span><span class="si">{</span><span class="n">syntaxe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s1">&#39;sgbd&#39;</span><span class="p">:</span> <span class="n">sgbd</span><span class="p">})</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="c1"># dépendances</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">TaxPayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaxPayer</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="kn">from</span><span class="w"> </span><span class="nn">myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">json_response</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="c1"># récupération des données de l&#39;administration fiscale</span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a>    <span class="c1"># admindata sera une donnée de portée application en lecture seule</span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a>    <span class="n">admindata</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_admindata</span><span class="p">()</span>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="k">except</span> <span class="n">ImpôtsError</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-31" name="__codelineno-5-31"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-32" name="__codelineno-5-32"></a>
<a id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="c1"># application Flask</span>
<a id="__codelineno-5-34" name="__codelineno-5-34"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-5-35" name="__codelineno-5-35"></a>
<a id="__codelineno-5-36" name="__codelineno-5-36"></a>
<a id="__codelineno-5-37" name="__codelineno-5-37"></a><span class="c1"># Home URL : /?marié=xx&amp;enfants=yy&amp;salaire=zz</span>
<a id="__codelineno-5-38" name="__codelineno-5-38"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-5-39" name="__codelineno-5-39"></a><span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
<a id="__codelineno-5-40" name="__codelineno-5-40"></a>    <span class="c1"># au départ pas d&#39;erreurs</span>
<a id="__codelineno-5-41" name="__codelineno-5-41"></a>    <span class="n">erreurs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-42" name="__codelineno-5-42"></a>    <span class="c1"># la requête doit avoir trois paramètres dans l’URL</span>
<a id="__codelineno-5-43" name="__codelineno-5-43"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-5-44" name="__codelineno-5-44"></a>        <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Méthode GET requise avec les seuls paramètres [marié, enfants, salaire]&quot;</span><span class="p">)</span>
<a id="__codelineno-5-45" name="__codelineno-5-45"></a>
<a id="__codelineno-5-46" name="__codelineno-5-46"></a>    <span class="c1"># on récupère le statut marital dans l’URL</span>
<a id="__codelineno-5-47" name="__codelineno-5-47"></a>    <span class="n">marié</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;marié&#39;</span><span class="p">)</span>
<a id="__codelineno-5-48" name="__codelineno-5-48"></a>    <span class="k">if</span> <span class="n">marié</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-49" name="__codelineno-5-49"></a>        <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;paramètre [marié] manquant&quot;</span><span class="p">)</span>
<a id="__codelineno-5-50" name="__codelineno-5-50"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-51" name="__codelineno-5-51"></a>        <span class="n">marié</span> <span class="o">=</span> <span class="n">marié</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-5-52" name="__codelineno-5-52"></a>        <span class="n">erreur</span> <span class="o">=</span> <span class="n">marié</span> <span class="o">!=</span> <span class="s2">&quot;oui&quot;</span> <span class="ow">and</span> <span class="n">marié</span> <span class="o">!=</span> <span class="s2">&quot;non&quot;</span>
<a id="__codelineno-5-53" name="__codelineno-5-53"></a>        <span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-5-54" name="__codelineno-5-54"></a>            <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;paramétre marié [</span><span class="si">{</span><span class="n">marié</span><span class="si">}</span><span class="s2">] invalide&quot;</span><span class="p">)</span>
<a id="__codelineno-5-55" name="__codelineno-5-55"></a>
<a id="__codelineno-5-56" name="__codelineno-5-56"></a>    <span class="c1"># on récupère le nombre d&#39;enfants dans l’URL</span>
<a id="__codelineno-5-57" name="__codelineno-5-57"></a>    <span class="n">enfants</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enfants&#39;</span><span class="p">)</span>
<a id="__codelineno-5-58" name="__codelineno-5-58"></a>    <span class="k">if</span> <span class="n">enfants</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-59" name="__codelineno-5-59"></a>        <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;paramètre [enfants] manquant&quot;</span><span class="p">)</span>
<a id="__codelineno-5-60" name="__codelineno-5-60"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-61" name="__codelineno-5-61"></a>        <span class="n">enfants</span> <span class="o">=</span> <span class="n">enfants</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-5-62" name="__codelineno-5-62"></a>        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\d+&quot;</span><span class="p">,</span> <span class="n">enfants</span><span class="p">)</span>
<a id="__codelineno-5-63" name="__codelineno-5-63"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-5-64" name="__codelineno-5-64"></a>            <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;paramétre enfants [</span><span class="si">{</span><span class="n">enfants</span><span class="si">}</span><span class="s2">] invalide&quot;</span><span class="p">)</span>
<a id="__codelineno-5-65" name="__codelineno-5-65"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-66" name="__codelineno-5-66"></a>            <span class="n">enfants</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">enfants</span><span class="p">)</span>
<a id="__codelineno-5-67" name="__codelineno-5-67"></a>
<a id="__codelineno-5-68" name="__codelineno-5-68"></a>    <span class="c1"># on récupère le salaire dans l’URL</span>
<a id="__codelineno-5-69" name="__codelineno-5-69"></a>    <span class="n">salaire</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;salaire&#39;</span><span class="p">)</span>
<a id="__codelineno-5-70" name="__codelineno-5-70"></a>    <span class="k">if</span> <span class="n">salaire</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-71" name="__codelineno-5-71"></a>        <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;paramètre [salaire] manquant&quot;</span><span class="p">)</span>
<a id="__codelineno-5-72" name="__codelineno-5-72"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-73" name="__codelineno-5-73"></a>        <span class="n">salaire</span> <span class="o">=</span> <span class="n">salaire</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-5-74" name="__codelineno-5-74"></a>        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\d+&quot;</span><span class="p">,</span> <span class="n">salaire</span><span class="p">)</span>
<a id="__codelineno-5-75" name="__codelineno-5-75"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-5-76" name="__codelineno-5-76"></a>            <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;paramétre salaire [</span><span class="si">{</span><span class="n">salaire</span><span class="si">}</span><span class="s2">] invalide&quot;</span><span class="p">)</span>
<a id="__codelineno-5-77" name="__codelineno-5-77"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-78" name="__codelineno-5-78"></a>            <span class="n">salaire</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">salaire</span><span class="p">)</span>
<a id="__codelineno-5-79" name="__codelineno-5-79"></a>
<a id="__codelineno-5-80" name="__codelineno-5-80"></a>    <span class="c1"># des paramètres invalides dans l’URL ?</span>
<a id="__codelineno-5-81" name="__codelineno-5-81"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-5-82" name="__codelineno-5-82"></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;marié&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">]:</span>
<a id="__codelineno-5-83" name="__codelineno-5-83"></a>            <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;paramètre [</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">] invalide&quot;</span><span class="p">)</span>
<a id="__codelineno-5-84" name="__codelineno-5-84"></a>
<a id="__codelineno-5-85" name="__codelineno-5-85"></a>    <span class="c1"># des erreurs ?</span>
<a id="__codelineno-5-86" name="__codelineno-5-86"></a>    <span class="k">if</span> <span class="n">erreurs</span><span class="p">:</span>
<a id="__codelineno-5-87" name="__codelineno-5-87"></a>        <span class="c1"># on envoie une réponse d&#39;erreur au client</span>
<a id="__codelineno-5-88" name="__codelineno-5-88"></a>        <span class="n">résultats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;erreurs&quot;</span><span class="p">:</span> <span class="n">erreurs</span><span class="p">}}</span>
<a id="__codelineno-5-89" name="__codelineno-5-89"></a>        <span class="k">return</span> <span class="n">json_response</span><span class="p">(</span><span class="n">résultats</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
<a id="__codelineno-5-90" name="__codelineno-5-90"></a>
<a id="__codelineno-5-91" name="__codelineno-5-91"></a>    <span class="c1"># pas d&#39;erreurs, on peut travailler</span>
<a id="__codelineno-5-92" name="__codelineno-5-92"></a>    <span class="c1"># calcul de l&#39;impôt</span>
<a id="__codelineno-5-93" name="__codelineno-5-93"></a>    <span class="n">taxpayer</span> <span class="o">=</span> <span class="n">TaxPayer</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="n">marié</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="n">enfants</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="n">salaire</span><span class="p">})</span>
<a id="__codelineno-5-94" name="__codelineno-5-94"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;métier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">taxpayer</span><span class="p">,</span> <span class="n">admindata</span><span class="p">)</span>
<a id="__codelineno-5-95" name="__codelineno-5-95"></a>    <span class="c1"># on envoie la réponse au client</span>
<a id="__codelineno-5-96" name="__codelineno-5-96"></a>    <span class="k">return</span> <span class="n">json_response</span><span class="p">({</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">taxpayer</span><span class="o">.</span><span class="n">asdict</span><span class="p">()}},</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
<a id="__codelineno-5-97" name="__codelineno-5-97"></a>
<a id="__codelineno-5-98" name="__codelineno-5-98"></a>
<a id="__codelineno-5-99" name="__codelineno-5-99"></a><span class="c1"># main uniquement</span>
<a id="__codelineno-5-100" name="__codelineno-5-100"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-5-101" name="__codelineno-5-101"></a>    <span class="c1"># on lance le serveur Flask</span>
<a id="__codelineno-5-102" name="__codelineno-5-102"></a>    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ENV</span><span class="o">=</span><span class="s2">&quot;development&quot;</span><span class="p">,</span> <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-103" name="__codelineno-5-103"></a>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 1-10 : on récupère le paramètre qui indique quel SGBD utiliser ;</li>
<li>lignes 12-14 : munie de cette information on peut configurer l’application. Le Python Path est notamment construit ;</li>
<li>lignes 16-23 : muni du nouveau Python Path, on importe les éléments dont on a besoin ;</li>
<li>lignes 25-31 : on récupère les données de l’administration fiscale qui permettent de faire le calcul de l’impôt ;</li>
<li>lignes 33-34 : instanciation de l’application Flask ;</li>
<li>ligne 38 : l’application Flask ne sert que l’URL <strong>[/]</strong>. Elle attend une URL paramétrée de la façon suivante <strong>[/ ?marié=xx&amp;enfants=yy&amp;salaire=zz]</strong> avec :</li>
<li>xx : oui / non ;</li>
<li>yy : nombre d’enfants ;</li>
<li>zz : salaire annuel ;</li>
<li>lignes 40-89 : on vérifie la validité des paramètres de l’URL ;</li>
<li>ligne 41 : on va cumuler les messages d’erreur dans la liste <strong>[erreurs]</strong> ;</li>
<li>ligne 43 : on se rappelle peut-être que les paramètres de l’URL paramétrée sont retrouvés dans <strong>[request.args]</strong> (voir |<a href="#_scripts_[flask/04]_:"><u><u>ici</u></u></a>|) :</li>
<li>l’objet <strong>[request]</strong> est l’objet Flask importé ligne 20 ;</li>
<li>l’objet <strong>[request.args]</strong> se comporte comme un dictionnaire ;</li>
<li>lignes 43-44 : on vérifie qu’on a trois paramètres exactement (pas moins, pas plus) ;</li>
<li>lignes 46-49 : on vérifie que le paramètre <strong>[marié]</strong> est présent dans l’URL ;</li>
<li>lignes 50-54 : s’il est présent on vérifie que sa valeur minuscule débarrassée des ‘blancs’ de début / fin est oui ou non ;</li>
<li>lignes 56-59 : on vérifie que le paramètre <strong>[enfants]</strong> est dans l’URL ;</li>
<li>lignes 60-66 : s’il est présent on vérifie que sa valeur est un entier positif ;</li>
<li>ligne 66 : il ne faut pas oublier que les paramètres de l’URL et leurs valeurs sont des chaînes de caractères. La valeur du paramètre <strong>[enfants]</strong> est transformée en ‘int’ ;</li>
<li>lignes 68-78 : pour le paramètre <strong>[salaire]</strong>, on fait les mêmes tests que pour le paramètre <strong>[enfants]</strong> ;</li>
<li>lignes 81-83 : on vérifie qu’il n’y a pas de paramètres autres que <strong>[‘marié, ‘enfants’, ‘salaire’]</strong> dans l’URL ;</li>
<li>lignes 85-89 : si après toutes ces vérifications, la liste <strong>[erreurs]</strong> n’est pas vide alors on envoie cette liste d’erreurs au client sous la forme d’une chaîne jSON  et le code de statut <strong>[400 Bad Request]</strong> ;
Comme par la suite, nous aurons souvent l’occasion d’envoyer une chaîne jSON en réponse au client, les quelques lignes nécessaires à cet envoi ont été factorisées dans le module <strong>[myutils.py]</strong> que nous avons déjà utilisé :</li>
</ul>
<p><img src="images/10000000000000E4000000AA2DDA30F6.png" style="width:2.631cm;height:1.96cm;" alt="Image" /></p>
<p>Le script <strong>[myutils.py]</strong> devient le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c1"># imports</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_response</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">set_syspath</span><span class="p">(</span><span class="n">absolute_dependencies</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>    <span class="c1"># absolute_dependencies : une liste de noms absolus de dossiers</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>    <span class="err">…</span><span class="o">.</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="c1"># génération d&#39;une réponse HTTP jSON</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">json_response</span><span class="p">(</span><span class="n">réponse</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a>    <span class="c1"># corps de la réponse HTTP</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">réponse</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a>    <span class="c1"># corps de la réponse HTTP est du jSON</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/json; charset=utf-8&#39;</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a>    <span class="c1"># on envoie la réponse HTTP</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a>    <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">status_code</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 16 : la fonction <strong>[json_response]</strong> attend deux paramètres :</li>
<li><strong>[réponse]</strong> : le dictionnaire dont il faut envoyer la chaîne jSON au client web ;</li>
<li><strong>[status_code]</strong> : le code de statut HTTP de la réponse ;</li>
<li>ligne 18 : on fixe le corps jSON de la réponse ;</li>
<li>ligne 20 : on ajoute l’entête HTTP qui dit au client web qu’il va recevoir du jSON ;</li>
<li>ligne 22 : on envoie la réponse HTTP au code appelant. A charge pour lui de l’envoyer au client web ;
Le fichier <strong>[<strong>init</strong>.py]</strong> évolue de la façon suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_syspath</span><span class="p">,</span> <span class="n">json_response</span>
</code></pre></div></td></tr></table></div>
<p>La nouvelle version de <strong>[myutils]</strong> est installée parmi les modules de portée machine avec la commande <strong>[pip install .]</strong> dans un terminal Pycharm :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="p">(</span><span class="n">venv</span><span class="p">)</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">packages</span><span class="o">&gt;</span><span class="n">pip</span> <span class="n">install</span> <span class="o">.</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="n">Processing</span> <span class="n">c</span><span class="p">:</span>\<span class="n">data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">packages</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="n">Using</span> <span class="n">legacy</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span> <span class="k">for</span> <span class="n">myutils</span><span class="p">,</span> <span class="n">since</span> <span class="n">package</span> <span class="s1">&#39;wheel&#39;</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">installed</span><span class="o">.</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="n">Installing</span> <span class="n">collected</span> <span class="n">packages</span><span class="p">:</span> <span class="n">myutils</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>  <span class="n">Attempting</span> <span class="n">uninstall</span><span class="p">:</span> <span class="n">myutils</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>    <span class="n">Found</span> <span class="n">existing</span> <span class="n">installation</span><span class="p">:</span> <span class="n">myutils</span> <span class="mf">0.1</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a>    <span class="n">Uninstalling</span> <span class="n">myutils</span><span class="o">-</span><span class="mf">0.1</span><span class="p">:</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>      <span class="n">Successfully</span> <span class="n">uninstalled</span> <span class="n">myutils</span><span class="o">-</span><span class="mf">0.1</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>    <span class="n">Running</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span> <span class="k">for</span> <span class="n">myutils</span> <span class="o">...</span> <span class="n">done</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="n">Successfully</span> <span class="n">installed</span> <span class="n">myutils</span><span class="o">-</span><span class="mf">0.1</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 1 : il faut être dans le dossier <strong>[packages]</strong> pour taper cette instruction ;
Le code du script <strong>[server_01]</strong> se poursuit de la façon suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="err">…</span>    
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>    <span class="c1"># des erreurs ?</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>    <span class="k">if</span> <span class="n">erreurs</span><span class="p">:</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>        <span class="c1"># on envoie une réponse d&#39;erreur au client</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>        <span class="n">résultats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;erreurs&quot;</span><span class="p">:</span> <span class="n">erreurs</span><span class="p">}}</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>        <span class="k">return</span> <span class="n">json_response</span><span class="p">(</span><span class="n">résultats</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a>    <span class="c1"># pas d&#39;erreurs, on peut travailler</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>    <span class="c1"># calcul de l&#39;impôt</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a>    <span class="n">taxpayer</span> <span class="o">=</span> <span class="n">TaxPayer</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="n">marié</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="n">enfants</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="n">salaire</span><span class="p">})</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;métier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">taxpayer</span><span class="p">,</span> <span class="n">admindata</span><span class="p">)</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>    <span class="c1"># on envoie la réponse au client</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a>    <span class="k">return</span> <span class="n">json_response</span><span class="p">({</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">taxpayer</span><span class="o">.</span><span class="n">asdict</span><span class="p">()}},</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 10 : lorsqu’on est là, les paramètres attendus dans l’URL sont là et sont corrects ;</li>
<li>ligne 10 : on crée l’objet <strong>[TaxPayer]</strong> qui modélise le contribuable ;</li>
<li>ligne 11 : on demande à la couche <strong>[métier]</strong> de calculer l’impôt. On rappelle que les éléments calculés par la couche <strong>[métier]</strong> sont insérés dans l’objet <strong>[taxpayer]</strong> passé en paramètre ;</li>
<li>ligne 13 : la réponse est envoyée au client web sous la forme d’une chaîne jSON. Celle-ci est la chaîne jSON d’un dictionnaire. Associé à la clé <strong>[result]</strong>, on y met le dictionnaire de l’objet <strong>[taxpayer]</strong>. On ne pouvait pas mettre l’objet <strong>[taxpayer]</strong> lui-même car celui-ci n’est pas sérialisable en jSON ;
On crée deux configurations d’exécution, une pour MySQL, l’autre pour PostgreSQL :</li>
</ul>
<p><img src="images/10000000000003D1000001DC0EF38F9B.png" style="width:11.27cm;height:5.49cm;" alt="Image" /></p>
<p>Voici quelques exemples d’exécution (vous avez lancé l’application <strong>[server_01]</strong> et le SGBD utilisé puis vous demandez l’URL <a href="http://localhost:5000/"><u><u>http://localhost:5000/</u></u></a> avec un navigateur) :</p>
<p><img src="images/10000000000005670000011B8C582729.png" style="width:15.971cm;height:3.271cm;" alt="Image" /></p>
<p><img src="images/10000000000005160000014CA6697955.png" style="width:15.041cm;height:3.83cm;" alt="Image" /></p>
<p>Voici un exemple d’exécution dans la console de Postman :</p>
<p><img src="images/1000000000000518000001542807413B.png" style="width:15.02cm;height:3.931cm;" alt="Image" /></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="n">GET</span> <span class="o">/</span><span class="err">?</span><span class="n">mari</span><span class="o">%</span><span class="n">C3</span><span class="o">%</span><span class="n">A9</span><span class="o">=</span><span class="n">xx</span><span class="o">&amp;</span><span class="n">enfants</span><span class="o">=</span><span class="n">yy</span><span class="o">&amp;</span><span class="n">salaire</span><span class="o">=</span><span class="n">zz</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:</span> <span class="n">PostmanRuntime</span><span class="o">/</span><span class="mf">7.26.1</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="n">Accept</span><span class="p">:</span> <span class="o">*/*</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="p">:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="n">Postman</span><span class="o">-</span><span class="n">Token</span><span class="p">:</span> <span class="n">e4c5df8c</span><span class="o">-</span><span class="mi">4</span><span class="n">bd6</span><span class="o">-</span><span class="mi">4250</span><span class="o">-</span><span class="n">b789</span><span class="o">-</span><span class="n">b7b164db4eff</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="n">Host</span><span class="p">:</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">5000</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">br</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">400</span> <span class="n">BAD</span> <span class="n">REQUEST</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">134</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="n">Server</span><span class="p">:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">1.0.1</span> <span class="n">Python</span><span class="o">/</span><span class="mf">3.8.1</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="n">Date</span><span class="p">:</span> <span class="n">Fri</span><span class="p">,</span> <span class="mi">17</span> <span class="n">Jul</span> <span class="mi">2020</span> <span class="mi">06</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">44</span> <span class="n">GMT</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;erreurs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;paramètre marié [xx] invalide&quot;</span><span class="p">,</span> <span class="s2">&quot;paramètre enfants [yy] invalide&quot;</span><span class="p">,</span> <span class="s2">&quot;paramètre salaire [zz] invalide&quot;</span><span class="p">]}}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 1 : une URL incorrecte est demandée ;</li>
<li>ligne 10 : le serveur répond avec le statut 400 BAD REQUEST ;</li>
</ul>
<h3 id="2322-version-2">23.2.2. Version 2</h3>
<p><img src="images/100000000000014000000170F726DD2A.png" style="width:3.693cm;height:4.245cm;" alt="Image" /></p>
<p>La version 2 du serveur isole le traitement de l’URL dans le module <strong>[index_controller]</strong> <strong>[5]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span>
<span class="normal"><a href="#__codelineno-11-31">31</a></span>
<span class="normal"><a href="#__codelineno-11-32">32</a></span>
<span class="normal"><a href="#__codelineno-11-33">33</a></span>
<span class="normal"><a href="#__codelineno-11-34">34</a></span>
<span class="normal"><a href="#__codelineno-11-35">35</a></span>
<span class="normal"><a href="#__codelineno-11-36">36</a></span>
<span class="normal"><a href="#__codelineno-11-37">37</a></span>
<span class="normal"><a href="#__codelineno-11-38">38</a></span>
<span class="normal"><a href="#__codelineno-11-39">39</a></span>
<span class="normal"><a href="#__codelineno-11-40">40</a></span>
<span class="normal"><a href="#__codelineno-11-41">41</a></span>
<span class="normal"><a href="#__codelineno-11-42">42</a></span>
<span class="normal"><a href="#__codelineno-11-43">43</a></span>
<span class="normal"><a href="#__codelineno-11-44">44</a></span>
<span class="normal"><a href="#__codelineno-11-45">45</a></span>
<span class="normal"><a href="#__codelineno-11-46">46</a></span>
<span class="normal"><a href="#__codelineno-11-47">47</a></span>
<span class="normal"><a href="#__codelineno-11-48">48</a></span>
<span class="normal"><a href="#__codelineno-11-49">49</a></span>
<span class="normal"><a href="#__codelineno-11-50">50</a></span>
<span class="normal"><a href="#__codelineno-11-51">51</a></span>
<span class="normal"><a href="#__codelineno-11-52">52</a></span>
<span class="normal"><a href="#__codelineno-11-53">53</a></span>
<span class="normal"><a href="#__codelineno-11-54">54</a></span>
<span class="normal"><a href="#__codelineno-11-55">55</a></span>
<span class="normal"><a href="#__codelineno-11-56">56</a></span>
<span class="normal"><a href="#__codelineno-11-57">57</a></span>
<span class="normal"><a href="#__codelineno-11-58">58</a></span>
<span class="normal"><a href="#__codelineno-11-59">59</a></span>
<span class="normal"><a href="#__codelineno-11-60">60</a></span>
<span class="normal"><a href="#__codelineno-11-61">61</a></span>
<span class="normal"><a href="#__codelineno-11-62">62</a></span>
<span class="normal"><a href="#__codelineno-11-63">63</a></span>
<span class="normal"><a href="#__codelineno-11-64">64</a></span>
<span class="normal"><a href="#__codelineno-11-65">65</a></span>
<span class="normal"><a href="#__codelineno-11-66">66</a></span>
<span class="normal"><a href="#__codelineno-11-67">67</a></span>
<span class="normal"><a href="#__codelineno-11-68">68</a></span>
<span class="normal"><a href="#__codelineno-11-69">69</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1"># import des dépendances</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalProxy</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="c1"># URL paramétrée : /?marié=xx&amp;enfants=yy&amp;salaire=zz</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">LocalProxy</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>    <span class="c1"># dépendances</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">TaxPayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaxPayer</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a>    <span class="c1"># au départ pas d&#39;erreurs</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a>    <span class="n">erreurs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a>    <span class="c1"># la requête doit avoir trois paramètres</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a>        <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Méthode GET requise avec les seuls paramètres [marié, enfants, salaire]&quot;</span><span class="p">)</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a>    <span class="c1"># on récupère le statut marital de l&#39;URL</span>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a>    <span class="n">marié</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;marié&#39;</span><span class="p">)</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a>    <span class="k">if</span> <span class="n">marié</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a>        <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;paramètre [marié] manquant&quot;</span><span class="p">)</span>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a>        <span class="n">marié</span> <span class="o">=</span> <span class="n">marié</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a>        <span class="n">erreur</span> <span class="o">=</span> <span class="n">marié</span> <span class="o">!=</span> <span class="s2">&quot;oui&quot;</span> <span class="ow">and</span> <span class="n">marié</span> <span class="o">!=</span> <span class="s2">&quot;non&quot;</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a>        <span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a>            <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;paramétre marié [</span><span class="si">{</span><span class="n">marié</span><span class="si">}</span><span class="s2">] invalide&quot;</span><span class="p">)</span>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a>
<a id="__codelineno-11-29" name="__codelineno-11-29"></a>    <span class="c1"># on récupère le nombre d&#39;enfants de l&#39;URL</span>
<a id="__codelineno-11-30" name="__codelineno-11-30"></a>    <span class="n">enfants</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enfants&#39;</span><span class="p">)</span>
<a id="__codelineno-11-31" name="__codelineno-11-31"></a>    <span class="k">if</span> <span class="n">enfants</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-11-32" name="__codelineno-11-32"></a>        <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;paramètre [enfants] manquant&quot;</span><span class="p">)</span>
<a id="__codelineno-11-33" name="__codelineno-11-33"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-11-34" name="__codelineno-11-34"></a>        <span class="n">enfants</span> <span class="o">=</span> <span class="n">enfants</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-11-35" name="__codelineno-11-35"></a>        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\d+&quot;</span><span class="p">,</span> <span class="n">enfants</span><span class="p">)</span>
<a id="__codelineno-11-36" name="__codelineno-11-36"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-11-37" name="__codelineno-11-37"></a>            <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;paramétre enfants </span><span class="si">{</span><span class="n">enfants</span><span class="si">}</span><span class="s2"> invalide&quot;</span><span class="p">)</span>
<a id="__codelineno-11-38" name="__codelineno-11-38"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-11-39" name="__codelineno-11-39"></a>            <span class="n">enfants</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">enfants</span><span class="p">)</span>
<a id="__codelineno-11-40" name="__codelineno-11-40"></a>
<a id="__codelineno-11-41" name="__codelineno-11-41"></a>    <span class="c1"># on récupère le salaire de l&#39;URL</span>
<a id="__codelineno-11-42" name="__codelineno-11-42"></a>    <span class="n">salaire</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;salaire&#39;</span><span class="p">)</span>
<a id="__codelineno-11-43" name="__codelineno-11-43"></a>    <span class="k">if</span> <span class="n">salaire</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-11-44" name="__codelineno-11-44"></a>        <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;paramètre [salaire] manquant&quot;</span><span class="p">)</span>
<a id="__codelineno-11-45" name="__codelineno-11-45"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-11-46" name="__codelineno-11-46"></a>        <span class="n">salaire</span> <span class="o">=</span> <span class="n">salaire</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-11-47" name="__codelineno-11-47"></a>        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\d+&quot;</span><span class="p">,</span> <span class="n">salaire</span><span class="p">)</span>
<a id="__codelineno-11-48" name="__codelineno-11-48"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-11-49" name="__codelineno-11-49"></a>            <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;paramétre salaire </span><span class="si">{</span><span class="n">salaire</span><span class="si">}</span><span class="s2"> invalide&quot;</span><span class="p">)</span>
<a id="__codelineno-11-50" name="__codelineno-11-50"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-11-51" name="__codelineno-11-51"></a>            <span class="n">salaire</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">salaire</span><span class="p">)</span>
<a id="__codelineno-11-52" name="__codelineno-11-52"></a>
<a id="__codelineno-11-53" name="__codelineno-11-53"></a>    <span class="c1"># autres paramètres dans l&#39;URL ?</span>
<a id="__codelineno-11-54" name="__codelineno-11-54"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-11-55" name="__codelineno-11-55"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;marié&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">]:</span>
<a id="__codelineno-11-56" name="__codelineno-11-56"></a>            <span class="n">erreurs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;paramètre [</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">] invalide&quot;</span><span class="p">)</span>
<a id="__codelineno-11-57" name="__codelineno-11-57"></a>
<a id="__codelineno-11-58" name="__codelineno-11-58"></a>    <span class="c1"># des erreurs ?</span>
<a id="__codelineno-11-59" name="__codelineno-11-59"></a>    <span class="k">if</span> <span class="n">erreurs</span><span class="p">:</span>
<a id="__codelineno-11-60" name="__codelineno-11-60"></a>        <span class="c1"># on envoie une réponse d&#39;erreur au client</span>
<a id="__codelineno-11-61" name="__codelineno-11-61"></a>        <span class="n">résultats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;erreurs&quot;</span><span class="p">:</span> <span class="n">erreurs</span><span class="p">}}</span>
<a id="__codelineno-11-62" name="__codelineno-11-62"></a>        <span class="k">return</span> <span class="n">résultats</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
<a id="__codelineno-11-63" name="__codelineno-11-63"></a>
<a id="__codelineno-11-64" name="__codelineno-11-64"></a>    <span class="c1"># pas d&#39;erreurs, on peut travailler</span>
<a id="__codelineno-11-65" name="__codelineno-11-65"></a>    <span class="c1"># calcul de l&#39;impôt</span>
<a id="__codelineno-11-66" name="__codelineno-11-66"></a>    <span class="n">taxpayer</span> <span class="o">=</span> <span class="n">TaxPayer</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="n">marié</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="n">enfants</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="n">salaire</span><span class="p">})</span>
<a id="__codelineno-11-67" name="__codelineno-11-67"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;métier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">taxpayer</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;admindata&quot;</span><span class="p">])</span>
<a id="__codelineno-11-68" name="__codelineno-11-68"></a>    <span class="c1"># on envoie la réponse au client</span>
<a id="__codelineno-11-69" name="__codelineno-11-69"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">taxpayer</span><span class="o">.</span><span class="n">asdict</span><span class="p">()}},</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 9 : la fonction <strong>[execute]</strong> reçoit deux paramètres :</li>
<li><strong>[request]</strong> : la requête HTTP du client ;</li>
<li><strong>[config]</strong> : le dictionnaire de configuration de l’application ;
Le script <strong>[server_02]</strong> est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span>
<span class="normal"><a href="#__codelineno-12-22">22</a></span>
<span class="normal"><a href="#__codelineno-12-23">23</a></span>
<span class="normal"><a href="#__codelineno-12-24">24</a></span>
<span class="normal"><a href="#__codelineno-12-25">25</a></span>
<span class="normal"><a href="#__codelineno-12-26">26</a></span>
<span class="normal"><a href="#__codelineno-12-27">27</a></span>
<span class="normal"><a href="#__codelineno-12-28">28</a></span>
<span class="normal"><a href="#__codelineno-12-29">29</a></span>
<span class="normal"><a href="#__codelineno-12-30">30</a></span>
<span class="normal"><a href="#__codelineno-12-31">31</a></span>
<span class="normal"><a href="#__codelineno-12-32">32</a></span>
<span class="normal"><a href="#__codelineno-12-33">33</a></span>
<span class="normal"><a href="#__codelineno-12-34">34</a></span>
<span class="normal"><a href="#__codelineno-12-35">35</a></span>
<span class="normal"><a href="#__codelineno-12-36">36</a></span>
<span class="normal"><a href="#__codelineno-12-37">37</a></span>
<span class="normal"><a href="#__codelineno-12-38">38</a></span>
<span class="normal"><a href="#__codelineno-12-39">39</a></span>
<span class="normal"><a href="#__codelineno-12-40">40</a></span>
<span class="normal"><a href="#__codelineno-12-41">41</a></span>
<span class="normal"><a href="#__codelineno-12-42">42</a></span>
<span class="normal"><a href="#__codelineno-12-43">43</a></span>
<span class="normal"><a href="#__codelineno-12-44">44</a></span>
<span class="normal"><a href="#__codelineno-12-45">45</a></span>
<span class="normal"><a href="#__codelineno-12-46">46</a></span>
<span class="normal"><a href="#__codelineno-12-47">47</a></span>
<span class="normal"><a href="#__codelineno-12-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="c1"># on attend un paramètre mysql ou pgres</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="n">syntaxe</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> mysql / pgres&quot;</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="n">erreur</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a>    <span class="n">sgbd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;mysql&quot;</span> <span class="ow">and</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;pgres&quot;</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syntaxe : </span><span class="si">{</span><span class="n">syntaxe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s1">&#39;sgbd&#39;</span><span class="p">:</span> <span class="n">sgbd</span><span class="p">})</span>
<a id="__codelineno-12-15" name="__codelineno-12-15"></a>
<a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="c1"># dépendances</span>
<a id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span>
<a id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="kn">from</span><span class="w"> </span><span class="nn">myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">json_response</span>
<a id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span>
<a id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="kn">import</span><span class="w"> </span><span class="nn">index_controller</span>
<a id="__codelineno-12-22" name="__codelineno-12-22"></a>
<a id="__codelineno-12-23" name="__codelineno-12-23"></a><span class="c1"># récupération des données de l&#39;administration fiscale</span>
<a id="__codelineno-12-24" name="__codelineno-12-24"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-12-25" name="__codelineno-12-25"></a>    <span class="c1"># admindata sera une donnée de portée application en lecture seule</span>
<a id="__codelineno-12-26" name="__codelineno-12-26"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;admindata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_admindata</span><span class="p">()</span>
<a id="__codelineno-12-27" name="__codelineno-12-27"></a><span class="k">except</span> <span class="n">ImpôtsError</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-12-28" name="__codelineno-12-28"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-12-29" name="__codelineno-12-29"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-12-30" name="__codelineno-12-30"></a>
<a id="__codelineno-12-31" name="__codelineno-12-31"></a><span class="c1"># application Flask</span>
<a id="__codelineno-12-32" name="__codelineno-12-32"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-12-33" name="__codelineno-12-33"></a>
<a id="__codelineno-12-34" name="__codelineno-12-34"></a>
<a id="__codelineno-12-35" name="__codelineno-12-35"></a><span class="c1"># Home URL : /?marié=xx&amp;enfant=yy&amp;salaire=zz</span>
<a id="__codelineno-12-36" name="__codelineno-12-36"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-12-37" name="__codelineno-12-37"></a><span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
<a id="__codelineno-12-38" name="__codelineno-12-38"></a>    <span class="c1"># on exécute la requête</span>
<a id="__codelineno-12-39" name="__codelineno-12-39"></a>    <span class="n">résultat</span><span class="p">,</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">index_controller</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-12-40" name="__codelineno-12-40"></a>    <span class="c1"># on envoie la réponse</span>
<a id="__codelineno-12-41" name="__codelineno-12-41"></a>    <span class="k">return</span> <span class="n">json_response</span><span class="p">(</span><span class="n">résultat</span><span class="p">,</span> <span class="n">statusCode</span><span class="p">)</span>
<a id="__codelineno-12-42" name="__codelineno-12-42"></a>
<a id="__codelineno-12-43" name="__codelineno-12-43"></a>
<a id="__codelineno-12-44" name="__codelineno-12-44"></a><span class="c1"># main uniquement</span>
<a id="__codelineno-12-45" name="__codelineno-12-45"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-12-46" name="__codelineno-12-46"></a>    <span class="c1"># on lance le serveur</span>
<a id="__codelineno-12-47" name="__codelineno-12-47"></a>    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ENV</span><span class="o">=</span><span class="s2">&quot;development&quot;</span><span class="p">,</span> <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-12-48" name="__codelineno-12-48"></a>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 36-41 : le traitement de la route / ;</li>
<li>ligne 39 : utilisation de la fonction <strong>[</strong><strong>IndexController</strong><strong>.execute</strong><strong>]</strong> ;
Nous utiliserons désormais cette technique : chaque route sera traitée par un module qui lui sera propre.</li>
</ul>
<p>Les résultats d’exécution sont les mêmes que pour la version 1.</p>
<h3 id="2323-version-3">23.2.3. Version 3</h3>
<p>La version 3 introduit la notion d’authentification.</p>
<p>Le script <strong>[server_03]</strong> devient le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span>
<span class="normal"><a href="#__codelineno-13-15">15</a></span>
<span class="normal"><a href="#__codelineno-13-16">16</a></span>
<span class="normal"><a href="#__codelineno-13-17">17</a></span>
<span class="normal"><a href="#__codelineno-13-18">18</a></span>
<span class="normal"><a href="#__codelineno-13-19">19</a></span>
<span class="normal"><a href="#__codelineno-13-20">20</a></span>
<span class="normal"><a href="#__codelineno-13-21">21</a></span>
<span class="normal"><a href="#__codelineno-13-22">22</a></span>
<span class="normal"><a href="#__codelineno-13-23">23</a></span>
<span class="normal"><a href="#__codelineno-13-24">24</a></span>
<span class="normal"><a href="#__codelineno-13-25">25</a></span>
<span class="normal"><a href="#__codelineno-13-26">26</a></span>
<span class="normal"><a href="#__codelineno-13-27">27</a></span>
<span class="normal"><a href="#__codelineno-13-28">28</a></span>
<span class="normal"><a href="#__codelineno-13-29">29</a></span>
<span class="normal"><a href="#__codelineno-13-30">30</a></span>
<span class="normal"><a href="#__codelineno-13-31">31</a></span>
<span class="normal"><a href="#__codelineno-13-32">32</a></span>
<span class="normal"><a href="#__codelineno-13-33">33</a></span>
<span class="normal"><a href="#__codelineno-13-34">34</a></span>
<span class="normal"><a href="#__codelineno-13-35">35</a></span>
<span class="normal"><a href="#__codelineno-13-36">36</a></span>
<span class="normal"><a href="#__codelineno-13-37">37</a></span>
<span class="normal"><a href="#__codelineno-13-38">38</a></span>
<span class="normal"><a href="#__codelineno-13-39">39</a></span>
<span class="normal"><a href="#__codelineno-13-40">40</a></span>
<span class="normal"><a href="#__codelineno-13-41">41</a></span>
<span class="normal"><a href="#__codelineno-13-42">42</a></span>
<span class="normal"><a href="#__codelineno-13-43">43</a></span>
<span class="normal"><a href="#__codelineno-13-44">44</a></span>
<span class="normal"><a href="#__codelineno-13-45">45</a></span>
<span class="normal"><a href="#__codelineno-13-46">46</a></span>
<span class="normal"><a href="#__codelineno-13-47">47</a></span>
<span class="normal"><a href="#__codelineno-13-48">48</a></span>
<span class="normal"><a href="#__codelineno-13-49">49</a></span>
<span class="normal"><a href="#__codelineno-13-50">50</a></span>
<span class="normal"><a href="#__codelineno-13-51">51</a></span>
<span class="normal"><a href="#__codelineno-13-52">52</a></span>
<span class="normal"><a href="#__codelineno-13-53">53</a></span>
<span class="normal"><a href="#__codelineno-13-54">54</a></span>
<span class="normal"><a href="#__codelineno-13-55">55</a></span>
<span class="normal"><a href="#__codelineno-13-56">56</a></span>
<span class="normal"><a href="#__codelineno-13-57">57</a></span>
<span class="normal"><a href="#__codelineno-13-58">58</a></span>
<span class="normal"><a href="#__codelineno-13-59">59</a></span>
<span class="normal"><a href="#__codelineno-13-60">60</a></span>
<span class="normal"><a href="#__codelineno-13-61">61</a></span>
<span class="normal"><a href="#__codelineno-13-62">62</a></span>
<span class="normal"><a href="#__codelineno-13-63">63</a></span>
<span class="normal"><a href="#__codelineno-13-64">64</a></span>
<span class="normal"><a href="#__codelineno-13-65">65</a></span>
<span class="normal"><a href="#__codelineno-13-66">66</a></span>
<span class="normal"><a href="#__codelineno-13-67">67</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1"># on attend un paramètre mysql ou pgres</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="n">syntaxe</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> mysql / pgres&quot;</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="n">erreur</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a>    <span class="n">sgbd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;mysql&quot;</span> <span class="ow">and</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;pgres&quot;</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syntaxe : </span><span class="si">{</span><span class="n">syntaxe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s1">&#39;sgbd&#39;</span><span class="p">:</span> <span class="n">sgbd</span><span class="p">})</span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="c1"># dépendances</span>
<a id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-13-18" name="__codelineno-13-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span>
<a id="__codelineno-13-19" name="__codelineno-13-19"></a><span class="kn">from</span><span class="w"> </span><span class="nn">myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">json_response</span>
<a id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span>
<a id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_httpauth</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<a id="__codelineno-13-22" name="__codelineno-13-22"></a><span class="kn">import</span><span class="w"> </span><span class="nn">index_controller</span>
<a id="__codelineno-13-23" name="__codelineno-13-23"></a>
<a id="__codelineno-13-24" name="__codelineno-13-24"></a><span class="c1"># récupération des données de l&#39;administration fiscale</span>
<a id="__codelineno-13-25" name="__codelineno-13-25"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-13-26" name="__codelineno-13-26"></a>    <span class="c1"># config[‘admindata’] sera une donnée de portée application en lecture seule</span>
<a id="__codelineno-13-27" name="__codelineno-13-27"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;admindata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_admindata</span><span class="p">()</span>
<a id="__codelineno-13-28" name="__codelineno-13-28"></a><span class="k">except</span> <span class="n">ImpôtsError</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-13-29" name="__codelineno-13-29"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-13-30" name="__codelineno-13-30"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-13-31" name="__codelineno-13-31"></a>
<a id="__codelineno-13-32" name="__codelineno-13-32"></a><span class="c1"># gestionnaire d&#39;authentification</span>
<a id="__codelineno-13-33" name="__codelineno-13-33"></a><span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>
<a id="__codelineno-13-34" name="__codelineno-13-34"></a>
<a id="__codelineno-13-35" name="__codelineno-13-35"></a>
<a id="__codelineno-13-36" name="__codelineno-13-36"></a><span class="c1"># méthode d&#39;authentification</span>
<a id="__codelineno-13-37" name="__codelineno-13-37"></a><span class="nd">@auth</span><span class="o">.</span><span class="n">verify_password</span>
<a id="__codelineno-13-38" name="__codelineno-13-38"></a><span class="k">def</span><span class="w"> </span><span class="nf">verify_credentials</span><span class="p">(</span><span class="n">login</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-13-39" name="__codelineno-13-39"></a>    <span class="c1"># liste des utilisateurs</span>
<a id="__codelineno-13-40" name="__codelineno-13-40"></a>    <span class="n">users</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
<a id="__codelineno-13-41" name="__codelineno-13-41"></a>    <span class="c1"># on parcourt cette liste</span>
<a id="__codelineno-13-42" name="__codelineno-13-42"></a>    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
<a id="__codelineno-13-43" name="__codelineno-13-43"></a>        <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;login&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">login</span> <span class="ow">and</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">password</span><span class="p">:</span>
<a id="__codelineno-13-44" name="__codelineno-13-44"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-13-45" name="__codelineno-13-45"></a>    <span class="c1"># on n&#39;a pas trouvé</span>
<a id="__codelineno-13-46" name="__codelineno-13-46"></a>    <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-13-47" name="__codelineno-13-47"></a>
<a id="__codelineno-13-48" name="__codelineno-13-48"></a>
<a id="__codelineno-13-49" name="__codelineno-13-49"></a><span class="c1"># application Flask</span>
<a id="__codelineno-13-50" name="__codelineno-13-50"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-13-51" name="__codelineno-13-51"></a>
<a id="__codelineno-13-52" name="__codelineno-13-52"></a>
<a id="__codelineno-13-53" name="__codelineno-13-53"></a><span class="c1"># Home URL : /?marié=xx&amp;enfant=yy&amp;salaire=zz</span>
<a id="__codelineno-13-54" name="__codelineno-13-54"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-13-55" name="__codelineno-13-55"></a><span class="nd">@auth</span><span class="o">.</span><span class="n">login_required</span>
<a id="__codelineno-13-56" name="__codelineno-13-56"></a><span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
<a id="__codelineno-13-57" name="__codelineno-13-57"></a>    <span class="c1"># on exécute la requête</span>
<a id="__codelineno-13-58" name="__codelineno-13-58"></a>    <span class="n">résultat</span><span class="p">,</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">index_controller</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-13-59" name="__codelineno-13-59"></a>    <span class="c1"># on envoie la réponse</span>
<a id="__codelineno-13-60" name="__codelineno-13-60"></a>    <span class="k">return</span> <span class="n">json_response</span><span class="p">(</span><span class="n">résultat</span><span class="p">,</span> <span class="n">statusCode</span><span class="p">)</span>
<a id="__codelineno-13-61" name="__codelineno-13-61"></a>
<a id="__codelineno-13-62" name="__codelineno-13-62"></a>
<a id="__codelineno-13-63" name="__codelineno-13-63"></a><span class="c1"># main uniquement</span>
<a id="__codelineno-13-64" name="__codelineno-13-64"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-13-65" name="__codelineno-13-65"></a>    <span class="c1"># on lance le serveur</span>
<a id="__codelineno-13-66" name="__codelineno-13-66"></a>    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ENV</span><span class="o">=</span><span class="s2">&quot;development&quot;</span><span class="p">,</span> <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-13-67" name="__codelineno-13-67"></a>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 21 : on importe un gestionnaire d’authentification. Il existe divers types d’authentification auprès d’un serveur web. Celle que nous utilisons ici s’appelle <strong>[HTTP Basic]</strong>. Chaque type d’authentification suit un dialogue client / serveur précis ;</li>
<li>ligne 33 : on crée une instance du gestionnaire d’authentification ;</li>
<li>ligne 37 : l’annotation <strong>[</strong><strong>@auth.verify_password</strong><strong>]</strong> tague la fonction à exécuter lorsque le gestionnaire d’authentification veut vérifier les login / password transmis par le client selon le protocole <strong>[HTTP Basic]</strong> ;</li>
<li>ligne 55 : l’annotation <strong>[</strong><strong>@auth.login_required</strong><strong>]</strong> tague une route pour laquelle le client web doit être authentifié. Si le client web n’a pas encore envoyé ses identifiants, le serveur web va automatiquement les lui demander selon le protocole HTTP basic ;
Le module <strong>[flask_httpauth]</strong> doit être installé :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="p">(</span><span class="n">venv</span><span class="p">)</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">impots</span>\<span class="n">http</span><span class="o">-</span><span class="n">servers</span>\<span class="mi">01</span>\<span class="n">flask</span><span class="o">&gt;</span><span class="n">pip</span> <span class="n">install</span> <span class="n">flask_httpauth</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="n">Collecting</span> <span class="n">flask_httpauth</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a>  <span class="n">Downloading</span> <span class="n">Flask_HTTPAuth</span><span class="o">-</span><span class="mf">4.1.0</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="nb">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mf">5.8</span> <span class="n">kB</span><span class="p">)</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">Flask</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>\<span class="n">data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span><span class="w"> </span><span class="nn">flask_httpauth</span><span class="p">)</span> <span class="p">(</span><span class="mf">1.1.2</span><span class="p">)</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">itsdangerous</span><span class="o">&gt;=</span><span class="mf">0.24</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>\<span class="n">data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span><span class="w"> </span><span class="nn">Flask</span><span class="o">-&gt;</span><span class="n">flask_httpauth</span><span class="p">)</span> <span class="p">(</span><span class="mf">1.1.0</span><span class="p">)</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">click</span><span class="o">&gt;=</span><span class="mf">5.1</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>\<span class="n">data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span><span class="w"> </span><span class="nn">Flask</span><span class="o">-&gt;</span><span class="n">flask_httpauth</span><span class="p">)</span> <span class="p">(</span><span class="mf">7.1.2</span><span class="p">)</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">Jinja2</span><span class="o">&gt;=</span><span class="mf">2.10.1</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>\<span class="n">data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span><span class="w"> </span><span class="nn">Flask</span><span class="o">-&gt;</span><span class="n">flask_httpauth</span><span class="p">)</span> <span class="p">(</span><span class="mf">2.11.2</span><span class="p">)</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">Werkzeug</span><span class="o">&gt;=</span><span class="mf">0.15</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>\<span class="n">data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span><span class="w"> </span><span class="nn">Flask</span><span class="o">-&gt;</span><span class="n">flask_httpauth</span><span class="p">)</span> <span class="p">(</span><span class="mf">1.0.1</span><span class="p">)</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">MarkupSafe</span><span class="o">&gt;=</span><span class="mf">0.23</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>\<span class="n">data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span><span class="w"> </span><span class="nn">Jinja2</span><span class="o">&gt;=</span><span class="mf">2.10.1</span><span class="o">-&gt;</span><span class="n">Flask</span><span class="o">-&gt;</span><span class="n">flask_httpauth</span><span class="p">)</span> <span class="p">(</span><span class="mf">1.1.1</span>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="p">)</span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="n">Installing</span> <span class="n">collected</span> <span class="n">packages</span><span class="p">:</span> <span class="n">flask</span><span class="o">-</span><span class="n">httpauth</span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="n">Successfully</span> <span class="n">installed</span> <span class="n">flask</span><span class="o">-</span><span class="n">httpauth</span><span class="o">-</span><span class="mf">4.1.0</span>
</code></pre></div></td></tr></table></div>
<p>Voyons ce qui se passe avec la console Postman. Vous :</p>
<ul>
<li>créez une configuration d’exécution ;</li>
<li>lancez l’application web ;</li>
<li>lancez le SGBD de votre choix ;</li>
<li>demandez l’URL <strong>[/]</strong> avec Postman ;
Le dialogue client / serveur dans la console Postman est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="n">GET</span> <span class="o">/</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:</span> <span class="n">PostmanRuntime</span><span class="o">/</span><span class="mf">7.26.1</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="n">Accept</span><span class="p">:</span> <span class="o">*/*</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="p">:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="n">Postman</span><span class="o">-</span><span class="n">Token</span><span class="p">:</span> <span class="n">e65e2a28</span><span class="o">-</span><span class="mi">4</span><span class="n">fe3</span><span class="o">-</span><span class="mi">423</span><span class="n">b</span><span class="o">-</span><span class="mi">88</span><span class="n">b3</span><span class="o">-</span><span class="n">b3e5a83092b1</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="n">Host</span><span class="p">:</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">5000</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">br</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a>
<a id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">401</span> <span class="n">UNAUTHORIZED</span>
<a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
<a id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">19</span>
<a id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="n">WWW</span><span class="o">-</span><span class="n">Authenticate</span><span class="p">:</span> <span class="n">Basic</span> <span class="n">realm</span><span class="o">=</span><span class="s2">&quot;Authentication Required&quot;</span>
<a id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="n">Server</span><span class="p">:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">1.0.1</span> <span class="n">Python</span><span class="o">/</span><span class="mf">3.8.1</span>
<a id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="n">Date</span><span class="p">:</span> <span class="n">Fri</span><span class="p">,</span> <span class="mi">17</span> <span class="n">Jul</span> <span class="mi">2020</span> <span class="mi">07</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">37</span> <span class="n">GMT</span>
<a id="__codelineno-15-16" name="__codelineno-15-16"></a>
<a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="n">Unauthorized</span> <span class="n">Access</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 10 : le serveur répond que nous ne sommes pas autorisés à accéder à l’URL <strong>[/]</strong> ;</li>
<li>ligne 13 : il nous indique le protocole d’authentification à utiliser, ici le protocole dit Authentification Basic ;
Il est possible de configurer Postman pour qu’il envoie les identifiants de l’utilisateur selon le protocole Auth Basic :</li>
</ul>
<p><img src="images/10000000000002AB000002667CD6689F.png" style="width:7.88cm;height:7.081cm;" alt="Image" /></p>
<ul>
<li>en <strong>[6-7]</strong> nous mettons les identifiants présents dans le script <strong>[config]</strong> :</li>
</ul>
<p><img src="images/1000000000000473000001DDA6DEE7F3.png" style="width:13.14cm;height:5.52cm;" alt="Image" /></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span>
<span class="normal"><a href="#__codelineno-16-3">3</a></span>
<span class="normal"><a href="#__codelineno-16-4">4</a></span>
<span class="normal"><a href="#__codelineno-16-5">5</a></span>
<span class="normal"><a href="#__codelineno-16-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a>        <span class="p">{</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a>            <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a>            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a>        <span class="p">}</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a>    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
<p>Le dialogue client / serveur dans la console Postman devient le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="n">GET</span> <span class="o">/</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="n">Authorization</span><span class="p">:</span> <span class="n">Basic</span> <span class="n">YWRtaW46YWRtaW4</span><span class="o">=</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:</span> <span class="n">PostmanRuntime</span><span class="o">/</span><span class="mf">7.26.1</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="n">Accept</span><span class="p">:</span> <span class="o">*/*</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="p">:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="n">Postman</span><span class="o">-</span><span class="n">Token</span><span class="p">:</span> <span class="mi">5</span><span class="n">ce20822</span><span class="o">-</span><span class="n">e87c</span><span class="o">-</span><span class="mi">4</span><span class="n">eef</span><span class="o">-</span><span class="n">a2f4</span><span class="o">-</span><span class="n">b9eaec38d881</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="n">Host</span><span class="p">:</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">5000</span>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">br</span>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">400</span> <span class="n">BAD</span> <span class="n">REQUEST</span>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">203</span>
<a id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="n">Server</span><span class="p">:</span> <span class="n">Werkzeug</span><span class="o">/</span><span class="mf">1.0.1</span> <span class="n">Python</span><span class="o">/</span><span class="mf">3.8.1</span>
<a id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="n">Date</span><span class="p">:</span> <span class="n">Fri</span><span class="p">,</span> <span class="mi">17</span> <span class="n">Jul</span> <span class="mi">2020</span> <span class="mi">07</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">01</span> <span class="n">GMT</span>
<a id="__codelineno-17-16" name="__codelineno-17-16"></a>
<a id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;erreurs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Méthode GET requise avec les seuls paramètres [marié, enfants, salaire]&quot;</span><span class="p">,</span> <span class="s2">&quot;paramètre [marié] manquant&quot;</span><span class="p">,</span> <span class="s2">&quot;paramètre [enfants] manquant&quot;</span><span class="p">,</span> <span class="s2">&quot;paramètre [salaire] manquant&quot;</span><span class="p">]}}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 2 : le client Postman envoie sous forme codée les identifiants de l’utilisateur <strong>[admin / admin]</strong> ;</li>
<li>ligne 17 : le serveur répond correctement. Il signale des erreurs car on n’a pas envoyé les paramètres <strong>[marié, enfants, salaire]</strong> (ligne 1) mais il ne signale pas d’erreur d’authentification ;
Maintenant demandons l’URL / avec un navigateur (Firefox ci-dessous) :</li>
</ul>
<p><img src="images/10000000000004730000018AC3848A39.png" style="width:13.14cm;height:4.541cm;" alt="Image" /></p>
<ul>
<li>comme avec Postman, Firefox a reçu la réponse HTTP du serveur avec les entêtes HTTP :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span>
<span class="normal"><a href="#__codelineno-18-3">3</a></span>
<span class="normal"><a href="#__codelineno-18-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">401</span> <span class="n">UNAUTHORIZED</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="err">…</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="n">WWW</span><span class="o">-</span><span class="n">Authenticate</span><span class="p">:</span> <span class="n">Basic</span> <span class="n">realm</span><span class="o">=</span><span class="s2">&quot;Authentication Required&quot;</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="err">…</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<p>Firefox comme d’autres navigateurs n’arrêtent pas le dialogue lorsqu’il reçoit ces entêtes. Il demandet à l’utilisateur les identifiants réclamés par le serveur. Il suffit ci-dessus de taper admin / admin pour recevoir la réponse du serveur :</p>
<p><img src="images/10000000000002F70000015FADE1EFB4.png" style="width:8.771cm;height:4.051cm;" alt="Image" /></p>
<h2 id="233-le-client-web-du-serveur-de-calcul-de-limpot">23.3. Le client web du serveur de calcul de l’impôt</h2>
<h3 id="2331-introduction">23.3.1. Introduction</h3>
<p>Dans le paragraphe précédent, le client web du serveur de calcul de l’impôt était un navigateur. Dans cette partie, le client web sera un script console. L’architecture devient la suivante :</p>
<p><img src="images/10000000000003BE000003E50F9DB416.png" style="width:11.06cm;height:11.51cm;" alt="Image" /></p>
<ul>
<li>le client web est formé des couches <strong>[1-2]</strong> ;</li>
<li>le serveur web est formé des couches <strong>[3-9]</strong>. Il a été écrit dans le paragraphe précédent ;
Il nous faut donc écrire les couches <strong>[1-2]</strong>.</li>
</ul>
<p>La couche <strong>[dao]</strong> <strong>[2]</strong> doit savoir communiquer avec le serveur web <strong>[3]</strong>. Nous connaissons maintenant le protocole HTTP et nous pourrions écrire, avec le module <strong>[pycurl]</strong> déjà étudié par exemple, un script communiquant avec le serveur web <strong>[3]</strong>. Cependant il existe des modules spécialisés dans les dialogues HTTP client / serveur. Nous allons utiliser l’un d’entre-eux, le module <strong>[requests]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="p">(</span><span class="n">venv</span><span class="p">)</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">impots</span>\<span class="n">http</span><span class="o">-</span><span class="n">servers</span>\<span class="mi">01</span>\<span class="n">flask</span><span class="o">&gt;</span><span class="n">pip</span> <span class="n">install</span> <span class="n">requests</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="n">Collecting</span> <span class="n">requests</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a>  <span class="n">Downloading</span> <span class="n">requests</span><span class="o">-</span><span class="mf">2.24.0</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="nb">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">61</span> <span class="n">kB</span><span class="p">)</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a>     <span class="o">||</span> <span class="mi">61</span> <span class="n">kB</span> <span class="mi">137</span> <span class="n">kB</span><span class="o">/</span><span class="n">s</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="n">Collecting</span> <span class="n">idna</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span><span class="o">&gt;=</span><span class="mf">2.5</span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a>  <span class="n">Downloading</span> <span class="n">idna</span><span class="o">-</span><span class="mf">2.10</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="nb">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">58</span> <span class="n">kB</span><span class="p">)</span>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a>     <span class="o">||</span> <span class="mi">58</span> <span class="n">kB</span> <span class="mi">692</span> <span class="n">kB</span><span class="o">/</span><span class="n">s</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="n">Collecting</span> <span class="n">chardet</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">,</span><span class="o">&gt;=</span><span class="mf">3.0.2</span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a>  <span class="n">Downloading</span> <span class="n">chardet</span><span class="o">-</span><span class="mf">3.0.4</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="nb">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">133</span> <span class="n">kB</span><span class="p">)</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a>     <span class="o">||</span> <span class="mi">133</span> <span class="n">kB</span> <span class="mf">1.3</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="n">Collecting</span> <span class="n">urllib3</span><span class="o">!=</span><span class="mf">1.25.0</span><span class="p">,</span><span class="o">!=</span><span class="mf">1.25.1</span><span class="p">,</span><span class="o">&lt;</span><span class="mf">1.26</span><span class="p">,</span><span class="o">&gt;=</span><span class="mf">1.21.1</span>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a>  <span class="n">Downloading</span> <span class="n">urllib3</span><span class="o">-</span><span class="mf">1.25.9</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="nb">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">126</span> <span class="n">kB</span><span class="p">)</span>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a>     <span class="o">||</span> <span class="mi">126</span> <span class="n">kB</span> <span class="mf">1.1</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="n">Collecting</span> <span class="n">certifi</span><span class="o">&gt;=</span><span class="mf">2017.4.17</span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a>  <span class="n">Downloading</span> <span class="n">certifi</span><span class="o">-</span><span class="mf">2020.6.20</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="nb">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">156</span> <span class="n">kB</span><span class="p">)</span>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a>     <span class="o">||</span> <span class="mi">156</span> <span class="n">kB</span> <span class="mf">1.1</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="n">Installing</span> <span class="n">collected</span> <span class="n">packages</span><span class="p">:</span> <span class="n">idna</span><span class="p">,</span> <span class="n">chardet</span><span class="p">,</span> <span class="n">urllib3</span><span class="p">,</span> <span class="n">certifi</span><span class="p">,</span> <span class="n">requests</span>
<a id="__codelineno-19-18" name="__codelineno-19-18"></a><span class="n">Successfully</span> <span class="n">installed</span> <span class="n">certifi</span><span class="o">-</span><span class="mf">2020.6.20</span> <span class="n">chardet</span><span class="o">-</span><span class="mf">3.0.4</span> <span class="n">idna</span><span class="o">-</span><span class="mf">2.10</span> <span class="n">requests</span><span class="o">-</span><span class="mf">2.24.0</span> <span class="n">urllib3</span><span class="o">-</span><span class="mf">1.25.9</span>
</code></pre></div></td></tr></table></div>
<p>L’arborescence des scripts du client web est la suivante :</p>
<p><img src="images/10000000000002060000022310C37CE5.png" style="width:5.991cm;height:6.331cm;" alt="Image" /></p>
<p>Le script va implémenter l’application de calcul de l’impôt en mode batch décrite dès la |<a href="#_Version_1"><u><u>version 1</u></u></a>|. La dernière version de cette application est la |<a href="#_Application_2_:"><u><u>version 5</u></u></a>|. On rappelle son fonctionnement :</p>
<ul>
<li>
<p>les contribuables dont on va calculer l’impôt sont rassemblés dans le fichier texte <strong>[taxpayersdata.txt]</strong> :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span>
<span class="normal"><a href="#__codelineno-20-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="c1"># données valides : id, marié, enfants, salaire</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="mi">1</span><span class="p">,</span><span class="n">oui</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">55555</span>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="mi">2</span><span class="p">,</span><span class="n">oui</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">50000</span>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="mi">3</span><span class="p">,</span><span class="n">oui</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">50000</span>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="mi">4</span><span class="p">,</span><span class="n">non</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">100000</span>
<a id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="mi">5</span><span class="p">,</span><span class="n">non</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">100000</span>
<a id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="mi">6</span><span class="p">,</span><span class="n">oui</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">100000</span>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="mi">7</span><span class="p">,</span><span class="n">oui</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">100000</span>
<a id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="mi">8</span><span class="p">,</span><span class="n">non</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100000</span>
<a id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="mi">9</span><span class="p">,</span><span class="n">oui</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">30000</span>
<a id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="mi">10</span><span class="p">,</span><span class="n">non</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">200000</span>
<a id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="mi">11</span><span class="p">,</span><span class="n">oui</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">200000</span>
<a id="__codelineno-20-13" name="__codelineno-20-13"></a><span class="c1"># on crée des lignes erronées</span>
<a id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="c1"># pas assez de valeurs</span>
<a id="__codelineno-20-15" name="__codelineno-20-15"></a><span class="mi">11</span><span class="p">,</span><span class="mi">12</span>
<a id="__codelineno-20-16" name="__codelineno-20-16"></a><span class="c1"># des valeurs erronées</span>
<a id="__codelineno-20-17" name="__codelineno-20-17"></a><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">x</span>
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>les résultats vont dans deux fichiers :</p>
</li>
<li>
<p>le fichier texte <strong>[errors.txt]</strong> rassemble les erreurs détectées dans le fichier des contribuables :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span>
<span class="normal"><a href="#__codelineno-21-2">2</a></span>
<span class="normal"><a href="#__codelineno-21-3">3</a></span>
<span class="normal"><a href="#__codelineno-21-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="n">Analyse</span> <span class="n">du</span> <span class="n">fichier</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">impots</span>\<span class="n">http</span><span class="o">-</span><span class="n">clients</span>\<span class="mi">01</span>\<span class="n">main</span><span class="o">/../</span><span class="n">data</span><span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">taxpayersdata</span><span class="o">.</span><span class="n">txt</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="n">Ligne</span> <span class="mi">15</span><span class="p">,</span> <span class="ow">not</span> <span class="n">enough</span> <span class="n">values</span> <span class="n">to</span> <span class="n">unpack</span> <span class="p">(</span><span class="n">expected</span> <span class="mi">4</span><span class="p">,</span> <span class="n">got</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="n">Ligne</span> <span class="mi">17</span><span class="p">,</span> <span class="n">MyException</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">L</span><span class="s1">&#39;identifiant d&#39;</span><span class="n">une</span> <span class="n">entité</span> <span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="err">&#39;</span><span class="nc">TaxPayer</span><span class="o">.</span><span class="n">TaxPayer</span><span class="s1">&#39;&gt; doit être un entier &gt;=0]</span>
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>le fichier jSON <strong>[résultats.json]</strong> rassemble les résultats des calculs de l’impôt des différents contribuables :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span>
<span class="normal"><a href="#__codelineno-22-12">12</a></span>
<span class="normal"><a href="#__codelineno-22-13">13</a></span>
<span class="normal"><a href="#__codelineno-22-14">14</a></span>
<span class="normal"><a href="#__codelineno-22-15">15</a></span>
<span class="normal"><a href="#__codelineno-22-16">16</a></span>
<span class="normal"><a href="#__codelineno-22-17">17</a></span>
<span class="normal"><a href="#__codelineno-22-18">18</a></span>
<span class="normal"><a href="#__codelineno-22-19">19</a></span>
<span class="normal"><a href="#__codelineno-22-20">20</a></span>
<span class="normal"><a href="#__codelineno-22-21">21</a></span>
<span class="normal"><a href="#__codelineno-22-22">22</a></span>
<span class="normal"><a href="#__codelineno-22-23">23</a></span>
<span class="normal"><a href="#__codelineno-22-24">24</a></span>
<span class="normal"><a href="#__codelineno-22-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="p">[</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a>  <span class="p">{</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a>    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a>    <span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a>    <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a>    <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">55555</span><span class="p">,</span>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a>    <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">2814</span><span class="p">,</span>
<a id="__codelineno-22-8" name="__codelineno-22-8"></a>    <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-22-9" name="__codelineno-22-9"></a>    <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span>
<a id="__codelineno-22-10" name="__codelineno-22-10"></a>    <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-22-11" name="__codelineno-22-11"></a>    <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span>
<a id="__codelineno-22-12" name="__codelineno-22-12"></a>  <span class="p">},</span>
<a id="__codelineno-22-13" name="__codelineno-22-13"></a>  <span class="p">{</span>
<a id="__codelineno-22-14" name="__codelineno-22-14"></a>    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-22-15" name="__codelineno-22-15"></a>    <span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span>
<a id="__codelineno-22-16" name="__codelineno-22-16"></a>    <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-22-17" name="__codelineno-22-17"></a>    <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span>
<a id="__codelineno-22-18" name="__codelineno-22-18"></a>    <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">1384</span><span class="p">,</span>
<a id="__codelineno-22-19" name="__codelineno-22-19"></a>    <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-22-20" name="__codelineno-22-20"></a>    <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span>
<a id="__codelineno-22-21" name="__codelineno-22-21"></a>    <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">384</span><span class="p">,</span>
<a id="__codelineno-22-22" name="__codelineno-22-22"></a>    <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">347</span>
<a id="__codelineno-22-23" name="__codelineno-22-23"></a>  <span class="p">},</span>
<a id="__codelineno-22-24" name="__codelineno-22-24"></a>  <span class="err">…</span>
<a id="__codelineno-22-25" name="__codelineno-22-25"></a><span class="p">]</span>
</code></pre></div></td></tr></table></div></p>
</li>
</ul>
<h3 id="2332-configuration-du-client-web">23.3.2. Configuration du client web</h3>
<p><img src="images/10000000000001B2000001615BAEC91E.png" style="width:5.01cm;height:4.07cm;" alt="Image" /></p>
<p>La configuration se fait à l’aide de deux scripts :</p>
<ul>
<li><strong>[config]</strong> qui assure la totalité de la configuration hors couches de l’architecture ;</li>
<li><strong>[config_layers]</strong> qui assure la configuration des couches de l’architecture ;
Le script <strong>[config]</strong> est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span>
<span class="normal"><a href="#__codelineno-23-15">15</a></span>
<span class="normal"><a href="#__codelineno-23-16">16</a></span>
<span class="normal"><a href="#__codelineno-23-17">17</a></span>
<span class="normal"><a href="#__codelineno-23-18">18</a></span>
<span class="normal"><a href="#__codelineno-23-19">19</a></span>
<span class="normal"><a href="#__codelineno-23-20">20</a></span>
<span class="normal"><a href="#__codelineno-23-21">21</a></span>
<span class="normal"><a href="#__codelineno-23-22">22</a></span>
<span class="normal"><a href="#__codelineno-23-23">23</a></span>
<span class="normal"><a href="#__codelineno-23-24">24</a></span>
<span class="normal"><a href="#__codelineno-23-25">25</a></span>
<span class="normal"><a href="#__codelineno-23-26">26</a></span>
<span class="normal"><a href="#__codelineno-23-27">27</a></span>
<span class="normal"><a href="#__codelineno-23-28">28</a></span>
<span class="normal"><a href="#__codelineno-23-29">29</a></span>
<span class="normal"><a href="#__codelineno-23-30">30</a></span>
<span class="normal"><a href="#__codelineno-23-31">31</a></span>
<span class="normal"><a href="#__codelineno-23-32">32</a></span>
<span class="normal"><a href="#__codelineno-23-33">33</a></span>
<span class="normal"><a href="#__codelineno-23-34">34</a></span>
<span class="normal"><a href="#__codelineno-23-35">35</a></span>
<span class="normal"><a href="#__codelineno-23-36">36</a></span>
<span class="normal"><a href="#__codelineno-23-37">37</a></span>
<span class="normal"><a href="#__codelineno-23-38">38</a></span>
<span class="normal"><a href="#__codelineno-23-39">39</a></span>
<span class="normal"><a href="#__codelineno-23-40">40</a></span>
<span class="normal"><a href="#__codelineno-23-41">41</a></span>
<span class="normal"><a href="#__codelineno-23-42">42</a></span>
<span class="normal"><a href="#__codelineno-23-43">43</a></span>
<span class="normal"><a href="#__codelineno-23-44">44</a></span>
<span class="normal"><a href="#__codelineno-23-45">45</a></span>
<span class="normal"><a href="#__codelineno-23-46">46</a></span>
<span class="normal"><a href="#__codelineno-23-47">47</a></span>
<span class="normal"><a href="#__codelineno-23-48">48</a></span>
<span class="normal"><a href="#__codelineno-23-49">49</a></span>
<span class="normal"><a href="#__codelineno-23-50">50</a></span>
<span class="normal"><a href="#__codelineno-23-51">51</a></span>
<span class="normal"><a href="#__codelineno-23-52">52</a></span>
<span class="normal"><a href="#__codelineno-23-53">53</a></span>
<span class="normal"><a href="#__codelineno-23-54">54</a></span>
<span class="normal"><a href="#__codelineno-23-55">55</a></span>
<span class="normal"><a href="#__codelineno-23-56">56</a></span>
<span class="normal"><a href="#__codelineno-23-57">57</a></span>
<span class="normal"><a href="#__codelineno-23-58">58</a></span>
<span class="normal"><a href="#__codelineno-23-59">59</a></span>
<span class="normal"><a href="#__codelineno-23-60">60</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a>    <span class="c1"># étape 1 ------</span>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a>    <span class="c1"># dossier de ce fichier</span>
<a id="__codelineno-23-7" name="__codelineno-23-7"></a>    <span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<a id="__codelineno-23-8" name="__codelineno-23-8"></a>
<a id="__codelineno-23-9" name="__codelineno-23-9"></a>    <span class="c1"># chemin racine</span>
<a id="__codelineno-23-10" name="__codelineno-23-10"></a>    <span class="n">root_dir</span> <span class="o">=</span> <span class="s2">&quot;C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020&quot;</span>
<a id="__codelineno-23-11" name="__codelineno-23-11"></a>
<a id="__codelineno-23-12" name="__codelineno-23-12"></a>    <span class="c1"># dépendances absolues</span>
<a id="__codelineno-23-13" name="__codelineno-23-13"></a>    <span class="n">absolute_dependencies</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-23-14" name="__codelineno-23-14"></a>        <span class="c1"># dossiers du projet</span>
<a id="__codelineno-23-15" name="__codelineno-23-15"></a>        <span class="c1"># BaseEntity, MyException</span>
<a id="__codelineno-23-16" name="__codelineno-23-16"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/classes/02/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-23-17" name="__codelineno-23-17"></a>        <span class="c1"># InterfaceImpôtsDao, InterfaceImpôtsMétier, InterfaceImpôtsUi</span>
<a id="__codelineno-23-18" name="__codelineno-23-18"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/interfaces&quot;</span><span class="p">,</span>
<a id="__codelineno-23-19" name="__codelineno-23-19"></a>        <span class="c1"># AbstractImpôtsdao, ImpôtsConsole, ImpôtsMétier</span>
<a id="__codelineno-23-20" name="__codelineno-23-20"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/services&quot;</span><span class="p">,</span>
<a id="__codelineno-23-21" name="__codelineno-23-21"></a>        <span class="c1"># ImpotsDaoWithAdminDataInDatabase</span>
<a id="__codelineno-23-22" name="__codelineno-23-22"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v05/services&quot;</span><span class="p">,</span>
<a id="__codelineno-23-23" name="__codelineno-23-23"></a>        <span class="c1"># AdminData, ImpôtsError, TaxPayer</span>
<a id="__codelineno-23-24" name="__codelineno-23-24"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-23-25" name="__codelineno-23-25"></a>        <span class="c1"># Constantes, tranches</span>
<a id="__codelineno-23-26" name="__codelineno-23-26"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v05/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-23-27" name="__codelineno-23-27"></a>        <span class="c1"># ImpôtsDaoWithHttpClient</span>
<a id="__codelineno-23-28" name="__codelineno-23-28"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../services&quot;</span><span class="p">,</span>
<a id="__codelineno-23-29" name="__codelineno-23-29"></a>        <span class="c1"># scripts de configuration</span>
<a id="__codelineno-23-30" name="__codelineno-23-30"></a>        <span class="n">script_dir</span><span class="p">,</span>
<a id="__codelineno-23-31" name="__codelineno-23-31"></a>    <span class="p">]</span>
<a id="__codelineno-23-32" name="__codelineno-23-32"></a>
<a id="__codelineno-23-33" name="__codelineno-23-33"></a>    <span class="c1"># on fixe le syspath</span>
<a id="__codelineno-23-34" name="__codelineno-23-34"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_syspath</span>
<a id="__codelineno-23-35" name="__codelineno-23-35"></a>    <span class="n">set_syspath</span><span class="p">(</span><span class="n">absolute_dependencies</span><span class="p">)</span>
<a id="__codelineno-23-36" name="__codelineno-23-36"></a>
<a id="__codelineno-23-37" name="__codelineno-23-37"></a>    <span class="c1"># étape 2 ------</span>
<a id="__codelineno-23-38" name="__codelineno-23-38"></a>    <span class="c1"># configuration de l&#39;application avec des constantes</span>
<a id="__codelineno-23-39" name="__codelineno-23-39"></a>    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
<a id="__codelineno-23-40" name="__codelineno-23-40"></a>        <span class="s2">&quot;taxpayersFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../data/input/taxpayersdata.txt&quot;</span><span class="p">,</span>
<a id="__codelineno-23-41" name="__codelineno-23-41"></a>        <span class="s2">&quot;resultsFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../data/output/résultats.json&quot;</span><span class="p">,</span>
<a id="__codelineno-23-42" name="__codelineno-23-42"></a>        <span class="s2">&quot;errorsFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../data/output/errors.txt&quot;</span><span class="p">,</span>
<a id="__codelineno-23-43" name="__codelineno-23-43"></a>        <span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-23-44" name="__codelineno-23-44"></a>            <span class="s2">&quot;urlServer&quot;</span><span class="p">:</span> <span class="s2">&quot;http://127.0.0.1:5000/&quot;</span><span class="p">,</span>
<a id="__codelineno-23-45" name="__codelineno-23-45"></a>            <span class="s2">&quot;authBasic&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-23-46" name="__codelineno-23-46"></a>            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-23-47" name="__codelineno-23-47"></a>                <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
<a id="__codelineno-23-48" name="__codelineno-23-48"></a>                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span>
<a id="__codelineno-23-49" name="__codelineno-23-49"></a>            <span class="p">}</span>
<a id="__codelineno-23-50" name="__codelineno-23-50"></a>        <span class="p">}</span>
<a id="__codelineno-23-51" name="__codelineno-23-51"></a>    <span class="p">}</span>
<a id="__codelineno-23-52" name="__codelineno-23-52"></a>    <span class="p">)</span>
<a id="__codelineno-23-53" name="__codelineno-23-53"></a>
<a id="__codelineno-23-54" name="__codelineno-23-54"></a>    <span class="c1"># étape 3 ------</span>
<a id="__codelineno-23-55" name="__codelineno-23-55"></a>    <span class="c1"># instanciation des couches</span>
<a id="__codelineno-23-56" name="__codelineno-23-56"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config_layers</span>
<a id="__codelineno-23-57" name="__codelineno-23-57"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_layers</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-23-58" name="__codelineno-23-58"></a>
<a id="__codelineno-23-59" name="__codelineno-23-59"></a>    <span class="c1"># on rend la configuation</span>
<a id="__codelineno-23-60" name="__codelineno-23-60"></a>    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 1 : la fonction <strong>[configure]</strong> reçoit en paramètre le dictionnaire à remplir avec les informations de configuration. Celui-ci peut être déjà pré-rempli ou vide. Ici, il sera vide ;</li>
<li>lignes 40-42 : les noms absolus des trois fichiers texte gérés par la couche <strong>[dao]</strong> ;</li>
<li>lignes 43-50 : associées à la clé <strong>[server]</strong>, les informations que doit connaître la couche <strong>[dao]</strong> sur le serveur web avec lequel elle doit communiquer :</li>
<li>ligne 44 : l’URL du service web ;</li>
<li>ligne 45 : la clé <strong>[authBasic]</strong> vaut True si l’accès à l’URL nécessite une authentification de type Basic ;</li>
<li>lignes 46-49 : les identifiants de l’utilisateur qui va s’authentifier si l’authentification est demandée ;</li>
<li>lignes 56-57 : on instancie les couches, ici l’unique couche <strong>[dao]</strong> et on met les références des couches dans <strong>[config]</strong> associées à la clé <strong>[layers]</strong> ;
Le script <strong>[config_layers]</strong> est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a>    <span class="c1"># instanciation des couches de l&#39;applicatuon</span>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a>    <span class="c1"># couche dao</span>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsDaoWithHttpClient</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsDaoWithHttpClient</span>
<a id="__codelineno-24-6" name="__codelineno-24-6"></a>    <span class="n">dao</span> <span class="o">=</span> <span class="n">ImpôtsDaoWithHttpClient</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-24-7" name="__codelineno-24-7"></a>
<a id="__codelineno-24-8" name="__codelineno-24-8"></a>    <span class="c1"># on rend la configuation des couches</span>
<a id="__codelineno-24-9" name="__codelineno-24-9"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-24-10" name="__codelineno-24-10"></a>        <span class="s2">&quot;dao&quot;</span><span class="p">:</span> <span class="n">dao</span>
<a id="__codelineno-24-11" name="__codelineno-24-11"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 1 : la fonction <strong>[configure]</strong> reçoit le dictionnaire qui configure l’application ;</li>
<li>lignes 4-6 : la couche <strong>[dao]</strong> est instanciée. Ligne 6, on lui passe la configuration de l’application dans lequel elle trouvera les informations dont elle a besoin ;</li>
<li>lignes 8-11 : on rend un dictionnaire dans lequel on a mis la référence de la couche <strong>[dao]</strong> ;</li>
</ul>
<h3 id="2333-le-script-principal-main">23.3.3. Le script principal [main]</h3>
<p>Le script principal <strong>[main]</strong> est une variante de celui de la |<a href="#_Le_script_principal_5"><u><u>version 5</u></u></a>| :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span>
<span class="normal"><a href="#__codelineno-25-11">11</a></span>
<span class="normal"><a href="#__codelineno-25-12">12</a></span>
<span class="normal"><a href="#__codelineno-25-13">13</a></span>
<span class="normal"><a href="#__codelineno-25-14">14</a></span>
<span class="normal"><a href="#__codelineno-25-15">15</a></span>
<span class="normal"><a href="#__codelineno-25-16">16</a></span>
<span class="normal"><a href="#__codelineno-25-17">17</a></span>
<span class="normal"><a href="#__codelineno-25-18">18</a></span>
<span class="normal"><a href="#__codelineno-25-19">19</a></span>
<span class="normal"><a href="#__codelineno-25-20">20</a></span>
<span class="normal"><a href="#__codelineno-25-21">21</a></span>
<span class="normal"><a href="#__codelineno-25-22">22</a></span>
<span class="normal"><a href="#__codelineno-25-23">23</a></span>
<span class="normal"><a href="#__codelineno-25-24">24</a></span>
<span class="normal"><a href="#__codelineno-25-25">25</a></span>
<span class="normal"><a href="#__codelineno-25-26">26</a></span>
<span class="normal"><a href="#__codelineno-25-27">27</a></span>
<span class="normal"><a href="#__codelineno-25-28">28</a></span>
<span class="normal"><a href="#__codelineno-25-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({})</span>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="c1"># dépendances</span>
<a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-25-7" name="__codelineno-25-7"></a>
<a id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="c1"># code</span>
<a id="__codelineno-25-9" name="__codelineno-25-9"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-25-10" name="__codelineno-25-10"></a>    <span class="c1"># on récupère la couche [dao]</span>
<a id="__codelineno-25-11" name="__codelineno-25-11"></a>    <span class="n">dao</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span>
<a id="__codelineno-25-12" name="__codelineno-25-12"></a>    <span class="c1"># lecture des données des contribuables</span>
<a id="__codelineno-25-13" name="__codelineno-25-13"></a>    <span class="n">taxpayers</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_taxpayers_data</span><span class="p">()[</span><span class="s2">&quot;taxpayers&quot;</span><span class="p">]</span>
<a id="__codelineno-25-14" name="__codelineno-25-14"></a>    <span class="c1"># des contribuables ?</span>
<a id="__codelineno-25-15" name="__codelineno-25-15"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">taxpayers</span><span class="p">:</span>
<a id="__codelineno-25-16" name="__codelineno-25-16"></a>        <span class="k">raise</span> <span class="n">ImpôtsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pas de contribuables valides dans le fichier </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;taxpayersFilename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-25-17" name="__codelineno-25-17"></a>    <span class="c1"># calcul de l&#39;impôt des contribuables</span>
<a id="__codelineno-25-18" name="__codelineno-25-18"></a>    <span class="k">for</span> <span class="n">taxpayer</span> <span class="ow">in</span> <span class="n">taxpayers</span><span class="p">:</span>
<a id="__codelineno-25-19" name="__codelineno-25-19"></a>        <span class="c1"># taxpayer est à la fois un paramètre d&#39;entrée et de sortie</span>
<a id="__codelineno-25-20" name="__codelineno-25-20"></a>        <span class="c1"># taxpayer va être modifié</span>
<a id="__codelineno-25-21" name="__codelineno-25-21"></a>        <span class="n">dao</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">taxpayer</span><span class="p">)</span>
<a id="__codelineno-25-22" name="__codelineno-25-22"></a>    <span class="c1"># écriture des résultats dans un fichier texte</span>
<a id="__codelineno-25-23" name="__codelineno-25-23"></a>    <span class="n">dao</span><span class="o">.</span><span class="n">write_taxpayers_results</span><span class="p">(</span><span class="n">taxpayers</span><span class="p">)</span>
<a id="__codelineno-25-24" name="__codelineno-25-24"></a><span class="k">except</span> <span class="n">ImpôtsError</span>  <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-25-25" name="__codelineno-25-25"></a>    <span class="c1"># affichage de l&#39;erreur</span>
<a id="__codelineno-25-26" name="__codelineno-25-26"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-25-27" name="__codelineno-25-27"></a><span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-25-28" name="__codelineno-25-28"></a>    <span class="c1"># terminé</span>
<a id="__codelineno-25-29" name="__codelineno-25-29"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Travail terminé...&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 2-3 : l’application est configurée ;</li>
<li>ligne 13 : la couche <strong>[dao]</strong> fournit la liste des contribuables dont on doit calculer l’impôt ;</li>
<li>ligne 21 : la couche <strong>[dao]</strong> calcule l’impôt de chacun d’eux ;</li>
<li>ligne 23 : les résultats sont enregistrés dans un fichier jSON ;</li>
</ul>
<h3 id="2334-implementation-de-la-couche-dao">23.3.4. Implémentation de la couche [dao]</h3>
<p><img src="images/100000000000021600000111FE33D106.png" style="width:6.181cm;height:3.151cm;" alt="Image" /></p>
<p>Revenons sur l’architecture client / serveur utilisée :</p>
<p><img src="images/10000000000003D1000002955314F81B.png" style="width:11.27cm;height:7.64cm;" alt="Image" /></p>
<ul>
<li>en <strong>[2, 6]</strong>, on voit que la couche <strong>[dao]</strong> a deux rôles :</li>
<li>elle accède au système de fichiers à la fois pour lire les données des contribuables et écrire les résultats des calculs de l’impôt. Nous avons déjà une classe |<a href="#_La_classe_[AbstractImpôtsDao]"><u><u>AbstractImpôtsDao</u></u></a>| qui sait faire cela. Elle a été utilisée dès la |<a href="#_Version_3"><u><u>version 4</u></u></a>| ;</li>
<li>elle dialogue avec le serveur web <strong>[3]</strong> ;
Dans la |<a href="#_Le_script_principal_5"><u><u>version 5</u></u></a>|, le script principal <strong>[main]</strong> <strong>[1]</strong> dialoguait directement avec la couche <strong>[métier]</strong> <strong>[4]</strong>. On voudrait ne pas changer ce script. Pour cela, on va faire en sorte que la couche <strong>[dao]</strong> <strong>[2]</strong> implémente l’interface de la couche <strong>[métier]</strong> <strong>[4]</strong>. Ainsi le script principal <strong>[main]</strong> aura l’impression de dialoguer directement avec la couche <strong>[métier]</strong> <strong>[4]</strong> et pourra ignorer complètement que celle-ci se situe sur une autre machine.</li>
</ul>
<p>Une définition de la classe implémentant la couche <strong>[dao]</strong> <strong>[2]</strong> pourrait être celle-ci :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ImpôtsDaoWithHttpClient</span><span class="p">(</span><span class="n">AbstractImpôtsDao</span><span class="p">,</span> <span class="n">InterfaceImpôtsMétier</span><span class="p">):</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>la classe <strong>[ImpôtsDaoWithHttpClient]</strong> :</li>
<li>hérite de la classe <strong>[AbstractImpôtsDao]</strong> ce qui va lui permettre de gérer le dialogue avec le système de fichiers <strong>[6]</strong> ;</li>
<li>implémente l’interface <strong>[InterfaceImpôtsMétier]</strong> pour ne pas avoir à changer le script principal <strong>[main]</strong> de la |<a href="#_Le_script_principal_5"><u><u>version 5</u></u></a>| ;
Le code complet de la classe <strong>[ImpôtsDaoWithHttpClient]</strong> est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span>
<span class="normal"><a href="#__codelineno-27-18">18</a></span>
<span class="normal"><a href="#__codelineno-27-19">19</a></span>
<span class="normal"><a href="#__codelineno-27-20">20</a></span>
<span class="normal"><a href="#__codelineno-27-21">21</a></span>
<span class="normal"><a href="#__codelineno-27-22">22</a></span>
<span class="normal"><a href="#__codelineno-27-23">23</a></span>
<span class="normal"><a href="#__codelineno-27-24">24</a></span>
<span class="normal"><a href="#__codelineno-27-25">25</a></span>
<span class="normal"><a href="#__codelineno-27-26">26</a></span>
<span class="normal"><a href="#__codelineno-27-27">27</a></span>
<span class="normal"><a href="#__codelineno-27-28">28</a></span>
<span class="normal"><a href="#__codelineno-27-29">29</a></span>
<span class="normal"><a href="#__codelineno-27-30">30</a></span>
<span class="normal"><a href="#__codelineno-27-31">31</a></span>
<span class="normal"><a href="#__codelineno-27-32">32</a></span>
<span class="normal"><a href="#__codelineno-27-33">33</a></span>
<span class="normal"><a href="#__codelineno-27-34">34</a></span>
<span class="normal"><a href="#__codelineno-27-35">35</a></span>
<span class="normal"><a href="#__codelineno-27-36">36</a></span>
<span class="normal"><a href="#__codelineno-27-37">37</a></span>
<span class="normal"><a href="#__codelineno-27-38">38</a></span>
<span class="normal"><a href="#__codelineno-27-39">39</a></span>
<span class="normal"><a href="#__codelineno-27-40">40</a></span>
<span class="normal"><a href="#__codelineno-27-41">41</a></span>
<span class="normal"><a href="#__codelineno-27-42">42</a></span>
<span class="normal"><a href="#__codelineno-27-43">43</a></span>
<span class="normal"><a href="#__codelineno-27-44">44</a></span>
<span class="normal"><a href="#__codelineno-27-45">45</a></span>
<span class="normal"><a href="#__codelineno-27-46">46</a></span>
<span class="normal"><a href="#__codelineno-27-47">47</a></span>
<span class="normal"><a href="#__codelineno-27-48">48</a></span>
<span class="normal"><a href="#__codelineno-27-49">49</a></span>
<span class="normal"><a href="#__codelineno-27-50">50</a></span>
<span class="normal"><a href="#__codelineno-27-51">51</a></span>
<span class="normal"><a href="#__codelineno-27-52">52</a></span>
<span class="normal"><a href="#__codelineno-27-53">53</a></span>
<span class="normal"><a href="#__codelineno-27-54">54</a></span>
<span class="normal"><a href="#__codelineno-27-55">55</a></span>
<span class="normal"><a href="#__codelineno-27-56">56</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="c1"># imports</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">AbstractImpôtsDao</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbstractImpôtsDao</span>
<a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">AdminData</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdminData</span>
<a id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceImpôtsMétier</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceImpôtsMétier</span>
<a id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">TaxPayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaxPayer</span>
<a id="__codelineno-27-10" name="__codelineno-27-10"></a>
<a id="__codelineno-27-11" name="__codelineno-27-11"></a>
<a id="__codelineno-27-12" name="__codelineno-27-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">ImpôtsDaoWithHttpClient</span><span class="p">(</span><span class="n">AbstractImpôtsDao</span><span class="p">,</span> <span class="n">InterfaceImpôtsMétier</span><span class="p">):</span>
<a id="__codelineno-27-13" name="__codelineno-27-13"></a>
<a id="__codelineno-27-14" name="__codelineno-27-14"></a>    <span class="c1"># constructeur</span>
<a id="__codelineno-27-15" name="__codelineno-27-15"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-27-16" name="__codelineno-27-16"></a>        <span class="c1"># initialisation parent</span>
<a id="__codelineno-27-17" name="__codelineno-27-17"></a>        <span class="n">AbstractImpôtsDao</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-27-18" name="__codelineno-27-18"></a>        <span class="c1"># mémorisation paramètres</span>
<a id="__codelineno-27-19" name="__codelineno-27-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">]</span>
<a id="__codelineno-27-20" name="__codelineno-27-20"></a>
<a id="__codelineno-27-21" name="__codelineno-27-21"></a>    <span class="c1"># méthode inutilisée de [AbstractImpôtsDao]</span>
<a id="__codelineno-27-22" name="__codelineno-27-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_admindata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AdminData</span><span class="p">:</span>
<a id="__codelineno-27-23" name="__codelineno-27-23"></a>        <span class="k">pass</span>
<a id="__codelineno-27-24" name="__codelineno-27-24"></a>
<a id="__codelineno-27-25" name="__codelineno-27-25"></a>    <span class="c1"># calcul de l&#39;impôt</span>
<a id="__codelineno-27-26" name="__codelineno-27-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_tax</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">taxpayer</span><span class="p">:</span> <span class="n">TaxPayer</span><span class="p">,</span> <span class="n">admindata</span><span class="p">:</span> <span class="n">AdminData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-27-27" name="__codelineno-27-27"></a>        <span class="c1"># on laisse remonter les exceptions</span>
<a id="__codelineno-27-28" name="__codelineno-27-28"></a>        <span class="c1"># paramètres du get</span>
<a id="__codelineno-27-29" name="__codelineno-27-29"></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="n">taxpayer</span><span class="o">.</span><span class="n">marié</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="n">taxpayer</span><span class="o">.</span><span class="n">enfants</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="n">taxpayer</span><span class="o">.</span><span class="n">salaire</span><span class="p">}</span>
<a id="__codelineno-27-30" name="__codelineno-27-30"></a>        <span class="c1"># connexion avec authentification Auth Basic ?</span>
<a id="__codelineno-27-31" name="__codelineno-27-31"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span><span class="p">[</span><span class="s1">&#39;authBasic&#39;</span><span class="p">]:</span>
<a id="__codelineno-27-32" name="__codelineno-27-32"></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-27-33" name="__codelineno-27-33"></a>                <span class="c1"># URL du serveur interrogé</span>
<a id="__codelineno-27-34" name="__codelineno-27-34"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span><span class="p">[</span><span class="s1">&#39;urlServer&#39;</span><span class="p">],</span>
<a id="__codelineno-27-35" name="__codelineno-27-35"></a>                <span class="c1"># paramètres de l&#39;URL</span>
<a id="__codelineno-27-36" name="__codelineno-27-36"></a>                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
<a id="__codelineno-27-37" name="__codelineno-27-37"></a>                <span class="c1"># authentification Basic</span>
<a id="__codelineno-27-38" name="__codelineno-27-38"></a>                <span class="n">auth</span><span class="o">=</span><span class="p">(</span>
<a id="__codelineno-27-39" name="__codelineno-27-39"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;login&quot;</span><span class="p">],</span>
<a id="__codelineno-27-40" name="__codelineno-27-40"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;password&quot;</span><span class="p">]))</span>
<a id="__codelineno-27-41" name="__codelineno-27-41"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-27-42" name="__codelineno-27-42"></a>            <span class="c1"># connexion sans authentification Auth Basic</span>
<a id="__codelineno-27-43" name="__codelineno-27-43"></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span><span class="p">[</span><span class="s1">&#39;urlServer&#39;</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
<a id="__codelineno-27-44" name="__codelineno-27-44"></a>        <span class="c1"># vérification</span>
<a id="__codelineno-27-45" name="__codelineno-27-45"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-27-46" name="__codelineno-27-46"></a>        <span class="c1"># code de statut de la réponse HTTP</span>
<a id="__codelineno-27-47" name="__codelineno-27-47"></a>        <span class="n">status_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
<a id="__codelineno-27-48" name="__codelineno-27-48"></a>        <span class="c1"># on met la réponse jSON dans un dictionnaire</span>
<a id="__codelineno-27-49" name="__codelineno-27-49"></a>        <span class="n">résultat</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-27-50" name="__codelineno-27-50"></a>        <span class="c1"># erreur si code de statut différent de 200 OK</span>
<a id="__codelineno-27-51" name="__codelineno-27-51"></a>        <span class="k">if</span> <span class="n">status_code</span> <span class="o">!=</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">:</span>
<a id="__codelineno-27-52" name="__codelineno-27-52"></a>            <span class="c1"># on sait que les erreurs ont été associées à la clé [erreurs] de la réponse</span>
<a id="__codelineno-27-53" name="__codelineno-27-53"></a>            <span class="k">raise</span> <span class="n">ImpôtsError</span><span class="p">(</span><span class="mi">87</span><span class="p">,</span> <span class="n">résultat</span><span class="p">[</span><span class="s1">&#39;réponse&#39;</span><span class="p">][</span><span class="s1">&#39;erreurs&#39;</span><span class="p">])</span>
<a id="__codelineno-27-54" name="__codelineno-27-54"></a>        <span class="c1"># on sait que le résultat a été associé à la clé [result] de la réponse</span>
<a id="__codelineno-27-55" name="__codelineno-27-55"></a>        <span class="c1"># on modifie le paramètre d&#39;entrée avec ce résultat</span>
<a id="__codelineno-27-56" name="__codelineno-27-56"></a>        <span class="n">taxpayer</span><span class="o">.</span><span class="n">fromdict</span><span class="p">(</span><span class="n">résultat</span><span class="p">[</span><span class="s2">&quot;réponse&quot;</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 21-23 : la classe <strong>[AbstractImpôtsDao]</strong> (ligne 12) possède une méthode abstraite <strong>[get_admindata]</strong>. Nous sommes obligés de l’implémenter même si on ne s’en sert pas (admindata est géré par le serveur pas par le client) ;</li>
<li>ligne 26 : la méthode <strong>[calculate_tax]</strong> appartient à l’interface <strong>[</strong><strong>InterfaceImpôtsMétier</strong><strong>]</strong> (ligne 12). il nous faut l’implémenter ;</li>
<li>ligne 15 : le constructeur reçoit en unique paramètre le dictionnaire de la configuration de l’application ;</li>
<li>lignes 16-17 : la classe parent <strong>[</strong><strong>AbstractImpôtsDao</strong><strong>]</strong> est initialisée en lui passant, là également, la configuration de l’application. Elle y trouvera les noms des trois fichiers texte qu’elle a à gérer ;</li>
<li>lignes 18-19 : on mémorise localement dans la classe les informations concernant le serveur web de calcul de l’impôt ;</li>
<li>ligne 26 : la méthode <strong>[calculate_tax]</strong> reçoit en paramètre un objet de type |<a href="#_La_classe_[TaxPayer]"><u><u>Taxpayer</u></u></a>|. Pour respecter la signature de la méthode <strong>[InterfaceImpôtsMétier.calculate_tax]</strong>, elle reçoit également un paramètre <strong>[admindata]</strong> qui est censé encapsuler les données de l’administration fiscale. Côté client, on n’a pas ces données. Ce paramètre restera toujours à <strong>[None]</strong>. Cette contorsion fait dire que la classe <strong>[ImpôtsMétier]</strong> a été initialement mal écrite :</li>
<li>la signature de <strong>[calculate_tax]</strong> aurait dû être simplement :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_tax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taxpayer</span><span class="p">:</span> <span class="n">TaxPayer</span><span class="p">)</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<p>et le paramètre <strong>[admindata : AdminData]</strong> aurait dû être passé au constructeur de la classe ;</p>
<ul>
<li>ligne 27 : le code de la méthode <strong>[calculate_tax]</strong> n’a pas été encapsulé dans un try / catch / finally. Cela veut dire que les éventuelles exceptions ne seront pas gérées et remonteront au code appelant, en l’occurrence le script <strong>[main]</strong>. Celui-ci arrête bien toutes les exceptions remontant de la couche <strong>[dao]</strong> ;</li>
<li>ligne 28 : le calcul de l’impôt se fait côté serveur. Il va donc falloir communiquer avec lui. On le fait avec le module <strong>[requests]</strong> importé ligne 2 ;</li>
<li>lignes 31-43 : pour envoyer une requête GET au serveur web, on utilise la méthode <strong>[requests.get]</strong> :</li>
<li>lignes 33-34 : le 1er paramètre de la méthode est l’URL à contacter ;</li>
<li>lignes 35-40 : les deux autres paramètres sont des paramètres nommés dont l’ordre n’importe pas ;</li>
<li>lignes 35-36 : la valeur du paramètre nommé <strong>[params]</strong> doit être un dictionnaire contenant les informations à mettre dans l’URL sous la forme <strong>[/url ?param1=valeur1&amp;param2=valeur2&amp;…]</strong> ;</li>
<li>ligne 29 : le dictionnaire contenant les trois paramètres <strong>[marié, enfants, salaire]</strong> que le serveur web attend. On n’a pas à s’occuper de l’encodage (appelé urlencoded) que doivent subir ces paramètres. <strong>[requests]</strong> s’en occupe ;</li>
<li>lignes 37-40 : le paramètre nommé <strong>[auth]</strong> est un tuple de deux éléments (login, password). Il représente les identifiants d’une authentification de type Basic ;</li>
<li>lignes 44-45 : ces deux lignes n’ont qu’un but pédagogique (on les mettra en commentaires lorsque le débogage sera terminé) :</li>
<li><strong>[response]</strong> représente la réponse HTTP du serveur ;</li>
<li><strong>[response.text]</strong> représente le texte du document encapsulé dans cette réponse. En phase de débogage, il est utile de vérifier ce que le serveur nous a envoyé ;</li>
<li>ligne 47 : <strong>[response.status_code]</strong> est le code de statut HTTP de la réponse reçue. Notre serveur n’en envoie que trois :</li>
<li>200 OK</li>
<li>400 BAD REQUEST</li>
<li>500 INTERNAL SERVER ERROR</li>
<li>ligne 49 : notre serveur envoie toujours du jSON même en cas d’erreur. La fonction <strong>[response.json()]</strong> crée un dictionnaire à partir de la chaîne jSON reçue. Rappelons les deux formes possibles pour la chaîne jSON :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;erreurs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Méthode GET requise avec les seuls paramètres [marié, enfants, salaire]&quot;</span><span class="p">,</span> <span class="s2">&quot;paramètre [marié] manquant&quot;</span><span class="p">,</span> <span class="s2">&quot;paramètre [enfants] manquant&quot;</span><span class="p">,</span> <span class="s2">&quot;paramètre [salaire] manquant&quot;</span><span class="p">]}}</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">42842</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">17283</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 51-53 : si le code de statut n’est pas 200 alors on lance une exception avec les messages d’erreur encapsulés dans la réponse ;</li>
<li>ligne 56 : on récupère le dictionnaire produit par le calcul de l’impôt et on l’utilise pour mettre à jour le paramètre d’entrée <strong>[taxpayer]</strong> ; </li>
</ul>
<h3 id="2335-execution">23.3.5. Exécution</h3>
<p>Pour exécuter le client :</p>
<ul>
<li>lancer le serveur <strong>[server_03]</strong> avec le SGBD de votre choix ;</li>
<li>exécuter le script <strong>[main]</strong> du client ;
Les résultats seront trouvés dans le dossier <strong>[data/output]</strong>. Ce sont les mêmes que pour la version 5.</li>
</ul>
<h2 id="234-tests-de-la-couche-dao">23.4. Tests de la couche [dao]</h2>
<p>Revenons à l’architecture de l’application client / serveur :</p>
<p><img src="images/10000000000003CF000003C7638DD447.png" style="width:11.27cm;height:11.171cm;" alt="Image" /></p>
<ul>
<li>dans le client écrit, nous nous sommes débrouillés pour que la couche <strong>[dao]</strong> <strong>[1]</strong> offre la même interface que la couche <strong>[métier]</strong> <strong>[3]</strong>. Nous allons donc utiliser en <strong>[4]</strong>, la classe de tests |<a href="#_Tests_des_couches"><u><u>TestDaoMétier</u></u></a>| déjà étudiée pour tester la couche <strong>[métier]</strong> <strong>[3]</strong> ;
La classe de test sera exécutée dans l’environnement suivant :</li>
</ul>
<p><img src="images/10000000000001F50000020535068CC3.png" style="width:5.792cm;height:5.98cm;" alt="Image" /></p>
<ul>
<li>la configuration <strong>[2]</strong> est identique à la configuration <strong>[1]</strong> que nous venons d’étudier ;
La classe de test <strong>[</strong><strong>TestHttpClientDao</strong><strong>]</strong> est la suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span>
<span class="normal"><a href="#__codelineno-31-11">11</a></span>
<span class="normal"><a href="#__codelineno-31-12">12</a></span>
<span class="normal"><a href="#__codelineno-31-13">13</a></span>
<span class="normal"><a href="#__codelineno-31-14">14</a></span>
<span class="normal"><a href="#__codelineno-31-15">15</a></span>
<span class="normal"><a href="#__codelineno-31-16">16</a></span>
<span class="normal"><a href="#__codelineno-31-17">17</a></span>
<span class="normal"><a href="#__codelineno-31-18">18</a></span>
<span class="normal"><a href="#__codelineno-31-19">19</a></span>
<span class="normal"><a href="#__codelineno-31-20">20</a></span>
<span class="normal"><a href="#__codelineno-31-21">21</a></span>
<span class="normal"><a href="#__codelineno-31-22">22</a></span>
<span class="normal"><a href="#__codelineno-31-23">23</a></span>
<span class="normal"><a href="#__codelineno-31-24">24</a></span>
<span class="normal"><a href="#__codelineno-31-25">25</a></span>
<span class="normal"><a href="#__codelineno-31-26">26</a></span>
<span class="normal"><a href="#__codelineno-31-27">27</a></span>
<span class="normal"><a href="#__codelineno-31-28">28</a></span>
<span class="normal"><a href="#__codelineno-31-29">29</a></span>
<span class="normal"><a href="#__codelineno-31-30">30</a></span>
<span class="normal"><a href="#__codelineno-31-31">31</a></span>
<span class="normal"><a href="#__codelineno-31-32">32</a></span>
<span class="normal"><a href="#__codelineno-31-33">33</a></span>
<span class="normal"><a href="#__codelineno-31-34">34</a></span>
<span class="normal"><a href="#__codelineno-31-35">35</a></span>
<span class="normal"><a href="#__codelineno-31-36">36</a></span>
<span class="normal"><a href="#__codelineno-31-37">37</a></span>
<span class="normal"><a href="#__codelineno-31-38">38</a></span>
<span class="normal"><a href="#__codelineno-31-39">39</a></span>
<span class="normal"><a href="#__codelineno-31-40">40</a></span>
<span class="normal"><a href="#__codelineno-31-41">41</a></span>
<span class="normal"><a href="#__codelineno-31-42">42</a></span>
<span class="normal"><a href="#__codelineno-31-43">43</a></span>
<span class="normal"><a href="#__codelineno-31-44">44</a></span>
<span class="normal"><a href="#__codelineno-31-45">45</a></span>
<span class="normal"><a href="#__codelineno-31-46">46</a></span>
<span class="normal"><a href="#__codelineno-31-47">47</a></span>
<span class="normal"><a href="#__codelineno-31-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">unittest</span>
<a id="__codelineno-31-2" name="__codelineno-31-2"></a>
<a id="__codelineno-31-3" name="__codelineno-31-3"></a>
<a id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestHttpClientDao</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<a id="__codelineno-31-5" name="__codelineno-31-5"></a>
<a id="__codelineno-31-6" name="__codelineno-31-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-31-7" name="__codelineno-31-7"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">TaxPayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaxPayer</span>
<a id="__codelineno-31-8" name="__codelineno-31-8"></a>
<a id="__codelineno-31-9" name="__codelineno-31-9"></a>        <span class="c1"># {&#39;marié&#39;: &#39;oui&#39;, &#39;enfants&#39;: 2, &#39;salaire&#39;: 55555,</span>
<a id="__codelineno-31-10" name="__codelineno-31-10"></a>        <span class="c1"># &#39;impôt&#39;: 2814, &#39;surcôte&#39;: 0, &#39;décôte&#39;: 0, &#39;réduction&#39;: 0, &#39;taux&#39;: 0.14}</span>
<a id="__codelineno-31-11" name="__codelineno-31-11"></a>        <span class="n">taxpayer</span> <span class="o">=</span> <span class="n">TaxPayer</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">55555</span><span class="p">})</span>
<a id="__codelineno-31-12" name="__codelineno-31-12"></a>        <span class="n">dao</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">taxpayer</span><span class="p">)</span>
<a id="__codelineno-31-13" name="__codelineno-31-13"></a>        <span class="c1"># vérification</span>
<a id="__codelineno-31-14" name="__codelineno-31-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">impôt</span><span class="p">,</span> <span class="mi">2815</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-31-15" name="__codelineno-31-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">décôte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-31-16" name="__codelineno-31-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">réduction</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-31-17" name="__codelineno-31-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">taux</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<a id="__codelineno-31-18" name="__codelineno-31-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">surcôte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-31-19" name="__codelineno-31-19"></a>
<a id="__codelineno-31-20" name="__codelineno-31-20"></a>    <span class="err">…</span>
<a id="__codelineno-31-21" name="__codelineno-31-21"></a>
<a id="__codelineno-31-22" name="__codelineno-31-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_11</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-31-23" name="__codelineno-31-23"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">TaxPayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaxPayer</span>
<a id="__codelineno-31-24" name="__codelineno-31-24"></a>
<a id="__codelineno-31-25" name="__codelineno-31-25"></a>        <span class="c1"># {&#39;marié&#39;: &#39;oui&#39;, &#39;enfants&#39;: 3, &#39;salaire&#39;: 200000,</span>
<a id="__codelineno-31-26" name="__codelineno-31-26"></a>        <span class="c1"># &#39;impôt&#39;: 42842, &#39;surcôte&#39;: 17283, &#39;décôte&#39;: 0, &#39;réduction&#39;: 0, &#39;taux&#39;: 0.41}</span>
<a id="__codelineno-31-27" name="__codelineno-31-27"></a>        <span class="n">taxpayer</span> <span class="o">=</span> <span class="n">TaxPayer</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">})</span>
<a id="__codelineno-31-28" name="__codelineno-31-28"></a>        <span class="n">dao</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">taxpayer</span><span class="p">)</span>
<a id="__codelineno-31-29" name="__codelineno-31-29"></a>        <span class="c1"># vérifications</span>
<a id="__codelineno-31-30" name="__codelineno-31-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">impôt</span><span class="p">,</span> <span class="mi">42842</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-31-31" name="__codelineno-31-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">décôte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-31-32" name="__codelineno-31-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">réduction</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-31-33" name="__codelineno-31-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">taux</span><span class="p">,</span> <span class="mf">0.41</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<a id="__codelineno-31-34" name="__codelineno-31-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">surcôte</span><span class="p">,</span> <span class="mi">17283</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-31-35" name="__codelineno-31-35"></a>
<a id="__codelineno-31-36" name="__codelineno-31-36"></a>
<a id="__codelineno-31-37" name="__codelineno-31-37"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-31-38" name="__codelineno-31-38"></a>
<a id="__codelineno-31-39" name="__codelineno-31-39"></a>    <span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-31-40" name="__codelineno-31-40"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-31-41" name="__codelineno-31-41"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({})</span>
<a id="__codelineno-31-42" name="__codelineno-31-42"></a>
<a id="__codelineno-31-43" name="__codelineno-31-43"></a>    <span class="c1"># couche dao</span>
<a id="__codelineno-31-44" name="__codelineno-31-44"></a>    <span class="n">dao</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">][</span><span class="s1">&#39;dao&#39;</span><span class="p">]</span>
<a id="__codelineno-31-45" name="__codelineno-31-45"></a>
<a id="__codelineno-31-46" name="__codelineno-31-46"></a>    <span class="c1"># on exécute les méthodes de test</span>
<a id="__codelineno-31-47" name="__codelineno-31-47"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tests en cours...&quot;</span><span class="p">)</span>
<a id="__codelineno-31-48" name="__codelineno-31-48"></a>    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>Cette classe est analogue à |<a href="#_Tests_des_couches"><u><u>celle</u></u></a>| déjà étudiée dans la version 4 de l’application.</p>
<ul>
<li>lignes 40-41 : on configure l’environnement des tests ;</li>
<li>ligne 44 : on récupère une référence sur la couche <strong>[dao]</strong> ;</li>
<li>lignes 47-48 : on exécute les tests ;
Pour exécuter les tests, on crée une |<a href="#configuration_execution"><u><u>configuration d’exécution</u></u></a>| :</li>
</ul>
<p><img src="images/1000000000000516000002BC49BFEEF5.png" style="width:15.011cm;height:8.071cm;" alt="Image" /></p>
<ul>
<li>on crée une configuration d’exécution pour un script console pas pour un test UnitTest ;
Lorsqu’on exécute cette configuration, on obtient les résultats suivants :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-32-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-32-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-32-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-32-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-32-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-32-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-32-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-32-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-32-10">10</a></span>
<span class="normal"><a href="#__codelineno-32-11">11</a></span>
<span class="normal"><a href="#__codelineno-32-12">12</a></span>
<span class="normal"><a href="#__codelineno-32-13">13</a></span>
<span class="normal"><a href="#__codelineno-32-14">14</a></span>
<span class="normal"><a href="#__codelineno-32-15">15</a></span>
<span class="normal"><a href="#__codelineno-32-16">16</a></span>
<span class="normal"><a href="#__codelineno-32-17">17</a></span>
<span class="normal"><a href="#__codelineno-32-18">18</a></span>
<span class="normal"><a href="#__codelineno-32-19">19</a></span>
<span class="normal"><a href="#__codelineno-32-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">Scripts</span>\<span class="n">python</span><span class="o">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">st</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">cours</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">impots</span><span class="o">/</span><span class="n">http</span><span class="o">-</span><span class="n">clients</span><span class="o">/</span><span class="mi">01</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">TestHttpClientDao</span><span class="o">.</span><span class="n">py</span>
<a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="n">tests</span> <span class="n">en</span> <span class="n">cours</span><span class="o">...</span>
<a id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">55555</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">2814</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="o">....</span><span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">64210</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">7498</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.45</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-32-5" name="__codelineno-32-5"></a><span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">42842</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">17283</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-32-6" name="__codelineno-32-6"></a><span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">1384</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">384</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">347</span><span class="p">}}}</span>
<a id="__codelineno-32-7" name="__codelineno-32-7"></a><span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">720</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-32-8" name="__codelineno-32-8"></a><span class="o">...</span><span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">19884</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">4480</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-32-9" name="__codelineno-32-9"></a><span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">16782</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">7176</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-32-10" name="__codelineno-32-10"></a><span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">9200</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">2180</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-32-11" name="__codelineno-32-11"></a><span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">4230</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-32-12" name="__codelineno-32-12"></a><span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">22986</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-32-13" name="__codelineno-32-13"></a><span class="o">....</span>
<a id="__codelineno-32-14" name="__codelineno-32-14"></a><span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-32-15" name="__codelineno-32-15"></a><span class="o">----------------------------------------------------------------------</span>
<a id="__codelineno-32-16" name="__codelineno-32-16"></a><span class="n">Ran</span> <span class="mi">11</span> <span class="n">tests</span> <span class="ow">in</span> <span class="mf">0.130</span><span class="n">s</span>
<a id="__codelineno-32-17" name="__codelineno-32-17"></a>
<a id="__codelineno-32-18" name="__codelineno-32-18"></a><span class="n">OK</span>
<a id="__codelineno-32-19" name="__codelineno-32-19"></a>
<a id="__codelineno-32-20" name="__codelineno-32-20"></a><span class="n">Process</span> <span class="n">finished</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
<p>Les 11 tests ont réussi.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner">

      <div>
        <a href="https://tahe.developpez.com" target="_blank">
          https://tahe.developpez.com
        </a>
        <br>
        Ce cours tutoriel écrit par <strong>Serge Tahé</strong> est mis à disposition du public selon les termes de la
        <em>Licence Creative Commons Attribution – Pas d’Utilisation Commerciale –
        Partage dans les Mêmes Conditions 3.0 non transposé</em>.
      </div>

    </div>
  </div>

      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": ".", "features": ["navigation.sections", "navigation.indexes", "toc.integrate", "navigation.top"], "search": "assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="javascripts/focus.js"></script>
      
    
  </body>
</html>