
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Introduction au langage Python 3 et au framework web Flask par l'exemple">
      
      
        <meta name="author" content="Serge Tahé">
      
      
        <link rel="canonical" href="https://stahe.github.io/python-flask-sept-2020/exercice-dapplication-version-7.html">
      
      
        <link rel="prev" href="exercice-dapplication-version-6.html">
      
      
        <link rel="next" href="exercice-dapplication-version-8.html">
      
      
        
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>24. Exercice d’application : version 7 - Introduction au langage Python 3 et au framework web Flask par l'exemple</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="stylesheets/focus.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#24-exercice-dapplication-version-7" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Introduction au langage Python 3 et au framework web Flask par l&#39;exemple" class="md-header__button md-logo" aria-label="Introduction au langage Python 3 et au framework web Flask par l'exemple" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Introduction au langage Python 3 et au framework web Flask par l'exemple
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              24. Exercice d’application : version 7
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode sombre"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Passer au mode sombre" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode clair"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Passer au mode clair" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/stahe/python-flask-sept-2020" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Introduction au langage Python 3 et au framework web Flask par l&#39;exemple" class="md-nav__button md-logo" aria-label="Introduction au langage Python 3 et au framework web Flask par l'exemple" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Introduction au langage Python 3 et au framework web Flask par l'exemple
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/stahe/python-flask-sept-2020" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accueil
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="avant-propos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Avant-propos
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="installation-dx27un-environnement-de-travail.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Installation d&#x27;un environnement de travail
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-bases-de-python.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Les bases de Python
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-chaines-de-caracteres.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Les chaînes de caractères
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-exceptions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Les exceptions
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-fonctions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Les fonctions
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-fichiers-texte.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    7. Les fichiers texte
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application---version-1.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    8. Exercice d&#x27;application – version 1
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-imports.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    9. Les imports
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-2.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    10. Exercice d’application : version 2
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-3.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    11. Exercice d’application : version 3
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-classes-et-objets.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    12. Les classes et objets
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-classes-generiques-baseentity-et-myexception.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    13. Les classes génériques [BaseEntity] et [MyException]
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="architecture-en-couches-et-programmation-par-interfaces.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    14. Architecture en couches et programmation par interfaces
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application---version-4.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    15. Exercice d&#x27;application - version 4
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-du-sgbd-mysql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    16. Utilisation du SGBD MySQL
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-du-sgbd-postgresql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    17. Utilisation du SGBD PostgreSQL
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="ecrire-du-code-independant-du-sgbd.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    18. Ecrire du code indépendant du SGBD
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-de-lorm-sqlalchemy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    19. Utilisation de l’ORM SQLALCHEMY
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application-version-5.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    20. Exercice d&#x27;application : version 5
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="fonctions-internet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    21. Fonctions internet
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="services-web-avec-le-framework-flask.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    22. Services web avec le framework Flask
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-6.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    23. Exercice d’application : version 6
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    24. Exercice d’application : version 7
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="exercice-dapplication-version-7.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    24. Exercice d’application : version 7
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#241-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        24.1. Introduction
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#242-les-utilitaires" class="md-nav__link">
    <span class="md-ellipsis">
      
        24.2. Les utilitaires
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="24.2. Les utilitaires">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2421-la-classe-logger" class="md-nav__link">
    <span class="md-ellipsis">
      
        24.2.1. La classe [Logger]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2422-la-classe-sendadminmail" class="md-nav__link">
    <span class="md-ellipsis">
      
        24.2.2. La classe [SendAdminMail]
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#243-le-serveur-web" class="md-nav__link">
    <span class="md-ellipsis">
      
        24.3. Le serveur web
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="24.3. Le serveur web">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2431-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        24.3.1. Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2432-le-script-principal-main" class="md-nav__link">
    <span class="md-ellipsis">
      
        24.3.2. Le script principal [main]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2433-le-controleur-index_controller" class="md-nav__link">
    <span class="md-ellipsis">
      
        24.3.3. Le contrôleur [index_controller]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2434-execution" class="md-nav__link">
    <span class="md-ellipsis">
      
        24.3.4. Exécution
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#244-le-client-web" class="md-nav__link">
    <span class="md-ellipsis">
      
        24.4. Le client web
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="24.4. Le client web">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2441-la-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        24.4.1. La configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2442-la-couche-dao" class="md-nav__link">
    <span class="md-ellipsis">
      
        24.4.2. La couche [dao]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2443-le-script-principal" class="md-nav__link">
    <span class="md-ellipsis">
      
        24.4.3. Le script principal
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2444-execution" class="md-nav__link">
    <span class="md-ellipsis">
      
        24.4.4. Exécution
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#245-tests-de-la-couche-dao" class="md-nav__link">
    <span class="md-ellipsis">
      
        24.5. Tests de la couche [dao]
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-8.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    25. Exercice d’application : version 8
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="du-dictionnaire-a-xml-et-vice-versa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    26. Du dictionnaire à XML et vice-versa
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-9.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    27. Exercice d’application : version 9
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-10.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    28. Exercice d’application : version 10
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-11.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    29. Exercice d’application : version 11
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    30. Exercice d’application : version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="clients-web-pour-les-services-json-et-xml-de-la-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    31. Clients web pour les services jSON et XML de la version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="le-mode-html-de-la-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    32. Le mode HTML de la version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-13.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    33. Exercice d’application : version 13
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-14.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    34. Exercice d’application : version 14
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-15.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    35. Exercice d’application : version 15
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-16.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    36. Exercice d’application : version 16
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-17.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    37. Exercice d’application : version 17
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-18.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    38. Exercice d’application : version 18
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="conclusion.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    39. Conclusion
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="24-exercice-dapplication-version-7">24. Exercice d’application : version 7</h1>
<h2 id="241-introduction">24.1. Introduction</h2>
<p>La version 7 de l’application de calcul de l’impôt est identique à la version 6 aux détails près suivants : </p>
<ul>
<li>le client web va lancer simultanément plusieurs requêtes HTTP. Dans la version précédente ces requêtes étaient lancées séquentiellement. Le serveur ne traitait alors à tout moment qu’une unique requête ;</li>
<li>le serveur sera multi-threadé : il pourra traiter plusieurs requêtes simultanément ;</li>
<li>pour suivre l’exécution de ces requêtes, on va doter le serveur web d’un logueur avec lequel on loguera dans un fichier texte les moments importants du traitement des requêtes ;</li>
<li>le serveur enverra un mail à l’administrateur de l’application lorsqu’il rencontrera un problème qui l’empêchera de se lancer, typiquement un problème avec la base de données associée au serveur web ;
L’architecture de l’application ne change pas :</li>
</ul>
<p><img src="images/10000000000003BE000003E50F9DB416.png" style="width:11.082cm;height:11.531cm;" alt="Image" /></p>
<p>L’arborescence des scripts est la suivante :</p>
<p><img src="images/1000000000000188000001CF823675AD.png" style="width:4.522cm;height:5.351cm;" alt="Image" /></p>
<p>Le dossier <strong>[http-servers/02]</strong> est d’abord obtenue par recopie du dossier <strong>[http-servers/01]</strong>. On y fait ensuite des modifications.</p>
<h2 id="242-les-utilitaires">24.2. Les utilitaires</h2>
<p><img src="images/100000000000018E000001473BCE220A.png" style="width:4.601cm;height:3.781cm;" alt="Image" /></p>
<h3 id="2421-la-classe-logger">24.2.1. La classe [Logger]</h3>
<p>La classe <strong>[Logger]</strong> va permettre de loguer dans un fichier texte certaines actions du serveur web :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">codecs</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">current_thread</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">Logger</span><span class="p">:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="c1"># attribut de classe</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="n">verrou</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="c1"># constructeur</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>            <span class="c1"># on ouvre le fichier en mode append (a)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__resource</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">logs_filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>            <span class="k">raise</span> <span class="n">ImpôtsError</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="c1"># écriture d&#39;un log</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="c1"># date / heure du moment</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="c1"># nom du thread</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="n">thread_name</span> <span class="o">=</span> <span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="c1"># on ne veut pas être dérangé pendant qu&#39;on écrira dans le fichier de logs</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="c1"># on demande l&#39;objet de synchronisation (= le verrou) de la classe - un seul thread l&#39;obtiendra</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="n">Logger</span><span class="o">.</span><span class="n">verrou</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>            <span class="c1"># écriture du log</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__resource</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">today</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">now</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>            <span class="c1"># écriture immédiate - sinon le texte ne sera écrit que lors de la fermeture du flux d&#39;écriture</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>            <span class="c1"># or on veut suivre les logs dans le temps</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__resource</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>            <span class="c1"># on libère l&#39;objet de synchronisation (= le verrou) pour qu&#39;un autre thread puisse l&#39;obtenir</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>            <span class="n">Logger</span><span class="o">.</span><span class="n">verrou</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="c1"># libération des ressources</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="c1"># fermeture du fichier</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resource</span><span class="p">:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__resource</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 10-11 : on définit un attribut de classe. Un attribut de classe est une propriété partagée par toutes les instances de la classe. On la référence par la notation <strong>[Classe.attribut_de_classe]</strong> (lignes 30, 39). L’attribut de classe <strong>[verrou]</strong> sera un objet de synchronisation pour tous les threads exécutant le code des lignes 31-36 ;</li>
<li>lignes 14-19 : le constructeur reçoit le nom absolu du fichier de logs. Ce fichier est alors ouvert et le descripteur de fichier récupéré est mémorisé dans la classe ;</li>
<li>ligne 17 : le fichier de logs est ouvert en mode ‘append’ (a). Chaque ligne écrite le sera à la fin du fichier ;</li>
<li>lignes 22-39 : la méthode <strong>[write]</strong> permet d’écrire dans le fichier de logs un message passé en paramètre. A celui-ci sont accolées deux informations :</li>
<li>ligne 24 : la date du jour ;</li>
<li>ligne 25 : l’heure du moment ;</li>
<li>ligne 27 : le nom du thread qui écrit le log. Il ne faut pas oublier ici qu’une application web sert plusieurs utilisateurs à la fois. Toute requête se voit attribuer un thread pour l’exécuter. Si ce thread est mis en pause, typiquement pour une opération d’ entrée / sortie (réseau, fichiers, base de données), alors le processeur sera donné à un autre thread. A cause de ces interruptions possibles, on ne peut pas être sûrs qu’un thread va réussir à écrire une ligne dans le fichier de logs sans être interrompu. On risque alors de voir des logs de deux threads différents se mélanger. Le risque est faible, peut-être même nul, mais on a néanmoins décidé de montrer comment synchroniser l’accès de deux threads à une ressource commune, ici le fichier de logs ;</li>
<li>ligne 30 : avant d’écrire, le thread demande la clé de la porte d’entrée. La clé demandée est celle créée ligne 11. Elle est effectivement unique : un attribut de classe est unique pour toutes les instances de la classe ;</li>
<li>au temps T1, un thread Thread1 obtient la clé. Il peut alors exécuter la ligne 33 ;</li>
<li>au temps T2, le thread Thread1 est mis en pause avant même d’avoir terminé l’écriture du log ;</li>
<li>au temps T3, le thread Thread2 qui a obtenu le processeur doit lui aussi écrire un log. Il arrive ainsi à la ligne 30 où il demande la clé de la porte d’entrée. On lui répond qu’un autre thread l’a déjà. Il est alors automatiquement mis en pause. Il en sera ainsi de tous les threads qui demanderont cette clé ;</li>
<li>au temps T4, le thread Thread1 qui avait été mis en pause retrouve le processeur. Il termine alors l’écriture du log ;</li>
<li>lignes 32-36 : l’écriture dans le fichier de logs se fait en deux temps :</li>
<li>ligne 33 : le descripteur de fichier obtenu ligne 17 travaille avec un buffer. L’opération <strong>[write]</strong> de la ligne 33 écrit dans ce buffer mais pas directement dans le fichier. Le buffer est ensuite vidé dans le fichier dans certaines conditions :</li>
<li>le buffer est plein ;</li>
<li>le descripteur de fichier subit une opération <strong>[close]</strong> ou <strong>[flush]</strong> ;</li>
<li>ligne 36 : on force l’écriture de la ligne de log dans le fichier. On fait cela parce qu’on veut voir s’intercaler entre eux les logs des différents threads. Si on ne fait pas ça, les logs d’un thread seront tous écrits en même temps lors de la fermeture du descripteur, ligne 45. Il serait alors beaucoup plus difficile de voir que certains threads ont été arrêtés : il faudrait regarder les heures dans les logs ;</li>
<li>ligne 39 : le thread Thread1 rend la clé qu’on lui avait donnée. Elle va pouvoir être donnée à un autre thread ;</li>
<li>ligne 22 : la méthode <strong>[write]</strong> est donc synchronisée : un seul thread à la fois écrit dans le fichier de logs. La clé du dispositif est la ligne 30 : quoiqu’il arrive, seul un thread récupère la clé de passage à la ligne suivante. Il la garde tant qu’il ne la rend pas (ligne 39) ;</li>
<li>lignes 41-45 : la méthode <strong>[close]</strong> permet de libérer les ressources allouées au descripteur du fichier de logs ;
Les logs écrits dans le fichier de logs auront l’allure suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">22</span> <span class="mi">20</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">52.992152</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="err">…</span>
</code></pre></div></td></tr></table></div>
<h3 id="2422-la-classe-sendadminmail">24.2.2. La classe [SendAdminMail]</h3>
<p>La classe <strong>[SendAminMail]</strong> permet d’envoyer un message à l’administrateur de l’application lorsque celle-ci ‘plante’.</p>
<p><img src="images/10000000000001820000019B2F5335EF.png" style="width:4.451cm;height:4.74cm;" alt="Image" /></p>
<p>La classe <strong>[SendAdminMail]</strong> est configurée dans le script <strong>[config]</strong> <strong>[2]</strong> de la façon suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a>        <span class="c1"># config serveur SMTP</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>        <span class="s2">&quot;adminMail&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>            <span class="c1"># serveur SMTP</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>            <span class="s2">&quot;smtp-server&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>            <span class="c1"># port du serveur SMTP</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>            <span class="s2">&quot;smtp-port&quot;</span><span class="p">:</span> <span class="s2">&quot;25&quot;</span><span class="p">,</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>            <span class="c1"># administrateur</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;guest@localhost.com&quot;</span><span class="p">,</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;guest@localhost.com&quot;</span><span class="p">,</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>            <span class="c1"># sujet du mail</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;plantage du serveur de calcul d&#39;impôts&quot;</span><span class="p">,</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>            <span class="c1"># tls à True si le serveur SMTP requiert une autorisation, à False sinon</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>            <span class="s2">&quot;tls&quot;</span><span class="p">:</span> <span class="kc">False</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>La classe <strong>[SendAminMail]</strong> reçoit le dictionnaire des lignes 2-13 ainsi que la configuration de l’envoi du mail. La classe est la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span>
<span class="normal"><a href="#__codelineno-3-24">24</a></span>
<span class="normal"><a href="#__codelineno-3-25">25</a></span>
<span class="normal"><a href="#__codelineno-3-26">26</a></span>
<span class="normal"><a href="#__codelineno-3-27">27</a></span>
<span class="normal"><a href="#__codelineno-3-28">28</a></span>
<span class="normal"><a href="#__codelineno-3-29">29</a></span>
<span class="normal"><a href="#__codelineno-3-30">30</a></span>
<span class="normal"><a href="#__codelineno-3-31">31</a></span>
<span class="normal"><a href="#__codelineno-3-32">32</a></span>
<span class="normal"><a href="#__codelineno-3-33">33</a></span>
<span class="normal"><a href="#__codelineno-3-34">34</a></span>
<span class="normal"><a href="#__codelineno-3-35">35</a></span>
<span class="normal"><a href="#__codelineno-3-36">36</a></span>
<span class="normal"><a href="#__codelineno-3-37">37</a></span>
<span class="normal"><a href="#__codelineno-3-38">38</a></span>
<span class="normal"><a href="#__codelineno-3-39">39</a></span>
<span class="normal"><a href="#__codelineno-3-40">40</a></span>
<span class="normal"><a href="#__codelineno-3-41">41</a></span>
<span class="normal"><a href="#__codelineno-3-42">42</a></span>
<span class="normal"><a href="#__codelineno-3-43">43</a></span>
<span class="normal"><a href="#__codelineno-3-44">44</a></span>
<span class="normal"><a href="#__codelineno-3-45">45</a></span>
<span class="normal"><a href="#__codelineno-3-46">46</a></span>
<span class="normal"><a href="#__codelineno-3-47">47</a></span>
<span class="normal"><a href="#__codelineno-3-48">48</a></span>
<span class="normal"><a href="#__codelineno-3-49">49</a></span>
<span class="normal"><a href="#__codelineno-3-50">50</a></span>
<span class="normal"><a href="#__codelineno-3-51">51</a></span>
<span class="normal"><a href="#__codelineno-3-52">52</a></span>
<span class="normal"><a href="#__codelineno-3-53">53</a></span>
<span class="normal"><a href="#__codelineno-3-54">54</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1"># imports</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">smtplib</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">email.mime.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">MIMEText</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">email.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">formatdate</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">SendAdminMail</span><span class="p">:</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>    <span class="c1"># -----------------------------------------------------------------------</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>        <span class="c1"># envoie message au serveur smtp config[&#39;smtp-server&#39;] sur le port config[smtp-port]</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>        <span class="c1"># si config[&#39;tls&#39;] est vrai, le support TLS sera utilisé</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>        <span class="c1"># le mail est envoyé de la part de config[&#39;from&#39;]</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a>        <span class="c1"># pour le destinataire config[&#39;to&#39;]</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a>        <span class="c1"># le message a le sujet config[&#39;subject&#39;]</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>        <span class="c1"># on trouve la référence d&#39;un logueur dans config[&#39;logger&#39;]</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a>        <span class="c1"># on récupère le logueur dans la config - peut être égal à None</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;logger&quot;</span><span class="p">]</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a>        <span class="c1"># serveur SMTP</span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a>        <span class="n">server</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a>        <span class="c1"># on envoie le message</span>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a>            <span class="c1"># le serveur SMTP</span>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a>            <span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;smtp-server&quot;</span><span class="p">])</span>
<a id="__codelineno-3-27" name="__codelineno-3-27"></a>            <span class="c1"># mode verbose</span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a>            <span class="n">server</span><span class="o">.</span><span class="n">set_debuglevel</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-3-29" name="__codelineno-3-29"></a>            <span class="c1"># connexion sécurisée ?</span>
<a id="__codelineno-3-30" name="__codelineno-3-30"></a>            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;tls&#39;</span><span class="p">]:</span>
<a id="__codelineno-3-31" name="__codelineno-3-31"></a>                <span class="c1"># début dialogue de sécurisation</span>
<a id="__codelineno-3-32" name="__codelineno-3-32"></a>                <span class="n">server</span><span class="o">.</span><span class="n">starttls</span><span class="p">()</span>
<a id="__codelineno-3-33" name="__codelineno-3-33"></a>                <span class="c1"># authentification</span>
<a id="__codelineno-3-34" name="__codelineno-3-34"></a>                <span class="n">server</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">])</span>
<a id="__codelineno-3-35" name="__codelineno-3-35"></a>            <span class="c1"># construction d&#39;un message Multipart - c&#39;est ce message qui sera envoyé</span>
<a id="__codelineno-3-36" name="__codelineno-3-36"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-3-37" name="__codelineno-3-37"></a>            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;From&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">]</span>
<a id="__codelineno-3-38" name="__codelineno-3-38"></a>            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span>
<a id="__codelineno-3-39" name="__codelineno-3-39"></a>            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatdate</span><span class="p">(</span><span class="n">localtime</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-40" name="__codelineno-3-40"></a>            <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span>
<a id="__codelineno-3-41" name="__codelineno-3-41"></a>            <span class="c1"># on envoie le message</span>
<a id="__codelineno-3-42" name="__codelineno-3-42"></a>            <span class="n">server</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-3-43" name="__codelineno-3-43"></a>            <span class="c1"># log - le logger peut ne pas exister</span>
<a id="__codelineno-3-44" name="__codelineno-3-44"></a>            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-3-45" name="__codelineno-3-45"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SendAdminMail] Message envoyé à [</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] : [</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-3-46" name="__codelineno-3-46"></a>        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-3-47" name="__codelineno-3-47"></a>            <span class="c1"># log- le logger peutne pas exister</span>
<a id="__codelineno-3-48" name="__codelineno-3-48"></a>            <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-3-49" name="__codelineno-3-49"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-3-50" name="__codelineno-3-50"></a>                    <span class="sa">f</span><span class="s2">&quot;[SendAdminMail] Erreur [</span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">] lors de l&#39;envoi à [</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] du message [</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">] : </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-3-51" name="__codelineno-3-51"></a>        <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-3-52" name="__codelineno-3-52"></a>            <span class="c1"># on a fini - on libère les ressources mobilisées par la fonction</span>
<a id="__codelineno-3-53" name="__codelineno-3-53"></a>            <span class="k">if</span> <span class="n">server</span><span class="p">:</span>
<a id="__codelineno-3-54" name="__codelineno-3-54"></a>                <span class="n">server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 24-54 : on retrouve le code déjà étudié dans l’exemple |<a href="#_scripts_[smtp/02]_:"><u><u>smtp/02</u></u></a>| ;</li>
<li>ligne 20 : on récupère la référence d’un logueur. Celui-ci est utilisé aux lignes 45 et 49 ;</li>
</ul>
<h2 id="243-le-serveur-web">24.3. Le serveur web</h2>
<h3 id="2431-configuration">24.3.1. Configuration</h3>
<p>La configuration du serveur est très semblable à celle du serveur étudié précédemment. Seul le fichier <strong>[config.py]</strong> évolue légèrement :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span>
<span class="normal"><a href="#__codelineno-4-29">29</a></span>
<span class="normal"><a href="#__codelineno-4-30">30</a></span>
<span class="normal"><a href="#__codelineno-4-31">31</a></span>
<span class="normal"><a href="#__codelineno-4-32">32</a></span>
<span class="normal"><a href="#__codelineno-4-33">33</a></span>
<span class="normal"><a href="#__codelineno-4-34">34</a></span>
<span class="normal"><a href="#__codelineno-4-35">35</a></span>
<span class="normal"><a href="#__codelineno-4-36">36</a></span>
<span class="normal"><a href="#__codelineno-4-37">37</a></span>
<span class="normal"><a href="#__codelineno-4-38">38</a></span>
<span class="normal"><a href="#__codelineno-4-39">39</a></span>
<span class="normal"><a href="#__codelineno-4-40">40</a></span>
<span class="normal"><a href="#__codelineno-4-41">41</a></span>
<span class="normal"><a href="#__codelineno-4-42">42</a></span>
<span class="normal"><a href="#__codelineno-4-43">43</a></span>
<span class="normal"><a href="#__codelineno-4-44">44</a></span>
<span class="normal"><a href="#__codelineno-4-45">45</a></span>
<span class="normal"><a href="#__codelineno-4-46">46</a></span>
<span class="normal"><a href="#__codelineno-4-47">47</a></span>
<span class="normal"><a href="#__codelineno-4-48">48</a></span>
<span class="normal"><a href="#__codelineno-4-49">49</a></span>
<span class="normal"><a href="#__codelineno-4-50">50</a></span>
<span class="normal"><a href="#__codelineno-4-51">51</a></span>
<span class="normal"><a href="#__codelineno-4-52">52</a></span>
<span class="normal"><a href="#__codelineno-4-53">53</a></span>
<span class="normal"><a href="#__codelineno-4-54">54</a></span>
<span class="normal"><a href="#__codelineno-4-55">55</a></span>
<span class="normal"><a href="#__codelineno-4-56">56</a></span>
<span class="normal"><a href="#__codelineno-4-57">57</a></span>
<span class="normal"><a href="#__codelineno-4-58">58</a></span>
<span class="normal"><a href="#__codelineno-4-59">59</a></span>
<span class="normal"><a href="#__codelineno-4-60">60</a></span>
<span class="normal"><a href="#__codelineno-4-61">61</a></span>
<span class="normal"><a href="#__codelineno-4-62">62</a></span>
<span class="normal"><a href="#__codelineno-4-63">63</a></span>
<span class="normal"><a href="#__codelineno-4-64">64</a></span>
<span class="normal"><a href="#__codelineno-4-65">65</a></span>
<span class="normal"><a href="#__codelineno-4-66">66</a></span>
<span class="normal"><a href="#__codelineno-4-67">67</a></span>
<span class="normal"><a href="#__codelineno-4-68">68</a></span>
<span class="normal"><a href="#__codelineno-4-69">69</a></span>
<span class="normal"><a href="#__codelineno-4-70">70</a></span>
<span class="normal"><a href="#__codelineno-4-71">71</a></span>
<span class="normal"><a href="#__codelineno-4-72">72</a></span>
<span class="normal"><a href="#__codelineno-4-73">73</a></span>
<span class="normal"><a href="#__codelineno-4-74">74</a></span>
<span class="normal"><a href="#__codelineno-4-75">75</a></span>
<span class="normal"><a href="#__codelineno-4-76">76</a></span>
<span class="normal"><a href="#__codelineno-4-77">77</a></span>
<span class="normal"><a href="#__codelineno-4-78">78</a></span>
<span class="normal"><a href="#__codelineno-4-79">79</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>    <span class="c1"># étape 1 ------</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>    <span class="c1"># dossier de ce fichier</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>    <span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>    <span class="c1"># chemin racine</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>    <span class="n">root_dir</span> <span class="o">=</span> <span class="s2">&quot;C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020&quot;</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>    <span class="c1"># dépendances absolues</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>    <span class="n">absolute_dependencies</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a>        <span class="c1"># dossiers du projet</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a>        <span class="c1"># BaseEntity, MyException</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/classes/02/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a>        <span class="c1"># InterfaceImpôtsDao, InterfaceImpôtsMétier, InterfaceImpôtsUi</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/interfaces&quot;</span><span class="p">,</span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a>        <span class="c1"># AbstractImpôtsdao, ImpôtsConsole, ImpôtsMétier</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/services&quot;</span><span class="p">,</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a>        <span class="c1"># ImpotsDaoWithAdminDataInDatabase</span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v05/services&quot;</span><span class="p">,</span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a>        <span class="c1"># AdminData, ImpôtsError, TaxPayer</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a>        <span class="c1"># Constantes, tranches</span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v05/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a>        <span class="c1"># IndexController</span>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/http-servers/01/controllers&quot;</span><span class="p">,</span>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a>        <span class="c1"># scripts [config_database, config_layers]</span>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a>        <span class="n">script_dir</span><span class="p">,</span>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a>        <span class="c1"># Logger, SendAdminMail</span>
<a id="__codelineno-4-32" name="__codelineno-4-32"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../utilities&quot;</span><span class="p">,</span>
<a id="__codelineno-4-33" name="__codelineno-4-33"></a>    <span class="p">]</span>
<a id="__codelineno-4-34" name="__codelineno-4-34"></a>    <span class="c1"># on fixe le syspath</span>
<a id="__codelineno-4-35" name="__codelineno-4-35"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_syspath</span>
<a id="__codelineno-4-36" name="__codelineno-4-36"></a>    <span class="n">set_syspath</span><span class="p">(</span><span class="n">absolute_dependencies</span><span class="p">)</span>
<a id="__codelineno-4-37" name="__codelineno-4-37"></a>
<a id="__codelineno-4-38" name="__codelineno-4-38"></a>    <span class="c1"># étape 2 ------</span>
<a id="__codelineno-4-39" name="__codelineno-4-39"></a>    <span class="c1"># configuration de l&#39;application</span>
<a id="__codelineno-4-40" name="__codelineno-4-40"></a>    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
<a id="__codelineno-4-41" name="__codelineno-4-41"></a>        <span class="c1"># utilisateurs autorisés à utiliser l&#39;application</span>
<a id="__codelineno-4-42" name="__codelineno-4-42"></a>        <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-4-43" name="__codelineno-4-43"></a>            <span class="p">{</span>
<a id="__codelineno-4-44" name="__codelineno-4-44"></a>                <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
<a id="__codelineno-4-45" name="__codelineno-4-45"></a>                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span>
<a id="__codelineno-4-46" name="__codelineno-4-46"></a>            <span class="p">}</span>
<a id="__codelineno-4-47" name="__codelineno-4-47"></a>        <span class="p">],</span>
<a id="__codelineno-4-48" name="__codelineno-4-48"></a>        <span class="c1"># fichier de logs</span>
<a id="__codelineno-4-49" name="__codelineno-4-49"></a>        <span class="s2">&quot;logsFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../data/logs/logs.txt&quot;</span><span class="p">,</span>
<a id="__codelineno-4-50" name="__codelineno-4-50"></a>        <span class="c1"># config serveur SMTP</span>
<a id="__codelineno-4-51" name="__codelineno-4-51"></a>        <span class="s2">&quot;adminMail&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-4-52" name="__codelineno-4-52"></a>            <span class="c1"># serveur SMTP</span>
<a id="__codelineno-4-53" name="__codelineno-4-53"></a>            <span class="s2">&quot;smtp-server&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
<a id="__codelineno-4-54" name="__codelineno-4-54"></a>            <span class="c1"># port du serveur SMTP</span>
<a id="__codelineno-4-55" name="__codelineno-4-55"></a>            <span class="s2">&quot;smtp-port&quot;</span><span class="p">:</span> <span class="s2">&quot;25&quot;</span><span class="p">,</span>
<a id="__codelineno-4-56" name="__codelineno-4-56"></a>            <span class="c1"># administrateur</span>
<a id="__codelineno-4-57" name="__codelineno-4-57"></a>            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;guest@localhost.com&quot;</span><span class="p">,</span>
<a id="__codelineno-4-58" name="__codelineno-4-58"></a>            <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;guest@localhost.com&quot;</span><span class="p">,</span>
<a id="__codelineno-4-59" name="__codelineno-4-59"></a>            <span class="c1"># sujet du mail</span>
<a id="__codelineno-4-60" name="__codelineno-4-60"></a>            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;plantage du serveur de calcul d&#39;impôts&quot;</span><span class="p">,</span>
<a id="__codelineno-4-61" name="__codelineno-4-61"></a>            <span class="c1"># tls à True si le serveur SMTP requiert une autorisation, à False sinon</span>
<a id="__codelineno-4-62" name="__codelineno-4-62"></a>            <span class="s2">&quot;tls&quot;</span><span class="p">:</span> <span class="kc">False</span>
<a id="__codelineno-4-63" name="__codelineno-4-63"></a>        <span class="p">},</span>
<a id="__codelineno-4-64" name="__codelineno-4-64"></a>        <span class="c1"># durée pause thread en secondes</span>
<a id="__codelineno-4-65" name="__codelineno-4-65"></a>        <span class="s2">&quot;sleep_time&quot;</span><span class="p">:</span> <span class="mi">0</span>
<a id="__codelineno-4-66" name="__codelineno-4-66"></a>    <span class="p">})</span>
<a id="__codelineno-4-67" name="__codelineno-4-67"></a>
<a id="__codelineno-4-68" name="__codelineno-4-68"></a>    <span class="c1"># étape 3 ------</span>
<a id="__codelineno-4-69" name="__codelineno-4-69"></a>    <span class="c1"># configuration base de données</span>
<a id="__codelineno-4-70" name="__codelineno-4-70"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config_database</span>
<a id="__codelineno-4-71" name="__codelineno-4-71"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_database</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-4-72" name="__codelineno-4-72"></a>
<a id="__codelineno-4-73" name="__codelineno-4-73"></a>    <span class="c1"># étape 4 ------</span>
<a id="__codelineno-4-74" name="__codelineno-4-74"></a>    <span class="c1"># instanciation des couches de l&#39;application</span>
<a id="__codelineno-4-75" name="__codelineno-4-75"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config_layers</span>
<a id="__codelineno-4-76" name="__codelineno-4-76"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_layers</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-4-77" name="__codelineno-4-77"></a>
<a id="__codelineno-4-78" name="__codelineno-4-78"></a>    <span class="c1"># on rend la configuration</span>
<a id="__codelineno-4-79" name="__codelineno-4-79"></a>    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 40-66 : on ajoute dans le dictionnaire de configuration du serveur, les éléments concernant le logueur (ligne 49) et celles concernant l’envoi d’un mail d’alerte à l’administrateur de l’application (lignes 51-63) ;</li>
<li>ligne 65 : pour mieux voir les threads en action on va imposer à certains de s’arrêter. <strong>[sleep_time]</strong> est la durée de l’arrêt exprimée en secondes ;</li>
<li>lignes 27-28 : on notera qu’on utilise le contrôleur <strong>[index_controller]</strong> de la version 6 précédente ;</li>
</ul>
<h3 id="2432-le-script-principal-main">24.3.2. Le script principal [main]</h3>
<p>Le script principal <strong>[main]</strong> est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">  1</a></span>
<span class="normal"><a href="#__codelineno-5-2">  2</a></span>
<span class="normal"><a href="#__codelineno-5-3">  3</a></span>
<span class="normal"><a href="#__codelineno-5-4">  4</a></span>
<span class="normal"><a href="#__codelineno-5-5">  5</a></span>
<span class="normal"><a href="#__codelineno-5-6">  6</a></span>
<span class="normal"><a href="#__codelineno-5-7">  7</a></span>
<span class="normal"><a href="#__codelineno-5-8">  8</a></span>
<span class="normal"><a href="#__codelineno-5-9">  9</a></span>
<span class="normal"><a href="#__codelineno-5-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-5-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-5-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-5-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-5-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-5-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-5-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-5-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-5-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-5-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-5-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-5-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-5-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-5-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-5-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-5-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-5-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-5-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-5-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-5-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-5-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-5-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-5-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-5-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-5-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-5-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-5-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-5-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-5-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-5-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-5-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-5-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-5-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-5-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-5-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-5-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-5-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-5-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-5-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-5-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-5-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-5-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-5-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-5-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-5-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-5-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-5-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-5-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-5-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-5-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-5-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-5-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-5-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-5-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-5-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-5-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-5-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-5-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-5-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-5-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-5-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-5-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-5-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-5-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-5-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-5-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-5-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-5-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-5-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-5-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-5-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-5-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-5-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-5-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-5-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-5-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-5-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-5-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-5-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-5-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-5-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-5-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-5-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-5-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-5-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-5-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-5-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-5-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-5-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-5-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-5-100">100</a></span>
<span class="normal"><a href="#__codelineno-5-101">101</a></span>
<span class="normal"><a href="#__codelineno-5-102">102</a></span>
<span class="normal"><a href="#__codelineno-5-103">103</a></span>
<span class="normal"><a href="#__codelineno-5-104">104</a></span>
<span class="normal"><a href="#__codelineno-5-105">105</a></span>
<span class="normal"><a href="#__codelineno-5-106">106</a></span>
<span class="normal"><a href="#__codelineno-5-107">107</a></span>
<span class="normal"><a href="#__codelineno-5-108">108</a></span>
<span class="normal"><a href="#__codelineno-5-109">109</a></span>
<span class="normal"><a href="#__codelineno-5-110">110</a></span>
<span class="normal"><a href="#__codelineno-5-111">111</a></span>
<span class="normal"><a href="#__codelineno-5-112">112</a></span>
<span class="normal"><a href="#__codelineno-5-113">113</a></span>
<span class="normal"><a href="#__codelineno-5-114">114</a></span>
<span class="normal"><a href="#__codelineno-5-115">115</a></span>
<span class="normal"><a href="#__codelineno-5-116">116</a></span>
<span class="normal"><a href="#__codelineno-5-117">117</a></span>
<span class="normal"><a href="#__codelineno-5-118">118</a></span>
<span class="normal"><a href="#__codelineno-5-119">119</a></span>
<span class="normal"><a href="#__codelineno-5-120">120</a></span>
<span class="normal"><a href="#__codelineno-5-121">121</a></span>
<span class="normal"><a href="#__codelineno-5-122">122</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1"># on attend un paramètre mysql ou pgres</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="n">syntaxe</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> mysql / pgres&quot;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="n">erreur</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>    <span class="n">sgbd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;mysql&quot;</span> <span class="ow">and</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;pgres&quot;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syntaxe : </span><span class="si">{</span><span class="n">syntaxe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s1">&#39;sgbd&#39;</span><span class="p">:</span> <span class="n">sgbd</span><span class="p">})</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="c1"># dépendances</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">Flask</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_httpauth</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="kn">import</span><span class="w"> </span><span class="nn">index_controller</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="kn">from</span><span class="w"> </span><span class="nn">SendAdminMail</span><span class="w"> </span><span class="kn">import</span> <span class="n">SendAdminMail</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="kn">from</span><span class="w"> </span><span class="nn">myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">json_response</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">Logger</span>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">randint</span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="c1"># gestionnaire d&#39;authentification</span>
<a id="__codelineno-5-31" name="__codelineno-5-31"></a><span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">()</span>
<a id="__codelineno-5-32" name="__codelineno-5-32"></a>
<a id="__codelineno-5-33" name="__codelineno-5-33"></a>
<a id="__codelineno-5-34" name="__codelineno-5-34"></a><span class="nd">@auth</span><span class="o">.</span><span class="n">verify_password</span>
<a id="__codelineno-5-35" name="__codelineno-5-35"></a><span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">login</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<a id="__codelineno-5-36" name="__codelineno-5-36"></a>    <span class="c1"># liste des utilisateurs</span>
<a id="__codelineno-5-37" name="__codelineno-5-37"></a>    <span class="n">users</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>
<a id="__codelineno-5-38" name="__codelineno-5-38"></a>    <span class="c1"># on parcourt cette liste</span>
<a id="__codelineno-5-39" name="__codelineno-5-39"></a>    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
<a id="__codelineno-5-40" name="__codelineno-5-40"></a>        <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;login&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">login</span> <span class="ow">and</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">password</span><span class="p">:</span>
<a id="__codelineno-5-41" name="__codelineno-5-41"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-5-42" name="__codelineno-5-42"></a>    <span class="c1"># on n&#39;a pas trouvé</span>
<a id="__codelineno-5-43" name="__codelineno-5-43"></a>    <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-5-44" name="__codelineno-5-44"></a>
<a id="__codelineno-5-45" name="__codelineno-5-45"></a>
<a id="__codelineno-5-46" name="__codelineno-5-46"></a><span class="c1"># envoi d&#39;un mail à l&#39;administrateur</span>
<a id="__codelineno-5-47" name="__codelineno-5-47"></a><span class="k">def</span><span class="w"> </span><span class="nf">send_adminmail</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-5-48" name="__codelineno-5-48"></a>    <span class="c1"># on envoie un mail à l&#39;administrateur de l&#39;application</span>
<a id="__codelineno-5-49" name="__codelineno-5-49"></a>    <span class="n">config_mail</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;adminMail&quot;</span><span class="p">]</span>
<a id="__codelineno-5-50" name="__codelineno-5-50"></a>    <span class="n">config_mail</span><span class="p">[</span><span class="s2">&quot;logger&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;logger&#39;</span><span class="p">]</span>
<a id="__codelineno-5-51" name="__codelineno-5-51"></a>    <span class="n">SendAdminMail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">config_mail</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<a id="__codelineno-5-52" name="__codelineno-5-52"></a>
<a id="__codelineno-5-53" name="__codelineno-5-53"></a>
<a id="__codelineno-5-54" name="__codelineno-5-54"></a><span class="c1"># vérification du fichier de logs</span>
<a id="__codelineno-5-55" name="__codelineno-5-55"></a><span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-56" name="__codelineno-5-56"></a><span class="n">erreur</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-5-57" name="__codelineno-5-57"></a><span class="n">message_erreur</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-58" name="__codelineno-5-58"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-59" name="__codelineno-5-59"></a>    <span class="c1"># logueur</span>
<a id="__codelineno-5-60" name="__codelineno-5-60"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;logsFilename&quot;</span><span class="p">])</span>
<a id="__codelineno-5-61" name="__codelineno-5-61"></a><span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
<a id="__codelineno-5-62" name="__codelineno-5-62"></a>    <span class="c1"># log console</span>
<a id="__codelineno-5-63" name="__codelineno-5-63"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-64" name="__codelineno-5-64"></a>    <span class="c1"># on note l&#39;erreur</span>
<a id="__codelineno-5-65" name="__codelineno-5-65"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-5-66" name="__codelineno-5-66"></a>    <span class="n">message_erreur</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-5-67" name="__codelineno-5-67"></a><span class="c1"># on mémorise le logueur dans la config</span>
<a id="__codelineno-5-68" name="__codelineno-5-68"></a><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logger&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-5-69" name="__codelineno-5-69"></a><span class="c1"># gestion de l&#39;erreur</span>
<a id="__codelineno-5-70" name="__codelineno-5-70"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-5-71" name="__codelineno-5-71"></a>    <span class="c1"># mail à l&#39;administrateur</span>
<a id="__codelineno-5-72" name="__codelineno-5-72"></a>    <span class="n">send_adminmail</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">message_erreur</span><span class="p">)</span>
<a id="__codelineno-5-73" name="__codelineno-5-73"></a>    <span class="c1"># fin de l&#39;application</span>
<a id="__codelineno-5-74" name="__codelineno-5-74"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-75" name="__codelineno-5-75"></a>
<a id="__codelineno-5-76" name="__codelineno-5-76"></a><span class="c1"># log de démarrage</span>
<a id="__codelineno-5-77" name="__codelineno-5-77"></a><span class="n">log</span> <span class="o">=</span> <span class="s2">&quot;[serveur] démarrage du serveur&quot;</span>
<a id="__codelineno-5-78" name="__codelineno-5-78"></a><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">log</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-79" name="__codelineno-5-79"></a><span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
<a id="__codelineno-5-80" name="__codelineno-5-80"></a>
<a id="__codelineno-5-81" name="__codelineno-5-81"></a><span class="c1"># récupération des données de l&#39;administration fiscale</span>
<a id="__codelineno-5-82" name="__codelineno-5-82"></a><span class="n">erreur</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-5-83" name="__codelineno-5-83"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-84" name="__codelineno-5-84"></a>    <span class="c1"># admindata sera une donnée de portée application en lecture seule</span>
<a id="__codelineno-5-85" name="__codelineno-5-85"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;admindata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_admindata</span><span class="p">()</span>
<a id="__codelineno-5-86" name="__codelineno-5-86"></a>    <span class="c1"># log de réussite</span>
<a id="__codelineno-5-87" name="__codelineno-5-87"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[serveur] connexion à la base de données réussie</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-88" name="__codelineno-5-88"></a><span class="k">except</span> <span class="n">ImpôtsError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
<a id="__codelineno-5-89" name="__codelineno-5-89"></a>    <span class="c1"># on note l&#39;erreur</span>
<a id="__codelineno-5-90" name="__codelineno-5-90"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-5-91" name="__codelineno-5-91"></a>    <span class="c1"># log d&#39;erreur</span>
<a id="__codelineno-5-92" name="__codelineno-5-92"></a>    <span class="n">log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-5-93" name="__codelineno-5-93"></a>    <span class="c1"># console</span>
<a id="__codelineno-5-94" name="__codelineno-5-94"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
<a id="__codelineno-5-95" name="__codelineno-5-95"></a>    <span class="c1"># fichier de logs</span>
<a id="__codelineno-5-96" name="__codelineno-5-96"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">log</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-97" name="__codelineno-5-97"></a>    <span class="c1"># mail à l&#39;administrateur</span>
<a id="__codelineno-5-98" name="__codelineno-5-98"></a>    <span class="n">send_adminmail</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
<a id="__codelineno-5-99" name="__codelineno-5-99"></a>
<a id="__codelineno-5-100" name="__codelineno-5-100"></a><span class="c1"># le thread principal n&#39;a plus besoin du logger</span>
<a id="__codelineno-5-101" name="__codelineno-5-101"></a><span class="n">logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-5-102" name="__codelineno-5-102"></a>
<a id="__codelineno-5-103" name="__codelineno-5-103"></a><span class="c1"># s&#39;il y a eu erreur on s&#39;arrête</span>
<a id="__codelineno-5-104" name="__codelineno-5-104"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-5-105" name="__codelineno-5-105"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-5-106" name="__codelineno-5-106"></a>
<a id="__codelineno-5-107" name="__codelineno-5-107"></a><span class="c1"># l&#39;application Flask peut démarrer</span>
<a id="__codelineno-5-108" name="__codelineno-5-108"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-5-109" name="__codelineno-5-109"></a>
<a id="__codelineno-5-110" name="__codelineno-5-110"></a>
<a id="__codelineno-5-111" name="__codelineno-5-111"></a><span class="c1"># Home URL</span>
<a id="__codelineno-5-112" name="__codelineno-5-112"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-5-113" name="__codelineno-5-113"></a><span class="nd">@auth</span><span class="o">.</span><span class="n">login_required</span>
<a id="__codelineno-5-114" name="__codelineno-5-114"></a><span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
<a id="__codelineno-5-115" name="__codelineno-5-115"></a>    <span class="err">…</span>
<a id="__codelineno-5-116" name="__codelineno-5-116"></a>
<a id="__codelineno-5-117" name="__codelineno-5-117"></a>
<a id="__codelineno-5-118" name="__codelineno-5-118"></a><span class="c1"># main uniquement</span>
<a id="__codelineno-5-119" name="__codelineno-5-119"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-5-120" name="__codelineno-5-120"></a>    <span class="c1"># on lance le serveur</span>
<a id="__codelineno-5-121" name="__codelineno-5-121"></a>    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ENV</span><span class="o">=</span><span class="s2">&quot;development&quot;</span><span class="p">,</span> <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-122" name="__codelineno-5-122"></a>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">threaded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 1-10 : le script attend un paramètre <strong>[mysql / pgres]</strong> qui lui indique le SGBD à utiliser ;</li>
<li>lignes 12-14 : l’application est configurée (Python Path, couches, base de données) ;</li>
<li>lignes 16-28 : les dépendances nécessaires à l’application ;</li>
<li>lignes 30-43 : gestion de l’authentification ;</li>
<li>lignes 46-51 : une fonction qui envoie un mail à l’administrateur de l’application ;</li>
<li>la fonction attend deux paramètres :</li>
<li>config : un dictionnaire ayant les clés <strong>[adminMail]</strong> et <strong>[logger]</strong> ;</li>
<li>le message à envoyer ;</li>
<li>lignes 49-50 : on prépare la configuration de l’envoi ;</li>
<li>on envoie le mail ;</li>
<li>lignes 54-74 : on vérifie la présence du fichier de logs ;</li>
<li>ligne 70-74 : si on n’a pas réussi à ouvrir le fichier de logs, on envoie un mail à l’administrateur et on s’arrête ;</li>
<li>lignes 76-79 : on logue le démarrage du serveur ;</li>
<li>lignes 81-98 : on va chercher les données de l’administration fiscale en base de données ;</li>
<li>lignes 88-98 : si on n’a pas réussi à obtenir ces données, on logue l’erreur aussi bien sur la console que dans le fichier de logs ;</li>
<li>lignes 100-101 : le thread principal ne fera plus de logs (les threads créés n’utiliseront pas le même descripteur de fichier) ;</li>
<li>lignes 103-105 : si on n’a pas pu se connecter à la base de données, on s’arrête ;</li>
<li>ligne 122 : on lance le serveur en mode multithreadé ;
La fonction <strong>[index]</strong> (ligne 114) est la suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span>
<span class="normal"><a href="#__codelineno-6-32">32</a></span>
<span class="normal"><a href="#__codelineno-6-33">33</a></span>
<span class="normal"><a href="#__codelineno-6-34">34</a></span>
<span class="normal"><a href="#__codelineno-6-35">35</a></span>
<span class="normal"><a href="#__codelineno-6-36">36</a></span>
<span class="normal"><a href="#__codelineno-6-37">37</a></span>
<span class="normal"><a href="#__codelineno-6-38">38</a></span>
<span class="normal"><a href="#__codelineno-6-39">39</a></span>
<span class="normal"><a href="#__codelineno-6-40">40</a></span>
<span class="normal"><a href="#__codelineno-6-41">41</a></span>
<span class="normal"><a href="#__codelineno-6-42">42</a></span>
<span class="normal"><a href="#__codelineno-6-43">43</a></span>
<span class="normal"><a href="#__codelineno-6-44">44</a></span>
<span class="normal"><a href="#__codelineno-6-45">45</a></span>
<span class="normal"><a href="#__codelineno-6-46">46</a></span>
<span class="normal"><a href="#__codelineno-6-47">47</a></span>
<span class="normal"><a href="#__codelineno-6-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c1"># Home URL</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="nd">@auth</span><span class="o">.</span><span class="n">login_required</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>        <span class="c1"># logger</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;logsFilename&quot;</span><span class="p">])</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>        <span class="c1"># on le mémorise dans une config associée au thread</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>        <span class="n">thread_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;logger&quot;</span><span class="p">:</span> <span class="n">logger</span><span class="p">}</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>        <span class="n">thread_name</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>        <span class="n">config</span><span class="p">[</span><span class="n">thread_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">thread_config</span><span class="p">}</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a>        <span class="c1"># on logue la requête</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[index] requête : </span><span class="si">{</span><span class="n">request</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a>        <span class="c1"># on interrompt le thread si cela a été demandé</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a>        <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;sleep_time&quot;</span><span class="p">]</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a>        <span class="k">if</span> <span class="n">sleep_time</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a>            <span class="c1"># la pause est aléatoire pour que certains threads soient interrompus et d&#39;autres pas</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a>            <span class="n">aléa</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a>            <span class="k">if</span> <span class="n">aléa</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a>                <span class="c1"># log avant pause</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[index] mis en pause du thread pendant </span><span class="si">{</span><span class="n">sleep_time</span><span class="si">}</span><span class="s2"> seconde(s)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a>                <span class="c1"># pause</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a>        <span class="c1"># on fait exécuter la requête par un contrôleur</span>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a>        <span class="n">résultat</span><span class="p">,</span> <span class="n">status_code</span> <span class="o">=</span> <span class="n">index_controller</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-6-27" name="__codelineno-6-27"></a>        <span class="c1"># y-a-t-il eu une erreur fatale ?</span>
<a id="__codelineno-6-28" name="__codelineno-6-28"></a>        <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">:</span>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a>            <span class="c1"># on envoie un mail à l&#39;administrateur de l&#39;application</span>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a>            <span class="n">config_mail</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;adminMail&quot;</span><span class="p">]</span>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a>            <span class="n">config_mail</span><span class="p">[</span><span class="s2">&quot;logger&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-6-32" name="__codelineno-6-32"></a>            <span class="n">SendAdminMail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">config_mail</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">résultat</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<a id="__codelineno-6-33" name="__codelineno-6-33"></a>        <span class="c1"># on logue la réponse</span>
<a id="__codelineno-6-34" name="__codelineno-6-34"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[index] </span><span class="si">{</span><span class="n">résultat</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-35" name="__codelineno-6-35"></a>        <span class="c1"># on envoie la réponse</span>
<a id="__codelineno-6-36" name="__codelineno-6-36"></a>        <span class="k">return</span> <span class="n">json_response</span><span class="p">(</span><span class="n">résultat</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>
<a id="__codelineno-6-37" name="__codelineno-6-37"></a>    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-6-38" name="__codelineno-6-38"></a>        <span class="c1"># on logue l&#39;erreur si c&#39;est possible</span>
<a id="__codelineno-6-39" name="__codelineno-6-39"></a>        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-6-40" name="__codelineno-6-40"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[index] </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-41" name="__codelineno-6-41"></a>        <span class="c1"># on prépare la réponse au client</span>
<a id="__codelineno-6-42" name="__codelineno-6-42"></a>        <span class="n">résultat</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;erreurs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]}}</span>
<a id="__codelineno-6-43" name="__codelineno-6-43"></a>        <span class="c1"># on envoie la réponse</span>
<a id="__codelineno-6-44" name="__codelineno-6-44"></a>        <span class="k">return</span> <span class="n">json_response</span><span class="p">(</span><span class="n">résultat</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">)</span>
<a id="__codelineno-6-45" name="__codelineno-6-45"></a>    <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-6-46" name="__codelineno-6-46"></a>        <span class="c1"># on ferme le fichier de logs s&#39;il a été ouvert</span>
<a id="__codelineno-6-47" name="__codelineno-6-47"></a>        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-6-48" name="__codelineno-6-48"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 4 : la fonction exécutée lorsqu’un utilisateur demande l’URL /. Parce que le serveur est multi-threadé (ligne 112), un thread va être créé pour exécuter la fonction. Ce thread peut à tout moment être interrompu et mis en pause pour reprendre son exécution un peu plus tard. Il faut toujours se souvenir de ce point lorsque le code accède à une ressource partagée par tous les threads. Une telle ressource est ici le fichier de logs : tous les threads écrivent dedans ;</li>
<li>ligne 8 : on crée une instance de logueur. Donc tous les threads auront une instance différence du logueur. Néanmoins tous ces logueurs pointent sur le même fichier de logs. Il est quand même important de noter que lorsqu’un thread ferme son logueur, cela n’a pas d’incidence sur les logueurs des autres threads ;</li>
<li>lignes 9-12 : on mémorise le logueur dans le dictionnaire <strong>[config]</strong> de l’application associé à une clé portant le nom du thread. Ainsi s’il y a n threads exécutés simultanément, on aura la création de n entrées dans le dictionnaire <strong>[config]</strong>. <strong>[config]</strong> est une ressource partagée entre tous les threads. Il peut donc y avoir un besoin de synchronisation. J’ai fait ici une hypothèse. J’ai supposé que si deux threads créaient simultanément leur entrée dans le fichier <strong>[config]</strong> et que l’un d’eux était interrompu par l’autre, cela n’avait pas d’incidence. Celui interrompu pouvait ultérieurement terminer la création de l’entrée. Si l’expérience montrait que cette hypothèse était fausse, il faudrait synchroniser l’accès à la ligne 12 ;</li>
<li>ligne 10 : on met le logueur dans un dictionnaire ;</li>
<li>ligne 11 : <strong>[</strong><strong>threading</strong><strong>.current_thread()</strong><strong>]</strong> est le thread qui exécute cette ligne, donc le thread qui exécute la fonction <strong>[index]</strong>. On note son nom. Chaque thread a un nom unique ;</li>
<li>ligne 12 : on mémorise la configuration du thread. A partir de maintenant, nous procèderons toujours ainsi : s’il y a des informations qui ne peuvent être partagées entre les threads, elles seront mises quand même dans la configuration générale, mais associées au nom du thread ;</li>
<li>ligne 14 : on logue la requête qu’on est en train d’exécuter ;</li>
<li>lignes 15-24 : de façon aléatoire on met certains threads en pause afin qu’ils laissent le processeur à un autre thread ;</li>
<li>ligne 16 : on récupère la durée de la pause (en secondes) dans la configuration ;</li>
<li>ligne 17 : il n’y a pause que si la durée de pause est différente de 0 ;</li>
<li>ligne 19 : un nombre entier aléatoire dans l’intervalle <strong>[0, 1]</strong>. Donc seules les valeurs 0 et 1 sont possibles ;</li>
<li>ligne 20 : la pause du thread ne se fait que si le nombre aléatoire est 1 ;</li>
<li>ligne 22 : on logue le fait que le thread va être interrompu ;</li>
<li>ligne 24 : on interrompt le thread pendant <strong>[</strong><strong>sleep_time</strong><strong>]</strong> secondes ;</li>
<li>ligne 26 : lorsque le thread se réveille, il fait exécuter la requête par le module <strong>[index_controller]</strong> ;</li>
<li>lignes 28-32 : si cette exécution provoque une erreur de type <strong>[500 INTERNAL SERVER ERROR]</strong>, on envoie un mail à l’administrateur ;</li>
<li>lignes 30-31 : on configure le dictionnaire <strong>[config_mail]</strong> qu’on va passer à la classe <strong>[SendAdminMail]</strong> ;</li>
<li>ligne 32 : le message envoyé à l’administrateur est la chaîne jSON du résultat qui va être envoyé au client ;</li>
<li>lignes 33-34 : on logue la réponse qu’on va envoyer au client (ligne 36) ;</li>
<li>lignes 37-44 : traitement d’une éventuelle exception ;</li>
<li>lignes 39-40 : si le logueur existe on logue l’erreur qui s’est produite ;</li>
<li>lignes 47-48 : on ferme le logueur s’il existe. Au final, le thread crée un logueur au début de la requête et le ferme lorsque celle-ci a été traitée ;</li>
</ul>
<h3 id="2433-le-controleur-index_controller">24.3.3. Le contrôleur [index_controller]</h3>
<p>Le contrôleur <strong>[index_controller]</strong> qui exécute les requêtes est celui de la version précédente :</p>
<p><img src="images/100000000000017E000001F38548F1CF.png" style="width:4.41cm;height:5.762cm;" alt="Image" /></p>
<h3 id="2434-execution">24.3.4. Exécution</h3>
<p>On lance le serveur Flask, le serveur de mails |<a href="#_Installation_d’un_serveur"><u><u>hMailServer</u></u></a>| ainsi que le lecteur de courrier |<a href="#_Installation_d'un_lecteur"><u><u>Thunderbird</u></u></a>|. On ne lance pas le SGBD. Le serveur s’arrête avec les logs console suivants :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span>
<span class="normal"><a href="#__codelineno-7-2">2</a></span>
<span class="normal"><a href="#__codelineno-7-3">3</a></span>
<span class="normal"><a href="#__codelineno-7-4">4</a></span>
<span class="normal"><a href="#__codelineno-7-5">5</a></span>
<span class="normal"><a href="#__codelineno-7-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">Scripts</span>\<span class="n">python</span><span class="o">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">st</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">cours</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">impots</span><span class="o">/</span><span class="n">http</span><span class="o">-</span><span class="n">servers</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="n">flask</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">py</span> <span class="n">mysql</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="p">[</span><span class="n">serveur</span><span class="p">]</span> <span class="n">démarrage</span> <span class="n">du</span> <span class="n">serveur</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="n">L</span><span class="s1">&#39;erreur suivante s&#39;</span><span class="n">est</span> <span class="n">produite</span> <span class="p">:</span> <span class="n">MyException</span><span class="p">[</span><span class="mi">27</span><span class="p">,</span> <span class="p">(</span><span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">InterfaceError</span><span class="p">)</span> <span class="mi">2003</span><span class="p">:</span> <span class="n">Can</span><span class="s1">&#39;t connect to MySQL server on &#39;</span><span class="n">localhost</span><span class="p">:</span><span class="mi">3306</span><span class="s1">&#39; (10061 Aucune connexion n’a pu être établie car l’ordinateur cible l’a expressément refusée)</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="p">(</span><span class="n">Background</span> <span class="n">on</span> <span class="n">this</span> <span class="n">error</span> <span class="n">at</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">sqlalche</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">e</span><span class="o">/</span><span class="mi">13</span><span class="o">/</span><span class="n">rvf5</span><span class="p">)]</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="n">Process</span> <span class="n">finished</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">2</span> 
</code></pre></div></td></tr></table></div>
<p>Le fichier de logs <strong>[logs.txt]</strong> est lui le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span>
<span class="normal"><a href="#__codelineno-8-2">2</a></span>
<span class="normal"><a href="#__codelineno-8-3">3</a></span>
<span class="normal"><a href="#__codelineno-8-4">4</a></span>
<span class="normal"><a href="#__codelineno-8-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mf">38.324752</span><span class="p">,</span> <span class="n">MainThread</span> <span class="p">:</span> <span class="p">[</span><span class="n">serveur</span><span class="p">]</span> <span class="n">démarrage</span> <span class="n">du</span> <span class="n">serveur</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mf">40.355510</span><span class="p">,</span> <span class="n">MainThread</span> <span class="p">:</span> <span class="n">L</span><span class="s1">&#39;erreur suivante s&#39;</span><span class="n">est</span> <span class="n">produite</span> <span class="p">:</span> <span class="n">MyException</span><span class="p">[</span><span class="mi">27</span><span class="p">,</span> <span class="p">(</span><span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">InterfaceError</span><span class="p">)</span> <span class="mi">2003</span><span class="p">:</span> <span class="n">Can</span><span class="s1">&#39;t connect to MySQL server on &#39;</span><span class="n">localhost</span><span class="p">:</span><span class="mi">3306</span><span class="s1">&#39; (10061 Aucune connexion n’a pu être établie car l’ordinateur cible l’a expressément refusée)</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="p">(</span><span class="n">Background</span> <span class="n">on</span> <span class="n">this</span> <span class="n">error</span> <span class="n">at</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">sqlalche</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">e</span><span class="o">/</span><span class="mi">13</span><span class="o">/</span><span class="n">rvf5</span><span class="p">)]</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mf">42.464206</span><span class="p">,</span> <span class="n">MainThread</span> <span class="p">:</span> <span class="p">[</span><span class="n">SendAdminMail</span><span class="p">]</span> <span class="n">Message</span> <span class="n">envoyé</span> <span class="n">à</span> <span class="p">[</span><span class="n">guest</span><span class="nd">@localhost</span><span class="o">.</span><span class="n">com</span><span class="p">]</span> <span class="p">:</span> <span class="p">[</span><span class="n">L</span><span class="s1">&#39;erreur suivante s&#39;</span><span class="n">est</span> <span class="n">produite</span> <span class="p">:</span> <span class="n">MyException</span><span class="p">[</span><span class="mi">27</span><span class="p">,</span> <span class="p">(</span><span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">InterfaceError</span><span class="p">)</span> <span class="mi">2003</span><span class="p">:</span> <span class="n">Can</span><span class="s1">&#39;t connect to MySQL server on &#39;</span><span class="n">localhost</span><span class="p">:</span><span class="mi">3306</span><span class="s1">&#39; (10061 Aucune connexion n’a pu être établie car l’ordinateur cible l’a expressément refusée)</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="p">(</span><span class="n">Background</span> <span class="n">on</span> <span class="n">this</span> <span class="n">error</span> <span class="n">at</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">sqlalche</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="n">e</span><span class="o">/</span><span class="mi">13</span><span class="o">/</span><span class="n">rvf5</span><span class="p">)]]</span>
</code></pre></div></td></tr></table></div>
<p>Avec Thunderbird, on vérifie les mails de l’administrateur <strong>[guest@localhost.com]</strong> :</p>
<p><img src="images/10000000000005540000028606FC64BC.png" style="width:15.77cm;height:7.46cm;" alt="Image" /></p>
<p>Puis on lance le SGBD et on demande l’URL [<a href="http://127.0.0.1:5000/?mari%C3%A9=oui&amp;enfants=3&amp;salaire=200000"><u><u>http://127.0.0.1:5000/?mari%C3%A9=oui&amp;enfants=3&amp;salaire=200000</u></u></a>]. Les logs deviennent les suivants :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span>
<span class="normal"><a href="#__codelineno-9-4">4</a></span>
<span class="normal"><a href="#__codelineno-9-5">5</a></span>
<span class="normal"><a href="#__codelineno-9-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mf">38.891753</span><span class="p">,</span> <span class="n">MainThread</span> <span class="p">:</span> <span class="p">[</span><span class="n">serveur</span><span class="p">]</span> <span class="n">démarrage</span> <span class="n">du</span> <span class="n">serveur</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mf">38.987999</span><span class="p">,</span> <span class="n">MainThread</span> <span class="p">:</span> <span class="p">[</span><span class="n">serveur</span><span class="p">]</span> <span class="n">connexion</span> <span class="n">à</span> <span class="n">la</span> <span class="n">base</span> <span class="n">de</span> <span class="n">données</span> <span class="n">réussie</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mf">40.586747</span><span class="p">,</span> <span class="n">MainThread</span> <span class="p">:</span> <span class="p">[</span><span class="n">serveur</span><span class="p">]</span> <span class="n">démarrage</span> <span class="n">du</span> <span class="n">serveur</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mf">40.655254</span><span class="p">,</span> <span class="n">MainThread</span> <span class="p">:</span> <span class="p">[</span><span class="n">serveur</span><span class="p">]</span> <span class="n">connexion</span> <span class="n">à</span> <span class="n">la</span> <span class="n">base</span> <span class="n">de</span> <span class="n">données</span> <span class="n">réussie</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mf">54.528360</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=oui&amp;enfants=3&amp;salaire=200000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mf">54.530653</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">42842</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">17283</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 1-4 : on rappelle qu’il y a deux démarrages du serveur parce que le mode <strong>[Debug=True]</strong> provoque un second démarrage ;</li>
<li>lignes 5-6 : les logs nous donnent une idée du temps d’exécution d’une requête, ici 2,293 millisecondes ;</li>
</ul>
<h2 id="244-le-client-web">24.4. Le client web</h2>
<p><img src="images/1000000000000207000002166A13AA26.png" style="width:6.002cm;height:6.171cm;" alt="Image" /></p>
<p>Le dossier <strong>[http-clients/02]</strong> est obtenu par recopie du dossier <strong>[http-clients/01]</strong>. On procède ensuite à quelques modifications.</p>
<h3 id="2441-la-configuration">24.4.1. La configuration</h3>
<p>La configuration <strong>[config]</strong> de l’application <strong>[http-clients/02]</strong> est le même que celle de l’application <strong>[http-clients/01]</strong> à quelques détails près :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span>
<span class="normal"><a href="#__codelineno-10-24">24</a></span>
<span class="normal"><a href="#__codelineno-10-25">25</a></span>
<span class="normal"><a href="#__codelineno-10-26">26</a></span>
<span class="normal"><a href="#__codelineno-10-27">27</a></span>
<span class="normal"><a href="#__codelineno-10-28">28</a></span>
<span class="normal"><a href="#__codelineno-10-29">29</a></span>
<span class="normal"><a href="#__codelineno-10-30">30</a></span>
<span class="normal"><a href="#__codelineno-10-31">31</a></span>
<span class="normal"><a href="#__codelineno-10-32">32</a></span>
<span class="normal"><a href="#__codelineno-10-33">33</a></span>
<span class="normal"><a href="#__codelineno-10-34">34</a></span>
<span class="normal"><a href="#__codelineno-10-35">35</a></span>
<span class="normal"><a href="#__codelineno-10-36">36</a></span>
<span class="normal"><a href="#__codelineno-10-37">37</a></span>
<span class="normal"><a href="#__codelineno-10-38">38</a></span>
<span class="normal"><a href="#__codelineno-10-39">39</a></span>
<span class="normal"><a href="#__codelineno-10-40">40</a></span>
<span class="normal"><a href="#__codelineno-10-41">41</a></span>
<span class="normal"><a href="#__codelineno-10-42">42</a></span>
<span class="normal"><a href="#__codelineno-10-43">43</a></span>
<span class="normal"><a href="#__codelineno-10-44">44</a></span>
<span class="normal"><a href="#__codelineno-10-45">45</a></span>
<span class="normal"><a href="#__codelineno-10-46">46</a></span>
<span class="normal"><a href="#__codelineno-10-47">47</a></span>
<span class="normal"><a href="#__codelineno-10-48">48</a></span>
<span class="normal"><a href="#__codelineno-10-49">49</a></span>
<span class="normal"><a href="#__codelineno-10-50">50</a></span>
<span class="normal"><a href="#__codelineno-10-51">51</a></span>
<span class="normal"><a href="#__codelineno-10-52">52</a></span>
<span class="normal"><a href="#__codelineno-10-53">53</a></span>
<span class="normal"><a href="#__codelineno-10-54">54</a></span>
<span class="normal"><a href="#__codelineno-10-55">55</a></span>
<span class="normal"><a href="#__codelineno-10-56">56</a></span>
<span class="normal"><a href="#__codelineno-10-57">57</a></span>
<span class="normal"><a href="#__codelineno-10-58">58</a></span>
<span class="normal"><a href="#__codelineno-10-59">59</a></span>
<span class="normal"><a href="#__codelineno-10-60">60</a></span>
<span class="normal"><a href="#__codelineno-10-61">61</a></span>
<span class="normal"><a href="#__codelineno-10-62">62</a></span>
<span class="normal"><a href="#__codelineno-10-63">63</a></span>
<span class="normal"><a href="#__codelineno-10-64">64</a></span>
<span class="normal"><a href="#__codelineno-10-65">65</a></span>
<span class="normal"><a href="#__codelineno-10-66">66</a></span>
<span class="normal"><a href="#__codelineno-10-67">67</a></span>
<span class="normal"><a href="#__codelineno-10-68">68</a></span>
<span class="normal"><a href="#__codelineno-10-69">69</a></span>
<span class="normal"><a href="#__codelineno-10-70">70</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>    <span class="c1"># étape 1 ------</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>    <span class="c1"># dossier de ce fichier</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>    <span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>    <span class="c1"># chemin racine</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a>    <span class="n">root_dir</span> <span class="o">=</span> <span class="s2">&quot;C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020&quot;</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a>    <span class="c1"># dépendances absolues</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a>    <span class="n">absolute_dependencies</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a>        <span class="c1"># dossiers du projet</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a>        <span class="c1"># BaseEntity, MyException</span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/classes/02/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a>        <span class="c1"># InterfaceImpôtsDao, InterfaceImpôtsMétier, InterfaceImpôtsUi</span>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/interfaces&quot;</span><span class="p">,</span>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a>        <span class="c1"># AbstractImpôtsdao, ImpôtsConsole, ImpôtsMétier</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/services&quot;</span><span class="p">,</span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a>        <span class="c1"># ImpotsDaoWithAdminDataInDatabase</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v05/services&quot;</span><span class="p">,</span>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a>        <span class="c1"># AdminData, ImpôtsError, TaxPayer</span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a>        <span class="c1"># Constantes, tranches</span>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v05/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a>        <span class="c1"># ImpôtsDaoWithHttpClient</span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../services&quot;</span><span class="p">,</span>
<a id="__codelineno-10-29" name="__codelineno-10-29"></a>        <span class="c1"># scripts de configuration</span>
<a id="__codelineno-10-30" name="__codelineno-10-30"></a>        <span class="n">script_dir</span><span class="p">,</span>
<a id="__codelineno-10-31" name="__codelineno-10-31"></a>        <span class="c1"># Logger</span>
<a id="__codelineno-10-32" name="__codelineno-10-32"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/http-servers/02/utilities&quot;</span><span class="p">,</span>
<a id="__codelineno-10-33" name="__codelineno-10-33"></a>    <span class="p">]</span>
<a id="__codelineno-10-34" name="__codelineno-10-34"></a>
<a id="__codelineno-10-35" name="__codelineno-10-35"></a>    <span class="c1"># on fixe le syspath</span>
<a id="__codelineno-10-36" name="__codelineno-10-36"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_syspath</span>
<a id="__codelineno-10-37" name="__codelineno-10-37"></a>    <span class="n">set_syspath</span><span class="p">(</span><span class="n">absolute_dependencies</span><span class="p">)</span>
<a id="__codelineno-10-38" name="__codelineno-10-38"></a>
<a id="__codelineno-10-39" name="__codelineno-10-39"></a>    <span class="c1"># étape 2 ------</span>
<a id="__codelineno-10-40" name="__codelineno-10-40"></a>    <span class="c1"># configuration de l&#39;application avec des constantes</span>
<a id="__codelineno-10-41" name="__codelineno-10-41"></a>    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
<a id="__codelineno-10-42" name="__codelineno-10-42"></a>        <span class="c1"># fichier des contribuables</span>
<a id="__codelineno-10-43" name="__codelineno-10-43"></a>        <span class="s2">&quot;taxpayersFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../data/input/taxpayersdata.txt&quot;</span><span class="p">,</span>
<a id="__codelineno-10-44" name="__codelineno-10-44"></a>        <span class="c1"># fichier des résultats</span>
<a id="__codelineno-10-45" name="__codelineno-10-45"></a>        <span class="s2">&quot;resultsFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../data/output/résultats.json&quot;</span><span class="p">,</span>
<a id="__codelineno-10-46" name="__codelineno-10-46"></a>        <span class="c1"># fichier des erreurs</span>
<a id="__codelineno-10-47" name="__codelineno-10-47"></a>        <span class="s2">&quot;errorsFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../data/output/errors.txt&quot;</span><span class="p">,</span>
<a id="__codelineno-10-48" name="__codelineno-10-48"></a>        <span class="c1"># fichier de logs</span>
<a id="__codelineno-10-49" name="__codelineno-10-49"></a>        <span class="s2">&quot;logsFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../data/logs/logs.txt&quot;</span><span class="p">,</span>
<a id="__codelineno-10-50" name="__codelineno-10-50"></a>        <span class="c1"># le serveur de calcul de l&#39;impôt</span>
<a id="__codelineno-10-51" name="__codelineno-10-51"></a>        <span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-10-52" name="__codelineno-10-52"></a>            <span class="s2">&quot;urlServer&quot;</span><span class="p">:</span> <span class="s2">&quot;http://127.0.0.1:5000/&quot;</span><span class="p">,</span>
<a id="__codelineno-10-53" name="__codelineno-10-53"></a>            <span class="s2">&quot;authBasic&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-10-54" name="__codelineno-10-54"></a>            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-10-55" name="__codelineno-10-55"></a>                <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
<a id="__codelineno-10-56" name="__codelineno-10-56"></a>                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span>
<a id="__codelineno-10-57" name="__codelineno-10-57"></a>            <span class="p">}</span>
<a id="__codelineno-10-58" name="__codelineno-10-58"></a>        <span class="p">},</span>
<a id="__codelineno-10-59" name="__codelineno-10-59"></a>        <span class="c1"># mode debug</span>
<a id="__codelineno-10-60" name="__codelineno-10-60"></a>        <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="kc">True</span>
<a id="__codelineno-10-61" name="__codelineno-10-61"></a>    <span class="p">}</span>
<a id="__codelineno-10-62" name="__codelineno-10-62"></a>    <span class="p">)</span>
<a id="__codelineno-10-63" name="__codelineno-10-63"></a>
<a id="__codelineno-10-64" name="__codelineno-10-64"></a>    <span class="c1"># étape 3 ------</span>
<a id="__codelineno-10-65" name="__codelineno-10-65"></a>    <span class="c1"># instanciation des couches</span>
<a id="__codelineno-10-66" name="__codelineno-10-66"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config_layers</span>
<a id="__codelineno-10-67" name="__codelineno-10-67"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_layers</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-10-68" name="__codelineno-10-68"></a>
<a id="__codelineno-10-69" name="__codelineno-10-69"></a>    <span class="c1"># on rend la configuation</span>
<a id="__codelineno-10-70" name="__codelineno-10-70"></a>    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 31-32 : on va utiliser le même logueur |<a href="#_La_classe_[Logger]"><u><u>Logger</u></u></a>| que celui utilisé pour le serveur ;</li>
<li>ligne 49 : le chemin absolu du fichier de logs ;</li>
<li>ligne 60 : le mode <strong>[debug=True]</strong> sert à écrire les réponses du serveur web dans le fichier de logs ;</li>
</ul>
<h3 id="2442-la-couche-dao">24.4.2. La couche [dao]</h3>
<p>Le code de la classe <strong>[</strong><strong>ImpôtsDaoWithHttpClient</strong><strong>]</strong> évolue légèrement :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span>
<span class="normal"><a href="#__codelineno-11-31">31</a></span>
<span class="normal"><a href="#__codelineno-11-32">32</a></span>
<span class="normal"><a href="#__codelineno-11-33">33</a></span>
<span class="normal"><a href="#__codelineno-11-34">34</a></span>
<span class="normal"><a href="#__codelineno-11-35">35</a></span>
<span class="normal"><a href="#__codelineno-11-36">36</a></span>
<span class="normal"><a href="#__codelineno-11-37">37</a></span>
<span class="normal"><a href="#__codelineno-11-38">38</a></span>
<span class="normal"><a href="#__codelineno-11-39">39</a></span>
<span class="normal"><a href="#__codelineno-11-40">40</a></span>
<span class="normal"><a href="#__codelineno-11-41">41</a></span>
<span class="normal"><a href="#__codelineno-11-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1"># imports</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">status</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="err">…</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">ImpôtsDaoWithHttpClient</span><span class="p">(</span><span class="n">AbstractImpôtsDao</span><span class="p">,</span> <span class="n">InterfaceImpôtsMétier</span><span class="p">):</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a>    <span class="c1"># constructeur</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a>        <span class="c1"># initialisation parent</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a>        <span class="n">AbstractImpôtsDao</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a>        <span class="c1"># mémorisation éléments de la configuration</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a>        <span class="c1"># config générale</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a>        <span class="c1"># serveur</span>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__config_server</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;server&quot;</span><span class="p">]</span>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a>        <span class="c1"># mode debug</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__debug</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">]</span>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a>        <span class="c1"># logger</span>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a>    <span class="c1"># méthode inutilisée</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_admindata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AdminData</span><span class="p">:</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a>        <span class="k">pass</span>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a>
<a id="__codelineno-11-29" name="__codelineno-11-29"></a>    <span class="c1"># calcul de l&#39;impôt</span>
<a id="__codelineno-11-30" name="__codelineno-11-30"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_tax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taxpayer</span><span class="p">:</span> <span class="n">TaxPayer</span><span class="p">,</span> <span class="n">admindata</span><span class="p">:</span> <span class="n">AdminData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-11-31" name="__codelineno-11-31"></a>        <span class="c1"># on laisse remonter les exceptions</span>
<a id="__codelineno-11-32" name="__codelineno-11-32"></a>        <span class="err">…</span>
<a id="__codelineno-11-33" name="__codelineno-11-33"></a>        <span class="c1"># mode debug ?</span>
<a id="__codelineno-11-34" name="__codelineno-11-34"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__debug</span><span class="p">:</span>
<a id="__codelineno-11-35" name="__codelineno-11-35"></a>            <span class="c1"># logueur</span>
<a id="__codelineno-11-36" name="__codelineno-11-36"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="p">:</span>
<a id="__codelineno-11-37" name="__codelineno-11-37"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__config</span><span class="p">[</span><span class="s1">&#39;logger&#39;</span><span class="p">]</span>
<a id="__codelineno-11-38" name="__codelineno-11-38"></a>            <span class="c1"># on logue</span>
<a id="__codelineno-11-39" name="__codelineno-11-39"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-11-40" name="__codelineno-11-40"></a>        <span class="c1"># code de statut de la réponse HTTP</span>
<a id="__codelineno-11-41" name="__codelineno-11-41"></a>        <span class="n">status_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
<a id="__codelineno-11-42" name="__codelineno-11-42"></a>        <span class="err">…</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 17 : on mémorise la configuration générale. On verra ultérieurement que lorsque le constructeur de la classe <strong>[</strong><strong>ImpôtsDaoWithHttpClient</strong><strong>]</strong> s’exécute, le dictionnaire <strong>[config]</strong> ne contient pas encore la clé <strong>[logger]</strong> utilisée ligne 37. C’est pour cette raison qu’on ne peut pas initialiser <strong>[self.__logger]</strong> (ligne 23) dans le constructeur ;</li>
<li>ligne 21 : on a ajouté dans la configuration une clé <strong>[debug]</strong> qui contrôle le log des lignes 33-39 ;</li>
<li>ligne 34 : si on est en mode <strong>[debug]</strong> ;</li>
<li>lignes 36-37 : initialisation éventuelle de la propriété <strong>[self.__logger]</strong>. Lorsque la méthode <strong>[calculate_tax]</strong> est utilisée, la clé <strong>[logger]</strong> fait partie du dictionnaire <strong>[config]</strong> ;</li>
<li>ligne 39 : on logue le document texte associé à la réponse HTTP du serveur ;
La couche <strong>[dao]</strong> va être exécutée simultanément par plusieurs threads. Or ici on crée un unique exemplaire de cette couche (cf. config_layers). Il faut donc vérifier que le code n’implique pas l’accès en écriture à des données partagées, typiquement les propriétés de la classe <strong>[</strong><strong>ImpôtsDaoWithHttpClient</strong><strong>]</strong> qui implémente la couche <strong>[dao]</strong>. Or ci-dessus la ligne 37 modifie une propriété de l’instance de classe. Ici ça ne porte pas à conséquence car tous les threads partagent le même logueur. Si cela n’avait pas été le cas, l’accès à la ligne 37 aurait du être synchronisé.</li>
</ul>
<h3 id="2443-le-script-principal">24.4.3. Le script principal</h3>
<p>Le script principal <strong>[main]</strong> évolue de la façon suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span>
<span class="normal"><a href="#__codelineno-12-22">22</a></span>
<span class="normal"><a href="#__codelineno-12-23">23</a></span>
<span class="normal"><a href="#__codelineno-12-24">24</a></span>
<span class="normal"><a href="#__codelineno-12-25">25</a></span>
<span class="normal"><a href="#__codelineno-12-26">26</a></span>
<span class="normal"><a href="#__codelineno-12-27">27</a></span>
<span class="normal"><a href="#__codelineno-12-28">28</a></span>
<span class="normal"><a href="#__codelineno-12-29">29</a></span>
<span class="normal"><a href="#__codelineno-12-30">30</a></span>
<span class="normal"><a href="#__codelineno-12-31">31</a></span>
<span class="normal"><a href="#__codelineno-12-32">32</a></span>
<span class="normal"><a href="#__codelineno-12-33">33</a></span>
<span class="normal"><a href="#__codelineno-12-34">34</a></span>
<span class="normal"><a href="#__codelineno-12-35">35</a></span>
<span class="normal"><a href="#__codelineno-12-36">36</a></span>
<span class="normal"><a href="#__codelineno-12-37">37</a></span>
<span class="normal"><a href="#__codelineno-12-38">38</a></span>
<span class="normal"><a href="#__codelineno-12-39">39</a></span>
<span class="normal"><a href="#__codelineno-12-40">40</a></span>
<span class="normal"><a href="#__codelineno-12-41">41</a></span>
<span class="normal"><a href="#__codelineno-12-42">42</a></span>
<span class="normal"><a href="#__codelineno-12-43">43</a></span>
<span class="normal"><a href="#__codelineno-12-44">44</a></span>
<span class="normal"><a href="#__codelineno-12-45">45</a></span>
<span class="normal"><a href="#__codelineno-12-46">46</a></span>
<span class="normal"><a href="#__codelineno-12-47">47</a></span>
<span class="normal"><a href="#__codelineno-12-48">48</a></span>
<span class="normal"><a href="#__codelineno-12-49">49</a></span>
<span class="normal"><a href="#__codelineno-12-50">50</a></span>
<span class="normal"><a href="#__codelineno-12-51">51</a></span>
<span class="normal"><a href="#__codelineno-12-52">52</a></span>
<span class="normal"><a href="#__codelineno-12-53">53</a></span>
<span class="normal"><a href="#__codelineno-12-54">54</a></span>
<span class="normal"><a href="#__codelineno-12-55">55</a></span>
<span class="normal"><a href="#__codelineno-12-56">56</a></span>
<span class="normal"><a href="#__codelineno-12-57">57</a></span>
<span class="normal"><a href="#__codelineno-12-58">58</a></span>
<span class="normal"><a href="#__codelineno-12-59">59</a></span>
<span class="normal"><a href="#__codelineno-12-60">60</a></span>
<span class="normal"><a href="#__codelineno-12-61">61</a></span>
<span class="normal"><a href="#__codelineno-12-62">62</a></span>
<span class="normal"><a href="#__codelineno-12-63">63</a></span>
<span class="normal"><a href="#__codelineno-12-64">64</a></span>
<span class="normal"><a href="#__codelineno-12-65">65</a></span>
<span class="normal"><a href="#__codelineno-12-66">66</a></span>
<span class="normal"><a href="#__codelineno-12-67">67</a></span>
<span class="normal"><a href="#__codelineno-12-68">68</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({})</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="c1"># dépendances</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">Logger</span>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a>
<a id="__codelineno-12-13" name="__codelineno-12-13"></a>
<a id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="c1"># exécution de la couche [dao] dans un thread</span>
<a id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="c1"># taxpayers est une liste de contribuables</span>
<a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">thread_function</span><span class="p">(</span><span class="n">dao</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">taxpayers</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-12-17" name="__codelineno-12-17"></a>    <span class="err">…</span>
<a id="__codelineno-12-18" name="__codelineno-12-18"></a>
<a id="__codelineno-12-19" name="__codelineno-12-19"></a>
<a id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="c1"># liste des threads du client</span>
<a id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-12-22" name="__codelineno-12-22"></a><span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-12-23" name="__codelineno-12-23"></a><span class="c1"># code</span>
<a id="__codelineno-12-24" name="__codelineno-12-24"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-12-25" name="__codelineno-12-25"></a>    <span class="c1"># logger</span>
<a id="__codelineno-12-26" name="__codelineno-12-26"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;logsFilename&quot;</span><span class="p">])</span>
<a id="__codelineno-12-27" name="__codelineno-12-27"></a>    <span class="c1"># on le mémorise dans la config</span>
<a id="__codelineno-12-28" name="__codelineno-12-28"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;logger&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-12-29" name="__codelineno-12-29"></a>    <span class="c1"># on récupère la couche [dao]</span>
<a id="__codelineno-12-30" name="__codelineno-12-30"></a>    <span class="n">dao</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span>
<a id="__codelineno-12-31" name="__codelineno-12-31"></a>    <span class="c1"># lecture des données des contribuables</span>
<a id="__codelineno-12-32" name="__codelineno-12-32"></a>    <span class="n">taxpayers</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_taxpayers_data</span><span class="p">()[</span><span class="s2">&quot;taxpayers&quot;</span><span class="p">]</span>
<a id="__codelineno-12-33" name="__codelineno-12-33"></a>    <span class="c1"># des contribuables ?</span>
<a id="__codelineno-12-34" name="__codelineno-12-34"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">taxpayers</span><span class="p">:</span>
<a id="__codelineno-12-35" name="__codelineno-12-35"></a>        <span class="k">raise</span> <span class="n">ImpôtsError</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Pas de contribuables valides dans le fichier </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;taxpayersFilename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-12-36" name="__codelineno-12-36"></a>    <span class="c1"># calcul de l&#39;impôt des contribuables avec plusieurs threads</span>
<a id="__codelineno-12-37" name="__codelineno-12-37"></a>    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-12-38" name="__codelineno-12-38"></a>    <span class="n">l_taxpayers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">taxpayers</span><span class="p">)</span>
<a id="__codelineno-12-39" name="__codelineno-12-39"></a>    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">taxpayers</span><span class="p">):</span>
<a id="__codelineno-12-40" name="__codelineno-12-40"></a>        <span class="c1"># chaque thread va traiter de 1 à 4 contribuables</span>
<a id="__codelineno-12-41" name="__codelineno-12-41"></a>        <span class="n">nb_taxpayers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">l_taxpayers</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-12-42" name="__codelineno-12-42"></a>        <span class="c1"># la liste des contribuables traités par le thread</span>
<a id="__codelineno-12-43" name="__codelineno-12-43"></a>        <span class="n">thread_taxpayers</span> <span class="o">=</span> <span class="n">taxpayers</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">nb_taxpayers</span><span class="p">)]</span>
<a id="__codelineno-12-44" name="__codelineno-12-44"></a>        <span class="c1"># on incrémente i pour le thread suivant</span>
<a id="__codelineno-12-45" name="__codelineno-12-45"></a>        <span class="n">i</span> <span class="o">+=</span> <span class="n">nb_taxpayers</span>
<a id="__codelineno-12-46" name="__codelineno-12-46"></a>        <span class="c1"># on crée le thread</span>
<a id="__codelineno-12-47" name="__codelineno-12-47"></a>        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">thread_function</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">dao</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">thread_taxpayers</span><span class="p">))</span>
<a id="__codelineno-12-48" name="__codelineno-12-48"></a>        <span class="c1"># on l&#39;ajoute à la liste des threads du script principal</span>
<a id="__codelineno-12-49" name="__codelineno-12-49"></a>        <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
<a id="__codelineno-12-50" name="__codelineno-12-50"></a>        <span class="c1"># on lance le thread - cette opération est asynchrone - on n&#39;attend pas le résultat du thread</span>
<a id="__codelineno-12-51" name="__codelineno-12-51"></a>        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-12-52" name="__codelineno-12-52"></a>    <span class="c1"># le thread principal attend la fin de tous les threads qu&#39;il a lancés</span>
<a id="__codelineno-12-53" name="__codelineno-12-53"></a>    <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
<a id="__codelineno-12-54" name="__codelineno-12-54"></a>        <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<a id="__codelineno-12-55" name="__codelineno-12-55"></a>    <span class="c1"># ici tous les threads ont fini leur travail - chacun a modifié un ou plusieurs objets [taxpayer]</span>
<a id="__codelineno-12-56" name="__codelineno-12-56"></a>    <span class="c1"># on enregistre les résultats dans le fichier jSON</span>
<a id="__codelineno-12-57" name="__codelineno-12-57"></a>    <span class="n">dao</span><span class="o">.</span><span class="n">write_taxpayers_results</span><span class="p">(</span><span class="n">taxpayers</span><span class="p">)</span>
<a id="__codelineno-12-58" name="__codelineno-12-58"></a><span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-12-59" name="__codelineno-12-59"></a>    <span class="c1"># affichage de l&#39;erreur</span>
<a id="__codelineno-12-60" name="__codelineno-12-60"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-12-61" name="__codelineno-12-61"></a><span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-12-62" name="__codelineno-12-62"></a>    <span class="c1"># on ferme le logueur</span>
<a id="__codelineno-12-63" name="__codelineno-12-63"></a>    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
<a id="__codelineno-12-64" name="__codelineno-12-64"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-12-65" name="__codelineno-12-65"></a>    <span class="c1"># on a fini</span>
<a id="__codelineno-12-66" name="__codelineno-12-66"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Travail terminé...&quot;</span><span class="p">)</span>
<a id="__codelineno-12-67" name="__codelineno-12-67"></a>    <span class="c1"># fin des threads qui pourraient encore exister si on s&#39;est arrêté sur erreur</span>
<a id="__codelineno-12-68" name="__codelineno-12-68"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>le script principal se distingue de celui du client précédent par le fait qu’il va générer plusieurs threads d’exécution pour effectuer les requêtes au serveur. Le client de la version 6 faisait toutes ses requêtes séquentiellement. La requête n° i n’était faite qu’une fois la réponse à la requête n° <strong>[i-1]</strong> reçue. Ici on veut voir comment le serveur va se comporter lorsqu’il reçoit plusieurs requêtes simultanées. Pour cela nous avons besoin des threads ;</li>
<li>ligne 21 : les threads générés vont être mis dans une liste. Il faut comprendre que le script <strong>[main]</strong> est lui aussi exécuté par un thread qui s’appelle <strong>[MainThread]</strong>. Ce thread principal va créer d’autres threads qui seront chargés de calculer l’impôt d’un ou plusieurs contribuables ;</li>
<li>ligne 26 : on crée un logueur. Celui-ci sera partagé par tous les threads ;</li>
<li>ligne 32 : on récupère tous les contribuables dont il faut calculer l’impôt ;</li>
<li>lignes 39-51 : on va répartir ces contribuables sur plusieurs threads ;</li>
<li>lignes 40-41 : chaque thread va traiter de 1 à 4 contribuables. Ce nombre est fixé de façon aléatoire ;</li>
<li><strong>[</strong><strong>random</strong><strong>.randint(1, 4)</strong><strong>]</strong> donne aléatoirement un nombre dans la liste <strong>[1, 2, 3, 4]</strong> ;</li>
<li>le thread ne peut avoir plus de <strong>[l-i]</strong> contribuables où <strong>[l-i]</strong> représente le nombre de contribuables à qui on n’a pas encore attribué de thread ;</li>
<li>on prend donc le min des deux valeurs ;</li>
<li>ligne 43 : une fois que <strong>[nb_taxpayers]</strong>, le nombre de contribuables traités par le thread, est connu, on prend ceux-ci dans la liste des contribuables :</li>
<li><strong>[slice(10,12)]</strong> est l’ensemble des indices <strong>[10, 11, 12]</strong> ;</li>
<li><strong>[taxpayers[slice(10,12)]</strong>] est la liste <strong>[taxpayers[10]</strong>, taxpayers<strong>[11]</strong>, taxpayers<strong>[12]</strong> ;</li>
<li>ligne 45 : on incrémente la valeur de i qui contrôle la boucle de la ligne 39 ;</li>
<li>ligne 47 : on crée un thread :</li>
<li><strong>[</strong><strong>target=thread_function</strong><strong>]</strong> fixe la fonction qu’exécutera le thread. C’est la fonction des lignes 16-17. Elle attend trois paramètres ;</li>
<li>
<p><strong>[ags]</strong> est la liste des trois paramètres attendus par la fonction <strong>[</strong><strong>thread_function</strong><strong>]</strong> ;
Créer un thread ne l’exécute pas. Ca crée un objet et c’est tout ;</p>
</li>
<li>
<p>lignes 48-49 : le thread qui vient d’être créé est ajouté à la liste des threads créés par le thread principal ;</p>
</li>
<li>ligne 51 : le thread est lancé. Il va alors être exécuté en parallèle des autres threads actifs. Ici, il va exécuter la fonction <strong>[</strong><strong>thread_function</strong><strong>]</strong> avec les arguments qu’on lui a donnés ;</li>
<li>lignes 53-54 : le thread principal attend chacun des threads qu’il a lancés. Prenons un exemple :</li>
<li>le thread principal a lancé trois threads <strong>[th1, th2, th3]</strong> ;</li>
<li>le thread principal se met en attente de chacun des threads (lignes 53-54) dans l’ordre de la boucle for : <strong>[th1, th2, th3]</strong> ;</li>
<li>supposons que les threads se terminent dans l’ordre <strong>[th2, th1, th3]</strong> ;</li>
<li>le thread principal attend la fin de th1. Lorsque th2 se termine, il ne se passe rien ;</li>
<li>lorsque th1 se termine, le thread principal se met en attente de th2. Or celui-ci est terminé. Le thread principal passe alors au thread suivant et attend th3 ;</li>
<li>lorsque th3 se termine, le thread principal a terminé son attente et passe alors à l’exécution de la ligne 57 ;</li>
<li>la ligne 57 écrit les résultats obtenus dans le fichier des résultats. On a là un bon exemple des références d’objets :</li>
<li>ligne 43 : la liste <strong>[thread_payers]</strong> associée à un thread contient des copies des références d’objets contenus dans la liste <strong>[taxpayers]</strong> ;</li>
<li>on sait que le calcul de l’impôt va modifier les objets pointés par les références de la liste <strong>[thread_payers]</strong>. Ces objets vont se voir enrichis des résultats du calcul de l’impôt. Néanmoins les références elles ne sont pas modifiées. Donc les références de la liste initiale <strong>[taxpayers]</strong> ‘voient’ ou ‘pointent sur’ les objets modifiés ;
La fonction <strong>[</strong><strong>thread_function</strong><strong>]</strong> exécutée par les threads est la suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span>
<span class="normal"><a href="#__codelineno-13-15">15</a></span>
<span class="normal"><a href="#__codelineno-13-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1"># exécution de la couche [dao] dans un thread</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="c1"># taxpayers est une liste de contribuables</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">thread_function</span><span class="p">(</span><span class="n">dao</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">taxpayers</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>    <span class="c1"># log début du thread</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a>    <span class="n">thread_name</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;début du thread [</span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2">] avec </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">taxpayers</span><span class="p">)</span><span class="si">}</span><span class="s2"> contribuable(s)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a>    <span class="c1"># on calcule l&#39;impôt des contribuables</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a>    <span class="k">for</span> <span class="n">taxpayer</span> <span class="ow">in</span> <span class="n">taxpayers</span><span class="p">:</span>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a>        <span class="c1"># log</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;début du calcul de l&#39;impôt de </span><span class="si">{</span><span class="n">taxpayer</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a>        <span class="c1"># calcul synchrone de l&#39;impôt</span>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a>        <span class="n">dao</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">taxpayer</span><span class="p">)</span>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a>        <span class="c1"># log</span>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fin du calcul de l&#39;impôt de </span><span class="si">{</span><span class="n">taxpayer</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a>    <span class="c1"># log fin du thread</span>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fin du thread [</span><span class="si">{</span><span class="n">thread_name</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>les fonctions exécutées simultanément par plusieurs threads sont souvent délicates à écrire : on doit toujours vérifier que le code n’essaie pas de modifier une donnée partagée entre threads. Lorsque ce dernier cas se produit, il faut mettre en place un accès synchronisé à la donnée partagée qui va être modifiée ;</li>
<li>ligne 3 : la fonction reçoit trois paramètres :</li>
<li><strong>[dao]</strong> : une référence sur la couche <strong>[dao]</strong>. Cette donnée est partagée ;</li>
<li><strong>[logger]</strong> : une référence sur le logueur. Cette donnée est partagée ;</li>
<li><strong>[taxpayers]</strong> : une liste de contribuables. Cette donnée n’est pas partagée : chaque thread gère une liste différente ;</li>
<li>examinons les deux références <strong>[dao, logger]</strong> :</li>
<li>on a vu que l’objet pointé par la référence <strong>[dao]</strong> avait une référence <strong>[self.__logger]</strong> qui était modifiée par les threads mais pour y mettre une valeur commune à tous les threads ;</li>
<li>la référence <strong>[logger]</strong> pointe sur un descripteur de fichier. On a vu qu’il pouvait y avoir un problème lors de l’écriture des logs dans le fichier. Pour cette raison l’écriture dans le fichier a été synchronisée ;</li>
<li>lignes 5-6 : on logue le nom du thread et le nombre de contribuables qu’il doit gérer ;</li>
<li>lignes 8-14 : calcul de l’impôt des contribuables ;</li>
<li>ligne 16 : on logue la fin du thread ;</li>
</ul>
<h3 id="2444-execution">24.4.4. Exécution</h3>
<p>Lançons le serveur web comme dans le paragraphe précédent (serveur web, SGBD, hMailServer, Thunderbird), puis exécutons le script <strong>[main]</strong> du client. Dans les fichiers <strong>[data/output/errors.txt, data/output/résultats.json]</strong> on a les mêmes résultats que dans la version précédente. Dans le fichier <strong>[data/logs/logs.txt]</strong>, on a les logs suivants :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span>
<span class="normal"><a href="#__codelineno-14-18">18</a></span>
<span class="normal"><a href="#__codelineno-14-19">19</a></span>
<span class="normal"><a href="#__codelineno-14-20">20</a></span>
<span class="normal"><a href="#__codelineno-14-21">21</a></span>
<span class="normal"><a href="#__codelineno-14-22">22</a></span>
<span class="normal"><a href="#__codelineno-14-23">23</a></span>
<span class="normal"><a href="#__codelineno-14-24">24</a></span>
<span class="normal"><a href="#__codelineno-14-25">25</a></span>
<span class="normal"><a href="#__codelineno-14-26">26</a></span>
<span class="normal"><a href="#__codelineno-14-27">27</a></span>
<span class="normal"><a href="#__codelineno-14-28">28</a></span>
<span class="normal"><a href="#__codelineno-14-29">29</a></span>
<span class="normal"><a href="#__codelineno-14-30">30</a></span>
<span class="normal"><a href="#__codelineno-14-31">31</a></span>
<span class="normal"><a href="#__codelineno-14-32">32</a></span>
<span class="normal"><a href="#__codelineno-14-33">33</a></span>
<span class="normal"><a href="#__codelineno-14-34">34</a></span>
<span class="normal"><a href="#__codelineno-14-35">35</a></span>
<span class="normal"><a href="#__codelineno-14-36">36</a></span>
<span class="normal"><a href="#__codelineno-14-37">37</a></span>
<span class="normal"><a href="#__codelineno-14-38">38</a></span>
<span class="normal"><a href="#__codelineno-14-39">39</a></span>
<span class="normal"><a href="#__codelineno-14-40">40</a></span>
<span class="normal"><a href="#__codelineno-14-41">41</a></span>
<span class="normal"><a href="#__codelineno-14-42">42</a></span>
<span class="normal"><a href="#__codelineno-14-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.942404</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">avec</span> <span class="mi">1</span> <span class="n">contribuable</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.943458</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 1, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 55555}</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.943458</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="n">avec</span> <span class="mi">3</span> <span class="n">contribuable</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.946502</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="n">avec</span> <span class="mi">1</span> <span class="n">contribuable</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.946502</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 2, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 50000}</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.947003</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 5, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 100000}</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.947003</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="n">avec</span> <span class="mi">3</span> <span class="n">contribuable</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.950324</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 6, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 100000}</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.948449</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="n">avec</span> <span class="mi">3</span> <span class="n">contribuable</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.953645</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 9, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 30000}</span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.976143</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">55555</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">2814</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.976695</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 1, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 55555, &quot;impôt&quot;: 2814, &quot;surcôte&quot;: 0, &quot;taux&quot;: 0.14, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.976695</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.973914</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">1384</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">384</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">347</span><span class="p">}}}</span>
<a id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.973914</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 2, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 50000, &quot;impôt&quot;: 1384, &quot;surcôte&quot;: 0, &quot;taux&quot;: 0.14, &quot;décôte&quot;: 384, &quot;réduction&quot;: 347}</span>
<a id="__codelineno-14-16" name="__codelineno-14-16"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.973914</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 3, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 50000}</span>
<a id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.977130</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">9200</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">2180</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-14-18" name="__codelineno-14-18"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.977130</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 6, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 100000, &quot;impôt&quot;: 9200, &quot;surcôte&quot;: 2180, &quot;taux&quot;: 0.3, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-14-19" name="__codelineno-14-19"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.977130</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 7, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 5, &quot;salaire&quot;: 100000}</span>
<a id="__codelineno-14-20" name="__codelineno-14-20"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.982634</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">16782</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">7176</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-14-21" name="__codelineno-14-21"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.982634</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-14-22" name="__codelineno-14-22"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.983134</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 5, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 100000, &quot;impôt&quot;: 16782, &quot;surcôte&quot;: 7176, &quot;taux&quot;: 0.41, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-14-23" name="__codelineno-14-23"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.983134</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 9, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 30000, &quot;impôt&quot;: 0, &quot;surcôte&quot;: 0, &quot;taux&quot;: 0.0, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-14-24" name="__codelineno-14-24"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.983134</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
<a id="__codelineno-14-25" name="__codelineno-14-25"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.983763</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 10, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 0, &quot;salaire&quot;: 200000}</span>
<a id="__codelineno-14-26" name="__codelineno-14-26"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">22.008562</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">64210</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">7498</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.45</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-14-27" name="__codelineno-14-27"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">22.008562</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 10, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 0, &quot;salaire&quot;: 200000, &quot;impôt&quot;: 64210, &quot;surcôte&quot;: 7498, &quot;taux&quot;: 0.45, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-14-28" name="__codelineno-14-28"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">22.009062</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 11, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 200000}</span>
<a id="__codelineno-14-29" name="__codelineno-14-29"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">22.016848</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">42842</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">17283</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-14-30" name="__codelineno-14-30"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">22.017349</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 11, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 200000, &quot;impôt&quot;: 42842, &quot;surcôte&quot;: 17283, &quot;taux&quot;: 0.41, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-14-31" name="__codelineno-14-31"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">22.017349</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
<a id="__codelineno-14-32" name="__codelineno-14-32"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.008486</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">720</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-14-33" name="__codelineno-14-33"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.008486</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 3, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 3, &quot;salaire&quot;: 50000, &quot;impôt&quot;: 0, &quot;surcôte&quot;: 0, &quot;taux&quot;: 0.14, &quot;décôte&quot;: 720, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-14-34" name="__codelineno-14-34"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.009749</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 4, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 100000}</span>
<a id="__codelineno-14-35" name="__codelineno-14-35"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.011722</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">4230</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-14-36" name="__codelineno-14-36"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.013723</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 7, &quot;marié&quot;: &quot;oui&quot;, &quot;enfants&quot;: 5, &quot;salaire&quot;: 100000, &quot;impôt&quot;: 4230, &quot;surcôte&quot;: 0, &quot;taux&quot;: 0.14, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-14-37" name="__codelineno-14-37"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.013723</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">début</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 8, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 0, &quot;salaire&quot;: 100000}</span>
<a id="__codelineno-14-38" name="__codelineno-14-38"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.024135</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">19884</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">4480</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-14-39" name="__codelineno-14-39"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.024135</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 4, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 2, &quot;salaire&quot;: 100000, &quot;impôt&quot;: 19884, &quot;surcôte&quot;: 4480, &quot;taux&quot;: 0.41, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-14-40" name="__codelineno-14-40"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.025178</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-14-41" name="__codelineno-14-41"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.025178</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;réponse&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;non&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;impôt&quot;</span><span class="p">:</span> <span class="mi">22986</span><span class="p">,</span> <span class="s2">&quot;surcôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;taux&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s2">&quot;décôte&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;réduction&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-14-42" name="__codelineno-14-42"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.026191</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">calcul</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;impôt de {&quot;id&quot;: 8, &quot;marié&quot;: &quot;non&quot;, &quot;enfants&quot;: 0, &quot;salaire&quot;: 100000, &quot;impôt&quot;: 22986, &quot;surcôte&quot;: 0, &quot;taux&quot;: 0.41, &quot;décôte&quot;: 0, &quot;réduction&quot;: 0}</span>
<a id="__codelineno-14-43" name="__codelineno-14-43"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.026191</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="n">fin</span> <span class="n">du</span> <span class="n">thread</span> <span class="p">[</span><span class="n">Thread</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ces logs montrent que cinq threads ont été lancés pour calculer l’impôt de 11 contribuables. Ces cinq threads ont lancé des requêtes simultanées au serveur de calcul de l’impôt. Il faut comprendre comment ça marche :</li>
<li>le thread <strong>[Thread-1]</strong> est lancé le premier. Lorsqu’il a le processeur, il avance dans le code jusqu’à envoyer sa requête HTTP. Comme il doit attendre le résultat de celle-ci, il est automatiquement mis en attente. Il perd alors le processeur et un autre thread obtient celui-ci ;</li>
<li>lignes 1-10 : le même processus se répète pour chacun des 5 threads. Ainsi les 5 threads sont lancés avant même que le thread <strong>[Thread-1]</strong> ait reçu sa réponse ligne 11 ;</li>
<li>les threads ne se terminent pas dans l’ordre où ils ont été lancés. Ainsi c’est le thread <strong>[Thread-3]</strong> qui termine le premier, ligne 23 ;
Côté serveur, les logs dans le fichier <strong>[data/logs/logs.txt]</strong> sont les suivants :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span>
<span class="normal"><a href="#__codelineno-15-18">18</a></span>
<span class="normal"><a href="#__codelineno-15-19">19</a></span>
<span class="normal"><a href="#__codelineno-15-20">20</a></span>
<span class="normal"><a href="#__codelineno-15-21">21</a></span>
<span class="normal"><a href="#__codelineno-15-22">22</a></span>
<span class="normal"><a href="#__codelineno-15-23">23</a></span>
<span class="normal"><a href="#__codelineno-15-24">24</a></span>
<span class="normal"><a href="#__codelineno-15-25">25</a></span>
<span class="normal"><a href="#__codelineno-15-26">26</a></span>
<span class="normal"><a href="#__codelineno-15-27">27</a></span>
<span class="normal"><a href="#__codelineno-15-28">28</a></span>
<span class="normal"><a href="#__codelineno-15-29">29</a></span>
<span class="normal"><a href="#__codelineno-15-30">30</a></span>
<span class="normal"><a href="#__codelineno-15-31">31</a></span>
<span class="normal"><a href="#__codelineno-15-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">01.692980</span><span class="p">,</span> <span class="n">MainThread</span> <span class="p">:</span> <span class="p">[</span><span class="n">serveur</span><span class="p">]</span> <span class="n">démarrage</span> <span class="n">du</span> <span class="n">serveur</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">01.877251</span><span class="p">,</span> <span class="n">MainThread</span> <span class="p">:</span> <span class="p">[</span><span class="n">serveur</span><span class="p">]</span> <span class="n">connexion</span> <span class="n">à</span> <span class="n">la</span> <span class="n">base</span> <span class="n">de</span> <span class="n">données</span> <span class="n">réussie</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">03.596162</span><span class="p">,</span> <span class="n">MainThread</span> <span class="p">:</span> <span class="p">[</span><span class="n">serveur</span><span class="p">]</span> <span class="n">démarrage</span> <span class="n">du</span> <span class="n">serveur</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">03.661160</span><span class="p">,</span> <span class="n">MainThread</span> <span class="p">:</span> <span class="p">[</span><span class="n">serveur</span><span class="p">]</span> <span class="n">connexion</span> <span class="n">à</span> <span class="n">la</span> <span class="n">base</span> <span class="n">de</span> <span class="n">données</span> <span class="n">réussie</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.968053</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=oui&amp;enfants=2&amp;salaire=50000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.969132</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">mis</span> <span class="n">en</span> <span class="n">pause</span> <span class="n">du</span> <span class="n">thread</span> <span class="n">pendant</span> <span class="mi">1</span> <span class="n">seconde</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.970316</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=oui&amp;enfants=3&amp;salaire=100000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.970316</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">mis</span> <span class="n">en</span> <span class="n">pause</span> <span class="n">du</span> <span class="n">thread</span> <span class="n">pendant</span> <span class="mi">1</span> <span class="n">seconde</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.971335</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=oui&amp;enfants=2&amp;salaire=55555&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.972563</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">4</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">55555</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">2814</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.974796</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=non&amp;enfants=3&amp;salaire=100000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.974796</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">mis</span> <span class="n">en</span> <span class="n">pause</span> <span class="n">du</span> <span class="n">thread</span> <span class="n">pendant</span> <span class="mi">1</span> <span class="n">seconde</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.976143</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">6</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=oui&amp;enfants=2&amp;salaire=30000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">20.976143</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">6</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">mis</span> <span class="n">en</span> <span class="n">pause</span> <span class="n">du</span> <span class="n">thread</span> <span class="n">pendant</span> <span class="mi">1</span> <span class="n">seconde</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.970615</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">1384</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">384</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">347</span><span class="p">}}}</span>
<a id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.973914</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">3</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">9200</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">2180</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.977130</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">6</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">21.977130</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">5</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;non&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">16782</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">7176</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">22.001693</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">7</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=oui&amp;enfants=3&amp;salaire=50000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-15-20" name="__codelineno-15-20"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">22.003013</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">7</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">mis</span> <span class="n">en</span> <span class="n">pause</span> <span class="n">du</span> <span class="n">thread</span> <span class="n">pendant</span> <span class="mi">1</span> <span class="n">seconde</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-15-21" name="__codelineno-15-21"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">22.003013</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">8</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=oui&amp;enfants=5&amp;salaire=100000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-15-22" name="__codelineno-15-22"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">22.003013</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">8</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">mis</span> <span class="n">en</span> <span class="n">pause</span> <span class="n">du</span> <span class="n">thread</span> <span class="n">pendant</span> <span class="mi">1</span> <span class="n">seconde</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-15-23" name="__codelineno-15-23"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">22.005871</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">9</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=non&amp;enfants=0&amp;salaire=200000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-15-24" name="__codelineno-15-24"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">22.006370</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">9</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;non&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">64210</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">7498</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.45</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-25" name="__codelineno-15-25"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">22.014170</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">10</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=oui&amp;enfants=3&amp;salaire=200000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-15-26" name="__codelineno-15-26"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">22.014170</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">10</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">42842</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">17283</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-27" name="__codelineno-15-27"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.003533</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">7</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">720</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-28" name="__codelineno-15-28"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.006434</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">8</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">4230</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-29" name="__codelineno-15-29"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.018026</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">11</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=non&amp;enfants=2&amp;salaire=100000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-15-30" name="__codelineno-15-30"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.019074</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">11</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;non&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">19884</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">4480</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
<a id="__codelineno-15-31" name="__codelineno-15-31"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.021447</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">12</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="n">requête</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">Request</span> <span class="s1">&#39;http://127.0.0.1:5000/?marié=non&amp;enfants=0&amp;salaire=100000&#39;</span> <span class="p">[</span><span class="n">GET</span><span class="p">]</span><span class="o">&gt;</span>
<a id="__codelineno-15-32" name="__codelineno-15-32"></a><span class="mi">2020</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">24</span> <span class="mi">10</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">23.022447</span><span class="p">,</span> <span class="n">Thread</span><span class="o">-</span><span class="mi">12</span> <span class="p">:</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="p">{</span><span class="s1">&#39;réponse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;non&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;impôt&#39;</span><span class="p">:</span> <span class="mi">22986</span><span class="p">,</span> <span class="s1">&#39;surcôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;taux&#39;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span> <span class="s1">&#39;décôte&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;réduction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>on voit que 11 threads ont traité les 11 contribuables ;</li>
<li>certains threads ont été mis en attente (lignes 6, 8, 12, 14, 20, 22) et d’autres pas (lignes 9, 23, 25, 29, 31) ;</li>
</ul>
<h2 id="245-tests-de-la-couche-dao">24.5. Tests de la couche [dao]</h2>
<p>Comme nous l’avons fait dans la |<a href="#_Tests_de_la"><u><u>version précédente</u></u></a>| nous testons la couche <strong>[dao]</strong> du client. Le principe est exactement le même :</p>
<p><img src="images/1000000000000390000003C89110DD1E.png" style="width:10.521cm;height:11.171cm;" alt="Image" /></p>
<p>La classe de test sera exécutée dans l’environnement suivant :</p>
<p><img src="images/10000000000001AA000002066FDFF26C.png" style="width:4.911cm;height:5.98cm;" alt="Image" /></p>
<ul>
<li>la configuration <strong>[2]</strong> est identique à la configuration <strong>[1]</strong> que nous venons d’étudier ;
La classe de test <strong>[</strong><strong>TestHttpClientDao</strong><strong>]</strong> est la suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span>
<span class="normal"><a href="#__codelineno-16-20">20</a></span>
<span class="normal"><a href="#__codelineno-16-21">21</a></span>
<span class="normal"><a href="#__codelineno-16-22">22</a></span>
<span class="normal"><a href="#__codelineno-16-23">23</a></span>
<span class="normal"><a href="#__codelineno-16-24">24</a></span>
<span class="normal"><a href="#__codelineno-16-25">25</a></span>
<span class="normal"><a href="#__codelineno-16-26">26</a></span>
<span class="normal"><a href="#__codelineno-16-27">27</a></span>
<span class="normal"><a href="#__codelineno-16-28">28</a></span>
<span class="normal"><a href="#__codelineno-16-29">29</a></span>
<span class="normal"><a href="#__codelineno-16-30">30</a></span>
<span class="normal"><a href="#__codelineno-16-31">31</a></span>
<span class="normal"><a href="#__codelineno-16-32">32</a></span>
<span class="normal"><a href="#__codelineno-16-33">33</a></span>
<span class="normal"><a href="#__codelineno-16-34">34</a></span>
<span class="normal"><a href="#__codelineno-16-35">35</a></span>
<span class="normal"><a href="#__codelineno-16-36">36</a></span>
<span class="normal"><a href="#__codelineno-16-37">37</a></span>
<span class="normal"><a href="#__codelineno-16-38">38</a></span>
<span class="normal"><a href="#__codelineno-16-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">unittest</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">Logger</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestHttpClientDao</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">TaxPayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaxPayer</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a>        <span class="c1"># {&#39;marié&#39;: &#39;oui&#39;, &#39;enfants&#39;: 2, &#39;salaire&#39;: 55555,</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a>        <span class="c1"># &#39;impôt&#39;: 2814, &#39;surcôte&#39;: 0, &#39;décôte&#39;: 0, &#39;réduction&#39;: 0, &#39;taux&#39;: 0.14}</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a>        <span class="n">taxpayer</span> <span class="o">=</span> <span class="n">TaxPayer</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">55555</span><span class="p">})</span>
<a id="__codelineno-16-14" name="__codelineno-16-14"></a>        <span class="n">dao</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">taxpayer</span><span class="p">)</span>
<a id="__codelineno-16-15" name="__codelineno-16-15"></a>        <span class="c1"># vérification</span>
<a id="__codelineno-16-16" name="__codelineno-16-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">impôt</span><span class="p">,</span> <span class="mi">2815</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-16-17" name="__codelineno-16-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">décôte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-16-18" name="__codelineno-16-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">réduction</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-16-19" name="__codelineno-16-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">taux</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<a id="__codelineno-16-20" name="__codelineno-16-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">surcôte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-16-21" name="__codelineno-16-21"></a>
<a id="__codelineno-16-22" name="__codelineno-16-22"></a>    <span class="err">…</span>
<a id="__codelineno-16-23" name="__codelineno-16-23"></a>
<a id="__codelineno-16-24" name="__codelineno-16-24"></a>
<a id="__codelineno-16-25" name="__codelineno-16-25"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-16-26" name="__codelineno-16-26"></a>    <span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-16-27" name="__codelineno-16-27"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-16-28" name="__codelineno-16-28"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({})</span>
<a id="__codelineno-16-29" name="__codelineno-16-29"></a>
<a id="__codelineno-16-30" name="__codelineno-16-30"></a>    <span class="c1"># logger</span>
<a id="__codelineno-16-31" name="__codelineno-16-31"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;logsFilename&quot;</span><span class="p">])</span>
<a id="__codelineno-16-32" name="__codelineno-16-32"></a>    <span class="c1"># on le mémorise dans la config</span>
<a id="__codelineno-16-33" name="__codelineno-16-33"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;logger&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logger</span>
<a id="__codelineno-16-34" name="__codelineno-16-34"></a>    <span class="c1"># on récupère la couche [dao]</span>
<a id="__codelineno-16-35" name="__codelineno-16-35"></a>    <span class="n">dao</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">][</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span>
<a id="__codelineno-16-36" name="__codelineno-16-36"></a>
<a id="__codelineno-16-37" name="__codelineno-16-37"></a>    <span class="c1"># on exécute les méthodes de test</span>
<a id="__codelineno-16-38" name="__codelineno-16-38"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tests en cours...&quot;</span><span class="p">)</span>
<a id="__codelineno-16-39" name="__codelineno-16-39"></a>    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>on crée une |<a href="#_Tests_de_la"><u><u>configuration d’exécution</u></u></a>| pour ce test ;</li>
<li>on lance le serveur web avec tout son environnement ;</li>
<li>on exécute le test ;
Les résultats sont les suivants :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span>
<span class="normal"><a href="#__codelineno-17-5">5</a></span>
<span class="normal"><a href="#__codelineno-17-6">6</a></span>
<span class="normal"><a href="#__codelineno-17-7">7</a></span>
<span class="normal"><a href="#__codelineno-17-8">8</a></span>
<span class="normal"><a href="#__codelineno-17-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">Scripts</span>\<span class="n">python</span><span class="o">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">st</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">cours</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">impots</span><span class="o">/</span><span class="n">http</span><span class="o">-</span><span class="n">clients</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">TestHttpClientDao</span><span class="o">.</span><span class="n">py</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="n">tests</span> <span class="n">en</span> <span class="n">cours</span><span class="o">...</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="o">...........</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="o">----------------------------------------------------------------------</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="n">Ran</span> <span class="mi">11</span> <span class="n">tests</span> <span class="ow">in</span> <span class="mf">6.128</span><span class="n">s</span>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="n">OK</span>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="n">Process</span> <span class="n">finished</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner">

      <div>
        <a href="https://tahe.developpez.com" target="_blank">
          https://tahe.developpez.com
        </a>
        <br>
        Ce cours tutoriel écrit par <strong>Serge Tahé</strong> est mis à disposition du public selon les termes de la
        <em>Licence Creative Commons Attribution – Pas d’Utilisation Commerciale –
        Partage dans les Mêmes Conditions 3.0 non transposé</em>.
      </div>

    </div>
  </div>

      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": ".", "features": ["navigation.sections", "navigation.indexes", "toc.integrate", "navigation.top"], "search": "assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="javascripts/focus.js"></script>
      
    
  </body>
</html>