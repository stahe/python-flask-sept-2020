
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Introduction au langage Python 3 et au framework web Flask par l'exemple">
      
      
        <meta name="author" content="Serge Tahé">
      
      
        <link rel="canonical" href="https://stahe.github.io/python-flask-sept-2020/exercice-dx27application-version-5.html">
      
      
        <link rel="prev" href="utilisation-de-lorm-sqlalchemy.html">
      
      
        <link rel="next" href="fonctions-internet.html">
      
      
        
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>20. Exercice d'application : version 5 - Introduction au langage Python 3 et au framework web Flask par l'exemple</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="stylesheets/focus.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#20-exercice-dapplication-version-5" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Introduction au langage Python 3 et au framework web Flask par l&#39;exemple" class="md-header__button md-logo" aria-label="Introduction au langage Python 3 et au framework web Flask par l'exemple" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Introduction au langage Python 3 et au framework web Flask par l'exemple
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              20. Exercice d&#x27;application : version 5
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode sombre"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Passer au mode sombre" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode clair"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Passer au mode clair" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/stahe/python-flask-sept-2020" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Introduction au langage Python 3 et au framework web Flask par l&#39;exemple" class="md-nav__button md-logo" aria-label="Introduction au langage Python 3 et au framework web Flask par l'exemple" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Introduction au langage Python 3 et au framework web Flask par l'exemple
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/stahe/python-flask-sept-2020" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accueil
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="avant-propos.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Avant-propos
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="installation-dx27un-environnement-de-travail.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Installation d&#x27;un environnement de travail
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-bases-de-python.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Les bases de Python
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-chaines-de-caracteres.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Les chaînes de caractères
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-exceptions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Les exceptions
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-fonctions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Les fonctions
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-fichiers-texte.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    7. Les fichiers texte
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application---version-1.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    8. Exercice d&#x27;application – version 1
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-imports.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    9. Les imports
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-2.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    10. Exercice d’application : version 2
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-3.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    11. Exercice d’application : version 3
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-classes-et-objets.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    12. Les classes et objets
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="les-classes-generiques-baseentity-et-myexception.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    13. Les classes génériques [BaseEntity] et [MyException]
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="architecture-en-couches-et-programmation-par-interfaces.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    14. Architecture en couches et programmation par interfaces
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dx27application---version-4.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    15. Exercice d&#x27;application - version 4
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-du-sgbd-mysql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    16. Utilisation du SGBD MySQL
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-du-sgbd-postgresql.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    17. Utilisation du SGBD PostgreSQL
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="ecrire-du-code-independant-du-sgbd.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    18. Ecrire du code indépendant du SGBD
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilisation-de-lorm-sqlalchemy.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    19. Utilisation de l’ORM SQLALCHEMY
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    20. Exercice d&#x27;application : version 5
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="exercice-dx27application-version-5.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    20. Exercice d&#x27;application : version 5
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#201-application-1-initialisation-de-la-base-de-donnees" class="md-nav__link">
    <span class="md-ellipsis">
      
        20.1. Application 1 : initialisation de la base de données
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="20.1. Application 1 : initialisation de la base de données">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2011-le-fichier-admindatajson" class="md-nav__link">
    <span class="md-ellipsis">
      
        20.1.1. Le fichier [admindata.json]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2012-creation-des-bases-de-donnees" class="md-nav__link">
    <span class="md-ellipsis">
      
        20.1.2. Création des bases de données
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2013-les-entitees-mappees-par-sqlalchemy" class="md-nav__link">
    <span class="md-ellipsis">
      
        20.1.3. Les entitées mappées par [sqlalchemy]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2014-le-fichier-de-configuration-de-sqlalchemy" class="md-nav__link">
    <span class="md-ellipsis">
      
        20.1.4. Le fichier de configuration de [sqlalchemy]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2015-la-couche-dao" class="md-nav__link">
    <span class="md-ellipsis">
      
        20.1.5. La couche [dao]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2016-configuration-de-lapplication" class="md-nav__link">
    <span class="md-ellipsis">
      
        20.1.6. Configuration de l’application
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2017-le-script-main-de-lapplication" class="md-nav__link">
    <span class="md-ellipsis">
      
        20.1.7. Le script [main] de l’application
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#202-application-2-calcul-de-limpot-en-mode-batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        20.2. Application 2 : calcul de l’impôt en mode batch
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="20.2. Application 2 : calcul de l’impôt en mode batch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2021-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        20.2.1. Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2022-configuration-de-lapplication" class="md-nav__link">
    <span class="md-ellipsis">
      
        20.2.2. Configuration de l’application
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2023-la-couche-dao" class="md-nav__link">
    <span class="md-ellipsis">
      
        20.2.3. La couche [dao]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2024-test-de-la-couche-dao" class="md-nav__link">
    <span class="md-ellipsis">
      
        20.2.4. Test de la couche [dao]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2025-le-script-principal" class="md-nav__link">
    <span class="md-ellipsis">
      
        20.2.5. Le script principal
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#203-application-3-calcul-de-limpot-en-mode-interactif" class="md-nav__link">
    <span class="md-ellipsis">
      
        20.3. Application 3 : calcul de l’impôt en mode interactif
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="fonctions-internet.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    21. Fonctions internet
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="services-web-avec-le-framework-flask.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    22. Services web avec le framework Flask
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-6.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    23. Exercice d’application : version 6
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-7.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    24. Exercice d’application : version 7
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-8.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    25. Exercice d’application : version 8
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="du-dictionnaire-a-xml-et-vice-versa.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    26. Du dictionnaire à XML et vice-versa
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-9.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    27. Exercice d’application : version 9
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-10.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    28. Exercice d’application : version 10
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-11.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    29. Exercice d’application : version 11
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    30. Exercice d’application : version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="clients-web-pour-les-services-json-et-xml-de-la-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    31. Clients web pour les services jSON et XML de la version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="le-mode-html-de-la-version-12.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    32. Le mode HTML de la version 12
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-13.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    33. Exercice d’application : version 13
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-14.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    34. Exercice d’application : version 14
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-15.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    35. Exercice d’application : version 15
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-16.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    36. Exercice d’application : version 16
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-17.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    37. Exercice d’application : version 17
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exercice-dapplication-version-18.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    38. Exercice d’application : version 18
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="conclusion.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    39. Conclusion
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="20-exercice-dapplication-version-5">20. Exercice d&#x27;application : version 5</h1>
<p>Nous allons développer trois applications :</p>
<ul>
<li>l’application 1 initialisera la base de données qui va venir remplacer le fichier <strong>[admindata.json]</strong> de la version 4 ;</li>
<li>l’application 2 fera le calcul des impôts en mode batch ;</li>
<li>l’application 3 fera le calcul des impôts en mode interactif ;</li>
</ul>
<h2 id="201-application-1-initialisation-de-la-base-de-donnees">20.1. Application 1 : initialisation de la base de données</h2>
<p>L’application 1 aura l&#x27;architecture suivante :</p>
<p><img src="images/1000000000000474000002D64D661730.png" style="width:13.14cm;height:8.37cm;" alt="Image" /></p>
<p>C&#x27;est une évolution de l&#x27;architecture de la version 4 (paragraphe |<a href="#_Exercice_d'application_-"><u><u>Version 4</u></u></a>|) : les données fiscales seront trouvées dans une base de données au lieu d&#x27;être dans un fichier jSON. La couche <strong>[dao]</strong> va évoluer pour implémenter ce changement.</p>
<h3 id="2011-le-fichier-admindatajson">20.1.1. Le fichier [admindata.json]</h3>
<p>Le fichier <strong>[admindata.json]</strong> est celui qu’il était dans la version 4 :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="p">{</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="s2">&quot;limites&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">9964</span><span class="p">,</span> <span class="mi">27519</span><span class="p">,</span> <span class="mi">73779</span><span class="p">,</span> <span class="mi">156244</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="s2">&quot;coeffr&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.41</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">],</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="s2">&quot;coeffn&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1394.96</span><span class="p">,</span> <span class="mi">5798</span><span class="p">,</span> <span class="mf">13913.69</span><span class="p">,</span> <span class="mf">20163.45</span><span class="p">],</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="s2">&quot;plafond_qf_demi_part&quot;</span><span class="p">:</span> <span class="mi">1551</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="s2">&quot;plafond_revenus_celibataire_pour_reduction&quot;</span><span class="p">:</span> <span class="mi">21037</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="s2">&quot;plafond_revenus_couple_pour_reduction&quot;</span><span class="p">:</span> <span class="mi">42074</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="s2">&quot;valeur_reduc_demi_part&quot;</span><span class="p">:</span> <span class="mi">3797</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="s2">&quot;plafond_decote_celibataire&quot;</span><span class="p">:</span> <span class="mi">1196</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="s2">&quot;plafond_decote_couple&quot;</span><span class="p">:</span> <span class="mi">1970</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="s2">&quot;plafond_impot_couple_pour_decote&quot;</span><span class="p">:</span> <span class="mi">2627</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="s2">&quot;plafond_impot_celibataire_pour_decote&quot;</span><span class="p">:</span> <span class="mi">1595</span><span class="p">,</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="s2">&quot;abattement_dixpourcent_max&quot;</span><span class="p">:</span> <span class="mi">12502</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="s2">&quot;abattement_dixpourcent_min&quot;</span><span class="p">:</span> <span class="mi">437</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Nous allons utiliser comme colonnes de la base de données les clés de ce dictionnaire.</p>
<h3 id="2012-creation-des-bases-de-donnees">20.1.2. Création des bases de données</h3>
<p>Comme il a été montré au paragraphe |<a href="#_Création_d’une_base"><u><u>création d’une base de données MySQL</u></u></a>|, nous créons une base de données MySQL nommée <strong>[dbimpots-2019]</strong> propriété de l’utilisateur <strong>[admimpots]</strong> de mot de passe <strong>[mdpimpots]</strong>. Dans <strong>[phpMyAdmin]</strong> cela donne la chose suivante :</p>
<p><img src="images/100000000000059B000001889F0F7712.png" style="width:16.581cm;height:4.53cm;" alt="Image" /></p>
<p>De même, comme il a été montré au paragraphe |<a href="#_Administrer_PostgreSQL_avec"><u><u>création d’une base de données PostgreSQL</u></u></a>|, nous créons une base de données PostgreSQL nommée <strong>[dbimpots-2019]</strong> propriété de l’utilisateur <strong>[admimpots]</strong> de mot de passe <strong>[mdpimpots]</strong>. Dans <strong>[pgAdmin]</strong> cela donne la chose suivante :</p>
<p><img src="images/10000000000005540000021DD77E89EE.png" style="width:15.761cm;height:6.241cm;" alt="Image" /></p>
<p>Les bases sont créées mais pour l’instant elles n’ont aucune table. Celles-ci vont être construites par l’ORM <strong>[sqlalchemy]</strong>.</p>
<h3 id="2013-les-entitees-mappees-par-sqlalchemy">20.1.3. Les entitées mappées par [sqlalchemy]</h3>
<p>Nous allons créer deux tables pour encapsuler les données de <strong>[admindata.json]</strong> :</p>
<p>Définie par <strong>[sqlalchemy]</strong> la table <strong>[</strong><strong>tbtranches</strong><strong>]</strong> rassemblera les données des tableaux <strong>[limites, coeffr, coeffn]</strong> du dictionnaire <strong>[admindata.json]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span>
<span class="normal"><a href="#__codelineno-1-3">3</a></span>
<span class="normal"><a href="#__codelineno-1-4">4</a></span>
<span class="normal"><a href="#__codelineno-1-5">5</a></span>
<span class="normal"><a href="#__codelineno-1-6">6</a></span>
<span class="normal"><a href="#__codelineno-1-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>    <span class="c1"># la table des tranches de l&#39;impôt</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>    <span class="n">tranches_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;tbtranches&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;limite&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;coeffr&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;coeffn&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>                           <span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Définie par <strong>[sqlalchemy]</strong> la table <strong>[</strong><strong>tbconstantes</strong><strong>]</strong> rassemblera les constantes du dictionnaire <strong>[admindata.json]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a>    <span class="c1"># la table des constantes</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>    <span class="n">constantes_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;tbconstantes&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_qf_demi_part&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_revenus_celibataire_pour_reduction&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_revenus_couple_pour_reduction&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;valeur_reduc_demi_part&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_decote_celibataire&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_decote_couple&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_impot_celibataire_pour_decote&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_impot_couple_pour_decote&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;abattement_dixpourcent_max&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;abattement_dixpourcent_min&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>                             <span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Les entités qui seront mappées avec ces deux tables seront les suivantes :</p>
<p><img src="images/100000000000013F0000014DF6407E52.png" style="width:3.68cm;height:3.841cm;" alt="Image" /></p>
<p>L’entité <strong>[Constantes]</strong> encapsule les constantes du dictionnaire <strong>[admindata.json]</strong> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">BaseEntity</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseEntity</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="c1"># classe conteneur des données de l&#39;administration fiscale</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">Constantes</span><span class="p">(</span><span class="n">BaseEntity</span><span class="p">):</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>    <span class="c1"># clés exclues de l&#39;état de la classe</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_sa_instance_state&quot;</span><span class="p">]</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>    <span class="c1"># clés autorisées</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_allowed_keys</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>                <span class="s2">&quot;plafond_qf_demi_part&quot;</span><span class="p">,</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>                <span class="s2">&quot;plafond_revenus_celibataire_pour_reduction&quot;</span><span class="p">,</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a>                <span class="s2">&quot;plafond_revenus_couple_pour_reduction&quot;</span><span class="p">,</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a>                <span class="s2">&quot;valeur_reduc_demi_part&quot;</span><span class="p">,</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>                <span class="s2">&quot;plafond_decote_celibataire&quot;</span><span class="p">,</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>                <span class="s2">&quot;plafond_decote_couple&quot;</span><span class="p">,</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a>                <span class="s2">&quot;plafond_decote_couple&quot;</span><span class="p">,</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a>                <span class="s2">&quot;plafond_impot_celibataire_pour_decote&quot;</span><span class="p">,</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a>                <span class="s2">&quot;plafond_impot_couple_pour_decote&quot;</span><span class="p">,</span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a>                <span class="s2">&quot;abattement_dixpourcent_max&quot;</span><span class="p">,</span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a>                <span class="s2">&quot;abattement_dixpourcent_min&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 5 : la classe <strong>[Constantes]</strong> étend la classe <strong>[BaseEntity]</strong> ;</li>
<li>ligne 7 : par mapping <strong>[sqlalchemy]</strong>, la classe <strong>[Constante]</strong> va recevoir la propriété <strong>[</strong><strong>_sa_instance_state</strong><strong>]</strong>. Nous l’excluons du dictionnaire <strong>[asdict]</strong> de l’entité ;</li>
<li>lignes 11-23 : les propriétés de l’entité. On a repris les noms utilisés dans le dictionnaire <strong>[admindata.json]</strong> pour faciliter l’écriture du code ;
L’entité <strong>[Tranche]</strong> encapsule une ligne des trois tableaux <strong>[limites, coeffr, coeffn]</strong> du dictionnaire <strong>[admindata.json]</strong> :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">BaseEntity</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseEntity</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="c1"># classe conteneur des données de l&#39;administration fiscale</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">Tranche</span><span class="p">(</span><span class="n">BaseEntity</span><span class="p">):</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>    <span class="c1"># clés exclues de l&#39;état de la classe</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>    <span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_sa_instance_state&quot;</span><span class="p">]</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>    <span class="c1"># clés autorisées</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_allowed_keys</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;limite&quot;</span><span class="p">,</span> <span class="s2">&quot;coeffr&quot;</span><span class="p">,</span> <span class="s2">&quot;coeffn&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 5 : la classe <strong>[Tranche]</strong> étend la classe <strong>[BaseEntity]</strong> ;</li>
<li>ligne 7 : on exclut des propriétés du dictionnaire <strong>[asdict]</strong> de l’entité, la propriété <strong>[</strong><strong>_sa_instance_state</strong><strong>]</strong> ajoutée par <strong>[sqlalchemy]</strong> ;</li>
<li>lignes 10-12 : les propriétés de la classe ;
Le mapping entre les entités <strong>[Constantes, Tranche]</strong> et les tables <strong>[constantes, tranches]</strong> sera le suivant :</li>
</ul>
<p><img src="images/10000000000001AB000002060FD6F2A5.png" style="width:4.43cm;height:5.381cm;" alt="Image" /></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span>
<span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span>
<span class="normal"><a href="#__codelineno-5-28">28</a></span>
<span class="normal"><a href="#__codelineno-5-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="err">…</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>    <span class="c1"># la table des constantes</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>    <span class="n">constantes_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;tbconstantes&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_qf_demi_part&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_revenus_celibataire_pour_reduction&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_revenus_couple_pour_reduction&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;valeur_reduc_demi_part&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_decote_celibataire&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_decote_couple&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_impot_celibataire_pour_decote&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_impot_couple_pour_decote&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;abattement_dixpourcent_max&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;abattement_dixpourcent_min&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a>                             <span class="p">)</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a>    <span class="c1"># la table des tranches de l&#39;impôt</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a>    <span class="n">tranches_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;tbtranches&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;limite&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;coeffr&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;coeffn&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a>                           <span class="p">)</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a>    <span class="c1"># les mappings</span>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Tranche</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tranche</span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a>    <span class="n">mapper</span><span class="p">(</span><span class="n">Tranche</span><span class="p">,</span> <span class="n">tranches_table</span><span class="p">)</span>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Constantes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Constantes</span>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a>    <span class="n">mapper</span><span class="p">(</span><span class="n">Constantes</span><span class="p">,</span> <span class="n">constantes_table</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>les mappings sont faits aux lignes 24-29. On y a omis de faire les correspondances entre propriétés des entités mappées et tables de la base de données. C’est possible lorsque les noms des colonnes des tables sont les mêmes que ceux des propriétés auxquelles elles doivent être associées. Pour cette raison, nous avons repris dans les tables les noms des propriétés des entités mappées. Cela facilite l’écriture du code et sa compréhension ;</li>
</ul>
<h3 id="2014-le-fichier-de-configuration-de-sqlalchemy">20.1.4. Le fichier de configuration de [sqlalchemy]</h3>
<p><img src="images/10000000000001AB000002060FD6F2A5.png" style="width:4.43cm;height:5.381cm;" alt="Image" /></p>
<p>Nous venons de détailler une partie de la configuration de <strong>[sqlalchemy]</strong>. Le fichier <strong>[config_database]</strong> dans sa totalité est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span>
<span class="normal"><a href="#__codelineno-6-32">32</a></span>
<span class="normal"><a href="#__codelineno-6-33">33</a></span>
<span class="normal"><a href="#__codelineno-6-34">34</a></span>
<span class="normal"><a href="#__codelineno-6-35">35</a></span>
<span class="normal"><a href="#__codelineno-6-36">36</a></span>
<span class="normal"><a href="#__codelineno-6-37">37</a></span>
<span class="normal"><a href="#__codelineno-6-38">38</a></span>
<span class="normal"><a href="#__codelineno-6-39">39</a></span>
<span class="normal"><a href="#__codelineno-6-40">40</a></span>
<span class="normal"><a href="#__codelineno-6-41">41</a></span>
<span class="normal"><a href="#__codelineno-6-42">42</a></span>
<span class="normal"><a href="#__codelineno-6-43">43</a></span>
<span class="normal"><a href="#__codelineno-6-44">44</a></span>
<span class="normal"><a href="#__codelineno-6-45">45</a></span>
<span class="normal"><a href="#__codelineno-6-46">46</a></span>
<span class="normal"><a href="#__codelineno-6-47">47</a></span>
<span class="normal"><a href="#__codelineno-6-48">48</a></span>
<span class="normal"><a href="#__codelineno-6-49">49</a></span>
<span class="normal"><a href="#__codelineno-6-50">50</a></span>
<span class="normal"><a href="#__codelineno-6-51">51</a></span>
<span class="normal"><a href="#__codelineno-6-52">52</a></span>
<span class="normal"><a href="#__codelineno-6-53">53</a></span>
<span class="normal"><a href="#__codelineno-6-54">54</a></span>
<span class="normal"><a href="#__codelineno-6-55">55</a></span>
<span class="normal"><a href="#__codelineno-6-56">56</a></span>
<span class="normal"><a href="#__codelineno-6-57">57</a></span>
<span class="normal"><a href="#__codelineno-6-58">58</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span class="c1"># configuration sqlalchemy</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Float</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">sessionmaker</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>    <span class="c1"># chaînes de connexion aux bases de données exploitées</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>    <span class="n">connection_strings</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>        <span class="s1">&#39;mysql&#39;</span><span class="p">:</span> <span class="s2">&quot;mysql+mysqlconnector://admimpots:mdpimpots@localhost/dbimpots-2019&quot;</span><span class="p">,</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>        <span class="s1">&#39;pgres&#39;</span><span class="p">:</span> <span class="s2">&quot;postgresql+psycopg2://admimpots:mdpimpots@localhost/dbimpots-2019&quot;</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>    <span class="p">}</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>    <span class="c1"># chaîne de connexion à la base de données exploitée</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">connection_strings</span><span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sgbd&#39;</span><span class="p">]])</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a>    <span class="c1"># metadata</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a>    <span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a>    <span class="c1"># la table des constantes</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a>    <span class="n">constantes_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;tbconstantes&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_qf_demi_part&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_revenus_celibataire_pour_reduction&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_revenus_couple_pour_reduction&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;valeur_reduc_demi_part&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_decote_celibataire&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_decote_couple&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_impot_celibataire_pour_decote&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-6-27" name="__codelineno-6-27"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;plafond_impot_couple_pour_decote&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-6-28" name="__codelineno-6-28"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;abattement_dixpourcent_max&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a>                             <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;abattement_dixpourcent_min&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a>                             <span class="p">)</span>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a>
<a id="__codelineno-6-32" name="__codelineno-6-32"></a>    <span class="c1"># la table des tranches de l&#39;impôt</span>
<a id="__codelineno-6-33" name="__codelineno-6-33"></a>    <span class="n">tranches_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;tbtranches&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-6-34" name="__codelineno-6-34"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-6-35" name="__codelineno-6-35"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;limite&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-6-36" name="__codelineno-6-36"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;coeffr&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-6-37" name="__codelineno-6-37"></a>                           <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;coeffn&#39;</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-6-38" name="__codelineno-6-38"></a>                           <span class="p">)</span>
<a id="__codelineno-6-39" name="__codelineno-6-39"></a>    <span class="c1"># les mappings</span>
<a id="__codelineno-6-40" name="__codelineno-6-40"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Tranche</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tranche</span>
<a id="__codelineno-6-41" name="__codelineno-6-41"></a>    <span class="n">mapper</span><span class="p">(</span><span class="n">Tranche</span><span class="p">,</span> <span class="n">tranches_table</span><span class="p">)</span>
<a id="__codelineno-6-42" name="__codelineno-6-42"></a>
<a id="__codelineno-6-43" name="__codelineno-6-43"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">Constantes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Constantes</span>
<a id="__codelineno-6-44" name="__codelineno-6-44"></a>    <span class="n">mapper</span><span class="p">(</span><span class="n">Constantes</span><span class="p">,</span> <span class="n">constantes_table</span><span class="p">)</span>
<a id="__codelineno-6-45" name="__codelineno-6-45"></a>
<a id="__codelineno-6-46" name="__codelineno-6-46"></a>    <span class="c1"># la session factory</span>
<a id="__codelineno-6-47" name="__codelineno-6-47"></a>    <span class="n">session_factory</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()</span>
<a id="__codelineno-6-48" name="__codelineno-6-48"></a>    <span class="n">session_factory</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<a id="__codelineno-6-49" name="__codelineno-6-49"></a>
<a id="__codelineno-6-50" name="__codelineno-6-50"></a>    <span class="c1"># une session</span>
<a id="__codelineno-6-51" name="__codelineno-6-51"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">session_factory</span><span class="p">()</span>
<a id="__codelineno-6-52" name="__codelineno-6-52"></a>
<a id="__codelineno-6-53" name="__codelineno-6-53"></a>    <span class="c1"># on enregistre certaines informations</span>
<a id="__codelineno-6-54" name="__codelineno-6-54"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;engine&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">,</span> <span class="s2">&quot;tranches_table&quot;</span><span class="p">:</span> <span class="n">tranches_table</span><span class="p">,</span>
<a id="__codelineno-6-55" name="__codelineno-6-55"></a>                          <span class="s2">&quot;constantes_table&quot;</span><span class="p">:</span> <span class="n">constantes_table</span><span class="p">,</span> <span class="s2">&quot;session&quot;</span><span class="p">:</span> <span class="n">session</span><span class="p">}</span>
<a id="__codelineno-6-56" name="__codelineno-6-56"></a>
<a id="__codelineno-6-57" name="__codelineno-6-57"></a>    <span class="c1"># résultat</span>
<a id="__codelineno-6-58" name="__codelineno-6-58"></a>    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 1 : la fonction <strong>[configure]</strong> reçoit en paramètre un dictionnaire dont la clé <strong>[sgbd]</strong> lui dit quel SGBD utiliser : MySQL (mysql) ou PostgreSQL (pgres) ;</li>
<li>lignes 6-12 : on sélectionne la base de données demandée par la configuration ;</li>
<li>lignes 14-44 : mappings entités / tables.  Ces mappings sont simples car il n’existe aucun lien entre les tables <strong>[tranches]</strong> et <strong>[constantes]</strong>. Elles sont indépendantes. Il n’y a donc pas de clé étrangère de l’une sur l’autre à gérer ;</li>
<li>lignes 46-51 : on crée la session <strong>[session]</strong> de travail de l’application ;</li>
<li>lignes 53-58 : les informations utiles sont mises dans le dictionnaire de la configuration et celui-ci est retourné ;</li>
</ul>
<h3 id="2015-la-couche-dao">20.1.5. La couche [dao]</h3>
<p>Revenons à l’architecture de l’application 1 à construire :</p>
<p><img src="images/1000000000000474000002D64D661730.png" style="width:13.14cm;height:8.37cm;" alt="Image" /></p>
<p>La couche <strong>[dao]</strong> <strong>[1]</strong> doit lire le fichier <strong>[admindata.json]</strong> <strong>[2]</strong> et transférer son contenu dans une des bases <strong>[3, 4]</strong> ;</p>
<p><img src="images/100000000000022F000001FDE6D0F33E.png" style="width:6.46cm;height:5.882cm;" alt="Image" /></p>
<p>La couche <strong>[dao]</strong> présente l’interface <strong>[1]</strong> et est implémentée par la classe <strong>[2]</strong>.</p>
<p>L’interface <strong>[</strong><strong>InterfaceDao4TransferAdminData2Database</strong><strong>]</strong> est la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1"># imports</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="c1"># interface InterfaceImpôtsUI</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">InterfaceDao4TransferAdminData2Database</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>    <span class="c1"># transfert des données fiscales dans une base de données</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">transfer_admindata_in_database</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span><span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 8-10 : l’interface ne présente qu’une méthode <strong>[</strong><strong>transfer_admindata_in_database</strong><strong>]</strong> sans paramètres. Comme cette méthode a besoin de paramètres (quel fichier ?, quelle base de données ?), cela signifie que ceux-ci seront passés au constructeur des classes implémentant cette interface ;
La classe <strong>[</strong><strong>DaoTransferAdminDataFromJsonFile2Database</strong><strong>]</strong> implémente l’interface <strong>[</strong><strong>InterfaceDao4TransferAdminData2Database</strong><strong>]</strong> de la façon suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span>
<span class="normal"><a href="#__codelineno-8-33">33</a></span>
<span class="normal"><a href="#__codelineno-8-34">34</a></span>
<span class="normal"><a href="#__codelineno-8-35">35</a></span>
<span class="normal"><a href="#__codelineno-8-36">36</a></span>
<span class="normal"><a href="#__codelineno-8-37">37</a></span>
<span class="normal"><a href="#__codelineno-8-38">38</a></span>
<span class="normal"><a href="#__codelineno-8-39">39</a></span>
<span class="normal"><a href="#__codelineno-8-40">40</a></span>
<span class="normal"><a href="#__codelineno-8-41">41</a></span>
<span class="normal"><a href="#__codelineno-8-42">42</a></span>
<span class="normal"><a href="#__codelineno-8-43">43</a></span>
<span class="normal"><a href="#__codelineno-8-44">44</a></span>
<span class="normal"><a href="#__codelineno-8-45">45</a></span>
<span class="normal"><a href="#__codelineno-8-46">46</a></span>
<span class="normal"><a href="#__codelineno-8-47">47</a></span>
<span class="normal"><a href="#__codelineno-8-48">48</a></span>
<span class="normal"><a href="#__codelineno-8-49">49</a></span>
<span class="normal"><a href="#__codelineno-8-50">50</a></span>
<span class="normal"><a href="#__codelineno-8-51">51</a></span>
<span class="normal"><a href="#__codelineno-8-52">52</a></span>
<span class="normal"><a href="#__codelineno-8-53">53</a></span>
<span class="normal"><a href="#__codelineno-8-54">54</a></span>
<span class="normal"><a href="#__codelineno-8-55">55</a></span>
<span class="normal"><a href="#__codelineno-8-56">56</a></span>
<span class="normal"><a href="#__codelineno-8-57">57</a></span>
<span class="normal"><a href="#__codelineno-8-58">58</a></span>
<span class="normal"><a href="#__codelineno-8-59">59</a></span>
<span class="normal"><a href="#__codelineno-8-60">60</a></span>
<span class="normal"><a href="#__codelineno-8-61">61</a></span>
<span class="normal"><a href="#__codelineno-8-62">62</a></span>
<span class="normal"><a href="#__codelineno-8-63">63</a></span>
<span class="normal"><a href="#__codelineno-8-64">64</a></span>
<span class="normal"><a href="#__codelineno-8-65">65</a></span>
<span class="normal"><a href="#__codelineno-8-66">66</a></span>
<span class="normal"><a href="#__codelineno-8-67">67</a></span>
<span class="normal"><a href="#__codelineno-8-68">68</a></span>
<span class="normal"><a href="#__codelineno-8-69">69</a></span>
<span class="normal"><a href="#__codelineno-8-70">70</a></span>
<span class="normal"><a href="#__codelineno-8-71">71</a></span>
<span class="normal"><a href="#__codelineno-8-72">72</a></span>
<span class="normal"><a href="#__codelineno-8-73">73</a></span>
<span class="normal"><a href="#__codelineno-8-74">74</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="c1"># imports</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">codecs</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.exc</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">IntegrityError</span><span class="p">,</span> <span class="n">InterfaceError</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Constantes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Constantes</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">InterfaceDao4TransferAdminData2Database</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterfaceDao4TransferAdminData2Database</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Tranche</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tranche</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">DaoTransferAdminDataFromJsonFile2Database</span><span class="p">(</span><span class="n">InterfaceDao4TransferAdminData2Database</span><span class="p">):</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a>    <span class="c1"># constructeur</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a>    <span class="c1"># transfert</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">transfer_admindata_in_database</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a>        <span class="c1"># initialisations</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a>        <span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a>        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a>            <span class="c1"># on récupère les données de l&#39;administration fiscale</span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a>            <span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;admindataFilename&quot;</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
<a id="__codelineno-8-28" name="__codelineno-8-28"></a>                <span class="c1"># transfert du contenu dans un dictionnaire</span>
<a id="__codelineno-8-29" name="__codelineno-8-29"></a>                <span class="n">admindata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
<a id="__codelineno-8-30" name="__codelineno-8-30"></a>
<a id="__codelineno-8-31" name="__codelineno-8-31"></a>            <span class="c1"># on récupère la configuration de la base de données</span>
<a id="__codelineno-8-32" name="__codelineno-8-32"></a>            <span class="n">database</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span>
<a id="__codelineno-8-33" name="__codelineno-8-33"></a>
<a id="__codelineno-8-34" name="__codelineno-8-34"></a>            <span class="c1"># suppression des deux tables de la base de données</span>
<a id="__codelineno-8-35" name="__codelineno-8-35"></a>            <span class="c1"># checkfirst=True : vérifie d&#39;abord que la table existe</span>
<a id="__codelineno-8-36" name="__codelineno-8-36"></a>            <span class="n">database</span><span class="p">[</span><span class="s2">&quot;tranches_table&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">database</span><span class="p">[</span><span class="s2">&quot;engine&quot;</span><span class="p">],</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-8-37" name="__codelineno-8-37"></a>            <span class="n">database</span><span class="p">[</span><span class="s2">&quot;constantes_table&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">database</span><span class="p">[</span><span class="s2">&quot;engine&quot;</span><span class="p">],</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-8-38" name="__codelineno-8-38"></a>
<a id="__codelineno-8-39" name="__codelineno-8-39"></a>            <span class="c1"># recréation des tables à partir des mappings</span>
<a id="__codelineno-8-40" name="__codelineno-8-40"></a>            <span class="n">database</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">database</span><span class="p">[</span><span class="s2">&quot;engine&quot;</span><span class="p">])</span>
<a id="__codelineno-8-41" name="__codelineno-8-41"></a>
<a id="__codelineno-8-42" name="__codelineno-8-42"></a>            <span class="c1"># la session [sqlalchemy] courante</span>
<a id="__codelineno-8-43" name="__codelineno-8-43"></a>            <span class="n">session</span> <span class="o">=</span> <span class="n">database</span><span class="p">[</span><span class="s2">&quot;session&quot;</span><span class="p">]</span>
<a id="__codelineno-8-44" name="__codelineno-8-44"></a>
<a id="__codelineno-8-45" name="__codelineno-8-45"></a>            <span class="c1"># on remplit la table des tranches de l&#39;impôt</span>
<a id="__codelineno-8-46" name="__codelineno-8-46"></a>            <span class="n">limites</span> <span class="o">=</span> <span class="n">admindata</span><span class="p">[</span><span class="s2">&quot;limites&quot;</span><span class="p">]</span>
<a id="__codelineno-8-47" name="__codelineno-8-47"></a>            <span class="n">coeffr</span> <span class="o">=</span> <span class="n">admindata</span><span class="p">[</span><span class="s2">&quot;coeffr&quot;</span><span class="p">]</span>
<a id="__codelineno-8-48" name="__codelineno-8-48"></a>            <span class="n">coeffn</span> <span class="o">=</span> <span class="n">admindata</span><span class="p">[</span><span class="s2">&quot;coeffn&quot;</span><span class="p">]</span>
<a id="__codelineno-8-49" name="__codelineno-8-49"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">limites</span><span class="p">)):</span>
<a id="__codelineno-8-50" name="__codelineno-8-50"></a>                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Tranche</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">(</span>
<a id="__codelineno-8-51" name="__codelineno-8-51"></a>                    <span class="p">{</span><span class="s2">&quot;limite&quot;</span><span class="p">:</span> <span class="n">limites</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;coeffr&quot;</span><span class="p">:</span> <span class="n">coeffr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;coeffn&quot;</span><span class="p">:</span> <span class="n">coeffn</span><span class="p">[</span><span class="n">i</span><span class="p">]}))</span>
<a id="__codelineno-8-52" name="__codelineno-8-52"></a>            <span class="c1"># on remplit la table des constantes</span>
<a id="__codelineno-8-53" name="__codelineno-8-53"></a>            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Constantes</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span>
<a id="__codelineno-8-54" name="__codelineno-8-54"></a>                <span class="s1">&#39;plafond_qf_demi_part&#39;</span><span class="p">:</span> <span class="n">admindata</span><span class="p">[</span><span class="s2">&quot;plafond_qf_demi_part&quot;</span><span class="p">],</span>
<a id="__codelineno-8-55" name="__codelineno-8-55"></a>                <span class="s1">&#39;plafond_revenus_celibataire_pour_reduction&#39;</span><span class="p">:</span> <span class="n">admindata</span><span class="p">[</span><span class="s2">&quot;plafond_revenus_celibataire_pour_reduction&quot;</span><span class="p">],</span>
<a id="__codelineno-8-56" name="__codelineno-8-56"></a>                <span class="s1">&#39;plafond_revenus_couple_pour_reduction&#39;</span><span class="p">:</span> <span class="n">admindata</span><span class="p">[</span><span class="s2">&quot;plafond_revenus_couple_pour_reduction&quot;</span><span class="p">],</span>
<a id="__codelineno-8-57" name="__codelineno-8-57"></a>                <span class="s1">&#39;valeur_reduc_demi_part&#39;</span><span class="p">:</span> <span class="n">admindata</span><span class="p">[</span><span class="s2">&quot;valeur_reduc_demi_part&quot;</span><span class="p">],</span>
<a id="__codelineno-8-58" name="__codelineno-8-58"></a>                <span class="s1">&#39;plafond_decote_celibataire&#39;</span><span class="p">:</span> <span class="n">admindata</span><span class="p">[</span><span class="s2">&quot;plafond_decote_celibataire&quot;</span><span class="p">],</span>
<a id="__codelineno-8-59" name="__codelineno-8-59"></a>                <span class="s1">&#39;plafond_decote_couple&#39;</span><span class="p">:</span> <span class="n">admindata</span><span class="p">[</span><span class="s2">&quot;plafond_decote_couple&quot;</span><span class="p">],</span>
<a id="__codelineno-8-60" name="__codelineno-8-60"></a>                <span class="s1">&#39;plafond_impot_celibataire_pour_decote&#39;</span><span class="p">:</span> <span class="n">admindata</span><span class="p">[</span><span class="s2">&quot;plafond_impot_celibataire_pour_decote&quot;</span><span class="p">],</span>
<a id="__codelineno-8-61" name="__codelineno-8-61"></a>                <span class="s1">&#39;plafond_impot_couple_pour_decote&#39;</span><span class="p">:</span> <span class="n">admindata</span><span class="p">[</span><span class="s2">&quot;plafond_impot_couple_pour_decote&quot;</span><span class="p">],</span>
<a id="__codelineno-8-62" name="__codelineno-8-62"></a>                <span class="s1">&#39;abattement_dixpourcent_max&#39;</span><span class="p">:</span> <span class="n">admindata</span><span class="p">[</span><span class="s2">&quot;abattement_dixpourcent_max&quot;</span><span class="p">],</span>
<a id="__codelineno-8-63" name="__codelineno-8-63"></a>                <span class="s1">&#39;abattement_dixpourcent_min&#39;</span><span class="p">:</span> <span class="n">admindata</span><span class="p">[</span><span class="s2">&quot;abattement_dixpourcent_min&quot;</span><span class="p">]</span>
<a id="__codelineno-8-64" name="__codelineno-8-64"></a>            <span class="p">}))</span>
<a id="__codelineno-8-65" name="__codelineno-8-65"></a>
<a id="__codelineno-8-66" name="__codelineno-8-66"></a>            <span class="c1"># validation de la session [sqlalchemy]</span>
<a id="__codelineno-8-67" name="__codelineno-8-67"></a>            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-8-68" name="__codelineno-8-68"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">InterfaceError</span><span class="p">)</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-8-69" name="__codelineno-8-69"></a>            <span class="c1"># on relance l&#39;exception sous une autre forme</span>
<a id="__codelineno-8-70" name="__codelineno-8-70"></a>            <span class="k">raise</span> <span class="n">ImpôtsError</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-71" name="__codelineno-8-71"></a>        <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-8-72" name="__codelineno-8-72"></a>            <span class="c1"># on libère les ressources de la session</span>
<a id="__codelineno-8-73" name="__codelineno-8-73"></a>            <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-8-74" name="__codelineno-8-74"></a>                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 13 : la classe <strong>[</strong><strong>DaoTransferAdminDataFromJsonFile2Database</strong><strong>]</strong> implémente l’interface <strong>[</strong><strong>InterfaceDao4TransferAdminData2Database</strong><strong>]</strong> ;</li>
<li>lignes 15-17 : le constructeur de la classe reçoit en paramètre le dictionnaire de la configuration. Les clés suivantes vont être utilisées :</li>
<li><strong>[</strong><strong>admindataFilename</strong><strong>]</strong> (ligne 27) : le nom du fichier jSON contenant les données de l’administration fiscale à transférer en base ;</li>
<li><strong>[</strong><strong>database</strong><strong>]</strong> ligne 32 : le configuration <strong>[sqlalchemy]</strong> de l’application ;</li>
<li>lignes 34-37 : suppression des tables <strong>[constantes]</strong> et <strong>[tranches]</strong> si elles existent ;</li>
<li>lignes 39-40 : recréation des deux tables ;</li>
<li>ligne 43 : on récupère la session <strong>[sqlalchemy]</strong> présente dans la configuration ;</li>
<li>lignes 45-51 : les tableaux <strong>[limites, coeffr, coeffn]</strong> du dictionnaire <strong>[admindata]</strong> sont mis dans la session. Pour cela on met dans la session des instances de l’entité <strong>[Tranche]</strong> ;</li>
<li>lignes 52-64 : une instance de l’entité <strong>[Constantes]</strong> est mise en session ;</li>
<li>lignes 66-67 : la session est validée. Si les données de la session n’étaient pas encore en base, elles y sont mises à ce moment là ;</li>
<li>lignes 68-70 : gestion d’une éventuelle erreur ;</li>
<li>lignes 71-74 : la session est fermée. On peut le faire car la couche <strong>[dao]</strong> n’est utilisée qu’une fois ;</li>
</ul>
<h3 id="2016-configuration-de-lapplication">20.1.6. Configuration de l’application</h3>
<p><img src="images/1000000000000185000002053F5226B4.png" style="width:4.481cm;height:5.98cm;" alt="Image" /></p>
<p>L’application est configurée par trois fichiers <strong>[1]</strong> :</p>
<ul>
<li><strong>[config]</strong> est le fichier de configuration générale. C’est lui qui configure l’application <strong>[main]</strong>. Il se fait aider par les deux autres fichiers :</li>
<li><strong>[config_database]</strong> que nous avons étudié et qui configure l’ORM <strong>[sqlalchemy]</strong> ;</li>
<li><strong>[config_layers]</strong> qui configure les couches de l’application ;
Le fichier <strong>[config]</strong> est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span>
<span class="normal"><a href="#__codelineno-9-20">20</a></span>
<span class="normal"><a href="#__codelineno-9-21">21</a></span>
<span class="normal"><a href="#__codelineno-9-22">22</a></span>
<span class="normal"><a href="#__codelineno-9-23">23</a></span>
<span class="normal"><a href="#__codelineno-9-24">24</a></span>
<span class="normal"><a href="#__codelineno-9-25">25</a></span>
<span class="normal"><a href="#__codelineno-9-26">26</a></span>
<span class="normal"><a href="#__codelineno-9-27">27</a></span>
<span class="normal"><a href="#__codelineno-9-28">28</a></span>
<span class="normal"><a href="#__codelineno-9-29">29</a></span>
<span class="normal"><a href="#__codelineno-9-30">30</a></span>
<span class="normal"><a href="#__codelineno-9-31">31</a></span>
<span class="normal"><a href="#__codelineno-9-32">32</a></span>
<span class="normal"><a href="#__codelineno-9-33">33</a></span>
<span class="normal"><a href="#__codelineno-9-34">34</a></span>
<span class="normal"><a href="#__codelineno-9-35">35</a></span>
<span class="normal"><a href="#__codelineno-9-36">36</a></span>
<span class="normal"><a href="#__codelineno-9-37">37</a></span>
<span class="normal"><a href="#__codelineno-9-38">38</a></span>
<span class="normal"><a href="#__codelineno-9-39">39</a></span>
<span class="normal"><a href="#__codelineno-9-40">40</a></span>
<span class="normal"><a href="#__codelineno-9-41">41</a></span>
<span class="normal"><a href="#__codelineno-9-42">42</a></span>
<span class="normal"><a href="#__codelineno-9-43">43</a></span>
<span class="normal"><a href="#__codelineno-9-44">44</a></span>
<span class="normal"><a href="#__codelineno-9-45">45</a></span>
<span class="normal"><a href="#__codelineno-9-46">46</a></span>
<span class="normal"><a href="#__codelineno-9-47">47</a></span>
<span class="normal"><a href="#__codelineno-9-48">48</a></span>
<span class="normal"><a href="#__codelineno-9-49">49</a></span>
<span class="normal"><a href="#__codelineno-9-50">50</a></span>
<span class="normal"><a href="#__codelineno-9-51">51</a></span>
<span class="normal"><a href="#__codelineno-9-52">52</a></span>
<span class="normal"><a href="#__codelineno-9-53">53</a></span>
<span class="normal"><a href="#__codelineno-9-54">54</a></span>
<span class="normal"><a href="#__codelineno-9-55">55</a></span>
<span class="normal"><a href="#__codelineno-9-56">56</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>    <span class="c1"># [config] a la clé [sgbd] qui vaut:</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>    <span class="c1"># [mysql] pour gérer une base MySQL</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>    <span class="c1"># [pgres] pour gérer une base PostgreSQL</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a>    <span class="c1"># étape 1 ---</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>    <span class="c1"># on établit le Python Path de l&#39;application</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a>    <span class="c1"># chemin absolu du dossier de ce script</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>    <span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a>    <span class="c1"># root_dir (à changer éventuellement)</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a>    <span class="n">root_dir</span> <span class="o">=</span> <span class="s2">&quot;C:/Data/st-2020/dev/python/cours-2020/python3-flask-2020&quot;</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a>    <span class="c1"># chemins absolus des dépendances</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a>    <span class="n">absolute_dependencies</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a>        <span class="c1"># InterfaceImpôtsDao, InterfaceImpôtsMétier, InterfaceImpôtsUi</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/interfaces&quot;</span><span class="p">,</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a>        <span class="c1"># AbstractImpôtsDao, ImpôtsConsole, ImpôtsMétier</span>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/services&quot;</span><span class="p">,</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a>        <span class="c1"># AdminData, ImpôtsError, TaxPayer</span>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/impots/v04/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a>        <span class="c1"># BaseEntity, MyException</span>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">/classes/02/entities&quot;</span><span class="p">,</span>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a>        <span class="c1"># dossiers locaux</span>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../../interfaces&quot;</span><span class="p">,</span>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../../services&quot;</span><span class="p">,</span>
<a id="__codelineno-9-31" name="__codelineno-9-31"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../../entities&quot;</span><span class="p">,</span>
<a id="__codelineno-9-32" name="__codelineno-9-32"></a>    <span class="p">]</span>
<a id="__codelineno-9-33" name="__codelineno-9-33"></a>
<a id="__codelineno-9-34" name="__codelineno-9-34"></a>    <span class="c1"># on fixe le syspath</span>
<a id="__codelineno-9-35" name="__codelineno-9-35"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">myutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_syspath</span>
<a id="__codelineno-9-36" name="__codelineno-9-36"></a>    <span class="n">set_syspath</span><span class="p">(</span><span class="n">absolute_dependencies</span><span class="p">)</span>
<a id="__codelineno-9-37" name="__codelineno-9-37"></a>
<a id="__codelineno-9-38" name="__codelineno-9-38"></a>    <span class="c1"># étape 2 ------</span>
<a id="__codelineno-9-39" name="__codelineno-9-39"></a>    <span class="c1"># on complète la configuration de l&#39;application</span>
<a id="__codelineno-9-40" name="__codelineno-9-40"></a>    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
<a id="__codelineno-9-41" name="__codelineno-9-41"></a>        <span class="c1"># chemins absolus des fichiers de données</span>
<a id="__codelineno-9-42" name="__codelineno-9-42"></a>        <span class="s2">&quot;admindataFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../../data/input/admindata.json&quot;</span>
<a id="__codelineno-9-43" name="__codelineno-9-43"></a>    <span class="p">})</span>
<a id="__codelineno-9-44" name="__codelineno-9-44"></a>
<a id="__codelineno-9-45" name="__codelineno-9-45"></a>    <span class="c1"># étape 3 ------</span>
<a id="__codelineno-9-46" name="__codelineno-9-46"></a>    <span class="c1"># configuration base de données</span>
<a id="__codelineno-9-47" name="__codelineno-9-47"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config_database</span>
<a id="__codelineno-9-48" name="__codelineno-9-48"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">config_database</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-9-49" name="__codelineno-9-49"></a>
<a id="__codelineno-9-50" name="__codelineno-9-50"></a>    <span class="c1"># étape 4 ------</span>
<a id="__codelineno-9-51" name="__codelineno-9-51"></a>    <span class="c1"># instanciation des couches de l&#39;application</span>
<a id="__codelineno-9-52" name="__codelineno-9-52"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config_layers</span>
<a id="__codelineno-9-53" name="__codelineno-9-53"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">config_layers</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-9-54" name="__codelineno-9-54"></a>
<a id="__codelineno-9-55" name="__codelineno-9-55"></a>    <span class="c1"># on rend la config</span>
<a id="__codelineno-9-56" name="__codelineno-9-56"></a>    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 8-36 : on construit le Python Path de l’application ;</li>
<li>lignes 38-43 : on met dans la configuration le chemin du fichier <strong>[admindata.json]</strong> ;</li>
<li>lignes 45-48 : configuration <strong>[sqlalchemy]</strong> ;</li>
<li>lignes 50-53 : instanciation des couches de l’application ;</li>
<li>ligne 56 : on rend la configuration générale ;
Le fichier <strong>[config_layers]</strong> est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span>
<span class="normal"><a href="#__codelineno-10-3">3</a></span>
<span class="normal"><a href="#__codelineno-10-4">4</a></span>
<span class="normal"><a href="#__codelineno-10-5">5</a></span>
<span class="normal"><a href="#__codelineno-10-6">6</a></span>
<span class="normal"><a href="#__codelineno-10-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>    <span class="c1"># instanciation couche [dao]</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">DaoTransferAdminDataFromJsonFile2Database</span><span class="w"> </span><span class="kn">import</span> <span class="n">DaoTransferAdminDataFromJsonFile2Database</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dao&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DaoTransferAdminDataFromJsonFile2Database</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>    <span class="c1"># on rend la config</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 3-4 : instanciation de la couche <strong>[dao]</strong>. On a vu que le constructeur de la classe <strong>[DaoTransferAdminDataFromJsonFile2Database]</strong> attendait en paramètre le dictionnaire de la configuration générale de l’application ;</li>
<li>ligne 4 : la référence sur la couche <strong>[dao]</strong> est mise dans la configiration ;</li>
<li>ligne 7 : on rend la configuration ;</li>
</ul>
<h3 id="2017-le-script-main-de-lapplication">20.1.7. Le script [main] de l’application</h3>
<p><img src="images/100000000000018E000002054838D98A.png" style="width:4.141cm;height:5.381cm;" alt="Image" /></p>
<p><img src="images/100000010000032E00000215935EB4C2.png" style="width:13.831cm;height:9.051cm;" alt="Image" /></p>
<p>Le script principal <strong>[main]</strong> est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span>
<span class="normal"><a href="#__codelineno-11-31">31</a></span>
<span class="normal"><a href="#__codelineno-11-32">32</a></span>
<span class="normal"><a href="#__codelineno-11-33">33</a></span>
<span class="normal"><a href="#__codelineno-11-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1"># on attend un paramètre mysql ou pgres</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="n">syntaxe</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> mysql / pgres&quot;</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="n">erreur</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>    <span class="n">sgbd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;mysql&quot;</span> <span class="ow">and</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;pgres&quot;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syntaxe : </span><span class="si">{</span><span class="n">syntaxe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s1">&#39;sgbd&#39;</span><span class="p">:</span> <span class="n">sgbd</span><span class="p">})</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="c1"># le syspath est établi - on peut faire les imports</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="c1"># on récupère la couche [dao]</span>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="n">dao</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="c1"># code</span>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a>    <span class="c1"># transfert des données dans la base</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a>    <span class="n">dao</span><span class="o">.</span><span class="n">transfer_admindata_in_database</span><span class="p">()</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a><span class="k">except</span> <span class="n">ImpôtsError</span> <span class="k">as</span> <span class="n">ex1</span><span class="p">:</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a>    <span class="c1"># on affiche l&#39;erreur</span>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur 1 suivante s&#39;est produite : </span><span class="si">{</span><span class="n">ex1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-11-29" name="__codelineno-11-29"></a><span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">ex2</span><span class="p">:</span>
<a id="__codelineno-11-30" name="__codelineno-11-30"></a>    <span class="c1"># on affiche l&#39;erreur</span>
<a id="__codelineno-11-31" name="__codelineno-11-31"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur 2 suivante s&#39;est produite : </span><span class="si">{</span><span class="n">ex2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-11-32" name="__codelineno-11-32"></a><span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-11-33" name="__codelineno-11-33"></a>    <span class="c1"># fin</span>
<a id="__codelineno-11-34" name="__codelineno-11-34"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Terminé...&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 1-10 : on attend un paramètre. On vérifie qu’il est là et correct ;</li>
<li>lignes 12-14 : on configure l’application (générale, sqlalchemy, couches) en passant en paramètre le type de SGBD choisi ;</li>
<li>lignes 19-20 : on va avoir besoin de la couche <strong>[dao]</strong>. On la récupère ;</li>
<li>ligne 25 : on fait le transfert en base. Toutes les informations nécessaires à la méthode <strong>[</strong><strong>transfer_admindata_in_database</strong><strong>]</strong> sont disponibles dans les propriétés de la couche <strong>[dao]</strong> de la ligne 20. C’est là qu’elle ira les chercher ;
Après exécution avec la base MySQL, celle-ci contient les éléments suivants (phpMyAdmin) :</li>
</ul>
<p><img src="images/10000000000002560000042A6C088693.png" style="width:6.901cm;height:12.3cm;" alt="Image" /></p>
<p><img src="images/10000001000003FC000001280C474C2E.png" style="width:17.521cm;height:5.081cm;" alt="Image" /></p>
<p><img src="images/1000000100000239000001CAA30A3175.png" style="width:9.61cm;height:7.73cm;" alt="Image" /></p>
<p>Colonne <strong>[3]</strong>, on voit les valeurs attribuées par MySQL à la clé primaire <strong>[id]</strong>. La numérotation démarre à 1. La copie d’écran ci-dessus a été obtenue après plusieurs exécutions du script.</p>
<p><img src="images/10000001000003FA000001298C303263.png" style="width:17.511cm;height:5.1cm;" alt="Image" /></p>
<p><img src="images/100000010000039200000123B9CBAF12.png" style="width:15.47cm;height:4.92cm;" alt="Image" /></p>
<p>Avec la base PostgreSQL les résultats sont les suivants :</p>
<p><img src="images/10000001000003DF0000016937D5EBBA.png" style="width:16.44cm;height:5.98cm;" alt="Image" /></p>
<ul>
<li>on clique droit sur <strong>[1]</strong>, puis ensuite <strong>[2-3]</strong> ;</li>
<li>en <strong>[4]</strong>, on a bien les données des tranches d’impôts ;
On refait la même chose pour la table des constantes <strong>[tbconstantes]</strong> :</li>
</ul>
<p><img src="images/100000010000030C000000FE916880AF.png" style="width:13.151cm;height:4.28cm;" alt="Image" /></p>
<p><img src="images/10000001000002F8000000FEB93CE4B7.png" style="width:13.131cm;height:4.381cm;" alt="Image" /></p>
<p><img src="images/100000010000031F000000FC161A736A.png" style="width:13.821cm;height:4.351cm;" alt="Image" /></p>
<h2 id="202-application-2-calcul-de-limpot-en-mode-batch">20.2. Application 2 : calcul de l’impôt en mode batch</h2>
<p><img src="images/10000000000001850000023E1A30A3E3.png" style="width:4.492cm;height:6.621cm;" alt="Image" /></p>
<h3 id="2021-architecture">20.2.1. Architecture</h3>
<p>L’application de calcul de l’impôt de la version 4 utilisait l&#x27;architecture suivante :</p>
<p><img src="images/1000000100000257000000DA58BEF0ED.png" style="width:10.12cm;height:3.68cm;" alt="Image" /></p>
<p>La couche <strong>[</strong><strong>dao</strong><strong>]</strong> implémente une interface <strong>[</strong><strong>InterfaceImpôtsDao</strong><strong>]</strong>. Nous avons construit une classe implémentant cette interface :</p>
<ul>
<li><strong>[</strong><strong>Imp</strong><strong>ôtsDaoWithAdminDataInJsonFile</strong><strong>]</strong> qui allait chercher les données fiscales dans un fichier jSON. C’était la version 3 ;
Nous allons implémenter l’interface <strong>[</strong><strong>InterfaceImpôtsDao</strong><strong>]</strong> par une nouvelle classe <strong>[</strong><strong>ImpotsDaoWithTaxAdminDataInDatabase</strong><strong>]</strong> qui ira chercher les données de l’administration fiscale dans une base de données. La couche <strong>[</strong><strong>dao</strong><strong>]</strong>, comme précédemment, écrira les résultats dans un fichier jSON et trouvera les données des contribuables dans un fichier texte. Nous savons que si nous continuons à respecter l’interface <strong>[InterfaceImpôtsDao]</strong>, la couche <strong>[</strong><strong>métier</strong><strong>]</strong> n’aura pas à être modifiée.</li>
</ul>
<p>La nouvelle architecture sera la suivante :</p>
<p><img src="images/10000000000003B5000002BD8D4E698A.png" style="width:10.951cm;height:8.09cm;" alt="Image" /></p>
<h3 id="2022-configuration-de-lapplication">20.2.2. Configuration de l’application</h3>
<p><img src="images/100000000000019500000206ACE6D19A.png" style="width:4.201cm;height:5.381cm;" alt="Image" /></p>
<p>Le fichier de configuration <strong>[config_database]</strong> reste ce qu’il était dans l’application 1. La configuration <strong>[config]</strong> intègre des éléments nouveaux :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span>
<span class="normal"><a href="#__codelineno-12-2">2</a></span>
<span class="normal"><a href="#__codelineno-12-3">3</a></span>
<span class="normal"><a href="#__codelineno-12-4">4</a></span>
<span class="normal"><a href="#__codelineno-12-5">5</a></span>
<span class="normal"><a href="#__codelineno-12-6">6</a></span>
<span class="normal"><a href="#__codelineno-12-7">7</a></span>
<span class="normal"><a href="#__codelineno-12-8">8</a></span>
<span class="normal"><a href="#__codelineno-12-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a>    <span class="c1"># étape 2 ------</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>    <span class="c1"># on complète la configuration de l&#39;application</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a>    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a>        <span class="c1"># chemins absolus des fichiers de données</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>        <span class="s2">&quot;admindataFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../../data/input/admindata.json&quot;</span><span class="p">,</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a>        <span class="s2">&quot;taxpayersFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../../data/input/taxpayersdata.txt&quot;</span><span class="p">,</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a>        <span class="s2">&quot;errorsFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../../data/output/errors.txt&quot;</span><span class="p">,</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a>        <span class="s2">&quot;resultsFilename&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">script_dir</span><span class="si">}</span><span class="s2">/../../data/output/résultats.json&quot;</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a>    <span class="p">})</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 6-8 : les chemins absolus des fichiers texte utilisés par l’application 2 ;
La configuration des couches <strong>[config_layers]</strong> évolue de la façon suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a>    <span class="c1"># instanciation couche dao</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">ImpotsDaoWithAdminDataInDatabase</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpotsDaoWithAdminDataInDatabase</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImpotsDaoWithAdminDataInDatabase</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a>    <span class="c1"># instanciation couche [métier]</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsMétier</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsMétier</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;métier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImpôtsMétier</span><span class="p">()</span>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a>    <span class="c1"># on rend la config</span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a>    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 3-4 : la couche <strong>[dao]</strong> est désormais implémentée par la classe <strong>[ImpotsDaoWithAdminDataInDatabase]</strong>. Cette classe est nouvelle mais implémente la même interface <strong>[InterfaceDao]</strong> que la <a href="#_L'interface_[InterfaceImpôtsDao]"><u><u>version 4 de l’exercice d’application</u></u></a> ;</li>
<li>lignes 7-8 : la couche <strong>[métier]</strong> est implémentée par la classe <strong>[ImpôtsMétier]</strong>. C’est la classe utilisée dans la version 4 de l’exercice d’application ;</li>
</ul>
<h3 id="2023-la-couche-dao">20.2.3. La couche [dao]</h3>
<p>La classe d&#x27;implémentation <strong>[</strong><strong>ImpotsDaoWithAdminDataInDatabase</strong><strong>]</strong> de l&#x27;interface <strong>[</strong><strong>InterfaceImpôtsDao</strong><strong>]</strong> sera la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span>
<span class="normal"><a href="#__codelineno-14-18">18</a></span>
<span class="normal"><a href="#__codelineno-14-19">19</a></span>
<span class="normal"><a href="#__codelineno-14-20">20</a></span>
<span class="normal"><a href="#__codelineno-14-21">21</a></span>
<span class="normal"><a href="#__codelineno-14-22">22</a></span>
<span class="normal"><a href="#__codelineno-14-23">23</a></span>
<span class="normal"><a href="#__codelineno-14-24">24</a></span>
<span class="normal"><a href="#__codelineno-14-25">25</a></span>
<span class="normal"><a href="#__codelineno-14-26">26</a></span>
<span class="normal"><a href="#__codelineno-14-27">27</a></span>
<span class="normal"><a href="#__codelineno-14-28">28</a></span>
<span class="normal"><a href="#__codelineno-14-29">29</a></span>
<span class="normal"><a href="#__codelineno-14-30">30</a></span>
<span class="normal"><a href="#__codelineno-14-31">31</a></span>
<span class="normal"><a href="#__codelineno-14-32">32</a></span>
<span class="normal"><a href="#__codelineno-14-33">33</a></span>
<span class="normal"><a href="#__codelineno-14-34">34</a></span>
<span class="normal"><a href="#__codelineno-14-35">35</a></span>
<span class="normal"><a href="#__codelineno-14-36">36</a></span>
<span class="normal"><a href="#__codelineno-14-37">37</a></span>
<span class="normal"><a href="#__codelineno-14-38">38</a></span>
<span class="normal"><a href="#__codelineno-14-39">39</a></span>
<span class="normal"><a href="#__codelineno-14-40">40</a></span>
<span class="normal"><a href="#__codelineno-14-41">41</a></span>
<span class="normal"><a href="#__codelineno-14-42">42</a></span>
<span class="normal"><a href="#__codelineno-14-43">43</a></span>
<span class="normal"><a href="#__codelineno-14-44">44</a></span>
<span class="normal"><a href="#__codelineno-14-45">45</a></span>
<span class="normal"><a href="#__codelineno-14-46">46</a></span>
<span class="normal"><a href="#__codelineno-14-47">47</a></span>
<span class="normal"><a href="#__codelineno-14-48">48</a></span>
<span class="normal"><a href="#__codelineno-14-49">49</a></span>
<span class="normal"><a href="#__codelineno-14-50">50</a></span>
<span class="normal"><a href="#__codelineno-14-51">51</a></span>
<span class="normal"><a href="#__codelineno-14-52">52</a></span>
<span class="normal"><a href="#__codelineno-14-53">53</a></span>
<span class="normal"><a href="#__codelineno-14-54">54</a></span>
<span class="normal"><a href="#__codelineno-14-55">55</a></span>
<span class="normal"><a href="#__codelineno-14-56">56</a></span>
<span class="normal"><a href="#__codelineno-14-57">57</a></span>
<span class="normal"><a href="#__codelineno-14-58">58</a></span>
<span class="normal"><a href="#__codelineno-14-59">59</a></span>
<span class="normal"><a href="#__codelineno-14-60">60</a></span>
<span class="normal"><a href="#__codelineno-14-61">61</a></span>
<span class="normal"><a href="#__codelineno-14-62">62</a></span>
<span class="normal"><a href="#__codelineno-14-63">63</a></span>
<span class="normal"><a href="#__codelineno-14-64">64</a></span>
<span class="normal"><a href="#__codelineno-14-65">65</a></span>
<span class="normal"><a href="#__codelineno-14-66">66</a></span>
<span class="normal"><a href="#__codelineno-14-67">67</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="c1"># imports</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.exc</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">IntegrityError</span><span class="p">,</span> <span class="n">InterfaceError</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">AbstractImpôtsDao</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbstractImpôtsDao</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">AdminData</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdminData</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Constantes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Constantes</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">Tranche</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tranche</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">ImpotsDaoWithAdminDataInDatabase</span><span class="p">(</span><span class="n">AbstractImpôtsDao</span><span class="p">):</span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a>    <span class="c1"># constructeur</span>
<a id="__codelineno-14-13" name="__codelineno-14-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-14-14" name="__codelineno-14-14"></a>        <span class="c1"># config[&quot;taxPayersFilename&quot;] : le nom du fichier texte des contribuables</span>
<a id="__codelineno-14-15" name="__codelineno-14-15"></a>        <span class="c1"># config[&quot;taxPayersResultsFilename&quot;] : le nom du fichier jSON des résultats</span>
<a id="__codelineno-14-16" name="__codelineno-14-16"></a>        <span class="c1"># config[&quot;errorsFilename&quot;] : enregistre les erreurs trouvées dans taxPayersFilename</span>
<a id="__codelineno-14-17" name="__codelineno-14-17"></a>        <span class="c1"># config[&quot;database&quot;] : configuration de la base de données</span>
<a id="__codelineno-14-18" name="__codelineno-14-18"></a>
<a id="__codelineno-14-19" name="__codelineno-14-19"></a>        <span class="c1"># initialisation de la classe Parent</span>
<a id="__codelineno-14-20" name="__codelineno-14-20"></a>        <span class="n">AbstractImpôtsDao</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-14-21" name="__codelineno-14-21"></a>        <span class="c1"># mémorisation paramètre</span>
<a id="__codelineno-14-22" name="__codelineno-14-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-14-23" name="__codelineno-14-23"></a>        <span class="c1"># admindata</span>
<a id="__codelineno-14-24" name="__codelineno-14-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__admindata</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-14-25" name="__codelineno-14-25"></a>
<a id="__codelineno-14-26" name="__codelineno-14-26"></a>    <span class="c1"># implémentation de l&#39;interface</span>
<a id="__codelineno-14-27" name="__codelineno-14-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_admindata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-14-28" name="__codelineno-14-28"></a>        <span class="c1"># admindata a-t-il été mémorisé ?</span>
<a id="__codelineno-14-29" name="__codelineno-14-29"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__admindata</span><span class="p">:</span>
<a id="__codelineno-14-30" name="__codelineno-14-30"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__admindata</span>
<a id="__codelineno-14-31" name="__codelineno-14-31"></a>        <span class="c1"># on fait une requête en BD</span>
<a id="__codelineno-14-32" name="__codelineno-14-32"></a>        <span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-14-33" name="__codelineno-14-33"></a>        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__config</span>
<a id="__codelineno-14-34" name="__codelineno-14-34"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-14-35" name="__codelineno-14-35"></a>            <span class="c1"># une session</span>
<a id="__codelineno-14-36" name="__codelineno-14-36"></a>            <span class="n">database_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;database&quot;</span><span class="p">]</span>
<a id="__codelineno-14-37" name="__codelineno-14-37"></a>            <span class="n">session</span> <span class="o">=</span> <span class="n">database_config</span><span class="p">[</span><span class="s2">&quot;session&quot;</span><span class="p">]</span>
<a id="__codelineno-14-38" name="__codelineno-14-38"></a>
<a id="__codelineno-14-39" name="__codelineno-14-39"></a>            <span class="c1"># on lit la table des tranches de l&#39;impôt</span>
<a id="__codelineno-14-40" name="__codelineno-14-40"></a>            <span class="n">tranches</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Tranche</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-14-41" name="__codelineno-14-41"></a>
<a id="__codelineno-14-42" name="__codelineno-14-42"></a>            <span class="c1"># on lit la table des constantes (1 seule ligne)</span>
<a id="__codelineno-14-43" name="__codelineno-14-43"></a>            <span class="n">constantes</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Constantes</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a id="__codelineno-14-44" name="__codelineno-14-44"></a>
<a id="__codelineno-14-45" name="__codelineno-14-45"></a>            <span class="c1"># on crée l&#39;instance admindata</span>
<a id="__codelineno-14-46" name="__codelineno-14-46"></a>            <span class="n">admindata</span> <span class="o">=</span> <span class="n">AdminData</span><span class="p">()</span>
<a id="__codelineno-14-47" name="__codelineno-14-47"></a>            <span class="c1"># on y crée les tableaux limtes, coeffR, coeffN</span>
<a id="__codelineno-14-48" name="__codelineno-14-48"></a>            <span class="n">limites</span> <span class="o">=</span> <span class="n">admindata</span><span class="o">.</span><span class="n">limites</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-14-49" name="__codelineno-14-49"></a>            <span class="n">coeffr</span> <span class="o">=</span> <span class="n">admindata</span><span class="o">.</span><span class="n">coeffr</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-14-50" name="__codelineno-14-50"></a>            <span class="n">coeffn</span> <span class="o">=</span> <span class="n">admindata</span><span class="o">.</span><span class="n">coeffn</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-14-51" name="__codelineno-14-51"></a>            <span class="k">for</span> <span class="n">tranche</span> <span class="ow">in</span> <span class="n">tranches</span><span class="p">:</span>
<a id="__codelineno-14-52" name="__codelineno-14-52"></a>                <span class="n">limites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tranche</span><span class="o">.</span><span class="n">limite</span><span class="p">))</span>
<a id="__codelineno-14-53" name="__codelineno-14-53"></a>                <span class="n">coeffr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tranche</span><span class="o">.</span><span class="n">coeffr</span><span class="p">))</span>
<a id="__codelineno-14-54" name="__codelineno-14-54"></a>                <span class="n">coeffn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tranche</span><span class="o">.</span><span class="n">coeffn</span><span class="p">))</span>
<a id="__codelineno-14-55" name="__codelineno-14-55"></a>            <span class="c1"># on y rajoute les constantes</span>
<a id="__codelineno-14-56" name="__codelineno-14-56"></a>            <span class="n">admindata</span><span class="o">.</span><span class="n">fromdict</span><span class="p">(</span><span class="n">constantes</span><span class="o">.</span><span class="n">asdict</span><span class="p">())</span>
<a id="__codelineno-14-57" name="__codelineno-14-57"></a>            <span class="c1"># on mémorise admindata</span>
<a id="__codelineno-14-58" name="__codelineno-14-58"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">__admindata</span> <span class="o">=</span> <span class="n">admindata</span>
<a id="__codelineno-14-59" name="__codelineno-14-59"></a>            <span class="c1"># on rend la valeur</span>
<a id="__codelineno-14-60" name="__codelineno-14-60"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__admindata</span>
<a id="__codelineno-14-61" name="__codelineno-14-61"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">InterfaceError</span><span class="p">)</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-14-62" name="__codelineno-14-62"></a>            <span class="c1"># on relance l&#39;exception sous une autre forme</span>
<a id="__codelineno-14-63" name="__codelineno-14-63"></a>            <span class="k">raise</span> <span class="n">ImpôtsError</span><span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-14-64" name="__codelineno-14-64"></a>        <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-14-65" name="__codelineno-14-65"></a>            <span class="c1"># on ferme la session</span>
<a id="__codelineno-14-66" name="__codelineno-14-66"></a>            <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
<a id="__codelineno-14-67" name="__codelineno-14-67"></a>                <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p><strong>Notes</strong></p>
<ul>
<li>ligne 11 : la classe <strong>[</strong><strong>ImpotsDaoWithAdminDataInDatabase</strong><strong>]</strong> hérite de la classe [<a href="#_La_classe_[AbstractImpôtsDao]"><u><u>AbstractImpôtsDao</u></u></a>] présentée dans la version 4. On sait que cette dernière implémente l’interface [<a href="#_L'interface_[InterfaceImpôtsDao]"><u><u>InterfaceDao</u></u></a>] présentée dans cette même version. C’est le respect de cette interface qui nous permet de ne pas changer la couche <strong>[métier]</strong> ;</li>
<li>ligne 13 : le constructeur de la classe reçoit en paramètre le dictionnaire de la configuration de l’application ;</li>
<li>ligne 20 : la classe parent <strong>[]</strong> est initialisée. Elle implémente partiellement l’interface <strong>[InterfaceDao]</strong> :</li>
<li><strong>[get_taxpayers_data]</strong> lit le fichier <strong>[taxpayersdata.txt]</strong> qui contient les données des contribuables ;</li>
<li><strong>[write_taxpayers_results]</strong> écrit les résultats dans le fichier jSON <strong>[résultats.json]</strong> ;</li>
<li><strong>[get_admindata]</strong> n’est pas implémentée ;</li>
<li>ligne 22 : on mémorise la configuration passée en paramètres ;</li>
<li>ligne 27 : implémentation de la méthode <strong>[get_admindata]</strong> de l’interface <strong>[InterfaceDao]</strong> :</li>
<li>lignes 28-30 : la méthode <strong>[get_admindata]</strong> récupère les données de l’administration fiscale dans un objet de type <strong>[AdminData]</strong> et mémorise cet objet dans <strong>[self.__admindata]</strong>. Si la méthode <strong>[get_admindata]</strong> est appelée plusieurs fois, on n’interroge pas la base de données plusieurs fois. On l’interroge seulement la première fois. Les fois suivantes, on rend l’objet <strong>[self.__admindata]</strong> ;</li>
<li>lignes 36-37 : on récupère la session <strong>[sqlalchemy]</strong> qui a été créée lors de la configuration de l’application par <strong>[config_database]</strong> ;</li>
<li>lignes 40 : on récupère les tranches de l’impôt dans une liste ;</li>
<li>lignes 43 : on récupère les constantes du calcul de l’impôt ;</li>
<li>ligne 46 : on crée une instance de la classe [<a href="#_La_classe_[AdminData]"><u><u>AdminData</u></u></a>]. On rappelle qu’elle dérive de <strong>[BaseEntity]</strong> ;</li>
<li>lignes 48-54 : on initialise les tableaux <strong>[limites, coeffr, coeffn]</strong> de l’instance <strong>[AdminData]</strong> ;</li>
<li>lignes 55-56 : on initialise les autres propriétés de <strong>[AdminData]</strong> avec les constantes du calcul de l’impôt. On avait pris soin de donner les mêmes noms aux propriétés des classes <strong>[AdminData]</strong> et <strong>[Constantes]</strong>, ce qui simplifie le code ;</li>
<li>lignes 57-58 : l’instance <strong>[AdminData]</strong> est mémorisée dans la couche <strong>[dao]</strong> pour la rendre lors des prochains appels à la méthode <strong>[</strong><strong>get_admindata</strong><strong>]</strong> ;</li>
<li>ligne 60 : on rend la valeur demandée par le code appelant ;</li>
<li>lignes 61-63 : gestion d’une éventuelle erreur ;</li>
<li>lignes 64-67 : la base de données ne fait l’objet que d’une unique requête. On peut donc fermer la session <strong>[sqlalchemy]</strong> ;</li>
</ul>
<h3 id="2024-test-de-la-couche-dao">20.2.4. Test de la couche [dao]</h3>
<p>Dans la version 4 de cette application, nous avions construit une <a href="#_Tests_des_couches"><u><u>classe de test</u></u></a> de la couche <strong>[métier]</strong>. Plus exactement, elle testait à la fois les couches <strong>[métier]</strong> et <strong>[dao]</strong>. Nous reprenons ce test pour vérifier que la couche <strong>[dao]</strong> fonctionne comme attendu. En effet, la couche <strong>[métier]</strong> elle ne change pas.</p>
<p><img src="images/100000000000017E000001A74483DEE4.png" style="width:3.98cm;height:4.4cm;" alt="Image" /></p>
<p><img src="images/100000000000047B00000345B54A307A.png" style="width:13.251cm;height:9.67cm;" alt="Image" /></p>
<p>Le test <strong>[TestDaoMétier]</strong> est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span>
<span class="normal"><a href="#__codelineno-15-18">18</a></span>
<span class="normal"><a href="#__codelineno-15-19">19</a></span>
<span class="normal"><a href="#__codelineno-15-20">20</a></span>
<span class="normal"><a href="#__codelineno-15-21">21</a></span>
<span class="normal"><a href="#__codelineno-15-22">22</a></span>
<span class="normal"><a href="#__codelineno-15-23">23</a></span>
<span class="normal"><a href="#__codelineno-15-24">24</a></span>
<span class="normal"><a href="#__codelineno-15-25">25</a></span>
<span class="normal"><a href="#__codelineno-15-26">26</a></span>
<span class="normal"><a href="#__codelineno-15-27">27</a></span>
<span class="normal"><a href="#__codelineno-15-28">28</a></span>
<span class="normal"><a href="#__codelineno-15-29">29</a></span>
<span class="normal"><a href="#__codelineno-15-30">30</a></span>
<span class="normal"><a href="#__codelineno-15-31">31</a></span>
<span class="normal"><a href="#__codelineno-15-32">32</a></span>
<span class="normal"><a href="#__codelineno-15-33">33</a></span>
<span class="normal"><a href="#__codelineno-15-34">34</a></span>
<span class="normal"><a href="#__codelineno-15-35">35</a></span>
<span class="normal"><a href="#__codelineno-15-36">36</a></span>
<span class="normal"><a href="#__codelineno-15-37">37</a></span>
<span class="normal"><a href="#__codelineno-15-38">38</a></span>
<span class="normal"><a href="#__codelineno-15-39">39</a></span>
<span class="normal"><a href="#__codelineno-15-40">40</a></span>
<span class="normal"><a href="#__codelineno-15-41">41</a></span>
<span class="normal"><a href="#__codelineno-15-42">42</a></span>
<span class="normal"><a href="#__codelineno-15-43">43</a></span>
<span class="normal"><a href="#__codelineno-15-44">44</a></span>
<span class="normal"><a href="#__codelineno-15-45">45</a></span>
<span class="normal"><a href="#__codelineno-15-46">46</a></span>
<span class="normal"><a href="#__codelineno-15-47">47</a></span>
<span class="normal"><a href="#__codelineno-15-48">48</a></span>
<span class="normal"><a href="#__codelineno-15-49">49</a></span>
<span class="normal"><a href="#__codelineno-15-50">50</a></span>
<span class="normal"><a href="#__codelineno-15-51">51</a></span>
<span class="normal"><a href="#__codelineno-15-52">52</a></span>
<span class="normal"><a href="#__codelineno-15-53">53</a></span>
<span class="normal"><a href="#__codelineno-15-54">54</a></span>
<span class="normal"><a href="#__codelineno-15-55">55</a></span>
<span class="normal"><a href="#__codelineno-15-56">56</a></span>
<span class="normal"><a href="#__codelineno-15-57">57</a></span>
<span class="normal"><a href="#__codelineno-15-58">58</a></span>
<span class="normal"><a href="#__codelineno-15-59">59</a></span>
<span class="normal"><a href="#__codelineno-15-60">60</a></span>
<span class="normal"><a href="#__codelineno-15-61">61</a></span>
<span class="normal"><a href="#__codelineno-15-62">62</a></span>
<span class="normal"><a href="#__codelineno-15-63">63</a></span>
<span class="normal"><a href="#__codelineno-15-64">64</a></span>
<span class="normal"><a href="#__codelineno-15-65">65</a></span>
<span class="normal"><a href="#__codelineno-15-66">66</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">unittest</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestDaoMétier</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">TaxPayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaxPayer</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a>        <span class="c1"># {&#39;marié&#39;: &#39;oui&#39;, &#39;enfants&#39;: 2, &#39;salaire&#39;: 55555,</span>
<a id="__codelineno-15-10" name="__codelineno-15-10"></a>        <span class="c1"># &#39;impôt&#39;: 2814, &#39;surcôte&#39;: 0, &#39;décôte&#39;: 0, &#39;réduction&#39;: 0, &#39;taux&#39;: 0.14}</span>
<a id="__codelineno-15-11" name="__codelineno-15-11"></a>        <span class="n">taxpayer</span> <span class="o">=</span> <span class="n">TaxPayer</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s2">&quot;marié&quot;</span><span class="p">:</span> <span class="s2">&quot;oui&quot;</span><span class="p">,</span> <span class="s2">&quot;enfants&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;salaire&quot;</span><span class="p">:</span> <span class="mi">55555</span><span class="p">})</span>
<a id="__codelineno-15-12" name="__codelineno-15-12"></a>        <span class="n">métier</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">taxpayer</span><span class="p">,</span> <span class="n">admindata</span><span class="p">)</span>
<a id="__codelineno-15-13" name="__codelineno-15-13"></a>        <span class="c1"># vérification</span>
<a id="__codelineno-15-14" name="__codelineno-15-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">impôt</span><span class="p">,</span> <span class="mi">2815</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-15-15" name="__codelineno-15-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">décôte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-15-16" name="__codelineno-15-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">réduction</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-15-17" name="__codelineno-15-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">taux</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<a id="__codelineno-15-18" name="__codelineno-15-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">surcôte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-15-19" name="__codelineno-15-19"></a>
<a id="__codelineno-15-20" name="__codelineno-15-20"></a>    <span class="err">…</span>
<a id="__codelineno-15-21" name="__codelineno-15-21"></a>
<a id="__codelineno-15-22" name="__codelineno-15-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_11</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-15-23" name="__codelineno-15-23"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">TaxPayer</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaxPayer</span>
<a id="__codelineno-15-24" name="__codelineno-15-24"></a>
<a id="__codelineno-15-25" name="__codelineno-15-25"></a>        <span class="c1"># {&#39;marié&#39;: &#39;oui&#39;, &#39;enfants&#39;: 3, &#39;salaire&#39;: 200000,</span>
<a id="__codelineno-15-26" name="__codelineno-15-26"></a>        <span class="c1"># &#39;impôt&#39;: 42842, &#39;surcôte&#39;: 17283, &#39;décôte&#39;: 0, &#39;réduction&#39;: 0, &#39;taux&#39;: 0.41}</span>
<a id="__codelineno-15-27" name="__codelineno-15-27"></a>        <span class="n">taxpayer</span> <span class="o">=</span> <span class="n">TaxPayer</span><span class="p">()</span><span class="o">.</span><span class="n">fromdict</span><span class="p">({</span><span class="s1">&#39;marié&#39;</span><span class="p">:</span> <span class="s1">&#39;oui&#39;</span><span class="p">,</span> <span class="s1">&#39;enfants&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;salaire&#39;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">})</span>
<a id="__codelineno-15-28" name="__codelineno-15-28"></a>        <span class="n">métier</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">taxpayer</span><span class="p">,</span> <span class="n">admindata</span><span class="p">)</span>
<a id="__codelineno-15-29" name="__codelineno-15-29"></a>        <span class="c1"># vérifications</span>
<a id="__codelineno-15-30" name="__codelineno-15-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">impôt</span><span class="p">,</span> <span class="mi">42842</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-15-31" name="__codelineno-15-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">décôte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-15-32" name="__codelineno-15-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">réduction</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-15-33" name="__codelineno-15-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">taux</span><span class="p">,</span> <span class="mf">0.41</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<a id="__codelineno-15-34" name="__codelineno-15-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">taxpayer</span><span class="o">.</span><span class="n">surcôte</span><span class="p">,</span> <span class="mi">17283</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-15-35" name="__codelineno-15-35"></a>
<a id="__codelineno-15-36" name="__codelineno-15-36"></a>
<a id="__codelineno-15-37" name="__codelineno-15-37"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-15-38" name="__codelineno-15-38"></a>    <span class="c1"># on attend un paramètre mysql ou pgres</span>
<a id="__codelineno-15-39" name="__codelineno-15-39"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-15-40" name="__codelineno-15-40"></a>    <span class="n">syntaxe</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> mysql / pgres&quot;</span>
<a id="__codelineno-15-41" name="__codelineno-15-41"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
<a id="__codelineno-15-42" name="__codelineno-15-42"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-15-43" name="__codelineno-15-43"></a>        <span class="n">sgbd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-15-44" name="__codelineno-15-44"></a>        <span class="n">erreur</span> <span class="o">=</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;mysql&quot;</span> <span class="ow">and</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;pgres&quot;</span>
<a id="__codelineno-15-45" name="__codelineno-15-45"></a>    <span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-15-46" name="__codelineno-15-46"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syntaxe : </span><span class="si">{</span><span class="n">syntaxe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-15-47" name="__codelineno-15-47"></a>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<a id="__codelineno-15-48" name="__codelineno-15-48"></a>
<a id="__codelineno-15-49" name="__codelineno-15-49"></a>    <span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-15-50" name="__codelineno-15-50"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-15-51" name="__codelineno-15-51"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s1">&#39;sgbd&#39;</span><span class="p">:</span> <span class="n">sgbd</span><span class="p">})</span>
<a id="__codelineno-15-52" name="__codelineno-15-52"></a>    <span class="c1"># couche métier</span>
<a id="__codelineno-15-53" name="__codelineno-15-53"></a>    <span class="n">métier</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;métier&#39;</span><span class="p">]</span>
<a id="__codelineno-15-54" name="__codelineno-15-54"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-15-55" name="__codelineno-15-55"></a>        <span class="c1"># admindata</span>
<a id="__codelineno-15-56" name="__codelineno-15-56"></a>        <span class="n">admindata</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dao&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_admindata</span><span class="p">()</span>
<a id="__codelineno-15-57" name="__codelineno-15-57"></a>    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
<a id="__codelineno-15-58" name="__codelineno-15-58"></a>        <span class="c1"># affichage</span>
<a id="__codelineno-15-59" name="__codelineno-15-59"></a>        <span class="nb">print</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
<a id="__codelineno-15-60" name="__codelineno-15-60"></a>        <span class="c1"># fin</span>
<a id="__codelineno-15-61" name="__codelineno-15-61"></a>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<a id="__codelineno-15-62" name="__codelineno-15-62"></a>    <span class="c1"># on enève le paramètre reçu par le script</span>
<a id="__codelineno-15-63" name="__codelineno-15-63"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<a id="__codelineno-15-64" name="__codelineno-15-64"></a>    <span class="c1"># on exécute les méthodes de test</span>
<a id="__codelineno-15-65" name="__codelineno-15-65"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tests en cours...&quot;</span><span class="p">)</span>
<a id="__codelineno-15-66" name="__codelineno-15-66"></a>   <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>nous ne revenons pas sur les 11 tests décrits au paragraphe |<a href="#_Tests_des_couches"><u><u>test couche </u><u><strong>[métier]</strong></u><u> version 4</u></u></a>| ;</li>
<li>lignes 37-66 : nous allons exécuter le script des tests comme une application normale et non pas comme un test UnitTest. C’est la ligne66qui fera intervenir le framework UnitTest. Dans les tests précédents, nous utilisions la méthode <strong>[setUp]</strong> pour configurer l’exécution de chaque test. On refaisait 11 fois la même configuration puisque la fonction <strong>[setUp]</strong> est exécutée avant chaque test. Ici, nous faisons la configuration 1 fois. Elle consiste à définir des variables globales <strong>[métier]</strong> ligne 53, <strong>[admindata]</strong> ligne 56 qui seront ensuite utilisées par les méthodes de <strong>[TestDaoMétier]</strong>, ligne 12 par exemple ;</li>
<li>lignes 39-47 : le script de test attend un paramètre <strong>[mysql / pgres]</strong> qui indique si on utilise une base MySQL ou PostgreSQL ;</li>
<li>lignes 50-51 : le test est configuré ;</li>
<li>ligne 53 : on récupère la couche <strong>[métier]</strong> dans la configuration ;</li>
<li>ligne 56 : on fait de même avec la couche <strong>[dao]</strong>. On récupère alors l’instance <strong>[admindata]</strong> qui encapsule les données nécessaires au calcul de l’impôt ;</li>
<li>les tests ont montré que la méthode <strong>[unittest</strong><strong>.</strong><strong>main</strong><strong>()</strong><strong>]</strong> de la ligne 66 n’ignorait pas le paramètre <strong>[mysql / pgres]</strong> reçu par le script mais lui donnait une signification autre. La ligne 63 fait en sorte que cette méthode n’ait plus aucun paramètre ;
Nous créons deux <a href="#_Le_script_principal_2"><u><u>configurations d’exécution</u></u></a> :</li>
</ul>
<p><img src="images/1000000000000517000002697CC32661.png" style="width:15.031cm;height:7.111cm;" alt="Image" /></p>
<p><img src="images/1000000000000513000002406E8B8A1E.png" style="width:15.011cm;height:6.651cm;" alt="Image" /></p>
<p>Si nous exécutons l’une de ces deux configurations, nous obtenons les résultats suivants :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span>
<span class="normal"><a href="#__codelineno-16-3">3</a></span>
<span class="normal"><a href="#__codelineno-16-4">4</a></span>
<span class="normal"><a href="#__codelineno-16-5">5</a></span>
<span class="normal"><a href="#__codelineno-16-6">6</a></span>
<span class="normal"><a href="#__codelineno-16-7">7</a></span>
<span class="normal"><a href="#__codelineno-16-8">8</a></span>
<span class="normal"><a href="#__codelineno-16-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="n">C</span><span class="p">:</span>\<span class="n">Data</span>\<span class="n">st</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">dev</span>\<span class="n">python</span>\<span class="n">cours</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span>\<span class="n">venv</span>\<span class="n">Scripts</span>\<span class="n">python</span><span class="o">.</span><span class="n">exe</span> <span class="n">C</span><span class="p">:</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">st</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">cours</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">python3</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="mi">2020</span><span class="o">/</span><span class="n">impots</span><span class="o">/</span><span class="n">v05</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">TestDaoMétier</span><span class="o">.</span><span class="n">py</span> <span class="n">mysql</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="n">tests</span> <span class="n">en</span> <span class="n">cours</span><span class="o">...</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="o">...........</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="o">----------------------------------------------------------------------</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="n">Ran</span> <span class="mi">11</span> <span class="n">tests</span> <span class="ow">in</span> <span class="mf">0.001</span><span class="n">s</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="n">OK</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="n">Process</span> <span class="n">finished</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">code</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 5 et 7 : les 11 tests ont été réussis ;
Rappelons que ces tests ne vérifient que 11 cas du calcul de l’impôt. Leur réussite peut néanmoins suffire pour nous donner confiance dans la couche <strong>[dao]</strong>.</li>
</ul>
<h3 id="2025-le-script-principal">20.2.5. Le script principal</h3>
<p><img src="images/10000000000001A1000002152583529E.png" style="width:4.34cm;height:5.55cm;" alt="Image" /></p>
<p><img src="images/100000000000039F000002AD82466924.png" style="width:10.701cm;height:7.901cm;" alt="Image" /></p>
<p>Le script principal <strong>[main]</strong> est le même que dans la version 4 :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span>
<span class="normal"><a href="#__codelineno-17-20">20</a></span>
<span class="normal"><a href="#__codelineno-17-21">21</a></span>
<span class="normal"><a href="#__codelineno-17-22">22</a></span>
<span class="normal"><a href="#__codelineno-17-23">23</a></span>
<span class="normal"><a href="#__codelineno-17-24">24</a></span>
<span class="normal"><a href="#__codelineno-17-25">25</a></span>
<span class="normal"><a href="#__codelineno-17-26">26</a></span>
<span class="normal"><a href="#__codelineno-17-27">27</a></span>
<span class="normal"><a href="#__codelineno-17-28">28</a></span>
<span class="normal"><a href="#__codelineno-17-29">29</a></span>
<span class="normal"><a href="#__codelineno-17-30">30</a></span>
<span class="normal"><a href="#__codelineno-17-31">31</a></span>
<span class="normal"><a href="#__codelineno-17-32">32</a></span>
<span class="normal"><a href="#__codelineno-17-33">33</a></span>
<span class="normal"><a href="#__codelineno-17-34">34</a></span>
<span class="normal"><a href="#__codelineno-17-35">35</a></span>
<span class="normal"><a href="#__codelineno-17-36">36</a></span>
<span class="normal"><a href="#__codelineno-17-37">37</a></span>
<span class="normal"><a href="#__codelineno-17-38">38</a></span>
<span class="normal"><a href="#__codelineno-17-39">39</a></span>
<span class="normal"><a href="#__codelineno-17-40">40</a></span>
<span class="normal"><a href="#__codelineno-17-41">41</a></span>
<span class="normal"><a href="#__codelineno-17-42">42</a></span>
<span class="normal"><a href="#__codelineno-17-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1"># on attend un paramètre mysql ou pgres</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="n">syntaxe</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> mysql / pgres&quot;</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="n">erreur</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a>    <span class="n">sgbd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;mysql&quot;</span> <span class="ow">and</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;pgres&quot;</span>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syntaxe : </span><span class="si">{</span><span class="n">syntaxe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s1">&#39;sgbd&#39;</span><span class="p">:</span> <span class="n">sgbd</span><span class="p">})</span>
<a id="__codelineno-17-15" name="__codelineno-17-15"></a>
<a id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="c1"># le syspath est établi - on peut faire les imports</span>
<a id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-17-18" name="__codelineno-17-18"></a>
<a id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="c1"># on récupère les couches de l&#39;application (elles sont déjà instanciées)</span>
<a id="__codelineno-17-20" name="__codelineno-17-20"></a><span class="n">dao</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span>
<a id="__codelineno-17-21" name="__codelineno-17-21"></a><span class="n">métier</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;métier&quot;</span><span class="p">]</span>
<a id="__codelineno-17-22" name="__codelineno-17-22"></a>
<a id="__codelineno-17-23" name="__codelineno-17-23"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-17-24" name="__codelineno-17-24"></a>    <span class="c1"># récupération des tranches de l&#39;impôt</span>
<a id="__codelineno-17-25" name="__codelineno-17-25"></a>    <span class="n">admindata</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_admindata</span><span class="p">()</span>
<a id="__codelineno-17-26" name="__codelineno-17-26"></a>    <span class="c1"># lecture des données des contribuables</span>
<a id="__codelineno-17-27" name="__codelineno-17-27"></a>    <span class="n">taxpayers</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_taxpayers_data</span><span class="p">()[</span><span class="s2">&quot;taxpayers&quot;</span><span class="p">]</span>
<a id="__codelineno-17-28" name="__codelineno-17-28"></a>    <span class="c1"># des contribuables ?</span>
<a id="__codelineno-17-29" name="__codelineno-17-29"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">taxpayers</span><span class="p">:</span>
<a id="__codelineno-17-30" name="__codelineno-17-30"></a>        <span class="k">raise</span> <span class="n">ImpôtsError</span><span class="p">(</span><span class="mi">57</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Pas de contribuables valides dans le fichier </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;taxpayersFilename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-17-31" name="__codelineno-17-31"></a>    <span class="c1"># calcul de l&#39;impôt des contribuables</span>
<a id="__codelineno-17-32" name="__codelineno-17-32"></a>    <span class="k">for</span> <span class="n">taxPayer</span> <span class="ow">in</span> <span class="n">taxpayers</span><span class="p">:</span>
<a id="__codelineno-17-33" name="__codelineno-17-33"></a>        <span class="c1"># taxPayer est à la fois un paramètre d&#39;entrée et de sortei</span>
<a id="__codelineno-17-34" name="__codelineno-17-34"></a>        <span class="c1"># taxPayer va être modifié</span>
<a id="__codelineno-17-35" name="__codelineno-17-35"></a>        <span class="n">métier</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">taxPayer</span><span class="p">,</span> <span class="n">admindata</span><span class="p">)</span>
<a id="__codelineno-17-36" name="__codelineno-17-36"></a>    <span class="c1"># écriture des résultats dans un fichier texte</span>
<a id="__codelineno-17-37" name="__codelineno-17-37"></a>    <span class="n">dao</span><span class="o">.</span><span class="n">write_taxpayers_results</span><span class="p">(</span><span class="n">taxpayers</span><span class="p">)</span>
<a id="__codelineno-17-38" name="__codelineno-17-38"></a><span class="k">except</span> <span class="n">ImpôtsError</span> <span class="k">as</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-17-39" name="__codelineno-17-39"></a>    <span class="c1"># affichage de l&#39;erreur</span>
<a id="__codelineno-17-40" name="__codelineno-17-40"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur suivante s&#39;est produite : </span><span class="si">{</span><span class="n">erreur</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-17-41" name="__codelineno-17-41"></a><span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-17-42" name="__codelineno-17-42"></a>    <span class="c1"># terminé</span>
<a id="__codelineno-17-43" name="__codelineno-17-43"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Travail terminé...&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p><strong>Notes</strong></p>
<ul>
<li>lignes 1-10 : on récupère le paramètre <strong>[mysql / pgres]</strong> qui indique le SGBD à utiliser ;</li>
<li>lignes 12-14 : l’application est configurée ;</li>
<li>lignes 16-17 : la classe <strong>[ImpôtsError]</strong> est importée. On en a besoin ligne 38 ;</li>
<li>lignes 19-21 : on récupère des références sur les couches de l’application ;</li>
<li>ligne 25 : on demande à la couche <strong>[dao]</strong> les données de l’administration fiscale. La couche <strong>[métier]</strong> en a besoin pour le calcul de l’impôt ;</li>
<li>ligne 27 : on récupère dans une liste, les données (id, marié, enfants, salaire) des contribuables ;</li>
<li>lignes 29-30 : si cette liste est vide, on lance une exception ;</li>
<li>lignes 32-35 : calcul de l&#x27;impôt des éléments de la liste <strong>[taxpayers]</strong> ;</li>
<li>ligne 37 : écriture des résultats dans le fichier jSON<strong>[résultats.json]</strong> ;</li>
<li>lignes 38-40 : gestion de l&#x27;éventuelle erreur ;
Pour l’exécution du script, on crée deux |<a href="#_Le_script_principal_2"><u><u>configurations d’exécution</u></u></a>| :</li>
</ul>
<p><img src="images/10000000000003D2000001DC25ED70E5.png" style="width:11.27cm;height:5.501cm;" alt="Image" /></p>
<p>Les résultats obtenus dans le fichier <strong>[résultats.json]</strong> sont ceux de la version 4.</p>
<p><img src="images/10000000000003D2000001D660C57B6C.png" style="width:11.27cm;height:5.441cm;" alt="Image" /></p>
<h2 id="203-application-3-calcul-de-limpot-en-mode-interactif">20.3. Application 3 : calcul de l’impôt en mode interactif</h2>
<p>Nous introduisons maintenant l’application permettant de calculer l’impôt de façon interactive. C’est un portage de <a href="#_Version_4_–"><u><u>l’application 2</u></u></a> de la version 4.</p>
<p><img src="images/100000000000018500000205A7925E38.png" style="width:4.051cm;height:5.381cm;" alt="Image" /></p>
<p><img src="images/1000000000000422000003317DC9988A.png" style="width:12.232cm;height:9.431cm;" alt="Image" /></p>
<ul>
<li>le script <strong>[main]</strong> lance le dialogue avec l’utilisateur avec la méthode <strong>[ui.run]</strong> de la couche <strong>[ui]</strong> ;</li>
<li>la couche <strong>[ui]</strong> :</li>
<li>utilise la couche <strong>[dao]</strong> pour obtenir les données permettant de faire le calcul de l’impôt ;</li>
<li>demande à l’utilisateur les renseignements concernant le contribuable dont on veut calculer l’impôt ;</li>
<li>utilise la couche <strong>[métier]</strong> pour faire ce calcul ;
Le fichier <strong>[config_layers]</strong> instancie une couche supplémentaire :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a>    <span class="c1"># instanciation couche dao</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">ImpotsDaoWithAdminDataInDatabase</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpotsDaoWithAdminDataInDatabase</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a>    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dao&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImpotsDaoWithAdminDataInDatabase</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a>    <span class="c1"># instanciation couche [métier]</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsMétier</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsMétier</span>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;métier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImpôtsMétier</span><span class="p">()</span>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a>    <span class="c1"># ui</span>
<a id="__codelineno-18-11" name="__codelineno-18-11"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsConsole</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsConsole</span>
<a id="__codelineno-18-12" name="__codelineno-18-12"></a>    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ui&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImpôtsConsole</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-18-13" name="__codelineno-18-13"></a>
<a id="__codelineno-18-14" name="__codelineno-18-14"></a>    <span class="c1"># on rend la config</span>
<a id="__codelineno-18-15" name="__codelineno-18-15"></a>    <span class="k">return</span> <span class="n">config</span>
</code></pre></div></td></tr></table></div>
<p>La classe <strong>[ImpôtsConsole]</strong>, lignes 11-12, est la même que dans la |<a href="#_La_classe_[ImpôtsConsole]"><u><u>version 4</u></u></a>|.</p>
<p>Le script principal <strong>[main]</strong> est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span>
<span class="normal"><a href="#__codelineno-19-27">27</a></span>
<span class="normal"><a href="#__codelineno-19-28">28</a></span>
<span class="normal"><a href="#__codelineno-19-29">29</a></span>
<span class="normal"><a href="#__codelineno-19-30">30</a></span>
<span class="normal"><a href="#__codelineno-19-31">31</a></span>
<span class="normal"><a href="#__codelineno-19-32">32</a></span>
<span class="normal"><a href="#__codelineno-19-33">33</a></span>
<span class="normal"><a href="#__codelineno-19-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="c1"># on attend un paramètre mysql ou pgres</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="n">syntaxe</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> mysql / pgres&quot;</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="n">erreur</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a>    <span class="n">sgbd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a>    <span class="n">erreur</span> <span class="o">=</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;mysql&quot;</span> <span class="ow">and</span> <span class="n">sgbd</span> <span class="o">!=</span> <span class="s2">&quot;pgres&quot;</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="k">if</span> <span class="n">erreur</span><span class="p">:</span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;syntaxe : </span><span class="si">{</span><span class="n">syntaxe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="c1"># on configure l&#39;application</span>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">config</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">configure</span><span class="p">({</span><span class="s1">&#39;sgbd&#39;</span><span class="p">:</span> <span class="n">sgbd</span><span class="p">})</span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="c1"># le syspath est configuré - on peut faire les imports</span>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ImpôtsError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImpôtsError</span>
<a id="__codelineno-19-18" name="__codelineno-19-18"></a>
<a id="__codelineno-19-19" name="__codelineno-19-19"></a><span class="c1"># on récupère la couche [ui]</span>
<a id="__codelineno-19-20" name="__codelineno-19-20"></a><span class="n">ui</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;ui&quot;</span><span class="p">]</span>
<a id="__codelineno-19-21" name="__codelineno-19-21"></a>
<a id="__codelineno-19-22" name="__codelineno-19-22"></a><span class="c1"># code</span>
<a id="__codelineno-19-23" name="__codelineno-19-23"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-19-24" name="__codelineno-19-24"></a>    <span class="c1"># exécution de la couche [ui]</span>
<a id="__codelineno-19-25" name="__codelineno-19-25"></a>    <span class="n">ui</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-19-26" name="__codelineno-19-26"></a><span class="k">except</span> <span class="n">ImpôtsError</span> <span class="k">as</span> <span class="n">ex1</span><span class="p">:</span>
<a id="__codelineno-19-27" name="__codelineno-19-27"></a>    <span class="c1"># on affiche le message d&#39;erreur</span>
<a id="__codelineno-19-28" name="__codelineno-19-28"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur 1 suivante s&#39;est produite : </span><span class="si">{</span><span class="n">ex1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-19-29" name="__codelineno-19-29"></a><span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">ex2</span><span class="p">:</span>
<a id="__codelineno-19-30" name="__codelineno-19-30"></a>    <span class="c1"># on affiche le message d&#39;erreur</span>
<a id="__codelineno-19-31" name="__codelineno-19-31"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L&#39;erreur 2 suivante s&#39;est produite : </span><span class="si">{</span><span class="n">ex2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-19-32" name="__codelineno-19-32"></a><span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-19-33" name="__codelineno-19-33"></a>    <span class="c1"># exécuté dans tous les cas</span>
<a id="__codelineno-19-34" name="__codelineno-19-34"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Travail terminé...&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 1-10, le script attend un paramètre <strong>[mysql / pgres]</strong> qui indique le SGBD à utiliser ;</li>
<li>lignes 12-14 : l’application est configurée ;</li>
<li>lignes 19-20 : on récupère la couche <strong>[ui]</strong> dans la configuration ;</li>
<li>ligne 25 : on l’exécute ;
Les résultats sont identiques à ceux de la |<a href="#_Le_script_principal_4"><u><u>version 4</u></u></a>|. Il ne pouvait en être autrement puisque toutes les interfaces de la version 4 ont été respectées dans la version 5.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner">

      <div>
        <a href="https://tahe.developpez.com" target="_blank">
          https://tahe.developpez.com
        </a>
        <br>
        Ce cours tutoriel écrit par <strong>Serge Tahé</strong> est mis à disposition du public selon les termes de la
        <em>Licence Creative Commons Attribution – Pas d’Utilisation Commerciale –
        Partage dans les Mêmes Conditions 3.0 non transposé</em>.
      </div>

    </div>
  </div>

      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": ".", "features": ["navigation.sections", "navigation.indexes", "toc.integrate", "navigation.top"], "search": "assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="javascripts/focus.js"></script>
      
    
  </body>
</html>